var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.brennenstuhl=xnm.aio.brennenstuhl||{};xnm.aio.brennenstuhl.WebLine=function(a,b,e,c){this.ip=a;this.port=80;b&&(this.port=b);this.user="admin";e&&(this.user=e);this.password="admin";c&&(this.password=c);this.CommandHandler=null};
xnm.aio.brennenstuhl.WebLine.prototype._doRequest=function(a,b,e){var c={host:this.ip,port:this.port,path:a,method:"GET",headers:{Connection:"close"}};e&&(c.headers.Authorization=e);var g=this,h=require("http").request(c,function(c){if(200==c.statusCode){c.setEncoding("utf-8");var h="";c.on("data",function(a){h+=a});c.on("end",function(){b&&b(h)})}else if(401!=c.statusCode||e)b&&b(null);else if(e=null,c.headers["www-authenticate"]&&"Digest "==c.headers["www-authenticate"].substr(0,7)){var f={};c=
c.headers["www-authenticate"].substr(7).replace(/'/g,"").replace(/"/g,"").split(",");for(var l=0;l<c.length;l++){var m=c[l].split("=");2==m.length&&(f[m[0]]=m[1])}f.nonce&&(e="Digest ",e+='username="'+g.user+'", ',e+='realm="'+f.realm+'", ',e+='nonce="'+f.nonce+'", ',e+='uri="'+a+'", ',c=require("x.crypt.js"),l=c.MD5(g.user+":"+f.realm+":"+g.password),m=c.MD5("GET:"+a),e+='response="'+c.MD5(l+":"+f.nonce+":1::auth:"+m)+'", ',e+='opaque="'+f.opaque+'", ',e+="qop="+f.qop+", ",e+="nc=1, ",e+='cnonce=""');
e?g._doRequest(a,b,e):b&&b(null)}});h.setTimeout(5E3,function(){h.abort()});h.on("error",function(a){b&&b(null)});h.end()};
xnm.aio.brennenstuhl.WebLine.prototype.executeCommand=function(a,b,e){if("toggle"==b)this._doRequest("/cgi-bin/toggleRel"+a.address+"?id=0",e);else if("on"==b||"off"==b){var c=this;this._doRequest("/power?id=1",function(g){g=c.getStateValues(null,g);"on"==b&&"M"==a.address&&"off"==g.master||"on"==b&&"S"==a.address&&"off"==g.slave||"off"==b&&"M"==a.address&&"on"==g.master||"off"==b&&"S"==a.address&&"on"==g.slave?c._doRequest("/cgi-bin/toggleRel"+a.address+"?id=0",e):e&&e()})}else e&&e()};
xnm.aio.brennenstuhl.WebLine.prototype.getStates=function(a,b,e){var c=this;this.CommandHandler=a;this._doRequest("/power?id=1",function(a){if(a&&c.CommandHandler)if(c.CommandHandler.setState){var b=c.getStateValues(null,a),f;for(f in b)"state"==f?c.CommandHandler.setState(d.id,b[f]):c.CommandHandler.setState(d.id+":"+f,b[f])}else c.CommandHandler.receivedState&&c.CommandHandler.receivedState("webline",c.ip,a);e&&e(c.getStateValues(null,a))})};
xnm.aio.brennenstuhl.WebLine.prototype.getStateValues=function(a,b){a={state:"?",master:"?",slave:"?"};b&&(b=b.split("|"),5==b.length&&(a.state="off","1"==b[3]?(a.master="on",a.state="on"):a.master="off","1"==b[4]?(a.slave="on",a.state="on"):a.slave="off"));return a};
xnm.aio.brennenstuhl.WebLine.Discovery=function(a){this.Devices={};this.callback=a;this._sockets=[];var b=require("os");a=require("dgram");if(b&&b.networkInterfaces){var e=this,c=a.createSocket("udp4");c.on("listening",function(){c.setBroadcast(!0);var a=b.networkInterfaces(),h;for(h in a)for(var f=a[h],k=0;k<f.length;k++)"IPv4"==f[k].family&&0==f[k].internal&&e._addDiscoverSocket(c.address().port,f[k].address);e.discoverDevices()});c.on("message",function(a,b){e._receivedData(b.address,a)});c.bind(null)}else this._addDiscoverSocket(null),
this.discoverDevices()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._getMAC=function(a){for(var b="",e=0;5>e;e++)b+=XC.getHexVal(a[e],2).toUpperCase()+"-";return b+=XC.getHexVal(a[e],2).toUpperCase()};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");94==b.length&&(this.Devices[a]=new xnm.aio.brennenstuhl.WebLine(a),this.Devices[a].uuid=this._getMAC(b.slice(19,25)),this.callback&&this.callback(this.Devices[a]))};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype._addDiscoverSocket=function(a,b){var e=this,c=require("dgram").createSocket("udp4");c.on("listening",function(){c.setBroadcast(!0)});c.on("message",function(a,b){e._receivedData(b.address,a)});c.bind(a,b);this._sockets.push(c)};xnm.aio.brennenstuhl.WebLine.Discovery.prototype._sendDiscoveryMessages=function(a,b,e,c){a=new Buffer([255,4,2,251]);for(b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,23,"255.255.255.255")};
xnm.aio.brennenstuhl.WebLine.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};xnm.aio.brennenstuhl.Handler=function(){this._WebLineDiscovery=new xnm.aio.brennenstuhl.WebLine.Discovery;this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.discoverDevices=function(a){a&&(this._WebLineDiscovery.callback=a);this._WebLineDiscovery.discoverDevices()};xnm.aio.brennenstuhl.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.brennenstuhl.WebLine).getStateValues(b)};
xnm.aio.brennenstuhl.Handler.prototype.getDeviceCommandList=function(a,b){a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};xnm.aio.brennenstuhl.Handler.prototype.getDevice=function(a){for(var b in this._WebLineDiscovery.Devices)if(a.address&&this._WebLineDiscovery.Devices[b].uuid==a.address)return this._WebLineDiscovery.Devices[b];return null};xnm.aio.brennenstuhl.Handler.prototype.WebLine=xnm.aio.brennenstuhl.WebLine;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.brennenstuhl.Handler);
