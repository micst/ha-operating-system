var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,f,d){b!=Array.prototype&&b!=Object.prototype&&(b[f]=d.value)};
$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var f=0;f<b.length;++f){var d=b[f];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,f,d,k){if(f){d=$jscomp.global;b=b.split(".");for(k=0;k<b.length-1;k++){var m=b[k];m in d||(d[m]={});d=d[m]}b=b[b.length-1];k=d[b];f=f(k);f!=k&&null!=f&&$jscomp.defineProperty(d,b,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Object.is",function(b){return b?b:function(b,d){return b===d?0!==b||1/b===1/d:b!==b&&d!==d}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(b){return b?b:function(b,d){var f=this;f instanceof String&&(f=String(f));var m=f.length;d=d||0;for(0>d&&(d=Math.max(d+m,0));d<m;d++){var a=f[d];if(a===b||Object.is(a,b))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(b,f,d){if(null==b)throw new TypeError("The 'this' value for String.prototype."+d+" must not be null or undefined");if(f instanceof RegExp)throw new TypeError("First argument to String.prototype."+d+" must not be a regular expression");return b+""};$jscomp.polyfill("String.prototype.includes",function(b){return b?b:function(b,d){return-1!==$jscomp.checkStringArgs(this,b,"includes").indexOf(b,d||0)}},"es6","es3");
$jscomp.owns=function(b,f){return Object.prototype.hasOwnProperty.call(b,f)};$jscomp.assign="function"==typeof Object.assign?Object.assign:function(b,f){for(var d=1;d<arguments.length;d++){var k=arguments[d];if(k)for(var m in k)$jscomp.owns(k,m)&&(b[m]=k[m])}return b};$jscomp.polyfill("Object.assign",function(b){return b||$jscomp.assign},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.commandhandler=xnm.aio.commandhandler||{};
xnm.aio.commandhandler.CommandHandler=function(b,f,d,k,m){this.SystemData=b;this.RulesManager=f;this.RemoteHandler=k;this.CloudHandler=m;this.gwModule=require("xnm.aio.gateway.js");this.CFG=d;this._gealanFans=null;this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"];this._persistentAioData={};this._states={};this.RemoteController=null;this._updateReceivers=[];this.getStatesCallback=null;this.setGealanFanFactory=function(a){this._gealanFans=a};this.getCurrentState=function(a){return void 0!==
this._states[a]?this._states[a]:"?"};this.setState=function(a,c){if(this._states[a]!=c){this._states[a]=c;for(var b=0;b<this._updateReceivers.length;b++){var e=this._updateReceivers[b];e.filter(a)&&e.callback(a.substr(a.indexOf(":")+1),c)}}};this.deleteDeviceStates=function(a){for(var c in this._states)this._states.hasOwnProperty(c)&&parseInt(c.split(":")[0])===a&&delete this._states[c]};this.subscribe=function(a,c,b){var e={filter:a,callback:c,refresh:b};this._updateReceivers.push(e);return{unsubscribe:function(a){return function(){var c=
a.indexOf(e);-1!==c&&a.splice(c,1)}}(this._updateReceivers)}};this.subscribeForDevice=function(a,c,b){var e=a.index;return this.subscribe(function(a){return+a.split(":")[0]===e},c,b)};this.clearSubscribers=function(){this._updateReceivers=[]};this.subscribeForStateOnDevices=function(a,c,b){return this.subscribe(function(a){var b=a.split(":")[0];return c.some(function(a){return a.index===+b})},function(c,d){a.some(function(a){return c===a})&&b(d)})};this.refreshSubscribers=function(){this._updateReceivers.forEach(function(a){void 0!==
a.refresh&&a&&a.refresh()}.bind(this))};this.receivedState=function(a,c,b,e){XC.debugf(a);XC.debugf(c);XC.debugf(b);var d=this;"hue"===a?this.SystemData.getGateways(function(b){return b.info.sys===a}).forEach(function(h){this.SystemData.getDevices(function(a){return a.info.gateway===h.index}).forEach(function(h){var l={},g="",e=h.info.data;h.info.subtype&&(e=h.info.subtype);h.info.address==c&&(g=h.room+"."+h.index,"hue"===a&&(l=require("xnm.aio.hue.js").getStateValues({type:e},b),l.rgb=b.rgb,l.effect=
b.effect));for(var d in l)"state"==d?this.setState(g,l[d]):this.setState(g+":"+d,l[d])}.bind(this))}.bind(this)):("sonos"==a||"wemo"==a||"orvibo"==a||"edimax"==a||"kt"==a||"siegenia"==a||"lightify"==a)&&d.SystemData.getDevices(function(a){return a.info.address===c}).forEach(function(c){XC.debugf(c);XC.debugf(b);var e=c.room+"."+c.index,l=c.data;c.subtype&&(l=c.subtype);"lightify"===a&&(a="osram");c=require("xnm.aio."+a+".js").getStateValues({type:l},b);"osram"===a&&(c.rgb=""+XC.getHexVal(b.red,2)+
XC.getHexVal(b.green,2)+XC.getHexVal(b.blue,2),c.ct=b.colorTemp);for(var g in c)"state"==g?d.setState(e,c[g]):d.setState(e+":"+g,c[g])})};this.execute=function(a,c,b,e){var d=this.SystemData.getDevices(function(c){return c.index==a})[0];d&&this.executeCommand(c,d.info,b,e)};this.executeCommand=function(a,c,b,e){var d=this,h=this,f=c.gateway,l=c.sys,g=this.SystemData.getGateways(function(a){return a.index===f},!0)[0];if(g&&("aio"===l||"hm"===l)){var n=this.gwModule.resolveGateway(g.info);n.CommandHandler=
this;this._restoreAioData(n);g.info.server&&n.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/");g.info.password&&(n._at=this.hash(g.info.password));var q=this.RemoteHandler.isRemote();n.setCloudAccess(q);q&&(b=!0);n.executeCommandCreator(null,{value:q?"raOn":"raOff"});n.executeCommandCreator(c,a,function(g){d._saveAioData(n);XC.debugf("Executed Gateway Command: "+c.sys+" "+a+(q?" (remote)":" (local)"));b&&setTimeout(function(){return n.getStates(h)},1E3);e&&e(g)})}else if(!this.RemoteHandler.isRemote())if(g&&
"fritzbox"===l){var k=new (require("xnm.aio.fritz.js").Box)(g.info.ip,g.info.password);k.executeCommand(c,a,function(){XC.debugf("executed fritz command");e&&e.call();c.id=c.location+"."+c.id;b&&k.getStates(h,[c])})}else if(g&&"alpha2"===l){var m=new (require("xnm.aio.moehlenhoff.js").Alpha2)(g.info.ip);m.executeCommandCreator(c,a,function(){XC.debugf("executed moehlenhoff command");e&&e.call();c.id=c.location+"."+c.id;b&&m.getStates(h,[c])})}else if(g)XC.debugf("executeCommand for unknown gatewaytype");
else if("edimax kt orvibo siegenia sonos wemo".split(" ").includes(l)){g={address:c.address,data:c.data};if("wemo"===l){g.port=49154;var p=c.address.split(":");2==p.length&&(g.address=p[0],g.port=p[1])}else"sonos"===l?(g.port=1400,g.address=c.ip):"siegenia"===l&&(g.pwd=c.pwd);p=require("xnm.aio."+l+".js");var r=p.getDevice(g);r?r.executeCommandCreator(g,a,function(a,c){XC.debugf("executed "+l+" command");"siegenia"===l?e&&e.call(null,a,c):e&&e.call();b&&r.getStates(h)}):e&&e.call()}else"gealan"===
l?(p=require("xnm.aio.gealan.js"),(new p.Fan(c.ip,c.port,c.username,c.password)).executeCommandCreator(c,a,function(a,c){XC.debugf("executed "+l+" command");e&&e.call()})):"aiogateway"===l&&(n=new this.gwModule.Gateway(c.address),n.executeGatewayCommand(a,function(){e&&e.call()}))};this._restoreAioData=function(a){if(this._persistentAioData[a._mac])for(var c in this._persistentAioData[a._mac])a[c]=this._persistentAioData[a._mac][c];else this._persistentAioData[a._mac]={}};this._saveAioData=function(a){var c=
this;this._persistentAioKeys.forEach(function(b){b in a&&(c._persistentAioData[a._mac][b]=a[b])})};this.hash=function(a){a=String(a);return require("x.crypt.js").MD5(unescape(encodeURI(a+"_SALT!")))};this.getStatesForDevice=function(a,c){var b=this;a.info&&"cloudservice"===a.info.sys&&(new this.CloudHandler).getModuleStates(a.info.module,function(c,d){b.deleteDeviceStates(a.index);if(d&&(c=d[a.info.connection])&&(c=c[a.info.id])&&c.states)for(var g in c.states)b.setState(a.index+":"+g,c.states[g])});
if(a.info&&a.info.mod){this.deleteDeviceStates(a.index);var d=this.gwModule.devicemanager.getSystem(a.info);if(d){var f=this.SystemData.getGateways(function(c){return c.index===a.info.gateway})[0];if(f){var h=f.info.mac;this._aioCache?(this._aioCache[h]||(this._aioCache[h]=this.gwModule.resolveGateway(f.info)),h=this._aioCache[h]):h=this.gwModule.resolveGateway(f.info);this.RemoteHandler.isRemote()&&(h.setRemoteAccessMode(f.info.sid),h.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),
h._at=this.hash(f.info.password));h.executeCommandCreator(null,{value:this.RemoteHandler.isRemote()?"raOn":"raOff"});d.getStatesCreator(h,a.info,function(d,g){if(!d&&g){for(var e in g)b.setState(a.index+":"+e,g[e]);c&&c(g)}})}}}else if(!this.RemoteHandler.isRemote()&&(d=a.sys,-1!==["gealan"].indexOf(d)&&"gealan"==d)){d=this._gealanFans.getFan({ip:a.ip,port:a.port,mac:a.mac});var t=[];require("xnm.aio.gealan.js").getDeviceStatus(a,function(c,b){for(c=0;c<b.length;c++){var d=b[c];d.ref&&d.ref.value&&
t.push({id:d.ref.value,device:a,status:{value:d.ref.value}})}});d.getStatesCreator(null,t,function(d,g){if(!d&&g){for(var e=0;e<g.length;e++){var h=g[e];b.setState(a.id+":"+h.id,h.status)}c&&c(d,g)}})}};this.getStatesForDevices=function(a,c){var b={},d=[];this._orderByGateway(a,b,d);this.getStatesPerGateway(b,d,c)};this.getStatesForLocations=function(a,c){var b=this,d={},f=[];a.forEach(function(a){var e=b.SystemData.getDevices(function(c){return c.room===a.index});b._orderByGateway(e,d,f,c)});this.getStatesPerGateway(d,
f)};this._orderByGateway=function(a,c,b,d){a.forEach(function(a){if("cloudservice"===a.info.sys){if(!d)return;var e=a}else a.info.mod?e=a:(e=Object.assign({},a.info),e.id=a.index,e.subtype=a.info.subtype?a.info.subtype:a.info.data);var f=a.info.gateway;f&&!a.info.mod?(c[f]||(c[f]=[]),c[f].push(e)):b.push(e)})};this.getStatesPerGateway=function(a,c,b){var d=this,f;for(f in a){var h=this.SystemData.getGateways(function(a){return a.index==f},!0)[0];if(!h)return;var k=h.info.sys,l=a[f];"aio"===k?(k=this.gwModule.resolveGateway(h.info),
this.RemoteHandler.isRemote()&&(k.setRemoteAccessMode(h.info.sid),k.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),k._at=this.hash(h.info.password),k.setCloudAccess(!0),k.executeCommandCreator(null,{value:"raOn"})),k.getStates(this,l,function(a,c){null==a&&b&&b(Error("Error getting states "+c))})):"hm"===k?(XC.debugf("GET HM STATES"),(new (require("xnm.aio.hm.js").CCU)(h.info.ip)).getStates(this,l,function(a,b){if(!a&&b)for(a=0;a<b.length;a++)this.setState(b[a].id,b[a].status)}.bind(this))):
"fritzbox"===k?(new (require("xnm.aio.fritz.js").Box)(h.info.ip,h.info.password)).getStates(this,l):"alpha2"===k&&(new (require("xnm.aio.moehlenhoff.js").Alpha2)(h.info.ip)).getStates(this,l)}setTimeout(function(){d._aioCache=[];for(var a=0;a<c.length;a++)d.getStatesForDevice(c[a]);d._aioCache=[]},1E3)}};xnm.aio.commandhandler.Handler=function(){};xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler);
