var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.sms=xnm.aio.sms||{};
xnm.aio.sms.Handler=function(){var k="http://webservice.aio-control.com/smsservice",q="https://webservice.mediola.com/cloudservice",n={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="",c=0;for(a=n._utf8_encode(a);c<a.length;){var d=a.charCodeAt(c++);var f=a.charCodeAt(c++);var g=a.charCodeAt(c++);var p=d>>2;d=(d&3)<<4|f>>4;var e=(f&15)<<2|g>>6;var l=g&63;isNaN(f)?e=l=64:isNaN(g)&&(l=64);b=b+this._keyStr.charAt(p)+this._keyStr.charAt(d)+this._keyStr.charAt(e)+
this._keyStr.charAt(l)}return b},decode:function(a){var b="",c=0;for(a=a.replace(/[^A-Za-z0-9\+\/=]/g,"");c<a.length;){var d=this._keyStr.indexOf(a.charAt(c++));var f=this._keyStr.indexOf(a.charAt(c++));var g=this._keyStr.indexOf(a.charAt(c++));var e=this._keyStr.indexOf(a.charAt(c++));d=d<<2|f>>4;f=(f&15)<<4|g>>2;var h=(g&3)<<6|e;b+=String.fromCharCode(d);64!=g&&(b+=String.fromCharCode(f));64!=e&&(b+=String.fromCharCode(h))}return b=n._utf8_decode(b)},_utf8_encode:function(a){a=a.replace(/\r\n/g,
"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){var b="",c=0;for(c1=c2=0;c<a.length;){var d=a.charCodeAt(c);128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+
2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3)}return b}},e=function(){};e.prototype.setURL=function(a){k=a};e.prototype.setCloudServiceURL=function(a){q=a};e.prototype.registAllUndeliveredPurchase=function(a,b){var c=this;this._getUndeliveredPurchase(function(d,f){XC.debugf("deliver unregest ps");XC.debugf(d);XC.debugf(f);if(d)b&&b(d);else if(f&&0!=f.length){XC.debugf("registAllSmsPurchase purchases:"+JSON.stringify(f));d=[];for(var g=[],e=0;e<f.length;e++){var h=f[e];if(c._isSmsPurchase(h)){var l=
c._getSmsCount(h);l&&(h.smsTotalCount=l,h.sid=a,d.push(h))}else c._isCloudServicePurchase(h)&&(l=c._getCloudServiceDuration(h))&&(h.duration=l,g.push(h))}var k=2,m=null;c._handleSms(d,function(a){k--;a&&(m=a);0==k&&b&&b(m)});c._handleCloudService(g,function(a){k--;a&&(m=a);0==k&&b&&b(m)})}else b&&b()})};e.prototype._handleSms=function(a,b){if(!a||0>=a.length)b&&b();else{var c=this;this._registSmsPurchases(a,function(d){d?b&&b(d):c._purchasesDelivered(a,function(a){b&&b(a)})})}};e.prototype._handleCloudService=
function(a,b){if(!a||0>=a.length)b&&b();else{var c=this;this._registCloudServicePurchases(a,function(d){d?b&&b(d):c._purchasesDelivered(a,function(a){b&&b(a)})})}};e.prototype.getSmsInfo=function(a,b){var c=require("url").parse(k);a={host:c.hostname,port:c.port,path:c.path+"/gatewaysmsinfo?sid="+a,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};a=require("http").request(a,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",
function(){if(200!=a.statusCode){var d=Error("http response:"+a.statusCode);b&&b(d)}else if(c)try{d=JSON.parse(c),b&&b(null,d)}catch(p){b&&b(p)}else d=Error("server response is empty"),b&&b(d)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(a){b&&b(a?a:Error("http error"))});a.end()};e.prototype.setSmsActive=function(a,b,c){var d=require("url").parse(k);a={host:d.hostname,port:d.port,path:d.path+"/activatesms?sid="+a+"&active="+b,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',
Connection:"close"}};a=require("http").request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+a.statusCode));c&&c(d,b)})});a.setTimeout&&a.setTimeout(1E4);if(a.on)a.on("error",function(a){c&&c(a?a:Error("http error"))});a.end()};e.prototype._getUndeliveredPurchase=function(a){XC.callHost("inapppurchase","getUndeliveredPurchase",null,function(b){b?b.error?a&&a(Error(b.error)):b.value?a&&a(null,b.value):
a&&a(null,[]):a&&a(Error("result is null"))})};e.prototype._registSmsPurchases=function(a,b){a=this._encrypt2base64(JSON.stringify(a));var c=require("url").parse(k);XC.debugf("registAllSmsPurchase ud:"+JSON.stringify(c));c={host:c.hostname,port:c.port,path:c.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}};c=require("http").request(c,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var d;200!=a.statusCode&&
(d=Error("http response:"+a.statusCode));b&&b(d,c)})});c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(a){b&&b(a?a:Error("http error"))});c.write(a);c.end()};e.prototype._registCloudServicePurchases=function(a,b){a=this._encrypt2base64(JSON.stringify(a));var c=require("url").parse(q),d=c.port;-1!=c.protocol.indexOf("https")&&80==d&&(d=443);XC.debugf("regist cloud service purchase ud:"+JSON.stringify(c));c={host:c.hostname,port:d,path:c.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',
Connection:"close"}};c=require("https").request(c,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+a.statusCode));b&&b(d,c)})});c.setTimeout&&c.setTimeout(1E4);if(c.on)c.on("error",function(a){b&&b(a?a:Error("http error"))});c.write(a);c.end()};e.prototype._encrypt2base64=function(a){var b=require("x.crypt.js");a=n.encode(a);for(var c="",d=0,e=a.length,g;d<e;d+=1)g=a.charCodeAt(d),c+=g.toString(16);
a=b.AES.h2a(c);b.AES.setSize(128);c=b.AES.h2a("CB1CC15198F09B7D9EA80892A870399E");d=b.AES.h2a("D0648681F88076B43CE216E0686A02DD");a=b.AES.encrypt(a,c,d);return b.AES.a2h(a)};e.prototype._purchasesDelivered=function(a,b){var c=a.length;if(c)for(var d=null,e=0;e<a.length;e++)this._purchaseDelivered(a[e].orderId,function(a){c--;d||(d=a);0==c&&b&&b(d)});else b&&b()};e.prototype._purchaseDelivered=function(a,b){a?XC.callHost("inapppurchase","purchaseDelivered",{orderId:a},function(a){a?a.error?b&&b(Error(a.error)):
b&&b(null,a.value):b&&b(Error("result is null"))}):b&&b(Error("order id is empty"))};e.prototype._isSmsPurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".sms."):!1};e.prototype._isCloudServicePurchase=function(a){return a&&a.productId?"android.test.purchased"==a.productId?!0:0<=a.productId.indexOf(".cloudservice"):!1};e.prototype._getSmsCount=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==a.productId)return 50;a=a.productId;
var b=a.indexOf(".sms.");if(0>b||b+5>=a.length)return 0;a=a.substr(b+5);return parseInt(a)};e.prototype._getCloudServiceDuration=function(a){if(!a||!a.productId)return 0;if("android.test.purchased"==a.productId)return 50;a=a.productId;var b=a.indexOf(".cloudservice.");if(0>b||b+14>=a.length)return 0;a=a.substr(b+14);return parseInt(a)};return e}();"undefined"!=typeof module&&module&&module.exports&&(module.exports=new xnm.aio.sms.Handler);
