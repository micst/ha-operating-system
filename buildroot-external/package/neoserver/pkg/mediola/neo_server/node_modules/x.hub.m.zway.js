var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(h){var e=0;return function(){return e<h.length?{done:!1,value:h[e++]}:{done:!0}}};$jscomp.arrayIterator=function(h){return{next:$jscomp.arrayIteratorImpl(h)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(h,e,c){h!=Array.prototype&&h!=Object.prototype&&(h[e]=c.value)};$jscomp.getGlobal=function(h){h=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,h];for(var e=0;e<h.length;++e){var c=h[e];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(h,e){this.$jscomp$symbol$id_=h;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:e})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function h(c){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+e++,c)}var e=0;return h}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var h=$jscomp.global.Symbol.iterator;h||(h=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[h]&&$jscomp.defineProperty(Array.prototype,h,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var h=$jscomp.global.Symbol.asyncIterator;h||(h=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(h){$jscomp.initSymbolIterator();h={next:h};h[$jscomp.global.Symbol.iterator]=function(){return this};return h};
$jscomp.iteratorFromArray=function(h,e){$jscomp.initSymbolIterator();h instanceof String&&(h+="");var c=0,g={next:function(){if(c<h.length){var l=c++;return{value:e(l,h[l]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(h,e,c,g){if(e){c=$jscomp.global;h=h.split(".");for(g=0;g<h.length-1;g++){var l=h[g];l in c||(c[l]={});c=c[l]}h=h[h.length-1];g=c[h];e=e(g);e!=g&&null!=e&&$jscomp.defineProperty(c,h,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Array.prototype.keys",function(h){return h?h:function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6","es3");
var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),logger=require("x.logger.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zway=x.hub.m.zway||{};
x.hub.m.zway.Util={hasEvent:function(h,e,c,g){if(!h||!e||!c||0>g||255<g)return null;if("binary"==c.type&&c.value){c=c.value;var l=Math.floor(g/8);return c[l]?(c=c[l]>>g%8&1)?h._EVNETS[e]?h._EVNETS[e][g]:null:null:null}return isNaN(parseInt(c.value))?null:(c=parseInt(c.value)>>g&1)?h._EVNETS[e]?h._EVNETS[e][g]:null:null}};
x.hub.m.zway.PollManager=function(){var h=["37","38","49","64","67"],e=function(c){this._logger=logger.getLogger("x.hub.m.zway.Poller");this._pollManager=c;this._deviceID=null;this._pollInterval=0;this._running=!1;this._pollTO=this._startPollTO=null;this._errorCount=0};e.prototype.setDeviceID=function(c){this._deviceID=c};e.prototype.setPollInterval=function(c){this._pollInterval=c};e.prototype.start=function(){this._logger.log("trace","start for device: "+this._deviceID+" with interval: "+this._pollInterval+
"s");if(!this._running){this._running=!0;var c=this;this._startPollTO=setTimeout(function(){c._pollTO=setInterval(function(){c._pollDevice()},1E3*c._pollInterval)},1E3*Math.floor(10*Math.random()+1))}};e.prototype.stop=function(){this._logger.log("trace","stop for device: "+this._deviceID);this._running&&(this._running=!1,this._pollTO&&(clearInterval(this._pollTO),this._pollTO=null),this._startPollTO&&(clearInterval(this._startPollTO),this._startPollTO=null))};e.prototype.immediatelyPoll=function(){this._pollDevice()};
e.prototype._pollDevice=function(){var c=this._pollManager.getHandler().getZway();c&&((c=c.getDevice(this._deviceID))?(this._errorCount=0,this._logger.log("trace","poll device:"+this._deviceID),(c=this._findCommandClassesToPoll(this._deviceID,c))&&0<c.length&&this._pollManager._pollCommandClass(c)):(this._logger.log("trace","no such device: "+this._deviceID),this._errorCount++,10<this._errorCount&&(this._logger.log("trace","too many error with no such device, stop poller: "+this._deviceID),this._pollManager.stopPoller(this._deviceID))))};
e.prototype._findCommandClassesToPoll=function(c,g){if(!g||!g.instances)return null;var e=[],k;for(k in g.instances){var a=g.instances[k];if(a&&a.commandClasses)for(var b in a.commandClasses)-1!=h.indexOf(b)&&e.push(c+"."+k+"."+b)}return e};return{_logger:require("x.logger.js").getLogger("x.hub.m.zway.PollManager"),_handler:null,_tasks:[],_pollers:{},_pollWait:200,_pollTO:null,init:function(c,g){this._handler=c;g&&g()},getHandler:function(){return this._handler},startPoller:function(c,g){if(c&&g&&
!(0>g)){if(!this._pollers[c]){var h=new e(this);h.setDeviceID(c);h.setPollInterval(g);this._pollers[c]=h}this._pollers[c].start()}},stopPoller:function(c){if(c){var g=this._pollers[c];g&&(g.stop(),delete this._pollers[c])}},immediatelyPoll:function(c){if(c)for(var g=0;g<c.length;g++){var h=c[g],k=this._pollers[h];k||(k=new e(this),k.setDeviceID(h));k.immediatelyPoll()}},_pollCommandClass:function(c){for(var g=this._tasks.length,e=0;e<c.length;e++){var h=c[e];-1==this._tasks.indexOf(h)&&this._tasks.push(h)}0!=
g||this._pollTO||this._doNextPollTask()},_doNextPollTask:function(){this._pollTO&&(clearTimeout(this._pollTO),this._pollTO=null);var c=this._tasks.shift();if(c){var e=this;this._doGetRequest(c,function(){e._pollTO=setTimeout(function(){e._pollTO=null;e._doNextPollTask()},e._pollWait)})}},_doGetRequest:function(c,e){this._logger.log("trace","do Get() for command class:"+c);var g=this._handler.getZway();if(g){var h=c.split(".");if(!(3>h.length)){var a=this;g._doRunRequest("devices["+h[0]+"].instances["+
h[1]+"].commandClasses["+h[2]+"].Get()",null,function(b){b&&a._logger.log("warn","do Get() for command class:"+c+" error:"+b.message);e&&e()})}}}}}();
x.hub.m.zway.SettingsManager=function(){var h=function(e,c){this._settingsManager=e;this._deviceID=c;this._autoPoll=!1;this._pollInterval=0};h.prototype.init=function(){this.start()};h.prototype.start=function(){this._autoPoll&&0<this._pollInterval&&this._settingsManager._startPoller(this)};h.prototype.stop=function(){this._settingsManager._stopPoller(this)};h.prototype.getDeviceID=function(){return this._deviceID};h.prototype.getPollInterval=function(){return this._pollInterval};h.prototype.toJSON=
function(){return{autoPoll:this._autoPoll,pollInterval:this._pollInterval}};h.prototype.fromJSON=function(e){e&&(this._autoPoll=e.autoPoll?!0:!1,this._pollInterval=e.pollInterval?e.pollInterval:0)};return{ZWAY_FILE:"zwave.json",_logger:require("x.logger.js").getLogger("x.hub.m.zway.SettingsManager"),_handler:null,_settings:{},init:function(e,c){this._logger.log("trace","init");this._handler=e;var g=this;this._loadSettings(function(e,h){e&&g._logger.log("warn","init error:"+e.message);h&&(g._settings=
h,g._initSettings());c&&c()})},setSetting:function(e,c,g){if(this._handler.getZway().getDevice(e)){var l=this._settings[e];l&&l.stop();l=new h(this,e);l.fromJSON(c);this._settings[e]=l;l.start();this._saveSettings(function(c){g&&g(c?c:null,c?null:l)})}else g&&g(Error("no such device:"+e))},getSetting:function(e,c){if(this._handler.getZway().getDevice(e)){var g=this._settings[e];g||(g=new h(this,e));c&&c(null,g)}else c&&c(Error("no such device:"+e))},deleteSetting:function(e,c){if(this._handler.getZway().getDevice(e)){var g=
this._settings[e];g||(g.stop(),delete this._settings[e]);this._saveSettings(c)}else c&&c(Error("no such device:"+e))},_startPoller:function(e){this._handler.startPoller(e.getDeviceID(),e.getPollInterval())},_stopPoller:function(e){this._handler.stopPoller(e.getDeviceID())},_initSettings:function(){for(var e in this._settings){var c=this._settings[e];c&&c.init()}},_loadSettings:function(e){var c=this;this._loadFile(function(g,h){g?e&&e(g):(g=c._jsonToSettingsMap(h),e&&e(null,g))})},_jsonToSettingsMap:function(e){if(!e)return{};
var c={},g;for(g in e){var l=e[g];if(l){var k=new h(this,g);k.fromJSON(l);c[g]=k}}return c},_loadFile:function(e){var c=this._getFilePath();fs_extra.ensureFile(c,function(g){g?e&&e(g):fs_extra.readFile(c,"utf8",function(c,g){if(c)e&&e(c);else if(g)try{var a=JSON.parse(g);e&&e(null,a)}catch(b){e&&e(b)}else e&&e(null,{})})})},_getFilePath:function(){var e=fileman.fileManager.getUserRootDataPath();return path.resolve(e,this.ZWAY_FILE)},_saveSettings:function(e){var c=this._settingsMapToJson(this._settings);
this._saveFile(c,function(c){e&&e(c)})},_settingsMapToJson:function(e){if(!e)return{};var c={},g;for(g in e){var h=e[g];h&&(h=h.toJSON(),c[g]=h)}return c},_saveFile:function(e,c){var g=this._getFilePath();fs_extra.writeFile(g,JSON.stringify(e,null,2),function(e){c&&c(e)})}}}();
x.hub.m.zway.ZWay=function(){var h={_buffer:{},updateState:function(a,b){if(!b)return!1;var d=this._buffer[a];this._buffer[a]=b;if(!d)return!0;a=!1;for(var f in b)b[f]!=d[f]&&(a=!0);return a}},e={sendSTAEvent:function(a){var b=require("x.hub.eventbus.js");b.emit("gatewayevent",a,{address:"ZWAVE"},"STA");b.emit("udpevent",a,"STA")}},c={_alarms:{},_alarmEvents:{},setAlarm:function(a,b){this._alarms[a]=b},getAlarm:function(a){return this._alarms[a]},setAlarmEvent:function(a,b){this._alarmEvents[a]=b},
getAlarmEvent:function(a){return this._alarmEvents[a]},deleteAlarmEvent:function(a){delete this._alarmEvents[a]}},g=function(a){this.INTERVIEW_TIMEOUT=2E4;this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay.LearnHander");this._zway=a;this._inclusion=!1;this._inclusionDeviceId=this._inclusionCB=this._inclusionListener=this._inclusionTO=null;this._inclusionInterViewProgress=0;this._inclusionInterViewTO=null;this._exclusion=!1;this._exclusionDeviceId=this._exclusionCB=this._exclusionTO=
null;this._updateInterview=this._exclusionAny=!1;this._updateInterviewCommandClassID=this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;var b=this;this._dataUpdateListener=function(a){b._onDataUpdate(a)}};g.prototype.inclusion=function(a,b){if(this._inclusion){var d=Error("inclusion process running");d.code="08001";b&&b(d)}else if(this._exclusion)d=Error("exclusion process running"),
d.code="08002",b&&b(d);else if(this._updateInterview)d=Error("update interview process running"),d.code="08006",b&&b(d);else{this._logger.log("info","start inclusion");var f=this;this._inclusionListener=a;this._inclusionCB=b;this._inclusionTO=setTimeout(function(){d=Error("inclusion timeout");d.code="08003";f._inclusionFinish(d)},2E4);this._inclusionListener&&this._inclusionListener(1,0,"start inclusion");this._zway.addDataUpdateListener(this._dataUpdateListener);this._inclusion=!0;this._zway._startInclusion(function(a){a?
f._inclusionFinish(a):f._inclusionListener&&f._inclusionListener(2,0,"set device")})}};g.prototype.exclusion=function(a,b){if(this._inclusion){var d=Error("inclusion process running");d.code="08001";b&&b(d)}else if(this._exclusion)d=Error("exclusion process running"),d.code="08002",b&&b(d);else if(this._updateInterview)d=Error("update interview process running"),d.code="08006",b&&b(d);else{this._logger.log("info","start exclusion");var f=this;this._exclusionCB=b;this._exclusionTO=setTimeout(function(){d=
Error("exclusion timeout");d.code="08005";f._exclusionFinish(d)},2E4);this._zway.addDataUpdateListener(this._dataUpdateListener);this._exclusion=!0;-1==a&&(this._exclusionAny=!0);this._zway._startExclusion(function(a){a&&f._exclusionFinish(a)})}};g.prototype.updateInterview=function(a,b,d,f,m){if(this._inclusion){var c=Error("inclusion process running");c.code="08001";m&&m(c)}else if(this._exclusion)c=Error("exclusion process running"),c.code="08002",m&&m(c);else if(this._updateInterview)c=Error("update interview process running"),
c.code="08006",m&&m(c);else if(a)if(this._zway.getDevice(a)){var e=this._updateInterviewProgress=this._zway.getInterviewProgress(a);if(100==e)m&&m(null,this._zway.getSimplifiedJSON(a));else{this._logger.log("info","update interview for device:"+a);var g=this;this._updateInterviewCB=m;this._updateInterviewDeviceId=a;this._updateInterviewInstanceID=b;this._updateInterviewCommandClassID=d;this._updateInterviewListener=f;this._updateInterviewTO=setTimeout(function(){c=Error("update interview timeout");
c.code="08008";g._updateInterviewFinish(c,g._updateInterviewDeviceId)},1E4);this._zway.addDataUpdateListener(this._dataUpdateListener);this._updateInterview=!0;this._updateInterviewProgress=e;this._updateInterviewListener&&this._updateInterviewListener(1,e,"start update interview");this._zway._startUpdateInterview(a,b,d,function(a){a&&g._updateInterviewFinish(a)})}}else c=Error("update interview deviceID invalid"),c.code="08006",m&&m(c);else c=Error("update interview deviceID invalid"),c.code="08006",
m&&m(c)};g.prototype._inclusionFinish=function(a,b){a?this._logger.log("warn","inclusion finish with error:"+a.stack):this._logger.log("info","inclusion finish:"+b);this._inclusionTO&&clearTimeout(this._inclusionTO);this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO);var d=this;this._zway._stopInclusion(function(){d._zway.removeDataUpdateListener(d._dataUpdateListener);var f=d._inclusionCB;d._inclusion=!1;d._inclusionTO=null;d._inclusionListener=null;d._inclusionCB=null;d._inclusionInterViewProgress=
0;d._inclusionInterViewTO=null;d._inclusionDeviceId=null;setTimeout(function(){var m=null;b&&(m=d._zway.getSimplifiedJSON(b));m&&(m.interViewDone=!0);a&&"08004"==a.code&&m&&(a=null,m.interViewDone=!1);f&&f(a,m)},5E3)})};g.prototype._exclusionFinish=function(a,b){a?this._logger.log("warn","exclusion finish with error:"+a.stack):this._logger.log("info","exclusion finish:"+b);this._exclusionTO&&clearTimeout(this._exclusionTO);var d=this;setTimeout(function(){d._zway._stopExclusion(function(){d._zway.removeDataUpdateListener(d._dataUpdateListener);
var f=d._exclusionCB;d._exclusion=!1;d._exclusionTO=null;d._exclusionCB=null;d._exclusionDeviceId=null;d._exclusionAny=!1;f&&f(a,b)})},1E3)};g.prototype._updateInterviewFinish=function(a,b){a?this._logger.log("warn","update interview finish with error:"+a.stack):this._logger.log("info","update interview finish:"+b);var d=null;b&&(d=this._zway.getSimplifiedJSON(b));this._updateInterviewTO&&clearTimeout(this._updateInterviewTO);this._zway.removeDataUpdateListener(this._dataUpdateListener);b=this._updateInterviewCB;
this._updateInterview=!1;this._updateInterviewCommandClassID=this._updateInterviewInstanceID=this._updateInterviewDeviceId=this._updateInterviewListener=this._updateInterviewCB=this._updateInterviewTO=null;this._updateInterviewProgress=0;b&&b(a,d)};g.prototype._onDataUpdate=function(a){this._logger.log("debug","on data update");this._logger.log("debug",JSON.stringify(a,null,2));a&&(this._inclusion?this._onInclusionDataUpdate(a):this._exclusion?this._onExclusionDataUpdate(a):this._updateInterview&&
this._onUpdateInterviewDataUpdate(a))};g.prototype._onInclusionDataUpdate=function(a){if(!this._inclusionDeviceId&&a["controller.data.lastIncludedDevice"]){var b=a["controller.data.lastIncludedDevice"].value;b&&(this._inclusionDeviceId=b,this._inclusionTO&&(clearTimeout(this._inclusionTO),this._inclusionTO=null),this._inclusionListener&&this._inclusionListener(3,0,"run interview"))}var d=this,f=null;this._inclusionDeviceId&&(f=this._zway.getDevice(this._inclusionDeviceId),this._inclusionInterViewTO||
(this._inclusionInterViewTO=setTimeout(function(){var a=Error("interview timeout");a.code="08004";d._inclusionFinish(a,d._inclusionDeviceId)},this.INTERVIEW_TIMEOUT)));if(f&&f.instances){var m=b=0;for(h in f.instances){var c=f.instances[h];if(c&&c.commandClasses)for(var e in c.commandClasses){var g=c.commandClasses[e];g&&g.data&&(g.data.interviewDone&&(b+=1),g.data.interviewDone.value&&(m+=1))}}var h=!1;for(var k in a)if(0==k.indexOf("devices."+this._inclusionDeviceId)){h=!0;break}a=0;if(0!=b&&0!=
m){a=Math.round(m/b*100);if(a!=this._inclusionInterViewProgress||h)this._inclusionInterViewProgress=a,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._inclusionInterViewTO=setTimeout(function(){var a=Error("interview timeout");a.code="08004";d._inclusionFinish(a,d._inclusionDeviceId)},this.INTERVIEW_TIMEOUT);this._logger.log("debug","inclusion progress:"+a);this._inclusionListener&&this._inclusionListener(3,a,"run interview")}100==a&&this._inclusionFinish(null,this._inclusionDeviceId)}};
g.prototype._onExclusionDataUpdate=function(a){a["controller.data.lastExcludedDevice"]&&(a=a["controller.data.lastExcludedDevice"].value,this._exclusionAny?"undefined"!=typeof a&&null!=a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,-1)):a&&(this._exclusionDeviceId=a,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,this._exclusionDeviceId)))};g.prototype._onUpdateInterviewDataUpdate=
function(a){var b=this;a=this._zway.getInterviewProgress(this._updateInterviewDeviceId);a!=this._updateInterviewProgress&&(this._updateInterviewProgress=a,this._updateInterviewTO&&clearTimeout(this._updateInterviewTO),this._updateInterviewTO=setTimeout(function(){var a=Error("update interview timeout");a.code="08008";b._updateInterviewFinish(a,b._updateInterviewDeviceId)},1E4));this._logger.log("debug","update interview progress:"+a);this._updateInterviewListener&&this._updateInterviewListener(2,
a,"run interview");"undefined"!=typeof this._updateInterviewInstanceID&&null!=this._updateInterviewInstanceID&&this._updateInterviewCommandClassID?(a=this._zway.listInterviewResults(this._updateInterviewDeviceId))&&a[this._updateInterviewInstanceID]&&a[this._updateInterviewInstanceID].commandClasses&&a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID]&&a[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID].interviewDone&&this._updateInterviewFinish(null,
this._updateInterviewDeviceId):100==a&&this._updateInterviewFinish(null,this._updateInterviewDeviceId)};var l={LIST:[37,38,48,49,50,64,66,67,68,69,91,98,113,128,156],getCommandClassFromId:function(a){if(!a)return null;a=parseInt(a);if(isNaN(a)||-1==this.LIST.indexOf(a))return null;switch(a){case 37:return this.SwitchBinary;case 38:return this.SwitchMultilevel;case 48:return this.SensorBinary;case 49:return this.SensorMultilevel;case 50:return this.Meter;case 64:return this.ThermostatMode;case 66:return this.ThermostatOperatingState;
case 67:return this.ThermostatSetPoint;case 68:return this.ThermostatFanMode;case 69:return this.ThermostatFanState;case 91:return this.CentralScene;case 98:return this.DoorLock;case 113:return this.Alarm;case 128:return this.Battery;case 156:return this.AlarmSensor}},SwitchBinary:{buildCMD:function(a,b,d){return a?"on"==a.value?"Set(true)":"off"==a.value?"Set(false)":"toggle"==a.value&&d&&d.data&&d.data.level?(a=d.data.level.value)?"Set(false)":"Set(true)":null:null},resolveState:function(a){return a&&
a.data&&a.data.level?[{id:"37",state:a.data.level.value?"on":"off"}]:null},getSimplifiedJSON:function(a){return a&&a.data&&a.data.level&&"SwitchBinary"==a.name?{37:{type:a.name,valueType:a.data.level.type}}:null}},SwitchMultilevel:{buildCMD:function(a,b,d){if(!a)return null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(b=a.value.substr(8),a.value="toggleTo",a.ext=b):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(b=a.value.substr(7),a.value="valueTo",a.ext=b);var f;switch(a.value){case "on":return"Set(255,0)";
case "off":return d&&d.data&&(d.data.level={value:0}),"Set(0,0)";case "toggle":if(d&&d.data&&d.data.level){if(f=d.data.level.value)d.data.level={value:0};return f?"Set(0,0)":"Set(255,0)"}break;case "toggleTo":if("undefined"==typeof a.ext||null==a.ext)break;if(d&&d.data&&d.data.level){if(f=d.data.level.value)return"Set(0,0)";f=Math.round(parseInt(a.ext)/100*99);99<f&&(f=99);0>f&&(f=0);d&&d.data&&(d.data.level={value:f});return"Set("+f+",0)"}break;case "stop":return"StopLevelChange()";case "up":return"Set(99)";
case "down":return"Set(0)";case "stepUp":b=5;if("undefined"!=typeof a.ext||null!=a.ext)b=parseInt(a.ext);if(d&&d.data&&d.data.level)return f=d.data.level.value,f=Math.round(parseInt(f)/99*100),f+=b,100<f&&(f=100),f=Math.round(parseInt(f)/100*99),d&&d.data&&(d.data.level={value:f}),"Set("+f+",0)";break;case "stepDown":b=5;if("undefined"!=typeof a.ext||null!=a.ext)b=parseInt(a.ext);if(d&&d.data&&d.data.level)return f=d.data.level.value,f=Math.round(parseInt(f)/99*100),f-=b,0>f&&(f=0),f=Math.round(parseInt(f)/
100*99),d&&d.data&&(d.data.level={value:f}),"Set("+f+",0)";break;case "valueTo":if("undefined"!=typeof a.ext&&null!=a.ext)return f=Math.round(parseInt(a.ext)/100*99),99<f&&(f=99),0>f&&(f=0),d&&d.data&&(d.data.level={value:f}),"Set("+f+",0)"}return null},resolveState:function(a){return a&&a.data&&a.data.level?[{id:"38",state:Math.round(parseInt(a.data.level.value)/99*100)}]:null},getSimplifiedJSON:function(a){return a&&a.data&&a.data.level&&"SwitchMultilevel"==a.name?{38:{type:a.name,valueType:a.data.level.type}}:
null}},SensorMultilevel:{resolveState:function(a){if(!a||!a.data)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];c&&c.val&&(b||(b=[]),b.push({id:"49."+f,state:c.val.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"SensorMultilevel"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.sensorTypeString&&f.scaleString&&f.val&&(b||(b={}),b["49."+d]={name:f.sensorTypeString.value,unit:f.scaleString.value,
valueType:f.val.type,type:"SensorMultilevel"})}return b}},SensorBinary:{resolveState:function(a){if(!a||!a.data)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];c&&c.level&&(b||(b=[]),b.push({id:"48."+f,state:c.level.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"SensorBinary"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.sensorTypeString&&f.level&&(b||(b={}),b["48."+d]={name:f.sensorTypeString.value,
type:"SensorBinary"})}return b}},Meter:{buildCMD:function(a,b,d){return a?"reset"==a.value?"Reset()":null:null},resolveState:function(a){if(!a||!a.data)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];c&&c.val&&(b||(b=[]),b.push({id:"50."+f,state:c.val.value}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"Meter"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.sensorTypeString&&f.scaleString&&f.val&&
(b||(b={}),b["50."+d]={name:f.sensorTypeString.value,unit:f.scaleString.value,valueType:f.val.type,type:"Meter"})}return b}},ThermostatSetPoint:{buildCMD:function(a,b,d){if(!a)return null;if(5<a.value.length&&"setTo"==a.value.substr(0,5)){var f=a.value.substr(5);a.value="setTo";a.ext=f}else 2<a.value.length&&"up"==a.value.substr(0,2)?(f=a.value.substr(2),a.value="up",a.ext=f):4<a.value.length&&"down"==a.value.substr(0,4)&&(f=a.value.substr(4),a.value="down",a.ext=f);b=b[b.length-1];switch(a.value){case "up":f=
.5;if("undefined"!=typeof a.ext||null!=a.ext)f=parseFloat(a.ext);if(d&&d.data&&d.data[b]&&d.data[b].setVal){a=d.data[b];var c=a.setVal.value;c+=f;a.max&&c>a.max.value&&(c=a.max.value);d.data[b].setVal.value=c;return"Set("+b+","+c+")"}break;case "down":f=.5;if("undefined"!=typeof a.ext||null!=a.ext)f=parseFloat(a.ext);if(d&&d.data&&d.data[b]&&d.data[b].setVal)return a=d.data[b],c=a.setVal.value,c-=f,a.min&&c<a.min.value&&(c=a.min.value),d.data[b].setVal.value=c,"Set("+b+","+c+")";break;case "setTo":if("undefined"!=
typeof a.ext&&null!=a.ext&&(c=parseFloat(a.ext),d&&d.data&&d.data[b]&&d.data[b].setVal))return d.data[b].setVal.value=c,"Set("+b+","+c+")"}return null},resolveState:function(a){if(!a||!a.data)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];if(c&&c.val){var e=c.val.value;e=c.setVal?e+(":"+c.setVal.value):e+(":"+e);b||(b=[]);b.push({id:"67."+f,state:e})}}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"ThermostatSetPoint"!=a.name)return null;var b=
null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)&&(f=a.data[d])&&f.modeName&&f.scaleString&&f.val){b||(b={});var c={name:f.modeName.value,unit:f.scaleString.value,valueType:f.val.type,type:"ThermostatSetPoint"};f.min&&(c.min=f.min.value);f.max&&(c.max=f.max.value);b["67."+d]=c}}return b}},ThermostatMode:{_MODES:["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"],buildCMD:function(a,
b,d){if(!a)return null;13<a.value.length&&"setThermoMode"==a.value.substr(0,13)&&(b=a.value.substr(13),a.value="setThermoMode",a.ext=b);switch(a.value){case "thermoModeOff":return"Set(0)";case "thermoModeHeat":return"Set(1)";case "thermoModeCool":return"Set(2)";case "thermoModeAuto":return"Set(3)";case "setThermoMode":return"Set("+a.ext+")"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var b=[];b.push({id:"64",state:a.data.mode.value});return b},getSimplifiedJSON:function(a){if(!a||
!a.data||"ThermostatMode"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.modeName&&f.modeName.value&&(b||(b={}),b[d]=f.modeName.value)}return{64:{type:"ThermostatMode",valueType:"int",modes:b}}}},ThermostatOperatingState:{_MODES:"IDLE HEATING COOLING FAN_ONLY PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" "),resolveState:function(a){if(!a||!a.data||!a.data.state)return null;
var b=[];b.push({id:"66",state:a.data.state.value});return b},getSimplifiedJSON:function(a){return a&&a.data&&"ThermostatOperatingState"==a.name?{66:{type:"ThermostatOperatingState",valueType:a.data.state.type}}:null}},ThermostatFanMode:{_MODES:"AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" "),buildCMD:function(a,b,d){if(!a)return null;16<a.value.length&&"setThermoFanMode"==a.value.substr(0,16)&&(b=a.value.substr(16),a.value=
"setThermoFanMode",a.ext=b);b="Off"==a.ext?0:1;switch(a.value){case "thermoFanModeAutoLow":return"Set("+b+",0)";case "thermoFanModeLow":return"Set("+b+",1)";case "thermoFanModeAutoHigh":return"Set("+b+",2)";case "thermoFanModeHigh":return"Set("+b+",3)";case "setThermoFanMode":return b?"Set("+b+","+a.ext+")":"Set("+b+",1)"}return null},resolveState:function(a){if(!a||!a.data||!a.data.mode)return null;var b=[],d={id:"68",state:a.data.mode.value};a.data&&a.data.on&&!a.data.on.value&&(d={id:"68",state:"off"});
b.push(d);return b},getSimplifiedJSON:function(a){if(!a||!a.data||"ThermostatFanMode"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.modeName&&f.modeName.value&&(b||(b={}),b[d]=f.modeName.value)}return{68:{type:"ThermostatFanMode",valueType:"int",modes:b}}}},ThermostatFanState:{resolveState:function(a){if(!a||!a.data||!a.data.state)return null;var b=[];b.push({id:"69",state:a.data.state.value?"on":"off"});return b},getSimplifiedJSON:function(a){return a&&
a.data&&"ThermostatFanState"==a.name?{69:{type:"ThermostatFanState"}}:null}},CentralScene:{resolveState:function(a,b,d){if(!(a&&a.data&&a.data.currentScene&&a.data.keyAttribute)||a.data.currentScene.value)return null},resolveUpdate:function(a,b,d){if(!(a&&a.data&&a.data.currentScene&&a.data.keyAttribute))return null;var f=a.data.currentScene.value;if(f){var c=null;switch(a.data.keyAttribute.value){case 0:c="press";break;case 1:c="release";break;case 2:c="hold"}if(!c)return null;a={};a[d+"."+b+".91."+
f]=c;e.sendSTAEvent({type:"ZWAVE2",adr:d,state:a});return null}},getSimplifiedJSON:function(a){if(!a||!a.data||!a.data.maxScenes||"CentralScene"!=a.name)return null;var b={};a=a.data.maxScenes.value;for(var d=1;d<=a;d++)b["91."+d]={name:"Key "+d,type:"CentralScene"};return b}},Alarm:{_EVNETS:{1:{1:"Smoke",2:"Smoke",3:"Smoke Alarm Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance",8:"Maintenance Dust"},2:{1:"CO",2:"CO",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",
6:"Alarm Silenced",7:"Maintenance"},3:{1:"CO2",2:"CO2",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance"},4:{1:"Overheat",2:"Overheat",3:"Rapid Temperature Rise",4:"Rapid Temperature Rise",5:"Under Heat",6:"Under Heat",7:"Heat Alarm Test",8:"Replacement End-of-life",9:"Alarm Silenced",10:"Maintenance Dust",11:"Maintenance"},5:{1:"Water Leak",2:"Water Leak",3:"Water Level Dropped",4:"Water Level Dropped",5:"Replace Water Filter",6:"Water Flow Alarm",7:"Water Pressure Alarm"},
6:{1:"Manual Lock",2:"Manual Unlock",3:"RF Lock",4:"RF Unlock",5:"Keypad Lock",6:"Keypad Unlock",7:"Manual Not Fully Locked",8:"RF Not Fully Locked",9:"Auto Lock Locked",10:"Auto Lock Not Fully Locked",11:"Lock Jammed",22:"Contact Opened",23:"Contact Closed"},7:{1:"Intrusion",2:"Intrusion",3:"Tampering",4:"Tampering",5:"Glass Breakage",6:"Glass Breakage",7:"Motion Detection",8:"Motion Detection",9:"Motion Detection"},8:{1:"Power has been applied",10:"Replace battery soon",11:"Replace battery now",
14:"Charge battery soon",15:"Charge battery now"}},buildCMD:function(a,b,d){if(!a||!b)return null;b=b[b.length-1];if("on"==a.value)return"Set("+b+",255)";if("off"==a.value)return"Set("+b+",0)";if("toggle"==a.value){if(d&&d.data&&d.data[b]&&(d=d.data[b].status))return(d=d.value)?"Set("+b+",0)":"Set("+b+",255)"}else if("resetAlarm"==a.value){if(d&&d.data)for(b in d.data)if(a=parseInt(b),!isNaN(a)){var f=d.data[b];if(f&&f.status&&(c.setAlarmEvent("113."+a,0),f.event&&f.event.value&&(c.setAlarm("113."+
a+"."+f.event.value,!1),f.event.value=null),f.eventMask&&f.eventMask.value))for(var e=1;255>=e;e++)x.hub.m.zway.Util.hasEvent(this,a,f.eventMask,e)&&c.getAlarm("113."+a+"."+e,!1)}return-1}return null},resolveState:function(a){if(!a||!a.data)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var e=a.data[d];if(e&&e.status){b||(b=[]);var g={id:"113."+f,state:e.status.value?"on":"off"};b.push(g);if(e.event)if(c.setAlarmEvent("113."+f,e.event.value),g={id:"113."+f+".event",state:e.event.value},
b.push(g),e.event.value&&this._EVNETS[f]&&this._EVNETS[f][e.event.value]?b.push({id:"113."+f+".eventName",state:this._EVNETS[f][e.event.value]}):0==e.event.value&&b.push({id:"113."+f+".eventName",state:"No Alarm"}),e.event.value)c.setAlarm("113."+f+"."+e.event.value,!0);else if(0==e.event.value&&e.eventParameters&&e.eventParameters.value)if(g=e.eventParameters.value,0==g.length){if(e.eventMask&&e.eventMask.value)for(var h=1;255>=h;h++)(g=x.hub.m.zway.Util.hasEvent(this,f,e.eventMask,h))&&c.setAlarm("113."+
f+"."+h,!1)}else for(h=0;h<g.length;h++)c.setAlarm("113."+f+"."+g[h],!1);if(e.eventMask&&e.eventMask.value)for(h=1;255>=h;h++)if(g=x.hub.m.zway.Util.hasEvent(this,f,e.eventMask,h)){g={id:"113."+f+"."+h,state:!1};var p=c.getAlarm("113."+f+"."+h);p&&(g.state=p);b.push(g)}}}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"Alarm"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];if(c&&c.typeString&&c.status&&(b||(b={}),b["113."+d]={name:c.typeString.value,
subtype:d,type:"Alarm"},c.eventMask&&c.eventMask.value))for(var e=1;255>=e;e++){var g=x.hub.m.zway.Util.hasEvent(this,f,c.eventMask,e);g&&(b["113."+d+"."+e]={name:g,eventID:e,type:"Alarm.Event"})}}}return b}},Battery:{resolveState:function(a){return a&&a.data&&a.data.last?[{id:"128",state:a.data.last.value}]:null},getSimplifiedJSON:function(a){return a&&a.data&&"Battery"==a.name?{128:{name:"Battery",valueType:"int",type:"Battery"}}:null}},AlarmSensor:{resolveState:function(a){if(!a||!a.data)return null;
var b=null,d;for(d in a.data){var f=parseInt(d);if(!isNaN(f)){var c=a.data[d];c&&c.sensorState&&(b||(b=[]),b.push({id:"156."+f,state:c.sensorState.value?"on":"off"}))}}return b},getSimplifiedJSON:function(a){if(!a||!a.data||"AlarmSensor"!=a.name)return null;var b=null,d;for(d in a.data){var f=parseInt(d);isNaN(f)||(f=a.data[d])&&f.typeString&&(b||(b={}),b["156."+d]={name:f.typeString.value,subtype:d,type:"AlarmSensor"})}return b}},DoorLock:{_MODE:{0:"unlock",1:"unlock_with_timeout",16:"inside_handle_unlock",
17:"inside_handle_unlock_with_timeout",32:"outside_handle_unlock",33:"outside_handle_unlock_with_timeout",254:"unknown",255:"lock"},buildCMD:function(a,b,d){if(!a)return null;8<a.value.length&&"toggleTo"==a.value.substr(0,8)?(b=a.value.substr(8),a.value="toggleTo",a.ext=b):7<a.value.length&&"valueTo"==a.value.substr(0,7)&&(b=a.value.substr(7),a.value="valueTo",a.ext=b);switch(a.value){case "unlock":return"Set(0)";case "unlock_with_timeout":return"Set(1)";case "inside_handle_unlock":return"Set(16)";
case "inside_handle_unlock_with_timeout":return"Set(17)";case "outside_handle_unlock":return"Set(32)";case "outside_handle_unlock_with_timeout":return"Set(33)";case "lock":return"Set(255)"}return null},resolveState:function(a){if(!a||!a.data)return null;var b=[];if(a.data.mode){var d=this._MODE[a.data.mode.value];d&&b.push({id:"98.mode",state:d})}a.data.opType&&b.push({id:"98.op_mode",state:1==a.data.opType.value?"constant":"autolock"});return 0==b.length?null:b},getSimplifiedJSON:function(a){return a&&
a.data&&"DoorLock"==a.name?{98:{name:"DoorLock",type:a.name}}:null}}},k=function(a,b,d,f){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay");this._learnHandler=new g(this);this._ip=a;this._port=b;this._username=d;this._password=f;this._data=null;this._dataUpdateListeners=[];this._dataUpdateRunning=!1;this._dataUpdateCB=[];this._dataUpdatePeriod=1E3;this._dataUpdateTO=null;this._dataFullRunning=!1;this._dataFullCB=[];this._dataFullPeriod=1E4;this._running=!1};k.prototype.start=function(a){this._running||
(this._running=!0,this._getDataFull());a&&a()};k.prototype.stop=function(a){this._running&&(this._running=!1);this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);a&&a()};k.prototype.addDataUpdateListener=function(a){a&&-1==this._dataUpdateListeners.indexOf(a)&&this._dataUpdateListeners.push(a)};k.prototype.removeDataUpdateListener=function(a){a&&(a=this._dataUpdateListeners.indexOf(a),-1!=a&&this._dataUpdateListeners.splice(a,1))};k.prototype.getData=function(){return this._data};
k.prototype.getDevices=function(){return this._data&&this._data.devices?this._data.devices:null};k.prototype.getDevice=function(a){return a&&this._data&&this._data.devices?this._data.devices[a]:null};k.prototype.getSimplifiedJSON=function(a){if(!this._data||!this._data.devices||!this._data.devices[a])return null;var b=this._data.devices[a];if(!b.data||!b.instances)return null;var d=b.data,f={};f.id=a;f.basicType=d.basicType?d.basicType.value:null;f.genericType=d.genericType?d.genericType.value:null;
f.specificType=d.specificType?d.specificType.value:null;f.type=d.deviceTypeString?d.deviceTypeString.value:null;f.vendor=d.vendorString?d.vendorString.value:null;f.name=d.givenName?d.givenName.value:null;f.interViewProgress=this.getInterviewProgress(a);d=this.listInterviewResults(a);f.instanceInterViewProgress={};for(var c in d)if(d[c]&&d[c].commandClasses){a=d[c].commandClasses;var e=0,g=0,h;for(h in a)e+=1,a[h]&&a[h].interviewDone&&(g+=1);f.instanceInterViewProgress[c]=Math.round(100*g/e)}f.instance=
{};b=b.instances;for(c in b)if((a=b[c])&&a.commandClasses){f.instance[c]={commandClasses:{}};a=a.commandClasses;for(var k in a)if(h=a[k])if(d=null,(e=l.getCommandClassFromId(k))&&(d=e.getSimplifiedJSON(h)),d)for(var n in d)f.instance[c].commandClasses[n]=d[n]}return f};k.prototype.getInterviewProgress=function(a){a=this.getDevice(a);if(!a)return-1;var b=0,d=0,f;for(f in a.instances){var c=a.instances[f];if(c&&c.commandClasses)for(var e in c.commandClasses){var g=c.commandClasses[e];g&&g.data&&(g.data.interviewDone&&
(b+=1),g.data.interviewDone.value&&(d+=1))}}return Math.round(d/b*100)};k.prototype.listInterviewResults=function(a){a=this.getDevice(a);if(!a)return null;var b={},d;for(d in a.instances){var f=a.instances[d];if(f&&f.commandClasses)for(var c in f.commandClasses){var e=f.commandClasses[c];e&&e.data&&e.data.interviewDone&&(b[d]||(b[d]={commandClasses:{}}),b[d].commandClasses[c]={interviewDone:e.data.interviewDone.value})}}return b};k.prototype.executeCommand=function(a,b,d){if(a&&b){b.value||(b={value:b});
var f=a.split(".");if(3>f.length)d&&d(Error("address invalid"));else if(this._data&&this._data.devices){var c=this._data.devices[f[0]];if(c)if(c.instances&&c.instances[f[1]]){var e=c.instances[f[1]];if(e.commandClasses&&e.commandClasses[f[2]]){e=e.commandClasses[f[2]];var g=null,h=l.getCommandClassFromId(f[2]);h&&(g=h.buildCMD(b,f,e));if(g)if(-1==g)d&&d();else{var k=this;this._doRunRequest("devices["+f[0]+"].instances["+f[1]+"].commandClasses["+f[2]+"]."+g,null,function(b){b||k._postCommandExecution(c,
a);d&&d(b)})}else d&&d(Error("command invalid"))}else d&&d(Error("no such command class:"+f[2]))}else d&&d(Error("no such instance:"+f[1]));else d&&d(Error("no such device with id:"+f[0]))}else d&&d(Error("initialization not finish"))}else d&&d(Error("address or command is null"))};k.prototype._postCommandExecution=function(a,b){a&&b&&a.data&&a.data.vendorString&&"Fibaro"==a.data.vendorString.value&&(a=b.split("."),"64"!=a[2]&&"67"!=a[2]||setTimeout(function(){x.hub.m.zway.PollManager._pollCommandClass([b])},
2E3))};k.prototype.getStates=function(a){var b=this._getStates();a&&a(null,b)};k.prototype._getStates=function(){if(!this._data||!this._data.devices)return{};var a={},b;for(b in this._data.devices)if(1!=b){var d=this._getState(b);if(d)for(var f in d)a[f]=d[f]}return a};k.prototype._getState=function(a){return this._data&&this._data.devices?this._resolveDeviceState(a,this._data.devices[a]):null};k.prototype._resolveDeviceState=function(a,b){if(!b)return null;var d={};if(b&&b.instances)for(var f in b.instances){var c=
b.instances[f];if(c.commandClasses)for(var e in c.commandClasses){var g=c.commandClasses[e],h=null,k=l.getCommandClassFromId(e);k&&(h=k.resolveState(g,f,a));if(h)for(g=0;g<h.length;g++){var n=k=null;h[g].id&&(k=a+"."+f+"."+h[g].id);"undefined"!=typeof h[g].state&&null!=h[g].state&&(n=h[g].state);k&&"undefined"!=typeof n&&null!=n&&(d[a]||(d[a]={}),d[a][k]=n)}}}return d};k.prototype.inclusion=function(a,b){this._learnHandler.inclusion(a,b)};k.prototype.exclusion=function(a,b){this._learnHandler.exclusion(a,
b)};k.prototype.updateInterview=function(a,b,d,f,c){this._learnHandler.updateInterview(a,b,d,f,c)};k.prototype.resetController=function(a){this._resetController(a)};k.prototype.backup=function(a,b){this._logger.log("debug","backup zwave to folder:"+a);var d={host:this._ip,port:this._port,path:"/ZWaveAPI/Backup",method:"GET"};this._username&&(d.auth=this._username+":"+(this._password?this._password:""));this._logger.log("trace","send http request:"+JSON.stringify(d));var f=b,c=this;b=require("http").request(d,
function(b){if(200!=b.statusCode)f&&f(Error("http status code:"+b.statusCode)),f=null;else{var d=require("fs"),c=require("path").join(a,"z-way-backup.zbk");if(d.existsSync(c))try{d.unlinkSync(c)}catch(n){f&&f(n);f=null;return}var e=d.createWriteStream(c);b.pipe(e);e.on("finish",function(){e.close(function(){f&&f(null,c);f=null})});e.on("error",function(a){d.unlink(c);f&&f(a);f=null})}});b.on("error",function(a){c._logger.log("trace","http request error:"+a.stack);f&&f(a);f=null});b.setTimeout(1E4,
function(){c._logger.log("trace","http request timeout");f&&f(Error("http timeout"));f=null});b.end()};k.prototype.restore=function(a,b,d){this._logger.log("debug","restore zwave (restoreStick="+b+") from file:"+a);var f=require("form-data"),c=require("fs");f=new f;f.append("config_backup",c.createReadStream(a));a={host:this._ip,port:this._port,path:"/ZWave.zway/Restore?restore_chip_info="+(b?1:0),method:"POST",headers:f.getHeaders()};this._username&&(a.auth=this._username+":"+(this._password?this._password:
""));this._logger.log("trace","send http request:"+JSON.stringify(a));b=require("http");var e=d,g=this;d=b.request(a,function(a){var b="";a.setEncoding("utf-8");a.on("data",function(a){b+=a});a.on("end",function(){g._logger.log("trace","http response status:"+a.statusCode);g._logger.log("trace","http response data:"+b);var d=null;200!=a.statusCode?(d=Error("http response "+a.statusCode+" data:"+b),e&&e(d,b,a.statusCode),e=null):setTimeout(function(){e&&e(null,b,a.statusCode);e=null},15E3)})});d.on("error",
function(a){g._logger.log("trace","http request error:"+a.stack);e&&e(a);e=null});d.setTimeout(1E4,function(){g._logger.log("trace","http request timeout");e&&e(Error("http timeout"));e=null});f.pipe(d)};k.prototype.pollDataUpdate=function(){this._data?this._getDataUpdate():this._getDataFull()};k.prototype._onDataUpdate=function(a){if(this._running){var b=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);this._dataUpdateTO=setTimeout(function(){b.pollDataUpdate()},this._dataUpdatePeriod);
if(a){var d=Object.keys(a);1<d.length&&this._logger.log("info","get data update:"+JSON.stringify(a));var f=null;d.forEach(function(d){if("updateTime"==d)b._data[d]=a[d];else if("devices"==d)b._data.devices=a[d];else{var c=d.split(".");if(2<c.length&&"devices"==c[0]){var e=c[1],g=b._data.devices[e];f||(f={});f[e]||(f[e]={device:g,updates:{}});f[e].updates[d]=a[d]}e=b._data;for(g=0;g<c.length-1;){e=e[c[g]];if(!e)break;g++}if(e){g=e[c[c.length-1]];var h=a[d];g&&h&&g.updateTime==h.updateTime?f&&delete f[c[1]].updates[d]:
e[c[c.length-1]]=a[d]}}});f&&this._onDeviceEvent(f);this._dataUpdateListeners.forEach(function(d){d&&d(a)})}}};k.prototype._onDataFull=function(a){if(this._running){this._logger.log("info","get data full:"+JSON.stringify(a));var b=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);var d=this._dataUpdatePeriod;a||(d=this._dataFullPeriod);this._dataUpdateTO=setTimeout(function(){b.pollDataUpdate()},d);this._data=a}};k.prototype._onDeviceEvent=function(a){if(a)for(var b in a){var d=a[b];if(d&&
d.updates){var c=!1,g={},k;for(k in d.updates){var q=k.split(".");if("instances"==q[2]){var p=q[3];if(p&&"commandClasses"==q[4]){var r=parseInt(q[5]);-1!=l.LIST.indexOf(r)&&(c=!0,g[p]||(g[p]={}),g[p][r]||(g[p][r]={data:{}}),"data"==q[6]&&q[7]&&(g[p][r].data[q[7]]=d.updates[k]))}}}for(p in g)for(r in d=g[p],d){q=d[r];var n=l.getCommandClassFromId(r);n&&n.resolveUpdate&&n.resolveUpdate(q,p,b)}c&&(c=this._getState(b))&&c[b]&&h.updateState(b,c[b])&&e.sendSTAEvent({type:"ZWAVE2",adr:b,state:c[b]})}}};
k.prototype._startInclusion=function(a){var b=this;this._doRunRequest("controller.AddNodeToNetwork(1)",null,function(d,c,e){d?b._logger.log("warn","start include device error:"+d.stack):200!=e?(d=Error("start include device http response code:"+e),b._logger.log("warn","start include device  http error:"+e+" data:"+c)):b._logger.log("debug","start include device success:"+c);a&&a(d,c)})};k.prototype._stopInclusion=function(a){var b=this;this._doRunRequest("controller.AddNodeToNetwork(0)",null,function(d,
c,e){d?b._logger.log("warn","stop include device error:"+d.stack):200!=e?(d=Error("stop include device http response code:"+e),b._logger.log("warn","stop include device  http error:"+e+" data:"+c)):b._logger.log("debug","stop include device success:"+c);a&&a(d,c)})};k.prototype._startExclusion=function(a){var b=this;this._doRunRequest("controller.RemoveNodeFromNetwork(1)",null,function(d,c,e){d?b._logger.log("warn","start exclude device error:"+d.stack):200!=e?(d=Error("start exclude device http response code:"+
e),b._logger.log("warn","start exclude device http error:"+e+" data:"+c)):b._logger.log("debug","start exclude device success:"+c);a&&a(d,c)})};k.prototype._stopExclusion=function(a){var b=this;this._doRunRequest("controller.RemoveNodeFromNetwork(0)",null,function(d,c,e){d?b._logger.log("warn","stop exclude device error:"+d.stack):200!=e?(d=Error("stop exclude device http response code:"+e),b._logger.log("warn","stop exclude device http error:"+e+" data:"+c)):b._logger.log("debug","stop exclude device success:"+
c);a&&a(d,c)})};k.prototype._startUpdateInterview=function(a,b,d,c){var f=this.getDevice(a);if(f){var e=[];if("undefined"!=typeof b&&null!=b&&d)e.push({deviceID:a,instanceID:b,commandClassID:d});else for(var g in f.instances)if((b=f.instances[g])&&b.commandClasses)for(var h in b.commandClasses)(d=b.commandClasses[h])&&d.data&&d.data.interviewDone&&!d.data.interviewDone.value&&e.push({deviceID:a,instanceID:g,commandClassID:h});if(0==e.length)c&&c();else{var k=this,l=0,t=function(){l++;l==e.length?
c&&c():k._startInterview(e[l].deviceID,e[l].instanceID,e[l].commandClassID,t)};this._startInterview(e[l].deviceID,e[l].instanceID,e[l].commandClassID,t)}}else c&&c(Error("no such device:"+a))};k.prototype._startInterview=function(a,b,d,c){var e=a+"."+b+"."+d;this._logger.log("debug","start interview:"+e);var f=this;this._doRunRequest("devices["+a+"].instances["+b+"].commandClasses["+d+"].Interview()",null,function(a,d,b){a?f._logger.log("warn","start interview "+e+" error:"+a.stack):200!=b?(a=Error("start interview "+
e+" http response code:"+b),f._logger.log("warn","start interview "+e+" http error:"+b+" data:"+d)):f._logger.log("debug","start interview "+e+" success:"+d);c&&c(a,d)})};k.prototype._resetController=function(a){var b=this;this._doRunRequest("controller.SetDefault()",null,function(d,c,e){d?b._logger.log("warn","reset controller error:"+d.stack):200!=e?(d=Error("reset controller http response code:"+e),b._logger.log("warn","reset controller http error:"+e+" data:"+c)):b._logger.log("debug","reset controller success:"+
c);a&&a(d,c)})};k.prototype._getDataFull=function(a){a&&-1==this._dataFullCB.indexOf(a)&&this._dataFullCB.push(a);if(!this._dataFullRunning){this._dataFullRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var b=this;this._logger.log("debug","get data all");this._doDataRequest(null,function(a,c,e){a?b._logger.log("warn","get data full error:"+a.stack):200!=e?(a=Error("get data http response code:"+e),b._logger.log("warn","get data full http error:"+e+" data:"+
c)):b._logger.log("debug","get data full success:"+JSON.stringify(c));b._dataFullRunning=!1;e=b._dataFullCB;b._dataFullCB=[];!a&&c?b._onDataFull(c):a&&b._onDataFull(null);e.forEach(function(b){b&&b(a,c)})})}};k.prototype._getDataUpdate=function(a){a&&-1==this._dataUpdateCB.indexOf(a)&&this._dataUpdateCB.push(a);if(!this._dataUpdateRunning){this._dataUpdateRunning=!0;this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var b=this;(a=this._data.updateTime)||(a=Math.floor((new Date).getTime()/
1E3));this._logger.log("trace","get data update with timestamp:"+a);this._doDataRequest(a,function(a,c,e){a?b._logger.log("warn","get data update error:"+a.stack):200!=e?(a=Error("get data update http response code:"+e),b._logger.log("warn","get data update  http error:"+e+" data:"+c)):b._logger.log("trace","get data update success:"+JSON.stringify(c));b._dataUpdateRunning=!1;e=b._dataUpdateCB;b._dataUpdateCB=[];!a&&c?b._onDataUpdate(c):a&&b._onDataUpdate(null);e.forEach(function(b){b&&b(a,c)})})}};
k.prototype._doDataRequest=function(a,b){var d="/ZWaveAPI/Data/";a&&(d+=a);var c=1E4;a&&(c=1E3);var e=this;this._logger.log("trace","get data with path:"+d);this._doRequest(d,null,null,c,function(a,c,f){if(a)e._logger.log("trace","get data with path:"+d+" error:"+a.stack),b&&b(a);else{e._logger.log("trace","get data with path:"+d+" status:"+f);e._logger.log("trace","get data result:"+c);try{var g=JSON.parse(c);b&&b(null,g,f)}catch(n){b&&b(n)}}})};k.prototype._doRunRequest=function(a,b,d){var c="/ZWaveAPI/Run/"+
a;b||(b=1E3);var e=this;this._logger.log("trace","do run request:"+c);this._doRequest(c,null,null,b,function(a,b,f){a?(e._logger.log("trace","do run request with path:"+c+" error:"+a.stack),d&&d(a)):(e._logger.log("trace","do run request with path:"+c+" status:"+f),e._logger.log("trace","do run request result:"+b),d&&d(null,b,f))})};k.prototype._doRequest=function(a,b,c,e,g){a={host:this._ip,port:this._port,path:a,method:"POST"};b&&(a.headers=b);c&&(a.headers["Content-Length"]=c.length);this._username&&
(a.auth=this._username+":"+(this._password?this._password:""));var d=g,f=this;this._logger.log("trace","send http request:"+JSON.stringify(a));this._logger.log("trace","send http data:"+c);b=require("http").request(a,function(a){var b="";a.setEncoding("utf-8");a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace","http response status:"+a.statusCode);f._logger.log("trace","http response data:"+b);var c=null;200!=a.statusCode&&(c=Error("http response "+a.statusCode+" data:"+b));
d&&d(c,b,a.statusCode)})});b.on("error",function(a){f._logger.log("trace","http request error:"+a.stack);d&&d(a);d=null});b.setTimeout(e,function(){f._logger.log("trace","http request timeout");d&&d(Error("http timeout"));d=null});c&&b.write(c);b.end()};return k}();
x.hub.m.zway.Handler=function(){var h=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.Handler");this._zway=null;this._pollManager=x.hub.m.zway.PollManager;this._settingsManager=x.hub.m.zway.SettingsManager};util.inherits(h,EventEmitter);h.prototype.ZWay=x.hub.m.zway.ZWay;h.prototype.getSystems=function(){return["zway"]};h.prototype.init=function(e){this._logger.log("debug","init zway");var c=this,g=require("x.hub.eventbus.js");g.on("x.hub.peripheralman.ADD_ZWAVE",function(e){c._logger.log("debug",
"insert zwave usb stick");c._logger.log("info","connect to local zwave server");c._start()});g.on("x.hub.peripheralman.REMOVE_ZWAVE",function(e){c._logger.log("debug","eject zwave usb stick");c._logger.log("info","disconnect from local zwave server");c._stop()});global.ZWAVE2_URL&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM&&(this._logger.log("info","connect to remote zwave server"),this._start());this._pollManager.init(this,function(){c._settingsManager.init(c,function(){e&&e({})})})};h.prototype._start=
function(){this._zway||(this._zway="CA"==global.HARDWARE_VERSION?new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT,"mediola","mediola"):new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT));this._zway.start()};h.prototype._stop=function(){this._zway&&(this._zway.stop(),this._zway=null)};h.prototype.getAllStates=function(){return this._zway?this._zway._getStates():null};h.prototype.executeCommand=function(e,c,g){e&&e.address&&e.type?c&&c.value?this._ozw?this._ozw.executeCommand(e,c.value,function(c){g&&
g({error:c})}):g&&g({error:Error("zwave serial not initialized")}):g&&g({error:Error("command invalid")}):g&&g({error:Error("device invalid")})};h.prototype.learnDevice=function(e,c,g){this._zway?this._zway.inclusion(c,function(c,e){g&&g({error:c,data:e})}):g&&g({error:Error("zwave module not running")})};h.prototype.removeDevice=function(e,c){this._zway?this._zway.exclusion(e?e.address:-1,function(e,h){c&&c({error:e,data:{deviceID:h}})}):c&&c({error:Error("zwave module not running")})};h.prototype.listDevices=
function(e,c){if(this._zway){var g=this._zway.getDevices();if(g){e=[];for(var h in g)h&&(g=this._zway.getSimplifiedJSON(h))&&e.push(g);c&&c({data:e})}else c&&c({data:[]})}else c&&c({error:Error("zwave module not running")})};h.prototype.updateInterview=function(e,c,g,h,k){this._zway?this._zway.updateInterview(e,c,g,h,function(a,b){k&&k({error:a,data:b})}):k&&k({error:Error("zwave module not running")})};h.prototype.listInterviewResults=function(e,c){if(this._zway)if(e&&e.address){var g=this._zway.listInterviewResults(e.address);
c&&c({data:g})}else{var h=this._zway.getDevices();if(h){e={};for(g in h)g&&(h=this._zway.listInterviewResults(g))&&(e[g]||(e[g]={instances:{}}),e[g].instances=h);c&&c({data:e})}else c&&c({data:[]})}else c&&c({error:Error("zwave module not running")})};h.prototype.resetController=function(e){this._zway?this._zway.resetController(function(c,g){e&&e({error:c})}):e&&e({error:Error("zwave module not running")})};h.prototype.getAllStatesLegacy=function(e){var c=[],g=this.getAllStates();if(g)for(var h in g)c.push({type:"ZWAVE2",
adr:h,state:g[h]});e&&e({data:c})};h.prototype.executeCommandLegacy=function(e,c,g){this._zway?e?c?this._zway.executeCommand(e,c,function(c){g&&g({error:c})}):g&&g({error:Error("command invalid")}):g&&g({error:Error("address invalid")}):g&&g({error:Error("zwave module not running")})};h.prototype.getZway=function(){return this._zway};h.prototype.startPoller=function(e,c){this._pollManager.startPoller(e,c)};h.prototype.stopPoller=function(e){this._pollManager.stopPoller(e)};h.prototype.forcePoll=function(e,
c){this._pollManager.immediatelyPoll(e);c&&c({data:{}})};h.prototype.setDeviceSetting=function(e,c,g){this._zway?this._zway.getData()?e?c?this._settingsManager.setSetting(e,c,function(c,e){g&&g({error:c?c:null,data:e?e.toJSON():null})}):g&&g({error:Error("setting json invalid")}):g&&g({error:Error("device id invalid")}):g&&g({error:Error("zwave module initialization not finish")}):g&&g({error:Error("zwave module not running")})};h.prototype.getDeviceSetting=function(e,c){this._zway?this._zway.getData()?
e?this._settingsManager.getSetting(e,function(e,h){c&&c({error:e?e:null,data:h?h.toJSON():null})}):c&&c({error:Error("device id invalid")}):c&&c({error:Error("zwave module initialization not finish")}):c&&c({error:Error("zwave module not running")})};return h}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zway.Handler);
