var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.netatmo=xnm.aio.netatmo||{};
xnm.aio.netatmo.Cloud=function(){var k={},e={},g={},t={},f=function(a){return a.refreshToken?a.refreshToken:a.user?e[a.user]:null},d=function(a){var b=f(a);if(!b)return null;k[b]||(k[b]={cloud:a});return k[b].cred?k[b].cred:{refresh_token:b}},m=function(a,b){var c=b.refresh_token;a.refreshToken||(a.refreshToken=c);a.user&&(e[a.user]=c);k[c]||(k[c]={cloud:a});k[c].cred=b;b.expires_in&&(b._expireTime=(new Date).getTime()+1E3*b.expires_in-6E5)},r=function(a){return(a=d(a))&&a._expireTime?(new Date).getTime()>
a._expireTime:!1},w=function(a){var b=f(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].weather||(k[b].weather={updateData:{running:!1,error:null}});return k[b].weather},x=function(a){a=w(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},u=function(a,b,c){var l=f(a),h=w(a);h.updateData={running:!1,error:b};try{if(!b&&c){var d=require("xnm.aio.netatmo.js")._updateListener;if(d&&0<d.length)for(var n=0;n<d.length;n++)d[n]&&d[n].updateWeather&&d[n].updateWeather(a,h.data,c)}}catch(A){}h.timer&&
clearTimeout(h.timer);d=y(a);b?h.data=null:c&&(h.data=c);c=h.tmpCBs;h.tmpCBs=[];if(c)for(n=0;n<c.length;n++)if(b)c[n](b);else a.getWeatherStatus(c[n]);b?h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},6E4):(a=y(a),d&&a&&d==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,b=60*h.retry,h.delay=b,h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},1E3*b)):(h.retry=0,(d=h.delay)||(d=0),b=6E5,a&&(c=Math.round((new Date).getTime()/1E3),c>a&&(b=600-(c-a)%600+30)),require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug",
"weather station next poll in t:"+b/60+" min delay:"+d),h.timer=setTimeout(function(){k[l].cloud.getStationsData(null)},1E3*b+1E3*d)))},y=function(a){a=w(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;return 0},z=function(a){var b=f(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].homecoach||(k[b].homecoach={updateData:{running:!1,error:null}});return k[b].homecoach},F=function(a){a=
z(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},C=function(a,b,c){var d=f(a),h=z(a);h.updateData={running:!1,error:b};try{if(!b&&c){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var n=0;n<e.length;n++)e[n]&&e[n].updateHomeCoach&&e[n].updateHomeCoach(a,h.data,c)}}catch(A){}h.timer&&clearTimeout(h.timer);e=B(a);b?h.data=null:c&&(h.data=c);c=h.tmpCBs;h.tmpCBs=[];if(c)for(n=0;n<c.length;n++)if(b)c[n](b);else a.getWeatherStatus(c[n]);b?h.timer=setTimeout(function(){k[d].cloud.getHomeCoachsData(null)},
6E4):(a=B(a),e&&a&&e==a&&1>h.retry?(h.retry=h.retry?h.retry+1:1,b=60*h.retry,h.delay=b,h.timer=setTimeout(function(){k[d].cloud.getHomeCoachsData(null)},1E3*b)):(h.retry=0,(e=h.delay)||(e=0),b=6E5,a&&(c=Math.round((new Date).getTime()/1E3),c>a&&(b=600-(c-a)%600+30)),h.timer=setTimeout(function(){k[d].cloud.getHomeCoachsData(null)},1E3*b+1E3*e)))},B=function(a){a=z(a);if(!a.data)return 0;for(var b=0;b<a.data.length;b++)if(a.data[b]&&a.data[b].dashboard_data&&a.data[b].dashboard_data.time_utc)return a.data[b].dashboard_data.time_utc;
return 0},v=function(a){var b=f(a);if(!b)return null;k[b]||(k[b]={cloud:a});k[b].thermo||(k[b].thermo={updateData:{running:!1,error:null}});return k[b].thermo},G=function(a){a=v(a);a.timer&&clearTimeout(a.timer);a.updateData={running:!0,error:null}},D=function(a,b,c){var d=f(a),h=v(a);try{if(!b&&c){var e=require("xnm.aio.netatmo.js")._updateListener;if(e&&0<e.length)for(var n=0;n<e.length;n++)e[n]&&e[n].updateThermo&&e[n].updateThermo(a,h.data,c)}}catch(A){}h.timer&&clearTimeout(h.timer);h.updateData=
{running:!1,error:b};b?h.data=null:c&&(h.data=c);c=h.tmpCBs;h.tmpCBs=[];if(c)for(e=0;e<c.length;e++)if(b)c[e](b);else a.getThermoStatus(c[e]);h.timer=b?setTimeout(function(){k[d].cloud.getThermostatsData(null)},6E4):setTimeout(function(){k[d].cloud.getThermostatsData(null)},18E5)},E=function(a,b){var c=f(a);if(!b.module)return 60;a=v(a);a.duration||(k[c].thermo.duration={});c=a.duration[b.module];if(!c){a:{if(b.module&&XC&&XC.localStorage){if(c=XC.localStorage.getItem("netatmo"))try{c=JSON.parse(c)}catch(l){}if(c&&
c.duration){c=c.duration[b.module];break a}}c=null}a.duration[b.module]=c}c||(c=60);return c},H=function(a,b,c){a=v(a);a.duration||(a.duration={});if(b.module&&(a.duration[b.module]=c,b.module&&XC&&XC.localStorage)){if(a=XC.localStorage.getItem("netatmo"))try{a=JSON.parse(a)}catch(l){}a&&"object"==typeof a||(a={});a.duration||(a.duration={});a.duration[b.module]=c;XC.localStorage.setItem("netatmo",JSON.stringify(a))}},I=function(a,b){a=v(a);if(a.data)for(var c=0;c<a.data.length;c++){var d=a.data[c];
if(d&&d._id==b.address&&d.modules)for(var h=0;h<d.modules.length;h++){var e=d.modules[h];if(e&&e._id==b.module)return e.setpoint}}return null},p=function(a,b,c){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud");this.user=a;this.password=b;this.refreshToken=c;this._scope="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence access_presence".split(" ");this._scopeFallback="read_station read_thermostat read_homecoach write_thermostat read_camera access_camera read_presence".split(" ")};
p.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value){var d=this,h={},e=E(this,a);I(this,a);switch(b.value){case "thermoAuto":h.setpoint_mode="program";break;case "thermoAway":h.setpoint_mode="away";break;case "thermoHg":h.setpoint_mode="hg";break;case "thermoOff":h.setpoint_mode="off";break;case "thermoMax":h.setpoint_mode="max";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);break;case "thermoManu":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command ext invalid"));
return}var f=b.ext;"string"==typeof b.ext&&(f=parseFloat(b.ext));5.5>f&&(f=5.5);30<f&&(f=30);h.setpoint_mode="manual";h.setpoint_endtime=Math.round(((new Date).getTime()+6E4*e)/1E3);h.setpoint_temp=f;break;case "tempDuration":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command ext invalid"));return}e=b.ext;"string"==typeof b.ext&&(e=parseFloat(b.ext));15>e&&(e=15);720<e&&(e=720);H(this,a,e);c&&c();return;default:c&&c(Error("unknow command"))}this.setThermPoint(a,h,function(b){if(b)c&&c(b);
else{b=v(d);b.data||(b.data=[]);var e;for(e=0;e<b.data.length;e++)if(b.data[e]&&b.data[e]._id==a.address){var l=b.data[e];break}l||(l={_id:a.address,modules:[]},b.data.push(l));for(e=0;e<l.modules.length;e++)if(l.modules[e]&&l.modules[e]._id==a.module){var f=l.modules[e];break}f||(f={_id:a.module},l.modules.push(f));f.setpoint=h;c&&c()}})}else c&&c(Error("command format invalid"))};p.prototype.getStatesCreator=function(a,b,c){b?this.getAllStatus(function(a,h){for(var d=[],e=0;e<b.length;e++){var l=
b[e];if(l.id){var f,q="?";if(!a&&h&&l.device&&l.device.type&&(f="NAMain"==l.device.type||"NHC"==l.device.type?l.device.address:l.device.address+"|"+l.device.module)&&l.status&&l.status.value&&(f=h[f]))if("tempFelt"==l.status.value)q=f.temp,f=f.hum,q="undefined"!=typeof q&&"undefined"!=typeof f?"NHC"==l.device.type?xnm.aio.netatmo.DM.calcFeltTemp(q,f,t):xnm.aio.netatmo.DM.calcFeltTemp(q,f,g):"?";else if("winDName"==l.status.value)q=f.winD,null===q||"undefined"==typeof q?q="?":(q=Number(q),q=isNaN(q)?
"?":23<q&&68>=q?"NO":68<q&&113>=q?"O":113<q&&158>=q?"SO":158<q&&203>=q?"S":203<q&&248>=q?"SW":248<q&&293>=q?"W":293<q&&338>=q?"NW":"N");else if(q=f[l.status.value],null==q||"undefined"==typeof q)q="?";d.push({id:l.id,status:q})}}c&&c(null,d)}):c&&c(Error("deviceList is null"))};p.prototype.getAllStatus=function(a){var b=this,c={};this.getWeatherStatus(function(d,h){d?a&&a(d):b.getThermoStatus(function(d,e){d?a&&a(d):b.getHomeCoachStatus(function(b,d){if(b)a&&a(b);else{for(var l in h)h.hasOwnProperty(l)&&
(c[l]=h[l]);for(l in e)e.hasOwnProperty(l)&&(c[l]=e[l]);for(l in d)d.hasOwnProperty(l)&&(c[l]=d[l]);a&&a(null,c)}})})})};p.prototype.getDeviceList=function(a){var b=this;this.getStationsData(function(c,d){c?a&&a(c):b.getThermostatsData(function(c,e){c?a&&a(c):b.getHomeCoachsData(function(b,c){if(b)a&&a(b);else{b={weather:[],thermostat:[]};if(d){for(var h=[],l=0;l<d.length;l++){var f=d[l];if(f&&f._id&&f.type){var g=f.station_name,m=f.module_name,k={address:f._id,type:f.type,name:g+" ("+m+")"};k.dashboard_data=
f.dashboard_data;k.modules=[];if(f.modules)for(var n=0;n<f.modules.length;n++)f.modules[n]&&f.modules[n]._id&&f.modules[n].type&&(m=f.modules[n].module_name,k.modules.push({address:f._id,module:f.modules[n]._id,type:f.modules[n].type,name:g+" ("+m+")",dashboard_data:f.modules[n].dashboard_data}));h.push(k)}}b.weather=h}if(e){h=[];for(l=0;l<e.length;l++)if((f=e[l])&&f._id&&f.type&&(g=f.station_name,f.modules))for(k=0;k<f.modules.length;k++)f.modules[k]&&f.modules[k]._id&&f.modules[k].type&&(m=f.modules[k].module_name,
h.push({address:f._id,module:f.modules[k]._id,type:f.modules[k].type,name:g+" ("+m+")"}));b.thermostat=h}if(c){h=[];for(l=0;l<c.length;l++)(f=c[l])&&f._id&&f.type&&(g=f.module_name,m={address:f._id,type:f.type,name:f.name},g&&(m.name+=" ("+g+")"),m.dashboard_data=f.dashboard_data,m.modules=[],h.push(m));b.homecoach=h}a&&a(null,b)}})})})};p.prototype.getCamList=function(a){var b=this;this.getCamsData(function(c,f){if(c)a&&a(c);else{c={cam:[]};if(f){for(var h=[],e=0;e<f.length;e++)if(f[e]&&f[e].id){var l=
f[e].name,g=f[e].cameras;if(g)for(var k=0;k<g.length;k++)if(g[k]&&g[k].id){var m="welcome";"NACamera"==g[k].type?m="welcome":"NOC"==g[k].type&&(m="presence");m&&(m={sys:"cam",type:"system",manufacturer:"netatmo",model:m,address:g[k].id},g[k].name&&(m.name=g[k].name+(l?" ("+l+")":"")),h.push(m))}}c.cam=h}f=d(b);if(c.cam&&0<c.cam.length)for(h=0;h<c.cam.length;h++)c.cam[h].refreshToken=f.refresh_token;a&&a(null,c)}})};p.prototype.getWeatherStatus=function(a){var b=function(a,b){var c={};if(b)for(var h=
0;h<b.length;h++){var d=b[h];if(d&&d._id){var f=a._resolveStationStatus(d);f&&(c[d._id]=f);if(d.modules)for(var e=0;e<d.modules.length;e++)(f=a._resolveModuleStatus(d.modules[e]))&&(c[d._id+"|"+d.modules[e]._id]=f)}}return c};this._logger.log("debug","getWeatherStatus");var c=w(this),d=this,h=a;a=null;c&&c.data?(a=b(this,c.data),h&&h(null,a),h=null):this.getStationsData(function(a){a?(h&&h(a),h=null):h&&d.getWeatherStatus(h)})};p.prototype.getHomeCoachStatus=function(a){var b=function(a,b){var c=
{};if(b)for(var h=0;h<b.length;h++){var d=b[h];if(d&&d._id){var f=a._resolveHomeCoachStatus(d);f&&(c[d._id]=f)}}return c};this._logger.log("debug","getHomeCoachStatus");var c=z(this),d=this,h=a;a=null;c&&c.data?(a=b(this,c.data),h&&h(null,a),h=null):this.getHomeCoachsData(function(a){a?(h&&h(a),h=null):h&&d.getHomeCoachStatus(h)})};p.prototype.getThermoStatus=function(a){var b=function(a,b){for(var c={},h=0;h<b.length;h++){var d=b[h];if(d&&d._id&&d.modules)for(var f=0;f<d.modules.length;f++){var e=
a._resolveModuleStatus(d.modules[f]);e&&(c[d._id+"|"+d.modules[f]._id]=e)}}return c},c=v(this),d=this,h=a,f=null;c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):c.data?(f=b(this,c.data),h&&h(null,f),h=null):this.getThermostatsData(function(a){a?(h&&h(a),h=null):h&&d.getThermoStatus(h)})};p.prototype.getCamUrl=function(a,b){var c=this;this._refreshToken(this.refreshToken,function(d,h){if(d)h&&h.error&&(d=Error(h.error),d._code="auth_error"),b&&b(d);else{if(h&&h.access_token)var f=h.access_token;
f?h&&h.scope&&-1==h.scope.indexOf("access_camera")?b&&b(null,"scop_error"):c._getCamsData(f,function(h,d){if(h)d&&d.error&&(h=Error(d.error),h._code="api_error"),b&&b(h);else if(h=null,d.body&&d.body.homes&&(h=d.body.homes),h){for(d=0;d<h.length;d++)if(h[d]&&h[d].cameras){for(var f=h[d].cameras,e=0;e<f.length;e++)if(f[e]&&f[e].id==a&&f[e].vpn_url){var l=f[e];break}if(l)break}l?1==l.is_local?c._getLocalCamUrl(l.vpn_url,function(a,c){b&&b(a,c)}):b&&b(null,l.vpn_url+"/live/index.m3u8"):b&&b("no cam with address:"+
a)}else b&&b("get cams data reponse invalid")}):b&&b(Error("auth response invalid"))}})};p.prototype._resolveStationStatus=function(a){var b={};null!=a.wifi_status&&"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b};p.prototype._resolveModuleStatus=function(a){var b={};null!=a.rf_status&&"undefined"!=
typeof a.rf_status&&(b.rf=a.rf_status,b.rfStatus=90<=b.rf?"very_low":80<=b.rf?"low":70<=b.rf?"medium":60<=b.rf?"high":"full");if(null!=a.battery_vp&&"undefined"!=typeof a.battery_vp)switch(b.bat=a.battery_vp,a.type){case "NAModule4":b.batStatus=5640<=b.bat?"full":5280<=b.bat?"high":4920<=b.bat?"medium":4560<=b.bat?"low":"very_low";break;case "NAModule1":case "NAModule3":b.batStatus=5500<=b.bat?"full":5E3<=b.bat?"high":4500<=b.bat?"medium":4E3<=b.bat?"low":"very_low";break;case "NAModule2":b.batStatus=
5900<=b.bat?"full":5180<=b.bat?"high":4770<=b.bat?"medium":4360<=b.bat?"low":"very_low";break;case "NATherm1":b.batStatus=4100<=b.bat?"full":3600<=b.bat?"high":3300<=b.bat?"medium":3E3<=b.bat?"low":"very_low"}var c,d;if("NATherm1"==a.type&&(c=this._resolveThermoStat(a)))for(d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);if(a.dashboard_data&&(c=this._resolveDashboard(a.dashboard_data)))for(d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);return b};p.prototype._resolveHomeCoachStatus=function(a){var b={};null!=a.wifi_status&&
"undefined"!=typeof a.wifi_status&&(b.wifi=a.wifi_status,b.wifiStatus=86<=b.wifi?"bad":71<=b.wifi?"middle":56<=b.wifi?"good":"very_good");if(a.dashboard_data&&(a=this._resolveDashboard(a.dashboard_data)))for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b};p.prototype._resolveThermoStat=function(a){var b={};if(a.setpoint){switch(a.setpoint.setpoint_mode){case "program":var c="auto";break;case "away":c="away";break;case "hg":c="frost-guard";break;case "manual":c="manu";break;case "off":c="off";
break;case "max":c="boost"}c&&(b.mode=c);null!=a.setpoint.setpoint_temp&&"undefined"!=typeof a.setpoint.setpoint_temp&&(b.manuT=a.setpoint.setpoint_temp);if(null!=a.setpoint.setpoint_endtime&&"undefined"!=typeof a.setpoint.setpoint_endtime)if(b.tempEnd=a.setpoint.setpoint_endtime,b.tempEndStr=(new Date(1E3*a.setpoint.setpoint_endtime)).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{b.tempEndStr=dateFormat(b.tempEndStr,"dd mm yyyy, HH:MM:ss")}catch(l){}else b.tempEndStr=b.tempEndStr.toLocaleString()}a.measured&&
(null!=a.measured.time&&"undefined"!=typeof a.measured.time&&(b.mesureT=a.measured.time),null!=a.measured.temperature&&"undefined"!=typeof a.measured.temperature&&(b.currentTemp=a.measured.temperature));b.tempDuration=E(this,{module:a._id});return b};p.prototype._resolveDashboard=function(a){var b=function(a,b){return null!=a[b]&&"undefined"!=typeof a[b]},c={};b(a,"AbsolutePressure")&&(c.absPres=a.AbsolutePressure);b(a,"CO2")&&(c.co2=a.CO2);b(a,"Humidity")&&(c.hum=a.Humidity);b(a,"Noise")&&(c.noise=
a.Noise);b(a,"Pressure")&&(c.pres=a.Pressure);b(a,"Rain")&&(c.rain=a.Rain);b(a,"sum_rain_1")&&(c.rain1h=a.sum_rain_1);b(a,"sum_rain_24")&&(c.rain24h=a.sum_rain_24);b(a,"Temperature")&&(c.temp=a.Temperature);if(b(a,"date_max_temp")){c.timeMaxTemp=a.date_max_temp;var d=1E3*a.date_max_temp;c.timeMaxTempStr=new Date(d);c.timeMaxTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):c.timeMaxTempStr.toLocaleString()}b(a,"date_min_temp")&&(c.timeMinTemp=a.date_min_temp,
d=1E3*a.date_min_temp,c.timeMinTempStr=new Date(d),c.timeMinTempStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMinTempStr.toLocaleString());b(a,"max_temp")&&(c.maxTemp=a.max_temp);b(a,"min_temp")&&(c.minTemp=a.min_temp);b(a,"WindAngle")&&(c.winD=a.WindAngle);b(a,"WindStrength")&&(c.winS=a.WindStrength);b(a,"GustAngle")&&(c.gwinD=a.GustAngle);b(a,"GustStrength")&&(c.gwinS=a.GustStrength);b(a,"time_utc")&&(c.mesureT=a.time_utc,d=1E3*a.time_utc,
c.mesureTStr=new Date(d),c.mesureTStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):c.mesureTStr.toLocaleString());b(a,"date_max_wind_str")&&(c.timeMaxWind=a.date_max_wind_str,d=1E3*a.date_max_wind_str,c.timeMaxWindStr=new Date(d),c.timeMaxWindStr="undefined"!=typeof dateFormat&&dateFormat?dateFormat(c.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):c.timeMaxWindStr.toLocaleString());b(a,"max_wind_angle")&&(c.maxWinD=a.max_wind_angle);b(a,"max_wind_str")&&(c.maxWinS=
a.max_wind_str);b(a,"temp_trend")&&(c.tempTrend=a.temp_trend);b(a,"pressure_trend")&&(c.presTrend=a.pressure_trend);if(b(a,"health_idx"))switch(c.healthIdxLvl=a.health_idx,parseInt(c.healthIdx)){case 0:c.healthIdx="healthy";break;case 1:c.healthIdx="fine";break;case 2:c.healthIdx="fair";break;case 3:c.healthIdx="poor";break;case 4:c.healthIdx="unhealthy"}return c};p.prototype.auth=function(a){this._logger.log("debug","auth");var b=d(this),c=this;b?b.access_token?r(this)?this._refreshToken(b.refresh_token,
function(b,d){b?(d&&d.error&&(b=Error(d.error),b._code="refresh_token_error"),a&&a(b)):(m(c,d),a&&a(null,d))}):a&&a(null,b):this._refreshToken(b.refresh_token,function(b,d){b?(d&&d.error&&(b=Error(d.error),b._code="refresh_token_error"),a&&a(b)):(m(c,d),a&&a(null,d))}):this._auth(this._scope.join(" "),function(b,d){if(b){if(d)try{if(d=JSON.parse(d),d.error&&(b=Error(d.error),b._code="auth_error","invalid_request"==d.error&&-1!=c._scope.indexOf("access_presence"))){c._scope=c._scopeFallback;c.auth(a);
return}}catch(J){}a&&a(b)}else m(c,d),a&&a(null,d)})};p.prototype.setThermPoint=function(a,b,c){if(a&&a.address&&a.module)if(b&&b.setpoint_mode)if("max"!=b.setpoint_mode||b.setpoint_endtime)if("manual"!=b.setpoint_mode||b.setpoint_endtime&&b.setpoint_temp){var f=this;this.auth(function(h){h?c&&c(h):f._setThermPoint(d(f).access_token,a.address,a.module,b.setpoint_mode,b.setpoint_endtime,b.setpoint_temp,function(a,b){a?(b&&b.error&&(a=Error(b.error),a._code="api_error"),c&&c(a)):c&&c(null,b)})})}else c&&
c(Error("param format invalid"));else c&&c(Error("param format invalid"));else c&&c(Error("param format invalid"));else c&&c(Error("device format invalid"))};p.prototype.getStationsData=function(a){this._logger.log("debug","getStationsData");var b=this;this.auth(function(c){c?a&&a(c):(c=w(b))&&c.updateData&&c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):(x(b),b._getStationsData(d(b).access_token,null,function(c,d){c?(d&&d.error&&(c=Error(d.error),c._code="api_error"),u(b,c,null),
a&&a(c)):(c=null,d.body&&d.body.devices&&(c=d.body.devices),d.body&&d.body.user&&d.body.user.administrative&&(g=d.body.user.administrative),u(b,null,c),a&&a(null,c))}))})};p.prototype.getThermostatsData=function(a){var b=this;this.auth(function(c){c?a&&a(c):(c=v(this))&&c.updateData&&c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):(G(b),b._getThermostatsData(d(b).access_token,null,function(c,d){c?(d&&d.error&&(c=Error(d.error),c._code="api_error"),D(b,c,null),a&&a(c)):(c=null,d.body&&
d.body.devices&&(c=d.body.devices),D(b,null,c),a&&a(null,c))}))})};p.prototype.getHomeCoachsData=function(a){this._logger.log("debug","getHomeCoachsData");var b=this;this.auth(function(c){c?a&&a(c):(c=z(this))&&c.updateData&&c.updateData.running?(c.tmpCBs||(c.tmpCBs=[]),c.tmpCBs.push(a)):(F(b),b._getHomeCoachsData(d(b).access_token,null,function(c,d){c?(d&&d.error&&(c=Error(d.error),c._code="api_error"),C(b,c,null),a&&a(c)):(c=null,d.body&&d.body.devices&&(c=d.body.devices),d.body&&d.body.user&&d.body.user.administrative&&
(t=d.body.user.administrative),C(b,null,c),a&&a(null,c))}))})};p.prototype.getCamsData=function(a){this._logger.log("debug","getCamsData");var b=this;this.auth(function(c){c?a&&a(c):b._getCamsData(d(b).access_token,function(b,c){b?(c&&c.error&&(b=Error(c.error),b._code="api_error"),a&&a(b)):(b=null,c.body&&c.body.homes&&(b=c.body.homes),a&&a(null,b))})})};p.prototype._auth=function(a,b){this._logger.log("trace","_auth");this._doRequest("POST","/oauth2/token",{grant_type:"password",client_id:"564b2c5245a1e3173cb21d3b",
client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",username:this.user,password:this.password,scope:a},b)};p.prototype._refreshToken=function(a,b){this._logger.log("trace","_refreshToken");this._doRequest("POST","/oauth2/token",{grant_type:"refresh_token",client_id:"564b2c5245a1e3173cb21d3b",client_secret:"n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",refresh_token:a},b)};p.prototype._setThermPoint=function(a,b,c,d,f,e,g){a={access_token:a,device_id:b,module_id:c,setpoint_mode:d};f&&(a.setpoint_endtime=
f);e&&(a.setpoint_temp=e);this._doRequest("GET","/api/setthermpoint",a,g)};p.prototype._getStationsData=function(a,b,c){this._logger.log("debug","_getStationsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/getstationsdata",a,c)};p.prototype._getHomeCoachsData=function(a,b,c){this._logger.log("debug","_getHomeCoachsData");a={access_token:a};b&&(a.device_id=b);this._doRequest("GET","/api/gethomecoachsdata",a,c)};p.prototype._getThermostatsData=function(a,b,c){a={access_token:a};
b&&(a.device_id=b);this._doRequest("GET","/api/getthermostatsdata",a,c)};p.prototype._getCamsData=function(a,b){this._doRequest("GET","/api/gethomedata",{access_token:a},b)};p.prototype._getLocalCamUrl=function(a,b){var c=this;this._logger.log("trace","ping cam "+a);this._doUrlRequest("get",a+"/command/ping",null,function(d,f){!d&&f&&f.local_url?c._doUrlRequest("get",f.local_url+"/command/ping",null,function(c,d){c||!d||d.local_url!=f.local_url?b&&b(null,a+"/live/index.m3u8"):b&&b(null,d.local_url+
"/live/index.m3u8")}):b&&b(null,a+"/live/index.m3u8")})};p.prototype._doRequest=function(a,b,c,d){this._doUrlRequest(a,"https://api.netatmo.net"+b,c,d)};p.prototype._doUrlRequest=function(a,b,c,d){var f=this,e=d,g=null;try{g=JSON.parse(JSON.stringify(c)),g.username&&(g.username="xxxxxx"),g.password&&(g.password="xxxxxx")}catch(A){g=c}this._logger.log("trace","send "+a+" req to:"+b+" data:"+JSON.stringify(g));$.ajax({url:b,type:a,timeout:1E4,dataType:"json",data:c,cache:!1,success:function(a){f._logger.log("trace",
"http request success:"+JSON.stringify(a));d&&d(null,a)},error:function(a,b,c){b="http request error:"+(a?a.status:"0")+"-"+b;f._logger.log("warn","http request error:"+b);b=Error(b);c&&(f._logger.log("warn","http request http error:"+c),b.httpError=!0,b.statusCode=a?a.status:0);e&&(e(b,a?a.responseText:null),e=null)}})};p.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password}};p.prototype.equalsTo=function(a){return a&&a instanceof p?this.user==a.user&&
this.password==a.password:!1};p.pause=function(a){for(var b in k)if(k.hasOwnProperty(b)){var c=k[b];c&&c.weather&&c.weather.timer&&clearTimeout(c.weather.timer);c&&c.thermo&&c.thermo.timer&&clearInterval(c.thermo.timer)}k={};a&&a()};return p}();
xnm.aio.netatmo.MNetatmo=function(){var k=function(e){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo");this._interval=0;this._on={};this._updateInterval=12E4;this._url=null;this._username=e?e.username:null;this._password=e?e.password:null;this._basicAuth=e?e.basicAuth:null};k.CLOUD_URL="cloud.mediola.com";k.prototype={_doUpdate:function(e){var g=this;APP.isInDemoMode||this.getStates(null,function(k,f){if(f&&f.XC_SUC){XC.debugf("[MNetatmo] Received update.");for(var d in f.XC_SUC){k=
f.XC_SUC[d];for(var m in k){var r=k[m],w=d+"_"+m;if(r.states)for(var t in r.states)CommandHandler.setState(w+":"+t,r.states[t],!0)}}e&&e();if(Array.isArray(g._on.update))for(f={type:"update"},d=0;d<g._on.update.length;d++)(m=g._on.update[d])&&m(f)}})},_sendRequest:function(e,g){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var k=require("https"),f=this._getURL();f=f.replace("https://","");e={host:f,method:"GET",path:e||"/",headers:{}};(f=this._getBasicAuthHeader())&&
(e.headers.Authorization=f);var d=this,m=g,r=k.request(e,function(f){f.setEncoding("utf-8");var e="";f.on("data",function(d){e+=d});f.on("end",function(){d._logger.log("trace","http reponse:"+e+" statusCode:"+f.statusCode);if(200!=f.statusCode)m&&m(Error("http response with code:"+f.statusCode),null);else try{var g=JSON.parse(e);g&&g.XC_SUC?m&&m(null,g.XC_SUC):g&&g.XC_ERR?m&&m(Error(g.XC_ERR.msg)):m&&m(Error("http reponse format valid"));m=null}catch(y){d._logger.log("trace","http reponse is not valid json:"+
y.message),m&&m(y,null),m=null}})});r.setTimeout(1E4,function(){d._logger.log("trace","http request timeout");r.abort();m&&m(Error("http timeout"));m=null});r.on("error",function(f){d._logger.log("trace","http request error:"+f.message);m&&m(f);m=null});r.end()},_getURL:function(){return this._url?this._url:k.CLOUD_URL},_getBasicAuthHeader:function(){return this._basicAuth?this._basicAuth:this._username?"Basic "+(new Buffer(this._username+":"+(this._password?this._password:""))).toString("base64"):
null},_getStates:function(e){this._sendRequest("/netatmo/getStates",e)},addEventListener:function(e,g){this._on[e]||(this._on[e]=[]);this._on[e].push(g)},setUrl:function(e){this._url=e},getDevices:function(e){this._sendRequest("/netatmo/getDevices",e)},getStates:function(e,g,k){this._getStates(function(f,d){if(f)k&&k(null);else if(g){f={};for(var m in d){var r=d[m];if(r)for(var t in r)if(g&&g.address==t){var x=r[t];if(x&&x.states){f=x.states;break}}}if(e)for(var u in f)e.setState(g.id+":"+u,f[u]);
k&&k(f)}else k&&k(d)})},removeEventListener:function(e,g){if(this._on[e])for(var k=0;k<this._on[e].length;k++)if(this._on[e][k]===g){this._on[e].splice(k,1);break}},startUpdating:function(e){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var g=this;XC.debugf("[MNetatmo.startUpdating] Start.");this._doUpdate();this._interval=setInterval(function(){g._doUpdate()},this._updateInterval)}},stopUpdating:function(){clearInterval(this._interval);
XC.debugf("[MNetatmo.stopUpdating] Stop.")}};return k}();
xnm.aio.netatmo.DM=function(){var k=function(f,d){this.code=f;this.message=d;this.stack=Error().stack};k.prototype=Error();k.prototype.name="NetatmoDmError";k.prototype.code=0;k.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e=k.ERROR_CODE,g=[{type:"float",name:"absolute pressure",ref:{value:"absPres"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},{type:"float",
name:"pressure",ref:{value:"pres"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain today",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",ref:{value:"minTemp"}},{type:"int",
name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",
name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad","middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:"auto away frost-guard manu off boost".split(" ")}},
{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",
ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:"N NO O SO S SW W NW".split(" ")}},{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",options:["up",
"down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],t=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",
ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}];return{SYS:"netatmo",getGatewayType:function(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}]},getGatewayDeviceType:function(f){return[{sys:this.SYS,type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,
type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}]},_checkInfo:function(f,d,g){if(f)if(f.gateway)if(f.type)if(f.address)if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var m;for(m=0;m<d.length;m++)if(d[m].index===f.gateway){var t=d[m];break}t?g():g(new k(e.NOT_FOUND,"gateway with index "+
f.gateway+" not exists"))}else g(new k(e.NOT_FOUND,"gateway with index "+f.gateway+" not exists"));else g(new k(e.INVALID,"address is invalid"));else g(new k(e.INVALID,"type is invalid"));else g(new k(e.INVALID,"gateway is invalid"));else g(new k(e.INVALID,"info is invalid"))},createGateway:function(f,d,g){f?f.refreshToken||f.username&&f.password?g(null,f):g(new k(e.INVALID,"refreshToken is invalid")):g(new k(e.INVALID,"info is invalid"))},updateGateway:function(f,d,g,r){d?d.refreshToken||d.username&&
d.password?r(null,d):r(new k(e.INVALID,"refreshToken is invalid")):r(new k(e.INVALID,"info is invalid"))},deleteGateway:function(f,d,e){e()},createDevice:function(f,d,e){this._checkInfo(f,d,function(d){e(d,f)})},updateDevice:function(f,d,e){this._checkInfo(f,d,function(d){e(d,f)})},deleteDevice:function(f,d,e){e(null,f)},applyUIFilter:function(f,d){var e=function(d,f){if("*"==d)return!0;for(var e=!1,g=0;g<d.length;g++)if(d[g]==f){e=!0;break}return e},g=function(d,f,g){var k=[];switch(g.catagory){case "command":d.command&&
d.command.forEach(function(d){e(g.elems,d.type)&&(d=JSON.parse(JSON.stringify(d)),k.push(d))});break;case "status":d.status&&d.status.forEach(function(d){e(g.elems,d.type)&&(d=JSON.parse(JSON.stringify(d)),k.push(d))})}return k},k=function(d,f){var e=[],k=this.getCommandStatusMap(d);k&&(d=g(k,d,f),e=e.concat(d));return e};if(!f.sys)return null;var t=JSON.parse(JSON.stringify(f)),u=null;switch(d.catagory){case "command":u=k.call(this,f,d);t.command=u;break;case "status":u=k.call(this,f,d);t.status=
u;break;default:return null}return u&&0!=u.length?t:null},applyIPEventFilter:function(f,d){if(!f.sys)return null;d=JSON.parse(JSON.stringify(f));f=this.getIPevtMap(f);if(!f)return d;d.ipevt=f.ipevt;return d},getCommandStatusMap:function(f){var d={command:[],status:[]};switch(f.type){case "NAMain":d.status.push(g[25]);d.status.push(g[26]);break;case "NAModule1":case "NAModule2":case "NAModule3":case "NAModule4":case "NATherm1":d.status.push(g[21]);d.status.push(g[22]);d.status.push(g[23]);d.status.push(g[24]);
"NATherm1"==f.type&&(d.status.push(g[27]),d.status.push(g[28]),d.status.push(g[29]),d.status.push(g[30]),d.status.push(g[31]),d.status.push(g[32]));break;case "NHC":d.status.push(g[25]),d.status.push(g[26])}"NATherm1"==f.type&&(d.command=t);if(f.dashboard_data)for(var e in f.dashboard_data)if(f.dashboard_data.hasOwnProperty(e))switch(e){case "AbsolutePressure":d.status.push(g[0]);break;case "CO2":d.status.push(g[1]);break;case "Humidity":d.status.push(g[2]);d.status.push(g[37]);break;case "Noise":d.status.push(g[3]);
break;case "Pressure":d.status.push(g[4]);break;case "Rain":d.status.push(g[5]);break;case "sum_rain_1":d.status.push(g[6]);break;case "sum_rain_24":d.status.push(g[7]);break;case "Temperature":d.status.push(g[8]);break;case "date_max_temp":d.status.push(g[9]);d.status.push(g[33]);break;case "date_min_temp":d.status.push(g[10]);d.status.push(g[34]);break;case "max_temp":d.status.push(g[11]);break;case "min_temp":d.status.push(g[12]);break;case "WindAngle":d.status.push(g[13]);d.status.push(g[38]);
break;case "WindStrength":d.status.push(g[14]);break;case "GustAngle":d.status.push(g[15]);break;case "GustStrength":d.status.push(g[16]);break;case "time_utc":d.status.push(g[17]);d.status.push(g[35]);break;case "date_max_wind_str":d.status.push(g[18]);d.status.push(g[36]);break;case "max_wind_angle":d.status.push(g[19]);break;case "max_wind_str":d.status.push(g[20]);break;case "temp_trend":d.status.push(g[39]);break;case "pressure_trend":d.status.push(g[40]);break;case "health_idx":d.status.push(g[41]),
d.status.push(g[42])}return d},getIPevtMap:function(f){return(f=this.getCommandStatusMap(f))?{ipevt:f.status}:null},calcFeltTemp:function(f,d,e){if(e&&"object"==typeof e&&0===e.feel_like_algo)e=243.5,d=Math.log(.01*d)+17.67*f/(e+f),d=f+.5555*(6.11*Math.exp(5417.753*(1/273.16-1/(e*d/(17.67-d)+273.15)))-10);else{e=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,8.5282E-4,-1.99E-6];f=9*f/5+32;var g=f*f,k=d*d;d=e[0]+e[1]*f+e[2]*d+e[3]*f*d+e[4]*g+e[5]*k+e[6]*g*d+e[7]*f*k+e[8]*
g*k;d=5*(d-32)/9}return Math.round(10*d)/10}}}();
xnm.aio.netatmo.Handler=function(){var k=function(){this._updateListener=[]};k.prototype.Cloud=xnm.aio.netatmo.Cloud;k.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo;k.prototype.devicemanager=xnm.aio.netatmo.DM;k.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"netatmo")};k.prototype.resolveGateway=function(e){return e.refreshToken||e.username&&e.password?new xnm.aio.netatmo.Cloud(e.username,e.password,e.refreshToken):null};k.prototype.getDeviceCommands=function(e,g){e=(e=xnm.aio.netatmo.DM.applyUIFilter(e,
{catagory:"command",elems:"*"}))?e.command:[];g&&g(null,e)};k.prototype.getDeviceStatus=function(e,g){e=(e=xnm.aio.netatmo.DM.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];g&&g(null,e)};k.prototype.login=function(e,g){(e=this.resolveGateway(e))?e.auth(function(e,f){e?g&&g(e):g&&g(e,{refreshToken:f.refresh_token})}):g&&g(Error("gateway json format invalid"))};k.prototype.doCommand=function(e,g,k,f){(e=this.resolveGateway(e))?e.executeCommandCreator(g,k,function(d){f&&f(d)}):f&&f(Error("gateway json format invalid"))};
k.prototype.doStatus=function(e,g,k,f,d){(g=this.resolveGateway(g))?g.getStatesCreator(null,[{id:e,device:k,status:f}],function(e,f){e?d&&d(e):d&&d(null,f[0])}):d&&d(Error("gateway json format invalid"))};k.prototype.getDeviceList=function(e,g){(e=this.resolveGateway(e))?e.getDeviceList(g):g&&g(Error("gateway json format invalid"))};k.prototype.getCamList=function(e,g){(e=this.resolveGateway(e))?e.getCamList(g):g&&g(Error("gateway json format invalid"))};k.prototype.pause=function(e){xnm.aio.netatmo.Cloud.pause(e)};
k.prototype.addUpdateListener=function(e){e&&-1==this._updateListener.indexOf(e)&&this._updateListener.push(e)};k.prototype.getDevice=function(e){return new this.MNetatmo(e)};k.prototype.setMNetatmoCloudUrl=function(e){this.MNetatmo.CLOUD_URL=e};return k}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler);
