var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mirubee=xnm.aio.mirubee||{};
xnm.aio.mirubee.Mirubee=function(){var d={},a=function(b,a,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mirubee.Mirubee");this._protocol="https";this._ip="v5dev.mediola.com";this._port=443;this.username=b;this.password=a;this.id=c;this._statesBuffer=d;this._getDeviceStatesCBs={}};a.prototype._putStatesBuffer=function(b,a){this._statesBuffer[b]={data:a,timestamp:(new Date).getTime()}};a.prototype._getStatesBuffer=function(b){var a=
this._statesBuffer[b];if(!a)return null;var c=(new Date).getTime();return!a.timestamp||6E4<c-a.timestamp?(delete this._statesBuffer[b],null):a.data};a.prototype.connect=function(b,a,c){this._doJsonRequest("GET","/eapi/v1/mirubee/connect",{account:b,password:a},null,function(b,a){c&&c(b,a)})};a.prototype.disconenct=function(b){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/disconnect",{id:this.id},null,function(a,c){b&&b(a,c)}):b&&b(Error("account not connected"))};a.prototype.getInfo=function(b){this._doJsonRequest("GET",
"/eapi/v1/mirubee/info",null,null,function(a,c){b&&b(a,c)})};a.prototype.getDevices=function(b){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/devices/"+this.id,null,null,function(a,c){if(a)b&&b(a);else{var e=[];if(c)for(var g in c){var d=c[g];d.sys="mirubee";e.push(d)}b&&b(a,e)}}):b&&b(Error("account not connected"))};a.prototype.executeCommandCreator=function(b,a,c){c&&c()};a.prototype.getStatesCreator=function(b,a,c){if(this.id)if(a)if(0==a.length)c&&c(null,[]);else{b=[];for(var e=0;e<a.length;e++){var d=
a[e];d&&d.device&&d.device.id&&-1==b.indexOf(d.device.id)&&b.push(d.device.id)}this.getStates(b,function(b,e){if(b)c&&c(b);else{b=[];for(var d=0;d<a.length;d++){var f=a[d];if(f&&f.id){var g=null;f.device&&f.device.id&&f.status&&f.status.value&&(g=e[f.device.id])&&(g=g[f.status.value]);if("undefined"==typeof g||null==g)g="?";b.push({id:f.id,status:g})}}c&&c(null,b)}})}else c&&c(Error("deviceList is null"));else c&&c(Error("account not connected"))};a.prototype.getStates=function(b,a){if(b&&0!=b.length)for(var c=
{},e=b.length,d=0;d<b.length;d++)this.getDeviceStates(b[d],function(b,d,f){!b&&d&&(c[f]=d);e--;0==e&&a&&a(null,c)});else a&&a(null,{})};a.prototype.getDeviceStates=function(b,a){var c=this._getStatesBuffer(b);if(c)a&&a(null,c,b);else{c=this._getDeviceStatesCBs[b];c||(this._getDeviceStatesCBs[b]=[],c=this._getDeviceStatesCBs[b]);var d=c.length;c.push(a);if(!(0<d)){var e=this;this._getDeviceStates(b,function(a,c){var d=e._getDeviceStatesCBs[b];e._getDeviceStatesCBs[b]=[];!a&&c&&(c=e._resolveStates(c),
e._putStatesBuffer(b,c));for(var f=0;f<d.length;f++)d[f]&&d[f](a,c,b)})}}};a.prototype._resolveStates=function(b){b&&b.measured&&(b.measuredStr=(new Date(b.measured)).toLocaleString());return b};a.prototype._getDeviceStates=function(b,a){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/states/"+this.id+"/"+b,null,null,function(b,d){a&&a(b,d)}):a&&a(Error("account not connected"))};a.prototype._doJsonRequest=function(b,a,c,d,g){this._doRequest(b,a,c,d,function(b,a){b?g&&g(b):a?a.XC_ERR?(b=Error("error response:"+
a.XC_ERR.msg),b.code=a.XC_ERR.code,g&&g(b)):a.XC_SUC?g&&g(null,a.XC_SUC):g&&g(Error("unknown response")):g&&g(Error("invalid response"))})};a.prototype._doRequest=function(a,d,c,f,g){d||(d="/");var b={};c&&(b=JSON.parse(JSON.stringify(c)));c="";for(var e in b)b.hasOwnProperty(e)&&(c&&(c+="&"),c+=e+"="+encodeURIComponent(b[e]));c&&(d+="?"+c);a={host:this._ip,port:this._port,path:d,method:a,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};this._logger.log("trace","do request:"+
JSON.stringify(a));if(this.username||this.password)a.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),a.headers.Authorization="Basic "+(new Buffer((this.username?this.username:"")+":"+(this.password?this.password:""))).toString("base64");f&&(a.headers["Content-Length"]=f.length);e=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var n=this,h=g,k=e.request(a,function(a){a.setEncoding("utf-8");
var b="";a.on("data",function(a){b+=a});a.on("end",function(){n._logger.log("trace","receive code:"+a.statusCode+" headers:"+JSON.stringify(a.headers)+" response:"+b);if(200==a.statusCode)try{var c=b?JSON.parse(b):null}catch(p){var d=p}else d=Error("http reponse:"+a.statusCode);h&&(h(d,c,a.statusCode),h=null)})});if(k.on)k.on("error",function(a){n._logger.log("trace","do request error:"+a.message);h&&(h(a),h=null)});k.setTimeout&&k.setTimeout(2E4,function(){n._logger.log("trace","do request timeout");
k.abort();h&&(h(Error("timeout")),h=null)});f&&(this._logger.log("trace","do request send body:"+f),k.write(f));k.end()};a.prototype.toJSON=function(){return{sys:"mirubee",username:this.username,password:this.password,id:this.id}};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.id==b.id&&this.username==b.username&&this.password==b.password:!1};a.parseJSON=function(b){return b.username?new a(b.username,b.password,b.id):null};return a}();
xnm.aio.mirubee.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="mirubeeDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mirubee",MAP:{meter:{channel:{status:[{type:"float",name:"power",ref:{value:"power",unit:"W"}},{type:"float",name:"voltage",ref:{value:"voltage",unit:"V"}},{type:"float",name:"current",ref:{value:"current",unit:"A"}},{type:"int",
name:"last measured time",ref:{value:"measured"}},{type:"string",name:"last measured time (text)",ref:{value:"measuredStr"}},{type:"statistic",name:"energy statistic",ref:{value:"energy"}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"mirubee (alfanar)"}]},createGateway:function(a,b,e){b=d.ERROR_CODE;a?a.username?a.password?a.id?e(null,a):e(new d(b.INVALID,"id is invalid")):e(new d(b.INVALID,"password is invalid")):e(new d(b.INVALID,"username is invalid")):e(new d(b.INVALID,"info is invalid"))},
updateGateway:function(a,b,e,c){a=d.ERROR_CODE;b?b.username?b.password?b.id?c(null,b):c(new d(a.INVALID,"id is invalid")):c(new d(a.INVALID,"password is invalid")):c(new d(a.INVALID,"username is invalid")):c(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,b,e){var c=d.ERROR_CODE;if(a)if(a.id)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?e&&e(null,a):e(new d(c.NOT_FOUND,"gateway with index "+
a.gateway+" not exists"))}else e(new d(c.INVALID,"gateway is invalid"));else e(new d(c.INVALID,"id is invalid"));else e(new d(c.INVALID,"info is invalid"))},updateDevice:function(a,b,e){var c=d.ERROR_CODE;if(a)if(a.id)if(a.gateway){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?e(null,a):e(new d(c.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new d(c.INVALID,"gateway is invalid"));else e(new d(c.INVALID,"id is invalid"));else e(new d(c.INVALID,
"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var c=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,d){var e=[];"command"==d.catagory?a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==d.catagory&&a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},g=function(a,b){var c=
[],f=xnm.aio.mirubee.DM.getCommandStatusMap(a,d);f&&(a=e(f,a,b),c=c.concat(a));return c};if(!a.sys)return null;var m=JSON.parse(JSON.stringify(a)),l=null;if("command"==b.catagory)l=g(a,b),m.command=l;else if("status"==b.catagory)l=g(a,b),m.status=l;else return null;return l&&0!=l.length?m:null},getCommandStatusMap:function(a,b){if(!a||!a.id||3>a.id.split(":").length)return null;a={status:[]};a.status=this.MAP.meter.channel.status;return a}}}();
xnm.aio.mirubee.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.mirubee.DM;d.prototype.Mirubee=xnm.aio.mirubee.Mirubee;d.prototype.registModule=function(a){a.register("mirubee","mirubee")};d.prototype.resolveGateway=function(a){return a?this.Mirubee.parseJSON(a):null};d.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,
{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.doCommand=function(a,b,d,c){(a=this.resolveGateway(a))?a.executeCommandCreator(b,d,function(a){c&&c(a)}):c&&c(Error("gateway json format invalid"))};d.prototype.doStatus=function(a,b,d,c,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:d,status:c}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(a,
c){b&&b(a,c)}):b&&b(Error("gateway json format invalid"))};d.prototype.connect=function(a,b,d,c){(a=this.resolveGateway(a))?a.connect(b,d,function(a,b){c&&c(a,b)}):c&&c(Error("gateway json format invalid"))};d.prototype.disconnect=function(a,b){(a=this.resolveGateway(a))?a.disconenct(function(a,c){b&&b(a,c)}):b&&b(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mirubee.Handler);
