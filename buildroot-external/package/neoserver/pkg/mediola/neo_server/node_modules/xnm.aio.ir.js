var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.ir=xnm.aio.ir||{};
xnm.aio.ir.RedEye=function(){var c=function(a,b,d){var c=require("x.logger.js");this._logger=c?c.getLogger("RedEye"):{log:function(){}};this._host=a;this._serial=d;this._port=b;if(!this._port||0>this._port)this._port=80};c.SEND_PATH="/cgi-bin/play_iph.sh?/devicedata/";c.LEARN_PATH="/cgi-bin/RedEyeApp?debug=1";c.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value)if(a&&a.ircodes&&a.ircodes.codes){for(var c,f=0;f<a.ircodes.codes.length;f++){var g=a.ircodes.codes[f];if(g.key==b.value){c=g.code;
break}}c?this.executeCommand(a,c,function(a){d&&d(a)}):d&&d(Error("no such ir code:"+b.value))}else d&&d(Error("device has no ir codes"));else d&&d(Error("command invalid"))};c.prototype.executeCommand=function(a,b,d){b?this._doGetRequest(this._host,this._port,c.SEND_PATH+b,function(a){d&&d(a)}):d&&d(Error("command invalid"))};c.prototype.learnIrCode=function(a){this._doPostRequest(this._host,82,c.LEARN_PATH,'<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>id</key><integer>-1</integer><key>serialNumber</key><string>'+
this._serial+"</string><key>clientType</key><integer>99999</integer><key>softwareVersion</key><string>2.6.0</string><key>type</key><integer>26</integer><key>isInitialRequest</key><string>no</string><key>hostName</key><string></string><key>cookie</key><integer>-1</integer><key>actions</key></dict></plist>",function(b,d){b?a&&a(b):d&&-1!=d.indexOf("/devicedata/")?(b=d.indexOf("/devicedata/"),d=d.substr(b+12),b=d.indexOf("<"),-1==b?a&&a(Error("learn ir code response error")):(d=d.substr(0,b),a&&a(null,
d))):a&&a(Error("learn ir code response error"))})};c.prototype._doGetRequest=function(a,b,d,c){var e=c;a={host:a,port:b,path:d,method:"GET"};var g=this,h="";a=require("http").request(a,function(a){200==a.statusCode?(a.setEncoding("utf8"),a.on("data",function(a){h+=a}),a.on("end",function(){e&&e(null,h);e=null})):(g._logger.log("warn","Failed to do get request to "+g.ip+" with status code:"+a.statusCode),e&&e(Error("post request failed with status code:"+a.statusCode)),e=null)});if(a.on&&"function"==
typeof a.on)a.on("error",function(a){e&&e(a);e=null});a.end()};c.prototype._doPostRequest=function(a,b,d,c,f){var e=f;a={host:a,port:b,path:d,method:"POST",headers:{"Content-Type":'text/xml; charset="UTF-8"',"Content-Length":c.length,"User-Agent":"mediola",Connection:"close"}};var h=this,k="";a=require("http").request(a,function(a){200==a.statusCode?(a.setEncoding("utf8"),a.on("data",function(a){k+=a}),a.on("end",function(){e&&e(null,k);e=null})):(h._logger.log("warn","Failed to do get request to "+
h.ip+" with status code:"+a.statusCode),e&&e(Error("post request failed with status code:"+a.statusCode)),e=null)});if(a.on&&"function"==typeof a.on)a.on("error",function(a){e&&e(a);e=null});a.write(c);a.end()};c.prototype.toJSON=function(){return{sys:xnm.aio.ir.RedEye.DM.SYS,ip:this._host,port:this._port,serial:this._serial}};c.prototype.equalsTo=function(a){return a&&a instanceof c?this._host==a._host:!1};c.parseJSON=function(a){return a.ip?new c(a.ip,a.port,a.serial):null};c.discoveryWithTimeout=
function(a,b){var d=require("x.mdns.js");d.clearRecordBuffer();d.discoverServiceWithTimeout("_tf_redeye._tcp.local",a,function(a,d){if(a)b&&b(a);else{for(var e=[],f=0;f<d.length;f++){var k=d[f];if(k.target&&k.ip&&0<k.ip.length){var n=k.target.replace("RedEye_","");n=n.replace(".local","");k=new c(k.ip[0],80,n);e.push(k)}}b&&b(a,e)}})};return c}();
xnm.aio.ir.RedEye.DM=function(){return{SYS:"redeye",registModule:function(c){c.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"RedEye"}},createGateway:function(c,a,b){a=xnm.aio.ir.DMError;var d=xnm.aio.ir.DMError.ERROR_CODE;c?c.ip?b(null,c):b(new a(d.INVALID,"ip is invalid")):b(new a(d.INVALID,"info is invalid"))},updateGateway:function(c,a,b,d){c=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?d(null,a):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,
"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new d(e.INVALID,"gateway is invalid"))},
updateDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){b()},getCommandStatusMap:function(c){var a={command:[]};if(c&&c.ircodes&&c.ircodes.codes){for(var b=0;b<c.ircodes.codes.length;b++){var d=
c.ircodes.codes[b];a.command.push({type:"enum",name:d.key,ref:{value:d.key}})}return a}return null}}}();
xnm.aio.ir.IRTrans=function(){var c=function(a,b){var d=require("x.logger.js");this._logger=d?d.getLogger("IRTrans"):{log:function(){}};this._ip=a;this._port=b;this._port||(this._port=21E3);this._idleTimer=this._socket=null;this._commandTasks=[]};c.SO_TIMEOUT=2E3;c.IDLE_TIMEOUT=6E4;c.CONNECTION_PREAMBLE="ASCI";c.prototype.executeCommandCreator=function(a,b,d,c){if(b&&b.value)if(a&&a.ircodes&&a.ircodes.codes){for(var e,g=0;g<a.ircodes.codes.length;g++){var h=a.ircodes.codes[g];if(h.key==b.value){e=
h.code;break}}e?this.executeCommand(a,e,function(){d&&d()},c):d&&d(Error("no such ir code:"+b.value))}else d&&d(Error("device has no ir codes"));else d&&d(Error("command invalid"))};c.prototype.executeCommand=function(a,b,d,c){var e="Asndhex ";switch(a.address){case "LD":case "LI":case "LE":case "LB":case "L1":case "L2":case "L3":case "L4":case "L5":case "L6":case "L7":case "L8":e+=a.address+" "}e+="H"+b;var g=this;this._createSocket(function(a){a?d&&d(a):g._addTask("command",e,c,d)})};c.prototype.learnIrCode=
function(a,b){var d="Alearn M"+(a&a.mode?a.mode:0)+" I"+(a&a.timeout?a.timeout:0)+" R"+(a&a.receiver?a.receiver:"I1")+" W10",c=this;this._createSocket(function(a){a?b&&b(a):c._addTask("learn",d,!0,b)})};c.prototype.toJSON=function(){return{sys:xnm.aio.ir.IRTrans.DM.SYS,ip:this._ip,port:this._port}};c.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.ir.IRTrans?this._ip==a._ip&&this._port==a._port:!1};c.prototype._createSocket=function(a){if(this._socket)a();else{var b=this,d={port:this._port,
host:this._ip},e=require("net").connect(d);e.setTimeout(c.SO_TIMEOUT);e.setEncoding("utf8");e.on("connect",function(){b._logger.log("trace","connect to irtrans:"+b._ip);e.write(c.CONNECTION_PREAMBLE);b._socket=e;a()});e.on("data",function(a){b._logger.log("trace","receive from irtrans:"+b._ip+" data:"+a);b._onSocketData(a)});e.on("error",function(d){b._socket?(b._logger.log("trace","irtrans:"+b._ip+" error:"+d.message),b._onSocketError(d)):(b._logger.log("trace","irtrans:"+b._ip+" connection error:"+
d.message),a(d))});e.on("timeout",function(){b._socket?(b._logger.log("trace","irtrans:"+b._ip+" data timeout"),b._onSocketTimeout()):(b._logger.log("trace","irtrans:"+b._ip+" connection timeout"),e.destroy(),a(Error("timeout")))});e.on("close",function(){b._logger.log("trace","irtrans:"+b._ip+" close socket");b._onSocketClose()});e._doConnect&&"function"==typeof e._doConnect&&e._doConnect()}};c.prototype._closeSocket=function(){this._socket&&this._socket.end();this._clean()};c.prototype._clean=function(){this._idleTimer&&
(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._commandTasks)for(var a=0;a<this._commandTasks.length;a++){var b=this._commandTasks[a];b&&b.callback&&b.callback(Error("socket closed"))}this._commandTasks=[]};c.prototype._onSocketError=function(a){this._closeSocket()};c.prototype._onSocketTimeout=function(){4<this._commandTasks.length&&this._closeSocket()};c.prototype._onSocketClose=function(){this._clean()};c.prototype._onSocketData=function(a){a=a.split(" ");var b=
2<a.length&&"LEARN"==a[1],d;b&&(d=a[2].replace(/\r?\n|\r/g,""));var c=!1;if(0<this._commandTasks.length){var f=this._commandTasks[0];c=f.closeSocket;this._commandTasks.splice(0,1);if("learn"==f.type&&0==a[2].indexOf("Error")){a=a.slice(2);var g=Error(a.join(" ").replace(/\r?\n|\r/g,""))}f.callback&&f.callback(g,b?d:null)}c&&0==this._commandTasks.length&&this._closeSocket()};c.prototype._addTask=function(a,b,d,e){this._logger.log("trace","add task to buffer");this._commandTasks.push({type:a,data:b,
callback:e,closeSocket:d});var f=this;this._idleTimer&&clearTimeout(this._idleTimer);this._idleTimer=setTimeout(function(){f._closeSocket()},c.IDLE_TIMEOUT);this._doRequest(b)};c.prototype._doRequest=function(a){this._logger.log("trace","send data to irtrans:"+this._ip+" data:"+a);this._socket&&this._socket.write(a)};c.parseJSON=function(a){return a.ip?new c(a.ip,a.port):null};c._discovery=function(a,b){var d=function(a,d,b){a=a.toString("hex");2<a.length&&0==a.toLowerCase().indexOf("e7")&&(d=new xnm.aio.ir.IRTrans(d.address),
b.push(d))},c=function(a,b,c,e){var f=e,g=require("dgram").createSocket({type:"udp4",reuseAddr:!0});g.on("listening",function(){g.setBroadcast(!0);f&&(f(null,g),f=null)});g.on("message",function(a,b){d(a,b,c)});g.on("error",function(a){f&&(f(a),f=null)});g.bind(a,b);return g},f=function(a){var d=new Buffer([200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,214,2,39,11,100,179,139]);a.send(d,0,d.length,21E3,"255.255.255.255")};
(function(a){var b=a,e=[],f=[],g=require("os"),q=require("dgram");if(g&&g.networkInterfaces){var m=q.createSocket({type:"udp4",reuseAddr:!0});m.on("listening",function(){m.setBroadcast(!0);var a=g.networkInterfaces(),d=[],h;for(h in a)for(var k=a[h],p=0;p<k.length;p++)"IPv4"==k[p].family&&0==k[p].internal&&d.push(k[p].address);var n=0;for(a=0;a<d.length;a++)c(21E3,d[a],e,function(a,c){!a&&c&&f.push(c);n++;n==d.length&&b&&(b(null,f,e),b=null)})});m.on("message",function(a,b){d(a,b,e)});m.on("error",
function(a){m.close();b&&(b(a),b=null)});m.bind(21E3);m._isListenerSocket=!0;f.push(m)}else c(21E3,null,e,function(d,b){d?a&&a(d):(b&&f.push(b),a&&a(null,f,e))})})(function(d,c,e){if(!d&&c){for(d=0;d<c.length;d++){var g=c[d];g._isListenerSocket||f(g)}setTimeout(function(){if(c)for(var a=0;a<c.length;a++)c[a].close();b&&b(null,e)},a)}})};return c}();
xnm.aio.ir.IRTrans.DM=function(){return{SYS:"irtrans",registModule:function(c){c.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"IRTrans"}},createGateway:function(c,a,b){a=xnm.aio.ir.DMError;var d=xnm.aio.ir.DMError.ERROR_CODE;c?c.ip?b(null,c):b(new a(d.INVALID,"ip is invalid")):b(new a(d.INVALID,"info is invalid"))},updateGateway:function(c,a,b,d){c=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?d(null,a):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,
"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new d(e.INVALID,"gateway is invalid"))},
updateDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){b()},getCommandStatusMap:function(c){var a={command:[]};if(c&&c.ircodes&&c.ircodes.codes){for(var b=0;b<c.ircodes.codes.length;b++){var d=
c.ircodes.codes[b];a.command.push({type:"enum",name:d.key,ref:{value:d.key}})}return a}return null}}}();
xnm.aio.ir.iTach=function(){var c=function(a,b,c){this.type="learnIR";this.itach=a;this.closeSocket=b;this.callback=c;this.timer=null;this._step=0;this._data=""};c.prototype.run=function(){var a=this;this.itach._createSocket(function(b){b?(a.itach._delTask(a),a.callback&&a.callback(b),a._taskFinish()):(a.itach._doRequest("get_IRL\r"),a._step=1,a.timer=setTimeout(function(){a.itach._doRequest("stop_IRL\r");a.callback&&a.callback(Error("learn ir code timeout"));a.itach._delTask(a);a._taskFinish()},
2E4))})};c.prototype.onData=function(a){this._data+=a;-1!=this._data.indexOf("\r")&&(1==this._step?"IR Learner Enabled"==this._data.trim()?(this._data="",this._step=2):(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):2==this._step&&(0==this._data.indexOf("sendir")?(a=this._data.split(","),a.splice(0,2),a=a.join().trim(),this._step=3,this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(null,
a),this._taskFinish()):this._data=""))};c.prototype.onTimeout=function(){switch(this._step){case 1:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(Error("learn ir code req timeout")),this._taskFinish()}};c.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var a=function(a,b,c){this.type="sendIR";this.itach=a;this.closeSocket=b.closeSocket;this.address=
b.address?b.address:"1:1";this.code=b.code;this.callback=c;this._step=0;this._data=""};a.prototype.run=function(){var a=this;this.itach._createSocket(function(b){b?(a.itach._delTask(a),a.callback&&a.callback(b),a._taskFinish()):(a.itach._doRequest("set_IR,"+a.address+",IR\r"),a._step=1)})};a.prototype.onData=function(a){this._data+=a;if(-1!=this._data.indexOf("\r"))if(1==this._step)-1!=this._data.trim().indexOf("ERR")?(this.itach._delTask(this),this.callback&&this.callback(Error(this._data)),this._taskFinish()):
(this._data="",this._step=2,this.itach._doRequest("sendir,"+this.address+","+this.code+"\r"));else if(2==this._step){if(-1!=this._data.trim().indexOf("ERR")||-1!=this._data.trim().indexOf("busyIR"))var b=Error(this._data);this.itach._delTask(this);this.callback&&this.callback(b);this._taskFinish()}};a.prototype.onTimeout=function(){switch(this._step){case 1:case 2:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback("send ir code timeout"),this._taskFinish()}};
a.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask()};var b=function(a,b,c){var d=require("x.logger.js");this.ip=a;this.port=b?b:4998;this.uuid=c;this.model=null;this._logger=d?d.getLogger("xnm.aio.ir.iTach"):{log:function(){}};this._idleTimer=this._socket=null;this._taskBuffer=[]};b.prototype.toJSON=function(){return{sys:xnm.aio.ir.iTach.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid?this.uuid:
"",model:this.model?this.model:""}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.ip==a.ip&&this.port==a.port:!1};b.prototype.executeCommandCreator=function(a,b,c,g){if(b&&b.value)if(a&&a.ircodes&&a.ircodes.codes){for(var d,e=0;e<a.ircodes.codes.length;e++){var f=a.ircodes.codes[e];if(f.key==b.value){d=f.code;break}}d?this.executeCommand(a.address,d,g,function(){c&&c()}):c&&c(Error("no such ir code:"+b.value))}else c&&c(Error("device has no ir codes"));else c&&c(Error("command invalid"))};
b.prototype.executeCommand=function(b,c,f,g){b=new a(this,{address:b,code:c,closeSocket:f},g);this._addTask(b)};b.prototype.learnIrCode=function(a,b){b&&(a=new c(this,a,b),this._addTask(a))};b.SO_TIMEOUT=2E3;b.IDLE_TIMEOUT=6E4;b.prototype._createSocket=function(a){if(this._socket)a();else{var c=this,d={port:this.port,host:this.ip},g=require("net").connect(d);g.setTimeout(b.SO_TIMEOUT);g.setEncoding("utf8");g.on("connect",function(){c._logger.log("trace","connect to itach:"+c.ip);c._socket=g;a()});
g.on("data",function(a){c._logger.log("trace","receive from itach:"+c.ip+" data:"+a);c._onSocketData(a)});g.on("error",function(b){c._socket?(c._logger.log("trace","itach:"+c.ip+" error:"+b.message),c._onSocketError(b)):(c._logger.log("trace","itach:"+c.ip+" connection error:"+b.message),a(b))});g.on("timeout",function(){c._socket?(c._logger.log("trace","itach:"+c.ip+" data timeout"),c._onSocketTimeout()):(c._logger.log("trace","itach:"+c.ip+" connection timeout"),g.destroy(),a(Error("timeout")))});
g.on("close",function(){c._logger.log("trace","itach:"+c.ip+" close socket");c._onSocketClose()});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()}};b.prototype._closeSocket=function(){this._logger.log("trace","to close itach socket");this._socket&&this._socket.end();this._clean()};b.prototype._clean=function(){this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null);this._socket=null;if(this._taskBuffer)for(var a=0;a<this._taskBuffer.length;a++){var b=this._taskBuffer[a];
b&&b.callback&&b.callback(Error("socket closed"))}this._taskBuffer=[]};b.prototype._onSocketError=function(a){this._closeSocket()};b.prototype._onSocketTimeout=function(){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onTimeout()};b.prototype._onSocketClose=function(){this._clean()};b.prototype._onSocketData=function(a){if(this._taskBuffer&&0<this._taskBuffer.length)this._taskBuffer[0].onData(a)};b.prototype._addTask=function(a){this._logger.log("trace","add task to buffer");this._idleTimer&&
clearTimeout(this._idleTimer);var c=this;this._idleTimer=setTimeout(function(){c._logger.log("trace","idle timer triggered");c._closeSocket()},b.IDLE_TIMEOUT);var d=this._taskBuffer.length;this._taskBuffer.push(a);0==d&&this._doNextTask()};b.prototype._delTask=function(a){this._logger.log("trace","delete task from buffer");for(var b=-1,c=0;c<this._taskBuffer.length;c++)if(this._taskBuffer[c]===a){b=c;break}-1!=b&&this._taskBuffer.splice(b,1)};b.prototype._doNextTask=function(){this._taskBuffer&&0<
this._taskBuffer.length&&this._taskBuffer[0].run()};b.prototype._doRequest=function(a){this._logger.log("trace","send data to itach:"+this.ip+" data:"+a);this._socket&&this._socket.write(a)};b.parseJSON=function(a){if(!a||!a.ip)return null;var c=new b(a.ip,a.port,a.uuid);c.model=a.model;return c};b.discovery=function(a){if(a&&(this._discoverCallbacks||(this._discoverCallbacks=[]),this._addDiscoverCallback(a),!this._discoverRunning)){this._discoverRunning=!0;var b=this;this._startDiscovery(function(a){if(a){for(var c=
0;c<b._discoverCallbacks.length;c++)b._discoverCallbacks[c](a);b._discoverCallbacks=[];b._discoverRunning=!1}else setTimeout(function(){b._stopDiscovery(function(){var a=[],c;for(c in b._discoverResults)b._discoverResults.hasOwnProperty(c)&&a.push(b._discoverResults[c]);for(c=0;c<b._discoverCallbacks.length;c++)b._discoverCallbacks[c](null,a);b._discoverCallbacks=[]})},1E4)})}};b._addDiscoverCallback=function(a){for(var b=!1,c=0;c<this._discoverCallbacks.length;c++)if(this._discoverCallbacks[c]===
a){b=!0;break}b||this._discoverCallbacks.push(a)};b._removeDiscoverCallback=function(a){for(var b=-1,c=0;c<this._discoverCallbacks.length;c++)if(this._discoverCallbacks[c]===a){b=c;break}-1!=b&&this._discoverCallbacks.splice(b,1)};b._startDiscovery=function(a){var c=require("x.logger.js");this._logger||(this._logger=c?c.getLogger("xnm.aio.ir.iTach"):{log:function(){}});this._discoverResults={};var d=this;(function(a,b){var c=b,d=[],e=require("os");b=require("dgram");if(e&&e.networkInterfaces){e=e.networkInterfaces();
for(var f in e)if(e.hasOwnProperty(f))for(var g=e[f],h=0;h<g.length;h++)"IPv4"==g[h].family&&0==g[h].internal&&d.push(g[h].address)}var l=b.createSocket("udp4");l.on("listening",function(){l.setBroadcast(!0);if(0<d.length)for(var a=0;a<d.length;a++)l.addMembership("239.255.250.250",d[a]);else l.addMembership("239.255.250.250");c&&(c(null,l),c=null)});l.on("message",function(b,c){a(b,c)});l.on("error",function(a){l.close();c&&(c(a),c=null)});l.bind(9131)})(function(a,c){a=a.toString();if(0==a.indexOf("AMXB")){0==
a.indexOf("AMXB")&&(a=a.substr(4));var e=a.split(/<-/g);a={};for(var f=0;f<e.length;f++){var g=e[f].trim();g=g.substr(0,g.length-1);g=g.split("=");2<=g.length&&g[0]&&(a[g[0]]=g[1])}d._logger.log("trace","find iTach:"+JSON.stringify(a));a.UUID&&!d._discoverResults[a.UUID]&&(c=new b(c.address,4998,a.UUID),c.model=a.Model,d._discoverResults[a.UUID]=c)}},function(b,c){b?a&&a(b):(d._discoverSocket=c,a&&a())})};b._stopDiscovery=function(a){this._discoverSocket||a&&a();this._discoverSocket.close();this._discoverSocket=
null;this._discoverRunning=!1;a&&a()};return b}();
xnm.aio.ir.iTach.DM=function(){return{SYS:"itach",registModule:function(c){c.register(this.SYS,"ir")},getGatewayType:function(){return{sys:this.SYS,name:"Global Cach\u00e9 iTach (IR)"}},createGateway:function(c,a,b){a=xnm.aio.ir.DMError;var d=xnm.aio.ir.DMError.ERROR_CODE;c?c.ip?b(null,c):b(new a(d.INVALID,"ip is invalid")):b(new a(d.INVALID,"info is invalid"))},updateGateway:function(c,a,b,d){c=xnm.aio.ir.DMError;b=xnm.aio.ir.DMError.ERROR_CODE;a?a.ip?d(null,a):d(new c(b.INVALID,"ip is invalid")):
d(new c(b.INVALID,"update is invalid"))},deleteGateway:function(c,a,b){b()},createDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c.gateway)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else b(new d(e.INVALID,"gateway is invalid"))},
updateDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.gateway){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===c.gateway){var g=a[f];break}g?b(null,c):b(new d(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else b(new d(e.INVALID,"gateway is invalid"));else b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){b()},getCommandStatusMap:function(c){var a={command:[]};if(c&&c.ircodes&&c.ircodes.codes){for(var b=0;b<c.ircodes.codes.length;b++){var d=
c.ircodes.codes[b];a.command.push({type:"enum",name:d.key,ref:{value:d.key}})}return a}return null}}}();xnm.aio.ir.DMError=function(){var c=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};c.prototype=Error();c.prototype.name="IrDmError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return c}();
xnm.aio.ir.DM=function(){return{getGatewayType:function(c){var a=[],b;for(b in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(b)){var d=xnm.aio.ir[b];d&&d.DM&&d.DM.getGatewayType&&(d=d.DM.getGatewayType(c))&&a.push(d)}return a},_getSystem:function(c){for(var a in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(a)){var b=xnm.aio.ir[a];if(b&&b.DM&&b.DM.SYS&&b.DM.SYS==c)return b}return null},createGateway:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.sys){var f=this._getSystem(c.sys);
f&&f.DM&&f.DM.createGateway?f.DM.createGateway(c,a,b):b&&b(new d(e.INVALID,"no such sys:"+c.sys))}else b&&b(new d(e.INVALID,"sys is invalid"));else b&&b(new d(e.INVALID,"info is invalid"))},updateGateway:function(c,a,b,d){var e=xnm.aio.ir.DMError,f=xnm.aio.ir.DMError.ERROR_CODE;if(a)if(a.sys){var g=this._getSystem(a.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(c,a,b,d):d&&d(new e(f.INVALID,"no such sys:"+a.sys))}else d&&d(new e(f.INVALID,"sys is invalid"));else d&&d(new e(f.INVALID,"update is invalid"))},
deleteGateway:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.sys){var f=this._getSystem(c.sys);f&&f.DM&&f.DM.deleteGateway?f.DM.deleteGateway(c,a,b):b&&b(new d(e.INVALID,"no such sys:"+c.sys))}else b&&b(new d(e.INVALID,"sys is invalid"));else b&&b()},createDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.sys){var f=this._getSystem(c.sys);f&&f.DM&&f.DM.createDevice?f.DM.createDevice(c,a,b):b&&b(new d(e.INVALID,"no such sys:"+
c.sys))}else b&&b(new d(e.INVALID,"sys is invalid"));else b&&b(new d(e.INVALID,"info is invalid"))},updateDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;if(c)if(c.sys){var f=this._getSystem(c.sys);f&&f.DM&&f.DM.updateDevice?f.DM.updateDevice(c,a,b):b&&b(new d(e.INVALID,"no such sys:"+c.sys))}else b&&b(new d(e.INVALID,"sys is invalid"));else b&&b(new d(e.INVALID,"info is invalid"))},deleteDevice:function(c,a,b){var d=xnm.aio.ir.DMError,e=xnm.aio.ir.DMError.ERROR_CODE;
if(c)if(c.sys){var f=this._getSystem(c.sys);f&&f.DM&&f.DM.deleteDevice?f.DM.deleteDevice(c,a,b):b&&b(new d(e.INVALID,"no such sys:"+c.sys))}else b&&b(new d(e.INVALID,"sys is invalid"));else b&&b()},applyUIFilter:function(c,a){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},d=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;
case "status":a.status&&a.status.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var c=[],e;if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.getCommandStatusMap&&(e=f.DM.getCommandStatusMap(a))}e&&(a=d(e,a,b),c=c.concat(a));return c};if(!c.sys)return null;var f=JSON.parse(JSON.stringify(c)),g=null;switch(a.catagory){case "command":g=e.call(this,c,a);f.command=g;break;case "status":g=e.call(this,c,a);f.status=g;break;default:return null}return g&&
0!=g.length?f:null}}}();
xnm.aio.ir.Handler=function(){var c=function(){};c.prototype.devicemanager=xnm.aio.ir.DM;c.prototype.registModule=function(a){for(var b in xnm.aio.ir)if(xnm.aio.ir.hasOwnProperty(b)){var c=xnm.aio.ir[b];c&&c.DM&&c.DM.registModule&&c.DM.registModule(a)}};c.prototype.resolveGateway=function(a){switch(a.sys){case xnm.aio.ir.IRTrans.DM.SYS:return xnm.aio.ir.IRTrans.parseJSON(a);case xnm.aio.ir.RedEye.DM.SYS:return xnm.aio.ir.RedEye.parseJSON(a);case xnm.aio.ir.iTach.DM.SYS:return xnm.aio.ir.iTach.parseJSON(a);default:return null}};
c.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.ir.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};c.prototype.searchIRTransWithTimeout=function(a,b){xnm.aio.ir.IRTrans._discovery(a,b)};c.prototype.learnIRTransCode=function(a,b,c){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.learnIrCode(b,c):c&&c(Error("gateway json format invalid"))};c.prototype.doIRTransCommand=function(a,b,c,e){(a=xnm.aio.ir.IRTrans.parseJSON(a))?a.executeCommandCreator(b,c,e,!0):e&&e(Error("gateway json format invalid"))};
c.prototype.searchRedeyeWithTimeout=function(a,b){xnm.aio.ir.RedEye.discoveryWithTimeout(a,b)};c.prototype.learnRedeyeCode=function(a,b){(a=xnm.aio.ir.RedEye.parseJSON(a))?a.learnIrCode(b):b&&b(Error("gateway json format invalid"))};c.prototype.doRedeyeCommand=function(a,b,c,e){(a=xnm.aio.ir.RedEye.parseJSON(a))?a.executeCommandCreator(b,c,e):e&&e(Error("gateway json format invalid"))};c.prototype.searchITach=function(a){xnm.aio.ir.iTach.discovery(a)};c.prototype.learnITachCode=function(a,b){(a=xnm.aio.ir.iTach.parseJSON(a))?
a.learnIrCode(!0,b):b&&b(Error("gateway json format invalid"))};c.prototype.doITachCommand=function(a,b,c,e){(a=xnm.aio.ir.iTach.parseJSON(a))?a.executeCommandCreator(b,c,e,!0):e&&e(Error("gateway json format invalid"))};return c}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ir.Handler);
