var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.icomfort=xnm.aio.icomfort||{};xnm.aio.icomfort.Gateway=function(a){this.ip=a;this.port=5555;this._learnedDeviceCallback=this._connection=this.uuid=null;this._devicesToGetStatesFor=[];this._states={};this._gotStateCallback=this._stateAddress=this._sentCommandCallback=this._gotStatesCallback=null;this._rooms={}};
xnm.aio.icomfort.Gateway.prototype._closeConnection=function(){this._connection&&this._connection.end();this._learnedDeviceCallback&&(this._learnedDeviceCallback(null),this._learnedDeviceCallback=null);this._gotStatesCallback&&(this._gotStatesCallback(this._states),this._gotStatesCallback=null);this._sentCommandCallback&&(this._sentCommandCallback(),this._sentCommandCallback=null)};
xnm.aio.icomfort.Gateway.prototype._getData=function(a){var b={};a=a.split("&");for(var c=0;c<a.length;c++){var d=a[c].split("=");2==d.length&&(b[d[0]]=d[1])}return b};xnm.aio.icomfort.Gateway.prototype._evalState=function(a){return"00"==a?"off":"3F"==a?"on":Math.round(parseInt(a,16)/62*100)+"%"};xnm.aio.icomfort.Gateway.prototype._evalEData=function(a){a=this._getData(a);a.a&&this._learnedDeviceCallback&&(this._learnedDeviceCallback({address:a.a}),this._learnedDeviceCallback=null,this._closeConnection())};
xnm.aio.icomfort.Gateway.prototype._evalGData=function(a){a=this._getData(a);if(0<this._devicesToGetStatesFor.length)for(var b=0;b<this._devicesToGetStatesFor.length;b++){var c=this._devicesToGetStatesFor[b];if(c.address==a.a){this._devicesToGetStatesFor.splice(b,1);this._states[c.address]=this._evalState(a.d);this._getNextState();break}}else this._gotStateCallback?this._stateAddress==a.a&&(this._gotStateCallback(this._evalState(a.d)),this._gotStateCallback=null):this._sentCommandCallback&&this._closeConnection()};
xnm.aio.icomfort.Gateway.prototype._evalBlock=function(a){2<a.length&&("E?"==a.substr(0,2)?this._evalEData(a.substr(2)):"G?"==a.substr(0,2)||"F?"==a.substr(0,2)?this._evalGData(a.substr(2)):XC.debugf(a))};
xnm.aio.icomfort.Gateway.prototype._connect=function(a){var b="",c=this;this._connection=require("net").connect({port:this.port,host:this.ip},function(){a&&a()});this._connection.on("data",function(a){for(b+=a.toString();0<(a=b.indexOf("\n"));)c._evalBlock(b.substr(0,a)),b=b.substr(a+1)});this._connection.on("end",function(){XC.debugf("END")});this._connection.on("error",function(){XC.debugf("ERROR");c._closeConnection()})};
xnm.aio.icomfort.Gateway.prototype._executeCommand=function(a,b){this._connection?("on"==b?b="3F":"off"==b?b="00":(0==b.indexOf("dimTo")&&(b=b.replace(/dimTo/g,"")),b=b.replace(/%/g,""),b=XC.getHexVal(Math.round(parseInt(b)/100*62),2)),a=new Buffer("S?a="+a+"&d="+b+"\n"),this._connection.write(a)):this._closeConnection()};xnm.aio.icomfort.Gateway.prototype._getNextState=function(){if(0<this._devicesToGetStatesFor.length){var a=new Buffer("G?a="+this._devicesToGetStatesFor[0].address+"\n");this._connection.write(a)}else this._closeConnection()};
xnm.aio.icomfort.Gateway.prototype._getState=function(a,b){this._gotStateCallback=b;this._stateAddress=a;a=new Buffer("G?a="+a+"\n");this._connection.write(a)};xnm.aio.icomfort.Gateway.prototype.sendCommand=function(a,b,c){this._sentCommandCallback=c;var d=this;this._connect(function(){"toggle"==b?d._getState(a,function(b){"off"==b?d._executeCommand(a,"on"):d._executeCommand(a,"off")}):d._executeCommand(a,b)})};
xnm.aio.icomfort.Gateway.prototype.learnDevice=function(a){this._learnedDeviceCallback=a;this._connect()};xnm.aio.icomfort.Gateway.prototype.getStates=function(a,b){this._states={};this._devicesToGetStatesFor=a;this._gotStatesCallback=b;var c=this;this._connect(function(){c._getNextState()})};
xnm.aio.icomfort.Discovery=function(){this.Gateways={};this.callback=null;this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a)for(var c=a[b],d=0;d<c.length;d++)this._addDiscoverSocket(5556,c[d])}else this._addDiscoverSocket(5556,null)};
xnm.aio.icomfort.Discovery.prototype._receivedData=function(a,b){b=b.toString();36==b.length&&"REV ICOMFORT"==b.substr(0,12)&&(this.Gateways[a]=new xnm.aio.icomfort.Gateway(a),this.Gateways[a].uuid=b.substr(17,17),this.callback&&this.callback(this.Gateways[a]))};
xnm.aio.icomfort.Discovery.prototype._addDiscoverSocket=function(a,b){var c=require("dgram"),d=this;if(b)"IPv4"==b.family&&0==b.internal&&(e=c.createSocket("udp4"),e.on("listening",function(){e.setBroadcast(!0)}),e.on("message",function(a,b){d._receivedData(b.address,a)}),e.bind(a,b.address),this._sockets.push(e));else{var e=c.createSocket("udp4");e.on("message",function(a,b){d._receivedData(b.address,a)});e.bind(a);this._sockets.push(e)}};
xnm.aio.icomfort.Discovery.prototype._sendDiscoveryMessages=function(a,b,c,d){a=new Buffer([68]);for(b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,5556,"255.255.255.255")};xnm.aio.icomfort.Discovery.prototype.discoverGateways=function(){this._sendDiscoveryMessages()};xnm.aio.icomfort.Handler=function(){this._Discovery=null};
xnm.aio.icomfort.Handler.prototype.discoverGateways=function(a){this._Discovery||(this._Discovery=new xnm.aio.icomfort.Discovery);a&&(this._Discovery.callback=a);this._Discovery.discoverGateways()};xnm.aio.icomfort.Handler.prototype.getDetectedGateways=function(){this._Discovery||(this._Discovery=new xnm.aio.icomfort.Discovery);return this._Discovery.Gateways};xnm.aio.icomfort.Handler.prototype.Gateway=xnm.aio.icomfort.Gateway;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.icomfort.Handler);
