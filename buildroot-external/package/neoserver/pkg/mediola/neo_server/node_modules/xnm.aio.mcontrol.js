var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,d,e){a instanceof String&&(a=String(a));for(var g=a.length,f=0;f<g;f++){var c=a[f];if(d.call(e,c,f,a))return{i:f,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,e){a!=Array.prototype&&a!=Object.prototype&&(a[d]=e.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var d=0;d<a.length;++d){var e=a[d];if(e&&e.Math==Math)return e}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,d,e,g){if(d){e=$jscomp.global;a=a.split(".");for(g=0;g<a.length-1;g++){var f=a[g];f in e||(e[f]={});e=e[f]}a=a[a.length-1];g=e[a];d=d(g);d!=g&&null!=d&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(d,a){return $jscomp.findInternal(this,d,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mcontrol=xnm.aio.mcontrol||{};
xnm.aio.mcontrol.MControl=function(){var a={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},d=function(c){return c.replace(/[<>&"']/g,function(b){return a[b]})},e=function(c,b,h){this.device=c;this.command=b;this.callback=h;this._socket=null};e.prototype.run=function(c){var b=this;c._connect({onError:function(c){b._finish(c)},onTimeout:function(){b._finish(Error("response timeout"))},onData:function(){b._socket.end();b._finish()},onClose:function(){b._finish()}},function(h,d){h?b._finish(h):
(b._socket=d,h=c._buildCommand(b.device,b.command),d.write(h,"utf8"))})};e.prototype._finish=function(c){this.callback&&this.callback(c);this.callback=null};var g=function(c,b){this.deviceList=c;this.callback=b;this._socket=null;this._block="";this._responseComplete=!1};g.prototype.run=function(c){var b=this;c._connect({onError:function(c){b._finish(c)},onTimeout:function(){b._responseComplete||b._finish(Error("response timeout"))},onData:function(c){b._block+=c;b._handleRsp()},onClose:function(){b._finish()}},
function(d,a){d?b._finish(d):(b._socket=a,d=c._buildStatus(b.deviceList),a.write(d,"utf8"))})};g.prototype._finish=function(c,b){this.callback&&this.callback(c,b);this.callback=null};g.prototype._handleRsp=function(){var c=this._block.indexOf("\n");if(!(0>=c))if("XML"!=this._block.substr(0,c))this._block="";else{var b=this._block.indexOf("\n",c+1);0>b||(c=this._block.substr(c+1,b-c-1),c=parseInt(c),this._block.length<c+4+9||(this._responseComplete=!0,b=this._block.substr(b+1),0==b.charCodeAt(b.length-
1)&&(b=b.substr(0,b.length-1)),this._parseStatus(b),this._socket.end()))}};g.prototype._parseStatus=function(c){var b=[];$($.parseXML(c)).find("return").each(function(){var c=$(this),d=c.attr("name");c=c.attr("value");b.push({id:d,status:c})});this._finish(null,b)};var f=function(c,b){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.mcontrol.MControl"):{log:function(){}};this.ip=c;this.port=b;this.port||(this.port=8082)};f.prototype.REQ='<?xml version="1.0"?>\n<mctrlmessage>\n<request name="@1" module="@2">\n@3</request>\n</mctrlmessage>\n';
f.prototype.PARAM='<param name="@1" value="@2" />\n';f.prototype.executeCommandCreator=function(c,b,d){var a=b.ext;b.value&&"do"!=b.value&&"setInt"!=b.value&&"setFloat"!=b.value&&(a=b.value+(null!=a&&"undefined"!=typeof a?a:""));this.executeCommand(c.address,a,function(b){d&&d(b)})};f.prototype.getStatesCreator=function(c,b,d){if(b)if(0==b.length)d&&d(null,[]);else{c={};for(var a=0;a<b.length;a++)b[a]&&b[a].id&&b[a].device&&b[a].device.address&&(c[b[a].id]=b[a].device.address);this.getStates(c,function(c,
a){if(c)d&&d(c);else{c={};for(var e=0;e<b.length;e++)b[e]&&b[e].id&&b[e].status&&b[e].status.value&&(c[b[e].id]=b[e].status.value);e=[];a||(a=[]);for(var h=0;h<a.length;h++){var f=a[h].status;"intVal"==c[a[h].id]?(f=parseInt(f),isNaN(f)||e.push({id:a[h].id,status:f})):"floatVal"==c[a[h].id]?(f=parseFloat(f),isNaN(f)||e.push({id:a[h].id,status:f})):e.push({id:a[h].id,status:a[h].status})}d&&d(null,e)}})}else d&&d(Error("deviceList is null"))};f.prototype.executeCommand=function(c,b,a){c&&null!=b&&
"undefined"!=typeof b?(new e(c,b,a)).run(this):a&&a(Error("argument invalid"))};f.prototype.getStates=function(c,b){c?(new g(c,b)).run(this):b&&b(Error("deviceList is null"))};f.prototype._buildCommand=function(c,b){var a=f.prototype.PARAM.replace("@1","command");c=c.split(".");a=a.replace("@2",d(c[0]+"."+(c[1]?c[1]+".":"")+b));b=f.prototype.REQ.replace("@1","ExecuteCommand");b=b.replace("@2","hcontrol");b=b.replace("@3",a);a=b.length;for(a=a.toString();8>a.length;)a="0"+a;return"MCM:PLUGIN\nXML\n"+
a+"\n"+b};f.prototype._buildStatus=function(a){var b="",c;for(c in a)if(a.hasOwnProperty(c)){var e=f.prototype.PARAM.replace("@1",d(c));e=e.replace("@2",d(a[c]));b+=e}a=f.prototype.REQ.replace("@1","GetStates");a=a.replace("@2","hcontrol");a=a.replace("@3",b);b=a.length;for(b=b.toString();8>b.length;)b="0"+b;return"MCM:PLUGIN\nXML\n"+b+"\n"+a};f.prototype._connect=function(a,b){var d=this,c={port:this.port,host:this.ip},e=!1,f=b,g=require("net").connect(c);a.__socket=g;g.setTimeout(1E4);g.setEncoding("utf8");
g.on("connect",function(){d._logger.log("trace","connect tcp to:"+d.ip);e=!0;if(f){var b=a.__socket;delete a.__socket;f(null,b)}});g.on("data",function(b){d._logger.log("trace","receive from tcp:"+d.ip+" data:"+b);a.onData(b)});g.on("error",function(b){e?(d._logger.log("trace","tcp:"+d.ip+" error:"+b.message),g.end(),a.onError(b)):(d._logger.log("trace","tcp:"+d.ip+" connection error:"+b.message),f&&(f(b),f=null))});g.on("timeout",function(){e?(d._logger.log("trace","tcp:"+d.ip+" data timeout"),g.end(),
a.onTimeout()):(d._logger.log("trace","tcp:"+d.ip+" connection timeout"),g.end(),f&&(f(Error("connection timeout")),f=null))});g.on("close",function(){d._logger.log("trace","tcp:"+d.ip+" close socket");a.onClose()});g._doConnect&&"function"==typeof g._doConnect&&g._doConnect()};f.prototype.toJSON=function(){return{sys:xnm.aio.mcontrol.DM.SYS,ip:this.ip,port:this.port}};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip==a.ip&&this.port==a.port:!1};return f}();
xnm.aio.mcontrol.DMError=function(a,d){this.code=a;this.message=d;this.stack=Error().stack};xnm.aio.mcontrol.DMError.prototype=Error();xnm.aio.mcontrol.DMError.prototype.name="MControlDMError";xnm.aio.mcontrol.DMError.prototype.code=0;xnm.aio.mcontrol.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};
xnm.aio.mcontrol.DM={SYS:"mcontrol",MAP:{command:[{type:"string",name:"do",ref:{value:"do",ext:"%s"}},{type:"int",name:"set integer value",ref:{value:"setInt",ext:"%d"}},{type:"float",name:"set float value",ref:{value:"setFloat",ext:"%f"}}],status:[{type:"string",name:"value",ref:{value:"state"}},{type:"int",name:"value as integer",ref:{value:"intVal"}},{type:"float",name:"value as float",ref:{value:"floatVal"}}]},getGatewayType:function(){return[{sys:this.SYS,name:"mControl",port:8082}]},createGateway:function(a,
d,e){d=xnm.aio.mcontrol.DMError;var g=xnm.aio.mcontrol.DMError.ERROR_CODE;a?a.ip?e(null,a):e(new d(g.INVALID,"ip is invalid")):e(new d(g.INVALID,"info is invalid"))},updateGateway:function(a,d,e,g){a=xnm.aio.mcontrol.DMError;e=xnm.aio.mcontrol.DMError.ERROR_CODE;d?d.ip?g(null,d):g(new a(e.INVALID,"ip is invalid")):g(new a(e.INVALID,"update is invalid"))},deleteGateway:function(a,d,e){e()},createDevice:function(a,d,e){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(d.data&&
d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var c;for(c=0;c<d.length;c++)if(d[c].index===a.gateway){var b=d[c];break}b?e(null,a):e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else e(new g(f.INVALID,"address is invalid"));else e(new g(f.INVALID,"gateway is invalid"));else e(new g(f.INVALID,"info is invalid"))},updateDevice:function(a,d,e){var g=xnm.aio.mcontrol.DMError,f=xnm.aio.mcontrol.DMError.ERROR_CODE;
if(a)if(a.gateway)if(a.address)if(d.data&&d.data.gateways&&0!==d.data.gateways.length){d=d.data.gateways;var c;for(c=0;c<d.length;c++)if(d[c].index===a.gateway){var b=d[c];break}b?e(null,a):e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new g(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else e(new g(f.INVALID,"address is invalid"));else e(new g(f.INVALID,"gateway is invalid"));else e(new g(f.INVALID,"info is invalid"))},deleteDevice:function(a,d,e){e()},
applyUIFilter:function(a,d){var e=function(a,b){if("*"==a)return!0;for(var d=!1,c=0;c<a.length;c++)if(a[c]==b){d=!0;break}return d},g=function(a,b,d){var c=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){e(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),c.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),c.push(a))})}return c},f=function(a,d){var b=[],c=JSON.parse(JSON.stringify(xnm.aio.mcontrol.DM.MAP));
c&&(a=g(c,a,d),b=b.concat(a));return b};if(!a)return null;var c=JSON.parse(JSON.stringify(a)),b=null;switch(d.catagory){case "command":b=f(a,d);c.command=b;break;case "status":b=f(a,d);c.status=b;break;default:return null}return b&&0!=b.length?c:null}};
xnm.aio.mcontrol.Handler=function(){var a=function(){};a.prototype.MControl=xnm.aio.mcontrol.MControl;a.prototype.devicemanager=xnm.aio.mcontrol.DM;a.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"mcontrol")};a.prototype.resolveGateway=function(a){return a&&a.ip?new xnm.aio.mcontrol.MControl(a.ip,a.port):null};a.prototype.getDeviceCommands=function(a,e){a=(a=xnm.aio.mcontrol.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];e&&e(null,a)};a.prototype.getDeviceStatus=
function(a,e){a=(a=xnm.aio.mcontrol.DM.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];e&&e(null,a)};a.prototype.doCommand=function(a,e,g,f){(a=this.resolveGateway(a))?a.executeCommandCreator(e,g,function(a){f&&f(a)}):f&&f(Error("gateway json format invalid"))};a.prototype.doStatus=function(a,e,g,f,c){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:a,device:g,status:f}],function(a,d){a?c&&c(a):c&&c(null,d[0])}):c&&c(Error("gateway json format invalid"))};return a}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mcontrol.Handler);
