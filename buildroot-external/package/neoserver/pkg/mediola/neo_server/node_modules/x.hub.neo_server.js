var x=x||{};x.hub=x.hub||{};x.hub.neo_server=x.hub.neo_server||{};
x.hub.neo_server.Time=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Time");this._handler=a};d.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},
{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},
{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,
zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}];d.prototype.init=function(a){a&&a()};d.prototype.getTimezoneSync=function(){var a=new Date,b=new Date(a.getFullYear(),
0,1);a=new Date(a.getFullYear(),6,1);b=b.getTimezoneOffset();a=a.getTimezoneOffset();var c=b!=a,f=Math.round((0-Math.max(b,a))/60),m=null;d.TimeZone_MAP.forEach(function(a){a.utc==f&&a.dst==c&&(m=a.zone)});return m};d.prototype.getTimezoneEncoded=function(a){var b=new Date,c=new Date(b.getFullYear(),0,1);b=new Date(b.getFullYear(),6,1);c=c.getTimezoneOffset();b=b.getTimezoneOffset();var f=Math.round((0-Math.max(c,b))/60)+11;0>f&&(f=0);12<f&&(f=12);c=(((c!=b?1:0)<<7|f&31)&255).toString(16).toUpperCase();
2>c.length&&(c="0"+c);a&&a(null,c)};return d}();
x.hub.neo_server.Network=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.neo_server.Network");this._handler=a};d.prototype.init=function(a){a&&a()};d.prototype.getNetwork=function(a){var b=this;this._getDNS(function(c,f){b._getRouter(function(b,c){b=require("os").networkInterfaces();var d={},e;for(e in b)if("lo"!=e.substr(0,2))for(var l=b[e],n=0;n<l.length;n++){var h=l[n];h.internal||"IPv4"!=h.family||(h={ip:h.address,subnet:h.netmask,mac:h.mac,dns:f},h.router=c?
c[e]:null,d[e]=h)}a&&a(null,d)})})};d.prototype._getDNS=function(a){var b=require("dns"),c=[];b&&b.getServers&&(c=b.getServers());a(null,c)};d.prototype._getRouter=function(a){try{var b=require("netroute").getInfo(),c={};if(b&&b.IPv4)for(var f=0;f<b.IPv4.length;f++)"0.0.0.0"==b.IPv4[f].destination&&b.IPv4[f].interface&&b.IPv4[f].gateway&&(c[b.IPv4[f].interface]=b.IPv4[f].gateway);a(null,c)}catch(m){a(m)}};return d}();
x.hub.neo_server.Handler=function(){var d=function(){this._network=new x.hub.neo_server.Network(this);this._time=new x.hub.neo_server.Time(this);this._hub=null};d.prototype.init=function(a,b){this._hub=a;this._network.init();this._time.init();b&&b()};d.prototype.setTZData=function(a,b){b&&b()};d.prototype.getTZData=function(a){this._time.getTimezoneEncoded(a)};d.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync()};d.prototype.reset=function(a,b){var c=this;switch(a){case "factory":this._stm.reset(function(a){a?
b&&b(a,a?!1:!0):c._zwayServer.reset(function(){c._sysConf.reset(function(a){b&&b(a,a?!1:!0)})})});break;default:b&&b(Error("unknonw reset type: "+a))}};d.prototype.backup=function(a,b,c){var f=this,d=function(a,b,c){var d=require("fs-extra"),e=require("path"),n=require("os").tmpdir(),l=require("archiver"),h=new Date,v=h.getFullYear()+"",m=h.getMonth()+1+"";1==m.length&&(m="0"+m);var g=h.getDate()+"";1==g.length&&(g="0"+g);var k=h.getHours()+"";1==k.length&&(k="0"+k);var q=h.getMinutes()+"";1==q.length&&
(q="0"+q);h=h.getSeconds()+"";1==h.length&&(h="0"+h);var t="backup_"+(v+m+g+k+q+h)+".xbp",p=e.join(n,t);e=d.createWriteStream(p);l=l("zip");e.on("close",function(){if(b){var a=require("crypto").createCipher("aes-256-cbc",b),h=d.createReadStream(p),e=d.createWriteStream(p+".enc");e.on("finish",function(){d.removeSync(p);c(null,p+".enc",t)});h.pipe(a).pipe(e)}else c(null,p,t)});e.on("error",function(a){f._logger.log("warn","write backup zip file failed:"+a.message);c(a)});l.on("error",function(a){f._logger.log("warn",
"zip backup data failed:"+a.message);c(a)});l.pipe(e);l.directory(a+"/","backup");l.finalize()},g=null,k=require("x.crypt.js");a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?g=a.query.at:a.query.auth&&(g=k.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));a=require("fs");k=require("os").tmpdir();var e=require("path"),l=e.join(k,"backup");if(a.existsSync(l))try{a.rmdirRecursiveSync(l)}catch(n){}try{a.mkdirSync(l)}catch(n){b.status(500).end();c&&c(Error('create backup folder "'+e+
'" failed:'+n.message));return}this._backup(l,function(a){a?(b.status(500).end(),c&&c(a)):d(l,g,function(a,e,d){a?(b.status(500).end(),c&&c(a)):(b.setHeader("Content-disposition","attachment; filename="+d),b.sendFile(e,null,function(a){require("fs-extra").removeSync(e);a&&b.status(500).end();c&&c(a)}))})})};d.prototype._backup=function(a,b){require("async").series([function(b){var c=require("fs-extra"),d=require("path"),g=require("x.hub.fileman.js").fileManager.getUserRootDataPath();c.copy(g,d.join(a,
"data"),function(f){f?b(f):c.exists(d.join(a,"data","localstorage","x.hub.Server.pwd"),function(e){e?c.remove(d.join(a,"data","localstorage","x.hub.Server.pwd"),function(a){b(a)}):b()})})}],function(a){b&&b(a)})};d.prototype.restore=function(a,b,c){var d=function(a,b,c){var d=require("fs"),e=require("fs-extra"),f=require("os").tmpdir(),l=require("path"),g=l.join(f,"restore"),n=l.join(g,"backup");if(e.existsSync(g))try{e.removeSync(g)}catch(r){c(r);return}e=require("fs-extra");var m=require("adm-zip"),
k=null;try{(new m(a)).extractAllTo(g,!0)}catch(r){k="invalid backup file/password"}k?b?(b=require("crypto").createDecipher("aes-256-cbc",b),f=d.createReadStream(a),d=d.createWriteStream(a+".dec.zip"),b.on("error",function(){e.removeSync(a);e.removeSync(a+".dec.zip");c(Error(k))}),d.on("finish",function(){k=null;try{(new m(a+".dec.zip")).extractAllTo(g,!0)}catch(r){k="invalid backup file/password"}e.removeSync(a);e.removeSync(a+".dec.zip");c(k?Error(k):null,n)}),f.pipe(b).pipe(d)):(e.removeSync(a),
c(Error(k)),c=null):(e.removeSync(a),c(null,n),c=null)},m=require("x.crypt.js"),g=null;a.query.key?g=a.query.key:a.query.at?g=a.query.at:a.query.auth&&(g=m.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));var k=this;(function(a,b){var c=require("fs"),d=require("os").tmpdir(),e=require("path").join(d,"restore.zip");if(c.existsSync(e))try{c.unlinkSync(e)}catch(u){b(u);return}var f=c.createWriteStream(e);a.pipe(f);f.on("finish",function(){f.close(function(){b(null,e)})});f.on("error",function(a){c.unlink(e);
b(a)})})(a,function(a,f){a?(b.json({XC_ERR:{code:"000000",msg:"donwload backup file failed:"+a.message}}),c&&c(a)):d(f,g,function(a,d){a?(b.json({XC_ERR:{code:"000000",msg:"extract backup data failed:"+a.message}}),c&&c(a)):k._restore(d,function(a){try{var e=require("fs-extra");e.removeSync(f);e.removeSync(d)}catch(u){}a?b.json({XC_ERR:{code:"000000",msg:"restore backup data failed:"+a.message}}):b.json({XC_SUC:{}});c&&c(a)})})})};d.prototype._restore=function(a,b){require("async").series([function(b){var c=
require("fs-extra"),d=require("path"),g=require("x.hub.fileman.js").fileManager.getUserRootDataPath();c.copy(d.join(a,"data"),g,function(a){b(a?Error("restore standard data failed:"+a.message):null)})}],function(a){b&&b(a)})};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.neo_server.Handler);
