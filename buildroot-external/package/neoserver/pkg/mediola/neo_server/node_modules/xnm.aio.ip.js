var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,a,c){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(a.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var a=0;a<b.length;++a){var c=b[a];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,a,c,d){if(a){c=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in c||(c[e]={});c=c[e]}b=b[b.length-1];d=c[b];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");$jscomp.arrayIteratorImpl=function(b){var a=0;return function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}}};
$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,a){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(c){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+a++,c)}var a=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,a){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var c=0,d={next:function(){if(c<b.length){var e=c++;return{value:a(e,b[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.ip=xnm.aio.ip||{};
xnm.aio.ip.Http=function(){var b=function(a,c){this._options=a;this._deviceInfo=c};b.prototype.executeCommandCreator=function(a,c,d){this.executeCommand(c.value,function(a){d&&d(a)})};b.prototype.executeCommand=function(a,c){if(a)if(this._options&&this._options.ip){var d=this._getPort();if(d){var b=this._getMethod();if(b){var f=this._buildControlUrl(a);if(f){var k=this._buildPostData(a);a=this._buildHttpHeader(a);this._doRequest({host:this._options.ip,port:d,path:f,method:b,username:this._options.username,
password:this._options.password,headers:a},k,function(a,d){c&&c(a,d)})}else c&&c(Error("build control url error"))}else c&&c(Error("build method error"))}else c&&c(Error("build port error"))}else c&&c(Error("ip is empty"));else c&&c(Error("command is empty"))};b.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};
b.prototype._getMethod=function(){return this._deviceInfo?this._deviceInfo.controlpostdata?"POST":this._deviceInfo.controlurl?"GET":null:null};b.prototype._buildControlUrl=function(a){if(!this._deviceInfo||!this._deviceInfo.controlurl)return null;var c=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlurl);a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);return c.replace("%@",a)};b.prototype._buildPostData=function(a){if(!this._deviceInfo||!this._deviceInfo.controlpostdata)return null;
var c=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlpostdata);a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);return c.replace("%@",a)};b.prototype._buildHttpHeader=function(a){if(!this._deviceInfo||!this._deviceInfo.httpheader)return{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"};a={};var c=xnm.aio.ip.Util._decodeXml(this._deviceInfo.httpheader).split("|");if(c&&0<c.length)for(var d=0;d<c.length;d++){var b=c[d].trim();if(b){var f=b.indexOf(":");
if(-1!=f){var k=b.substr(0,f);b=b.substr(f+1);k&&(a[k]=b)}}}return a};b.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var c=0;c<this._deviceInfo.keys.length;c++){var b=this._deviceInfo.keys[c];if(b.id&&b.id==a)return b.code}return null};b.prototype._doRequest=function(a,c,b){var d={host:a.host,port:a.port,path:a.path,method:a.method,headers:a.headers};a.username&&(a.password||(a.password=""),d.user=a.username,d.password=a.password,d.headers.Authorization=
"Basic "+(new Buffer(a.username+":"+a.password)).toString("base64"));c&&(d.headers["Content-Length"]=c.length);a=require("http").request(d,function(a){a.setEncoding("utf-8");var c="";a.on("data",function(a){c+=a});a.on("end",function(){var d;200!=a.statusCode&&(d=Error("http response:"+a.statusCode));b&&b(d,c)})});if(a.on)a.on("error",function(a){b&&b(a)});c&&a.write(c);a.end()};return b}();
xnm.aio.ip.Tcp=function(){var b=function(a,c){this._options=a;this._deviceInfo=c;this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Tcp")};b.prototype.executeCommandCreator=function(a,c,b){this.executeCommand(c.value,function(a){b&&b(a)})};b.prototype.executeCommand=function(a,c){if(a)if(this._options&&this._options.ip)if(this._getPort())if(a=this._buildTcpData(a)){var b="utf8";switch(this._deviceInfo.tcptype){case "text":case "textnl":case "pioneer":b="utf8";break;case "binary":b="binary",
a=new Buffer(a)}this._doRequest(a,b,function(a){setTimeout(function(){c&&c(a)},150)})}else c&&c(Error("build data return null"));else c&&c(Error("build port error"));else c&&c(Error("ip is empty"));else c&&c(Error("command is empty"))};b.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};b.prototype._buildTcpData=
function(a){if(!this._deviceInfo||!this._deviceInfo.tcptype)return null;a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);switch(this._deviceInfo.tcptype){case "text":return a;case "textnl":case "pioneer":return a+"\r";case "binary":return xnm.aio.ip.Util._hex2arr(a);default:return null}};b.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var c=0;c<this._deviceInfo.keys.length;c++){var b=this._deviceInfo.keys[c];if(b.id&&
b.id==a)return b.code}return null};b.prototype._doRequest=function(a,c,b){var d=this,f={port:this._options.port,host:this._options.ip},k=!1,l=!1,g=b,h=require("net").connect(f);h.setTimeout(1E3);c&&"binary"!=c&&h.setEncoding(c);this._logger.log("trace","try to connect tcp to:"+d._options.ip);h.on("connect",function(){d._logger.log("trace","tcp connected to:"+d._options.ip);d._logger.log("trace","write data:"+a.toString());k=!0;h.write(a,c);l=!0});h.on("data",function(a){d._logger.log("trace","receive from tcp:"+
d._options.ip+" data:"+a);l&&h.end()});h.on("error",function(a){k?(d._logger.log("trace","tcp:"+d._options.ip+" error:"+a.message),h.end()):d._logger.log("trace","tcp:"+d._options.ip+" connection error:"+a.message);g&&(g(a),g=null)});h.on("timeout",function(){k?(d._logger.log("trace","tcp:"+d._options.ip+" data timeout"),h.end(),g&&(g(),g=null)):(d._logger.log("trace","tcp:"+d._options.ip+" connection timeout"),h.end(),g&&(g(Error("connection timeout")),g=null))});h.on("close",function(){d._logger.log("trace",
"tcp:"+d._options.ip+" close socket");g&&(g(),g=null)});h._doConnect&&"function"==typeof h._doConnect&&h._doConnect()};return b}();
xnm.aio.ip.Udp=function(){var b=function(a,c){this._options=a;this._deviceInfo=c;this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Udp")};b.prototype.executeCommandCreator=function(a,c,b){this.executeCommand(c.value,function(a){b&&b(a)})};b.prototype.executeCommand=function(a,c){a?this._options&&this._options.ip?this._getPort()?(a=this._buildUdpData(a))?this._doRequest(new Buffer(a),function(a){c&&c(a)}):c&&c(Error("build data return null")):c&&c(Error("build port error")):c&&c(Error("ip is empty")):
c&&c(Error("command is empty"))};b.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};b.prototype._buildUdpData=function(a){if(!this._deviceInfo||!this._deviceInfo.udptype)return null;a=this._getCommandCode(a);if(!a)return null;a=xnm.aio.ip.Util._decodeXml(a);switch(this._deviceInfo.udptype){case "text":return a;
case "textnl":return a+"\r";case "binary":return xnm.aio.ip.Util._hex2arr(a);default:return null}};b.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var c=0;c<this._deviceInfo.keys.length;c++){var b=this._deviceInfo.keys[c];if(b.id&&b.id==a)return b.code}return null};b.prototype._doRequest=function(a,c){var b=require("dgram").createSocket("udp4");b.send(a,0,a.length,this._options.port,this._options.ip,function(a){b.close();c&&c(a)})};return b}();
xnm.aio.ip._Proxy=function(){var b=function(a,c){this._options=a;this._deviceInfo=c;this._logger=require("x.logger.js").getLogger("xnm.aio.ip._Proxy")};b.prototype.executeCommandCreator=function(a,c,b){this.executeCommand(c.value,function(a){b&&b(a)})};b.prototype.executeCommand=function(a,c){a?this._options&&this._options.ip?this._getPort()?(a=this._buildData(a))?this._doRequest(a,function(a){c&&c(a)}):c&&c(Error("build data return null")):c&&c(Error("build port error")):c&&c(Error("ip is empty")):
c&&c(Error("command is empty"))};b.prototype._getPort=function(){if(this._options&&this._options.port&&0<this._options.port)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var a=parseInt(this._deviceInfo.controlport);return 0>=a?0:a};b.prototype._buildData=function(a){return this._deviceInfo?(a=this._getCommandCode(a))?xnm.aio.ip.Util._decodeXml(a):null:null};b.prototype._getCommandCode=function(a){if(!a||!this._deviceInfo||!this._deviceInfo.keys)return null;
for(var c=0;c<this._deviceInfo.keys.length;c++){var b=this._deviceInfo.keys[c];if(b.id&&b.id==a)return b.code}return null};b.prototype._doRequest=function(a,c){if("samsung_tv"==this._deviceInfo.id){var b=require("xnm.aio.samsung.js").SamsungTV;b=new b(this._options.ip,this._getPort());b._executeCommand(a,function(a){c&&c(a)})}else this._deviceInfo.ircccontrolurl?(new (require("xnm.aio.sony.js").IRCC)(this._options.ip,this._getPort(),this._deviceInfo.ircccontrolurl))._executeCommand(a,function(a){c&&
c(a)}):this._deviceInfo.pnccontrolurl?(b=require("xnm.aio.panasonic.js").TV,b=new b(this._options.ip,this._getPort(),this._deviceInfo.pnccontrolurl),b._executeCommand(a,function(a){c&&c(a)})):"onkyo"==this._deviceInfo.tcptype?(new (require("xnm.aio.onkyo.js").AVReceiver)(this._options.ip,this._getPort())).executeCommand(a,function(a){c&&c(a)}):"lgav"==this._deviceInfo.tcptype?(b=require("xnm.aio.lg.js").BDP,b=new b(this._options.ip,this._getPort()),b._executeCommand(a,function(a){c&&c(a)})):"panasonicbdp"==
this._deviceInfo.tcptype?(b=require("xnm.aio.panasonic.js").BDP,b=new b(this._options.ip,this._getPort()),b._executeCommand(a,function(a){c&&c(a)})):"lgtv"==this._deviceInfo.tcptype?(b=require("xnm.aio.lg.js"),b="lgtv2012"==this._deviceInfo.id?b.TV2012:b.TV,b=new b(this._options.ip,this._getPort(),this._options.authKey),b._executeCommand(a,function(a){c&&c(a)})):"philips2011"==this._deviceInfo.tcptype?(b=require("xnm.aio.philips.js").JointSpaceTV,b=new b(this._options.ip,this._getPort()),b._executeCommand(a,
function(a){c&&c(a)})):c&&c(Error("unknow ip device proxy type"))};return b}();xnm.aio.ip.Util=function(){return{_decodeXml:function(b){return b.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")},_hex2arr:function(b){for(var a=[];2<=b.length;)a.push(parseInt(b.substring(0,2),16)),b=b.substring(2,b.length);return a}}}();
xnm.aio.ip.DM=function(){var b=function(a,c){this.code=a;this.message=c;this.stack=Error().stack};b.prototype=Error();b.prototype.name="IpDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"ip",getIPDeviceType:function(a,c){c=[];if(a&&(a=a.getDevices()))for(var b=0;b<a.length;b++){var e=a[b],f=$(e).getAttributes();if(f&&f.id&&f.name){var k=this._deviceinfoXml2Json($(e)),l=this.getDeviceInfoType(k);l&&(e={sys:this.SYS,
type:l,id:f.id,name:f.name,port:f.controlport},"proxy"==l&&!f.controlport&&(f=this._getProxyDeviceClass(k))&&(f=new f,e.port=f.port),c.push(e))}}return c},createDevice:function(a,c,d){c=b.ERROR_CODE;a?a.type?a.id?a.ip?d(null,a):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,"id is invalid")):d(new b(c.INVALID,"type is invalid")):d(new b(c.INVALID,"info is invalid"))},updateDevice:function(a,c,d){c=b.ERROR_CODE;a?a.type?a.id?a.ip?d(null,a):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,
"id is invalid")):d(new b(c.INVALID,"type is invalid")):d(new b(c.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var c=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&
(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},k=function(a,b){var c=[],e=xnm.aio.ip.DM.getCommandStatusMap(a,d);e&&(a=f(e,a,b),c=c.concat(a));return c};if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=k(a,b);l.command=g;break;case "status":g=k(a,b);l.status=g;break;default:return null}return g&&0!=g.length?l:null},getDeviceInfo:function(a,b){if(!a.id||!b)return null;var c;(a=b.find('device[id="'+a.id+'"]'))&&0<a.length&&(c=a[0]);c=c?$(c):
null;return c?this._deviceinfoXml2Json(c):null},getDeviceInfoType:function(a){if("samsung_tv"==a.id||a.ircccontrolurl||a.pnccontrolurl)return"proxy";if(a.tcptype){if("text"==a.tcptype||"textnl"==a.tcptype||"pioneer"==a.tcptype||"binary"==a.tcptype)return"tcp";if("generic"!=a.tcptype)return"proxy"}return a.udptype?"udp":a.controlurl?"http":null},getCommandStatusMap:function(a,b){a=this.getDeviceInfo(a,b);if(!a)return null;b={command:[]};if(a.keys)for(var c=0;c<a.keys.length;c++){var e=a.keys[c];b.command.push({type:"enum",
name:e.id,ref:{value:e.id}})}return b},_getProxyDeviceClass:function(a){var b=null;"samsung_tv"==a.id?b=require("xnm.aio.samsung.js").SamsungTV:a.ircccontrolurl?b=require("xnm.aio.sony.js").IRCC:a.pnccontrolurl?b=require("xnm.aio.panasonic.js").TV:"onkyo"==a.tcptype?b=require("xnm.aio.onkyo.js").AVReceiver:"lgav"==a.tcptype?b=require("xnm.aio.lg.js").BDP:"panasonicbdp"==a.tcptype?b=require("xnm.aio.panasonic.js").BDP:"lgtv"==a.tcptype?b=require("xnm.aio.lg.js").TV:"philips2011"==a.tcptype&&(b=require("xnm.aio.philips.js").JointSpaceTV);
return b},_deviceinfoXml2Json:function(a){var b=a.getAttributes();b=JSON.parse(JSON.stringify(b));a=a.children();for(var d=0;d<a.length;d++){var e=a[d];if(e){var f=$(e).attr("id");e=$(e).attr("code");f&&e&&(b.keys||(b.keys=[]),b.keys.push({id:f,code:e}))}}return b}}}();
xnm.aio.ip.Handler=function(){var b=function(){};b.prototype.devicemanager=xnm.aio.ip.DM;b.prototype.Http=xnm.aio.ip.Http;b.prototype.Tcp=xnm.aio.ip.Tcp;b.prototype.Udp=xnm.aio.ip.Udp;b.prototype.registModule=function(a){a.register(xnm.aio.ip.DM.SYS,"ip")};b.prototype.resolveDevice=function(a,b){b=xnm.aio.ip.DM.getDeviceInfo(a,b);if(!b)return null;switch(xnm.aio.ip.DM.getDeviceInfoType(b)){case "http":return new xnm.aio.ip.Http(a,b);case "tcp":return new xnm.aio.ip.Tcp(a,b);case "udp":return new xnm.aio.ip.Udp(a,
b);case "proxy":return new xnm.aio.ip._Proxy(a,b);default:return null}};b.prototype.getDeviceCommands=function(a,b){a=(a=xnm.aio.cams.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};return b}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ip.Handler);
