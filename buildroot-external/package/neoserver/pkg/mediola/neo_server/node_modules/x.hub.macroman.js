var x=x||{};x.hub=x.hub||{};x.hub.macroman=x.hub.macroman||{};
x.hub.macroman.MacroManager=function(a,e){a=function(b,c){this._logger=require("x.logger.js").getLogger("x.hub.macroman.MacroManager");this._handler=this._tenant=null;this._folder=b;this._folder||(this._folder="db");this._tenantIdx=c;this._tenantIdx||(this._tenantIdx=1)};a.prototype.init=function(b,c){this._logger.log("info","init macro managaer:"+this._folder);var d=require("m.aio.configmanager.js"),a=require("m.aio.macromanager.js");b=this._generateTenantParent(b);this._tenant=new d.Tenant(b);this._tenant.index=
this._tenantIdx;this._tenant.license="dummy";this._tenant.folder=this._folder;this._handler=new a.Handler(this._tenant);var e=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){e._load(c)})};a.prototype.execute=function(b,c,d,a,e){this._handler.execute(b,c,d,a,e)};a.prototype.reload=function(b){this._load(b)};a.prototype._load=function(b){var c=this;this._handler._loadMacros(function(d){d&&c._logger.log("warn","init macro error:"+d.message);b&&b(d)})};a.prototype._generateTenantParent=
function(b){return{fileManager:b,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};a.prototype.findMacro=function(b,c,d){this._handler.findMacro(b,c,d)};a.prototype.findMacroIdx=function(b,c,d){this._handler.findMacroIdx(b,c,d)};return a}();x.hub.macroman.Handler=function(){this.macroManager=new x.hub.macroman.MacroManager("db",1);this.macroManager2=new x.hub.macroman.MacroManager("db2",2)};x.hub.macroman.Handler.prototype.MacroManager=x.hub.macroman.MacroManager;
x.hub.macroman.Handler.prototype.init=function(a,e,b){"CA"==global.HARDWARE_VERSION?this._configNew(a):this._config(a);var c=this;this.macroManager.init(e,function(){c.macroManager2.init(e,b)})};
x.hub.macroman.Handler.prototype._configNew=function(a){var e=this;require("x.hub.js").getServer().addRoute("/xhub/macromanager/",function(b,c){var d=b.method.toLowerCase();b.path.substr(19);var a=b.url,g=a.indexOf("?");-1!=g&&(a=a.substr(0,g));g=b.query;b=b.body;var f=null;switch(d){case "get":f="read";break;case "post":f="create";break;case "put":f="update";break;case "delete":f="delete"}f?e.macroManager.execute(f,a,g,b,function(b,a){b?c.send(this.error2json(b)):a.toJSON&&"function"==typeof a.toJSON?
c.send(a.toJSON()):c.send(a)}.bind(this)):(d=Error("invalid http method"),d.code=500,c.send(this.error2json(d)))}.bind(this))};
x.hub.macroman.Handler.prototype._config=function(a){var e=this;a.use("/xhub/macromanager/:tenantIdx",function(b,a){var d=b.method.toLowerCase(),c=b.url,g=c.indexOf("?");-1!=g&&(c=c.substr(0,g));g=b.query;b=b.body;var f=null;switch(d){case "get":f="read";break;case "post":f="create";break;case "put":f="update";break;case "delete":f="delete"}f?e.macroManager.execute(f,c,g,b,function(b,c){b?a.send(this.error2json(b)):c.toJSON&&"function"==typeof c.toJSON?a.send(c.toJSON()):a.send(c)}.bind(this)):(d=
Error("invalid http method"),d.code=500,a.send(this.error2json(d)))}.bind(this))};x.hub.macroman.Handler.prototype.execute=function(a,e,b,c){this.macroManager.findMacro(a,e,function(a,e){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler.executeMacro(e,function(a){b&&b(a)},c)})};x.hub.macroman.Handler.prototype.cancel=function(a,e){require("x.hub.commandman.js").commandHandler.cancelMacro(a,function(b){e&&e(b)})};
x.hub.macroman.Handler.prototype.executeWithIdx=function(a,e,b){this.macroManager.findMacroIdx(a,e,function(a,d){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler.executeMacro(d,function(a){b&&b(a)})})};x.hub.macroman.Handler.prototype.execute2=function(a,e,b){this.macroManager2.findMacro(a,e,function(a,d){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler2.executeMacro(d,function(a){b&&b(a)})})};
x.hub.macroman.Handler.prototype.executeWithIdx2=function(a,e,b){this.macroManager2.findMacroIdx(a,e,function(a,d){a?b&&b({error:a}):require("x.hub.commandman.js").commandHandler2.executeMacro(d,function(a){b&&b(a)})})};module.exports=new x.hub.macroman.Handler;
