var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rademacher=xnm.aio.rademacher||{};
xnm.aio.rademacher.Util={clearHttpOptionForLog:function(a){try{var b=JSON.parse(JSON.stringify(a));b.auth&&(b.auth="xxxxxx:xxxxxx");if(b.headers)for(var c in headers)if(c&&"authorization"==c.toLocaleLowerCase()){var d=headers[c];if(d){var f=d.indexOf(" ");headers[c]=-1==f?"xxxxxx":d.substr(0,f)+" xxxxxx"}}return b}catch(e){return a}}};
xnm.aio.rademacher.HomePilot=function(a,b,c,d,f){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot");this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._uid=f;this._inRemoteMode=!1;this.CommandHandler=null};xnm.aio.rademacher.HomePilot.prototype.enableRemoteMode=function(a){this._inRemoteMode=a};
xnm.aio.rademacher.HomePilot.prototype._doRequest=function(a,b){var c=this.ip,d=this.port,f="/rest2/Index?do="+a,e=require("http");this._inRemoteMode&&(e=require("https"),c="www.homepilot.de",d=443,f="/uid/"+this._uid+"/rest2/Index?do="+a);"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");a={host:c,port:d,path:f,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};
this._inRemoteMode&&this._user&&this._password&&(a.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));var h=this;this._logger.log("trace","send http req:"+JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(a)));var g=e.request(a,function(c){h._logger.log("trace","receive http rsp status code:"+c.statusCode);if(200==c.statusCode){c.setEncoding("utf-8");var a="";c.on("data",function(b){a+=b});c.on("end",function(){h._logger.log("trace","receive http rsp:"+
a);var c=JSON.parse(a);b&&b(c)})}else 403==c.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),b&&b(null)});g.setTimeout(6E3,function(){h._logger.log("trace","send http req timeout");g.abort()});g.on("error",function(c){h._logger.log("trace","send http req err:"+c.message);b&&b(null)});g.end()};
xnm.aio.rademacher.HomePilot.prototype.getDevices=function(a){var b={};this._doRequest("/devices",function(c){if(c&&"ok"==c.status)for(var d=0;d<c.devices.length;d++){var f=c.devices[d],e={};e.name=f.name;e.type=f.deviceGroup;e.info=f.description;e.state=f.statusesMap;b[f.did]=e}else b=null;a(b)})};
xnm.aio.rademacher.HomePilot.prototype.getMeters=function(a){var b={},c=[],d=this;this._doRequest("/meters",function(f){if(f&&"ok"==f.status&&f.meters){for(var e=0;e<f.meters.length;e++){var h=f.meters[e];h&&h.did&&c.push(h.did)}0==c.length&&a&&a(null);var g=0;for(f=0;f<c.length;f++)d.getMeter(c[f],function(e){g+=1;if(e&&e.meter&&e.data){var f=d._resolveMeterType(e.data);e.meter.did&&f&&(b[e.meter.did]={name:e.meter.name,address:e.meter.did,type:f,data:e.data})}g==c.length&&a&&a(b)})}else a&&a(null)})};
xnm.aio.rademacher.HomePilot.prototype.getMeter=function(a,b){a?this._doRequest("/meters/"+a,function(c){c&&"ok"==c.status&&c.meter&&c.data?b&&b(c):b&&b(null)}):b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterType=function(a){for(var b={},c=0;c<a.length;c++)for(var d=a[c],f=Object.keys(d),e=0;e<f.length;e++)b[f[e]]=d[f[e]];return b["Schlie\u00dfer"]?"contact":"sensor"};
xnm.aio.rademacher.HomePilot.prototype.getStates=function(a,b,c){if(b&&0!=b.length){var d=this;this.CommandHandler=a;this.getDevices(function(a){if(a&&d.CommandHandler)if(b&&d.CommandHandler.setState)for(var e=0;e<b.length;e++){var f=b[e],g;if(a[f.address]&&(g=a[f.address].state)){var k=d.getStateValues(a[f.address].type,g),l;for(l in k)"state"==l?d.CommandHandler.setState(f.id,k[l]):d.CommandHandler.setState(f.id+":"+l,k[l])}}else if(d.CommandHandler.receivedState)for(e in a)d.CommandHandler.receivedState("hp",
e,a[e].state);c&&c(null)})}else c&&c(null)};
xnm.aio.rademacher.HomePilot.prototype.executeCommand=function(a,b,c){var d=this;"on"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):"off"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):"up"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=1",c):"down"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=2",c):"stop"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=3",c):"dimUp"==b?this._doRequest("/devices/"+a.address+"?do=use&cmd=23",c):"dimDown"==b?this._doRequest("/devices/"+
a.address+"?do=use&cmd=24",c):"toggle"==b?this._doRequest("/devices/"+a.address,function(b){b&&"ok"==b.status&&b.device?0<b.device.statusesMap.Position?d._doRequest("/devices/"+a.address+"?do=use&cmd=11",c):d._doRequest("/devices/"+a.address+"?do=use&cmd=10",c):c&&c()}):("string"==typeof b&&0==b.indexOf("dimTo")&&(b=b.replace(/dimTo/g,"")),"string"==typeof b&&0==b.indexOf("moveTo")&&(b=b.replace(/moveTo/g,"")),"string"==typeof b&&(b=b.replace(/%/g,"")),this._doRequest("/devices/"+a.address+"?do=use&cmd=9&pos="+
b,c))};xnm.aio.rademacher.HomePilot.prototype.getStateValues=function(a,b){var c={};1==a?100==b.Position?c.state="on":0==b.Position&&(c.state="off"):c.state=b.Position;c.manu=b.Manuellbetrieb;return c};xnm.aio.rademacher.Kodi=function(a,b,c,d){this.ip=a;this.port=80;b&&(this.port=b);this._user=c;this._password=d;this._inRemoteMode=!1;this.CommandHandler=null};
xnm.aio.rademacher.Kodi.prototype._doRequest=function(a,b,c){var d={jsonrpc:"2.0",method:a,params:b,id:1};a="/jsonrpc?request="+encodeURI(JSON.stringify(d));a={host:this.ip,port:this.port,path:a,method:"GET",headers:{Connection:"close"}};this._inRemoteMode&&this._user&&this._password&&(a.headers.Authorization="Basic "+(new Buffer(this._user+":"+this._password)).toString("base64"));d=require("http").request(a,function(b){if(200==b.statusCode){b.setEncoding("utf-8");var a="";b.on("data",function(b){a+=
b});b.on("end",function(){var b=JSON.parse(a);c&&c(b)})}else 403==b.statusCode?XC.debugf("UNAUTHORIZED"):XC.debugf("Failed to post request"),c&&c(null)});d.setTimeout(6E3,function(){d.abort()});d.on("error",function(b){c&&c(null)});d.end()};
xnm.aio.rademacher.Kodi.prototype.executeCommand=function(a,b,c){a=null;var d={};"play"==b?(a="Player.PlayPause",d={playerid:0}):"stop"==b?(a="Player.Stop",d={playerid:0}):"previous"==b?(a="Player.GoTo",d={playerid:0,to:"previous"}):"next"==b?(a="Player.GoTo",d={playerid:0,to:"next"}):"left"==b?a="Input.Left":"right"==b?a="Input.Right":"up"==b?a="Input.Up":"down"==b?a="Input.Down":"home"==b?a="Input.Home":"enter"==b?a="Input.Select":"info"==b?a="Input.Info":"back"==b?a="Input.Back":"menu"==b?a="Input.ContextMenu":
"osd"==b?a="Input.ShowOSD":"mute"==b?(a="Application.SetMute",d={mute:"toggle"}):"volumeUp"==b?(a="Application.SetVolume",d={volume:"increment"}):"volumeDown"==b?(a="Application.SetVolume",d={volume:"decrement"}):"shutdown"==b?a="System.Shutdown":"reboot"==b?a="System.Reboot":"suspend"==b?a="System.Suspend":"hibernate"==b&&(a="System.Hibernate");a?this._doRequest(a,d,c):c&&c()};
xnm.aio.rademacher.HomePilot.prototype.executeCommandCreator=function(a,b,c){if(a&&"kodi"==a.type)b&&b.value?(new xnm.aio.rademacher.Kodi(this.ip,a.port,a.username,a.password)).executeCommand(null,b.value,function(){c&&c()}):c&&c(Error("command invalid"));else if(a&&a.address)if(b){var d=b.value;switch(d){case "dimTo":case "moveTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}if("number"==typeof b.ext)d=parseInt(b.ext);else if(b.ext.match(/^[-+]?[0-9]+$/))d=parseInt(b.ext);
else{c&&c(Error("command invalid"));return}break;case "tempTo":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command invalid"));return}d=parseFloat(b.ext);if(isNaN(d)){c&&c(Error("command invalid"));return}d=Math.round(10*d)}this.executeCommand(a,d,function(){c&&c()})}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};
xnm.aio.rademacher.HomePilot.prototype.getStatesCreator=function(a,b,c){if(b){a=[];for(var d=[],f=0;f<b.length;f++){var e=b[f];e.device&&e.device.address&&("contact"==e.device.type||"env"==e.device.type||"smoke"==e.device.type||"sun"==e.device.type?d.push(e):a.push({id:e.id,address:e.device.address}))}var h=0,g=[];this._getMeterStates(d,function(b){h++;b&&(g=g.concat(b));2==h&&c&&(c(null,g),c=null)});this.getStates({setState:function(c,a){var d=c.lastIndexOf(":"),e="state";-1!=d&&d!=c.length-1&&(d=
c.substr(d+1))&&(e=d);for(d=0;d<b.length;d++)if(b[d].id==c&&b[d].status&&b[d].device)switch(b[d].device.type){case "thermo":if("state"==e){var f=parseInt(a);isNaN(f)||(f={id:b[d].id,status:(f/10).toFixed(1)},g.push(f))}break;default:"state"==e&&(f={id:b[d].id,status:a},g.push(f))}}},a,function(){h++;2==h&&c&&(c(null,g),c=null)})}else c&&c(Error("deviceList is null"))};
xnm.aio.rademacher.HomePilot.prototype._getMeterStates=function(a,b){if(a&&0!=a.length){var c=0,d=this,f=[],e;for(e=0;e<a.length;e++)a[e].device&&a[e].device.address&&-1==f.indexOf(a[e].device.address)&&f.push(a[e].device.address);var h={};for(e=0;e<f.length;e++)f[e]&&this.getMeter(f[e],function(e){e&&e.meter&&e.meter.did&&e.data&&(h[e.meter.did]=e.data);c++;if(c==f.length){e=[];for(var g=0;g<a.length;g++)if(a[g].id){var l="?";if(a[g].device&&a[g].device.address&&a[g].device.type&&a[g].status&&a[g].status.value&&
h[a[g].device.address]){var m=d._resolveMeterDatapointState(a[g].device.type,a[g].status.value,h[a[g].device.address]);"undefined"!=typeof m&&null!=m&&(l=m)}e.push({id:a[g].id,status:l})}b&&b(e)}})}else b&&b(null)};xnm.aio.rademacher.HomePilot.prototype._resolveMeterDatapointState=function(a,b,c){return(a=this._resolveMeterStates(a,c))?a[b]:null};
xnm.aio.rademacher.HomePilot.prototype._resolveMeterStates=function(a,b){switch(a){case "contact":return this._resolveContactState(b);case "env":return this._resolveEnvState(b);case "smoke":return this._resolveSmokeState(b);case "sun":return this._resolveSunState(b)}return null};
xnm.aio.rademacher.HomePilot.prototype._resolveEnvState=function(a){var b=null,c;if(a)if(1==a.length)b={},a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envUpdate=c.value);else if(7<=a.length){b={};a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value&&(b.envLum=parseInt(c.value.replace("lx","").trim()));a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.envWindS=parseInt(c.value.replace("m/s","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.envTemp=parseFloat(c.value.replace("\u00b0C",
"").trim()));if(a[3]&&(c=this._resolveKeyValue(a[3]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.envRain="false";break;default:b.envRain="true"}a[4]&&(c=this._resolveKeyValue(a[4]))&&c.value&&(b.envSunH=parseInt(c.value.replace("\u00b0","").trim()));if(a[5]&&(c=this._resolveKeyValue(a[5]))&&c.value){var d=c.value.indexOf("("),f=c.value.indexOf(")");if(-1!=d&&f>d){var e=c.value.substr(0,d);c=c.value.substr(d+1,f-d-1);b.envSunD=parseInt(c.replace("\u00b0",
"").trim());b.envSunDS=e.trim()}}a[6]&&(c=this._resolveKeyValue(a[6]))&&c.value&&(b.envUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveContactState=function(a){var b=null,c;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Closed":case "Geschlossen":case "Ferm\u00e9":case "Gesloten":b.contactState="closed";break;default:b.contactState="open"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.contactBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.contactUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSmokeState=function(a){var b=null,c;if(a&&3<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non d\u00e9tect\u00e9":case "Niet herkend":b.smokeState="ok";break;default:b.smokeState="alarm"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.smokeBat=parseInt(c.value.replace("%","").trim()));a[2]&&(c=this._resolveKeyValue(a[2]))&&c.value&&(b.smokeUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveSunState=function(a){var b=null,c;if(a&&2<=a.length){b={};if(a[0]&&(c=this._resolveKeyValue(a[0]))&&c.value)switch(c.value){case "Not detected":case "Nicht erkannt":case "Non reconnu":case "Niet herkend":b.sunState="no";break;default:b.sunState="yes"}a[1]&&(c=this._resolveKeyValue(a[1]))&&c.value&&(b.sunUpdate=c.value)}return b};
xnm.aio.rademacher.HomePilot.prototype._resolveKeyValue=function(a){for(var b in a)if(a.hasOwnProperty(b))return{key:b,value:a[b]};return null};
xnm.aio.rademacher.HomePilot.prototype.getSensorTypeFromData=function(a){var b=null;if(a&&a[0]&&(a=this._resolveKeyValue(a[0]))&&a.key&&a.value){switch(a.key){case "Closer":case "Schlie\u00dfer":case "Contact normalement ouvert":case "Sluitcontact":b="contact";break;case "Smoke":case "Rauch":case "Fum\u00e9e":case "roken":b="smoke";break;case "Sun":case "Sonne":case "Soleil":case "Zon":b="sun"}-1!=a.value.indexOf("lx")&&(b="env")}return b};
xnm.aio.rademacher.HomePilot.prototype.toJSON=function(){return{sys:"homepilot1",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};xnm.aio.rademacher.HomePilot2=function(a,b,c,d,f){xnm.aio.rademacher.HomePilot.call(this,a,b,c,d,f)};xnm.aio.rademacher.HomePilot2.prototype=xnm.aio.rademacher.HomePilot.prototype;
xnm.aio.rademacher.HomePilot2.constructor=xnm.aio.rademacher.HomePilot2;xnm.aio.rademacher.HomePilot2.prototype.toJSON=function(){return{sys:"homepilot2",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};xnm.aio.rademacher.HomePilot2.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rademacher.HomePilot2?this.ip==a.ip&&this.port==a.port&&this._uid==a._uid:!1};
xnm.aio.rademacher.HomePilot2V5=function(){var a=function(b,c,a,f,e){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot2A");this.ip=b;this.port=80;c&&(this.port=c);this._user=a;this._password=f;this._uid=e;this._communication_token=null;this._loginCBs=[]};a.prototype.executeCommandCreator=function(b,c,a){if(b&&b.address&&"kodi"!=b.type)if(c){switch(c.value){case "dimTo":case "moveTo":case "tempTo":if(null==c.ext||"undefined"==typeof c.ext){a&&a(Error("command invalid"));return}var d=
parseFloat(c.ext);if(isNaN(d)){a&&a(Error("command invalid"));return}}this.executeCommand(b,c,function(b){a&&a(b)})}else a&&a(Error("command invalid"));else a&&a(Error("device invalid"))};a.prototype.getStatesCreator=function(b,a,d){a?this.getStates(function(b,c){if(b)d&&d(b);else{b=[];for(var e=0;e<a.length;e++){var f=a[e];if(f.id&&f.device&&f.device.address&&f.status&&f.status.value){var k=c[f.device.address],l=null;k&&(l=k[f.status.value]);null==l&&(l="?");b.push({id:f.id,status:l})}}d&&d(null,
b)}}):d&&d(Error("deviceList is null"))};a.prototype.executeCommand=function(b,a,d){var c=this;"on"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"TURN_ON_CMD"},d):"off"==a.value?"dimmer"==b.type?this.executeCommand(b,{value:"dimTo",ext:0},d):this._doRestReq("PUT","/devices/"+b.address,{name:"TURN_OFF_CMD"},d):"toggle"==a.value?this.getStates(function(a,f){a?d&&d(a):(a=f[b.address])&&"on"==a.state?c.executeCommand(b,{value:"off"},d):a&&!isNaN(a.state)&&0!=a.state?c.executeCommand(b,{value:"off"},
d):c.executeCommand(b,{value:"on"},d)}):"up"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"POS_UP_CMD"},d):"down"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"POS_DOWN_CMD"},d):"stop"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"STOP_CMD"},d):"dimUp"==a.value||"stepUp"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"INC_CMD"},d):"dimDown"==a.value||"stepDown"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"DEC_CMD"},d):"dimTo"==a.value||
"moveTo"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"GOTO_POS_CMD",value:parseInt(a.ext)},d):"tempTo"==a.value?this._doRestReq("PUT","/devices/"+b.address,{name:"TARGET_TEMPERATURE_CFG",value:parseInt(a.ext)},d):d&&d(Error("unknown command"))};a.prototype.getStates=function(a){var b=this;this._doRestReq("GET","/devices",null,function(c,f){if(c)a&&a(c);else if(f.payload&&f.payload.devices){var d={};f.payload.devices.forEach(function(a){a&&a.capabilities&&(a=b._evalDevice(a))&&a.address&&
a.states&&(d[a.address]=a.states)});a&&a(null,d)}else a&&a(null,[])})};a.prototype.getDevices=function(a){var b=this;this._doRestReq("GET","/devices",null,function(c,f){if(c)a&&a(c);else if(f.payload&&f.payload.devices){var d=[];f.payload.devices.forEach(function(a){a&&a.capabilities&&(a=b._evalDevice(a))&&(delete a.states,d.push(a))});a&&a(null,d)}else a&&a(null,[])})};a.prototype.login=function(a){var b=this._loginCBs.length;a&&-1==this._loginCBs.indexOf(a)&&this._loginCBs.push(a);if(0==b){var d=
this;d._getPasswordSalt(function(b,c){b?a&&a(b):(b=d._encodePassword(c),d._login(b,c,function(b,c){b?a&&a(b):(d._communication_token=c,b=d._loginCBs,d._loginCBs=[],b.forEach(function(a){a&&a()}))}))})}};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.ip==b.ip&&this.port==b.port&&this._user==b._user&&this._password==b._password:!1};a.prototype.toJSON=function(){return{sys:"homepilot2v5",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid}};a.prototype._evalDevice=
function(a){var b={sys:"homepilot2v5",name:null,type:null,address:null,caps:[],states:{}};if(!a||!a.capabilities)return null;for(var d=[],f=0;f<a.capabilities.length;f++){var e=a.capabilities[f];if("NAME_DEVICE_LOC"==e.name)b.name=e.value;else if("ID_DEVICE_LOC"==e.name)b.address=e.value;else if("DEVICE_TYPE_LOC"==e.name)switch(e.value){case "1":b.type="switch";break;case "2":b.type="blind";break;case "3":b.type="sensor";break;case "4":b.type="dimmer";break;case "5":b.type="thermo";break;case "8":b.type=
"gate"}else if("REACHABILITY_EVT"==e.name)b.states.reachable=e.value,-1!=e.timestamp&&(b.states.update=(new Date(1E3*e.timestamp)).toString());else if("CURR_SWITCH_POS_CFG"==e.name)b.states.state="false"==e.value?"off":"on";else if("CURR_POS_CFG"==e.name)b.states.state=parseInt(e.value);else if("TARGET_TEMPERATURE_CFG"==e.name)b.states.state=parseFloat(e.value),b.caps.push(e);else if("BATTERY_LVL_PCT_MEA"==e.name)b.states.battery=parseInt(e.value);else if("BATT_VALUE_EVT"==e.name)b.states.thermoBat=
parseInt(e.value);else if("SMOKE_DETECTION_MEA"==e.name)b.states.smokeState="false"==e.value?"ok":"alarm",-1!=e.timestamp&&(b.states.smokeUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("CLOSE_CONTACT_MEA"==e.name)b.states.contactState="2"==e.value?"tilted":"1"==e.value?"open":"closed",-1!=e.timestamp&&(b.states.contactUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("LIGHT_VAL_LUX_MEA"==e.name)b.states.envLum=parseFloat(e.value),d.push(e.name);else if("WIND_SPEED_MS_MEA"==
e.name)b.states.envWindS=parseFloat(e.value),d.push(e.name);else if("TEMP_CURR_DEG_MEA"==e.name)b.states.envTemp=parseFloat(e.value),d.push(e.name);else if("RAIN_DETECTION_MEA"==e.name)b.states.envRain=e.value,-1!=e.timestamp&&(b.states.envUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name);else if("SUN_DIRECTION_MEA"==e.name){var h=parseFloat(e.value);b.states.envSunD=h;var g=null;22.5>h||337.5<=h?g="N":22.5<=h&&67.5>h?g="NE":67.5<=h&&112.5>h?g="E":112.5<=h&&157.5>h?g="SE":157.5<=h&&202.5>
h?g="S":202.5<=h&&247.5>h?g="SW":247.5<=h&&292.5>h?g="W":292.5<=h&&337.5>h&&(g="NW");b.states.envSunDS=g;d.push(e.name)}else"SUN_HEIGHT_DEG_MEA"==e.name?(b.states.envSunH=parseFloat(e.value),d.push(e.name)):"SUN_DETECTION_MEA"==e.name?(b.states.sunState="false"==e.value?"no":"yes",b.states.envSunS="false"==e.value?"no":"yes",-1!=e.timestamp&&(b.states.sunUpdate=(new Date(1E3*e.timestamp)).toString()),d.push(e.name)):e.name&&d.push(e.name)}if(!b.type||!b.address)return null;"sensor"==b.type&&(-1!=
d.indexOf("CLOSE_CONTACT_MEA")?(b.type="contact","undefined"!=typeof b.states.battery&&null!=b.states.battery&&(b.states.contactBat=b.states.battery)):-1!=d.indexOf("SMOKE_DETECTION_MEA")?(b.type="smoke","undefined"!=typeof b.states.battery&&null!=b.states.battery&&(b.states.smokeBat=b.states.battery),!b.states.smokeUpdate&&b.states.update&&(b.states.smokeUpdate=b.states.update)):-1!=d.indexOf("SUN_DETECTION_MEA")&&-1==d.indexOf("RAIN_DETECTION_MEA")?b.type="sun":-1!=d.indexOf("RAIN_DETECTION_MEA")&&
(b.type="env"));return b};a.prototype._encodePassword=function(a){var b=require("x.crypt.js"),d=b.SHA256(this._password);return b.SHA256(a+d)};a.prototype._getPasswordSalt=function(a){this._doRequest("POST","/authentication/password_salt",null,null,function(b,d,f){if(b)a&&a(b);else{var c=b=null;if(200!=f)if(d)try{(b=JSON.parse(d))&&b.error_description?(c=Error(b.error_description),c.code=b.error_code,a&&a(c)):a&&a(Error("get password salt failed, reponse status code:"+f+", response:"+d))}catch(h){a&&
a(Error("get password salt failed, reponse status code:"+f+", response:"+d))}else a&&a(Error("get password salt failed, reponse status code:"+f));else if(d)try{(b=JSON.parse(d))?"OK"!=b.error_description?(c=Error(b.error_description),c.code=b.error_code,a&&a(c)):b.password_salt?a&&a(null,b.password_salt):a&&a(Error("invalid get password salt response:"+d)):a&&a(Error("invalid get password salt response:"+d))}catch(h){a&&a(Error("invalid get password salt response:"+d))}else a&&a(Error("get password salt response empty"))}})};
a.prototype._login=function(a,c,d){this._doRequest("POST","/authentication/login",null,JSON.stringify({password:a,password_salt:c}),function(a,b,c,g){if(a)d&&d(a);else{var e=a=null;if(200!=c)if(b)try{(a=JSON.parse(b))&&a.error_description?(e=Error(a.error_description),e.code=a.error_code,d&&d(e)):d&&d(Error("login failed, reponse status code:"+c+", response:"+b))}catch(l){d&&d(Error("login failed, reponse status code:"+c+", response:"+b))}else d&&d(Error("login failed, reponse status code:"+c));else g&&
g["set-cookie"]?(b=g["set-cookie"],b.constructor===Array&&(b=b[0]),c=null,g=b.indexOf(";Path="),0==b.indexOf("HPSESSION=")&&0<g&&(c=b.substring(10,g)),d&&d(null,c)):d&&d(Error("login failed, no HPSESSION"))}})};a.prototype._doRestReq=function(a,c,d,f){var b=this;if(!this._communication_token&&this._password)this.login(function(e){e?f&&f(e):b._doRestReq(a,c,d,f)});else{var h=null;this._communication_token&&this._password&&(h={cookie:"HPSESSION="+this._communication_token});var g=null;d&&(g=JSON.stringify(d));
this._doRequest(a,c,h,g,function(e,g,h){if(e)f&&f(e);else if(401==h&&b._password)b._communication_token=null,b._doRestReq(a,c,d,f);else if(200!=h)f&&f(Error("http reqeust faild, response status code:"+h));else if(g)try{var k=JSON.parse(g);if(k)if("OK"!=k.error_description){var l=Error(k.error_description);l.code=k.error_code;f&&f(l)}else f&&f(null,k);else f&&f(Error("invalid http response:"+g))}catch(p){f&&f(Error("invalid http response:"+g))}else f&&f(Error("http response empty"))})}};a.prototype._doRequest=
function(a,c,d,f,e){"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");a={host:this.ip,port:this.port,path:c,method:a,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};if(d)for(var b in d)a.headers[b]=d[b];var g=this;this._logger.log("trace","send http req:"+JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(a)));f&&this._logger.log("trace","with data: "+f);var k=
require("http").request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){g._logger.log("trace","receive http rsp status code:"+a.statusCode);g._logger.log("trace","receive http rsp:"+b);e&&(e(null,b,a.statusCode,a.headers),e=null)})});k.setTimeout(6E3,function(){g._logger.log("trace","send http req timeout");e&&(e(Error("http timeout")),e=null);k.abort()});k.on("error",function(a){g._logger.log("trace","send http req err:"+a.message);e&&(e(a),e=null)});
f&&k.write(f);k.end()};return a}();xnm.aio.rademacher.Handler=function(){};xnm.aio.rademacher.Handler.prototype.HomePilot=xnm.aio.rademacher.HomePilot;xnm.aio.rademacher.Handler.prototype.Kodi=xnm.aio.rademacher.Kodi;xnm.aio.rademacher.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.rademacher.HomePilot).getStateValues(a.type,b)};xnm.aio.rademacher.Handler.prototype.devicemanager=null;
xnm.aio.rademacher.Handler.prototype.registModule=function(a){a.register("homepilot1","rademacher");a.register("homepilot2","rademacher");a.register("homepilot2v5","rademacher")};
xnm.aio.rademacher.Handler.prototype.resolveGateway=function(a){if(!a||!a.ip||!a.sys)return null;switch(a.sys){case "homepilot1":return new xnm.aio.rademacher.HomePilot(a.ip,a.port,a.username,a.password,a.uid);case "homepilot2":return new xnm.aio.rademacher.HomePilot2(a.ip,a.port,a.username,a.password,a.uid);case "homepilot2v5":return new xnm.aio.rademacher.HomePilot2V5(a.ip,a.port,a.username,a.password,a.uid);default:return null}};
xnm.aio.rademacher.Handler.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};xnm.aio.rademacher.Handler.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};xnm.aio.rademacher.Handler.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.doStatus=function(a,b,c,d,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype.discover=function(a,b,c){var d=require("x.mdns.js");d.clearRecordBuffer();"homepilot2v5"==a?d.discoverServiceWithTimeout("_http._tcp.local",b,function(a,b){if(a)c&&c(a);else{for(var d=[],e=0;e<b.length;e++){var f=b[e];f.domain&&f.ip&&0<f.ip.length&&-1!=f.domain.toLowerCase().indexOf("homepilot")&&(f=new xnm.aio.rademacher.HomePilot2V5(f.ip[0]),d.push(f))}c&&c(a,d)}}):d.discoverServiceWithTimeout("_workstation._tcp.local",b,function(b,d){if(b)c&&c(b);else{for(var e=
[],f=0;f<d.length;f++){var k=d[f];k.target&&k.ip&&0<k.ip.length&&-1!=k.target.toLowerCase().indexOf("homepilot")&&(k="homepilot1"==a?new xnm.aio.rademacher.HomePilot(k.ip[0]):new xnm.aio.rademacher.HomePilot2(k.ip[0]),e.push(k))}c&&c(b,e)}})};
xnm.aio.rademacher.Handler.prototype.getDeviceList=function(a,b){var c=this.resolveGateway(a);if(c)if(c instanceof xnm.aio.rademacher.HomePilot2V5)c.getDevices(function(a,c){b&&b(a,c)});else{var d=this,f=!1,e=!1,h=[];c.getDevices(function(a){f=!0;var g;if(a)for(var l in a)a.hasOwnProperty(l)&&(g=d._device2json(c,a[l],l))&&h.push(g);c instanceof xnm.aio.rademacher.HomePilot2&&h.push({sys:"homepilot2",type:"kodi",port:8080});f&&e&&b&&b(null,h)});c.getMeters(function(a){e=!0;var d="homepilot1";c instanceof
xnm.aio.rademacher.HomePilot2&&(d="homepilot2");var g;if(a)for(var m in a)if(a.hasOwnProperty(m)&&(g=a[m])){if(g.data){var n=c.getSensorTypeFromData(g.data);g.type=n?n:"";g.sys=d}h.push(g)}f&&e&&b&&b(null,h)})}else b&&b(Error("gateway json format invalid"))};
xnm.aio.rademacher.Handler.prototype._device2json=function(a,b,c){var d=b.type,f="homepilot1";a instanceof xnm.aio.rademacher.HomePilot2&&(f="homepilot2");switch(d){case 1:d="switch";break;case 3:d="sensor";break;case 2:d="blind";break;case 5:d="thermo";break;case 4:d="dimmer";break;case 8:d="gate";break;default:return null}b.sys=f;b.address=c;b.type=d;return b};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rademacher.Handler);
