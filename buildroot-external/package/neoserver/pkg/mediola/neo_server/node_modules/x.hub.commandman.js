var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(f){var c=0;return function(){return c<f.length?{done:!1,value:f[c++]}:{done:!0}}};$jscomp.arrayIterator=function(f){return{next:$jscomp.arrayIteratorImpl(f)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,c,a){f!=Array.prototype&&f!=Object.prototype&&(f[c]=a.value)};$jscomp.getGlobal=function(f){f=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,f];for(var c=0;c<f.length;++c){var a=f[c];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(f,c){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function f(a){if(this instanceof f)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+c++,a)}var c=0;return f}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.iterator;f||(f=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[f]&&$jscomp.defineProperty(Array.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.asyncIterator;f||(f=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(f){$jscomp.initSymbolIterator();f={next:f};f[$jscomp.global.Symbol.iterator]=function(){return this};return f};
$jscomp.iteratorFromArray=function(f,c){$jscomp.initSymbolIterator();f instanceof String&&(f+="");var a=0,b={next:function(){if(a<f.length){var d=a++;return{value:c(d,f[d]),done:!1}}b.next=function(){return{done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};
$jscomp.polyfill=function(f,c,a,b){if(c){a=$jscomp.global;f=f.split(".");for(b=0;b<f.length-1;b++){var d=f[b];d in a||(a[d]={});a=a[d]}f=f[f.length-1];b=a[f];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(a,f,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.commandman=x.hub.commandman||{};
x.hub.commandman.MacroExecutor=function(){var f=function(c,a,b){this._id=-1;this._commandHandler=c;this._callback=b;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(a&&a.commands){"undefined"!=typeof a.pause&&null!==a.pause&&!isNaN(a.pause)&&0<=a.pause&&(this._pause=Math.max(Math.round(a.pause),1));this._commands=a.commands;c=[];for(a=this._commands.length-1;0<=a;a--)this._commands[a].removed||c.push(this._commands[a]);this._commands=c;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};f.prototype.cancel=function(c){this._canceling=!0;this._cancelCB=c};f.prototype._executeNextCommand=function(c){if(this._canceling){this._canceling=!1;var a=this._cancelCB;this._cancelCB=null;c=this._callback;this._callback=null;a&&a();c&&c(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){a=this._commands.pop();var b=this;if("command"==a.classid){var d=
{cmd:a.action.ref,device:a.action.device};d.cmd||(d.cmd={value:a.action.value});d.cmd&&null!==a.action.ext&&"undefined"!=typeof a.action.ext&&(d.cmd.ext=a.action.ext);a.action.path&&(d.cmd.path=a.action.path);"http_request"==a.action.type?this._commandHandler._doHTTPRequest({url:a.action.value,method:a.action.method,headers:a.action.headers,body:a.action.body},function(){b._executeNextCommand()}):c?this._commandHandler._executeCommand(d,function(){b._executeNextCommand()}):setTimeout(function(){b._commandHandler._executeCommand(d,
function(){b._executeNextCommand()})},b._pause)}else"navigate"==a.classid?(c={type:null},1===a.history?c.type="page_next":-1===a.history?c.type="page_prev":a.page?(c.type="navigate",c.data=a.page):c.type="refresh",b._commandHandler._doAction(c),setTimeout(function(){b._executeNextCommand(!0)},b._pause)):"sleep"==a.classid&&setTimeout(function(){b._executeNextCommand(!0)},a.time)}else this._callback&&this._callback()};return f}();
x.hub.commandman.CommandHandler=function(){var f=function(a){try{var b=JSON.parse(JSON.stringify(a));"undefined"!=typeof b.username&&null!=b.username&&(b.username="xxxxxx");"undefined"!=typeof b.password&&null!=b.password&&(b.password="xxxxxx");return b}catch(d){return a}},c=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=b;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=a;this._deviceManager||(this._deviceManager=
require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};c.prototype.init=function(a,b){this._logger.log("info","init command manager");b&&b()};c.prototype.executeCommandWithRef=function(a,b,c,e,g){var d,h=this._deviceManager;if(a&&b){var l=h.findDevice(a,b);if(!l){g&&g({error:Error("device not found")});return}l.info&&l.info.gateway&&(d=h.findGatewayWithIndex(l.info.gateway))}else if(c){if(d=h.findGateway(c),!d){g&&g({error:Error("gateway not found")});return}}else{g&&g({error:Error("device/gateway reference invalid")});
return}if(l&&l.info){var f=JSON.parse(JSON.stringify(l.info));f.deviceName=b}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));m.gatewayName=c;m.__neoInfo={db:this._id,index:d.index}}this.executeCommand(f,m,e,g)};c.prototype.getStateWithRef=function(a,b,c,e,g){var d,h=this._deviceManager;if(a&&b){var l=h.findDevice(a,b);if(!l){g&&g({error:Error("device not found")});return}l.info&&l.info.gateway&&(d=h.findGatewayWithIndex(l.info.gateway))}else if(c){if(d=h.findGateway(c),!d){g&&g({error:Error("gateway not found")});
return}}else{g&&g({error:Error("device/gateway reference invalid")});return}if(l&&l.info){var f=JSON.parse(JSON.stringify(l.info));f.deviceName=b}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));m.gatewayName=c;m.__neoInfo={db:this._id,index:d.index}}this.getState(f,m,e,g)};c.prototype.executeCommandWithIdx=function(a,b,c,e){var d,k=this._deviceManager;if(a){var h=k.findDeviceWithIndex(a);if(!h){e&&e({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=k.findGatewayWithIndex(h.info.gateway))}else if(b){if(d=
k.findGatewayWithIndex(b),!d){e&&e({error:Error("gateway not found")});return}}else{e&&e({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var l=JSON.parse(JSON.stringify(h.info));l.deviceName=h.name}if(d&&d.info){var f=JSON.parse(JSON.stringify(d.info));f.gatewayName=d.name;f.__neoInfo={db:this._id,index:d.index}}this.executeCommand(l,f,c,e)};c.prototype.getStateWithIdx=function(a,b,c,e,g){if(c&&Array.isArray(c))this.getStatesWithIdx(a,b,c,e,g);else{var d;g=this._deviceManager;
if(a){var h=g.findDeviceWithIndex(a);if(!h){e&&e({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(b){if(d=g.findGatewayWithIndex(b),!d){e&&e({error:Error("gateway not found")});return}}else{e&&e({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var f=JSON.parse(JSON.stringify(h.info));f.deviceName=h.name}if(d&&d.info){var n=JSON.parse(JSON.stringify(d.info));n.gatewayName=d.name;n.__neoInfo={db:this._id,index:d.index}}this.getState(f,
n,c,e)}};c.prototype.getStatesWithIdx=function(a,b,c,e,g){var d;g=this._deviceManager;if(a){var h=g.findDeviceWithIndex(a);if(!h){e&&e({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(b){if(d=g.findGatewayWithIndex(b),!d){e&&e({error:Error("gateway not found")});return}}else{e&&e({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var f=JSON.parse(JSON.stringify(h.info));f.deviceName=h.name}if(d&&d.info){var n=
JSON.parse(JSON.stringify(d.info));n.gatewayName=d.name;n.__neoInfo={db:this._id,index:d.index}}a=[];for(b=0;b<c.length;b++)g=c[b],g.id&&g.value&&a.push({id:g.id,device:f,status:g});this.getMultiStatesLegacy(f,n,a,function(a){if(a.error)e&&e(a);else{var b={data:{}};a.data&&a.data.forEach(function(a){a&&a.id&&(b.data[a.id]=a.status)});e&&e(b)}})};c.prototype.executeCommand=function(a,b,c,e){if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d){if(("aio"==d||"neoserver"==d)&&c&&
"cfOn"==c.value||"cfOff"==c.value){if(!b||!b.__neoInfo||!b.__neoInfo.index){e&&e({});return}if(this._deviceManager.getOwnIdx()==b.__neoInfo.index){e&&e({});return}}if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.executeCommand){var k={};a&&(k=JSON.parse(JSON.stringify(a)));b&&(k.gateway=JSON.parse(JSON.stringify(b)));this._logger.log("trace","do command:"+JSON.stringify(f(a)));this._logger.log("trace","command:"+JSON.stringify(c));d.executeCommand(k,c,e)}else this.executeCommandLegacy(a,
b,c,e)}else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no command")});else e&&e({error:Error("no device or gateway")})};c.prototype.getState=function(a,b,c,e){if(!c||Array.isArray(c))this.getStates(a,b,c,e);else if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d)if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.getState){var k={};a&&(k=JSON.parse(JSON.stringify(a)));b&&(k.gateway=JSON.parse(JSON.stringify(b)));d.getState(k,c.value,function(a){e&&
e(a)})}else this.getStateLegacy(a,b,c,e);else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no command")});else e&&e({error:Error("no device or gateway")})};c.prototype.executeCommandLegacy=function(a,b,c,e){if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d){var k=require("m.aio.modulemanager.js").getModule(d);if(k){var h;b&&(h=k.resolveGateway(b));b=null;var f=this._deviceManager;f&&(b=f.getDeviceInfo());!h&&a&&(h=k.resolveDevice(a,b));h?this._commandHandler.executeCommand(d,
h,a,c,function(b,d){if(a&&"cam"==a.sys&&c&&"snapshot"==c.value&&!b&&d)try{require("x.hub.camman.js").saveSnapshot(a,d,function(){})}catch(p){}e&&e({error:b,data:d})}):e&&e(Error("can not generate host"))}else e&&e({error:Error("no module can handle sys:"+d)})}else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no command")});else e&&e({error:Error("no device or gateway")})};c.prototype.getStateLegacy=function(a,b,c,e){if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=
a.sys);if(d){var k=require("m.aio.modulemanager.js").getModule(d);if(k){var h;b&&(h=k.resolveGateway(b));b=null;var f=this._deviceManager;f&&(b=f.getDeviceInfo());!h&&a&&(h=k.resolveDevice(a,b));h?this._commandHandler.getStates(d,h,[{id:"alias",device:a,status:c}],function(a,b){a?e&&e(a):(a=null,b[0]&&(a=b[0].status),e&&e({data:{value:a}}))}):e&&e({error:Error("can not generate host")})}else e&&e({error:Error("no module can handle sys:"+d)})}else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no status")});
else e&&e({error:Error("no device or gateway")})};c.prototype.getStates=function(a,b,c,e){if(a||b){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d)if((d=require("x.hub.moduleman.js").modulemanager.getModule(d))&&d.updateStates){var k={};a&&(k=JSON.parse(JSON.stringify(a)));b&&(k.gateway=JSON.parse(JSON.stringify(b)));d.updateStates(k,function(a){e&&e(a)},c)}else this.getStatesLegacy(a,b,c,e);else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no device or gateway")})};
c.prototype.getStatesLegacy=function(a,b,c,e){if(a||b){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d){var k=require("m.aio.modulemanager.js").getModule(d);if(k){var h;b&&(h=k.resolveGateway(b));b=null;var f=this._deviceManager;f&&(b=f.getDeviceInfo());!h&&a&&(h=k.resolveDevice(a,b));h?this._commandHandler.getStatesForSingleDevice(d,h,a,c,function(a,b){a?e&&e(a):e&&e({data:b})}):e&&e({error:Error("can not generate host")})}else e&&e({error:Error("no module can handle sys:"+d)})}else e&&
e({error:Error("no sys parameter")})}else e&&e({error:Error("no device or gateway")})};c.prototype.getMultiStatesLegacy=function(a,b,c,e){if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d){var k=require("m.aio.modulemanager.js").getModule(d);if(k){var h;b&&(h=k.resolveGateway(b));b=null;var f=this._deviceManager;f&&(b=f.getDeviceInfo());!h&&a&&(h=k.resolveDevice(a,b));h?this._commandHandler.getStates(d,h,c,function(a,b){a?e&&e(a):e&&e({data:b})}):e&&e({error:Error("can not generate host")})}else e&&
e({error:Error("no module can handle sys:"+d)})}else e&&e({error:Error("no sys parameter")})}else e&&e({error:Error("no device list")});else e&&e({error:Error("no device or gateway")})};c.prototype.execute=function(a,b,c,e,g){this._handler.execute(a,b,c,e,g)};c.prototype._executeCommand=function(a,b){a&&a.device&&a.cmd?a.device.name&&a.device.room?this.executeCommandWithRef(a.device.room,a.device.name,null,a.cmd,b):a.device.name?this.executeCommandWithRef(null,null,a.device.name,a.cmd,b):b&&b({error:Error("cmd object has no valid device")}):
b&&b({error:Error("cmd object format invalid")})};c.prototype._doAction=function(a,b){b&&b({})};c.prototype._doHTTPRequest=function(a,b){var c=null,e="GET",g=null,k=null;"string"===typeof a?c=a:(k=a.body||k,g=a.headers||g,e=a.method||e,c=a.url);a=String(c).toLowerCase();0===a.indexOf("http:")||0===a.indexOf("https:")?(c=require("url").parse(c),a="https:"==c.protocol?require("https"):require("http"),e={host:c.hostname,method:e,path:c.path,port:c.port,protocol:c.protocol},g&&"object"===typeof g&&(e.headers=
g),c.auth&&(e.auth=c.auth),g=a.request(e,function(a){b&&b()}),g.on("error",function(a){XC.debugf(a);b&&b()}),"string"===typeof k&&g.write(k),g.end()):(0<c.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:c}),b&&b())};c.prototype.executeMacro=function(a,b,c){var d=this,g=new x.hub.commandman.MacroExecutor(this,a,function(a){for(var c=-1,e=0;e<d._macroExecutors.length;e++)if(d._macroExecutors[e]==g){c=1;break}-1!=c&&d._macroExecutors.slice(c,1);b&&b({error:a})});
g._id=this._macroExecutors.length+1;this._macroExecutors.push(g);c&&c({id:g._id})};c.prototype.cancelMacro=function(a,b){for(var c=null,e=-1,g=0;g<this._macroExecutors.length;g++){var k=this._macroExecutors[g];if(k&&k._id==a){e=g;c=k;break}}c?(-1!=e&&this._macroExecutors.slice(e,1),c.cancel(function(){b&&b({})})):b&&b()};c.prototype.updateGeneralDeviceStates=function(a,b){var c=this;a||(a=1E4);this._deviceManager.getAllGeneralDevice(function(d,g){if(d)b&&b(d);else if(g&&0!=g.length){var e={};d=[];
for(var f=0;f<g.length;f++){var l=g[f];if(l._origin&&l._origin.info&&l.details&&l.details.states){var n=l._origin;n.states=l.details.states;l._origin.info.gateway?(l=l._origin.info.gateway,e[l]||(e[l]=[]),e[l].push(n)):d.push(n)}}var m=b,p={};g=Object.keys(e);var q=0,r=g.length+d.length;setTimeout(function(){m&&(m(null,p),m=null)},a);g.forEach(function(a){c._updateGeneralGatewayDeviceStates(a,e[a],function(a,b){if(!a&&b)for(var c in b)p[c]=b[c];q++;q==r&&m&&(m(null,p),m=null)})});d.forEach(function(a){c._updateGeneralIPDeviceStats(a,
function(a,b,c){!a&&c&&(p[b]=c);q++;q==r&&m&&(m(null,p),m=null)})})}else b&&b(null,{})})};c.prototype._updateGeneralGatewayDeviceStates=function(a,b,c){var d=this._deviceManager.findGatewayWithIndex(a);if(d)if(d.info){d=JSON.parse(JSON.stringify(d.info));d.__neoInfo={db:this._id,index:a};a=[];for(var g=0;g<b.length;g++){var f=b[g];if(f&&f.info&&f.states)for(var h in f.states)a.push({id:f.index+":"+h,device:f.info,status:f.states[h]})}this._updateGeneralStates(null,d,a,function(a,b){if(a)c&&c(a);else{a=
{};if(b)for(var d=0;d<b.length;d++){var e=b[d];if(e.id){var g=e.id.indexOf(":");if(-1!=g){var f=parseInt(e.id.substr(0,g));if(g=e.id.substr(g+1))a[f]||(a[f]={}),a[f][g]=e.status}}}c&&c(null,a)}})}else c&&c(Error("invalid gateway json"));else c&&c(Error("no such gateway"))};c.prototype._updateGeneralStates=function(a,b,c,e){if(a||b)if(c){var d=null;b&&b.sys&&(d=b.sys);!d&&a&&a.sys&&(d=a.sys);if(d){var f=require("x.hub.moduleman.js").modulemanager.getModule(d);if(f&&f.updateGeneralStates)d={},a&&(d=
JSON.parse(JSON.stringify(a))),b&&(d.gateway=JSON.parse(JSON.stringify(b))),f.updateGeneralStates(deviceJSON,gatewayJSON,c,function(a){e&&e(a)});else if(f=require("m.aio.modulemanager.js").getModule(d)){var h;b&&(h=f.resolveGateway(b));b=null;var l=this._deviceManager;l&&(b=l.getDeviceInfo());!h&&a&&(h=f.resolveDevice(a,b));h?this._commandHandler.getStates(d,h,c,function(a,b){e&&e(a,b)}):e&&e({error:Error("can not generate host")})}else e&&e({error:Error("no module can handle sys:"+d)})}else e&&e({error:Error("no sys parameter")})}else e&&
e({error:Error("no device list")});else e&&e({error:Error("no device or gateway")})};return c}();
x.hub.commandman.CommandHandlerV6=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6")};f.prototype.executeCommandWithCommandInfo=function(c,a,b){if(c)if(c.id)this.executeDeviceCommandWithId(c.id,c,a,b?b.source:null);else if(void 0!=c.rule&&null!=c.rule)this.executeRuleCommandWithId(c.rule,c,a,b);else if(void 0!=c.group&&null!=c.group)this.executeGroupCommandWithId(c.group,c,a,b);else if(void 0!=c.device&&null!=c.device){var d=c.device.mod;
d?"cloud"==d?(d=c.device,this.executeCloudCommand(d,c,a,b?b.source:null)):this.executeDeviceCommandWithJson(c.device,c.device.gateway,c,a):(d=c.device,this.executeCommandMediola(d,c,a,b?b.source:null))}else c.command?this.executeCommandRaw(c,a):c.legacycloudaction?this.executeLegacyCloudAction(c.legacycloudaction,a,b?b.source:null):c.cloudaction?this.executeCloudAction(c.cloudaction,a,b?b.source:null):(c=Error("invalid parameter"),c.code="000005",a&&a(c));else c=Error("invalid parameter"),c.code=
"000005",a&&a(c)};f.prototype.executeCommandRaw=function(c,a){if(c&&c.command){var b="GET";c.value&&(b="POST");var d=require("url").parse(c.command),e=d.pathname;d=d.query;var g={};d&&(g=require("querystring").parse(d));c={method:b,url:c.command,path:e,query:g,body:c.value?JSON.stringify(c.value):null,json:c.value,size:c.value?(new Buffer(JSON.stringify(c.value),"utf8")).length:0,hasValidAuth:!0};this._logger.log("trace","execute command raw "+JSON.stringify(c));var f=this;require("x.hub.js").getServer().doRequest(e,
c,function(b){f._logger.log("trace","execute command raw return:"+JSON.stringify(b));var c=null;if(b)try{(c=JSON.parse(b))&&c.XC_SUC?a&&a(null,c.XC_SUC):c&&c.XC_ERR?a&&a(Error(b)):a&&a(Error(e+" request return invalid format"))}catch(n){a&&a(n)}else a&&a(Error(e+" request return null"))})}else a&&a(Error("invalid command json"))};f.prototype.executeCommandMediola=function(c,a,b){if(c&&(c.id||c.sys))if(a&&(a.command||a.cmd))if(c.id){var d=a.command?a.command:a.cmd,e=a.value;"brightness"==d?d="dimTo":
"position"==d?d="moveTo":"temperature"==d?d="tempTo":"lamella"==d?d="lamellaTo":"mode"!=a||"auto"!=e&&"manu"!=e&&"boost"!=e||("boost"==e?e="boostOn":a=e,e="");c={method:"POST",url:"/cmd",query:{},json:{XC_FNC:"SendGenericCmd",id:c.id,data:{cmd:d,value:e}}};a.source&&(c.json.data.source=a.source);this._logger.log("trace","execute command local directly "+JSON.stringify(c));var g=this;a=require("x.hub.js").getServer();a.doRequest("/cmd",c,function(a){g._logger.log("trace","execute command local directly return:"+
JSON.stringify(a));var c=null;if(a)try{(c=JSON.parse(a))&&c.XC_SUC?b&&b(null,c.XC_SUC):c&&c.XC_ERR?b&&b(Error(a)):b&&b(Error("/cmd request return invalid format"))}catch(l){b&&b(l)}else b&&b(Error("/cmd request return null"))})}else d=a.command?a.command:a.cmd,c=JSON.parse(JSON.stringify(c)),c.type=c.sys,"HM"==c.sys&&("HmIP"==c.address.substr(0,4)&&(c._ver="v5+"),"brightness"==d?d="dimTo":"temperature"==d?d="tempTo":"potition"==d&&(d="moveTo")),(e=require("xnm.aio.gateway.js").devicemanager.getSystem(c))?
(c=e.buildQuery(null,c,{value:d,ext:a.value}),a.source&&(c.source=a.source),c={method:"GET",url:"/cmd?"+require("querystring").stringify(c),path:"/cmd",query:c,body:null,json:null,size:0,hasValidAuth:!0},this._logger.log("trace","execute command mediola "+JSON.stringify(c)),g=this,a=require("x.hub.js").getServer(),a.doRequest("/cmd",c,function(a){g._logger.log("trace","execute command mediola return:"+JSON.stringify(a));var c=null;if(a)try{(c=JSON.parse(a))&&c.XC_SUC?b&&b(null,c.XC_SUC):c&&c.XC_ERR?
b&&b(Error(a)):b&&b(Error("/cmd request return invalid format"))}catch(l){b&&b(l)}else b&&b(Error("/cmd request return null"))})):b&&b(Error("unknown device type"));else b&&b(Error("invalid command json"));else b&&b(Error("invalid device json"))};f.prototype.executeDeviceCommandWithId=function(c,a,b,d){var e=require("x.hub.deviceman.js").deviceManagerV6,g=e.getDevice(c);if(g)if("cloud"==d&&g.restricted)a=Error("invalid parameter"),a.code="000005",b&&b(a);else{d=null;if(g.gateway&&(d=e.getGateway(g.gateway),
!d)){a=Error("invalid parameter");a.code="000005";b&&b(a);return}this.executeDeviceCommandWithJson(g,d,a,function(a){a||e.setBufferedStates(c,null);b&&b(a)})}else a=Error("invalid parameter"),a.code="000005",b&&b(a)};f.prototype.executeDeviceCommandWithJson=function(c,a,b,d){var e=c.mod;a&&a.type&&(e=a.type);"alpha"==e&&(e="moehlenhoff");try{var g=require("x.hub.m."+e+".js");if(g&&g.executeCommandV6)g.executeCommandV6(c,a,b,function(a){a&&(a.code="000000");d&&d(a)});else{var f=Error("invalid parameter");
f.code="000005";d&&d(f)}}catch(h){f=Error("invalid parameter"),f.code="000005",d&&d(f)}};f.prototype.executeRuleCommandWithId=function(c,a,b,d){if(d)if("webserver"==d.source){if(1==d.locked&&0==d.pinMatch){a=Error("access denied (locked)");a.code="000007";b&&b(a);return}}else if("cloud"==d.source&&1==d.locked&&(0==d.pinMatch||0==d.rcs)){a=Error("access denied (locked)");a.code="000007";b&&b(a);return}c?(c=require("x.hub.rule.js").getRuleManager().getRule(c))?c.executeCommand(a,function(a){a&&!a.code&&
(a.code="000005");b&&b(a)}):(a=Error("invalid parameter"),a.code="000005",b&&b(a)):(a=Error("invalid parameter"),a.code="000005",b&&b(a))};f.prototype.executeGroupCommandWithId=function(c,a,b,d){if(c)if(a){var e=require("x.hub.group.js").getGroupManager();e.getGroup(c)?(d&&("webserver"==d.source||"cloud"==d.source)&&b&&(b(),b=null),e.executeGroupCommand(c,a,function(a){a&&!a.code&&(a.code="000005");b&&b(a)})):(c=Error("invalid parameter"),c.code="000005",b&&b(c))}else c=Error("invalid parameter"),
c.code="000005",b&&b(c);else c=Error("invalid parameter"),c.code="000005",b&&b(c)};f.prototype.executeCloudCommand=function(c,a,b,d){this._logger.log("trace","execute cloud device: "+JSON.stringify(c)+" command: "+JSON.stringify(a));d=require("x.hub.js").getServer();if(d.isCloudConnected()){var e=this,g={command:{sys:c.sys,data:c.data,command:a.command}};a.value&&(g.command.value=a.value);d._cloudConnect.sendMessageWithType(g,6,function(d){e._logger.log("trace","execute cloud device: "+JSON.stringify(c)+
" command: "+JSON.stringify(a)+" "+(d?"failed: "+d.message:"success"));b&&b(d)})}else this._logger.log("trace","execute cloud command failed: cloud connection not connected"),b&&b(Error("cloud connection not connected"))};f.prototype.executeLegacyCloudAction=function(c,a,b){this._logger.log("trace","execute legacy cloud action "+c+" from: "+b);var d=null;localStorage&&(d=localStorage.getItem("x.hub.v5.SID"));if(d){var e=parseInt(c,16);b=new Buffer(32);b.writeUInt8(Math.floor(256*Math.random()),0);
var g=Math.round((new Date).getTime()/1E3);b.writeInt32BE(g,1);b.writeUInt8(1,5);b.writeUInt8(1,6);for(g=0;g<d.length/2;g++){var f=d.substr(2*g,2);f=parseInt(f,16);b.writeUInt8(f,g+7)}b=Buffer.concat([b,new Buffer(d,"hex")]);b.writeUInt8(1,23);255<e?(b.writeUInt8(2,5),b.writeUInt8(2,23),b.writeInt16BE(e,24)):b.writeUInt8(e,24);this._logger.log("trace","execute legacy cloud action "+c+" plain buffer: "+b.toString("hex").substr(0,8)+" ...");e=require("crypto");g=new Buffer([42,115,204,166,146,83,35,
244,99,130,213,30,57,56,21,227]);f=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]);d="";e=e.createCipheriv("aes-128-cbc",g,f);e.setAutoPadding(!1);d+=e.update(b,null,"hex");d+=e.final("hex");this._logger.log("trace","execute legacy cloud action "+c+" encrypted: "+d.substr(0,8)+" ...");b=require("x.hub.js").getServer();var h=this;b.isCloudConnected()?(this._logger.log("trace","execute legacy cloud action "+c+" via cloud connection"),b={event:{type:"LEGACYRA",data:d}},require("x.hub.js").server._cloudConnect.sendMessageActive(b,
function(b){h._logger.log("trace","execute legacy cloud action "+c+" via cloud connection "+(b?"failed: "+b.message:"success"));a&&a(b)})):(this._logger.log("trace","execute legacy cloud action "+c+" via http request"),b=b.getCloudServer(),b=require("http").request({host:b,port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},function(b){b.setEncoding("utf8");var d="";b.on("data",function(a){d+=a});b.on("end",function(){h._logger.log("trace",
"execute legacy cloud action "+c+" via http response:"+b.statusCode+" - "+d);var e;200!=b.statusCode&&(e=Error("http request failed with status code:"+b.statusCode));a&&(a(e),a=null)})}),b.setTimeout(5E3,function(){h._logger.log("trace","execute legacy cloud action "+c+" via http timeout");a&&(a(Error("http timeout")),calback=null)}),b.on("error",function(b){h._logger.log("trace","execute legacy cloud action "+c+" via http failed:"+b.message);a&&(a(Error("http error: "+b.message)),calback=null)}),
b.write(new Buffer(d,"hex")),b.end())}else this._logger.log("trace","execute legacy cloud action "+c+" failed: no sid"),a&&a(Error("no sid"))};f.prototype.executeCloudAction=function(c,a,b){this._logger.log("trace","execute cloud action "+c+" from: "+b);b=require("x.hub.js").getServer();if(b.isCloudConnected()){var d=this;b._cloudConnect.sendMessageActive({event:{type:"ACTION",data:c}},function(b){d._logger.log("trace","execute cloud action "+c+" via cloud connection "+(b?"failed: "+b.message:"success"));
a&&a(b)})}else this._logger.log("trace","execute cloud action "+c+" failed: cloud connection not connected"),a&&a(Error("cloud connection not connected"))};f.prototype.getBufferedDeviceStates=function(c){var a=require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();c&&c(null,a)};f.prototype.getDeviceStatesWithStateInfo=function(c,a,b){c?void 0!=c.id&&null!=c.id?this.getDeviceStatesWithId(c.id,a,b):void 0!=c.device&&null!=c.device?c.device.mod?(c=Error("not support get states with "+JSON.stringify(c)),
c.code="000005",a&&a(c)):this.getDeviceStatesMediola(c.device,a,b):void 0!=c.rule&&null!=c.rule?this.getRuleStatesWithId(c.rule,a,b):(c=Error("invalid parameter"),c.code="000005",a&&a(c)):a&&a(Error("state info is null"))};f.prototype.getDeviceStatesMediola=function(c,a,b){if(c&&(c.id||c.sys))if(c.id){b={method:"GET",url:"/cmd?XC_FNC=getStates",query:{XC_FNC:"getStates"}};this._logger.log("trace","get states local directly "+JSON.stringify(b));var d=this;require("x.hub.js").getServer().doRequest("/cmd",
b,function(b){d._logger.log("trace","get states local directly return:"+JSON.stringify(b));var e=null;if(b){try{e=JSON.parse(b)}catch(h){a&&a(h);return}if(e&&e.XC_ERR)a&&a(Error(b));else if(e&&e.XC_SUC){b=e.XC_SUC;for(e=0;e<b.length;e++){var f=b[e];if(f&&f.state&&f.sid==c.id){a&&a(null,f.state);return}}a&&a(null,null)}else a&&a(Error("/cmd request return invalid format"))}else a&&a(Error("/cmd request return null"))})}else a&&a(Error("not support get state for device "+JSON.stringify(c)));else a&&
a(Error("invalid device json"))};f.prototype.getDeviceStatesWithId=function(c,a,b){if(c){var d,e=require("x.hub.deviceman.js").deviceManagerV6;if(d=e.getDevice(c))if("cloud"==b&&d.restricted)d=Error("invalid parameter"),d.code="000005",a&&a(d);else{b=null;if(d.gateway&&(b=e.getGateway(d.gateway),!b)){d=Error("invalid parameter");d.code="000005";a&&a(d);return}this.getDeviceStatesWithJson(d,b,function(b,d){!b&&d&&e.setBufferedStates(c,d);a&&a(b,d)})}else d=Error("invalid parameter"),d.code="000005",
a&&a(d)}else d=Error("invalid parameter"),d.code="000005",a&&a(d)};f.prototype.getDeviceStatesWithJson=function(c,a,b){var d=c.mod;a&&a.type&&(d=a.type);"alpha"==d&&(d="moehlenhoff");try{var e=require("x.hub.m."+d+".js");if(e&&e.getStatesV6)e.getStatesV6(c,a,function(a,c){a&&(a.code="000000");b&&b(a,c)});else{var f=Error("invalid parameter");f.code="000005";b&&b(f)}}catch(k){f=Error("invalid parameter"),f.code="000005",b&&b(f)}};f.prototype.getRuleStatesWithId=function(c,a,b){c?(b=require("x.hub.rule.js").getRuleManager().getRule(c),
b||(c=Error("invalid parameter"),c.code="000005",a&&a(c)),b.getStates(function(b,c){a&&a(b,c)})):(c=Error("invalid parameter"),c.code="000005",a&&a(c))};return f}();
x.hub.commandman.Handler=function(){var f=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2);this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6};f.prototype.CommandHandler=x.hub.commandman.CommandHandler;f.prototype.init=function(c,a){"CA"==global.HARDWARE_VERSION?this._config(c):this._configOld(c);this.commandHandler.init(a)};
f.prototype._config=function(c){var a=this;c=require("x.hub.js").getServer();c.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(b,c){(b=b.json)?a.commandHandler.executeCommand(b.device,b.gateway,b.command,function(b){c.json(a._toRestfulResponse(b.error,"ok"))}):c.json(a._toRestfulResponse({code:"000001",message:"invalid argument"}))});c.addRoute("/xhub/commandman/getState",{method:"POST"},function(b,c){(b=b.json)?a.commandHandler.getState(b.device,b.gateway,b.status,function(b){c.json(a._toRestfulResponse(b.error,
b.data))}):c.json(a._toRestfulResponse({code:"000001",message:"invalid argument"}))});c.addRoute("/api/command",function(b,c){var d=b.json;d||"GET"!=b.method||(d=b.query);a.commandHandlerV6.executeCommandWithCommandInfo(d,function(a){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:{}})},b)});c.addRoute("/api/state",function(b,c){var d=b.json;d||"GET"!=b.method||(d=b.query);a.commandHandlerV6.getDeviceStatesWithStateInfo(d,function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):
c.json({XC_SUC:b})},b.source)});c.addRoute("/api/states",function(b,c){a.commandHandlerV6.getBufferedDeviceStates(function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})})})};f.prototype._configOld=function(c){var a=require("body-parser");c.use("/xhub/commandman",a.json({limit:"50mb"}));c.post("/xhub/commandman/executeCommand",function(a,b){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(a){b.json(this._toRestfulResponse(a.error,"ok"))}.bind(this))}.bind(this));
c.post("/xhub/commandman/getState",function(a,b){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(a){b.json(this._toRestfulResponse(a.error,a.data))}.bind(this))}.bind(this));var b=this;c=require("x.hub.js").getServer();c.addRoute("/api/command",function(a,c){b.commandHandlerV6.executeCommandWithCommandInfo(a.query,function(a){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:{}})},a.source)});c.addRoute("/api/state",function(a,c){b.commandHandlerV6.getDeviceStatesWithId(a.query?
a.query.id:null,function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})},a.source)});c.addRoute("/api/states",function(a,c){b.commandHandlerV6.getBufferedDeviceStates(function(a,b){a?c.json({XC_ERR:{code:a.code,msg:a.message}}):c.json({XC_SUC:b})})})};f.prototype._toRestfulResponse=function(c,a){return c?{status:"fail",message:c.message,code:c.code?c.code:0}:{status:"success",data:a}};return f}();module.exports=new x.hub.commandman.Handler;
