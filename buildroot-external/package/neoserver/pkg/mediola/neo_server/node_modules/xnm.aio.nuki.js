var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.nuki=xnm.aio.nuki||{};
xnm.aio.nuki.SmartLockBridge=function(){var d={0:"uncalibrated",1:"locked",2:"unlocking",3:"unlocked",4:"locking",5:"unlatched",6:"unlocked_lock_n_go",7:"unlatching",254:"motor_blocked",255:"undefined"},a=function(b,c,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.nuki.SmartLock");this.ip=b;this.port=c;this.port||(this.port=8080);this.token=a;this.timeout=5E4};a.prototype.executeCommandCreator=function(b,c,a){if(b&&b.address)if(c&&
c.value){switch(c.value){case "unlock":c=1;break;case "lock":c=2;break;case "unlatch":c=3;break;case "lockGo":c=4;break;case "lockGoUnlatch":c=5;break;default:a&&a(Error("no such command"));return}this._lockAction(b.address,c,0,a)}else a&&a(Error("command json format invalid"));else a&&a(Error("device json format invalid"))};a.prototype.getStatesCreator=function(b,a,f){this.getLocalStates(function(b,c){b=[];for(var e=0;e<a.length;e++)if(a[e]&&a[e].id){var d="?";if(c&&a[e].status&&a[e].status.value&&
a[e].device&&a[e].device.address){var k=a[e].status.value,m=a[e].device.address;c[m]&&(d=c[m][k],"undefined"==typeof d||null==d)&&(d="?")}b.push({id:a[e].id,status:d})}f&&f(null,b)})};a.prototype.getLocalStates=function(a){var b=this;this._list(function(c,e){if(c)a&&a(c);else{c={};for(var f=0;f<e.length;f++){var d=e[f];if(d.nukiId&&d.lastKnownState){var g=b._toState(d.lastKnownState);g&&(c[d.nukiId]=g)}}a&&a(null,c)}})};a.prototype.getDevices=function(a){this._list(function(b,f){if(b)a&&a(b);else{b=
[];for(var c=0;c<f.length;c++){var d=f[c];d.nukiId&&d.name&&b.push({sys:"nuki",type:"smartlock",address:d.nukiId,name:d.name})}a&&a(null,b)}})};a.prototype._toState=function(a){var b={};b.state=d[a.state];b.lowbat=a.batteryCritical;b.stateCode=a.state;b.stateName=a.stateName;return b};a.prototype._lockAction=function(a,c,d,e){this._doLocalRequest("/lockAction",{token:this.token,nukiId:a,action:c,noWait:d},function(a,b,c){a?(401==parseInt(b)?(a=Error("invalid token"),a.code=1E3):400==parseInt(b)?(a=
Error("invalid action"),a.code=1003):404==parseInt(b)?(a=Error("unknown smart lock"),a.code=1001):503==parseInt(b)&&(a=Error("smart lock offline"),a.code=1002),e&&e(a)):e&&e(null,c)})};a.prototype._lockState=function(a,c){this._doLocalRequest("/lockState",{token:this.token,nukiId:a},function(a,b,d){a?(401==parseInt(b)?(a=Error("invalid token"),a.code=1E3):404==parseInt(b)?(a=Error("unknown smart lock"),a.code=1001):503==parseInt(b)&&(a=Error("smart lock offline"),a.code=1002),c&&c(a)):c&&c(null,d)})};
a.prototype._list=function(a){this._doLocalRequest("/list",{token:this.token},function(b,d,e){b?(401==parseInt(d)&&(b=Error("invalid token"),b.code=1E3),a&&a(b)):a&&a(null,e)})};a.prototype._doLocalRequest=function(a,c,d){var b=this,f=a="http://"+this.ip+":"+this.port+a;if(c){var l=[],g=[],n;for(n in c)if(c.hasOwnProperty(n)){var m=n+"=",p=c[n];"undefined"!=typeof p&&null!=p&&(m+=encodeURIComponent(p));l.push(m);"token"!=n?g.push(m):g.push("token=xxxxxx")}a+="?"+l.join("&");f+="?"+g.join("&")}this._logger.log("trace",
"send get to url:"+f);var h=d;$.ajax({url:a,type:"GET",timeout:this.timeout,dataType:"text",cache:!0,success:function(a){b._logger.log("trace","http request success:"+a);try{var c=JSON.parse(a);h&&(h(null,200,c),h=null)}catch(q){h&&(h(q,200),h=null)}},error:function(a,c){c="http request error:"+(a?a.status:"0")+"-"+c;b._logger.log("trace",c);h&&(h(Error(c),a?a.status:"0"),h=null)}})};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.ip===b.ip&&this.port===b.port&&this.token===b.token:
!1};return a}();
xnm.aio.nuki.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="NukiDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"nuki",MAP:{command:[{type:"enum",name:"unlock",ref:{value:"unlock"}},{type:"enum",name:"lock",ref:{value:"lock"}},{type:"enum",name:"unlatch",ref:{value:"unlatch"}},{type:"enum",name:"lock 'n' go",ref:{value:"lockGo"}},{type:"enum",
name:"lock 'n' go with unlatch",ref:{value:"lockGoUnlatch"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:"uncalibrated locked unlocking unlocked locking unlatched unlocked_lock_n_go unlatching motor_blocked undefined".split(" ")}},{type:"enum",name:"low battery",ref:{value:"lowbat",options:["true","false"]}}]},getGatewayType:function(){return[{sys:this.SYS,name:"NUKI Bridge",port:8080}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}]},createGateway:function(a,
b,c){b=d.ERROR_CODE;a?a.ip?a.token?c(null,a):c(new d(b.INVALID,"token is invalid")):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,b,c,f){a=d.ERROR_CODE;b?b.ip?b.token?f(null,b):f(new d(a.INVALID,"token is invalid")):f(new d(a.INVALID,"ip is invalid")):f(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var f=d.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=
b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var k=b[e];break}k?c(null,a):c(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new d(f.INVALID,"address is invalid"));else c(new d(f.INVALID,"gateway is invalid"));else c(new d(f.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var f=d.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=
b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var k=b[e];break}k?c(null,a):c(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new d(f.INVALID,"address is invalid"));else c(new d(f.INVALID,"gateway is invalid"));else c(new d(f.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=
0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},k=function(a,b){var d=[],f=c.getCommandStatusMap(a);f&&(a=e(f,a,b),d=d.concat(a));return d};if(!a||null==a.type||"undefined"==typeof a.type)return null;
var l=JSON.parse(JSON.stringify(a)),g=null;switch(b.catagory){case "command":g=k(a,b);l.command=g;break;case "status":g=k(a,b);l.status=g;break;default:return null}return g&&0!=g.length?l:null},getCommandStatusMap:function(a){return this.MAP}}}();
xnm.aio.nuki.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.nuki.DM;d.prototype.SmartLockBridge=xnm.aio.nuki.SmartLockBridge;d.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"nuki")};d.prototype.resolveGateway=function(a){return a&&a.ip?new this.SmartLockBridge(a.ip,a.port,a.token):null};d.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=
function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(a,b,c,d,e){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};d.prototype.getDeviceList=
function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(a,d){b&&b(a,d)}):b&&b(Error("gateway json format invalid"))};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.nuki.Handler);
