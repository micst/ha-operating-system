var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var d=0;return function(){return d<e.length?{done:!1,value:e[d++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,d,f){e!=Array.prototype&&e!=Object.prototype&&(e[d]=f.value)};$jscomp.getGlobal=function(e){e=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,e];for(var d=0;d<e.length;++d){var f=e[d];if(f&&f.Math==Math)return f}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,d){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:d})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(f){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(f||"")+"_"+d++,f)}var d=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,d){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var f=0,h={next:function(){if(f<e.length){var g=f++;return{value:d(g,e[g]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};
$jscomp.polyfill=function(e,d,f,h){if(d){f=$jscomp.global;e=e.split(".");for(h=0;h<e.length-1;h++){var g=e[h];g in f||(f[g]={});f=f[g]}e=e[e.length-1];h=f[e];d=d(h);d!=h&&null!=d&&$jscomp.defineProperty(f,e,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.values",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(d,f){return f})}},"es8","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.digitalstrom=xnm.aio.digitalstrom||{};
xnm.aio.digitalstrom.Server=function(){var e={0:"Broadcast",1:"Light",2:"Shading",3:"Heating",4:"Audio",5:"Video",6:"Security",7:"Access",8:"Joker",9:"Cooling",10:"Room ventilation",11:"Window",12:"Recirculation",48:"Temperature control",64:"Apartment ventilation"},d={0:"Preset 0",1:"Area 1 Off",2:"Area 2 Off",3:"Area 3 Off",4:"Area 4 Off",5:"Preset 1",6:"Area 1 On",7:"Area 2 On",8:"Area 3 On",9:"Area 4 On",10:"Area Stepping Continue",11:"Decrement",12:"Increment",13:"Minimum",14:"Maximum",15:"Stop",
17:"Preset 2",18:"Preset 3",19:"Preset 4",20:"Preset 12",21:"Preset 13",22:"Preset 14",23:"Preset 22",24:"Preset 23",25:"Preset 24",26:"Preset 32",27:"Preset 33",28:"Preset 34",29:"Preset 42",30:"Preset 43",31:"Preset 44",32:"Preset 10",33:"Preset 11",34:"Preset 20",35:"Preset 21",36:"Preset 30",37:"Preset 31",38:"Preset 40",39:"Preset 41",40:"Auto Off",41:"Impulse",42:"Area 1 Decrement",43:"Area 1 Increment",44:"Area 2 Decrement",45:"Area 2 Increment",46:"Area 3 Decrement",47:"Area 3 Increment",
48:"Area 4 Decrement",49:"Area 4 Increment",50:"Device Off",51:"Device On",52:"Area 1 Stop",53:"Area 2 Stop",54:"Area 3 Stop",55:"Area 4 Stop",56:"Sun protection"},f={64:"Auto Standby",65:"Panic",67:"Standby",68:"Deep Off",69:"Sleeping",70:"Wakeup",71:"Present",72:"Absent",73:"Door Bell",74:"Alarm",75:"Zone Active",76:"Fire",77:"Smoke",78:"Water",79:"Gas",80:"Bell 2",81:"Bell 3",82:"Bell 4",83:"Alarm 2",84:"Alarm 3",85:"Alarm 4",86:"Wind",87:"No Wind",88:"Rain",89:"No Rain",90:"Hail",91:"No Hail"},
h=function(a){this._server=a};h.prototype._requestApplicationToken=function(a,b){this._doSystemRequest("requestApplicationToken",{applicationName:a},function(c,a){c?b&&b(c):b&&b(null,a.applicationToken)})};h.prototype._login=function(a,b,c){this._doSystemRequest("login",{user:a,password:b},function(b,a){b?c&&c(b):c&&c(null,a.token)})};h.prototype._enableToken=function(a,b,c){this._doSystemRequest("enableToken",{applicationToken:a,token:b},function(b){c&&c(b)})};h.prototype._loginApplication=function(a,
b){a?this._doSystemRequest("loginApplication",{loginToken:a},function(c,a){c?b&&b(c):b&&b(null,a.token)}):b&&b(Error("loginToken is empty"))};h.prototype._doSystemRequest=function(a,b,c){this._server._doJsonRequest("/system/"+a,b,function(b,a){b?c&&c(b):c&&c(null,a)})};var g=function(a){this._server=a};g.prototype._getName=function(a){this._doApartmentRequest("getName",null,function(b,c){b?a&&a(b):c?a&&a(null,c.name):a&&a(Error("apartment getName result invalid"))})};g.prototype._getSensorValues=
function(a){this._doApartmentRequest("getSensorValues",null,function(b,c){b?a&&a(b):c?a&&a(null,c):a&&a(Error("apartment getSensorValues result invalid"))})};g.prototype._getTemperatureControlStatus=function(a){this._doApartmentRequest("getTemperatureControlStatus",null,function(b,c){b?a&&a(b):c?a&&a(null,c):a&&a(Error("apartment getTemperatureControlStatus result invalid"))})};g.prototype._getStructure=function(a){this._doApartmentRequest("getStructure",null,function(b,c){b?a&&a(b):a&&a(null,c)})};
g.prototype._callScene=function(a,b){a?"undefined"==typeof a.sceneNumber||null==a.sceneNumber?b&&b(Error("sceneNumber invalid")):this._doApartmentRequest("callScene",a,function(c,a){c?b&&b(c):b&&b(null,a)}):b&&b(Error("params invalid"))};g.prototype._doApartmentRequest=function(a,b,c){this._server._doJsonRequest("/apartment/"+a,b,function(b,a){b?c&&c(b):c&&c(null,a)})};var k=function(a){this._server=a};k.prototype._getReachableScenes=function(a,b,c){"undefined"==typeof a||null==a?c&&c(Error("id invalid")):
"undefined"==typeof b||null==b?c&&c(Error("groupID invalid")):this._doZoneRequest("getReachableScenes",{id:a,groupID:b},c)};k.prototype._callScene=function(a,b,c){b?"undefined"==typeof b.sceneNumber||null==b.sceneNumber?c&&c(Error("sceneNumber invalid")):"undefined"==typeof a||null==a?c&&c(Error("id invalid")):(b.id=a,this._doZoneRequest("callScene",b,c)):c&&c(Error("params invalid"))};k.prototype._doZoneRequest=function(a,b,c){this._server._doJsonRequest("/zone/"+a,b,function(b,a){b?c&&c(b):c&&c(null,
a)})};var n=function(a){this._server=a};n.prototype._turnOn=function(a,b){this._doDeviceRequest("turnOn",a,b)};n.prototype._turnOff=function(a,b){this._doDeviceRequest("turnOff",a,b)};n.prototype._increaseValue=function(a,b){this._doDeviceRequest("increaseValue",a,b)};n.prototype._decreaseValue=function(a,b){this._doDeviceRequest("decreaseValue",a,b)};n.prototype._callScene=function(a,b){a?"undefined"==typeof a.sceneNumber||null==a.sceneNumber?b&&b(Error("sceneNumber invalid")):this._doDeviceRequest("callScene",
a,b):b&&b(Error("params invalid"))};n.prototype._doDeviceRequest=function(a,b,c){b?"undefined"!=typeof b.dsid&&null!=b.dsid||b.name?this._server._doJsonRequest("/device/"+a,b,function(b,a){b?c&&c(b):c&&c(null,a)}):c&&c(Error("no dsid or name")):c&&c(Error("params invalid"))};var l=function(a){this._server=a};l.prototype._getMeters=function(a){this._query("/apartment/dSMeters/*(*)",function(b,c){b?a&&a(b):(b=[],c&&c.dSMeters&&(b=c.dSMeters),a&&a(null,b))})};l.prototype._getUsrEvent=function(a){this._query("/usr/events/*(*)",
function(b,c){b?a&&a(b):(b=[],c&&c.events&&(b=c.events),a&&a(null,b))})};l.prototype._getUsrDefinedStates=function(a){this._query("/usr/addon-states/system-addon-user-defined-states/*(*)",function(b,c){b?a&&a(b):(b=[],c&&c["system-addon-user-defined-states"]&&(b=c["system-addon-user-defined-states"]),a&&a(null,b))})};l.prototype._query=function(a,b){this._doPropertyRequest("query",{query:a},function(c,a){c?b&&b(c):b&&b(null,a)})};l.prototype._query2=function(a,b){this._doPropertyRequest("query2",
{query:a},function(c,a){c?b&&b(c):b&&b(null,a)})};l.prototype._doPropertyRequest=function(a,b,c){this._server._doJsonRequest("/property/"+a,b,function(b,a){b?c&&c(b):c&&c(null,a)})};var p=function(a){this._server=a};p.prototype._raise=function(a,b){a?a.name?this._doEventRequest("raise",a,b):b&&b(Error("name invalid")):b&&b(Error("params invalid"))};p.prototype._doEventRequest=function(a,b,c){b?"undefined"!=typeof b.dsid&&null!=b.dsid||b.name?this._server._doJsonRequest("/event/"+a,b,function(b,a){b?
c&&c(b):c&&c(null,a)}):c&&c(Error("no dsid or name")):c&&c(Error("params invalid"))};var m=function(a,b,c){var d=require("x.logger.js");this._logger=d?d.getLogger("xnm.aio.digitalstrom.Server"):{log:function(){}};this.ip=a;this.port=b;b||(this.port=8080);this.applicationToken=c;this.sessionToken=null;this._getSessionTokenCBs=[];this._system=new h(this);this._apartment=new g(this);this._zone=new k(this);this._device=new n(this);this._property=new l(this);this._event=new p(this)};m.HEAT_CONTROL_MODE=
["off","pid_control","zone_follower","fixed_value","manual"];m.HEAT_OP_MODE="off comfort economy not_used night holiday cooling cooling_off".split(" ");m.prototype._doRequest=function(a,b,c){a||(a="/");b||(b={});this.sessionToken&&(b.token=this.sessionToken);if(b){a+="?";for(var d in b)a+=d+"="+encodeURI(b[d])+"&"}"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");a={host:this.ip,port:this.port,path:a,method:"GET",headers:{"Content-Type":'text/html; charset="UTF-8"',
"Content-Length":0,Connection:"close",rejectUnauthorized:!1,requestCert:!0}};var f=this;this._logger.log("trace","do https request:"+JSON.stringify(a));a=require("https").request(a,function(b){b.setEncoding("utf-8");var a="";b.on("data",function(b){a+=b});b.on("end",function(){f._logger.log("trace","receive https response:"+a+" with code:"+b.statusCode);c&&c(null,a,b.statusCode);c=null})});a.on("error",function(b){f._logger.log("warn","do https request error:"+b.message);c&&c(b);c=null});a.setTimeout(1E4,
function(){f._logger.log("warn","do https request timeout");var b=Error("timeout");b.reason="timeout";c&&c(b);c=null});a.end()};m.prototype._doJsonRequest=function(a,b,c){var d=this,f=a;f||(f="/");this._doRequest("/json"+f,b,function(f,e,g){if(f)c&&c(f);else if(403==g)d.getSessionToken(function(f){f?c&&c(f):d._doJsonRequest(a,b,c)});else try{var h=JSON.parse(e);h.ok?c&&c(null,h.result):c&&c(Error("json response error:"+h.message))}catch(y){c&&c(y)}})};m.prototype._getReachableScenes=function(a,b){var c=
null,d=0,f=this,e=function(g,h){!g&&h&&(c||(c={}),c[a[d].zoneID+"."+a[d].groupID]=h);d++;d>=a.length?b&&b(null,c):f._zone._getReachableScenes(a[d].zoneID,a[d].groupID,e)};this._zone._getReachableScenes(a[d].zoneID,a[d].groupID,e)};m.prototype.getSessionToken=function(a){if(this.applicationToken){var b=this._getSessionTokenCBs.length;a&&-1==this._getSessionTokenCBs.indexOf(a)&&this._getSessionTokenCBs.push(a);if(0==b){var c=this;this._system._loginApplication(this.applicationToken,function(b,d){if(b)a&&
a(b);else{c.sessionToken=d;b=c._getSessionTokenCBs;c._getSessionTokenCBs=[];for(var f=0;f<b.length;f++)b[f](null,d)}})}}else a&&a(Error("applicationToken is empty"))};m.prototype.getDevices=function(a){var b=this,c={apartment:null};this._apartment._getName(function(d,f){if(d)a&&a(d);else{f||(f="Apartment");c.apartment={type:"apartment",name:f,meters:[],devices:[],zones:[],events:[],uds:[]};var g=0,h=function(b){g++;b?(a&&a(b),a=null):4==g&&(a&&a(null,c),a=null)};b._apartment._getTemperatureControlStatus(function(a,
d){b._apartment._getSensorValues(function(a,f){!a&&f&&f.outdoor&&(c.apartment.outdoor=f.outdoor);b._apartment._getStructure(function(a,g){if(a)h(a);else{a=[];if(g&&g.apartment&&g.apartment.zones)for(var m=0;m<g.apartment.zones.length;m++)for(var k=g.apartment.zones[m],n=0;n<k.groups.length;n++){var t=k.groups[n];0!=t.id&&0<t.devices.length&&a.push({zoneID:k.id,groupID:t.id})}b._getReachableScenes(a,function(b,a){if(b)h(b);else{if(g&&g.apartment&&g.apartment.zones)for(b=0;b<g.apartment.zones.length;b++){var m=
g.apartment.zones[b],k={type:"zone",zoneID:m.id,name:m.name,groups:[]},q;a:{if(f&&f.zones)for(q=0;q<f.zones.length;q++){var n=f.zones[q];if(n&&n.id==m.id){q=n.values;break a}}q=null}q&&(k.sensorValues=q);a:{n=m.id;var t=d;if(t&&t.zones)for(var p=0;p<t.zones.length;p++)if((q=t.zones[p])&&q.id==n&&0!=q.IsConfigured){n=[];for(var r in q)"ControlMode"!=r&&"OperationMode"!=r&&"TemperatureValue"!=r&&"NominalValue"!=r&&"ControlValue"!=r||n.push(r);q=n;break a}q=null}q&&(k.heating=q);if(0==m.id)for(m.name||
(k.name="All Devices"),q=0;q<m.devices.length;q++)n=m.devices[q],c.apartment.devices.push({type:"device",name:n.name,dsid:n.id,zoneID:n.zoneID,groups:n.groups});for(q=0;q<m.groups.length;q++){var l=m.groups[q];if(0!=l.id&&l.applicationType&&0<l.devices.length){n=e[l.id];t=m.id;p=l.id;var z=l.applicationType;var v=a?(v=a[m.id+"."+l.id])?v.reachableScenes:null:null;if(a)if((l=a[m.id+"."+l.id])&&l.userSceneNames){for(var w=null,x=0;x<l.userSceneNames.length;x++){var u=l.userSceneNames[x];u&&u.sceneNr&&
u.sceneName&&(w||(w={}),w[u.sceneNr]=u.sceneName)}l=w}else l=null;else l=null;k.groups.push({type:"group",name:n,zoneID:t,groupID:p,applicationType:z,reachableScenes:v,sceneNames:l})}}c.apartment.zones.push(k)}h()}})}})})});b._property._getMeters(function(b,a){if(b)h(b);else{if(a)for(b=0;b<a.length;b++)a[b].dSID&&c.apartment.meters.push({type:"meter",name:a[b].name,dsid:a[b].dSID});h()}});b._property._getUsrEvent(function(b,a){if(b)h(b);else{if(a)for(b=0;b<a.length;b++)a[b].id&&c.apartment.events.push({type:"event",
name:a[b].name,id:a[b].id});h()}});b._property._getUsrDefinedStates(function(b,a){if(b)h(b);else{if(a)for(b=0;b<a.length;b++)a[b].name&&c.apartment.uds.push({type:"uds",name:a[b].displayName,id:a[b].name,setName:a[b].setName,resetName:a[b].resetName});h()}})}})};m.prototype.registApplication=function(a,b,c){var d=this;this._system._requestApplicationToken("mediola",function(f,g){f?c&&c(f):d._system._login(a,b,function(b,a){b?c&&c(b):d._system._enableToken(g,a,function(b){c&&c(b,g)})})})};m.prototype.executeCommand=
function(a,b,c){if(a&&a.type)if(b&&b.value)switch(a.type){case "apartment":switch(b.value){case "callScene":b=parseInt(b.ext);if(isNaN(b)||0>b||128<b){c&&c(Error("scene number invalid"));return}this._apartment._callScene({sceneNumber:b},c);break;default:c&&c(Error("unknown command:"+b.value))}break;case "zone":switch(b.value){case "callScene":b=parseInt(b.ext);if(isNaN(b)||0>b||128<b){c&&c(Error("scene number invalid"));return}this._zone._callScene(a.zoneID,{sceneNumber:b},c);break;default:c&&c(Error("unknown command:"+
b.value))}break;case "group":switch(b.value){case "callScene":b=parseInt(b.ext);if(isNaN(b)||0>b||128<b){c&&c(Error("scene number invalid"));return}this._zone._callScene(a.zoneID,{groupID:a.groupID,sceneNumber:b},c);break;default:c&&c(Error("unknown command:"+b.value))}break;case "device":switch(b.value){case "callScene":b=parseInt(b.ext);if(isNaN(b)||0>b||128<b){c&&c(Error("scene number invalid"));return}this._device._callScene({dsid:a.dsid,sceneNumber:b},c);break;case "turnOn":this._device._turnOn({dsid:a.dsid},
c);break;case "turnOff":this._device._turnOff({dsid:a.dsid},c);break;case "decreaseValue":this._device._decreaseValue({dsid:a.dsid},c);break;case "increaseValue":this._device._increaseValue({dsid:a.dsid},c);break;default:c&&c(Error("unknown command:"+b.value))}break;case "event":switch(b.value){case "run":if(!a.id){c&&c(Error("device id invalid"));return}this._event._raise({name:"highlevelevent",parameter:"id="+a.id},c);break;default:c&&c(Error("unknown command:"+b.value))}break;default:c&&c(Error("unknown device type:"+
a.type))}else c&&c(Error("command format invalid"));else c&&c(Error("device format invalid"))};m.prototype.executeCommandCreator=function(a,b,c){if(b&&b.value)if(a&&a.type){var g={value:"callScene",ext:0},e=null;if("turnOn"==b.value||"turnOff"==b.value||"increaseValue"==b.value||"decreaseValue"==b.value||"run"==b.value)g.value=b.value;else if("callScene"==b.value){e=parseInt(b.ext);if(isNaN(e)){c&&c(Error("callScene value invalid"));return}g.ext=e}else if("doActivity"==b.value){if(!b.ext){c&&c(Error("doActivity value invalid"));
return}var h=!1,m;for(m in d)if(b.ext==d[m]){e=parseInt(m);h=!0;break}if(!h)for(m in f)if(b.ext==f[m]){e=parseInt(m);h=!0;break}if(!h){c&&c(Error("unknown doActivity:"+b.ext));return}g.ext=e}else if("doScene"==b.value.substr(0,7)){e=parseInt(b.value.substr(7));if(isNaN(e)){c&&c(Error("doScene value invalid"));return}g.ext=e}else{c&&c(Error("unknown command:"+b.value));return}b=null;switch(a.type){case "apartment":case "zone":case "group":case "device":case "event":b=a;break;default:c&&c(Error("unknown device type:"+
a.type))}this.executeCommand(b,g,function(b){c&&c(b)})}else c&&c(Error("device json invalid"));else c&&c(Error("command json invalid"))};m.prototype.getStatesCreator=function(a,b,c){var d=function(b){return b.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&")};if(b)if(0==b.length)c&&c(null,[]);else if(b){var f=[],g={},e={},h={},n={},k=this;this._property._getUsrDefinedStates(function(a,l){if(!a&&l)for(a=0;a<l.length;a++){var p=l[a];p.name&&
(n[p.name]={stateTxt:1==p.value?d(p.setName):d(p.resetName),stateF:1==p.value?parseFloat(p.setName):parseFloat(p.resetName)})}k._property._getMeters(function(a,d){if(!a&&d){var l,p;for(l=0;l<d.length;l++){var r=d[l];r.dSID&&(g[r.dSID]=r)}}k._apartment._getSensorValues(function(a,d){if(!a&&d&&(d.outdoor&&(h=d.outdoor),d.zones))for(l=0;l<d.zones.length;l++)if(a=d.zones[l],e[a.id]={},a.values)for(p=0;p<a.values.length;p++)for(var t in a.values[p])e[a.id][t]=a.values[p][t];k._apartment._getTemperatureControlStatus(function(a,
d){if(!a&&d&&d.zones)for(l=0;l<d.zones.length;l++)a=d.zones[l],e[a.id]||(e[a.id]={}),"undefined"!=typeof a.ControlMode&&null!=a.ControlMode&&(e[a.id].ControlMode=m.HEAT_CONTROL_MODE[a.ControlMode]),"undefined"!=typeof a.OperationMode&&null!=a.OperationMode&&(e[a.id].OperationMode=m.HEAT_OP_MODE[a.OperationMode]),"undefined"!=typeof a.TemperatureValue&&null!=a.TemperatureValue&&(e[a.id].TemperatureValue=a.TemperatureValue),"undefined"!=typeof a.NominalValue&&null!=a.NominalValue&&(e[a.id].NominalValue=
a.NominalValue),"undefined"!=typeof a.ControlValue&&null!=a.ControlValue&&(e[a.id].ControlValue=a.ControlValue);var k;for(l=0;l<b.length;l++)if(b[l]){d=b[l].id;a=b[l].device;var p=b[l].status;if(d&&p&&p.value&&a&&a.type){if("meter"==a.type&&a.dsid)(r=g[a.dsid])&&(k=r[p.value]);else if("uds"==a.type&&a.id)(r=n[a.id])&&(k=r[p.value]);else if("apartment"==a.type){if(r=h[p.value])k=r.value}else"zone"==a.type&&a.zoneID&&(r=e[a.zoneID])&&(k=r[p.value]);if("undefined"==typeof k||null==k)k="?";f.push({id:d,
status:k})}}c&&c(null,f)})})})})}else c&&c(Error("deviceList is null"));else c&&c(Error("deviceList is null"))};m.prototype.toJSON=function(){return{sys:"digitalstrom",ip:this.ip,port:this.port,token:this.applicationToken}};m.prototype.equalsTo=function(a){return a&&a instanceof m?this.ip==a.ip&&this.port==a.port&&this.applicationToken==a.applicationToken:!1};m.GROUP_NAMES=e;m.GROUP_SCENE=d;m.NON_GROUP_SCENE=f;m.GROUP_DEFAULT_SCENES={1:[0,5,17,18,19,40],2:[0,5,15,17,18,19],3:[0,1,2,4,5],4:[0,5,17,
18,19],5:[0,5,17,18,19],9:[6,7,8,10,11],10:[0,5,17,18,19,33,35,36,37],11:[0,5,17,18,19,33,35,36,37],12:[0,5,17,18,19,33,35,36,37],48:[0,1,2,4,5,6,7,8,10,11],64:[0,5,17,18,19,33,35,36,37]};m.GROUP_SPECIAL_SCENE_NAME={1:{0:"Off",40:"Fade Off"},2:{0:"Up",5:"Down"},3:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night"},4:{0:"Off"},5:{0:"Off"},9:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday"},
10:{0:"Off",5:"Level 1",17:"Level 2",18:"Level 3",19:"Level 4",33:"Automatic (air flow intensity)",35:"Auto (louver swing mode)",36:"Boost",37:"Noise Reduction"},48:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday",6:"Cooling Off",7:"Cooling Comfort",8:"Cooling Economy",9:"Cooling Not Used",10:"Cooling Night",11:"Cooling Holiday"}};return m}();
xnm.aio.digitalstrom.DM=function(){var e=function(d,f){this.code=d;this.message=f;this.stack=Error().stack};e.prototype=Error();e.prototype.name="DigitalStromDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"digitalstrom",getGatewayType:function(){return[{sys:this.SYS,name:"digitalSTROM"}]},getGatewayDeviceType:function(){return[]},createGateway:function(d,f,h){f=e.ERROR_CODE;d?d.ip?h(null,d):h(new e(f.INVALID,"ip is invalid")):
h(new e(f.INVALID,"info is invalid"))},updateGateway:function(d,f,h,g){d=e.ERROR_CODE;f?f.ip?f.username?f.password?g(null,f):g(new e(d.INVALID,"password is invalid")):g(new e(d.INVALID,"username is invalid")):g(new e(d.INVALID,"ip is invalid")):g(new e(d.INVALID,"update is invalid"))},deleteGateway:function(d,f,e){e()},createDevice:function(d,f,h){var g=e.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(f.data&&f.data.gateways&&0!==f.data.gateways.length){f=f.data.gateways;var k;for(k=0;k<f.length;k++)if(f[k].index===
d.gateway){var n=f[k];break}n?h(null,d):h(new e(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else h(new e(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else h(new e(g.INVALID,"type is invalid"));else h(new e(g.INVALID,"gateway is invalid"));else h(new e(g.INVALID,"info is invalid"))},updateDevice:function(d,f,h){var g=e.ERROR_CODE;if(d)if(d.gateway)if(d.type)if(f.data&&f.data.gateways&&0!==f.data.gateways.length){f=f.data.gateways;var k;for(k=0;k<f.length;k++)if(f[k].index===
d.gateway){var n=f[k];break}n?h(null,d):h(new e(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else h(new e(g.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else h(new e(g.INVALID,"type is invalid"));else h(new e(g.INVALID,"gateway is invalid"));else h(new e(g.INVALID,"info is invalid"))},deleteDevice:function(d,f,e){e()},applyUIFilter:function(d,f){var e=this,g=function(d,a){if("*"==d)return!0;for(var b=!1,c=0;c<d.length;c++)if(d[c]==a){b=!0;break}return b},k=function(d,a,
b){var c=[];switch(b.catagory){case "command":d.command&&d.command.forEach(function(a){g(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),c.push(a))});break;case "status":d.status&&d.status.forEach(function(a){g(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),c.push(a))})}return c},n=function(d,a){var b=[],c=e.getCommandStatusMap(d);c&&(d=k(c,d,a),b=b.concat(d));return b};if(!d||null==d.type||"undefined"==typeof d.type)return null;var l=JSON.parse(JSON.stringify(d)),p=null;switch(f.catagory){case "command":p=
n(d,f);l.command=p;break;case "status":p=n(d,f);l.status=p;break;default:return null}return p&&0!=p.length?l:null},getCommandStatusMap:function(d){var f=function(){var a=xnm.aio.digitalstrom.Server.GROUP_SCENE,c=[],d;for(d in a)a[d]&&c.push(a[d]);return c},e=function(){var a=xnm.aio.digitalstrom.Server.NON_GROUP_SCENE,c=[],d;for(d in a)a[d]&&c.push(a[d]);return c},g={command:[],status:[]};if(!d||!d.type)return null;if("event"==d.type)return g.command=[{type:"enum",name:"run",ref:{value:"run"}}],g;
if("uds"==d.type)return g.status=[{type:"string",name:"state (string)",ref:{value:"stateTxt"}},{type:"float",name:"state (float)",ref:{value:"stateF"}}],g;switch(d.type){case "apartment":g.command=[{type:"enum",name:"Absent",ref:{value:"doScene72"}},{type:"enum",name:"Present",ref:{value:"doScene71"}},{type:"enum",name:"Door Bell",ref:{value:"doScene73"}},{type:"enum",name:"Rain",ref:{value:"doScene88"}},{type:"enum",name:"No Rain",ref:{value:"doScene89"}},{type:"enum",name:"Wind",ref:{value:"doScene86"}},
{type:"enum",name:"No Wind",ref:{value:"doScene87"}},{type:"enum",name:"Hail",ref:{value:"doScene90"}},{type:"enum",name:"No Wind",ref:{value:"doScene91"}},{type:"enum",name:"Panic",ref:{value:"doScene65"}},{type:"enum",name:"Fire",ref:{value:"doScene76"}},{type:"enum",name:"Alarm 1",ref:{value:"doScene74"}},{type:"enum",name:"Alarm 2",ref:{value:"doScene83"}},{type:"enum",name:"Alarm 3",ref:{value:"doScene84"}},{type:"enum",name:"Alarm 4",ref:{value:"doScene85"}}];break;case "zone":g.command=[{type:"enum",
name:"Standby",ref:{value:"doScene67"}},{type:"enum",name:"Deep off",ref:{value:"doScene68"}},{type:"enum",name:"Sleeping",ref:{value:"doScene69"}},{type:"enum",name:"Wake up",ref:{value:"doScene70"}}];break;case "group":var k=xnm.aio.digitalstrom.Server.GROUP_DEFAULT_SCENES[d.applicationType];k||(k=[]);if(d.reachableScenes)for(var n=0;n<d.reachableScenes.length;n++)-1==k.indexOf(d.reachableScenes[n])&&k.push(d.reachableScenes[n]);if(d.sceneNames)for(var l in d.sceneNames)-1==k.indexOf(parseInt(l))&&
k.push(parseInt(l));for(n=0;n<k.length;n++){var p=k[n],m=null;d.sceneNames&&(m=d.sceneNames[p]);if(!m){var a=xnm.aio.digitalstrom.Server.GROUP_SPECIAL_SCENE_NAME[d.applicationType];a&&(m=a[p])}m||(m=xnm.aio.digitalstrom.Server.GROUP_SCENE[p]);m&&g.command.push({type:"enum",name:m,ref:{value:"doScene"+p}})}break;case "device":if(d.groups)for(k=[],n=0;n<d.groups.length;n++){p=[];switch(d.groups[n]){case 1:p=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}},
{type:"enum",name:"up",ref:{value:"increaseValue"}},{type:"enum",name:"down",ref:{value:"decreaseValue"}}];break;case 2:p=[{type:"enum",name:"move down",ref:{value:"turnOn"}},{type:"enum",name:"move up",ref:{value:"turnOff"}},{type:"enum",name:"step down",ref:{value:"increaseValue"}},{type:"enum",name:"step up",ref:{value:"decreaseValue"}}];break;case 4:p=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}}];break;case 5:p=[{type:"enum",name:"on",ref:{value:"turnOn"}},
{type:"enum",name:"off",ref:{value:"turnOff"}}]}for(m=0;m<p.length;m++)a=p[m],-1==k.indexOf(a.ref.value)&&(g.command.push(a),k.push(a.ref.value))}}switch(d.type){case "apartment":case "zone":f=f();f=f.concat(e());g.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:f}});break;case "group":case "device":f=f(),g.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:f}})}g.command.push({type:"int",name:"call scene",ref:{value:"callScene",
ext:"%d",extMeta:"0-127"}});e=null;switch(d.type){case "apartment":if(d.outdoor)for(l in d.outdoor)switch(l){case "temperature":g.status.push({type:"float",name:"temperature",ref:{value:"temperature"}});break;case "humidity":g.status.push({type:"float",name:"humidity",ref:{value:"humidity"}});break;case "windspeed":g.status.push({type:"float",name:"wind speed",ref:{value:"windspeed"}});break;case "winddirection":g.status.push({type:"float",name:"wind direction",ref:{value:"winddirection"}});break;
case "gustspeed":g.status.push({type:"float",name:"gust speed",ref:{value:"gustspeed"}});break;case "gustdirection":g.status.push({type:"float",name:"gust direction",ref:{value:"gustdirection"}});break;case "precipitation":g.status.push({type:"float",name:"precipitation",ref:{value:"precipitation"}});break;case "airpressure":g.status.push({type:"float",name:"air pressure",ref:{value:"airpressure"}})}break;case "zone":l=!1;if(d.sensorValues)for(n=0;n<d.sensorValues.length;n++)if(e=d.sensorValues[n])"undefined"!=
typeof e.TemperatureValue&&null!=e.TemperatureValue&&(l=!0,g.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}})),"undefined"!=typeof e.HumidityValue&&null!=e.HumidityValue&&g.status.push({type:"float",name:"humidity",ref:{value:"HumidityValue"}}),"undefined"!=typeof e.CO2ConcentrationValue&&null!=e.CO2ConcentrationValue&&g.status.push({type:"float",name:"co2",ref:{value:"CO2ConcentrationValue"}}),"undefined"!=typeof e.BrightnessValue&&null!=e.BrightnessValue&&g.status.push({type:"float",
name:"brightness",ref:{value:"BrightnessValue"}});if(d.heating)for(n=0;n<d.heating.length;n++)switch(e=d.heating[n],e){case "ControlMode":g.status.push({type:"enum",name:"control mode",ref:{value:"ControlMode",options:["off","pid_control","zone_follower","fixed_value","manual"]}});break;case "OperationMode":g.status.push({type:"enum",name:"operation mode",ref:{value:"OperationMode",options:"off comfort economy not_used night holiday cooling cooling_off".split(" ")}});break;case "TemperatureValue":l||
g.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}});break;case "NominalValue":g.status.push({type:"float",name:"target temperature",ref:{value:"NominalValue"}});break;case "ControlValue":g.status.push({type:"float",name:"control value",ref:{value:"ControlValue"}})}break;case "meter":g.status.push({type:"float",name:"power",ref:{value:"powerConsumption",unit:"W"}}),g.status.push({type:"float",name:"energy meter",ref:{value:"energyMeterValue",unit:"Wh"}})}return g}}}();
xnm.aio.digitalstrom.Handler=function(){var e=function(){};e.prototype.Server=xnm.aio.digitalstrom.Server;e.prototype.devicemanager=xnm.aio.digitalstrom.DM;e.prototype.registModule=function(d){d.register(this.devicemanager.SYS,"digitalstrom")};e.prototype.resolveGateway=function(d){return d&&d.ip&&d.token?new this.Server(d.ip,d.port,d.token):null};e.prototype.getDeviceCommands=function(d,e){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"command",elems:"*"}))?d.command:[];e&&e(null,d)};e.prototype.getDeviceStatus=
function(d,e){d=(d=this.devicemanager.applyUIFilter(d,{catagory:"status",elems:"*"}))?d.status:[];e&&e(null,d)};e.prototype.doCommand=function(d,e,h,g){(d=this.resolveGateway(d))?d.executeCommandCreator(e,h,function(d){g&&g(d)}):g&&g(Error("gateway json format invalid"))};e.prototype.doStatus=function(d,e,h,g,k){(e=this.resolveGateway(e))?e.getStatesCreator(null,[{id:d,device:h,status:g}],function(d,e){d?k&&k(d):k&&k(null,e[0])}):k&&k(Error("gateway json format invalid"))};e.prototype.getDeviceList=
function(d,e){(d=this.resolveGateway(d))?d.getDevices(function(d,f){e&&e(d,f)}):e&&e(Error("gateway json format invalid"))};e.prototype.discover=function(d,e){var f=require("x.mdns.js");f.clearRecordBuffer();f.discoverServiceWithTimeout("_http._tcp.local",d,function(d,f){if(d)e&&e(d);else{for(var g=[],h=0;h<f.length;h++){var k=f[h];k.target&&k.ip&&0<k.ip.length&&"dss.local"==k.target.toLowerCase()&&(k=new xnm.aio.digitalstrom.Server(k.ip[0],8080),g.push(k))}e&&e(d,g)}})};e.prototype.registApplication=
function(d,e,h,g){if(!d||!d.ip)return null;(new this.Server(d.ip,d.port)).registApplication(e,h,function(d,e){g&&g(d,e)})};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.digitalstrom.Handler);
