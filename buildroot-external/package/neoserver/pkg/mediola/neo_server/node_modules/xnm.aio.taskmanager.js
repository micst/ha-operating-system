var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c};
$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Object.is",function(a){return a?a:function(a,c){return a===c?0!==a||1/a===1/c:a!==a&&c!==c}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(a){return a?a:function(a,c){var b=this;b instanceof String&&(b=String(b));var e=b.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var h=b[c];if(h===a||Object.is(h,a))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(a,b,c){if(null==a)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return a+""};$jscomp.polyfill("String.prototype.includes",function(a){return a?a:function(a,c){return-1!==$jscomp.checkStringArgs(this,a,"includes").indexOf(a,c||0)}},"es6","es3");
$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var h=a[e];if(b.call(c,h,e,a))return{i:e,v:h}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.taskmanager=xnm.aio.taskmanager||{};xnm.aio.taskmanager.Taskmanager=function(){};xnm.aio.taskmanager.Taskmanager.prototype.setCloudService=function(a){this._cloudService=a;this._cloudTM=new require("xnm.aio.cloudTaskmanager");this._cloudTM.setCloudService(a);this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setWebserviceUrl=function(a){this._webServiceUrl=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.setCloudAccessUrl=function(a){this._cloudAccessUrl=a;this._cloudTM&&this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl);return this};xnm.aio.taskmanager.Taskmanager.prototype.setAuth=function(a){this._auth=a;return this};xnm.aio.taskmanager.Taskmanager.prototype.setSystemData=function(a){xnm.aio.taskmanager.SystemData=a;return this};
xnm.aio.taskmanager.Taskmanager.prototype.runTask=function(a,b){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.runVxTask:xnm.aio.taskmanager.runVxProTask)(a,b)};xnm.aio.taskmanager.Taskmanager.prototype.saveTask=function(a,b){xnm.aio.taskmanager.isVx(a.aio)?this.runVxSaving(a,b):this.runVxProSaving(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxSaving=function(a,b){var c=a.root.if.filter(function(a){return a.cloud}),d=a.root.then[0].then.filter(function(a){return a.cloud});a.root.if=a.root.if.filter(function(a){return!a.cloud});a.root.then[0].then=a.root.then[0].then.filter(function(a){return!a.cloud});var e=[];e=[xnm.aio.taskmanager.addVxLocalCloudActions.bind(this,a,d),this.createVxEspActions.bind(this,a),xnm.aio.taskmanager.saveVxTask.bind(this,a,e),this.saveVxSnsData.bind(this,a,e)];xnm.aio.taskmanager.hasCloudDevices()&&
e.push(this._cloudTM.saveVxCloudData.bind(this._cloudTM,a,c,d));(new xnm.aio.taskmanager.FunctionStack(e)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.runVxProSaving=function(a,b){var c=a.root.if.filter(function(a){return a.cloud}),d=a.root.then[0].then.filter(function(a){return a.cloud}),e=xnm.aio.taskmanager.SystemData.getGateways(function(a){return"cloudservice"===a.info.sys})[0];e&&(e.info.__neoIndex=e.index,c.forEach(function(a){a.type="cloud.trigger.device";a.gateway=e.info}),d.forEach(function(a){a.gateway=e.info}));xnm.aio.taskmanager.convertVxProTimespan(a);d=[this.saveVxProSnsData.bind(this,a),
xnm.aio.taskmanager.saveVxProTask.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&d.push(this._cloudTM.saveVxProCloudData.bind(this._cloudTM,a,c));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.deleteTask=function(a,b){var c=xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.deleteVxTask:xnm.aio.taskmanager.deleteVxProTask,d=xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.deleteVxCloudData:this._cloudTM.deleteVxProCloudData;c=[c.bind(this,a)];xnm.aio.taskmanager.hasCloudDevices()&&c.push(d.bind(this._cloudTM,a));xnm.aio.taskmanager.isVx(a.aio)&&c.push(this.deleteEspActions.bind(this,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.setTaskActive=function(a,b,c){(xnm.aio.taskmanager.isVx(a.aio)?xnm.aio.taskmanager.setVxTaskActive:xnm.aio.taskmanager.setVxProTaskActive)(a,b,c)};xnm.aio.taskmanager.Taskmanager.prototype.clear=function(a){xnm.aio.taskmanager.isVx(a)&&xnm.aio.taskmanager.getVxTasks(a,function(b,c){b||c.forEach(function(b){return xnm.aio.taskmanager.deleteVxElement(a,b)})})};
xnm.aio.taskmanager.Taskmanager.prototype.getAllTasks=function(a,b){function c(c){return function(f,m){f||!Array.isArray(m)?l=f||Error("Unknown"):(f=d?xnm.aio.taskmanager.mapVxTasksToPro(c,m):m.map(function(a){a.aio=c;xnm.aio.taskmanager.reconvertVxProTimespan(a);return a}),h=h.concat(f));++g===a.length&&b(l,h)}}if(!Array.isArray(a)||!a.length)return b(Error("invalid params"));var d=xnm.aio.taskmanager.isVx(a[0]),e=d?xnm.aio.taskmanager.getVxTasks:xnm.aio.taskmanager.getVxProTasks,h=[],g=0;a.forEach(function(a){return e(a,
c(a))});var l=null};xnm.aio.taskmanager.getGroups=function(a,b){var c=function(a,b){return b.filter(function(b){return b.group&&b.group.includes(a.sid)}).map(function(a){return a.sid})};a._executeRequest("getStates",{config:1},null,function(a,e){if(a)return b(a);if(!Array.isArray(e))return b(null,[]);a=e.filter(function(a){return"SGROUP"==a.type}).map(function(a){a.devices=c(a,e);return a});b(null,a)})};
xnm.aio.taskmanager.Taskmanager.prototype.markGroupActions=function(a,b){xnm.aio.taskmanager.getGroups(a.aio,function(c,d){c&&b(c);var e=d.map(function(a){return a.sid});a.root.then[0].then.forEach(function(a){a.device&&e.includes(a.device.sid)&&(a.group=d.find(function(b){return b.sid==a.device.sid}),a.subtype="group")});b(null,{})})};
xnm.aio.taskmanager.Taskmanager.prototype.fetchDetailData=function(a,b){var c=[this.unifyStructure.bind(this,a),this.addSnsData.bind(this,a)];xnm.aio.taskmanager.isVx(a.aio)&&c.push(this.addEspActionData.bind(this,a));xnm.aio.taskmanager.hasCloudDevices()&&c.push(this.addCloudData.bind(this,a));xnm.aio.taskmanager.isSelve(a.aio)&&c.push(this.markGroupActions.bind(this,a));(new xnm.aio.taskmanager.FunctionStack(c)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.unifyStructure=function(a,b){a=a.root;a.if||(a.if=[]);a.then||(a.then=[]);a.then[0]||(a.then[0]={if:[],then:[],type:"condition"});if(!a.then[0].then){var c=a.then;delete a.then;a.then=[{if:[],then:c,type:"condition"}]}b(null,{})};xnm.aio.taskmanager.Taskmanager.prototype.addCloudData=function(a,b){return xnm.aio.taskmanager.isVx(a.aio)?this._cloudTM.addVxCloudData(a,b):this._cloudTM.addVxProCloudData(a,b)};
xnm.aio.taskmanager.Taskmanager.prototype.addSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],d=[],e=function(b,c){$.ajax({method:"GET",url:this._webServiceUrl+(b.isVx?"ai2/m.php":"xhub/sns/getsns"),headers:{Authorization:this._auth},data:b.isVx?{XC_FNC:"getMessage",SID:a.aio._sid,AID:b.id}:{token:b.token},success:function(a){b.isVx?(a=a.replace("{XC_SUC}",""),a=JSON.parse(a||"{}"),b.recipients=a.mail,"PUSH"===a.snsType&&(b.subtype="PUSH")):(b.recipients=a.recipients,b.subject=a.subject);b.message=
a.message;b.snsType=a.snsType;"no such action"===b.message&&(b.failed=!0,b.message="");c(null,a)},error:function(a){b.failed=!0;c(null,{})}})};a.root.then[0].then.forEach(function(a){c.includes(a.subtype)&&d.push(e.bind(this,a))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxProSnsData=function(a,b){var c=["EMAIL","PUSH","SMS"],d=[],e=function(a,b){var c=a.message;"string"===typeof c&&(c={subject:"",snsType:a.snsType,message:a.message,recipients:a.recipients});$.ajax({method:"POST",url:this._webServiceUrl+"xhub/sns/setsns",contentType:"application/json; charset=utf-8",headers:{Authorization:this._auth},data:JSON.stringify(c),success:function(c){if(c&&c.error)return b(c,null);a.isVx||(a.token=c.token);b(null,c)},error:function(){a.failed=
!0;b(null,{})}})};a.root.then[0].then.forEach(function(a){c.includes(a.subtype)&&d.push(e.bind(this,a))}.bind(this));(new xnm.aio.taskmanager.FunctionStack(d)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.saveVxSnsData=function(a,b,c){var d=function(b,c){XC.debugf(b);$.ajax({method:"POST",url:this._webServiceUrl+"ai2/m.php?XC_FNC=setMessage&SID="+a.aio._sid+"&AID="+b.id,contentType:"application/x-www-form-urlencoded",headers:{Authorization:this._auth},data:{data:JSON.stringify({sns:"PUSH"===b.snsType?"PUSH":void 0,email:b.recipients,message:b.message})},success:function(a){if(a&&a.error)return c(a,null);c()},error:function(a){b.failed=!0;c(null,{})}})};b=b.map(function(a){return d.bind(this,
a)}.bind(this));(new xnm.aio.taskmanager.FunctionStack(b)).start(c)};
xnm.aio.taskmanager.Taskmanager.prototype.addEspActionData=function(a,b){a.espActionIds=[];a.aio._executeRequest("/api/actions",null,null,function(c,d){a.root.then[0].then.filter(function(a){return a.ipDevice}).forEach(function(b){var c=parseInt(b.code,16);a.espActionIds.push(c);c=d[c]||{};b.ipDevEvent=!0;b.command={ref:{value:c.command,ext:c.value}};b.device={id:c.id,ipDevice:!0};"alarm"==c.command&&(b.type="action",b.subtype="audio")});b()})};
xnm.aio.taskmanager.Taskmanager.prototype.createVxEspActions=function(a,b){var c=this,d=[],e=function(b,c){a.aio._executeRequest("/data/act/"+b,null,{method:"POST"},c)},h=a.espActionIds?a.espActionIds.map(function(a){return e.bind(c,a)}):[],g=function(b,c){var f;a:if(d.length){for(f=1;255>f;f++)if(!d.includes(f))break a;f=void 0}else f=1;d.push(f);b.espId=f;a.aio._executeRequest("/data/act/"+f,{id:b.device.id,command:b.command.ref.value,value:b.command.ref.ext},{method:"POST"},c)},l=a.root.then[0].then.filter(function(a){return"action"===
a.type&&a.device&&"aio"===a.device.sys&&a.device.mod}).map(function(a){return g.bind(c,a)});h=[].concat($jscomp.arrayFromIterable(h),[function(b){a.aio._executeRequest("/api/actions",null,null,function(a,c){if(a||!c)return b("ESP Error");d=Object.keys(c).map(function(a){return parseInt(a)});b(a,c)})}],$jscomp.arrayFromIterable(l));(new xnm.aio.taskmanager.FunctionStack(h)).start(b)};
xnm.aio.taskmanager.Taskmanager.prototype.deleteEspActions=function(a,b){var c=this,d=function(b,c){a.aio._executeRequest("/data/act/"+b,null,{method:"POST"},c)},e=a.root.then[0].then.filter(function(a){return a.ipDevice}).map(function(a){a=parseInt(a.code,16);return d.bind(c,a)});(new xnm.aio.taskmanager.FunctionStack(e)).start(b)};xnm.aio.taskmanager.hasCloudDevices=function(){return 0<xnm.aio.taskmanager.SystemData.getDevices(function(a){return"cloudservice"==a.info.sys}).length};
xnm.aio.taskmanager.mapVxTasksToPro=function(a,b){function c(a,b){try{return d.tasks.find(function(a){return a.id==b}).name}catch(g){return"Task "+b}}var d=xnm.aio.taskmanager.SystemData.getGateways(function(b){return b.info.mac==a._mac})[0];return b.filter(function(a){return"GROUP"==a.sys}).map(function(e){var d={id:e.id,aio:a,root:{},name:c(a,e.id),active:1==e.active,isAlarmTask:"FF"==e.id};d.root.if=[];0<e.triggerids.length&&(d.root.if=e.triggerids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["EVENT",
"SEVENT","TASK","ASTRO"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "EVENT":c="IRCODE"===f.type?{type:"ir",ir:{code:f.code}}:{type:"device.status",device:{type:f.type,address:f.code},status:f.code};break;case "SEVENT":c={type:"device.status",proEvent:!0,device:{sid:f.device},status:f.condition.state,value:f.condition.value,op:f.condition.type};break;case "TASK":c={op:"=",type:"timer",time:f.time,week:f.days,start:f.dateStart,end:f.dateEnd};break;case "ASTRO":c=parseInt(f.delay,
16),0<(c&32768)&&(c-=65536),c={type:"astro",astro:1==f.time?"sunrise":"sunset",delay:c,week:f.days,start:f.dateStart,end:f.dateEnd}}c.id=f.id;c.active=f.active;return c}).filter(function(a){return null!=a}));d.root.then=[{if:[],then:[]}];if(e.conditionids&&0<e.conditionids.length){d.root.then[0].if=e.conditionids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["TIME","SEVENT"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "TIME":c="00:00"===f.start||"00:00"===
f.end?{type:"timer",op:"00:00"===f.start?"<=":">=",time:"00:00"===f.start?f.end:f.start,week:f.days,start:f.dateStart,end:f.dateEnd}:{type:"timespan",startTime:f.start,endTime:f.end,week:f.days,start:f.dateStart,end:f.dateEnd};break;case "SEVENT":c={type:"device.status",proEvent:!0,device:{sid:f.device},status:f.condition.state,value:f.condition.value,op:f.condition.type}}c.id=f.id;c.active=f.active;return c}).filter(function(a){return null!=a});var g=[];d.root.then[0].if.forEach(function(a){g.push(a);
g.push({type:"logic.operator",op:"AND"})});g.pop();d.root.then[0].if=g}0<e.actionids.length&&(d.root.then[0].then=e.actionids.match(/.{1,2}/g).map(function(a){var c={},f=b.find(function(b){return["ACTION","DEVICEACTION"].includes(b.sys)&&b.id==a});if(!f)return null;switch(f.sys){case "DEVICEACTION":c={type:"action",subtype:"command",proEvent:!0,device:{sid:f.device},command:{ref:{ext:f.value,value:f.cmd}},gateway:null};break;case "ACTION":c="RGB"===f.type?{type:"action",subtype:"command",gwRgb:!0,
command:{type:"enum",ref:{value:{"0000":"ledOff","0001":"ledGreen","0002":"ledBlue","0003":"ledRed","0004":"ledYellow","0005":"ledWhite","0006":"ledPurple","0007":"ledCyan"}[f.code]}}}:"CLOUD"===f.type?{type:"CLOUD",internal:!0}:"AIO"===f.type?{type:"action",subtype:"EMAIL",isVx:!0}:"IP"===f.type?{type:"action",subtype:"command",ipDevice:!0,code:f.code}:{type:"action",subtype:"command",device:{type:f.type,address:f.code},command:{ref:{value:f.code}},gateway:null}}c.id=f.id;return c}).filter(function(a){return null!=
a}));return d})};
xnm.aio.taskmanager.mapProTaskToVx=function(a){var b=this,c="",d="",e="",h=a.root.if.filter(function(a){return!a.internal}).map(function(a){var c={};e+=a.id;switch(a.type){case "device.status":c=a.device.proDevice?{sys:"SEVENT",device:a.device.sid,condition:{type:a.op,state:a.status,value:a.value}}:{sys:"EVENT",type:a.device.type,code:a.code};break;case "timer":c={sys:"TASK",days:a.week,time:a.time,dateStart:a.start||"2000-00-00",dateEnd:a.end||"2099-00-00"};break;case "ir":c={sys:"EVENT",type:"IRCODE",
code:a.ir.code};break;case "astro":c=a.delay,0>c&&(c+=65536),c=b.intToStrHex(c,4),c={sys:"ASTRO",active:1,days:a.week,time:"sunrise"===a.astro?1:2,dateStart:a.start,dateEnd:a.end,delay:c,t:"00:00"}}c.id=a.id;c.active="1";return c}),g=a.root.then[0].if.filter(function(a){return!a.internal}).filter(function(a){return"logic.operator"!==a.type}).map(function(a){var b={};d+=a.id;switch(a.type){case "timer":b={sys:"TIME",days:a.week,start:"<="===a.op?"00:00":a.time,end:">="===a.op?"00:00":a.time,dateStart:a.start||
"2000-00-00",dateEnd:a.end||"2099-00-00"};break;case "timespan":b={sys:"TIME",days:a.week,start:a.startTime,end:a.endTime,dateStart:a.start||"2000-00-00",dateEnd:a.end||"2099-00-00"};break;case "device.status":b={sys:"SEVENT",device:a.device.sid,condition:{type:a.op,state:a.status,value:a.value}}}b.id=a.id;b.active="1";return b}),l=a.root.then[0].then.map(function(a){var b={};c+=a.id;switch(a.type){case "CLOUD":b={type:"CLOUD",sys:"ACTION"};break;case "action":"EMAIL"===a.subtype||"PUSH"===a.subtype?
(b={code:"",type:"AIO",sys:"ACTION",snsType:a.subtype},"string"===typeof a.message?(b.message=a.message,b.recipients=a.recipients):(b.message=a.message.message,b.recipients=a.message.recipients)):b=a.gwRgb?{type:"RGB",sys:"ACTION",code:{ledOn:"0005",ledOff:"0000",ledGreen:"0001",ledBlue:"0002",ledRed:"0003",ledYellow:"0004",ledWhite:"0005",ledPurple:"0006",ledCyan:"0007"}[a.command.ref.value]}:a.device.proDevice?{sys:"DEVICEACTION",device:a.device.sid,cmd:a.command.ref.value,value:a.command.ref.ext}:
a.device.ipDevice?{sys:"ACTION",type:"IP",code:xnm.aio.taskmanager.intToStrHex(a.espId)}:{sys:"ACTION",type:a.sys,code:a.command.ref.value}}b.id=a.id;return b});return{group:{id:a.id,sys:"GROUP",actionids:c,conditionids:d,triggerids:e,active:a.active?"1":"0"},actions:l,triggers:h,conditions:g}};
xnm.aio.taskmanager.convertVxProTimespan=function(a){var b=[];a.root.then[0].if.forEach(function(a){if("timespan"!==a.type)return b.push(a);b.push({type:"timer",op:">=",time:a.startTime,week:a.week,start:a.start,end:a.end},{type:"logic.operator",op:"AND"},{type:"timer",op:"<=",time:a.endTime,week:a.week,start:a.start,end:a.end})});a.root.then[0].if=b};
xnm.aio.taskmanager.reconvertVxProTimespan=function(a){for(var b=[],c=a.root.then[0].if||a.root.then[1].if,d=0;d<c.length;d++){var e=c[d];if("timer"!==e.type)b.push(e);else{var h=c[d+1],g=c[d+2];"timer"===e.type&&">="===e.op&&h&&g&&"AND"===h.op&&"timer"===g.type&&"<="===g.op&&e.week===g.week&&e.start===g.start&&e.end===g.end?(b.push({type:"timespan",startTime:e.time,endTime:g.time,week:e.week,start:e.start,end:e.end}),d+=2):b.push(e)}}a.root.then[0].if=b};
xnm.aio.taskmanager.getVxIdList=function(a,b){return a.filter(function(a){return b.includes(a.sys)}).map(function(a){return a.id})};xnm.aio.taskmanager.getNextVxElementId=function(a){if(!a.length)return xnm.aio.taskmanager.intToStrHex(1);for(var b=1;255>b;b++){var c=xnm.aio.taskmanager.intToStrHex(b);if(!a.includes(c))return c}return null};xnm.aio.taskmanager.runVxTask=function(a,b){a.aio._executeRequest("doGroup",{id:a.id},null,b)};
xnm.aio.taskmanager.runVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"doTask",{id:a.id},b)};xnm.aio.taskmanager.getVxTasks=function(a,b){a._executeRequest("GetAll",null,null,function(a,d){b(a,d)})};xnm.aio.taskmanager.getVxProTasks=function(a,b){xnm.aio.taskmanager._callVxPro(a,"GetTask",null,b)};xnm.aio.taskmanager.setVxTaskActive=function(a,b,c){a.aio._executeRequest("SaveGroup",{id:a.id,active:b?1:0},null,c)};
xnm.aio.taskmanager.setVxProTaskActive=function(a,b,c){xnm.aio.taskmanager._callVxPro(a.aio,"SetTaskActive",{id:a.id,active:b},c)};
xnm.aio.taskmanager.saveVxTask=function(a,b,c){function d(a,b,c){XC.debugf("# del elements: "+a);var e=0,d=q[a],h=f[a];if(0===d.length)return c();d.forEach(function(f){var k=m.filter(function(a){return a.id==f&&h.includes(a.sys)})[0];if(!k)return c(Error(a+" not found"));xnm.aio.taskmanager.deleteVxElement(g,k,function(a,f){if(a)return c(a);n[b].splice(n[b].indexOf(k.id),1);++e===d.length&&c()})})}function e(c,f,d){XC.debugf("# add elements: "+c);var e=l[c];if(!e||!e.length)return d();var h=0;e.forEach(function(k){k.id=
xnm.aio.taskmanager.getNextVxElementId(n[f]);p[c]+=k.id;n[f].push(k.id);xnm.aio.taskmanager.addVxElement(g,k,function(c,f){if(c)return XC.debugf(c),d(Error("add element failed"));"ACTION"===k.sys&&"AIO"===k.type&&b.push(k);"ACTION"===k.sys&&"CLOUD"===k.type&&(a._localCloudId=k.id);++h===e.length&&d()})}.bind(this))}function h(b){XC.debugf("# del all");if(!a.id)return b();var c={id:a.id,options:"all"};a.alarmPin&&(c.pin=a.alarmPin);a.aio._executeRequest("DelGroup",c,null,function(c,f){if(c)return a.isAlarmTask?
b({msg:"pin error"}):b(Error("del group failed"));b()})}var g=a.aio,l=xnm.aio.taskmanager.mapProTaskToVx(a),m=null,f={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],triggers:["TASK","ASTRO","EVENT","SEVENT"],conditions:["TIME"]},p={actions:"",triggers:"",conditions:""},n={groups:[],actions:[],triggers:[]},q={actions:[],triggers:[],conditions:[]},r=xnm.aio.taskmanager.hasDeleteAll(a.aio)?[h.bind(this)]:[d.bind(this,"triggers","triggers"),d.bind(this,"conditions","triggers"),d.bind(this,"actions",
"actions")];r=[function(b){function c(a){return a&&a.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(g,function(d,e){if(d)return b(d);m=e;if(a.id){d=e.filter(function(b){return"GROUP"===b.sys&&b.id==a.id})[0];if(!d)return b(Error("group not found"));q.actions=c(d.actionids);q.conditions=c(d.conditionids);q.triggers=c(d.triggerids)}n.groups=xnm.aio.taskmanager.getVxIdList(e,f.groups);n.actions=xnm.aio.taskmanager.getVxIdList(e,f.actions).concat(xnm.aio.taskmanager.getVxIdList(e,
f.conditions));n.triggers=xnm.aio.taskmanager.getVxIdList(e,f.triggers);b()})}].concat($jscomp.arrayFromIterable(r),[e.bind(this,"triggers","triggers"),e.bind(this,"conditions","triggers"),e.bind(this,"actions","actions"),function(b){var c=l.group;c.actionids=p.actions;c.triggerids=p.triggers;c.conditionids=p.conditions;c.id||(c.id=xnm.aio.taskmanager.getNextVxElementId(n.groups));a.id=c.id;var d=xnm.aio.taskmanager.SystemData,e=d.getGateways(function(b){return b.info.mac==a.aio._mac})[0];e.tasks||
(e.tasks=[]);var f=e.tasks.find(function(b){return b.id==a.id});f?f.name=a.name:e.tasks.push({id:a.id,name:a.name});d.saveGateway(e);a.alarmPin&&(c.pin=a.alarmPin);g._executeRequest("AddGroup",c,null,function(c,e){if(c)return a.isAlarmTask?b({msg:"pin error"}):b(Error("save group failed"));b()})}]);try{(new xnm.aio.taskmanager.FunctionStack(r)).start(c)}catch(t){XC.debugf(t)}};
xnm.aio.taskmanager.saveVxProTask=function(a,b){var c={data:a};a.alarmPin&&(c.pin=a.alarmPin);xnm.aio.taskmanager._callVxPro(a.aio,a.id?"UpdateTask":"CreateTask",c,function(c,e){if(c)return b(c,e);e&&e.id&&(a.id=e.id);b(null,e)})};xnm.aio.taskmanager.addVxLocalCloudActions=function(a,b,c){var d=a.root.then[0].then;b.some(function(a){return a.cloud})?d.some(function(a){return"CLOUD"===a.type})||d.push({type:"CLOUD",sys:"ACTION"}):a.root.then[0].then=d.filter(function(a){return"CLOUD"!==a.type});c()};
xnm.aio.taskmanager.deleteVxTask=function(a,b){function c(b,c,f){XC.debugf("# del elements: "+b);var g=0,l=h[b],m=e[b];if(0===l.length)return f();l.forEach(function(b){var c=d.filter(function(a){return a.id==b&&m.includes(a.sys)})[0];if(!c)return f();xnm.aio.taskmanager.deleteVxElement(a.aio,c,function(a,b){if(a)return f(a);++g===l.length&&f()})})}(function(a){var b=xnm.aio.taskmanager.SystemData,c=b.getGateways(function(b){return b.info.mac==a.aio._mac})[0];if(c.tasks){for(var d=c.tasks.length;d--;)c.tasks[d].id==
a.id&&c.tasks.splice(d,1);b.saveGateway(c)}})(a);if(xnm.aio.taskmanager.hasDeleteAll(a.aio))return a.aio._executeRequest("DelGroup",{id:a.id,options:"all"},null,b);var d=null,e={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],conditions:["TIME"],triggers:["TASK","ASTRO","EVENT","SEVENT"]},h={actions:[],triggers:[],conditions:[]},g=[function(b){function c(a){return a&&a.match(/.{1,2}/g)||[]}XC.debugf("# init");xnm.aio.taskmanager.getVxTasks(a.aio,function(e,g){if(e)return b(e);d=g;if(a.id){e=g.filter(function(b){return"GROUP"===
b.sys&&b.id==a.id})[0];if(!e)return b(Error("group not found"));h.actions=c(e.actionids);h.conditions=c(e.conditionids);h.triggers=c(e.triggerids)}b()})},c.bind(this,"triggers","triggers"),c.bind(this,"conditions","triggers"),c.bind(this,"actions","actions"),function(b){a.aio._executeRequest("DelGroup",{id:a.id},null,b)}];(new xnm.aio.taskmanager.FunctionStack(g)).start(b)};xnm.aio.taskmanager.deleteVxProTask=function(a,b){xnm.aio.taskmanager._callVxPro(a.aio,"DeleteTask",{id:a.id},b)};
xnm.aio.taskmanager.addVxElement=function(a,b,c){var d={},e={SEVENT:"SensorEvent",DEVICEACTION:"DeviceAction"};e[b.sys]?(e="Add"+e[b.sys],d.method="POST"):e="Add"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(e,b,d,c)};xnm.aio.taskmanager.deleteVxElement=function(a,b,c){var d={SEVENT:"SensorEvent"};d=d[b.sys]?"Del"+d[b.sys]:"Del"+b.sys.charAt(0).toUpperCase()+b.sys.toLowerCase().slice(1);a._executeRequest(d,{id:b.id},null,c)};
xnm.aio.taskmanager._callVxPro=function(a,b,c,d){(c=JSON.parse(JSON.stringify(c)))||(c={});c.XC_FNC=b;c.at=a._at;c.data&&delete c.data.aio;a.executeRequestV5Plus(c,function(a){if(d){if(!a)return d("error",a);if(a.error)return d(a.error,a);d(null,a.data)}})};xnm.aio.taskmanager.isVx=function(a){return"EA"!==a._hwv};xnm.aio.taskmanager.isSelve=function(a){return"E7"===a._hwv};xnm.aio.taskmanager.hasDeleteAll=function(a){return["e7","c1","c2","c3","c4"].includes(a._hwv.toLowerCase())};
xnm.aio.taskmanager.intToStrHex=function(a,b){b||(b=2);for(a=a.toString(16);a.length<b;)a="0"+a;return a.toUpperCase()};xnm.aio.taskmanager.FunctionStack=function(a){this._stack=a;this._onNext=function(a,c){if(a)return this._callback(a);var b=this._stack.shift();b?b(this._onNext.bind(this)):this._callback(a,c)};this.start=function(a){this._callback=a;this._onNext()}};xnm.aio.taskmanager.Handler=xnm.aio.taskmanager.Taskmanager;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.taskmanager.Handler);
