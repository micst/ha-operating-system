var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(e){var c=0;return function(){return c<e.length?{done:!1,value:e[c++]}:{done:!0}}};$jscomp.arrayIterator=function(e){return{next:$jscomp.arrayIteratorImpl(e)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,c,a){e!=Array.prototype&&e!=Object.prototype&&(e[c]=a.value)};$jscomp.getGlobal=function(e){e=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,e];for(var c=0;c<e.length;++c){var a=e[c];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(e,c){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function e(a){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(a||"")+"_"+c++,a)}var c=0;return e}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.iterator;e||(e=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[e]&&$jscomp.defineProperty(Array.prototype,e,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var e=$jscomp.global.Symbol.asyncIterator;e||(e=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(e){$jscomp.initSymbolIterator();e={next:e};e[$jscomp.global.Symbol.iterator]=function(){return this};return e};
$jscomp.iteratorFromArray=function(e,c){$jscomp.initSymbolIterator();e instanceof String&&(e+="");var a=0,d={next:function(){if(a<e.length){var b=a++;return{value:c(b,e[b]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(e,c,a,d){if(c){a=$jscomp.global;e=e.split(".");for(d=0;d<e.length-1;d++){var b=e[d];b in a||(a[b]={});a=a[b]}e=e[e.length-1];d=a[e];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(a,e,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.keys",function(e){return e?e:function(){return $jscomp.iteratorFromArray(this,function(c){return c})}},"es6","es3");require("x.core.js");var x=x||{};x.hub=x.hub||{};
x.hub.Dispatcher=function(){var e=function(c){this._expressApp=c;this._routes=[]};e.prototype.add=function(c,a,d){if(!c||!d)throw Error("invalid arguments");this._routes.push({path:c,opts:a,callback:d})};e.prototype.doRequest=function(c,a,d,b){var h=this,g=function(a,d,c,e){h._findRoute(a,d,function(a,h){a?a.callback(c,e,function(){g(h+1,d,c,e)}):b()})};g(0,c,a,d)};e.prototype._findRoute=function(c,a,d){for(;c<this._routes.length;c++){var b=this._routes[c];if(b&&0==b.path.indexOf(a)){d(b,c);return}}d(null,
-1)};e.prototype.init=function(){var c=this;this._expressApp.use("/",function(a,d,b){c.doRequest(a.path,a,d,b)})};return e}();
x.hub.Auth=function(){var e=function(){};e.prototype.auth=function(c,a){if(!a||!a.pwd)return!0;if(!c.query.at&&c.query.auth){var d=require("x.crypt.js");c.query.at=d.MD5(unescape(encodeURI(c.query.auth+"_SALT!")))}return c.query.at&&c.query.at==a.pwd?!0:c.headers&&c.headers.authorization?this._checkAuthHeader(c.headers.authorization,a):!1};e.prototype._checkAuthHeader=function(c,a){return c&&"Basic "==c.substr(0,6)?(c=c.substr(6).trim(),(c=(new Buffer(c,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(c+
"_SALT!")))==a.pwd:!1):!1};return e}();x.hub.Error=function(){var e=function(c,a){Error.call(this,c);this.code=a?a:"000000"};require("util").inherits(e,Error);return e}();
x.hub.Dispatcher2=function(){var e=function(c,a){this._expressApp=c;this._server=a;this._routes=[]};e.prototype.add=function(c,a,d){if(!c)throw Error("invalid arguments");a&&"function"==typeof a&&!d&&(d=a,a=null);if(!d)throw Error("invalid arguments");this._routes.push({path:c,opts:a,callback:d})};e.prototype.doRequest=function(c,a,d){var b=this,h=function(a,c,f){b._findRoute(a,c,function(a,g){if(a)try{b._doRoute(a,c,f,function(){h(g+1,c,f)})}catch(p){f.json({XC_ERR:{code:"000000",msg:p.message}})}else d()})};
h(0,c,a)};e.prototype._doRoute=function(c,a,d,b){var h=function(b,a,d,c,g,h){"cloud"==a.source?(a.hasValidAuth=!0,h()):(c=c.auth(a,g),a.hasValidAuth=c,b.opts&&0==b.opts.auth?h():c?h():d.json({XC_ERR:{code:"000007",msg:"access denied"}}))},g=this._server._auth,e={pwd:this._server._pwd};(function(b,a,d,c){if("cloud"==a.source)c();else if(b.opts&&"stream"==b.opts.body)c();else if("POST"!=a.method&&"PUT"!=a.method||"application/octet-stream"==a.header("content-type"))c();else{var g=new Buffer([]);a.on("data",
function(b){g=Buffer.concat([g,b])});a.on("end",function(){a.size=g.length;a.body=g.toString("utf8");a.json=null;if(!b.opts||!b.opts.body||"json"==b.opts.body)try{a.json=JSON.parse(g)}catch(r){}c()})}})(c,a,d,function(){h(c,a,d,g,e,function(){c.callback(a,d,function(){b()})})})};e.prototype._findRoute=function(c,a,d){for(var b=function(b,a){return"/"==a&&b!=a?!1:a.length<=b.length&&b.substr(0,a.length)==a?!0:"*"==a?!0:!1},h=function(b,a){return 0!=(("webserver"==b?1:"cloud"==b?2:3)&a)},g=a.path;c<
this._routes.length;c++){var e=this._routes[c];if(e&&e.path&&b(g,e.path)){if(e.opts){if(e.opts.method&&a.method&&a.method.toLowerCase()!=e.opts.method.toLowerCase())continue;if(e.opts.source&&!h(a.source,e.opts.source))continue}d(e,c);return}}d(null,-1)};e.prototype.init=function(){var c=this;this._expressApp.use("/",function(a,d,b){c.doRequest(a,d,b)})};return e}();
x.hub.Auth2=function(){var e=function(){};e.prototype.auth=function(c,a){if(!a||!a.pwd)return!0;var d=require("x.crypt.js");if(c.query){if(c.query.at){if(c.query.at==a.pwd)return delete c.query.at,!0;delete c.query.at}if(c.query.auth){if(d.MD5(unescape(encodeURI(c.query.auth+"_SALT!")))==a.pwd)return delete c.query.auth,!0;delete c.query.auth}}if(c.json){if(c.json.at){if(c.json.at==a.pwd)return delete c.json.at,!0;delete c.json.at}if(c.json.auth){if(d.MD5(unescape(encodeURI(c.json.auth+"_SALT!")))==
a.pwd)return delete c.json.auth,!0;delete c.json.auth}}return c.headers&&c.headers.authorization?this._checkAuthHeader(c.headers.authorization,a):!1};e.prototype._checkAuthHeader=function(c,a){return c&&"Basic "==c.substr(0,6)?(c=c.substr(6).trim(),(c=(new Buffer(c,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(c+"_SALT!")))==a.pwd:!1):!1};return e}();
x.hub.Server=function(e,c,a){this._logger=require("x.logger.js").getLogger("x.hub.Server");this.HWV="EB";this.VERSION="0.0.0";this.DEFAULT_NAME="XHUB";this.VID="FFFF";this.hostType="A20";this._port=null;this._stmPort=e;this._hmPort=c;this._signalPin=a;this._cloudConnect=this._hmSerial=this._stmUSB=null;this._pwd="";this._onCustomSerialEvent=this._onSerialEvent=null;this._app=require("express")();this._dispatcher=new x.hub.Dispatcher(this._app);this._httpserver=require("http").createServer(this._app);
this._commandFunctions={};this._cmdFunctions={};this._logger={log:function(){}};try{var d=require("x.logger.js");d&&(this._logger=d.getLogger("x.hub.Server"));var b=require("x.hub.eventbus.js");b&&(b.on("udpevent",this.onUdpEvt.bind(this)),b.on("status",this.onStatusEvt.bind(this)))}catch(h){}localStorage&&("EA"==global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C")),"CA"!=global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.geo.lat")||
localStorage.setItem("x.hub.Server.geo.lat","1392"),localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C")),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd")));this._auth=new x.hub.Auth};x.hub.Server.prototype.auth=function(e){return this._auth.auth(e,{pwd:this._pwd})};
x.hub.Server.prototype.getNetworkSettings=function(e){if("A20"==this.hostType)require("x.hub.v5.js").Native.getIPData(function(b){e&&e(null,b)});else{var c={},a=require("os");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var d in a){c[d]||(c[d]=[]);for(var b=a[d],h=0;h<b.length;h++)if("IPv4"==b[h].family&&!1===b[h].internal){var g=this._getIPData(b[h]);c[d].push(g)}}}e&&e(null,c)}};
x.hub.Server.prototype._getIPData=function(e){var c={};c.IP=e.address;c.PT=this._port;c.SN="255.255.255.0";e.netmask&&(c.SN=e.netmask);c.GW="0.0.0.0";var a=null;try{a=require("netroute")}catch(b){}if(a&&(a=a.getInfo())&&a.IPv4)for(var d=0;d<a.IPv4.length;d++)if("0.0.0.0"==a.IPv4[d].destination){c.GW=a.IPv4[d].gateway;break}c.DNS="0.0.0.0";(a=require("dns"))&&a.getServers&&(a=a.getServers())&&0<a.length&&(c.DNS=a[0]);c.MAC="00-00-00-00-00-00";e.mac&&(c.MAC=e.mac.replace(/:/g,"-"));return c};
x.hub.Server.prototype.addRoute=function(e,c,a){"function"==typeof c&&(a=c,c=null);return this._dispatcher.add(e,c,a)};
x.hub.Server.prototype.start=function(e){this._port=e;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);this._startServer();this._startUDPServer(1901);if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,
this._signalPin);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var d=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),d="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),d="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),d="STA");c._onSerialEvent(a,d)}else 82==a.type&&c._onCustomSerialEvent&&c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startSTM=function(e){if(this._stmPort){var c=this;this._stmUSB=new (require("x.hub.v5.js").USBSerial)(this._stmPort,this._signalPin,e);this._stmUSB.on("data",function(a){if(a&&a.type&&a.data)if(80==a.type&&c._onSerialEvent){a=a.data.toString();var d=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),d="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),d="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),d="STA");c._onSerialEvent(a,d)}else 82==a.type&&c._onCustomSerialEvent&&
c._onCustomSerialEvent(a.data)})}};
x.hub.Server.prototype.startWebserver=function(e,c){this._port=e;this._name=this.DEFAULT_NAME;localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name"));this._vid=this.VID;localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid"));this._startup=Math.round((new Date).getTime()/1E3);var a=0;this._startServer(function(){console.log("************* ++++++++++++++++++ **************");console.log("******* http server ("+
e+") started ********");console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()});this._startUDPServer(1901,function(){console.log("************* ++++++++++++++++++ **************");console.log("********** upd server (1901) started **********");console.log("************* ++++++++++++++++++ **************");a++;2==a&&c&&c()})};x.hub.Server.prototype.on=function(e,c){"serialevent"==e?this._onSerialEvent=c:"customserialevent"==e&&(this._onCustomSerialEvent=c)};
x.hub.Server.prototype._getServerFromReq=function(e){if(e.query.server)return e.query.server;var c=null;e.ip?c=e.ip:e.connection.remoteAddress&&(c=e.connection.remoteAddress);c&&-1<c.indexOf(":")&&c.indexOf(".")>c.indexOf(":")?c=c.substr(c.lastIndexOf(":")+1):"::1"==c&&(c="localhost");return c};x.hub.Server.prototype.enableCloudConnect=function(e){this._cloudConnect=e;e.init(this)};
x.hub.Server.prototype.restart=function(e){XC.debugf("RESTART!");var c=this;setTimeout(function(){"A20"==c.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0)},e)};x.hub.Server.prototype.resHasError=function(e){var c=null;try{c=JSON.parse(e)}catch(a){c=null}return c&&c.XC_ERR?!0:!1};
x.hub.Server.prototype._doSTMCommandRequest=function(e,c,a){this._stmUSB&&e&&-1<e.indexOf("?")?(e=e.substr(e.indexOf("?")+1),this._stmUSB.sendCommand(16,e,function(d){d&&d.data?XC.debugf(e+" --\x3e "+d.data.toString()):d&&d.error?XC.debugf(e+" --\x3e FAIL:"+d.error):XC.debugf(e+" --\x3e FAIL");if(d&&d.data){var b="XC_SUC";d.error&&(b="XC_ERR");c?a("{"+b+"}"+d.data.toString()):a('{"'+b+'": '+d.data.toString()+"}")}else c?a("{XC_ERR}internal error"):d&&d.error?a(JSON.stringify({XC_ERR:{code:"000000",
msg:d.error}})):a('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):c?a("{XC_ERR}invalid request"):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};x.hub.Server.prototype.doSTMCommand=function(e,c){this._doSTMCommandRequest("/cmd?"+e,!1,function(a){var d=null;try{d=JSON.parse(a)}catch(b){d=null}c&&c(d)})};x.hub.Server.prototype.doSTMRequest=function(e,c,a){this._stmUSB?this._stmUSB.sendCommand(e,c,function(d){d?d.error?a(null):a(d.data):a(null)}):a(null)};
x.hub.Server.prototype.setCommandFunc=function(e,c){this._commandFunctions[e.toLowerCase()]=c};x.hub.Server.prototype.setCmdFunc=function(e,c){this._cmdFunctions[e.toLowerCase()]=c};
x.hub.Server.prototype.doRequest=function(e,c,a){var d=require("os");if("/"==e){var b='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}\x3c/script>\n');b=b+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");b=b+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");b+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var h=Math.round((new Date).getTime()/1E3)-this._startup,g=Math.floor(h/86400);h-=86400*g;e=Math.floor(h/3600);h-=3600*e;var l=
Math.floor(h/60);b+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+g+"d "+e+"h "+l+"m "+(h-60*l)+"s</b></td></tr>\n";d&&d.freemem&&(b+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(d.freemem()/1E3)+"</b></td></tr>\n");a(b+'<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
e){var f={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};e="8C";l="1392";var m="035C";localStorage.getItem("x.hub.Server.timezone")&&(e=localStorage.getItem("x.hub.Server.timezone"));localStorage.getItem("x.hub.Server.geo.lat")&&(l=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(m=localStorage.getItem("x.hub.Server.geo.long"));f.XC_SUC.loc=(e+
l+m).toUpperCase();localStorage.getItem("x.hub.v5.config")&&(f.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?f.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(e=require("x.hub.v5.js").CloudConnect,f.XC_SUC.server=e.prototype.CLOUD_SERVER+":"+e.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(f.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));
localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(f.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(f.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(f.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));d&&d.freemem&&(f.XC_SUC.mem=Math.floor(d.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&
(h=require("x.hub.m.enocean.js"))&&(g=h.getEnoceanInfo(),f.XC_SUC.enocean=g)}catch(r){}if("A20"==this.hostType){f.XC_SUC.SAFE_MODE=global.SAFE_MODE;b=require("x.hub.v5.js");var n=function(b){return{ip:b.IP,sn:b.SN,gw:b.GW,dhcp:b.DHCP,dns:b.DNS,mac:b.MAC,ntp:b.NTP}};b.Native.getIPData(function(b){var d=null,c=null;Array.isArray(b.eth0)&&(d=n(b.eth0[0]));Array.isArray(b.wlan0)&&(c=n(b.wlan0[0]));b=d||c;for(var g in b)f.XC_SUC[g]=b[g];f.XC_SUC.primary_net=b===d?"eth0":"wlan0";f.XC_SUC.cfg&&b&&(d=parseInt(f.XC_SUC.cfg,
16),d=!0===b.dhcp?d&-129:d|128,f.XC_SUC.cfg=d.toString(16),2>f.XC_SUC.cfg.length&&(f.XC_SUC.cfg="0"+f.XC_SUC.cfg),f.XC_SUC.cfg=f.XC_SUC.cfg.toUpperCase());b!=c&&c&&(f.XC_SUC.wlan0=c);a(JSON.stringify(f))})}else if(require("dgram"),d&&d.networkInterfaces){d=d.networkInterfaces();for(b in d)if(d.hasOwnProperty(b))for(h=d[b],g=0;g<h.length;g++)"IPv4"==h[g].family&&!1===h[g].internal&&(e=this._getIPData(h[g]),l=null,c&&c.headers&&c.headers.host&&(l=c.headers.host,m=l.indexOf(":"),-1!=m&&(l=l.substr(0,
m))),!l||l!=e.IP&&"localhost"!=l&&"127.0.0.1"!=l||(f.XC_SUC.ip=e.IP,f.XC_SUC.sn=e.SN,f.XC_SUC.gw=e.GW,f.XC_SUC.dns=e.DNS,f.XC_SUC.mac=e.MAC));a(JSON.stringify(f))}}else if("/set"==e)c.query.rgb&&6==c.query.rgb.length&&(b=require("x.hub.v5.js"),b.setRGBColor(c.query.rgb)),a('{"XC_SUC": {}}');else if("/cmd"==e)if((b=c.query.XC_FNC)&&this._cmdFunctions[b.toLowerCase()]){var p=this;this._cmdFunctions[b.toLowerCase()](c,function(b){b?a(b):"POST"==c.method?p._doSTMCommandRequest(c,!1,a):p._doSTMCommandRequest(c.url,
!1,a)})}else"POST"==c.method?this._doSTMCommandRequest(c,!1,a):this._doSTMCommandRequest(c.url,!1,a);else if("/executeCommand"==e)b=require("x.logger.js").getLogger("GeneralExecuteCommand API"),b.log("trace","general execute command:"+JSON.stringify(c.query)),c.query&&c.query.data?(d=c.query.type,b=c.query.data,b.device&&!b.device.sys&&(b.device.sys=d),b.gateway&&!b.gateway.sys&&(b.gateway.sys=d),d=require("x.hub.commandman.js"),d.commandHandler.executeCommand(b.device,b.gateway,b.command,function(b){b.error?
a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==e)b=require("x.logger.js").getLogger("GeneralGetStates API"),b.log("trace","general get states:"+JSON.stringify(c.query)),c.query&&c.query.data?(d=c.query.type,b=c.query.data,b.device&&!b.device.sys&&(b.device.sys=d),b.gateway&&!b.gateway.sys&&(b.gateway.sys=d),d=require("x.hub.commandman.js"),b.deviceList?d.commandHandler.getMultiStatesLegacy(b.device,
b.gateway,b.deviceList,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')}):d.commandHandler.getState(b.device,b.gateway,b.status,function(b){b.error?a('{"XC_ERR":{"code":"000000","msg":"'+b.error.message+'"}}'):b&&b.data?a(JSON.stringify({XC_SUC:{data:JSON.stringify(b.data)}})):a('{"XC_SUC":{}}')})):a('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else{var k=a;b={json:function(b){k&&
(k(JSON.stringify(b)),k=null)},send:function(b){k&&(k(b),k=null)},status:function(){},end:function(){k&&(k(),k=null)}};this._dispatcher.doRequest(e,c,b,function(){k&&(k('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),k=null)})}};
x.hub.Server.prototype._preHandleRequest=function(e,c,a){if("POST"==e.method&&"application/octet-stream"!=e.header("content-type"))if(e.json){if(e.query&&0<Object.keys(e.query).length&&this.auth(e)){e.query=e.json;a();return}e.query=e.json}else if("text/plain"!=e.header("content-type")&&"text/xml"!=e.header("content-type")&&"application/xml"!=e.header("content-type")){c.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');return}this.auth(e)?a():c.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}')};
x.hub.Server.prototype._startServer=function(e){this._app.set("case sensitive routing",!0);var c=this;this._app.use(function(a,d,b){d.header("Access-Control-Allow-Origin","*");d.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+a.url);if("/"==require("url").parse(a.url).pathname)c.doRequest("/",a,function(b){d.send(b)});else if("POST"==a.method&&"application/octet-stream"!=
a.header("content-type")){var h=new Buffer([]);a.on("data",function(b){h=Buffer.concat([h,b])});a.on("end",function(){a.body=h.toString("utf8");a.json=null;try{a.json=JSON.parse(h)}catch(g){}c._preHandleRequest(a,d,b)})}else c._preHandleRequest(a,d,b)});this._app.get("/info",function(a,d){try{c.doRequest("/info",a,function(b){d.send(b)})}catch(b){console.error(b)}});this._app.get("/set",function(a,d){c.doRequest("/set",a,function(b){d.send(b)})});this._app.get("/cmd",function(a,d){c.doRequest("/cmd",
a,function(b){d.send(b)})});this._app.post("/cmd",function(a,d){c.doRequest("/cmd",a,function(b){d.send(b)})});this._app.get("/command",function(a,d){XC.debugf("command: "+a.url);var b=a.query.XC_FNC;if(b&&c._commandFunctions[b.toLowerCase()])c._commandFunctions[b.toLowerCase()](a,d);else c._doSTMCommandRequest(a.url,!0,function(b){d.send(b)})});this._app.post("/executeCommand",function(a,d){c.doRequest("/executeCommand",a,function(b){d.send(b)})});this._app.post("/getStates",function(a,d){c.doRequest("/getStates",
a,function(b){d.send(b)})});this._app.get("/config",function(a,d){var b=!0,h=!1;a.query.name&&0<a.query.name.length&&(c._name=a.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",a.query.name));a.query.vid&&0<a.query.vid.length&&(c._vid=a.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",a.query.vid));if(a.query.pwd||""==a.query.pwd)h=require("x.crypt.js"),0===a.query.pwd.length?(c._pwd="",a.query.cloud=0):c._pwd=h.MD5(unescape(encodeURI(a.query.pwd+"_SALT!"))),localStorage&&
localStorage.setItem("x.hub.Server.pwd",c._pwd),h=!0;if(a.query.loc){if(2==a.query.loc.length)var g=a.query.loc;else if(8==a.query.loc.length){var e=a.query.loc.substr(0,4);var f=a.query.loc.substr(4)}else 10==a.query.loc.length&&(g=a.query.loc.substr(0,2),e=a.query.loc.substr(2,4),f=a.query.loc.substr(6));g&&localStorage&&localStorage.setItem("x.hub.Server.timezone",g);e&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",e);f&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",f);
if("A1"==c.HWV)b=!1,c._platform.setLocation(e,f,function(b){b?d.json({XC_ERR:{code:"000000",msg:"set coordinate failed: "+b.message}}):c._platform.setTZData(g,function(b){b?d.json({XC_ERR:{code:"000000",msg:"set timezone failed: "+b.message}}):d.json({XC_SUC:{}})})});else{var m=require("x.hub.eventbus.js");m.emit("locationchange",{timezone:g,lat:e,long:f})}}a.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",a.query.neoserver),m=require("x.hub.eventbus.js"),m.emit("neoserver_activation",
a.query.neoserver));a.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state),m=require("x.hub.eventbus.js"),m.emit("x.hub.m.hm.CCU_INIT_STATE",a.query.ccu_init_state));a.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",a.query.disable_st_states);if("A20"==c.hostType||"CA"==c.HWV)f={},a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(f.IP=a.query.ip,f.SN=a.query.sn,f.GW=a.query.gw,f.DNS=a.query.dns,f.DHCP=
!1),a.query.dhcp&&1==a.query.dhcp&&(f={DHCP:!0}),a.query.ntp&&(f.NTP=a.query.ntp),a.query.mac&&(f.MAC=a.query.mac),0<Object.keys(f).length&&("EA"==c.HWV?(b=!1,e=require("x.hub.v5.js"),e.Native.setIPData(c,f,function(b){b?(d.send('{"XC_SUC":{}}'),c.restart(1E3)):d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})):"CA"==c.HWV&&(b=!1,require("x.hub.v6.js").setIPData(f,function(b,a){b?d.json({XC_ERR:{code:"000000",msg:b.message}}):(d.json({XC_SUC:{}}),a&&c.restart(1E3))})));a.query.sid&&
localStorage&&(localStorage.setItem("x.hub.v5.SID",a.query.sid),h=!0);a.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",a.query.ckey),h=!0);a.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",a.query.cserver),h=!0);a.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",a.query.cport),h=!0);a.query.cloud&&localStorage&&(h=255,localStorage.getItem("x.hub.v5.config")&&(h=parseInt(localStorage.getItem("x.hub.v5.config"),16)),h=1==a.query.cloud?
h&-65:h|64,h=h.toString(16),2>h.length&&(h="0"+h),localStorage.setItem("x.hub.v5.config",h.toUpperCase()),h=!0);if("A20"==c.hostType&&a.query.year&&a.query.month&&a.query.date&&a.query.hour&&a.query.minute){b=!1;f=parseInt(a.query.year);m=parseInt(a.query.month);var n=parseInt(a.query.date),p=parseInt(a.query.hour);a=parseInt(a.query.minute);if(isNaN(f)||1970>f||9999<f){d.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');return}if(isNaN(m)||1>m||12<m){d.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');
return}if(isNaN(n)||1>n||31<n){d.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');return}if(isNaN(p)||0>p||23<p){d.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');return}if(isNaN(a)||0>a||59<a){d.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');return}e=require("x.hub.v5.js");e.Native.setDateTime(f,m,n,p,a,function(b){b?(require("x.hub.eventbus.js").emit("timechange",{}),d.send('{"XC_SUC":{}}')):d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}h&&
c._cloudConnect&&c._cloudConnect.init(c);b&&d.send('{"XC_SUC": {}}')});this._app.get("/getKey",function(a,d){a=require("x.hub.v5.js");var b={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(b.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));a.getPublicKey(function(a){b.XC_SUC.key=a;d.end(JSON.stringify(b))})});this._app.get("/peripheral",function(a,d){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(b){b?b.error?d.end(JSON.stringify({XC_ERR:{code:"000001",msg:b.error}})):
b.data?d.end(JSON.stringify({XC_SUC:b.data})):d.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):d.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))})});this._hmPort?this._app.get("/hmtest",function(a,d){c._doHMTestRequest(a.query,d)}):"A20"==this.hostType&&this._app.get("/hmtest",function(a,d){require("x.hub.v5.js").Native.checkHMSerial(function(b){"OK"==b?d.send('{"XC_SUC":{}}'):d.send('{"XC_ERR":{"msg":"'+b+'"}}')})});this._app.get("/update",
function(a,d){var b=c._getServerFromReq(a),e="80",g=null;a.query.port&&(e=a.query.port);a.query.url&&(g=a.query.url);a.query.server&&(b=a.query.server);b&&e&&g?"A20"==c.hostType?require("x.hub.v5.js").Native.updateFirmware(b,e,g,function(b){d.send(b);c.resHasError(b)||c.restart(1E3)}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/updateST",function(a,d){if("CA"==global.HARDWARE_VERSION)c._platform.updateSTM(null,
d,function(){});else{var b=!1,e=c._getServerFromReq(a),g="80",l=null;a.query.live&&"0"!=a.query.live&&"false"!=a.query.live&&(b=!0);a.query.port&&(g=a.query.port);a.query.url&&(l=a.query.url);a.query.server&&(e=a.query.server);e&&g&&l?"A20"==c.hostType?(a=require("x.hub.v5.js"),b?a.Native.updateSTFirmware(e,g,l,d):a.Native.updateSTFirmware(e,g,l,null,function(b){d.send(b)})):b?d.send("ERROR."):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):b?d.send("ERROR."):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')}});
this._app.post("/updateST",function(a,d){"CA"==global.HARDWARE_VERSION?c._platform.updateSTM(a,d,function(){}):d.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.post("/updateV5PFW",function(a,d){require("x.hub.v5.js").Native.updateV5PFirmware(a,d,function(b){c.resHasError(b)||c.restart(1E3)})});this._app.get("/backup",function(a,d){var b=require("x.crypt.js"),e=require("x.hub.v5.js");if("A20"==c.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)e.Native.backup(c,
d);else{var g=null;a.query.enc&&"0"!=a.query.enc&&"false"!=a.query.enc&&(a.query.at?g=a.query.at:a.query.auth&&(g=b.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));e.backup(c,d,g)}});this._app.get("/restore",function(a,d){var b=c._getServerFromReq(a),e="80",g=null;a.query.port&&(e=a.query.port);a.query.url&&(g=a.query.url);if(b&&e&&g){var l=require("x.hub.v5.js");if("A20"==c.hostType&&a.query.native&&"0"!=a.query.native&&"false"!=a.query.native)l.Native.restore(c,"http://"+b+":"+e+g,function(b){d.send(b);
c.resHasError(b)||c.restart(1E3)});else{var f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=crypt.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));l.restore(c,"http://"+b+":"+e+g,f,function(b){d.send(b);c.resHasError(b)||c.restart(1E3)})}}else d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getLogs",function(a,d){a=require("x.hub.v5.js");"A20"==c.hostType?a.getLogs(d):"A1"==c.HWV?a.getNeoServerLogs(d):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});
this._app.get("/clearLogs",function(a,d){a=require("x.hub.v5.js");"A20"==c.hostType?a.clearLogs(function(){d.send('{"XC_SUC":{}}')}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/getPorts",function(a,d){require("x.hub.v5.js").getSerialPorts(function(b){d.send(b)})});this._app.get("/reset",function(a,d){d.send('{"XC_SUC":{}}');c.restart(1E3)});this._app.get("/refurbish",function(a,d){require("x.hub.v5.js").Native.setIPData(c,{DHCP:!0},function(b){b?c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){d.status(200).json({XC_SUC:{}})})}):
d.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}')})});this._app.get("/resetST",function(a,d){"CA"==global.HARDWARE_VERSION?c._platform._stm.reset(function(b){b?d.json({XC_ERR:{msg:b.message}}):d.json({XC_SUC:{}})}):c._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){d.status(200).json({XC_SUC:{}})})})});this._app.get("/rebootST",function(a,d){"CA"==global.HARDWARE_VERSION?c._platform._stm.reboot(function(b){b?d.json({XC_ERR:{msg:b.message}}):d.json({XC_SUC:{}})}):
c._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){d.status(200).json({XC_SUC:{}})})})});this._app.get("/resetHM",function(a,d){require("x.hub.v5.js").Native.resetHM(function(b){b?(d.status(200).json({XC_SUC:{}}),c.restart(100)):d.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}})})});this._app.get("/resetZwave",function(a,d){require("x.hub.v5.js").Native.resetZway(function(b){b?(d.status(200).json({XC_SUC:{}}),c.restart(100)):d.status(200).json({XC_ERR:{code:"000000",
message:"reset zwave failed"}})})});this._app.get("/resetZigbee",function(a,d){require("x.hub.v5.js").Native.resetZigbee(function(b){b?(d.status(200).json({XC_SUC:{}}),c.restart(100)):d.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}})})});this._app.get("/resetKNX",function(a,d){require("x.hub.m.knx.js").reset(function(b){b&&!b.error?d.status(200).json({XC_SUC:{}}):d.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}})})});this._app.get("/mountUSB",function(a,
d){require("x.hub.v5.js").mountUSB(function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.get("/setBackupUSB",function(a,d){a.query.path?require("x.hub.v5.js").setBackupUsbPath(a.query.path,function(){d.status(200).json({XC_SUC:{}})}):d.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}})});this._app.post("/backupDeviceXML",function(a,d){a=a.body;require("x.hub.v5.js").saveDeviceXMLforBackup(a,function(b){b.error?
d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.post("/backupMacrosXML",function(a,d){a=a.body;require("x.hub.v5.js").saveMacrosXMLforBackup(a,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{}})})});this._app.post("/backupIrcodesXML",function(a,d){a=a.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(a,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):
d.status(200).json({XC_SUC:{}})})});this._app.get("/backupLocal",function(a,d){var b=require("x.crypt.js"),e=require("x.hub.v5.js"),g=null;a.query.key&&(g=b.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));e.backupLocal(c,g,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{file:b.data}})})});this._app.get("/unmountUSB",function(a,d){require("x.hub.v5.js").unmountUSB(function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):
d.status(200).json({XC_SUC:{}})})});this._app.get("/listUsbBackups",function(a,d){require("x.hub.v5.js").listUsbBackups(function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:b.data})})});this._app.get("/deleteUsbBackup",function(a,d){(a=a.query.file)?require("x.hub.v5.js").deleteBackup(a,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{}})}):d.status(200).json({XC_ERR:{code:"000000",
msg:"file name is null"}})});this._app.get("/loadBackup",function(a,d){var b=require("x.hub.v5.js"),c=require("x.crypt.js"),g=a.query.file;if(g){var e=null;a.query.key&&(e=c.MD5(unescape(encodeURI(a.query.key+"_SALT!"))));b.loadBackup(g,e,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).json({XC_SUC:{}})})}else d.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}})});this._app.get("/loadBackupDeviceXML",function(a,d){require("x.hub.v5.js").loadDeviceXML(function(b){b.error?
d.status(400).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).end(b.data)})});this._app.get("/loadBackupMacroXML",function(a,d){require("x.hub.v5.js").loadMacroXML(function(b){b.error?d.status(400).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).end(b.data)})});this._app.get("/loadBackupIrcodesXML",function(a,d){require("x.hub.v5.js").loadIrcodesXML(function(b){b.error?d.status(400).json({XC_ERR:{code:"000000",msg:b.error.message}}):d.status(200).end(b.data)})});
this._app.get("/restoreLocal",function(a,d){require("x.hub.v5.js").restoreLocal(c,function(b){b.error?d.status(200).json({XC_ERR:{code:"000000",msg:b.error.message}}):(d.status(200).json({XC_SUC:{}}),c.restart(1E3))})});this._app.get("/testReadOnly",function(a,d){require("x.hub.v5.js").testReadOnly(function(b){b?d.status(200).json({XC_SUC:{readonly:!0,message:b.message}}):d.status(200).json({XC_SUC:{readonly:!1}})})});this._app.get("/fixReadOnly",function(a,d){require("x.hub.v5.js").fixReadOnly(d,
function(b){b?d.status(200).json({XC_ERR:{code:"01001",message:b.message}}):d.status(200).json({XC_SUC:{}})})});this._app.get("/scan",function(a,d){require("x.hub.v5.js").Native.scanWiFi(function(b,a){if(b)d.send(b.message);else if(a){d.send('{"XC_SUC":'+JSON.stringify(a)+"}");return}d.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}')})});this._app.get("/connect",function(a,d){a.query.ssid&&a.query.pwd?require("x.hub.v5.js").Native.connectWiFi(a.query.ssid,a.query.pwd,function(b){b?d.send('{"XC_SUC":{}}'):
d.send('{"XC_ERR":{"msg":"failed to connect"}}')}):d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.get("/configWLAN",function(a,d){var b={};a.query.ip&&a.query.sn&&a.query.gw&&a.query.dns&&(b.IP=a.query.ip,b.SN=a.query.sn,b.GW=a.query.gw,b.DNS=a.query.dns,b.DHCP=!1);a.query.dhcp&&1==a.query.dhcp&&(b={DHCP:!0});a.query.ntp&&(b.NTP=a.query.ntp);a.query.mac&&(b.MAC=a.query.mac);0<Object.keys(b).length?require("x.hub.v5.js").Native.setWLANData(b,function(b){b?d.send('{"XC_SUC":{}}'):
d.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')}):d.send('{"XC_SUC": {}}')});this._app.get("/tm/http",function(a,d){var b=require("x.hub.taskman.js");if(b&&b.taskManager)b.taskManager.onHttpEvt(a.query,function(b,a){b?d.send('{"XC_ERR":{"msg":'+b.message+"}}"):a?d.send('{"XC_SUC":{}}'):d.send('{"XC_ERR":{"msg":"no such trigger"}}')});else d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._dispatcher.init();this._app.get("*",function(a,d){XC.debugf("INVALID REQ: "+
a.url);d.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')});this._app.use(function(a,d,b,c){XC.debugf(a);b.send({XC_ERR:{code:"000001",msg:"exception"}})});this._httpserver.listen(this._port,function(){var a=c._httpserver.address().port;c._logger.log("info","listening on port "+a+"...");e&&e()})};
x.hub.Server.prototype.sendUDPMessage=function(e){if(this._udpSocket){var c=e.substr(0,4);if("EVT:"==c||"STA:"==c)try{var a=JSON.parse(e.substr(4));a.__srcId=this._udpSocket.__srcId;e=c+JSON.stringify(a)}catch(d){}e=new Buffer(e);this._udpSocket.send(e,0,e.length,1901,"239.255.255.250");this._udpSocket.send(e,0,e.length,1901,"255.255.255.255")}};
x.hub.Server.prototype._startUDPServer=function(e,c){var a=require("dgram"),d=this,b=require("crypto").randomBytes(4).toString("hex");try{var h=this._udpSocket=a.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){h=this._udpSocket=a.createSocket("udp4")}h.__srcId=b;h.on("listening",function(){d._logger.log("info","listening on udp port "+e+"...");h.setBroadcast(!0);c&&c()});h.on("message",function(b,a){h.address();if(b&&b.length&&3<=b.length&&71==b[0]&&69==b[1]&&84==b[2]){d._logger.log("trace","receive gateway discovery request");
var c=function(b,c){var g="DHCP:"+(b.DHCP?"TRUE":"FALSE")+"\nHWV:"+d.HWV+"\nVER:"+d.VERSION+"\nVID:"+d._vid+"\nNAME:"+d._name;g+="\nIP:"+b.IP;g+="\nPT:"+b.PT;g+="\nSN:"+b.SN;g+="\nGW:"+b.GW;g+="\nDNS:"+b.DNS;g+="\nMAC:"+b.MAC;c&&(g+="\nTMP_ID:"+c);g+="\n";d._logger.log("trace","send gateway discovery response:"+g.replace(/(?:\r\n|\r|\n)/g," | "));b=new Buffer(g);h.send(b,0,b.length,a.port,a.address);h.send(b,0,b.length,1901,"239.255.255.250");h.send(b,0,b.length,1901,"255.255.255.255")};d.getNetworkSettings(function(b,
a){if(!b&&a){b=null;"A20"==d.hostType&&(b=function(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1)},b=b()+b());for(var g in a)for(var e=0;e<a[g].length;e++)a[g][e].PT=d._port,c(a[g][e],b)}})}else if(b&&b.length&&4<=b.length&&69==b[0]&&86==b[1]&&84==b[2]){var g=b.toString();if(4<g.length){b=null;try{b=JSON.parse(g.substr(4))}catch(n){}b&&b.__srcId!=h.__srcId&&(delete b.__srcId,g=require("x.hub.eventbus.js"),g.emit("gatewayevent",b,a,"EVT"))}}else if(b&&b.length&&4<=b.length&&83==
b[0]&&84==b[1]&&65==b[2]&&(g=b.toString(),4<g.length)){b=null;try{b=JSON.parse(g.substr(4))}catch(n){}b&&b.__srcId!=h.__srcId&&(delete b.__srcId,g=require("x.hub.eventbus.js"),g.emit("gatewayevent",b,a,"STA"))}});h.on("error",function(b){XC.debugf("udp port error");h.close()});h.on("close",function(){});h.bind(e)};x.hub.Server.prototype.onUdpEvt=function(e,c){c||(c="EVT");this._logger.log("trace","send "+c+" event:"+JSON.stringify(e));this.sendUDPMessage(c+":"+JSON.stringify(e)+"\r\n")};
x.hub.Server.prototype.onStatusEvt=function(e){};x.hub.Server.prototype.getTimeZone=function(){var e="8C";localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(e=localStorage.getItem("x.hub.Server.timezone"));return e};
x.hub.Server.prototype.setTimeZoneCompatiable=function(e,c){if(!e||isNaN(parseInt(e,16)))c&&c(Error("timezone invalid"));else{e=parseInt(e,16);e=((e>>4&1?-1:1)*(e&15)+11&31|(e>>5&1)<<7).toString(16).toUpperCase();2>e.length&&(e="0"+e);e&&localStorage&&localStorage.setItem("x.hub.Server.timezone",e);var a=localStorage.getItem("x.hub.Server.geo.lat"),d=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:e,lat:a,long:d});c&&c()}};
x.hub.Server.prototype.getTimeZoneCompatiable=function(e){var c=this.getTimeZone();c=parseInt(c,16);var a=(c&31)-11;c=((0!=(c&128)?1:0)<<5|(0>a?1:0)<<4|(0<a?a:0-a)).toString(16).toUpperCase();2>c.length&&(c="0"+c);e&&e(null,c)};
x.hub.ServerNEO=function(){var e=function(c,a,d){x.hub.Server.call(this,c,a,d);this._dispatcher=new x.hub.Dispatcher2(this._app,this);this._auth=new x.hub.Auth2;this._platform=require("x.hub.neo_server.js")};require("util").inherits(e,x.hub.Server);e.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},
{path:"/getKey",options:{method:"GET"}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/tm/http",options:{method:"GET"}},{path:"/",options:{method:"GET",auth:0}}];e.prototype.addRoute=function(c,a,d){"function"==typeof a&&(d=a,a=null);return this._dispatcher.add(c,a,d)};
e.prototype._setDefaultRoutes=function(){var c=this,a=function(a,b){var d=null;d=require("url").parse(a.url).pathname;d="/"==d?"/":"/"+d.split("/")[1];c.doRequest(d,a,b,function(a){void 0!=a&&null!=a&&("object"==typeof a?b.json(a):b.send(a))})};this._routes.forEach(function(d){c.addRoute(d.path,d.options,a)})};e.prototype._startServer=function(c){var a=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(a,b,c){b.header("Access-Control-Allow-Origin","*");
b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var d=require("x.logger.js").getLogger("x.hub.Server.Access");d.log("debug",a.method+":"+a.url);a.source="webserver";b.on("finish",function(){d.log("debug",a.method+":"+a.url+" -> HTTP:"+b.statusCode)});c()});this._dispatcher.init();this._app.use("*",function(a,b){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","INVALID "+a.method+" REQ:"+a.url);b.json({XC_ERR:{code:"000001",
msg:"invalid request"}})});this._app.use(function(a,b,c,g){require("x.logger.js").getLogger("x.hub.Server.Access").log("warn","error: "+a.message+" stack:"+a.stack);c.json({XC_ERR:{code:"000002",msg:a.stack}})});this._httpserver.listen(this._port,function(){var d=a._httpserver.address().port;a._logger.log("info","listening on port "+d+"...");c&&c()})};e.prototype.doRequest=function(c,a,d,b){!b&&d&&"function"==typeof d&&(b=d,d=null);if("/info"==c)this._info(a,function(a,d){a?b&&b(JSON.stringify({XC_ERR:{code:"000000",
msg:a.message}})):b&&b(JSON.stringify({XC_SUC:d}))});else if("/command"==c)if((c=a.query.XC_FNC)&&this._commandFunctions[c.toLowerCase()])this._commandFunctions[c.toLowerCase()](a,d);else b&&b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/cmd"==c)if(c=a.query.XC_FNC,!c&&a.json&&a.json.XC_FNC&&(c=a.json.XC_FNC,a.query=a.json),c&&this._cmdFunctions[c.toLowerCase()])this._cmdFunctions[c.toLowerCase()](a,function(a){b&&b(a?a:'{"XC_ERR":{"code":"000002", "msg":"invalid request"}}')});
else b&&b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/config"==c)this._config(a,function(a,d){a?b&&b(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):b&&b(JSON.stringify({XC_SUC:d?d:{}}))});else if("/executeCommand"==c)c=require("x.logger.js").getLogger("GeneralExecuteCommand API"),a.json&&(a.query=a.json),c.log("trace","general execute command:"+JSON.stringify(a.query)),a.query&&a.query.data?(c=a.query.type,a=a.query.data,a.device&&!a.device.sys&&(a.device.sys=c),a.gateway&&
!a.gateway.sys&&(a.gateway.sys=c),c=require("x.hub.commandman.js"),c.commandHandler.executeCommand(a.device,a.gateway,a.command,function(a){a.error?b('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):b('{"XC_SUC":{}}')})):b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==c)c=require("x.logger.js").getLogger("GeneralGetStates API"),c.log("trace","general get states:"+JSON.stringify(a.query)),a.json&&(a.query=a.json),a.query&&a.query.data?(c=a.query.type,a=a.query.data,
a.device&&!a.device.sys&&(a.device.sys=c),a.gateway&&!a.gateway.sys&&(a.gateway.sys=c),c=require("x.hub.commandman.js"),a.deviceList?c.commandHandler.getMultiStatesLegacy(a.device,a.gateway,a.deviceList,function(a){a.error?b('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?b(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):b('{"XC_SUC":{}}')}):c.commandHandler.getState(a.device,a.gateway,a.status,function(a){a.error?b('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+
'"}}'):a&&a.data?b(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):b('{"XC_SUC":{}}')})):b('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==c){var e={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(e.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey"));require("x.hub.v5.js").getPublicKey(function(a){e.XC_SUC.key=a;b&&b(e)})}else if("/backup"==c)this._platform.backup(a,d,function(){b&&b()});else if("/restore"==c)this._platform.restore(a,d,function(){b&&
b()});else if("/reset"==c)c="factory",a.query&&a.query.type&&(c=a.query.type),this.reset(c,function(a){a?b&&b(JSON.stringify({XC_ERR:{code:"000000",msg:a.message}})):b&&b('{"XC_SUC":{}}')});else if("/log"==c||"/getLogs"==c)a.method&&"get"==a.method.toLowerCase()?this.getLogs(function(a,c,e){if(a)d.status(500),d.json({XC_ERR:{code:"100000",msg:a.message}}),b&&b();else{var g=require("fs-extra");d.setHeader("Content-disposition","attachment; filename="+c);d.sendFile(e,null,function(a){g.removeSync(e);
a&&(d.status(500),d.json({XC_ERR:{code:"100000",msg:a.message}}));b&&b(a)})}}):a.method&&"delete"==a.method.toLowerCase()&&this.clearLogs(function(a){a?b&&b({XC_ERR:{code:"100000",msg:a.message}}):b&&b({XC_SUC:{}})});else if("/tm"==c)if("/tm/http"==require("url").parse(a.url).pathname)require("x.hub.taskman.js").taskManager.onHttpEvt(a.query,function(a,d){a?b&&b('{"XC_ERR":{"msg":'+a.message+"}}"):d?b&&b('{"XC_SUC":{}}'):b&&b('{"XC_ERR":{"msg":"no such trigger"}}')});else b&&b(JSON.stringify({XC_ERR:{code:"000000",
msg:"invalid request"}}));else x.hub.Server.prototype.doRequest.call(this,c,a,b)};e.prototype._info=function(c,a){var d={name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)},b=this;require("async").parallel([function(b){localStorage.getItem("x.hub.v5.config")&&(d.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.SID")&&(d.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&
(d.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));var a=require("os");a&&a.freemem&&(d.mem=Math.floor(a.freemem()/1E3));b()},function(a){d.server=b.getCloudServer()+":"+b.getCloudPort();a()},function(a){b.getTZ(function(b,c){!b&&c&&(d.loc||(d.loc=""),d.loc=(c+d.loc).toUpperCase());a()})},function(a){b.getLocation(function(b,c,e){!b&&c&&e&&(d.loc||(d.loc=""),d.loc+=(c+e).toUpperCase());a()})},function(a){b._platform._network.getNetwork(function(b,e){if(!b&&e){b=null;if(c&&c.headers&&c.headers.host){b=
c.headers.host;var g=b.indexOf(":");-1!=g&&(b=b.substr(0,g))}for(var h in e)if(g=e[h],b&&(b==g.ip||"localhost"==b||"127.0.0.1"==b)){d.ip=g.ip;d.sn=g.subnet;d.gw=g.router;d.dns=g.dns?g.dns[0]:null;d.mac=g.mac;break}}a()})}],function(){a&&a(null,d)})};e.prototype._config=function(c,a){var d=this,b=!1,e;require("async").series([function(a){c.query.name&&(d._name=c.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",c.query.name));c.query.vid&&(d._vid=c.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",
c.query.vid));if(c.query.pwd||""==c.query.pwd){var e=require("x.crypt.js");0===c.query.pwd.length?(d._pwd="",c.query.cloud=0):d._pwd=e.MD5(unescape(encodeURI(c.query.pwd+"_SALT!")));localStorage&&localStorage.setItem("x.hub.Server.pwd",d._pwd);b=!0}c.query.neoserver&&(localStorage&&localStorage.setItem("x.hub.taskman.NEO_SERVER",c.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",c.query.neoserver));c.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",c.query.sid),
b=!0);a()},function(a){if(localStorage&&(c.query.ckey&&(d.setCloudKey(c.query.ckey),b=!0),c.query.cserver&&(d.setCloudServer(c.query.cserver),b=!0),c.query.cport&&(d.setCloudPort(c.query.cport),b=!0),void 0!=c.query.cloud&&null!=c.query.cloud)){var e=255;localStorage.getItem("x.hub.v5.config")&&(e=parseInt(localStorage.getItem("x.hub.v5.config"),16));e=1==c.query.cloud?e&-65:e|64;e=e.toString(16);2>e.length&&(e="0"+e);localStorage.setItem("x.hub.v5.config",e.toUpperCase());b=!0}a()},function(b){if(c.query.loc){if(2==
c.query.loc.length)var a=c.query.loc;else if(8==c.query.loc.length){var g=c.query.loc.substr(0,4);var h=c.query.loc.substr(4)}else 10==c.query.loc.length&&(a=c.query.loc.substr(0,2),g=c.query.loc.substr(2,4),h=c.query.loc.substr(6));d.setTZ(a,function(a){a&&(e=a);d.setLocation(g,h,function(a){a&&(e=a);b()})})}else b()}],function(){b&&d._cloudConnect&&d._cloudConnect.init(d);a&&a(e)})};e.prototype.setLocation=function(c,a,d){this._logger.log("debug","set location lat="+c+" long="+a);c&&a?(localStorage&&
(localStorage.setItem("x.hub.Server.geo.lat",c),localStorage.setItem("x.hub.Server.geo.long",a)),d&&d(),process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:c,long:a})})):d&&d(Error("invalid arguments"))};e.prototype.getLocation=function(c){if(localStorage){var a=localStorage.getItem("x.hub.Server.geo.lat");var d=localStorage.getItem("x.hub.Server.geo.long")}a&&d||(a="1392",d="035C");c&&c(null,a,d)};e.prototype.setTZ=function(c,a){this._platform.setTZData(c,a)};e.prototype.getTZ=
function(c){this._platform.getTZData(c)};e.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};e.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer()};e.prototype.setCloudServer=function(c){return this._cloudConnect.setCloudServer(c)};e.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};e.prototype.setCloudPort=function(c){return this._cloudConnect.setCloudPort(c)};e.prototype.setCloudKey=function(c){return this._cloudConnect.setCloudKey(c)};
e.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};e.prototype.getLogs=function(c){require("x.hub.logman.js").compressLogs(function(a,d,b){c&&c(a,d,b)})};e.prototype.clearLogs=function(c){require("x.hub.logman.js").clearLogs(function(a){c&&c(a)})};e.prototype.reset=function(c,a){var d=require("fs"),b=require("fs-extra"),e=require("path"),g=require("x.hub.fileman.js").fileManager.getUserRootDataPath();switch(c){case "passwords":c=e.join(g,"localstorage","x.hub.Server.pwd");
d.existsSync(c)&&b.removeSync(c);a&&a(null,!0);break;case "factory":d.existsSync(g)&&b.emptyDirSync(g);a&&a(null,!0);break;default:a&&a(Error("unknonw reset mode: "+c))}};return e}();
x.hub.ServerV6=function(){var e=function(){var a=function(b,a){this._expressApp=b;this._server=a;this._routes=[]};a.prototype.add=function(b,a,d){if(!b)throw Error("invalid arguments");a&&"function"==typeof a&&!d&&(d=a,a=null);if(!d)throw Error("invalid arguments");this._routes.push({path:b,opts:a,callback:d})};a.prototype.doRequest=function(b,a,d){var c=this,e=function(b,a,g){c._findRoute(b,a,function(b,f){if(b)try{c._doRoute(b,a,g,function(){e(f+1,a,g)})}catch(q){g.json({XC_ERR:{code:"000000",msg:q.message}})}else d()})};
e(0,b,a)};a.prototype._doRoute=function(b,a,d,c){var e=function(b,a,d,c,e,g){"cloud"==a.source?(a.hasValidAuth=!0,g()):(c=c.auth(a,e),a.hasValidAuth=c,b.opts&&0==b.opts.auth?g():c?g():d.json({XC_ERR:{code:"000007",msg:"access denied"}}))},g=function(b,a,d,c,e){var g=c.isLocked();a.locked=g;var f=c.getRCS();a.rcs=f;g?(g=a.query?a.query.pin:null,!g&&a.json&&a.json.pin&&(g=a.json.pin),g=c.checkPin(g),a.pinMatch=g,b.opts&&b.opts.lock?"function"==typeof b.opts.lock?b.opts.lock(g,a,c)?e():d.json({XC_ERR:{code:"000007",
msg:"access denied (locked)"}}):g?e():d.json({XC_ERR:{code:"000007",msg:"access denied (locked)"}}):e()):e()},h=this,l=this._server._auth,k={pwd:this._server._pwd};(function(b,a,d,c){if("cloud"==a.source)c();else if(b.opts&&"stream"==b.opts.body)c();else if("POST"!=a.method&&"PUT"!=a.method||"application/octet-stream"==a.header("content-type"))c();else{var e=new Buffer([]);a.on("data",function(b){e=Buffer.concat([e,b])});a.on("end",function(){a.size=e.length;a.body=e.toString("utf8");a.json=null;
if(!b.opts||!b.opts.body||"json"==b.opts.body)try{a.json=JSON.parse(e)}catch(u){}c()})}})(b,a,d,function(){e(b,a,d,l,k,function(){g(b,a,d,h._server,function(){b.callback(a,d,function(){c()})})})})};a.prototype._findRoute=function(b,a,d){for(var c=function(b,a){return b?"/"==a&&b!=a?!1:a.length<=b.length&&b.substr(0,a.length)==a?!0:"*"==a?!0:!1:!1},e=function(b,a){return 0!=(("webserver"==b?1:"cloud"==b?2:3)&a)},g=a.path;b<this._routes.length;b++){var h=this._routes[b];if(h&&h.path&&c(g,h.path)){if(h.opts){if(h.opts.method&&
a.method&&a.method.toLowerCase()!=h.opts.method.toLowerCase())continue;if(h.opts.source&&!e(a.source,h.opts.source))continue}d(h,b);return}}d(null,-1)};a.prototype.init=function(){var b=this;this._expressApp.use("/",function(a,d,c){b.doRequest(a,d,c)})};return a}(),c=function(){var a=function(){};a.prototype.auth=function(b,a){if(!a||!a.pwd)return!0;var d=require("x.crypt.js");if(b.query&&(b.query.at&&b.query.at==a.pwd||b.query.auth&&d.MD5(unescape(encodeURI(b.query.auth+"_SALT!")))==a.pwd))return!0;
if(b.json){if(b.json.at){if(b.json.at==a.pwd)return delete b.json.at,!0;delete b.json.at}if(b.json.auth){if(d.MD5(unescape(encodeURI(b.json.auth+"_SALT!")))==a.pwd)return delete b.json.auth,!0;delete b.json.auth}}return b.headers&&b.headers.authorization?this._checkAuthHeader(b.headers.authorization,a):!1};a.prototype._checkAuthHeader=function(b,a){return b&&"Basic "==b.substr(0,6)?(b=b.substr(6).trim(),(b=(new Buffer(b,"base64")).toString().split(":")[1])?require("x.crypt.js").MD5(unescape(encodeURI(b+
"_SALT!")))==a.pwd:!1):!1};return a}(),a=function(a,b,h){x.hub.Server.call(this,a,b,h);this._dispatcher=new e(this._app,this);this._auth=new c;this._platform=require("x.hub.v6.js");var d=this;this._platform._stm.on("event",function(b,a){d._onSerialEvent(b,a)});this._locked="true"==localStorage.getItem("x.hub.Server.lock");this._rcs="true"==localStorage.getItem("x.hub.Server.rcs")};require("util").inherits(a,x.hub.Server);a.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},
{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1,lock:1}},{path:"/wifi",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},{path:"/getKey",options:{method:"GET",lock:function(a,b,c){return!a||"cloud"==b.source&&!c.getRCS()?!1:!0}}},{path:"/peripheral",options:{method:"GET"}},{path:"/update",options:{source:1,lock:1}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",
body:"stream"}},{path:"/reset",options:{method:"GET",source:1,lock:1}},{path:"/reboot",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/lock",options:{method:"GET",lock:function(a,b,c){return!a||"cloud"==b.source&&!c.getRCS()?!1:!0}}},{path:"/unlock",options:{method:"GET",lock:function(a,b,c){return!a||"cloud"==b.source&&!c.getRCS()?!1:!0}}},{path:"/tm/http",options:{method:"GET"}},
{path:"/sapi",options:{method:"POST",body:"text",auth:0}},{path:"/",options:{method:"GET",auth:0}}];a.prototype.addRoute=function(a,b,c){"function"==typeof b&&(c=b,b=null);return this._dispatcher.add(a,b,c)};a.prototype._setDefaultRoutes=function(){var a=this,b=function(b,d){var c=null;c=require("url").parse(b.url).pathname;c="/"==c?"/":"/"+c.split("/")[1];a.doRequest(c,b,d,function(b){void 0!=b&&null!=b&&("object"==typeof b?d.json(b):d.send(b))})};this._routes.forEach(function(d){a.addRoute(d.path,
d.options,b)})};a.prototype._startServer=function(a){var b=this;this._setDefaultRoutes();this._app.set("case sensitive routing",!0);this._app.use(function(b,a,d){a.header("Access-Control-Allow-Origin","*");a.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var c=require("x.logger.js").getLogger("x.hub.Server.Access");c.log("debug",b.method+":"+b.url);b.source="webserver";a.on("finish",function(){c.log("debug",b.method+":"+b.url+" -> HTTP:"+a.statusCode)});
d()});this._dispatcher.init();this._app.use("*",function(b,a){XC.debugf("INVALID REQ: "+b.url);a.json({XC_ERR:{code:"000001",msg:"invalid request"}})});this._app.use(function(b,a,d,c){XC.debugf(b);d.json({XC_ERR:{code:"000002",msg:b.stack}})});this._httpserver.listen(this._port,function(){var d=b._httpserver.address().port;b._logger.log("info","listening on port "+d+"...");a&&a()})};a.prototype.doRequest=function(a,b,c,e){!e&&c&&"function"==typeof c&&(e=c,c=null);var d=this;if("/"==a){var f='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n<title>'+
(String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</title>\n<script>function setZwaveConfigRef() {var zwaveconfig = document.getElementById("zwaveconfig"); if(zwaveconfig){zwaveconfig.href = window.location.protocol + "//" + window.location.hostname + ":9000/";}}\x3c/script>\n');f=f+'</head>\n<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setZwaveConfigRef()">\n<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n<tbody>\n<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;"><th colspan="3">'+
(this._name+"</th>\n");f=f+'</tr>\n<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n<tr style="height: 30px;"><td>&nbsp;</td><td>device:</td><td><b>'+(this.DEFAULT_NAME+"</b></td></tr>\n");f+='<tr style="height: 30px;"><td>&nbsp;</td><td>version:</td><td><b>'+this.HWV+" ("+this.VERSION+")</b></td></tr>\n";var g=Math.round((new Date).getTime()/1E3)-this._startup;a=Math.floor(g/86400);g-=86400*a;var h=Math.floor(g/3600);g-=3600*
h;var p=Math.floor(g/60);f+='<tr style="height: 30px;"><td>&nbsp;</td><td>uptime:</td><td><b>'+a+"d "+h+"h "+p+"m "+(g-60*p)+"s</b></td></tr>\n";(a=require("os"))&&a.freemem&&(f+='<tr style="height: 30px;"><td>&nbsp;</td><td>memory:</td><td><b>'+Math.floor(a.freemem()/1E3)+"</b></td></tr>\n");e(f+'<tr style="height: 30px;"><td>&nbsp;</td><td>zwave:</td><td><b><a href=":9000/" id="zwaveconfig">Expert UI</a></b></td></tr>\n<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2020 mediola - connected living AG</td></tr>\n</tbody>\n</table>\n</body>\n</html>')}else if("/info"==
a){var k={XC_SUC:{name:this._name,mhv:"XH II-"+this.hostType,msv:this.VERSION,msb:this.BUILD,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round((new Date).getTime()/1E3)}};localStorage.getItem("x.hub.v5.config")&&(k.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config"));localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort")?k.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort"):(a=require("x.hub.v5.js").CloudConnect,
k.XC_SUC.server=a.prototype.CLOUD_SERVER+":"+a.prototype.CLOUD_SERVER_PORT);localStorage.getItem("x.hub.v5.SID")&&(k.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID"));localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(k.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(k.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE"));localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(k.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES"));
(a=require("os"))&&a.freemem&&(k.XC_SUC.mem=Math.floor(a.freemem()/1E3));try{global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&(f=require("x.hub.m.enocean.js"))&&(g=f.getEnoceanInfo(),k.XC_SUC.enocean=g)}catch(y){}f=require("async");f.parallel([function(a){k.XC_SUC.rcs=d.getRCS();a()},function(a){k.XC_SUC.locked=d.isLocked();a()},function(a){d._platform.getExtraInfo(function(b,d){!b&&d&&(k.XC_SUC.extra=d);a()})},function(a){d._platform._time.getNTPServers(function(b,d){!b&&d&&(k.XC_SUC.ntp=
d.join(","));a()})},function(a){d._platform.getLocation(function(b,c,e){!b&&c&&e&&(k.XC_SUC.loc=(c+e).toUpperCase());d._platform._time.getTimezoneEncoded(function(b,d){!b&&d&&(k.XC_SUC.loc=k.XC_SUC.loc?d.toUpperCase()+k.XC_SUC.loc:d.toUpperCase());a()})})},function(a){k.XC_SUC.mediola_mac=d._platform._network.getMediolaMac();d._platform._network.getNetwork(function(b,d){if(!b&&d){var c=function(a){return a?{ip:a.ip,sn:a.subnet,gw:a.router,dhcp:a.dhcp,dns:a.dns?a.dns.join(","):a.dns,mac:a.mac?a.mac.replace(/:/g,
"-"):null}:null},e=Object.keys(d);if(0==e.length)return;b=c(d.eth0);var f=c(d.wlan0),g=null;d.eth0||d.wlan0||(g=c(d[e[0]]));d=null;b&&b.ip?(d=b,k.XC_SUC.primary_net="eth0"):f&&f.ip?(d=f,k.XC_SUC.primary_net="wlan0"):g&&g.ip&&(d=f,k.XC_SUC.primary_net=e[0]);for(var h in d)k.XC_SUC[h]=d[h];k.XC_SUC.cfg&&d&&(h=parseInt(k.XC_SUC.cfg,16),h=!0===d.dhcp?h&-129:h|128,k.XC_SUC.cfg=h.toString(16),2>k.XC_SUC.cfg.length&&(k.XC_SUC.cfg="0"+k.XC_SUC.cfg),k.XC_SUC.cfg=k.XC_SUC.cfg.toUpperCase());k.XC_SUC.eth0=b;
k.XC_SUC.wlan0=f}a()})}],function(){e(JSON.stringify(k))})}else if("/command"==a)if((f=b.query.XC_FNC)&&this._commandFunctions[f.toLowerCase()])this._commandFunctions[f.toLowerCase()](b,c);else this._doSTMCommandRequest(b,!0,function(a){c.send(a)});else if("/cmd"==a)if(f=b.query.XC_FNC,!f&&b.json&&b.json.XC_FNC&&(f=b.json.XC_FNC,b.query=b.json),f&&this._cmdFunctions[f.toLowerCase()])this._cmdFunctions[f.toLowerCase()](b,function(a){a?e(a):d._doSTMCommandRequest(b,!1,e)});else this._doSTMCommandRequest(b,
!1,e);else if("/config"==a){var r=!1,q,v=!1,w=null;!b.query||1!=b.query.poweroff&&"true"!=b.query.poweroff&&1!=b.query.poweroff||(w=!0);f=require("async");f.series([function(a){b.query.name&&(d._name=b.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",b.query.name));b.query.vid&&(d._vid=b.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",b.query.vid));if(b.query.pwd||""==b.query.pwd){var c=require("x.crypt.js");0===b.query.pwd.length?(d._pwd="",b.query.cloud=0):d._pwd=
c.MD5(unescape(encodeURI(b.query.pwd+"_SALT!")));localStorage&&localStorage.setItem("x.hub.Server.pwd",d._pwd);r=!0}b.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",b.query.neoserver),c=require("x.hub.eventbus.js"),c.emit("neoserver_activation",b.query.neoserver));b.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",b.query.ccu_init_state),c=require("x.hub.eventbus.js"),c.emit("x.hub.m.hm.CCU_INIT_STATE",b.query.ccu_init_state));
b.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",b.query.disable_st_states);b.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",b.query.sid),r=!0);b.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",b.query.ckey),r=!0);b.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",b.query.cserver),r=!0);b.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",b.query.cport),r=!0);b.query.cloud&&
localStorage&&(c=255,localStorage.getItem("x.hub.v5.config")&&(c=parseInt(localStorage.getItem("x.hub.v5.config"),16)),c=1==b.query.cloud?c&-65:c|64,c=c.toString(16),2>c.length&&(c="0"+c),localStorage.setItem("x.hub.v5.config",c.toUpperCase()),r=!0);a()},function(a){if(b.query.loc){if(2==b.query.loc.length)var c=b.query.loc;else if(8==b.query.loc.length){var e=b.query.loc.substr(0,4);var f=b.query.loc.substr(4)}else 10==b.query.loc.length&&(c=b.query.loc.substr(0,2),e=b.query.loc.substr(2,4),f=b.query.loc.substr(6));
d.setTimeZoneCompatiable(c,function(b){b&&(q=b);d.setLocation(e,f,function(b){b&&(q=b);a()})})}else a()},function(a){if(b.query.year&&b.query.month&&b.query.date&&b.query.hour&&b.query.minute){var c=parseInt(b.query.year),e=parseInt(b.query.month),f=parseInt(b.query.date),g=parseInt(b.query.hour),h=parseInt(b.query.minute);d.setDateTime(c,e,f,g,h,function(b){b&&(q=b);a()})}else a()},function(a){b.query.apin?d.setPin(b.query.pin,b.query.apin,function(b){b&&(q=Error("failed to config"));a(b)}):a()},
function(a){if(void 0==b.query.rcs||null==b.query.rcs||""==b.query.rcs)a();else{var c=null;if("1"==b.query.rcs||"true"==b.query.rcs||1==b.query.rcs)c=!0;else if("0"==b.query.rcs||"false"==b.query.rcs||0==b.query.rcs)c=!1;else{a();return}d.setRCS(c,function(b){b&&(q=Error("failed to config"));a(b)})}},function(a){var c={};b.query.ip&&b.query.sn&&b.query.gw&&b.query.dns&&(c.IP=b.query.ip,c.SN=b.query.sn,c.GW=b.query.gw,c.DNS=b.query.dns,c.DHCP=!1);b.query.dhcp&&1==b.query.dhcp&&(c={DHCP:!0});b.query.ntp&&
(c.NTP=b.query.ntp);b.query.mac&&(c.MAC=b.query.mac);0>=Object.keys(c).length?a():d._platform.setIPData(c,function(b,d){b?q=b:v=d;a()})}],function(){r&&d._cloudConnect&&d._cloudConnect.init(d);e&&(q?e(JSON.stringify({XC_ERR:{code:"000001",msg:q.message}})):e('{"XC_SUC": {}}'));1==w?d.poweroff(1E3):v&&d.restart(1E3)})}else if("/executeCommand"==a)f=require("x.logger.js").getLogger("GeneralExecuteCommand API"),b.json&&(b.query=b.json),f.log("trace","general execute command:"+JSON.stringify(b.query)),
b.query&&b.query.data?(g=b.query.type,f=b.query.data,f.device&&!f.device.sys&&(f.device.sys=g),f.gateway&&!f.gateway.sys&&(f.gateway.sys=g),g=require("x.hub.commandman.js"),g.commandHandler.executeCommand(f.device,f.gateway,f.command,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getStates"==a)f=require("x.logger.js").getLogger("GeneralGetStates API"),f.log("trace","general get states:"+
JSON.stringify(b.query)),b.json&&(b.query=b.json),b.query&&b.query.data?(g=b.query.type,f=b.query.data,f.device&&!f.device.sys&&(f.device.sys=g),f.gateway&&!f.gateway.sys&&(f.gateway.sys=g),g=require("x.hub.commandman.js"),f.deviceList?g.commandHandler.getMultiStatesLegacy(f.device,f.gateway,f.deviceList,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):e('{"XC_SUC":{}}')}):g.commandHandler.getState(f.device,
f.gateway,f.status,function(a){a.error?e('{"XC_ERR":{"code":"000000","msg":"'+a.error.message+'"}}'):a&&a.data?e(JSON.stringify({XC_SUC:{data:JSON.stringify(a.data)}})):e('{"XC_SUC":{}}')})):e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/getKey"==a)if(f=b.query?b.query.k:null){var t=(b.headers?b.headers["x-forwarded-for"]:null)||(b.connection?b.connection.remoteAddress:null);if(t){var u=require("x.hub.password");u.registSecureClient(t,f,function(a,b){a?e&&e({XC_ERR:{code:"000000",
msg:a.message}}):e&&e({XC_SUC:b})})}else e&&e({XC_ERR:{code:"000000",msg:"can not get client ip address"}})}else k={XC_SUC:{}},localStorage.getItem("x.hub.v5.cloudKey")&&(k.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),require("x.hub.v5.js").getPublicKey(function(a){k.XC_SUC.key=a;e&&e(k)});else if("/peripheral"==a)require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(a){a?a.error?e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:a.error}})):a.data?e&&e(JSON.stringify({XC_SUC:a.data})):
e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):e&&e(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}))});else if("/update"==a)b.method&&"post"==b.method.toLowerCase()&&b.query&&"st"==b.query.type?d._platform.updateSTM(b,c,function(){e&&e()}):b.query&&"st"==b.query.type?d._platform.updateSTM(null,c,function(){e&&e()}):d._platform.updateFirmware(b.query?b.query.url:null,function(a,b){a?c.json({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}}):
(c.json({XC_SUC:{}}),b&&d._platform.reboot(null,1E3));e&&e()});else if("/backup"==a)d._platform.backup(b,c,function(){e&&e()});else if("/restore"==a)d._platform.restore(b,c,function(){e&&e()});else if("/reset"==a)b.query&&b.query.type?"st"==b.query.type?d._platform._stm.reset(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):"st_reboot"==b.query.type?d._platform._stm.reboot(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):"knx"==b.query.type?require("x.hub.m.knx.js").reset(function(a){a&&
!a.error?e&&e({XC_SUC:{}}):e&&e({XC_ERR:{code:"000000",message:"reset knx failed"}})}):"zwave"==b.query.type&&d._platform._zwayServer.reset(function(a){a?e&&e({XC_ERR:{msg:a.message}}):e&&e({XC_SUC:{}})}):(e&&e('{"XC_SUC":{}}'),d.restart(1E3));else if("/reboot"==a)e&&e('{"XC_SUC":{}}'),f=null,b.query&&b.query.mode&&"recovery"==b.query.mode&&(f="recovery"),d._platform.reboot(f,1E3);else if("/wifi"==a)switch(f=b.path,f=f.substr(5),f){case "/scan":d._platform._network.scanWifi(b.query,function(a,b){a?
e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):e&&e(JSON.stringify({XC_SUC:b?b:[]}))});break;case "/connect":d._platform._network.connectWifi(b.query,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),d.restart(1E3))});break;case "/disconnect":d._platform._network.disconnectWifi(b.query,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),
d.restart(1E3))});break;case "/info":d._platform._network.getWifiInfo(b.query,function(a,b){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):e&&e(JSON.stringify({XC_SUC:b}))});break;case "/config":f={};"true"==b.query.dhcp||1==b.query.dhcp||1==b.query.dhcp?f={dhcp:!0}:b.query.ip&&b.query.sn&&b.query.gw&&b.query.dns&&(f.ip=b.query.ip,f.subnet=b.query.sn,f.router=b.query.gw,f.dns=b.query.dns?b.query.dns.split(","):[],f.dhcp=!1);if(0>=Object.keys(f).length){e&&e(JSON.stringify({XC_SUC:{}}));
break}d._platform._network.setNetwork("wlan0",f,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code?a.code:"000000",msg:a.message}})):(e&&e(JSON.stringify({XC_SUC:{}})),d.restart(1E3))});break;default:e&&e({XC_ERR:{code:"000001",message:"invalid request"}})}else if("/log"==a||"/getLogs"==a)b.method&&"get"==b.method.toLowerCase()?d.getLogs(function(a,b,d){if(a)c.status(500),c.json({XC_ERR:{code:"100000",msg:a.message}}),e&&e();else{var f=require("fs-extra");c.setHeader("Content-disposition","attachment; filename="+
b);c.sendFile(d,null,function(a){f.removeSync(d);a&&(c.status(500),c.json({XC_ERR:{code:"100000",msg:a.message}}));e&&e(a)})}}):b.method&&"delete"==b.method.toLowerCase()&&d.clearLogs(function(a){a?e&&e({XC_ERR:{code:"100000",msg:a.message}}):e&&e({XC_SUC:{}})});else if("/tm"==a)if(f=require("url").parse(b.url).pathname,"/tm/http"==f)require("x.hub.taskman.js").taskManager.onHttpEvt(b.query,function(a,b){a?e&&e('{"XC_ERR":{"msg":'+a.message+"}}"):b?e&&e('{"XC_SUC":{}}'):e&&e('{"XC_ERR":{"msg":"no such trigger"}}')});
else e&&e(JSON.stringify({XC_ERR:{code:"000000",msg:"invalid request"}}));else"/lock"==a?(f=b.query?b.query.pin:null,d.lock(f,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code,msg:a.message}})):e&&e(JSON.stringify({XC_SUC:{}}))})):"/unlock"==a?(f=b.query?b.query.pin:null,d.unlock(f,function(a){a?e&&e(JSON.stringify({XC_ERR:{code:a.code,msg:a.message}})):e&&e(JSON.stringify({XC_SUC:{}}))})):"/sapi"==a?(t=(b.headers?b.headers["x-forwarded-for"]:null)||(b.connection?b.connection.remoteAddress:null))?
(d=this,u=require("x.hub.password"),u.decodeSecureReq(t,b,function(a,b){if(!a){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug",b.method+":"+b.url);var c={json:function(a){u.encodeSecureRsp(t,JSON.stringify(a),function(a,b){a?e&&e({XC_ERR:{code:"000000",msg:a.message}}):e&&e(b)})},send:function(a){u.encodeSecureRsp(t,a,function(a,b){a?e&&e({XC_ERR:{code:"000000",msg:a.message}}):e&&e(b)})}};d._dispatcher.doRequest(b,c,function(a){void 0!=a&&null!=a&&("object"==typeof a?c.json(a):
c.send(a))})}})):e&&e({XC_ERR:{code:"000000",msg:"can not get client ip address"}}):e&&e('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};a.prototype._doSTMCommandRequest=function(a,b,c){if(a){var d=this._platform._stm;if(d){var e=this;if("string"==typeof a){var f=16;var h=a;-1<h.indexOf("?")&&(h=h.substr(h.indexOf("?")+1))}else"POST"==a.method?(f=17,h=a.json?JSON.stringify(a.json):a.body):(f=16,h=a.url,-1<h.indexOf("?")&&(h=h.substr(h.indexOf("?")+1))),a.locked?"cloud"==a.source?16==f?f=
18:17==f&&(f=19):"webserver"!=a.source||a.pinMatch||(16==f?f=18:17==f&&(f=19)):"cloud"==a.source&&(16==f?f=20:17==f&&(f=21));d.sendCommand(f,h,function(a){a&&a.error?e._logger.log("trace",h+" --\x3e FAIL:"+a.error):a&&a.data?e._logger.log("trace",h+" --\x3e "+a.data.toString()):e._logger.log("trace",h+" --\x3e FAIL");if(a&&a.data){var d="XC_SUC";a.error&&(d="XC_ERR");b?c("{"+d+"}"+a.data.toString()):c('{"'+d+'": '+a.data.toString()+"}")}else b?c("{XC_ERR}internal error"):a&&a.error?c(JSON.stringify({XC_ERR:{code:"000000",
msg:a.error}})):c('{"XC_ERR":{"code":"000000", "msg":"internal error"}}')})}else b?c("{XC_ERR}no stm"):c('{"XC_ERR":{"code":"000001", "msg":"no stm"}}')}else b?c("{XC_ERR}invalid request"):c('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}')};a.prototype.setLED=function(a,b){if(a&&"string"==typeof a&&a.match(/^([a-fA-F0-9]){4}/g)){var d=this._platform._led;if(d){var c=parseInt(a.substr(0,2),16);a=parseInt(a.substr(2,2),16);var e;switch(a){case 0:var f=e=a=0;break;case 1:a=0;e=255;f=0;break;
case 2:e=a=0;f=255;break;case 3:a=255;f=e=0;break;case 4:e=a=255;f=0;break;case 5:f=e=a=255;break;case 6:a=255;e=0;f=255;break;case 7:a=0;f=e=255;break;default:b&&b(Error("invalid set led color:"+a));return}0===c?d.setColor(a,e,f,function(a){b&&b(a)}):1==c?d.saveColor(a,e,f,function(a){b&&b(a)}):b&&b(Error("invalid set led command:"+c))}else b&&b(Error("no led"))}else b&&b(Error("invalid set led data: "+a))};a.prototype.restart=function(a){this._platform.reboot(null,a)};a.prototype.poweroff=function(a){this._platform.poweroff(a)};
a.prototype.reset=function(a,b){var c=require("path"),d=require("fs"),e=require("fs-extra"),f=require("x.hub.fileman.js").fileManager.getUserRootDataPath();this._logger.log("debug","reset ("+a+")");switch(a){case "passwords":a=c.join(f,"localstorage","x.hub.Server.pwd");d.existsSync(a)&&(this._logger.log("trace","remove file "+a),e.removeSync(a));require("x.hub.password.js").reset(function(){b&&b(null,!0)});break;case "network":this._platform.reset("network",function(a,c){b&&b(a,c)});break;case "factory":d.existsSync(f)&&
(this._logger.log("trace","clear folder "+f),e.emptyDirSync(f));this._platform.reset("factory",function(a,c){b&&b(a,c)});break;default:b&&b(Error("unknonw reset mode: "+a))}};a.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync()};a.prototype.setTimeZoneCompatiable=function(a,b){this._platform.setTZData(a,function(c){c||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{timezone:a})});b&&b(c)})};a.prototype.getTimeZoneCompatiable=function(a){this._platform.getTZData(a)};
a.prototype.setLocation=function(a,b,c){this._platform.setLocation(a,b,function(d){d||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:a,long:b})});c&&c(d)})};a.prototype.getLocation=function(a){this._platform.getLocation(function(b,c,d){a&&a(b,c,d)})};a.prototype.setDateTime=function(a,b,c,e,l,f){isNaN(a)||1970>a||9999<a?f&&f(Error("year invalid")):isNaN(b)||1>b||12<b?f&&f(Error("month invalid")):isNaN(c)||1>c||31<c?f&&f(Error("date invalid")):isNaN(e)||0>e||23<
e?f&&f(Error("hour invalid")):isNaN(l)||0>l||59<l?f&&f(Error("minute invalid")):this._platform.setTime({year:a,month:b,date:c,hour:e,minute:l},f)};a.prototype.getLogs=function(a){var b=require("x.hub.fileman.js").fileManager.getUserLogPath(),c=require("os").tmpdir(),d=require("path"),e=require("fs-extra"),f=require("archiver"),m="logs_"+(new Date).toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",n=d.join(c,m);c=e.createWriteStream(n);f=f("zip");c.on("close",function(){a&&
(a(null,m,n),a=null)});c.on("error",function(b){a&&(a(b),a=null)});f.on("error",function(b){a&&(a(b),a=null)});f.pipe(c);f.directory(b);f.finalize()};a.prototype.clearLogs=function(a){require("x.hub.logman.js").clearLogs(function(b){a&&a(b)})};a.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer()};a.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort()};a.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected()};a.prototype.isLocked=
function(){return this._locked};a.prototype.lock=function(a,b){!a||this.checkPin(a)?(localStorage.setItem("x.hub.Server.lock",!0),this._locked=!0,b&&b(null)):(a=Error("failed to lock"),a.code="000003",b&&b(a))};a.prototype.unlock=function(a,b){a&&this.checkPin(a)?(localStorage.setItem("x.hub.Server.lock",!1),this._locked=!1,b&&b(null)):(a=Error("access denied (locked)"),a.code="000007",b&&b(a))};a.prototype.setPin=function(a,b,c){a=require("x.hub.password.js").setPin(a,b);c&&c(a?null:Error("failed"))};
a.prototype.checkPin=function(a){return require("x.hub.password.js").checkPin(a)};a.prototype.getRCS=function(){return this._rcs};a.prototype.setRCS=function(a,b){localStorage.getItem("x.hub.Server.rcs",a);this._rcs=a;b&&b()};return a}();x.hub.Handler=function(){this.server=null};x.hub.Handler.prototype.Server=x.hub.Server;x.hub.Handler.prototype.ServerNEO=x.hub.ServerNEO;x.hub.Handler.prototype.ServerV6=x.hub.ServerV6;x.hub.Handler.prototype.getServer=function(){return this.server};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler);
