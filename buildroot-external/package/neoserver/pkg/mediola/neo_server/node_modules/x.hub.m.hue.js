var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.hue=x.hub.m.hue||{};x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js");
x.hub.m.hue.Monitor=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor");this._running=!1;this._bridge=a;this._devices={};this._sensors={}};d.prototype.start=function(a){this._logger.log("debug","start monitor for:"+this._bridge.ip);this._running||(this._running=!0,this._getAllSensors());a&&a()};d.prototype.addStateDevice=function(a,b){a&&a.address&&(this._devices[a.address]=a);b&&b()};d.prototype._getAllSensors=function(){var a=this;this._logger.log("trace",
"get all sensors for:"+this._bridge.ip);x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(b,c){b?(a._logger.log("trace","get all sensors for:"+a._bridge.ip+" error:"+b.message),setTimeout(function(){a._getAllSensors()},1E3)):(!b&&c&&a._receiveSensors(c),a._running&&a._getAllSensors())})};d.prototype._receiveSensors=function(a){var b=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c].getAddress(),e=a[c].getStates();b[d]=e}return b},c=b(this._sensors);b=b(a);this._sensors=a;for(var d=
0;d<a.length;d++){var h=a[d],f=h.getAddress();if(this._devices[f]){h=h.getType();var e=c[f],g=b[f];if(g)switch(h){case "ZLLLightLevel":this._produceEvent(this._devices[f],"lightlevel",e?e.lightlevel:null,g.lightlevel);this._produceEvent(this._devices[f],"dark",e?e.dark:null,g.dark);this._produceEvent(this._devices[f],"daylight",e?e.daylight:null,g.daylight);this._produceEvent(this._devices[f],"battery",e?e.battery:null,g.battery);break;case "ZLLTemperature":this._produceEvent(this._devices[f],"temperature",
e?e.temperature:null,g.temperature);this._produceEvent(this._devices[f],"battery",e?e.battery:null,g.battery);break;case "ZLLPresence":this._produceEvent(this._devices[f],"motion",e?e.motion:null,g.motion);break;case "ZLLSwitch":this._produceEvent(this._devices[f],"levent",e?e.levent:null,g.levent);break;case "ZGPSwitch":this._produceEvent(this._devices[f],"levent",e?e.levent:null,g.levent)}}}};d.prototype._produceEvent=function(a,b,c,d){c!=d&&(this._logger.log("trace","receive new status:"+JSON.stringify({address:a.address,
key:b,value:d})),require("x.hub.eventbus.js").emit("status",{module:"hue",device:a,gateway:a.gateway,data:{key:b,value:d,oldvalue:c,changed:!0}}))};return d}();
x.hub.m.hue.Handler=function(){var d=function(){this._monitors={}};util.inherits(d,EventEmitter);d.prototype.init=function(a){a&&a()};d.prototype.getSystems=function(){return["hue"]};d.prototype.addStateDevice=function(a,b){a?a.gateway?this._startMonitor(a.gateway,function(c,d){c?b&&b({error:c}):d.addStateDevice(a,function(a){b&&b({error:a})})}):b&&b(Error("device gateway format invalid")):b&&b({error:Error("device json format invalid")})};d.prototype.getAllStates=function(){return[]};d.prototype.getStates=
function(a){return null};d.prototype.getState=function(a,b,c){a?a.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",a.gateway,a,{value:b},function(a,b){a?c&&c({error:a}):b?c&&c({data:{value:b.status}}):c&&c({error:Error("do status failed")})}):c&&c(Error("device gateway format invalid")):c&&c({error:Error("device json format invalid")})};d.prototype.executeCommand=function(a,b,c){x.hub.m.hue.HUE_MODULE.doCommand(a.gateway,a,b,c)};d.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&
b.gateway&&a.gateway&&b.gateway.ip==a.gateway.ip?b.device.address==a.device.address:!1};d.prototype._startMonitor=function(a,b){if(a&&a.ip){var c=a.ip;this._monitors[c]?b&&b(null,this._monitors[c]):(a=x.hub.m.hue.HUE_MODULE.resolveGateway(a))?(a=new x.hub.m.hue.Monitor(a),this._monitors[c]=a,a.start(),b&&b(null,a)):b&&b(Error("hue gateway format invalid"))}else b&&b(Error("harmony hub format invalid"))};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler);
