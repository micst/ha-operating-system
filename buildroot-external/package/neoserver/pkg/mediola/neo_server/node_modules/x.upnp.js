var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,a,c){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(a.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var a=0;a<b.length;++a){var c=b[a];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,a,c,d){if(a){c=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in c||(c[e]={});c=c[e]}b=b[b.length-1];d=c[b];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6","es3");var x=x||{};x.upnp=x.upnp||{};
x.upnp._DeviceCache={_cache:{},setDescLoaded:function(b,a){this._cache[b]||(this._cache[b]={});this._cache[b].loaded=a},addTarget:function(b,a){this._cache[b]&&(this._cache[b].targets||(this._cache[b].targets=[]),-1==this._cache[b].targets.indexOf(a)&&this._cache[b].targets.push(a))},putDevice:function(b,a,c){this._cache[b]||(this._cache[b]={loaded:!0});this._cache[b].device=a;this.addTarget(b,c)},getDevice:function(b){return(b=b?this._cache[b]:null)?b.device:null},getDeviceCache:function(b){return b?
this._cache[b]:null},removeDevices:function(b){for(var a=0;a<b.length;a++)delete this._cache[b[a]]},getDevices:function(){return this._cache},getDevicesWithTarget:function(b){var a=[],c;for(c in this._cache)if(this._cache.hasOwnProperty(c)){var d=this._cache[c];d.targets&&-1!=d.targets.indexOf(b)&&d.device&&a.push(d.device)}return a},removeDevicesWithTarget:function(b){var a={},c;for(c in this._cache){var d=!1,e=this._cache[c];e.targets&&-1!=e.targets.indexOf(b)&&e.device&&(d=!0);d||(a[c]=e)}this._cache=
a}};x.upnp._SSDPCache={_cache:{},putSSDP:function(b,a){if(b&&a){var c=a.getUUID();if(c){var d=a.getMaxAge(),e=Math.round((new Date).getTime()/1E3);this._cache[c]={ip:b,expire:e+d,location:a.location}}}},removeExpired:function(){var b=[],a=Math.round((new Date).getTime()/1E3),c;for(c in this._cache)if(this._cache.hasOwnProperty(c)){var d=this._cache[c].expire;-1==d?b.push(c):a>d&&b.push(c)}x.upnp._DeviceCache.removeDevices(b);for(a=0;a<b.length;a++)delete this._cache[b[a]]}};
x.upnp.SSDP=function(){var b=function(){this._usnObj=null};b.prototype.getUUID=function(){return this._usnObj?this._usnObj.uuid:null};b.prototype.getMaxAge=function(){if(!this["cache-control"])return-1;var a=this["cache-control"];a=a.replace("max-age","");a=a.replace("=","");a=parseInt(a.trim());a=parseInt(a);return isNaN(a)?-1:a};b.resolve=function(a){if(!a)return null;a=a.split("\n");var c=new b;switch(a[0].trim()){case "HTTP/1.1 200 OK":c.type="RESULT";break;case "NOTIFY * HTTP/1.1":c.type="NOTIFY";
break;case "M-SEARCH * HTTP/1.1":c.type="M-SEARCH";break;default:return null}for(var d=1;d<a.length&&"\r"!=a[d];d++){var e=a[d].trim(),f=e.indexOf(":");if(-1!=f){var g=e.substr(0,f);e=e.substr(f+1);g&&(c[g.toLowerCase()]=e.trim())}}if(!c.usn)return null;c._usnObj=x.upnp.Util.parseUSN(c.usn);return c};return b}();
x.upnp.UDPListener=function(){var b=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("x.upnp.UDPListener"):{log:{}};this._callbacks=[];this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var c in a)for(var d=a[c],e=0;e<d.length;e++)this._addDiscoverSocket(d[e])}else this._addDiscoverSocket(null)};b.prototype._addDiscoverSocket=function(a){var c=require("dgram"),d=this;a?"IPv4"==a.family&&0==a.internal&&
(c=c.createSocket("udp4"),c.bind(null,a.address),c.on("message",function(a,c){d._onResponse(a,c)}),this._sockets.push(c)):(c=c.createSocket("udp4"),c.on("message",function(a,c){d._onResponse(a,c)}),this._sockets.push(c))};b.prototype.addCallback=function(a){a&&-1==this._callbacks.indexOf(a)&&this._callbacks.push(a)};b.prototype.removeCallback=function(a){a&&(a=this._callbacks.indexOf(a),-1!=a&&this._callbacks.splice(a,1))};b.prototype.sendMessage=function(a,c,d){a=new Buffer(a);for(var e=0;e<this._sockets.length;e++)this._sockets[e].send(a,
0,a.length,d,c)};b.prototype._onResponse=function(a,c){a=a.toString();this._logger.log("trace","receive ssdp from: "+(c?c.address:"unknown address"));var d=x.upnp.SSDP.resolve(a);d&&(this._logger.log("trace","usn:"+(d.usn?d.usn:"")+" location:"+(d.location?d.location:"")),x.upnp._SSDPCache.putSSDP(c.address,d),this._callbacks.forEach(function(a){a&&a(c.address,d)}))};return b}();
x.upnp.DescLoader=function(){var b=function(a,c){this.ip=a;this.port=80;this.uuid=c;this.subtype=this.type=this.name=null;this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("x.upnp.DescLoader"):{log:{}}};b.prototype.load=function(a,c){var d=require("url").parse(a);d.port&&(this.port=d.port);var e=this;this._loadDeviceDesc2(a,function(a,d){a?c&&c(a):(a=e._parseDesc(d))?c&&c(null,a):c&&c(Error("device desc parse error"))})};b.prototype._loadDeviceDesc=function(a,c){var d=
this;this._logger.log("trace","load device descriptin from url:"+a);var e=c;$.ajax({url:a,type:"get",timeout:5E3,dataType:"text",cache:!0,success:function(c){d._logger.log("trace","http request success for:"+a);e&&(e(null,c),e=null)},error:function(a,c){a="http request error:"+(a?a.status:"0")+"-"+c;d._logger.log("trace",a);e&&(e(Error(a)),e=null)}})};b.prototype._loadDeviceDesc2=function(a,c){this._logger.log("trace","load device descriptin from url:"+a);var d=require("url").parse(a);d={host:d.hostname,
port:d.port,path:d.path,method:"GET"};var e=this,b="",g=require("http"),h=c;try{var k=g.request(d,function(c){c.on("data",function(a){b+=a});c.on("end",function(){if(200==c.statusCode)e._logger.log("trace","http request success for:"+a),h&&h(null,b);else{var d="http request error:"+c.statusCode+"-"+b;e._logger.log("trace",d);h&&h(Error(d))}h=null})});k.setTimeout&&k.setTimeout(2E3,function(){k.abort()});if(k.on&&"function"==typeof k.on)k.on("error",function(a){a||(a=Error("http request error"));h&&
h(a);h=null});k.end()}catch(l){h&&h(l),h=null}};b.prototype._parseDesc=function(a){-1!=a.indexOf('xmlns:ms=" urn:microsoft-com:wmc-1-0"')&&(a=a.replace('xmlns:ms=" urn:microsoft-com:wmc-1-0"','xmlns:ms="urn:microsoft-com:wmc-1-0"'));var c=null;try{c=$($.parseXML(a))}catch(f){}if(!c)return null;a=c.find("device");if(!a||0==a.length)return null;a=$(a[0]);var d=this._parseDescXml(a);if(!d)return null;d.embeddedDevices=[];var e=this;c.find("deviceList device").each(function(){var a=$(this);(a=e._parseDescXml(a))&&
d.embeddedDevices.push(a)});return d};b.prototype._parseDescXml=function(a){if(!a)return null;var c=null,d=a.find("friendlyName");0<d.length&&(this.name=$(d[0]).text(),0==this.name.indexOf("Philips hue")?this.type="hue":0==this.name.indexOf("WeMo Switch")||0==this.name.indexOf("WeMo Insight")?(this.type="wemo",0==this.name.indexOf("WeMo Insight")&&(this.subtype="insight")):0<this.name.indexOf("Sonos")&&(this.type="sonos"));(d=a.find("deviceType"))&&0<d.length&&(this.deviceType=$(d[0]).text());(d=
a.find("manufacturer"))&&0<d.length&&(this.manufacturer=$(d[0]).text());(d=a.find("modelName"))&&0<d.length&&(this.modelName=$(d[0]).text());(d=a.find("modelDescription"))&&0<d.length&&(this.modelDescription=$(d[0]).text());(d=a.find("serialNumber"))&&0<d.length&&(this.serialNumber=$(d[0]).text());d=a.find("UDN");0<d.length&&(c=$(d[0]).text());d=a.find("X_DLNACAP");0<d.length&&(this.X_DLNACAP=$(d[0]).text());if(!this.name||!this.deviceType||!c)return null;6<c.length&&"uuid:"==c.substr(0,5)&&!this.uuid&&
(this.uuid=c.substr(5));c=x.upnp.Util.parseURN(this.deviceType);if(!c)return null;c.device&&"MediaServer"==c.device.type?a=this.parseServer(a):c.device&&"MediaRenderer"==c.device.type?a=this.parseRenderer(a):(a=new x.upnp.Device,a.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}));return a};
b.prototype.parseServer=function(a){var c=null,d=null;a.find("serviceList service").each(function(){var a=$(this),b=a.find("serviceType");a=a.find("controlURL");if(0<b.length&&0<a.length)if(b=$(b[0]).text(),(a=$(a[0]).text())&&"/"==a.charAt(0)||(a="/"+a),-1!=b.indexOf("ContentDirectory"))c={type:b,url:a};else if("urn:schemas-upnp-org:service:ConnectionManager:1"==b||"urn:schemas-upnp-org:service:ConnectionManager:2"==b)d={type:b,url:a}});return c&&d?(a=new x.upnp.MediaServer,a.init(this.ip,this.port,
this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),a.contentDirectory=c,a.connectionManager=d,a):null};b.prototype.parseRenderer=function(a){var c=null,d=null,b=null,f=null,g=null;a.find("serviceList service").each(function(){var a=$(this),e=a.find("serviceType");a=a.find("controlURL");0<e.length&&0<a.length&&(e=
$(e[0]).text(),(a=$(a[0]).text())&&"/"==a.charAt(0)||(a="/"+a),-1!=e.indexOf("GroupRenderingControl")?f={type:e,url:a}:-1!=e.indexOf("RenderingControl")?c={type:e,url:a}:-1!=e.indexOf("ConnectionManager")?d={type:e,url:a}:-1!=e.indexOf("AVTransport")?b={type:e,url:a}:-1!=e.indexOf("Queue")&&(g={type:e,url:a}))});return c&&b?(a=new x.upnp.MediaRenderer,a.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,
deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),a.renderingControl=c,a.connectionManager=d,a.avTransport=b,a.groupRenderingControl=f,a.queue=g,a):null};return b}();
x.upnp.DiscoveryService=function(){var b=function(a){this._udpListener=a;this._callbacks={};this._autoSearchITV=null;var c=this;this._udpListener.addCallback(function(a,e){c._onReceiveSSDP(a,e)})};b.prototype.M_SEARCH='M-SEARCH * HTTP/1.1\r\nHost: 239.255.255.250:1900\r\nMan: "ssdp:discover"\r\nMX: 5\r\n';b.prototype._findDevice=function(a,c){c&&this._callbacks["ssdp:all"]&&this._callbacks["ssdp:all"].forEach(function(a){a&&a(c)});c&&this._callbacks[a]&&this._callbacks[a].forEach(function(a){a&&a(c)})};
b.prototype.addCallback=function(a,c){a||(a="upnp:rootdevice");this._callbacks[a]||(this._callbacks[a]=[]);c&&-1==this._callbacks[a].indexOf(c)&&this._callbacks[a].push(c)};b.prototype.removeCallback=function(a,c){a||(a="upnp:rootdevice");this._callbacks[a]&&c&&(c=this._callbacks[a].indexOf(c),-1!=c&&this._callbacks[a].splice(c,1))};b.prototype.startAutoSearch=function(){if(!this._autoSearchITV){var a=this;this._autoSearchITV=setInterval(function(){a.discoverTarget("upnp:rootdevice")},3E4);this.discoverTarget("upnp:rootdevice")}};
b.prototype.stopAutoSearch=function(){this._autoSearchITV&&(clearInterval(this._autoSearchITV),this._autoSearchITV=null)};b.prototype.discoverWithTimeout=function(a,c){this.discoverTargetWithTimeout("upnp:rootdevice",a,c)};b.prototype.discoverTargetWithTimeout=function(a,c,d){var e=function(a){a&&e.devices.push(a)};e.devices=[];this.addCallback(a,e);var b=this;this.discoverTarget(a);setTimeout(function(){b.removeCallback(a,e);d&&d(e.devices)},c)};b.prototype.discoverTarget=function(a){x.upnp._SSDPCache.removeExpired();
x.upnp._DeviceCache.removeDevicesWithTarget(a);this._udpListener.sendMessage(this.M_SEARCH+"ST: "+a+"\r\n\r\n","239.255.255.250",1900)};b.prototype._onReceiveSSDP=function(a,c){if("RESULT"==c.type){var d=c.getUUID(),b=c.st,f=x.upnp._DeviceCache.getDeviceCache(d);if(f&&f.device)f.targets&&-1!=f.targets.indexOf(b)||(x.upnp._DeviceCache.addTarget(d,b),this._findDevice(b,f.device));else if(!f||!f.loaded){var g=this;x.upnp._DeviceCache.setDescLoaded(d,!0);(new x.upnp.DescLoader(a,d)).load(c.location,function(a,
c){a||!c?x.upnp._DeviceCache.setDescLoaded(d,!1):(x.upnp._DeviceCache.putDevice(d,c,b),g._findDevice(b,c))})}}};return b}();
x.upnp.Util={parseUSN:function(b){if(!b||5>=b.length||"uuid:"!=b.substr(0,5))return null;var a={},c=b.indexOf("::",5);if(5==c)return null;if(-1==c)return a.uuid=b.substr(5),a;a.uuid=b.substring(5,c);if(b=b.substr(c+2))a.urn=this.parseURN(b);return a},parseURN:function(b){if(!b)return null;if("upnp:rootdevice"==b.substr(0,15))return{domain:"upnp",device:{type:"rootdevice"}};if("urn:"==b.substr(0,4)){var a=null;if(b=b.substr(4))b=b.split(":"),b[0]&&(a={domain:b[0]},"device"==b[1]&&b[2]&&b[3]?a.device=
{type:b[2],ver:b[3]}:"service"==b[1]&&b[2]&&b[3]&&(a.service={type:b[2],ver:b[3]}));return a}return null},findTag:function(b,a,c){var d=b.find(a);return d&&0<d.length?d:c?(d=b.find(c+"\\:"+a))&&0<d.length?d:d=this._iterateTag(b,a,c):[]},_iterateTag:function(b,a,c){var d=[],e=b.prop("tagName");e&&(e==a||e==c+":"+a)&&d.push(b);if((b=b.children())&&0<b.length)for(e=0;e<b.length;e++){var f=this._iterateTag($(b[e]),a,c);f&&0<f.length&&(d=d.concat(f))}return d}};
x.upnp.SOAPClient=function(){var b=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("x.upnp.SOAPClient"):{log:{}}};b.prototype._getSOAPMessage=function(a){return'<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body>'+a+"</s:Body>\n</s:Envelope>"};b.prototype.doRequest=function(a,c,d,b){d=this._getSOAPMessage(d);var e=require("url").parse(a);c={host:e.hostname,port:e.port,path:e.path,
method:"POST",headers:{"Content-Type":'text/xml; charset="utf-8"',"Content-Length":d.length,SOAPACTION:c,"User-Agent":"",Connection:"close"}};var g=this,h=require("http");c.port||(c.port=80);"https"==e.protocol&&(h=require("https"),"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),c.port||(c.port=443));this._logger.log("trace","send post to url:"+a);this._logger.log("trace","with headers:"+JSON.stringify(c.headers));this._logger.log("trace","with data:"+
d);var k=b,l=h.request(c,function(a){var c="";a.setEncoding("utf8");a.on("data",function(a){c+=a});a.on("end",function(){g._logger.log("trace","http reponse status code:"+a.statusCode);g._logger.log("trace","http reponse:"+c);var d;200!=a.statusCode&&(d=Error("http reponse status code:"+a.statusCode));k&&k(d,c,a.statusCode);k=null})});l.setTimeout&&l.setTimeout(2E4,function(){l.abort()});if(l.on&&"function"==typeof l.on)l.on("error",function(a){a||(a=Error("soap request error"));g._logger.log("trace",
"soap request error:"+a.message);k&&k(a);k=null});l.write(d);l.end()};return b}();
x.upnp.Device=function(){var b=function(){this.serialNumber=this.modelDescription=this.manufacturer=this.modelName=this.deviceType=this.subtype=this.type=this.name=this.uuid=this.port=this.ip=null};b.prototype.init=function(a,c,d,b){this.ip=a;this.port=c;this.uuid=d;for(var e in b)b.hasOwnProperty(e)&&(this[e]=b[e])};b.prototype._parseItemMetaData=function(a){var c=null,d=null,b=a.find("container");b&&b[0]&&(d=$(b[0]),c=d.getAttributes(),c=JSON.parse(JSON.stringify(c)));(a=a.find("item"))&&a[0]&&
(d=$(a[0]),c=d.getAttributes(),c=JSON.parse(JSON.stringify(c)));if(d)for(d=d.children(),a=0;a<d.length;a++)if(b=$(d[a])){var f=b.prop("tagName"),g=f.indexOf(":");-1!=g&&(f=f.substr(g+1));c[f]=b.text()}return c};b.prototype._maskMetaData=function(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");a=a.replace(/\r/g,"");a=a.replace(/\n/g,"");return a=a.replace(/\t/g,"")};b.prototype._unmaskMetaData=function(a){if(!a)return a;a=a.replace(/&lt;/g,
"<");a=a.replace(/&gt;/g,">");a=a.replace(/&amp;/g,"&");a=a.replace(/&quot;/g,'"');return a=a.replace(/&apos;/g,"'")};b.prototype._parseSOAPResponse=function(a,c){if(!a)return null;try{var d=$($.parseXML(a))}catch(e){return null}return d?(a=x.upnp.Util.findTag(d,c,"u"))&&0<a.length?$(a[0]):null:null};b.prototype.getURL=function(a){var c="http://"+this.ip;this.port&&80!=this.port&&(c+=":"+this.port);return c+a};b.prototype._getDuration=function(a){var c=a.split(":");3==c.length&&(a=3600*parseInt(c[0])+
60*parseInt(c[1])+parseInt(c[2]));return a};b.prototype._doSOAPRequest=function(a,c,d,b,f){var e="<u:"+d+' xmlns:u="'+c+'">',h;for(h in b)if(b.hasOwnProperty(h)){var k=b[h]+"";e+="<"+h+">"+(k?this._maskMetaData(k):"")+"</"+h+">"}var l=this;this._doRequest(a,'"'+c+"#"+d+'"',e+("</u:"+d+">"),function(a,c){a?f&&f(a):(a=l._parseSOAPResponse(c,d+"Response"))?f&&f(null,a):f&&f(Error(d+" reponse format invalid"))})};b.prototype._doRequest=function(a,c,d,b){(new x.upnp.SOAPClient).doRequest(a,c,d,function(a,
c){b&&b(null,c)})};return b}();
x.upnp.MediaServer=function(){var b=function(){this.connectionManager=this.contentDirectory=null};b.prototype=new x.upnp.Device;b.prototype.constructor=b;b.prototype.search=function(a,c,d,b){var e=this;c||(c="dc:title,upnp:artist,upnp:album,upnp:albumArtURI,res,res@protocolInfo,res@duration,res@resolution,res@size");var g='<u:Search xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ContainerID>0</ContainerID><SearchCriteria>'+(a+"</SearchCriteria><Filter>")+(c+"</Filter><StartingIndex>")+
(d+"</StartingIndex>");g+="<RequestedCount>"+this.chunkSize+"</RequestedCount>";g+="<SortCriteria></SortCriteria>";g+="</u:Search>";(new XCUPNPSOAPRequest).doRequest(this.getURL(this.contentDirectory),'"urn:schemas-upnp-org:service:ContentDirectory:1#Search"',g,function(f){if(f=e._parseSOAPResponse(f,!0)){var g=0,h=[];try{var m=$($.parseXML(f));h=e._getItems(m);g=$(m.children()[0]).children().length}catch(n){}g==e.chunkSize?(setTimeout(function(){e.search(a,c,d+e.chunkSize,b)},0),b(h,!1)):b(h,!0)}})};
b.prototype.browseMetaData=function(a,c){this._browseMetaData(a,function(a,b){a?c&&c(a):b&&b?c&&c(a,b):c&&c(Error("meta data invalid"))})};b.prototype.browseChildren=function(a,c,b,e,f){this._browseChildren(a,"*",c,b,null,function(a,c){if(a)f&&f(a);else if(c&&c.result){a=[];for(var b=0;b<c.result.length;b++){var d=c.result[b];e&&d["class"]?"object.container"==d["class"]?a.push(d):-1!=e.indexOf(d["class"])&&a.push(d):a.push(d)}f&&f(null,a,c.totalMatches)}else f&&f(null,[],0)})};b.prototype._getRes=
function(a){var c=null,b=0;a.find("res").each(function(){var a=$(this),d=a.attr("size");if(!c||d&&d>b)c=a,b=d});return c};b.prototype._getItems=function(a){var c=[],b=this;a.find("container").each(function(){var a=$(this),d=x.upnp.Util.findTag(a,"title","dc"),g=x.upnp.Util.findTag(a,"class","upnp");if(0<g.length&&0<d.length){g=$(g[0]).text();d=$(d[0]).text();d={type:"container","class":g,parentID:a.attr("parentID"),id:a.attr("id"),title:d};if(g=b._getRes(a)){var h=g.text(),k=null;g.attr("duration")&&
(k=b._getDuration(g.attr("duration")));d.res={url:h,dur:k}}a=x.upnp.Util.findTag(a,"albumArtURI","upnp");0<a.length&&(d.albumArtURI=$(a[0]).text());c.push(d)}});a.find("item").each(function(){var a=$(this),d=x.upnp.Util.findTag(a,"class","upnp"),g=x.upnp.Util.findTag(a,"title","dc");if(0<d.length&&0<g.length){d=$(d[0]).text();g=$(g[0]).text();g={type:"item",parentID:a.attr("parentID"),id:a.attr("id"),"class":d,title:g};var h=b._getRes(a,d);if(h){var k=h.text(),l=null;h.attr("duration")&&(l=b._getDuration(h.attr("duration")));
g.res={url:k,dur:l}}0==d.indexOf("object.item.audioItem")&&(g.info={},d=x.upnp.Util.findTag(a,"genre","upnp"),0<d.length&&(g.info.genre=$(d[0]).text()),d=x.upnp.Util.findTag(a,"artist","upnp"),0<d.length&&(g.info.artist=$(d[0]).text()),d=x.upnp.Util.findTag(a,"album","upnp"),0<d.length&&(g.info.album=$(d[0]).text()),d=x.upnp.Util.findTag(a,"albumArtURI","upnp"),0<d.length&&(g.info.albumArtURI=$(d[0]).text()));c.push(g)}});return c};b.prototype._browseMetaData=function(a,c){var d=this;this._browse(a,
"BrowseMetadata","*",0,0,null,function(a,b){if(a)c&&c(a);else{if(b.result)try{var e=$($.parseXML(b.result));b.meta=d._parseItemMetaData(e)}catch(h){c&&c(h);return}c(null,b)}})};b.prototype._browseChildren=function(a,c,b,e,f,g){var d=this;this._browse(a,"BrowseDirectChildren",c,b,e,f,function(a,c){if(a)g&&g(a);else{if(c.result)try{var b=$($.parseXML(c.result));c.result=d._getItems(b)}catch(n){g&&g(n);return}g(null,c)}})};b.prototype._browse=function(a,c,b,e,f,g,h){c||(c="BrowseDirectChildren");b||
(b="");g||(g="");a={ObjectID:a,BrowseFlag:c,Filter:b,StartingIndex:e,RequestedCount:f,SortCriteria:g};this._doSOAPRequest(this.getURL(this.contentDirectory.url),this.contentDirectory.type,"Browse",a,function(a,c){if(a)h&&h(a);else{a={};var b=c.find("Result");b&&0<b.length&&(a.result=$(b[0]).text());(b=c.find("NumberReturned"))&&0<b.length&&(a.numberReturned=$(b[0]).text());(b=c.find("TotalMatches"))&&0<b.length&&(a.totalMatches=$(b[0]).text());(b=c.find("UpdateID"))&&0<b.length&&(a.updateID=$(b[0]).text());
h&&h(null,a)}})};return b}();
x.upnp.MediaRenderer=function(){var b=function(){this.avTransport=this.connectionManager=this.renderingControl=null};b.prototype=new x.upnp.Device;b.prototype.constructor=b;b.prototype.PLAY_MODE="NORMAL SHUFFLE REPEAT_ONE REPEAT_ALL RANDOM DIRECT_1 INTRO".split(" ");b.prototype.TRANSPORT_STATE="STOPPED PLAYING TRANSITIONING PAUSED_PLAYBACK PAUSED_RECORDING RECORDING NO_MEDIA_PRESENT".split(" ");b.prototype.getPlayState=function(a){this.getPlayState_cbs||(this.getPlayState_cbs=[]);var c=this.getPlayState_cbs.length;
a&&-1==this.getPlayState_cbs.indexOf(a)&&this.getPlayState_cbs.push(a);if(0==c){var b=this,e=function(a,c){var d=b.getPlayState_cbs;b.getPlayState_cbs=[];d.forEach(function(b){b&&b(a,c)})};this._getTransportInfo(0,function(a,c){e&&e(a,c?c.currentTransportState:null)})}};b.prototype.getPlayInfo=function(a){this.getPlayInfo_cbs||(this.getPlayInfo_cbs=[]);var c=this.getPlayInfo_cbs.length;a&&-1==this.getPlayInfo_cbs.indexOf(a)&&this.getPlayInfo_cbs.push(a);if(0==c){var b=function(a,c){var b=e.getPlayInfo_cbs;
e.getPlayInfo_cbs=[];b.forEach(function(b){b&&b(a,c)})},e=this;this._getPositionInfo(0,function(a,c){a?b&&b(a):(a={},c.trackDuration&&(a.duration=c.trackDuration,a.durationSec=e._getDuration(c.trackDuration)),c.relTime&&(a.position=c.relTime,a.positionSec=e._getDuration(c.relTime)),a.trackMetaDataRaw=c.trackMetaDataRaw,a.trackMetaData=c.trackMetaData,b&&b(null,a))})}};b.prototype.getMediaInfo=function(a){this.getMediaInfo_cbs||(this.getMediaInfo_cbs=[]);var c=this.getMediaInfo_cbs.length;a&&-1==this.getMediaInfo_cbs.indexOf(a)&&
this.getMediaInfo_cbs.push(a);if(0==c){var b=function(a,c){var b=e.getMediaInfo_cbs;e.getMediaInfo_cbs=[];b.forEach(function(b){b&&b(a,c)})},e=this;this._getMediaInfo(0,function(a,c){b&&b(a,c)})}};b.prototype.getPlayMode=function(a){this.getPlayMode_cbs||(this.getPlayMode_cbs=[]);var c=this.getPlayMode_cbs.length;a&&-1==this.getPlayMode_cbs.indexOf(a)&&this.getPlayMode_cbs.push(a);if(0==c){var b=function(a,c){var b=e.getPlayMode_cbs;e.getPlayMode_cbs=[];b.forEach(function(b){b&&b(a,c)})},e=this;this._getTransportSettings(0,
function(a,c){b&&b(a,c?c.playMode:null)})}};b.prototype.playResource=function(a,c,b){var d=this;this._setAVTransportURI(0,a.url,c,function(a){a?b&&b(a):d.play(b)})};b.prototype.playContainer=function(a,c,b){var d="dlna-playcontainer://"+encodeURIComponent("uuid:"+a.server_uuid)+"?sid="+encodeURIComponent("urn:upnp-org:serviceId:ContentDirectory")+"&cid="+encodeURIComponent(a.containerID)+"&md=0";"undefined"!=typeof a.firstIdx&&null!=a.firstIdx&&(d+="&fii="+a.firstIdx);var f=this;this._setAVTransportURI(0,
d,c,function(a){a?b&&b(a):f.play(b)})};b.prototype.play=function(a){this._play(0,1,a)};b.prototype.pause=function(a){this._pause(0,a)};b.prototype.stop=function(a){this._stop(0,a)};b.prototype.previous=function(a){this._previous(0,1,a)};b.prototype.next=function(a){this._next(0,1,a)};b.prototype.seekRelTime=function(a,c){this._seek(0,"REL_TIME",a,c)};b.prototype.seekRelTimeSec=function(a,c){var b=a%60,e=(a-b)/60%60;a=(a-b-60*e)/3600;for(b+="";2>b.length;)b="0"+b;for(e+="";2>e.length;)e="0"+e;for(a+=
"";2>a.length;)a="0"+a;this._seek(0,"REL_TIME",a+":"+e+":"+b,c)};b.prototype.seekTrack=function(a,b){this._seek(0,"TRACK_NR",a,b)};b.prototype.setPlayMode=function(a,b){this._setPlayMode(0,a,b)};b.prototype.mute=function(a){this._setMute(0,"Master",1,a)};b.prototype.unmute=function(a){this._setMute(0,"Master",0,a)};b.prototype.toggleMute=function(a){var b=this;this.isMuted(function(c,e){c?a&&a(c):e?b.unmute(a):b.mute(a)})};b.prototype.isMuted=function(a){this.isMuted_cbs||(this.isMuted_cbs=[]);var b=
this.isMuted_cbs.length;a&&-1==this.isMuted_cbs.indexOf(a)&&this.isMuted_cbs.push(a);if(0==b){var d=function(a,b){var c=e.isMuted_cbs;e.isMuted_cbs=[];c.forEach(function(c){c&&c(a,b)})},e=this;this._getMute(0,"Master",function(a,b){a?d&&d(a):d&&d(null,"1"==b.mute)})}};b.prototype.setVolume=function(a,b){a=parseInt(a);0>a&&(a=0);100<a&&(a=100);this._setVolume(0,"Master",a,b)};b.prototype.volumeUp=function(a){var b=this;this.getVolume(function(c,e){c||100==e?a&&a(c):b.setVolume(e+5,a)})};b.prototype.volumeDown=
function(a){var b=this;this.getVolume(function(c,e){c||0==e?a&&a(c):b.setVolume(e-5,a)})};b.prototype.getVolume=function(a){this.getVolume_cbs||(this.getVolume_cbs=[]);var b=this.getVolume_cbs.length;a&&-1==this.getVolume_cbs.indexOf(a)&&this.getVolume_cbs.push(a);if(0==b){var d=function(a,b){var c=e.getVolume_cbs;e.getVolume_cbs=[];c.forEach(function(c){c&&c(a,b)})},e=this;this._getVolume(0,"Master",function(a,b){a?d&&d(a):d&&d(null,parseInt(b.volume))})}};b.prototype._setAVTransportURI=function(a,
b,d,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",{InstanceID:a,CurrentURI:b,CurrentURIMetaData:d},e)};b.prototype._seek=function(a,b,d,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Seek",{InstanceID:a,Unit:b,Target:d},e)};b.prototype._play=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Play",{InstanceID:a,Speed:b},d)};b.prototype._pause=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),
this.avTransport.type,"Pause",{InstanceID:a},b)};b.prototype._stop=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Stop",{InstanceID:a},b)};b.prototype._previous=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Previous",{InstanceID:a,Speed:b},d)};b.prototype._next=function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Next",{InstanceID:a,Speed:b},d)};b.prototype._setPlayMode=
function(a,b,d){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetPlayMode",{InstanceID:a,NewPlayMode:b},d)};b.prototype._getTransportInfo=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportInfo",{InstanceID:a},function(a,c){if(a)b&&b(a);else{a={};var d=c.find("CurrentTransportState");0<d.length&&(a.currentTransportState=$(d[0]).text());d=c.find("CurrentTransportStatus");0<d.length&&(a.currentTransportStatus=$(d[0]).text());
d=c.find("CurrentSpeed");0<d.length&&(a.currentSpeed=$(d[0]).text());b&&b(null,a)}})};b.prototype._getPositionInfo=function(a,b){var c=this;this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetPositionInfo",{InstanceID:a},function(a,d){if(a)b&&b(a);else{a={};var e=d.find("Track");0<e.length&&(a.track=$(e[0]).text());e=d.find("TrackDuration");0<e.length&&(a.trackDuration=$(e[0]).text());e=d.find("TrackMetaData");if(0<e.length)if(e=$(e[0]).text())try{var f=$($.parseXML(e));
a.trackMetaDataRaw=f;a.trackMetaData=c._parseItemMetaData(f)}catch(k){b&&b(k);return}else a.trackMetaDataRaw="",a.trackMetaData=null;e=d.find("TrackURI");0<e.length&&(a.trackURI=$(e[0]).text());e=d.find("RelTime");0<e.length&&(a.relTime=$(e[0]).text());e=d.find("AbsTime");0<e.length&&(a.absTime=$(e[0]).text());e=d.find("RelCount");0<e.length&&(a.relCount=$(e[0]).text());e=d.find("AbsCount");0<e.length&&(a.absCount=$(e[0]).text());b&&b(null,a)}})};b.prototype._getMediaInfo=function(a,b){var c=this;
this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetMediaInfo",{InstanceID:a},function(a,d){if(a)b&&b(a);else{a={};var e=d.find("NrTracks");0<e.length&&(a.nrTracks=$(e[0]).text());e=d.find("MediaDuration");0<e.length&&(a.mediaDuration=$(e[0]).text());e=d.find("CurrentURI");0<e.length&&(a.currentURI=$(e[0]).text());e=d.find("CurrentURIMetaData");if(0<e.length)if((e=$(e[0]).text())&&"null"!=e.toLowerCase())try{var f=$($.parseXML(e));a.currentURIMetaDataRaw=f;a.currentURIMetaData=
c._parseItemMetaData(f)}catch(k){b&&b(k);return}else a.currentURIMetaDataRaw="",a.currentURIMetaData=null;e=d.find("NextURI");0<e.length&&(a.nextURI=$(e[0]).text());e=d.find("NextURIMetaData");if(0<e.length)if(e=$(e[0]).text())try{f=$($.parseXML(e)),a.nextURIMetaDataRaw=f,a.nextURIMetaData=c._parseItemMetaData(f)}catch(k){b&&b(k);return}else a.nextURIMetaDataRaw="",a.nextURIMetaData=null;e=d.find("PlayMedium");0<e.length&&(a.playMedium=$(e[0]).text());e=d.find("RecordMedium");0<e.length&&(a.ecordMedium=
$(e[0]).text());e=d.find("WriteStatus");0<e.length&&(a.writeStatus=$(e[0]).text());b&&b(null,a)}})};b.prototype._getTransportSettings=function(a,b){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportSettings",{InstanceID:a},function(a,c){if(a)b&&b(a);else{a={};var d=c.find("PlayMode");0<d.length&&(a.playMode=$(d[0]).text());d=c.find("RecQualityMode");0<d.length&&(a.recQualityMode=$(d[0]).text());b&&b(null,a)}})};b.prototype._setMute=function(a,b,d,e){this._doSOAPRequest(this.getURL(this.renderingControl.url),
this.renderingControl.type,"SetMute",{InstanceID:a,Channel:b,DesiredMute:d},e)};b.prototype._getMute=function(a,b,d){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetMute",{InstanceID:a,Channel:b},function(a,b){a?d&&d(a):(a={},b=b.find("CurrentMute"),0<b.length&&(a.mute=$(b[0]).text()),d&&d(null,a))})};b.prototype._setVolume=function(a,b,d,e){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"SetVolume",{InstanceID:a,Channel:b,
DesiredVolume:d},e)};b.prototype._getVolume=function(a,b,d){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetVolume",{InstanceID:a,Channel:b},function(a,b){a?d&&d(a):(a={},b=b.find("CurrentVolume"),0<b.length&&(a.volume=$(b[0]).text()),d&&d(null,a))})};return b}();
x.upnp.XCUPNP=function(){var b=function(){this._udpListener=new x.upnp.UDPListener;this._discoveryService=new x.upnp.DiscoveryService(this._udpListener)};b.prototype.MediaServer=x.upnp.MediaServer;b.prototype.MediaRenderer=x.upnp.MediaRenderer;b.prototype.Device=x.upnp.Device;b.prototype.DescLoader=x.upnp.DescLoader;b.prototype.discoverDevices=function(a){this.discoverTargetWithTimeout("upnp:rootdevice",5E3,a)};b.prototype.discoverDevicesWithTarget=function(a,b){this.discoverTargetWithTimeout(a,5E3,
b)};b.prototype.discoverDevicesWithTimeout=function(a,b){this.discoverTargetWithTimeout("upnp:rootdevice",a,b)};b.prototype.discoverTargetWithTimeout=function(a,b,d){this._discoveryService.addCallback(a,d);this._discoveryService.discoverTarget(a);var c=this;setTimeout(function(){c._discoveryService.removeCallback(a,d)},b)};b.prototype.getDiscoveryService=function(){return this._discoveryService};return b}();var XCUPNP=x.upnp.XCUPNP;
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.upnp.XCUPNP);
