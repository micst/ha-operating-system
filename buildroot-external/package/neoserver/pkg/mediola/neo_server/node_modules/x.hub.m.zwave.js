var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.zwave=x.hub.m.zwave||{};var ozws=require("openzwave-shared"),os=require("os");
x.hub.m.zwave.OZW=function(){var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.zwave.OZW");this._port=a;this._key=b;this._controller=null;this._initSuccess=!1;this._nodes={};this.CommandHandler=null};d.prototype._setPersistantData=function(a){if(localStorage)for(var b in a)localStorage.setItem("xnm.aio.zwave.OZW."+b,a[b])};d.prototype._evalValue=function(a,b,c){var e=1;c.instance&&(e=c.instance);this._nodes[a].states[e]||(this._nodes[a].states[e]={});50==b?"decimal"==c.type&&
(this._nodes[a].states[e].power=c.value,this._nodes[a].states[e].state||(this._nodes[a].states[e].state="0.0"==c.value?"off":"on")):37==b?this._nodes[a].states[e].state=1==c.value?"on":"off":38==b?this._nodes[a].states[e].state=c.value:67==b?this._nodes[a].states[e].setpoint=c.value:66==b?this._nodes[a].states[e].state=c.value:68==b?this._nodes[a].states[e].fanmode=c.value:69==b?this._nodes[a].states[e].fanstate=c.value:49==b&&""!=c.units&&(1==this._initSuccess&&this._controller&&this._nodes[a].states[e].temperature!=
c.value&&this._controller.writeConfig(),this._nodes[a].states[e].temperature=c.value)};d.prototype.init=function(a){this._logger.log("trace","init ozw");var b=this;this._initSuccess=!1;if(!this._controller){var c=new ozws({ConsoleOutput:!1});c.on("driver ready",function(a){b._logger.log("debug","driver ready")});c.on("driver failed",function(){b._logger.log("warn","failed to start driver");c.disconnect();b._initSuccess=!1;a&&a(!1)});c.on("value added",function(a,c,d){b._nodes[a]||(b._nodes[a]={info:{},
states:{},ready:!1});b._nodes[a].info.classes||(b._nodes[a].info.classes=[]);-1==b._nodes[a].info.classes.indexOf(c)&&b._nodes[a].info.classes.push(c);b._evalValue(a,c,d)});c.on("node ready",function(a,f){b._nodes[a]||(b._nodes[a]={info:{},states:{},ready:!1});b._nodes[a].info.classes||(b._nodes[a].info.classes={});b._nodes[a].ready=!0;b._nodes[a].info.type=f.type;b._nodes[a].info.producttype=f.producttype;b._nodes[a].info.manufacturer=f.manufacturer;b._nodes[a].info.manufacturerid=f.manufacturerid;
b._nodes[a].info.product=f.product;b._nodes[a].info.productid=f.productid;for(var e in b._nodes[a].info.classes)switch(f=b._nodes[a].info.classes[e],f){case 37:case 38:case 66:case 67:case 68:case 69:c.enablePoll(a,f)}});c.on("node added",function(a){b._logger.log("trace","added node: "+a);b._nodes[a]||(b._nodes[a]={info:{},states:{},ready:!1})});c.on("node event",function(a,c){b._logger.log("trace","event from node "+a)});c.on("value changed",function(a,c,d){b._logger.log("trace","value changed for node "+
a);b._evalValue(a,c,d);b._logger.log("trace","new state:"+JSON.stringify(b._nodes[a].states))});c.on("notification",function(a,b){});c.on("scan complete",function(){b._logger.log("trace","scan complete");b._initSuccess=!0;a&&a(!0)});this._controller=c}this._controller.connect(this._port)};d.prototype.close=function(){this._logger.log("trace","close ozw");this._controller&&(this._initSuccess=!1,this._controller.disconnect())};d.prototype.getDevices=function(a){a&&a(this._nodes);return this._nodes};
d.prototype.addNode=function(a,b,c){var e=30;c&&(e=c);if(this._controller){var d=this;setTimeout(function(){XC.debugf("addNode timeout?");d._controller.cancelControllerCommand()},1E3*e);this._controller.addNode(a)}else b(null)};d.prototype.removeNode=function(a){this._controller&&(0==this._nodes[a].ready?this._controller.removeFailedNode(a):this._controller.removeNode(a))};d.prototype.executeCommand=function(a,b,c){try{if(this._controller){var e="1";a.instance&&(e=a.instance);"switch"==a.type||"powerswitch"==
a.type?("toggle"==b&&(b="off",this._nodes[a.address].states&&this._nodes[a.address].states[e]&&"off"==this._nodes[a.address].states[e].state&&(b="on")),"on"==b?this._controller.setValue(a.address,37,e,0,!0):"off"==b&&this._controller.setValue(a.address,37,e,0,!1)):"dimmer"==a.type?(0==b.indexOf("dimTo")?(b=b.replace(/dimTo/g,""),b=b.replace(/%/g,"")):0==b.indexOf("toggleTo")&&(b=b.replace(/toggleTo/g,""),b=b.replace(/%/g,""),this._nodes[a.address]&&this._nodes[a.address].states&&this._nodes[a.address].states[e]&&
0<parseInt(this._nodes[a.address].states[e].state)&&(b="0")),100<parseInt(b)&&(b="100"),this._controller.setValue({node_id:a.address,class_id:38,instance:e,index:0},b),this._nodes[a.address].states[e].state=parseInt(b)):"HM6-HP"==a.type&&(0==b.indexOf("setTo")&&(b=b.replace(/setTo/g,"")),5>parseFloat(b)&&(b="5.0"),37<parseFloat(b)&&(b="37.0"),this._controller.setValue({node_id:a.address,class_id:67,instance:e,index:2},b),this._nodes[a.address].states[e].setpoint=b)}}catch(f){console.error(f.stack),
this._logger.log("trace","failed to execute command:"+f.message)}c&&c()};d.prototype.getAllBufferedStates=function(){var a=[],b;for(b in this._nodes)if(this._nodes.hasOwnProperty(b)){var c=this._nodes[b];if(c&&c.states)for(var e in c.states)c.states.hasOwnProperty(e)&&a.push({address:b,instance:e,state:c.states[e]})}return a};d.prototype.getStates=function(a,b,c){a={};for(var e=0;e<b.length;e++){var d=b[e];if(this._nodes[d.address]){var g="1";d.instance&&(g=d.instance);this._nodes[d.address].states[g]&&
(a[d.id]=this._nodes[d.address].states[g])}}c&&c(a);return a};d.prototype.getStateValues=function(a,b){return b};return d}();
x.hub.m.zwave.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("xnm.hub.m.zwave.Handler");this._ozw=null};util.inherits(d,EventEmitter);d.prototype.OZW=x.hub.m.zwave.OZW;d.prototype.getSystems=function(){return["zwave"]};d.prototype.init=function(a){var b=this;process.on("SIGINT",function(){b._logger.log("debug","system exiting, disconnect zwave serial connection...");b._ozw&&b._ozw.close();setTimeout(function(){process.exit()},200)});var c=require("x.hub.eventbus.js");
c.on("x.hub.peripheralman.ADD_ZWAVE",function(a){b._attachSerial(a.port)});c.on("x.hub.peripheralman.REMOVE_ZWAVE",function(a){b._removeSerial(a.port)});global.ZWAVE_PORT&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM&&this._attachSerial(global.ZWAVE_PORT);a&&a({})};d.prototype.getAllStates=function(){return this._ozw?this._ozw.getAllBufferedStates():[]};d.prototype.executeCommand=function(a,b,c){a&&a.address&&a.type?b&&b.value?this._ozw?this._ozw.executeCommand(a,b.value,function(a){c&&c({error:a})}):
c&&c({error:Error("zwave serial not initialized")}):c&&c({error:Error("command invalid")}):c&&c({error:Error("device invalid")})};d.prototype.getAllStatesLegacy=function(a){var b=[];this.getAllStates().forEach(function(a){if(a&&a.address&&a.state){var c=a.address,d=a.instance;d||(d="1");b.push({module:"zwave",type:"ZWAVE",adr:c+"."+d,state:a.state})}});a&&a({data:b})};d.prototype.executeCommandLegacy=function(a,b,c,d,f){if(a)f&&f({error:Error("not supported yet")});else if(b)if(c)if(d){a=b;var e=
"1",h=b.indexOf(".");-1!=h&&(a=b.substr(0,h),e=b.substr(h+1));this.executeCommand({address:a,instance:e,type:c},{value:d},function(a){f&&f({error:a?a.error:null})})}else f&&f({error:Error("command invalid")});else f&&f({error:Error("type invalid")});else f&&f({error:Error("address invalid")})};d.prototype._attachSerial=function(a){this._logger.log("trace","zwave usb stick attached at port:"+a);this._ozw||(this._ozw=new x.hub.m.zwave.OZW(a));this._ozw._port=a;this._logger.log("trace","init ozw at port:"+
a);this._ozw.init()};d.prototype._removeSerial=function(a){this._logger.log("trace","zwave usb stick removed from port:"+a);this._ozw&&(this._logger.log("trace","close ozw at port:"+a),this._ozw.close())};return d}();x.hub.m.zwave.Handler.prototype.getStateValues=function(d,a){return(new xnm.aio.zwave.OZW).getStateValues(d.type,a)};
x.hub.m.zwave.Handler.prototype.getDeviceCommandList=function(d,a,b){a=[];"switch"==d.type?(a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"})):"dimmer"==d.type?a.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"}):"HM6-HP"==d.type&&a.push({id:"setTo",cmd:"setTo",step:"0.5",min:"5.0",max:"37.0"});return a};x.hub.m.zwave.Handler.prototype.__getStates=function(d,a){this._ozw?this._ozw.getStates(null,d,function(b){a&&a({data:b})}):a&&a({error:Error("zwave serial not initialized")})};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zwave.Handler);
