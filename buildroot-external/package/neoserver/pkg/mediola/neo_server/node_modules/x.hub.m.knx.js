var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(c){var a=0;return function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}}};$jscomp.arrayIterator=function(c){return{next:$jscomp.arrayIteratorImpl(c)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)};$jscomp.getGlobal=function(c){c=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,c];for(var a=0;a<c.length;++a){var b=c[a];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(c,a){this.$jscomp$symbol$id_=c;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function c(b){if(this instanceof c)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+a++,b)}var a=0;return c}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.asyncIterator;c||(c=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};
$jscomp.iteratorFromArray=function(c,a){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var b=0,d={next:function(){if(b<c.length){var e=b++;return{value:a(e,c[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(c,a,b,d){if(a){b=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var e=c[d];e in b||(b[e]={});b=b[e]}c=c[c.length-1];d=b[c];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(b,c,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
var util=require("util"),EventEmitter=require("events"),crypto=require("crypto"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.knx=x.hub.m.knx||{};
x.hub.m.knx.KNXIPGateway=function(){var c=function(a,b,d,e){this._gid=a;this._ip=b;this._port=d;this._port||(this.port=3671);this._mac=e;this._serial_number=this._physical_address=this._name=null};c.prototype.getID=function(){return this._gid};c.prototype.getIP=function(){return this._ip};c.prototype.getPort=function(){return this._port};c.prototype.getMAC=function(){return this._mac};c.prototype.toJSON=function(){return{gid:this._gid,ip:this._ip,port:this._port,mac:this._mac,name:this._name,physical_address:this._physical_address,
serial_number:this._serial_number}};c.prototype.fromJSON=function(a){this._gid=a.gid;this._ip=a.ip;this._port=a.port;this._port||(this.port=3671);this._mac=a.mac;this._name=a.name;this._physical_address=a.physical_address;this._serial_number=a.serial_number};c.prototype.updateJSON=function(a){a&&a.ip&&(this._ip=a.ip,this._port=a.port,this._port||(this.port=3671),this._mac=a.mac,this._name=a.name,this._physical_address=a.physical_address,this._serial_number=a.serial_number)};c.fromJSON=function(a){if(!a||
!a.gid||!a.ip)return null;var b=new c;b.fromJSON(a);return b};return c}();
x.hub.m.knx.KNXIPDevice=function(){var c=function(a,b,d,e){this._did=a;this._type=b;this._gid=d;this._name=null;this._channels=e};c.prototype.getID=function(){return this._did};c.prototype.getGID=function(){return this._gid};c.prototype.getChannels=function(){return this._channels};c.prototype.toJSON=function(){var a={};a.did=this._did;a.data=this._type;a.gid=this._gid;a.name=this._name;a.channels=this._channels;return a};c.prototype.fromJSON=function(a){this._did=a.did;this._type=a.data;this._name=
a.name;this._gid=a.gid;this._channels=a.channels};c.prototype.updateJSON=function(a){a&&a.data&&(this._type=a.data,this._name=a.name,this._gid=a.gid,this._channels=a.channels)};c.fromJSON=function(a){if(!(a&&a.data&&a.did&&a.gid))return null;var b=new c;b.fromJSON(a);return b};return c}();
x.hub.m.knx.DeviceHandler=function(){var c=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.DeviceHandler");this._controller=a;this._gateways=[];this._devices=[]};c.prototype.IP_GATEWAY_FILE="knx_gateway.json";c.prototype.DEVICE_FILE="knx_device.json";c.prototype.init=function(a){this._logger.log("trace","init");var b=this,d=2;this._loadGateways(function(e,c){d--;e&&b._logger.log("warn","load knx ip gateways error:"+e.message);c&&(b._gateways=c);0==d&&a&&a()});this._loadDevices(function(e,
c){d--;e&&b._logger.log("warn","load knx devices error:"+e.message);c&&(b._devices=c);0==d&&a&&a()})};c.prototype.getIPGatewayObjs=function(){return this._gateways};c.prototype.getIPGatewayObj=function(a){for(var b=0;b<this._gateways.length;b++){var d=this._gateways[b];if(a==d.getID())return d}return null};c.prototype.getIPGateways=function(a){var b=[];this._gateways.forEach(function(a){a&&(a=a.toJSON())&&b.push(a)});a&&a(null,b)};c.prototype.addIPGateway=function(a,b){if(a&&a.ip){for(var d=[],e=
0;e<this._gateways.length;e++){var c=this._gateways[e];if(c){var f=c.getID(),h=c.getIP(),k=c.getMAC();d.push(f);if(h==a.ip){a=Error("find knx ip gateway with same ip");a.code="09002";b&&b(null,c.toJSON());return}if(k&&a.mac&&k==a.mac){a=Error("find knx ip gateway with mac address");a.code="09003";b&&b(a);return}}}for(c=1;-1!=d.indexOf(c);)c++;a.gid=c;var l=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(l){this._gateways.push(l);var p=this;this._saveGateways(this._gateways,function(a){a?(a.code="09006",b&&
b(a)):p._controller._monitorManager.startMonitor(l,function(){b&&b(null,l.toJSON())})})}else a=Error("json format invalid"),a.code="09001",b&&b(a)}else a=Error("json format invalid"),a.code="09001",b&&b(a)};c.prototype.updateIPGateway=function(a,b){var d=x.hub.m.knx.KNXIPGateway.fromJSON(a);if(d){var e=null;this._gateways.forEach(function(a){a&&a.getID()==d.getID()&&(e=a)});if(e){var c=e.getIP(),f=e.getPort();e.updateJSON(a)}else this._gateways.push(d);var h=this;this._saveGateways(this._gateways,
function(d){d?(d.code="09006",b&&b(d)):c!=a.ip||f!=a.port?h._controller._monitorManager.stopMonitor(e,function(){h._controller._monitorManager.startMonitor(e,function(){b&&b(null,e.toJSON())})}):b&&b(null,e.toJSON())})}else{var k=Error("json format invalid");k.code="09001";b&&b(k)}};c.prototype.deleteIPGateway=function(a,b){if(a&&a.gid){for(var d=-1,e=null,c=0;c<this._gateways.length;c++){var f=this._gateways[c];if(f&&f.getID()==a.gid){d=c;e=f;break}}if(-1==d)b&&b();else{this._gateways.splice(d,1);
var h=this;this._saveGateways(this._gateways,function(a){a?(a.code="09006",b&&b(a)):h._controller._monitorManager.stopMonitor(e,function(){b&&b()})})}}else a=Error("json format invalid"),a.code="09001",b&&b(a)};c.prototype.deleteAllIPGateway=function(a){this._gateways=[];var b=this;this._saveGateways(this._gateways,function(d){d?(d.code="09006",a&&a(d)):b._controller._monitorManager.stopAllMonitors(function(){a&&a()})})};c.prototype.getAllDevices=function(){return this._devices};c.prototype.getDevices=
function(a){var b=[];this._devices.forEach(function(a){a&&(a=a.toJSON())&&b.push(a)});a&&a(null,b)};c.prototype.addDevice=function(a,b){if(a)if(a.gid)if(this.getIPGatewayObj(a.gid)){var d=[];this._devices.forEach(function(a){a&&(a=a.getID(),d.push(a))});for(var e=1;-1!=d.indexOf(e);)e++;a.did=e;var c=x.hub.m.knx.KNXIPDevice.fromJSON(a);c?(this._devices.push(c),this._saveDevices(this._devices,function(a){a&&(a.code="09007");b&&b(a,c.toJSON())})):(a=Error("json format invalid"),a.code="09001",b&&b(a))}else a=
Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("json format invalid"),a.code="09001",b&&b(a)};c.prototype.updateDevice=function(a,b){var d=x.hub.m.knx.KNXIPDevice.fromJSON(a);if(d)if(a.gid)if(this.getIPGatewayObj(a.gid)){var e=null;this._devices.forEach(function(a){a&&a.getID()==d.getID()&&(e=a)});e?e.updateJSON(a):this._devices.push(d);this._saveDevices(this._devices,function(a){a&&(a.code=
"09007");b&&b(a,e.toJSON())})}else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("no such knx ip gateway with id:"+a.gid),a.code="09004",b&&b(a);else a=Error("json format invalid"),a.code="09001",b&&b(a)};c.prototype.deleteDevice=function(a,b){if(a&&a.did){for(var d=-1,e=null,c=0;c<this._devices.length;c++)if((e=this._devices[c])&&e.getID()==a.did){d=c;break}-1==d?b&&b():(this._devices.splice(d,1),this._saveDevices(this._devices,function(a){a&&(a.code="09007");
b&&b(a)}))}else a=Error("json format invalid"),a.code="09001",b&&b(a)};c.prototype.deleteAllDevice=function(a){this._devices=[];this._saveDevices(this._devices,function(b){b&&(b.code="09007");a&&a(b)})};c.prototype.getDeviceObj=function(a){if(!this._devices)return null;for(var b=0;b<this._devices.length;b++){var d=this._devices[b];if(d&&d.getID()==a)return d}return null};c.prototype._getGatewayFile=function(){var a=fileman.fileManager,b=require("path");a=a.getUserRootDataPath();return b.resolve(a,
this.IP_GATEWAY_FILE)};c.prototype._getDeviceFile=function(){var a=fileman.fileManager,b=require("path");a=a.getUserRootDataPath();return b.resolve(a,this.DEVICE_FILE)};c.prototype._loadGateways=function(a){var b=require("fs-extra"),d=this._getGatewayFile();b.ensureFile(d,function(e){e?a&&a(e):b.readFile(d,"utf8",function(b,d){if(b)a&&a(b);else if(d)try{var e=[];JSON.parse(d).forEach(function(a){(a=x.hub.m.knx.KNXIPGateway.fromJSON(a))&&e.push(a)});a&&a(null,e)}catch(k){a&&a(k)}else a&&a(null,[])})})};
c.prototype._saveGateways=function(a,b){var d=this._getGatewayFile(),e=[];a&&a.forEach(function(a){(a=a.toJSON())&&e.push(a)});fs_extra.writeFile(d,JSON.stringify(e,null,2),function(a){b&&b(a)})};c.prototype._loadDevices=function(a){var b=require("fs-extra"),d=this._getDeviceFile();b.ensureFile(d,function(e){e?a&&a(e):b.readFile(d,"utf8",function(b,d){if(b)a&&a(b);else if(d)try{var e=[];JSON.parse(d).forEach(function(a){(a=x.hub.m.knx.KNXIPDevice.fromJSON(a))&&e.push(a)});a&&a(null,e)}catch(k){a&&
a(k)}else a&&a(null,[])})})};c.prototype._saveDevices=function(a,b){var d=this._getDeviceFile(),e=[];a&&a.forEach(function(a){(a=a.toJSON())&&e.push(a)});fs_extra.writeFile(d,JSON.stringify(e,null,2),function(a){b&&b(a)})};return c}();
x.hub.m.knx.Monitor=function(){var c=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Monitor");this._ip=a;this._port=b;this._manager=null;this._gateways=[];this._knx=null;this._monitorState=0;this._monitorError=this._reconnTO=null;this._forceStopped=!1};c.prototype.getIP=function(){return this._ip};c.prototype.getPort=function(){return this._port};c.prototype.getKNXSession=function(){return this._knx};c.prototype.setManager=function(a){this._manager=a};c.prototype.addGateway=
function(a){if(a){for(var b=a.getID(),d=!1,e=0;e<this._gateways.length;e++){var c=this._gateways[e];if(c&&c.getID()==b){d=!0;break}}d||this._gateways.push(a)}};c.prototype.hasGateway=function(a){if(!a)return!1;a=a.getID();for(var b=!1,d=0;d<this._gateways.length;d++){var e=this._gateways[d];if(e&&e.getID()==a){b=!0;break}}return b};c.prototype.getGateways=function(){return this._gateways};c.prototype.getGatewayWithMac=function(a){if(!a)return null;for(var b=0;b<this._gateways.length;b++){var d=this._gateways[b];
if(d&&d.getMAC()==a)return d}return null};c.prototype.start=function(a){this._forceStopped=!1;if(0!=this._monitorState&&4!=this._monitorState)a&&a(Error("monitor already started"));else{this._logger.log("debug","start monitor: "+this._ip+":"+this._port);var b=this;this._knx=new (require("xnm.aio.knx.js").KNXGateway)(this._ip,null,null);this._knx.on("message",function(a,e,c){var d=c.getData();b._logger.log("debug","receive monitor message:"+d.toString("hex")+"@"+e);var g=require("x.hub.m.knx.js");
b._gateways.forEach(function(a){if(a&&a.getID())g.onMonitorMessage(a.getID(),e,d)})});this._knx.on("error",function(a){b._monitorError=a;b._logger.log("warn","monitor error:"+a.message+" + code:"+(a.code?a.code:""))});this._knx.on("close",function(){b._logger.log("warn","monitor closed");b._restart()});this._monitorState=1;this._knx.startMonitor(function(){b._monitorState=2;a&&a()})}};c.prototype.stop=function(a){this._forceStopped=!0;if(0==this._monitorState||3==this._monitorState)a&&a();else if(this._monitorState=
3,this._logger.log("debug","stop monitor: "+this._ip+":"+this._port),this._knx){var b=this;this._knx.stopMonitor(function(){b._monitorState=0;b._knx.removeAllListeners();b._knx=null;a&&a()})}else a&&a()};c.prototype.stopForGateway=function(a,b){this._logger.log("debug","stop monitor for gateway: "+a.getID());for(var d=-1,e=0;e<this._gateways.length;e++){var c=this._gateways[e];c&&c.getID()==a.getID()&&(d=e)}-1!=d&&this._gateways.splice(d,1);0==this._gateways.length?this.stop(function(){b&&b(null,
!0)}):b&&b(null,!1)};c.prototype.getState=function(){return{state:this._monitorState,error:this._monitorError}};c.prototype._restart=function(){if(0==this._gateways.length)this._monitorState=0;else if(4!=this._monitorState&&!this._forceStopped){this._logger.log("debug","try to restart monitor after 30sec");var a=this;this._monitorState=4;this._reconnTO=setTimeout(function(){a.start()},3E4)}};return c}();
x.hub.m.knx.MonitorManager=function(){var c=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.MonitorManager");this._controller=a;this._monitors={}};c.prototype.init=function(a){var b=this;if(this._controller&&this._controller._deviceHandler){var d=this._controller._deviceHandler.getIPGatewayObjs(),c=0,g=function(){c++;c<d.length&&b.startMonitor(d[c],g)};this.startMonitor(d[c],g)}a&&a()};c.prototype.startMonitor=function(a,b){if(a){var d=a.getIP(),c=a.getPort();this._startMonitor(d,
c,a,b)}else b&&b(Error("gateway is null"))};c.prototype._startMonitor=function(a,b,d,c){if(d){this._logger.log("info","start connect monitor to gateway "+d.getID()+" ("+a+":"+b+")");var e=b+"@"+a,f=this._monitors[e];f?(f.addGateway(d),c&&c()):(f=new x.hub.m.knx.Monitor(a,b),f.addGateway(d),f.setManager(this),this._monitors[e]=f,f.start(c))}else c&&c(Error("gateway is null"))};c.prototype.stopMonitor=function(a,b){var d=null,c=null,g;for(g in this._monitors){var f=this._monitors[g];if(f&&f.hasGateway(a)){d=
f;c=g;break}}if(d){var h=this;d.stopForGateway(a,function(a,d){d&&(h._logger.log("debug","monitor "+c+" stopped"),delete h._monitors[c]);b&&b(a)})}else b&&b()};c.prototype.stopAllMonitors=function(a){var b=Object.keys(this._monitors);if(0==b.length)a&&a();else{var d=0,c=this._monitors;this._monitors={};var g=function(){d++;d>=b.length?a&&a():c[b[d]].stop(g)};c[b[d]].stop(g)}};c.prototype.onFindKNX=function(a){if(a){var b=a.getIP(),d=a.getPort();a=a.getMAC();var c=d+"@"+b,g=null,f=null,h;for(h in this._monitors){var k=
this._monitors[h].getGatewayWithMac(a);if(k){g=k;f=h;break}}if(g&&f!=c){var l=this;this.stopMonitor(g,function(){l._startMonitor(b,d,g)})}}};c.prototype.listMonitors=function(a){var b=[],d;for(d in this._monitors)this._monitors.hasOwnProperty(d)&&b.push(this._monitors[d]);a&&a(null,b)};c.prototype.getMonitorForGateway=function(a){for(var b in this._monitors)if(this._monitors.hasOwnProperty(b)){var d=this._monitors[b];if(d&&d.hasGateway(a))return d}return null};return c}();
x.hub.m.knx.SearchHandler=function(){var c=require("xnm.aio.knx.js").Finder,a=function(a){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.SearchHandler");this._controller=a;var b=this;this._searchListener=function(a,d){b._onFindKNX(a,d)};this._errorListener=function(a){b._onKNXFinderError(a)};this._searching=!1;this._searchCB=[];this._searchResult=[];this._nextSearchTO=this._searchTO=null};a.SEARCH_INTERVAL=3E5;a.prototype.init=function(a){c.on("found",this._searchListener);c.on("error",
this._errorListener);this._search();a&&a()};a.prototype._onFindKNX=function(a,d){a=a.toJSON();this._logger.log("info","find knx ip gateway:"+JSON.stringify(a));if(a.hapi&&a.hapi.ip&&a.mac){var b={ip:a.hapi.ip,port:a.hapi.port,mac:a.mac,name:a.name.replace(/\0/g,""),physical_address:a.physical_address,serial_number:a.serial_number};a=new x.hub.m.knx.KNXIPGateway;a.fromJSON(b);b=!1;for(var c=0;c<this._searchResult.length;c++){var f=this._searchResult[c];f&&f.getIP()==a.getIP()&&f.getPort()==a.getPort()&&
(b=!0)}b||this._searchResult.push(a);if(this._controller&&this._controller._monitorManager)this._controller._monitorManager.onFindKNX(a,d)}};a.prototype._onKNXFinderError=function(a){this._logger.log("debug","knx finder error:"+a.message);c.stopSearchKNX();this._search()};a.prototype.search=function(a){a&&-1==this._searchCB.indexOf(a)&&this._searchCB.push(a);this._searching||this._search()};a.prototype._search=function(){this._logger.log("debug","start search knx ip gateway");this._searching=!0;this._nextSearchTO&&
(this._logger.log("trace","clear next automatic search"),clearTimeout(this._nextSearchTO),this._nextSearchTO=null);var b=this;c.startSearchKNX();this._searchTO=setTimeout(function(){b._logger.log("trace","finish searching knx ip gateway");c.stopSearchKNX();b._searching=!1;b._searchTO=null;var d=b._searchCB;b._searchCB=[];var e=b._searchResult;b._searchResult=[];b._nextSearchTO=setTimeout(function(){b._nextSearchTO=null;b._logger.log("trace","start next automatic search");b._search()},a.SEARCH_INTERVAL);
d.forEach(function(a){a&&a(null,e)})},3E3)};return a}();
x.hub.m.knx.Handler=function(){var c={sendSTAEvent:function(a){var b=require("x.hub.eventbus.js");b.emit("gatewayevent",a,{address:"KNX"},"STA");b.emit("udpevent",a,"STA")}},a=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.knx.Handler");this._deviceHandler=new this.DeviceHandler(this);this._monitorManager=new this.MonitorManager(this);this._searchHandler=new this.SearchHandler(this)};a.prototype.DeviceHandler=x.hub.m.knx.DeviceHandler;a.prototype.MonitorManager=x.hub.m.knx.MonitorManager;
a.prototype.SearchHandler=x.hub.m.knx.SearchHandler;a.prototype.init=function(a){var b=this;this._deviceHandler.init(function(){b._monitorManager.init(function(){b._searchHandler.init(function(){a&&a({})})})})};a.prototype.getSystems=function(){return["knx"]};a.prototype.addStateDevice=function(a,c){c&&c({})};a.prototype.getAllStates=function(){var a=null,c=this;this._deviceHandler.getAllDevices().forEach(function(b){var d=c.getStates(b);d&&(a||(a={}),a[b.getID()]=d)});return a};a.prototype.getStates=
function(a){return a&&a.getID()?this._getStates(a.getID()):null};a.prototype._getStates=function(a){a=this._deviceHandler.getDeviceObj(a);if(!a)return null;var b=a.getGID();if(!b)return null;b=this._deviceHandler.getIPGatewayObj(b);if(!b)return null;b=this._monitorManager.getMonitorForGateway(b);if(!b)return null;b=b.getKNXSession();return b?(a=require("xnm.aio.knx.js").KNXGateway._Device.resolve(a.toJSON()))?a.getStates(b):null:null};a.prototype.executeCommand=function(a,c,e){e&&e({error:Error("not implemented yet")})};
a.prototype._executeCommand=function(a,c,e){var b=this._deviceHandler.getDeviceObj(a);if(b){var d=b.getGID();if(d)if(a=this._deviceHandler.getIPGatewayObj(d))if(a=this._monitorManager.getMonitorForGateway(a)){var h=a.getState().state;2!=h?e&&e(Error("monitor for gateway "+d+" is in state:"+h)):(a=a.getKNXSession())?(b=require("xnm.aio.knx.js").KNXGateway._Device.resolve(b.toJSON()))?b.executeCommand(c,a,function(a){e&&e(a)}):e&&e(Error("device format invalid")):e&&e(Error("knx session for gateway "+
d+" is null"))}else e&&e(Error("no monitor for gateway with id:"+d));else e&&e(Error("no such gateway with id:"+d));else e&&e(Error("device "+a+" has no gid"))}else e&&e(Error("no such device with id:"+a))};a.prototype.executeCommandLegacy=function(a,c,e){a?c?this._executeCommand(a,c,function(a){e&&e({error:a})}):e&&e({error:Error("command invalid")}):e&&e({error:Error("address invalid")})};a.prototype.getAllStatesLegacy=function(a,c){c=[];try{var b=this.getAllStates(),d;for(d in b)b.hasOwnProperty(d)&&
c.push({type:"KNX",adr:d,state:b[d]});a&&a({data:c})}catch(f){a&&a({error:f})}};a.prototype.getIPGateways=function(a){this._deviceHandler.getIPGateways(function(b,c){a&&a({error:b,data:c})})};a.prototype.addIPGateway=function(a,c){this._deviceHandler.addIPGateway(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.updateIPGateway=function(a,c){this._deviceHandler.updateIPGateway(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.deleteIPGateway=function(a,c){this._deviceHandler.deleteIPGateway(a,
function(a){c&&c({error:a})})};a.prototype.getDevices=function(a){this._deviceHandler.getDevices(function(b,c){a&&a({error:b,data:c})})};a.prototype.addDevice=function(a,c){this._deviceHandler.addDevice(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.updateDevice=function(a,c){this._deviceHandler.updateDevice(a,function(a,b){c&&c({error:a,data:b})})};a.prototype.deleteDevice=function(a,c){this._deviceHandler.deleteDevice(a,function(a){c&&c({error:a})})};a.prototype.clean=function(a){this._monitorManager.stopAllMonitors(a)};
a.prototype.listMonitors=function(a){this._monitorManager.listMonitors(function(b,c){if(b)a&&a({error:b});else{var d=[];c.forEach(function(a){if(a){var b=a.getGateways();b&&b.forEach(function(b){if(b){var c=a.getState();b={gateway:b.getID(),monitor:{ip:a.getIP(),port:a.getPort()},state:c.state,error:c.error?c.error.message:null};d.push(b)}})}});a&&a({data:d})}})};a.prototype.reset=function(a){var b=this;this._deviceHandler.deleteAllDevice(function(){b._deviceHandler.deleteAllIPGateway(function(){a&&
a({})})})};a.prototype.searchKNXGateway=function(a){this._searchHandler.search(function(b,c){if(b)a&&a({error:b});else{var d=[];c&&c.forEach(function(a){a&&(a=a.toJSON())&&d.push(a)});a&&a({data:d})}})};a.prototype.onMonitorMessage=function(a,d,e){var b=this._deviceHandler.getAllDevices(),f=require("xnm.aio.knx.js").KNXGateway;require("x.hub.eventbus.js");var h=this;b.forEach(function(b){if(b&&b.getGID()==a){var g=b.getChannels();if(g){var k=!1,n;for(n in g)if(g.hasOwnProperty(n)){var m=g[n];if(m&&
m.event&&m.event.ga&&f._adr2long(m.event.ga)==d){k=!0;break}}k&&(g=h.getStates(b),h._logger.log("info","receive event ("+e.toString("hex")+"@"+d+") for device "+b.getID()+":"+JSON.stringify(g)),b={type:"KNX",adr:b.getID(),state:g},c.sendSTAEvent(b))}}})};return a}();module.exports=new x.hub.m.knx.Handler;
