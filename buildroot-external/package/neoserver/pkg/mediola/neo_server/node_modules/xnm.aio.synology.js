var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.synology=xnm.aio.synology||{};
xnm.aio.synology.Syno=function(){var h={},k={Auth:{path:"/auth.cgi",api:"SYNO.API.Auth",version:3,login:function(a,b){a._doApiReq({path:this.path,api:this.api,version:this.version,method:"login",account:a.username,passwd:a.password},function(c,a){c?b&&b(c):a&&a.sid?b&&b(null,a.sid):(c=Error("login response format invalid"),c.code=-1,b&&b(c))})},logout:function(a,b){a._doApiReq({path:this.path,api:this.api,version:this.version,method:"logout",account:a.username,passwd:a.password},function(a){b&&b(a)})}}},
g=function(a,b,c,d){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.synology.Syno");this.ip=a;this.port=b;this.port||(this.port=5E3);this.username=c;this.password=d};g.prototype.getPlaylist=function(a){var b=this;this._login(function(c){c?a&&a(c):g.AudioStation.Playlist.list(b,function(c,e){b._logout(function(){a&&a(c,e)})})})};g.prototype.playPlaylist=function(a,b,c){var d=this;this._login(function(e){if(e)c&&c(e);else{var f={library:a.library,
offset:0,limit:1,play:!0,id:b};g.AudioStation.RemotePlayer.updateplaylist(d,[{type:"playlist",id:a.id}],f,function(a){a?c&&c(a):(f={action:"play",value:0,id:b},g.AudioStation.RemotePlayer.control(d,f,function(b){d._logout(function(){c&&c(b)})}))})}})};g.prototype.getPlayerStatus=function(a,b){var c=this;this._login(function(d){d?b&&b(d):g.AudioStation.RemotePlayer.getstatus(c,{id:a},function(a,d){c._logout(function(){b&&b(a,d)})})})};g.prototype.stop=function(a,b){var c=this;this._login(function(d){d?
b&&b(d):g.AudioStation.RemotePlayer.control(c,{action:"stop",value:0,id:a},function(a){c._logout(function(){b&&b(a)})})})};g.prototype._getSid=function(){return h[this.ip]};g.prototype._setSid=function(a){h[this.ip]=a};g.prototype._login=function(a){var b=this;k.Auth.login(this,function(c,d){c?a&&a(c):(b._setSid(d),a&&a())})};g.prototype._logout=function(a){var b=this;k.Auth.logout(this,function(c){b._setSid(null);a&&a(c)})};g.prototype._doApiReq=function(a,b){var c=this,d=this._getSid();if(d||"SYNO.API.Auth"==
a.api||"login"==a.method){var e=[];d&&e.push("_sid="+d);for(var f in a)a.hasOwnProperty(f)&&"path"!=f&&e.push(f+"="+encodeURIComponent(a[f]));e=e.join("&");this._doRequest("GET","/webapi"+a.path+"?"+e,null,function(a,c){if(a)a.code=-1,b&&b(a);else try{var d=JSON.parse(c);d.success?b&&b(null,d.data):(a=Error("api error"),a.code=d.error?d.error.code:-1,b&&b(a))}catch(l){l.code=-1,b&&b(l)}})}else this._login(function(d){d?b&&b(d):c._doApiReq(a,b)})};g.prototype._doRequest=function(a,b,c,d){var e=this;
b="http://"+this.ip+":"+this.port+b;this._logger.log("trace","send "+a+" to url:"+b+" data:"+c);var f=d;$.ajax({url:b,type:a,timeout:this.timeout,data:c,dataType:"text",cache:!0,success:function(a){e._logger.log("trace","http request success:"+a);f&&(f(null,a),f=null)},error:function(a,b){a="http request error:"+(a?a.status:"0")+"-"+b;e._logger.log("trace",a);f&&(f(Error(a)),f=null)}})};g.API=k;g.AudioStation={Playlist:{path:"/AudioStation/playlist.cgi",api:"SYNO.AudioStation.Playlist",version:2,
list:function(a,b){a._doApiReq({path:this.path,api:this.api,version:this.version,method:"list"},function(a,d){a?b&&b(a):d&&d.playlists?b&&b(null,d.playlists):(a=Error("playlist list response format invalid"),a.code=-1,b&&b(a))})}},RemotePlayer:{path:"/AudioStation/remote_player.cgi",api:"SYNO.AudioStation.RemotePlayer",version:2,updateplaylist:function(a,b,c,d){var e={path:this.path,api:this.api,version:this.version,method:"updateplaylist"},f;for(f in c)c.hasOwnProperty(f)&&(e[f]=c[f]);e.containers_json=
JSON.stringify(b);a._doApiReq(e,function(a){d&&d(a)})},control:function(a,b,c){var d={path:this.path,api:this.api,version:this.version,method:"control"},e;for(e in b)b.hasOwnProperty(e)&&(d[e]=b[e]);a._doApiReq(d,function(a){c&&c(a)})},getstatus:function(a,b,c){var d={path:this.path,api:this.api,version:this.version,method:"getstatus"},e;for(e in b)b.hasOwnProperty(e)&&(d[e]=b[e]);a._doApiReq(d,function(a,b){a?c&&c(a):c&&c(null,b)})}}};return g}();
xnm.aio.synology.Handler=function(){var h=function(){};h.prototype.Syno=xnm.aio.synology.Syno;return h}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.synology.Handler);
