var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(f,a,d){f instanceof String&&(f=String(f));for(var e=f.length,g=0;g<e;g++){var c=f[g];if(a.call(d,c,g,f))return{i:g,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,a,d){f!=Array.prototype&&f!=Object.prototype&&(f[a]=d.value)};$jscomp.getGlobal=function(f){f=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,f];for(var a=0;a<f.length;++a){var d=f[a];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(f,a,d,e){if(a){d=$jscomp.global;f=f.split(".");for(e=0;e<f.length-1;e++){var g=f[e];g in d||(d[g]={});d=d[g]}f=f[f.length-1];e=d[f];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(d,f,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.find",function(f){return f?f:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");$jscomp.arrayIteratorImpl=function(f){var a=0;return function(){return a<f.length?{done:!1,value:f[a++]}:{done:!0}}};
$jscomp.arrayIterator=function(f){return{next:$jscomp.arrayIteratorImpl(f)}};$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(f,a){this.$jscomp$symbol$id_=f;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function f(d){if(this instanceof f)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(d||"")+"_"+a++,d)}var a=0;return f}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.iterator;f||(f=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[f]&&$jscomp.defineProperty(Array.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.asyncIterator;f||(f=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(f){$jscomp.initSymbolIterator();f={next:f};f[$jscomp.global.Symbol.iterator]=function(){return this};return f};
$jscomp.iteratorFromArray=function(f,a){$jscomp.initSymbolIterator();f instanceof String&&(f+="");var d=0,e={next:function(){if(d<f.length){var g=d++;return{value:a(g,f[g]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};$jscomp.polyfill("Array.prototype.keys",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};
xnm.aio.denon=xnm.aio.denon||{};xnm.aio.marantz=xnm.aio.marantz||{};
xnm.aio.denon.AVR=function(){var f=function(a,d){this.ip=a;this.port=d;this.port||(this.port="23");this.timeout=2E3;this.CommandHandler=this._socket=null};f.prototype._doRequest=function(a,d,e){var g=require("net");if(!this._socket){var c=null,b=[];this._socket=g.connect({port:this.port,host:this.ip});this._socket.setTimeout(this.timeout);var h=this,l=null;this._socket.on("connect",function(){var b=new Buffer(a.shift()+"\r");h._socket.write(b);e&&h._socket.setTimeout(250)});this._socket.on("data",
function(k){c=c?c+k.toString():k.toString();for(k=c.indexOf("\r");0<k;)b.push(c.substr(0,k)),c=c.substr(k+1),k=c.indexOf("\r");0<a.length?(k=new Buffer(a.shift()+"\r"),h._socket.write(k)):h._socket.setTimeout(100)});this._socket.on("error",function(b){d&&(d({error:"socket error",data:null}),d=null);h._socket&&h._socket.destroy();h._socket=null});this._socket.on("timeout",function(){h._socket.destroy();h._socket=null;d&&(l=0<b.length?{error:null,data:b}:{error:"socket timeout",data:null})});this._socket.on("close",
function(){h._socket=null;d&&l&&setTimeout(function(){d(l)},250)})}};f.prototype._executeCommand=function(a,d){this._doRequest([a],function(){d&&d()},!0)};f.prototype.executeCommand=function(a,d){var e=a,g=this;"on"==a?e="PWON":"off"==a||"standby"==a?e="PWSTANDBY":"toggle"==a&&(e=null,this.getStates(function(c){c&&"on"==c.power?g._executeCommand("PWSTANDBY",d):g._executeCommand("PWON",d)}));e&&this._executeCommand(e,d)};f.prototype.getStates=function(a){var d={mainzone:{},zone2:{}};this._doRequest("PW? MU? SI? MV? ZM? Z2MU? Z2?".split(" "),
function(e){if(e.data){for(var g=0;g<e.data.length;g++){var c=e.data[g].trim();"PW"==c.substr(0,2)?d.power=c.substr(2).toLowerCase():"MV"==c.substr(0,2)?(c=c.substr(2),3==c.length?d.mainzone.volume=(parseFloat(c)/10).toFixed(1):2==c.length&&(d.mainzone.volume=parseFloat(c).toFixed(1))):"MU"==c.substr(0,2)?d.mainzone.mute=c.substr(2).toLowerCase():"SI"==c.substr(0,2)?d.mainzone.input=c.substr(2).toLowerCase():"ZM"==c.substr(0,2)?d.mainzone.power=c.substr(2).toLowerCase():"Z2MU"==c.substr(0,4)?d.zone2.mute=
c.substr(4).toLowerCase():"Z2"==c.substr(0,2)&&("Z2ON"==c?d.zone2.power="on":"Z2OFF"==c?d.zone2.power="off":(c=c.substr(2),/^\d+$/.test(c)?3==c.length?d.zone2.volume=(parseFloat(c)/10).toFixed(1):2==c.length&&(d.zone2.volume=parseFloat(c).toFixed(1)):d.zone2.input=c.toLowerCase()))}a&&a(d)}else a&&a()})};f.prototype.getStateValues=function(a,d){return d};return f}();
xnm.aio.denon.Cache={_cache:{},_getCache:function(f){return f?this._cache[f]:null},_ensureCache:function(f){if(!f)return null;this._cache[f]||(this._cache[f]={});return this._cache[f]},getConfig:function(f){return f?(f=this._getCache(f))?f.config:null:null},setConfig:function(f,a){if(!f)return null;this._ensureCache(f).config=a}};
xnm.aio.denon.WebAVR=function(){var f=function(a,d,e,g,c){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.denon.WebAVR");this.ip=a;this.port=d;this.port||(this.port=80);this.uuid=e;this.name=g;this.model=c;this.timeout=3E3;this.CommandHandler=null};f.prototype.audioModes="DIRECT;STEREO;DOLBY DIGITAL;DTS SURROUND;AUTO;MCH STEREO;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";");f.prototype.audioModesDesc=
"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";");f.prototype.videoInputs="CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;Online Music;Bluetooth;Internetradio;Media Server;CD;PHONO;HDRADIO".split(";");f.prototype._getConfig=function(){return xnm.aio.denon.Cache.getConfig(this.ip)};f.prototype._setConfig=function(a){xnm.aio.denon.Cache.setConfig(this.ip,
a)};f.prototype.executeCommandCreator=function(a,d,e){if(d&&d.value)if("openNative"==d.value)window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?a&&"marantz"==a.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&(a&&"marantz"==a.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):
window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),e&&e();else{a="";d.path&&d.path[0]&&"global"!=d.path[0]&&(a=d.path[0]+":");var g=a+d.value;if("setInput"==d.value){if(!d.ext){e&&e(Error("command setInput ext format invalid"));return}g=a+d.ext}else if("audioMode"==d.value){if(!d.ext){e&&e(Error("command audioMode ext format invalid"));return}g=a+d.ext}else if("setTo"==d.value||"setToDB"==d.value){if(null==d.ext||"undefined"==typeof d.ext){e&&e(Error("command setTo ext format invalid"));
return}g+=d.ext}else if("customCMD"==d.value){if(!d.ext){e&&e(Error("command customCMD ext format invalid"));return}g="customCMD:"+d.ext}if("tuner"==d.value){if(null==d.ext||"undefined"==typeof d.ext){e&&e(Error("command tunerPreset ext format invalid"));return}g+=d.ext}this.executeCommand(g,function(c){if(c)e&&e(c);else{if(d.path&&d.path[0]&&"mainzone"==d.path[0]){if("on"==d.value||"off"==d.value||"toggle"==d.value){setTimeout(function(){e&&e()},1E3);return}if("setTo"==d.value||"setToDB"==d.value||
"volumeUp"==d.value||"volumeDown"==d.value){setTimeout(function(){e&&e()},10);return}}"setInput"==d.value||"audioMode"==d.value?setTimeout(function(){e&&e()},1E3):e&&e()}})}else e&&e(Error("command json format invalid"))};f.prototype.getStatesCreator=function(a,d,e){this.getStates(function(a,c){a=[];for(var b=0;b<d.length;b++)if(d[b]&&d[b].id){var h="?";if(c&&d[b].status&&d[b].status.value){var l="";d[b].status.path&&d[b].status.path[0]&&"global"!=d[b].status.path[0]&&(l=d[b].status.path[0]);var k=
d[b].status.value;l&&null!=c[l]&&"undefined"!=typeof c[l]?c[l][k]&&(h=c[l][k]):null!=c[k]&&"undefined"!=typeof c[k]&&(h=c[k])}a.push({id:d[b].id,status:h})}e&&e(null,a)})};f.prototype._doRequest=function(a,d,e,g){var c=this;d="http://"+this.ip+":"+this.port+d;this._logger.log("trace","send "+a+" to url:"+d+" data:"+e);var b=g;$.ajax({url:d,type:a,timeout:this.timeout,data:e,dataType:"text",cache:!0,success:function(h){c._logger.log("trace","http request success:"+h);setTimeout(function(){b&&(b(null,
h),b=null)},200)},error:function(h,a){h="http request error:"+(h?h.status:"0")+"-"+a;c._logger.log("trace",h);b&&(b(Error(h)),b=null)}})};f.prototype._getInputList=function(a){this._doRequest("GET","/goform/formMainZone_MainZoneXmlStatus.xml",null,function(d,e){if(d)a&&a(d);else try{var g=$($.parseXML(e));if(g){var c={inputs:[],renamed:[]};g.find("InputFuncList").each(function(){$(this).find("value").each(function(){var b=$(this).text();b&&c.inputs.push(b.trim())})});g.find("RenameSource").each(function(){$(this).find("value value").each(function(){var b=
$(this).text();b&&c.renamed.push(b.trim())})});a&&a(null,c)}else a&&a(Error("MainZoneXmlStatus.xml response invalid"))}catch(b){a&&a(b)}})};f.prototype._getStateValue=function(a,d,e,g){var c=null;a.find(d).each(function(){var b=$(this).find("value");0<b.length&&(c=$(b[0]).text())});c&&g&&(c=c.trim());c&&e&&(c=c.toLowerCase());return c};f.prototype._getOriginalInputName=function(a){var d=a,e=this._getConfig();e&&e.renamed&&e.inputs&&(a=e.renamed.indexOf(a),-1!=a&&e.inputs[a]&&(d=e.inputs[a]));return d};
f.prototype._parseStates=function(a){var d={};try{var e=$($.parseXML(a));if(e){d.mainpower=this._getStateValue(e,"Power",!0,!0);"standby"==d.mainpower&&(d.mainpower="off");d.power=this._getStateValue(e,"ZonePower",!0,!0);d.mute=this._getStateValue(e,"Mute",!0,!0);d.input=this._getStateValue(e,"InputFuncSelect",!1,!0);d.audioMode=this._getStateValue(e,"selectSurround",!1,!0);d.input&&(d.originalInput=this._getOriginalInputName(d.input));"NETWORK"==d.originalInput&&(d.netfunc=this._getStateValue(e,
"NetFuncSelect",!1,!0));switch(d.originalInput){case "CBL/SAT":d.originalInput="CBL/SAT";break;case "DVD":d.originalInput="DVD/Blu-ray";break;case "Blu-ray":d.originalInput="Blu-ray";break;case "GAME":d.originalInput="Game";break;case "Media Player":d.originalInput="Media Player";break;case "iPod/USB":d.originalInput="iPod/USB";break;case "TUNER":d.originalInput="Tuner";break;case "TV AUDIO":d.originalInput="TV Audio";break;case "NETWORK":switch(d.netfunc){case "IRADIO":d.originalInput="Internetradio";
break;case "SERVER":d.originalInput="Media Server";break;default:d.originalInput="Online Music"}}var g=this._getStateValue(e,"MasterVolume",!1,!0);d.volumeDB="--"==g?"-80.0":parseFloat(g).toFixed(1);g="--"==g?0:parseFloat(g)+80;d.volume=""+g.toFixed(1)}}catch(c){}return d};f.prototype.getStates=function(a){var d={mainzone:{},zone2:{},zone3:{}},e=this;this._getConfig()?this._doRequest("GET","/goform/formMainZone_MainZoneXml.xml",null,function(g,c){!g&&c?(d.mainzone=e._parseStates(c),d.power=d.mainzone.mainpower,
delete d.mainzone.mainpower,e._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE2",null,function(b,c){!b&&c&&(d.zone2=e._parseStates(c),delete d.zone2.mainpower);e._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE3",null,function(b,h){!b&&c&&(d.zone3=e._parseStates(h),delete d.zone3.mainpower);a&&a(b,d)})})):a&&a(g,d)}):this._getInputList(function(d,c){d?a&&a(d):(e._setConfig(c),e.getStates(a))})};f.prototype.executeCommand=function(a,d){var e=null,g=!0,c=null,
b=a.indexOf(":");0<b&&(c=a.substr(0,b),a=a.substr(b+1));b="POST";var h="/MainZone/index.put.asp",l=this;"on"==a?e="mainzone"==c?"cmd0=PutZone_OnOff%2FON":"zone2"==c?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FON":"off"==a||"standby"==a?e="mainzone"==c?"cmd0=PutZone_OnOff%2FOFF":"zone2"==c?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2":"zone2"==c?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FSTANDBY":"toggle"==
a?(g=!1,this.getStates(function(b,a){c?"mainzone"==c?a&&a.mainzone&&"on"==a.mainzone.power?l._doRequest("POST",h,"cmd0=PutZone_OnOff%2FOFF",d):l._doRequest("POST",h,"cmd0=PutZone_OnOff%2FON",d):"zone2"==c?a&&a.zone2&&"on"==a.zone2.power?l._doRequest("POST",h,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2",d):l._doRequest("POST",h,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2",d):"zone3"==c&&(a&&a.zone3&&"on"==a.zone3.power?l._doRequest("POST",h,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3",d):l._doRequest("POST",
h,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3",d)):a&&"on"==a.power?l._doRequest("POST",h,"cmd0=PutSystem_OnStandby%2FSTANDBY",d):l._doRequest("POST",h,"cmd0=PutSystem_OnStandby%2FON",d)})):"mute"==a?"zone2"==c?e="cmd0=PutVolumeMute/on&ZoneName=ZONE2":"zone3"==c?e="cmd0=PutVolumeMute/on&ZoneName=ZONE3":"mainzone"==c?e="cmd0=PutVolumeMute/on":(h="/goform/AppCommand.xml",e='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>ON</value>\r\n</tx>'):"unmute"==a?"zone2"==
c?e="cmd0=PutVolumeMute/off&ZoneName=ZONE2":"zone3"==c?e="cmd0=PutVolumeMute/off&ZoneName=ZONE3":"mainzone"==c?e="cmd0=PutVolumeMute/off":(h="/goform/AppCommand.xml",e='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>OFF</value>\r\n</tx>'):"toggleMute"==a?e="zone2"==c?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE2":"zone3"==c?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE3":"cmd0=PutVolumeMute/toggle":"volumeDown"==a?e="zone2"==c?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE2":
"zone3"==c?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/<":"volumeUp"==a?e="zone2"==c?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE2":"zone3"==c?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/>":"CBL/SAT"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SAT/CBL":"DVD/Blu-ray"==a||"DVD"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE2":"zone3"==
c?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/DVD":"Blu-ray"==a||"BD"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BD":"Game"==a||"GAME"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/GAME":"AUX"==a||"AUX1"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE2":
"zone3"==c?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX1":"AUX2"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX2":"Media Player"==a||"MPLAY"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/MPLAY":"iPod/USB"==a||"IPOD"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE2":
"zone3"==c?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/USB/IPOD":"TV Audio"==a||"TV"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TV":"Tuner"==a||"TUNER"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TUNER":"Online Music"==a||"NETHOME"==a||"NET"==a?e=
"zone2"==c?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/NETHOME":"Bluetooth"==a||"BT"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BT":"Internetradio"==a||"IRP"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/IRP":
"Media Server"==a||"SERVER"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SERVER":"CD"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE2":"zone2"==c?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/CD":"PHONO"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/PHONO":
"HDRADIO"==a?e="zone2"==c?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE2":"zone3"==c?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/HDRADIO":"Source"==a?(b="GET","zone2"==c?h="/goform/formiPhoneAppDirect.xml?Z2SOURCE":"zone2"==c&&(h="/goform/formiPhoneAppDirect.xml?Z3SOURCE")):"Quick1"==a?e="cmd0=PutUserMode/Quick1":"Quick2"==a?e="cmd0=PutUserMode/Quick2":"Quick3"==a?e="cmd0=PutUserMode/Quick3":"Quick4"==a?e="cmd0=PutUserMode/Quick4":"playPause"==a?e="cmd0=PutNetAudioCommand/CurEnter":
"previous"==a?e="cmd0=PutNetAudioCommand/CurUp":"next"==a?e="cmd0=PutNetAudioCommand/CurDown":0==a.indexOf("tuner")?(a=a.replace(/tuner/g,""),b="GET",h="/goform/formiPhoneAppTuner.xml",a="Up"==a?"PRESETUP":"Down"==a?"PRESETDOWN":"PRESETCALL0"+a,h+="?"+("zone2"==c?"2+"+a:"zone3"==c?"3+"+a:"1+"+a),e=null):-1!=this.audioModes.indexOf(a)?(b="GET",h="/goform/formiPhoneAppDirect.xml?MS"+encodeURI(a),e=null):-1!=this.audioModesDesc.indexOf(a)?(a=this.audioModes[this.audioModesDesc.indexOf(a)],b="GET",h=
"/goform/formiPhoneAppDirect.xml?MS"+encodeURI(a),e=null):"customCMD"==c?(b="GET",h=a):0==a.indexOf("setToDB")?(0==a.indexOf("setToDB")&&(a=a.replace(/setToDB/g,"")),"mainzone"==c?(a=parseFloat(a),-80>a?a=-80:18<a&&(a=18),a=a.toFixed(1),e="cmd0=PutMasterVolumeSet/"+a):"zone2"==c?(a=parseInt(a),-80>a?a=-80:18<a&&(a=18),a=a.toFixed(1),e="cmd0=PutMasterVolumeSet/"+a+"&ZoneName=ZONE2"):"zone3"==c&&(a=parseInt(a),-80>a?a=-80:18<a&&(a=18),a=a.toFixed(1),e="cmd0=PutMasterVolumeSet/"+a+"&ZoneName=ZONE3")):
c&&(0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),"mainzone"==c?(a=parseFloat(a),0>a?a=0:98<a&&(a=98),a=(a-80).toFixed(1),e="cmd0=PutMasterVolumeSet/"+a):"zone2"==c?(a=parseInt(a),0>a?a=0:80<a&&(a=80),e="cmd0=PutMasterVolumeSet/"+(a-80)+"&ZoneName=ZONE2"):"zone3"==c&&(a=parseInt(a),0>a?a=0:80<a&&(a=80),e="cmd0=PutMasterVolumeSet/"+(a-80)+"&ZoneName=ZONE3"));g&&this._doRequest(b,h,e,d)};f.prototype.getStateValues=function(a,d){return d};f.prototype.toJSON=function(){var a={sys:xnm.aio.denon.DM.SYS,
type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};this.name&&(a.name=this.name);return a};f.prototype.equalsTo=function(a){return a&&a instanceof f?this.ip==a.ip&&this.port==a.port:!1};f.parseJSON=function(a){return a.ip?new f(a.ip,a.port,a.uuid,a.name,a.model):null};return f}();
xnm.aio.denon.AVR2=function(){var f=function(){var c=function(){this._stateExpiredTime=300;this._errorStateExpiredTime=10;this._buffer={}};c.prototype.reset=function(){this._buffer={}};c.prototype.getState=function(b){var c=Math.round((new Date).getTime()/1E3);if(this._buffer[b])if(b=this._buffer[b],!b.update||null==b.value&&c-b.update>this._errorStateExpiredTime||c-b.update>this._stateExpiredTime)b.update=c,b.value=null;else return b.value;else this._buffer[b]={update:c,value:null}};c.prototype.putState=
function(b,c){var a={};a.update=Math.round((new Date).getTime()/1E3);a.value=c;this._buffer[b]=a};return c}(),a=function(){var c=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller");var b=this;this._session=new d;this._session.on("open",function(){b._state="OPEN";b._logger.log("trace","session opened");b._emitEvent("open");b._restartCloseTimeout()});this._session.on("close",function(){b._state="IDLE";b._reset();b._logger.log("trace","session closed");b._emitEvent("close")});
this._session.on("error",function(c){b._state="CONNECT";b._logger.log("trace","session error:"+c.message);b._reset()});this._session.on("event",function(c){b._logger.log("trace","receive session event:"+c);b._processAVREvent(c)});this._state="IDLE";this._stateBuffer=new f;this._listeners={};this._closeTO=null;this._closeTimeout=3E5};c.prototype.isIdle=function(){return"IDLE"==this._state};c.prototype.on=function(b,c){b&&c&&(this._listeners[b]||(this._listeners[b]=[]),-1==this._listeners[b].indexOf(c)&&
this._listeners[b].push(c))};c.prototype.off=function(b,c){b&&c&&this._listeners[b]&&(c=this._listeners[b].indexOf(c),-1!=c&&this._listeners[b].splice(c,1))};c.prototype.open=function(b){"IDLE"==this._state&&(this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller.("+b.ip+":"+b.port+")"),this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(b))};c.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state=
"CLOSED",this._session.close())};c.prototype.sendCommand=function(b,c,a){this._logger.log("trace","send command:"+b+" param:"+c);this._restartCloseTimeout();var h=this;this._session.sendCommand(b,c,function(b,c){b?h._logger.log("trace","send command failed:"+b.message):h._logger.log("trace","send command success:"+c);a&&a(b,c)})};c.prototype.getState=function(b,c){this._logger.log("trace","get state:"+b);this._restartCloseTimeout();var a=this._stateBuffer.getState(b);if("undefined"!=typeof a)this._logger.log("trace",
"get buffered state:"+a),c&&c(null,a);else{var h=this,d=b,e="?";if("CV"==d.substr(0,2))d="CV";else if("MSQUICK"==d)e=" ?";else if("VS"==d.substr(0,2))e=" ?";else if("PS"==d.substr(0,2))"PSFRONT"!=d&&(e=" ?"),"PSSWL2"==d&&(d="PSSWL");else if("PV"==d.substr(0,2))"PV"!=d&&(e=" ?");else if("TR"==d.substr(0,2))d="TR";else if("DIM"==d.substr(0,3))e=" ?";else if("Z2"==d.substr(0,2))if("Z2QUICK"==d||"Z2PSBAS"==d||"Z2PSTRE"==d)e=" ?";else{if("Z2:POWER"==d||"Z2:VOLUME"==d||"Z2:INPUT"==d)d="Z2"}else if("Z3"==
d.substr(0,2))if("Z3QUICK"==d||"Z3PSBAS"==d||"Z3PSTRE"==d)e=" ?";else if("Z3:POWER"==d||"Z3:VOLUME"==d||"Z3:INPUT"==d)d="Z3";this._logger.log("trace","do send state request:"+d);this._session.sendCommand(d,e,function(k){k?(h._logger.log("trace","get state failed:"+k.message),c&&c(k)):"CV"==d||"MS"==d||"PSSWL"==d||"TR"==d||"Z2"==d||"Z3"==d?setTimeout(function(){h._logger.log("trace","get state "+d+" success");a=h._stateBuffer.getState(b);c&&c(null,a)},250):(h._logger.log("trace","get state "+d+" success"),
a=h._stateBuffer.getState(b),c&&c(null,a))})}};c.prototype._reset=function(){this._stateBuffer.reset()};c.prototype._emitEvent=function(b,c){if(b){var a=this._listeners[b];if(a&&0<a.length)for(var d=0;d<a.length;d++){var h=a[d];try{h(c)}catch(p){this._logger.log("trace","call "+b+" listener failed, error:"+p.message)}}}};c.prototype._processAVREvent=function(b){if(b&&!(2>b.length)){var c=b.split(" ");if("CVEND"!=b&&"DC"!=b.substr(0,2)&&"SY"!=b.substr(0,2)&&"NS"!=b.substr(0,2)&&"UG"!=b.substr(0,2)){if("CV"==
b.substr(0,2)){var a=c[0];var d=c[1].trim()}else if("SV"==b.substr(0,2))a=b.substr(0,2),d=b.substr(2).trim();else if("STBY"==b.substr(0,4))a="STBY",d=b.substr(4).trim();else if("ECO"==b.substr(0,3))a="ECO",d=b.substr(3).trim();else if("SLP"==b.substr(0,3))a="SLP",d=b.substr(3).trim();else if("MS"==b.substr(0,2))"MSQUICK"==b.substr(0,7)?(a="MSQUICK",d=b.substr(7).trim()):(a=b.substr(0,2),d=b.substr(2).trim());else if("VS"==b.substr(0,2))"VSASP"==b.substr(0,5)?(a="VSASP",d=b.substr(5).trim()):"VSMONI"==
b.substr(0,6)?(a="VSMONI",d=b.substr(6).trim()):"VSSCH"==b.substr(0,5)?(a="VSSCH",d=b.substr(5).trim()):"VSSC"==b.substr(0,4)?(a="VSSC",d=b.substr(4).trim()):"VSVST"==b.substr(0,5)?(a="VSVST",d=b.substr(5).trim()):"VSAUDIO"==b.substr(0,7)?(a="VSAUDIO",d=b.substr(7).trim()):"VSVPM"==b.substr(0,5)&&(a="VSVPM",d=b.substr(5).trim());else if("PS"==b.substr(0,2))"PSSP:"==b.substr(0,5)?(a="PSSP:",d=b.substr(5).trim()):"PSTONE CTRL"==b.substr(0,11)?(a="PSTONE CTRL",d=b.substr(11).trim()):"PSCINEMA EQ."==
b.substr(0,12)?(a="PSCINEMA EQ.",d=b.substr(12).trim()):"PSMULTEQ:"==b.substr(0,9)?(a="PSMULTEQ:",d=b.substr(9).trim()):(a=c[0],d=c[1].trim());else if("PV"==b.substr(0,2))2==c.length?(a=c[0],d=c[1].trim()):(a=b.substr(0,2),d=b.substr(2).trim());else if("MN"==b.substr(0,2))a=c[0],d=c[1].trim();else if("TR"==b.substr(0,2))a=c[0],d=c[1].trim();else if("DIM"==b.substr(0,3))a=c[0],d=c[1].trim();else if("TF"==b.substr(0,2))"TFANNAME"==b.substr(0,8)?(a="TFANNAME",d=b.substr(8).trim()):"TFAN"==b.substr(0,
4)&&(a="TFAN",d=b.substr(4).trim());else if("TP"==b.substr(0,2))"TPAN"==b.substr(0,4)&&(a="TPAN",d=b.substr(4).trim());else if("TM"==b.substr(0,2)){if("TMAN"==b.substr(0,4)){a=b.substr(0,4);d=b.substr(4).trim();(b=this._stateBuffer.getState(a))||(b={});switch(d){case "AM":case "FM":b.band=d;break;case "AUTO":case "MANUAL":b.mode=d}d=b}}else if("Z2"==b.substr(0,2))if("Z2MU"==b.substr(0,4))a="Z2MU",d=b.substr(4).trim();else if("Z2STBY"==b.substr(0,6))a="Z2STBY",d=b.substr(6).trim();else if("Z2CS"==
b.substr(0,4))a="Z2CS",d=b.substr(4).trim();else if("Z2CV"==b.substr(0,4))a=c[0],d=c[1].trim();else if("Z2HPF"==b.substr(0,5))a="Z2HPF",d=b.substr(5).trim();else if("Z2PS"==b.substr(0,4))a=c[0],d=c[1].trim();else if("Z2SLP"==b.substr(0,5))a="Z2SLP",d=b.substr(5).trim();else if("Z2HDA"==b.substr(0,5))a="Z2HDA",d=b.substr(5).trim();else if(d=b.substr(2).trim(),isNaN(parseInt(d)))switch(d){case "ON":case "OFF":a="Z2:POWER";break;case "QUICK1":case "QUICK2":case "QUICK3":case "QUICK4":case "QUICK5":a=
"Z2QUICK";break;default:a="Z2:INPUT"}else a="Z2:VOLUME";else if("Z3"==b.substr(0,2))if("Z3MU"==b.substr(0,4))a="Z3MU",d=b.substr(4).trim();else if("Z3STBY"==b.substr(0,6))a="Z3STBY",d=b.substr(6).trim();else if("Z3CS"==b.substr(0,4))a="Z3CS",d=b.substr(4).trim();else if("Z3CV"==b.substr(0,4))a=c[0],d=c[1].trim();else if("Z3HPF"==b.substr(0,5))a="Z3HPF",d=b.substr(5).trim();else if("Z3PS"==b.substr(0,4))a=c[0],d=c[1].trim();else if("Z3SLP"==b.substr(0,5))a="Z3SLP",d=b.substr(5).trim();else if(d=b.substr(2).trim(),
isNaN(parseInt(d)))switch(d){case "ON":case "OFF":a="Z3:POWER";break;case "QUICK1":case "QUICK2":case "QUICK3":case "QUICK4":case "QUICK5":a="Z3QUICK";break;default:a="Z3:INPUT"}else a="Z3:VOLUME";else"MVMAX"==b.substr(0,5)?(a="MVMAX",d=b.substr(6).trim()):(a=b.substr(0,2),d=b.substr(2).trim());a&&d&&this._stateBuffer.putState(a,d)}}};c.prototype._restartCloseTimeout=function(){var b=this;null!=this._closeTO&&(clearTimeout(this._closeTO),this._closeTO=null);this._closeTO=setTimeout(function(){b._logger.log("trace",
"no activity for "+b._closeTimeout/1E3+" seconds, stop the session");b.close()},this._closeTimeout)};return c}(),d=function(){var c=function(){};c.prototype.searchAVR=function(b,c){require("x.upnp.js").discoverDevicesWithTimeout(3E3,function(a){if(0==a.name.indexOf("Denon AVR")&&a.uuid==b){var d=a.modelName;d&&"*"==d.charAt(0)&&(d=d.substr(1));c&&c(null,{ip:a.ip,uuid:a.uuid,name:a.name,model:d})}})};var b=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session._Monitor");
this._monitorCallback=this._socket=null;this._commandTimeoutCount=0;this._heartBeatTo=null;this._heatBeatMissCount=0;var b=this;this._socketErrorCallback=function(c){b._finishRun(c)};this._socketCloseCallback=function(){b._finishRun(Error("socket closed"))}};b.prototype.run=function(b,c){this._socket=b;this._monitorCallback=c;this._setListener();this.scheduleNextHeartBeat()};b.prototype.reset=function(){this._monitorCallback=null;this._heatBeatMissCount=0;this._heartBeatTo&&(clearTimeout(this._heartBeatTo),
this._heartBeatTo=null);if(this._socket){var b=this._socket;this._clearListener();this._socket=null;b.close()}};b.prototype.executeCommandTimeout=function(b){b?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),3<this._commandTimeoutCount&&this._finishRun(Error("execute command is always timeout"))):this._commandTimeoutCount=0};b.prototype.scheduleNextHeartBeat=function(b){this._scheduleNextHeartBeat(b?b:15E3)};b.prototype._scheduleNextHeartBeat=
function(b){var c=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo);this._heartBeatTo=setTimeout(function(){c._checkHeartBeat()},b)};b.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var b=this;this._socket.sendCommand("PW","?",function(c){c?(b._heatBeatMissCount++,b._logger.log("warn","check heart beat failed #"+b._heatBeatMissCount+", error:"+c.message),b._scheduleNextHeartBeat(2E3)):(b._heatBeatMissCount=0,b._scheduleNextHeartBeat(15E3));
3<b._heatBeatMissCount&&b._finishRun(Error("heart beat failed"))})}};b.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};b.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};b.prototype._finishRun=function(b){var c=this._socket;this._socket&&(this._clearListener(),this._socket=null);b&&c&&c.close();
this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null);this._heatBeatMissCount=this._commandTimeoutCount=0;this._monitorCallback&&(c=this._monitorCallback,this._monitorCallback=null,c(b))};var a=function(){this._connectCallback=this._socket=this._connectWaitTo=null;var b=this;this._socketOpenCallback=function(){b._finishConnect()};this._socketErrorCallback=function(c){b._finishConnect(c)};this._socketCloseCallback=function(){b._finishConnect(Error("socket closed"))}};
a.prototype.connect=function(b,c){this._connectCallback=c;c=b.wait;delete b.wait;this._socket=new e(b);this._setListener();if(c){var a=this;this._connectWaitTo=setTimeout(function(){a._socket.open()},c)}else this._socket.open();return this._socket};a.prototype.reset=function(){this._connectWaitTo&&clearTimeout(this._connectWaitTo);this._connectCallback=this._connectWaitTo=null;if(this._socket){var b=this._socket;this._clearListener();this._socket=null;b.close()}};a.prototype._setListener=function(){this._socket&&
(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback))};a.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback))};a.prototype._finishConnect=function(b){var c=this._socket;this._socket&&(this._clearListener(),this._socket=null);b&&c&&c.close(b);if(this._connectCallback){var a=
this._connectCallback;this._connectCallback=null;a(b,c)}};var d=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session");this._connect=new a;this._monitor=new b;this._discover=new c;var d=this;this._socketEventCallback=function(b){d._logger.log("trace","receive event:"+b);d._monitor.scheduleNextHeartBeat();d._emitEvent("event",b)};this._socket=null;this._state="IDLE";this._uuid=this._port=this._ip=null;this._eventListeners={};this._connectFailCount=0};d.prototype.on=
function(b,c){b&&c&&(this._eventListeners[b]||(this._eventListeners[b]=[]),-1==this._eventListeners[b].indexOf(c)&&this._eventListeners[b].push(c))};d.prototype.off=function(b,c){b&&c&&this._eventListeners[b]&&(c=this._eventListeners[b].indexOf(c),-1!=c&&this._eventListeners[b].splice(c,1))};d.prototype.open=function(b){b&&"IDLE"==this._state&&(this._ip=b.ip,this._port=b.port,this._uuid=b.uuid,this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session.("+this._ip+":"+this._port+")"),
this._logger.log("debug","start controller for "+this._ip),this._doFSM("init"))};d.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"))};d.prototype.sendCommand=function(b,c,a){if("IDLE"==this._state)b=Error("session not initialized"),b.sys="denon",b.code=-4,a&&a(b);else{this._logger.log("trace","send command:"+b+c+" to "+this._ip);var d=this;this._socket.sendCommand(b,c,function(b,c){b?-3==b.code?(d._monitor.scheduleNextHeartBeat(),d._monitor.executeCommandTimeout(!0)):
d._monitor.executeCommandTimeout(!1):(d._monitor.scheduleNextHeartBeat(),d._monitor.executeCommandTimeout(!1));b?d._logger.log("trace","send command failed:"+b.message):d._logger.log("trace","send command success:"+c);a&&a(b,c)})}};d.prototype._emitEvent=function(b,c){if(b){var a=this._eventListeners[b];if(a&&0<a.length)for(var d=0;d<a.length;d++){var h=a[d];try{h(c)}catch(m){this._logger.log("trace","call "+b+" listener failed, error:"+m.message)}}}};d.prototype._connectAVR=function(b){this._logger.log("trace",
"connect avr device:"+this._ip+(b?" after "+b+" ms":""));var c=this;this._socket=this._connect.connect({ip:this._ip,port:this._port,uuid:this._uuid,wait:b},function(b,a){b?(c._logger.log("trace","connect to avr device:"+c._ip+" failed, error:"+b.message),c._doFSM("conn_fail")):(c._logger.log("trace","connect to avr device:"+c._ip+" success"),c._socket=a,c._doFSM("conn_ok"))})};d.prototype._stopConnectAVR=function(){this._logger.log("trace","stop connect avr device:"+this._ip);this._connect.reset();
this._reset()};d.prototype._runAVR=function(){this._logger.log("trace","monitor avr device:"+this._ip);var b=this;this._monitor.run(this._socket,function(c){c&&(b._logger.log("trace","monitor avr device:"+b._ip+" failed, error:"+c.message),b._socket=null,b._doFSM("run_error"),b._emitEvent("error",c))});this._setListener();this._emitEvent("open")};d.prototype._stopRunAVR=function(){this._logger.log("trace","stop monitor avr device:"+this._ip);this._monitor.reset();this._clearListener();this._emitEvent("close");
this._reset()};d.prototype._searchAVR=function(){if(this._uuid){var b=this;this._discover.searchAVR(this._uuid,function(c,a){!c&&a&&a.ip!=b._ip&&(b._logger.log("trace","find avr ("+b._uuid+") with new ip:"+a.ip),"CONNECT"==b._state&&(b._ip=a.ip,b._connect.reset(),b._connectAVR()))})}};d.prototype._setListener=function(){if(this._socket)this._socket.on("event",this._socketEventCallback)};d.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback)};d.prototype._reset=
function(){this._uuid=this._port=this._ip=this._socket=null;this._connectFailCount=0};d.prototype._doFSM=function(b){this._logger.log("trace","FSM current state:"+this._state+" input:"+b);switch(this._state){case "IDLE":switch(b){case "init":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectAVR()}break;case "CONNECT":switch(b){case "conn_fail":this._connectFailCount++;this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);2<=this._connectFailCount&&
this._searchAVR();this._connectAVR(Math.min(3E4,5E3*this._connectFailCount));break;case "conn_ok":this._connectFailCount=0;this._state="RUN";this._logger.log("trace","FSM new state:"+this._state);this._runAVR();break;case "stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectAVR()}break;case "RUN":switch(b){case "run_error":this._state="CONNECT";this._logger.log("trace","FSM new state:"+this._state);this._connectAVR();break;case "stop":this._state="IDLE",
this._logger.log("trace","FSM new state:"+this._state),this._stopRunAVR()}}};return d}(),e=function(){var c=function(b){if(!b)throw Error("options is null");if(!b.ip)throw Error("no ip");this._responseTimeout=300;this._ip=b.ip;this._port=b.port;this._port||(this._port=23);this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Socket.("+this._ip+":"+this._port+")");this._timeout=2E3;this._listeners={};this._socket=null;this._buf="";this._state="IDLE";this._commands=[]};c.prototype.on=function(b,
c){b&&c&&(this._listeners[b]||(this._listeners[b]=[]),-1==this._listeners[b].indexOf(c)&&this._listeners[b].push(c))};c.prototype.off=function(b,c){b&&c&&this._listeners[b]&&(c=this._listeners[b].indexOf(c),-1!=c&&this._listeners[b].splice(c,1))};c.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var b=this;this._state="CONNECT";this._buf="";var c=require("net").connect({port:this._port,host:this._ip});c.setTimeout(this._timeout);c.setEncoding("utf8");this._logger.log("trace","start connect to "+
this._ip+":"+this._port);c.on("connect",function(){b._logger.log("trace","success to connect "+b._ip+":"+b._port);b._state="CONNECTED";b._emitEvent("open");b._executeNextCommand()});c.on("data",function(c){b._logger.log("trace","receive data: "+c.toString());b._buf+=c.toString();b._processBuffer()});c.on("error",function(c){b._logger.log("trace","socket error: "+c.message);b._emitEvent("error",c)});c.on("timeout",function(){"CONNECT"==b._state&&(b._logger.log("trace","connect timeout"),b._emitEvent("error",
Error("connect timeout")),b.close(Error("connect timeout")))});c.on("close",function(){b._logger.log("trace","socket closed");b._onClose()});c._doConnect&&"function"==typeof c._doConnect&&c._doConnect();this._socket=c}};c.prototype.close=function(b){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose(b))};c.prototype.sendCommand=function(b,c,a){if("CLOSED"==this._state)b=Error("socket closed"),b.code=-1,a&&a(b);else if(b){var d=this._commands.length;this._commands.push({command:b,
param:c,callback:a,timeout:null,state:"IDLE",responseTimeout:this._responseTimeout});0==d&&this._executeNextCommand()}else b=Error("invalid command"),b.code=-2,a&&a(b)};c.prototype._executeNextCommand=function(){var b=this._commands[0];if(b&&"IDLE"==b.state&&"CONNECTED"==this._state){var c=b.command;"undefined"!=typeof b.param&&null!=b.param&&(c+=b.param);c+="\r";b.state="SENT";this._setupReponseTimeout(b);this._logger.log("debug","send command:"+c);b=new Buffer(c);this._socket.write(b)}};c.prototype._setupReponseTimeout=
function(b){var c=this;b.timeout=setTimeout(function(){c._commands.splice(0,1);b.state="TIMEOUT";if(b.callback){c._logger.log("debug","response timeout");var a=Error("response timeout");a.code=-3;b.callback(a)}c._executeNextCommand()},b.responseTimeout)};c.prototype._emitEvent=function(b,c){if(b){var a=this._listeners[b];if(a&&0<a.length)for(var d=0;d<a.length;d++){var h=a[d];try{h(c)}catch(p){this._logger.log("trace","call "+b+" listener failed, error:"+p.message)}}}};c.prototype._processBuffer=
function(){for(var b=this._buf.indexOf("\r");-1!=b;){if(0!=b){var c=this._buf.substr(0,b);this._processResponse(c)}this._buf=this._buf.substr(b+1);b=this._buf.indexOf("\r")}};c.prototype._processResponse=function(b){this._logger.log("debug","receive response: "+b);try{this._emitEvent("event",b);var c=this._commands[0];if(c&&"SENT"==c.state&&c.command&&c.command.substr(0,2)==b.substr(0,2)){clearTimeout(c.timeout);try{c.callback&&c.callback(null,b)}catch(l){this._logger.log("debug","do command callback error: "+
l.message)}this._commands.splice(0,1);this._executeNextCommand()}}catch(l){this._logger.log("debug","process response error: "+l.message)}};c.prototype._onClose=function(b){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};b=b?b:Error("socket closed");b.code=-1;for(var c=0;c<this._commands.length;c++){var a=this._commands[c];a.timeout&&clearTimeout(a.timeout);a.callback&&a.callback(b)}this._commands=[];this._buf=""};return c}(),g=function(c){this._ip=c.ip;this._port=
c.port;this._uuid=c.uuid;this._model=c.model;this._name=c.name;this._port||(this._port=23);this._controller=new a};g.prototype.executeCommandCreator=function(c,b,a){if(b&&b.value)if("openNative"==b.value)window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?c&&"marantz"==c.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&
(c&&"marantz"==c.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),a&&a();else if("customCMD"==b.value)b.ext?(cmd="customCMD:"+b.ext,this._sendCommand(b.ext,"",function(b){a&&a(b)})):a&&a(Error("command customCMD ext format invalid"));else{var d=c=null;b.path&&b.path[0]&&(c=b.path[0]);switch(c){case "global":d=0;break;case "mainzone":d=1;break;case "zone2":d=2;break;case "zone3":d=
3}if("radio"==c)switch(b.value){case "band":this.setRadioBand(b.ext,a);break;case "previousPreset":this.previousRadioPreset(a);break;case "nextPreset":this.nextRadioPreset(a);break;case "preset":this.setRadioPreset(b.ext,a);break;default:a&&a(Error("unkonwn command"))}else switch(b.value){case "on":this.setPower(d,!0,a);break;case "off":this.setPower(d,!1,a);break;case "toggle":this.togglePower(d,a);break;case "mute":this.setMute(d,!0,a);break;case "unmute":this.setMute(d,!1,a);break;case "toggleMute":this.toggleMute(d,
a);break;case "volumeUp":this.volumeUp(d,a);break;case "volumeDown":this.volumeDown(d,a);break;case "setTo":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command json invalid"));break}this.setVolume(d,b.ext,a);break;case "setToDB":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command json invalid"));break}this.setVolumeDB(d,b.ext,a);break;case "setInput":if(!b.ext){a&&a(Error("command json invalid"));break}this.setInput(d,b.ext,a);break;case "audioMode":if(!b.ext){a&&a(Error("command json invalid"));
break}this.setSurroundMode(d,b.ext,a);break;case "quickSelect":if(!b.ext){a&&a(Error("command json invalid"));break}this.setQuickSelect(d,b.ext,a);break;default:a&&a(Error("unkonwn command"))}}else a&&a(Error("command json invalid"))};g.prototype.getStatesCreator=function(c,b,a){var d={};for(c=0;c<b.length;c++)if(b[c]&&b[c].id&&b[c].status&&b[c].status.value){var e="";b[c].status.path&&b[c].status.path[0]&&(e=b[c].status.path[0]);var g=b[c].status.value,h=g;e&&(h=e+":"+g);d[h]||(d[h]=[]);d[h].push(b[c].id)}var f=
this,q=[],m=Object.keys(d);if(m.length){var n=0,r=function(b,c){b&&(c="?");d[m[n]].forEach(function(b){q.push({id:b,status:c})});n++;n<m.length?f._getStateWithName(m[n],r):a&&a(null,q)};this._getStateWithName(m[n],r)}else a&&a(null,[])};g.prototype._getStateWithName=function(c,b){switch(c){case "global:power":case "power":this.getPower(0,b);break;case "radio:band":this.getRadioBand(b);break;case "radio:preset":this.getRadioPreset(b);break;case "mainzone:volume":this.getVolume(1,function(c,a){b(c,
a)});break;case "mainzone:volumeDB":this.getVolume(1,function(c,a,d){b(c,d)});break;case "mainzone:power":this.getPower(1,b);break;case "mainzone:mute":this.getMute(1,b);break;case "mainzone:input":this.getInput(1,b);break;case "mainzone:audioMode":this.getSurroundMode(1,b);break;case "zone2:volume":this.getVolume(2,function(c,a){b(c,a)});break;case "zone2:volumeDB":this.getVolume(2,function(c,a,d){b(c,d)});break;case "zone2:power":this.getPower(2,b);break;case "zone2:mute":this.getMute(2,b);break;
case "zone2:input":this.getInput(2,b);break;case "zone3:volume":this.getVolume(3,function(c,a){b(c,a)});break;case "zone3:volumeDB":this.getVolume(3,function(c,a,d){b(c,d)});break;case "zone3:power":this.getPower(3,b);break;case "zone3:mute":this.getMute(3,b);break;case "zone3:input":this.getInput(3,b);break;default:b(Error("unknown state key"))}};g.prototype.setPower=function(c,b,a){var d=null,e=null;switch(c){case 0:d="PW";e=b?"ON":"STANDBY";break;case 1:d="ZM";e=b?"ON":"OFF";break;case 2:d="Z2";
e=b?"ON":"OFF";break;case 3:d="Z3",e=b?"ON":"OFF"}d&&e?this._sendCommand(d,e,function(b){b?a&&a(b):setTimeout(function(){a&&a()},1E3)}):a&&a(Error("invalid command"))};g.prototype.togglePower=function(c,b){var a=this;this.getPower(c,function(d,e){d?b&&b(d):(value="on"==e?!1:!0,a.setPower(c,value,b))})};g.prototype.getPower=function(c,b){var a=null;switch(c){case 0:a="PW";break;case 1:a="ZM";break;case 2:a="Z2:POWER";break;case 3:a="Z3:POWER"}this._getState(a,function(c,a){c?b&&b(c):a?b&&b(null,"ON"==
a?"on":"off"):b&&b(null,null)})};g.prototype.volumeUp=function(c,b){var a=null;switch(c){case 1:a="MV";break;case 2:a="Z2";break;case 3:a="Z3"}a?this._sendCommand(a,"UP",function(c){b&&b(c)}):b&&b(Error("invalid command"))};g.prototype.volumeDown=function(c,b){var a=null;switch(c){case 1:a="MV";break;case 2:a="Z2";break;case 3:a="Z3"}a?this._sendCommand(a,"DOWN",function(c){b&&b(c)}):b&&b(Error("invalid command"))};g.prototype.setVolume=function(c,b,a){var d=null;switch(c){case 1:d="MV";break;case 2:d=
"Z2";break;case 3:d="Z3"}if(d){b=parseFloat(b);0>b&&(b=0);98<b&&(b=98);if(Number(b)===b&&0!==b%1)for(b=10*b+"";3>b.length;)b="0"+b;else for(b+="";2>b.length;)b="0"+b;this._sendCommand(d,b,function(b){a&&a(b)})}else a&&a(Error("invalid command"))};g.prototype.setVolumeDB=function(c,b,a){b=parseFloat(b);this.setVolume(c,b+80,a)};g.prototype.getVolume=function(c,b){var a=null;switch(c){case 1:a="MV";break;case 2:a="Z2:VOLUME";break;case 3:a="Z3:VOLUME"}this._getState(a,function(c,a){c?b&&b(c):a?(c=2>=
a.length?parseInt(a):parseInt(a)/10,b&&b(null,c,c-80)):b&&b(null,null)})};g.prototype.setMute=function(c,b,a){var d=null;b=b?"ON":"OFF";switch(c){case 1:d="MU";break;case 2:d="Z2MU";break;case 3:d="Z3MU"}d&&b?this._sendCommand(d,b,function(b){a&&a(b)}):a&&a(Error("invalid command"))};g.prototype.toggleMute=function(c,b){var a=this;this.getMute(c,function(d,e){d?b&&b(d):(value="on"==e?!1:!0,a.setMute(c,value,b))})};g.prototype.getMute=function(c,b){var a=null;switch(c){case 1:a="MU";break;case 2:a=
"Z2MU";break;case 3:a="Z3MU"}this._getState(a,function(a,c){a?b&&b(a):c?b&&b(null,"ON"==c?"on":"off"):b&&b(null,null)})};g.prototype.setInput=function(a,b,d){var c=null;switch(a){case 1:c="SI";break;case 2:c="Z2";break;case 3:c="Z3"}c&&b?this._sendCommand(c,b,function(b){d&&d(b)}):d&&d(Error("invalid command"))};g.prototype.getInput=function(c,b){var a=null;switch(c){case 1:a="SI";break;case 2:a="Z2:INPUT";break;case 3:a="Z3:INPUT"}this._getState(a,function(a,c){a?b&&b(a):b&&b(null,c)})};g.prototype.setSurroundMode=
function(a,b,d){var c=null;switch(a){case 1:c="MS"}c&&b?this._sendCommand(c,b,function(b){d&&d(b)}):d&&d(Error("invalid command"))};g.prototype.getSurroundMode=function(a,b){var c=null;switch(a){case 1:c="MS";break;case 2:c="Z2:INPUT";break;case 3:c="Z3:INPUT"}this._getState(c,function(a,c){a?b&&b(a):b&&b(null,c)})};g.prototype.setQuickSelect=function(a,b,d){var c=null,e=b;e=parseInt(b);if(!e||isNaN(e)||1>e||5<e)d&&d(Error("invalid command value"));else{e="QUICK"+e;switch(a){case 1:c="MS";break;case 2:c=
"Z2";break;case 3:c="Z3"}c&&e?this._sendCommand(c,e,function(b){d&&d(b)}):d&&d(Error("invalid command"))}};g.prototype.previousRadioPreset=function(a){this._sendCommand("TP","ANUP",function(b){a&&a(b)})};g.prototype.nextRadioPreset=function(a){this._sendCommand("TP","ANDOWN",function(b){a&&a(b)})};g.prototype.setRadioPreset=function(a,b){!a||0>parseInt(a)||56<parseInt(a)?b&&b(Error("invalid command")):(a+="",2>a.length&&(a="0"+a),this._sendCommand("TP","AN"+a,function(a){b&&b(a)}))};g.prototype.getRadioPreset=
function(a){this._getState("TPAN",function(b,c){if(b)a&&a(b);else{b="OFF"==c?null:parseInt(c);if(!b||isNaN(b))b=null;a&&a(null,b)}})};g.prototype.setRadioBand=function(a,b){var c=null;switch(a){case "am":c="ANAM";break;case "fm":c="ANFM"}c?this._sendCommand("TM",c,function(a){b&&b(a)}):b&&b(Error("invalid command"))};g.prototype.getRadioBand=function(a){this._getState("TMAN",function(b,c){if(b)a&&a(b);else{b=null;if(c)switch(c.band){case "AM":b="am";break;case "FM":b="fm"}a&&a(null,b)}})};g.prototype._sendCommand=
function(a,b,d){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.sendCommand(a,b,d)};g.prototype._getState=function(a,b){this._controller.isIdle()&&this._controller.open(this.toJSON());this._controller.getState(a,b)};g.prototype.toJSON=function(){return{sys:"denon",type:"avr2",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model,name:this._name}};g.prototype.equalsTo=function(a){return a&&a instanceof g?this._ip==a._ip&&this._port==a._port:!1};g.parseJSON=
function(a){return a&&a.ip?new g(a):null};g._Socket=e;g._Session=d;g._Controller=a;return g}();xnm.aio.marantz.WebAVR=function(f,a,d,e,g){xnm.aio.denon.WebAVR.call(this,f,a,d,e,g);this._logger=require("x.logger.js").getLogger("xnm.aio.marantz.WebAVR")};xnm.aio.marantz.WebAVR.prototype=new xnm.aio.denon.WebAVR;xnm.aio.marantz.WebAVR.prototype.constructor=xnm.aio.marantz.WebAVR;
xnm.aio.marantz.WebAVR.prototype.toJSON=function(){var f={sys:xnm.aio.denon.DM.MARANTZ_SYS,type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};this.name&&(f.name=this.name);return f};xnm.aio.marantz.WebAVR.prototype.equalsTo=function(f){return f&&f instanceof xnm.aio.marantz.WebAVR?this.ip==f.ip&&this.port==f.port:!1};xnm.aio.marantz.WebAVR.parseJSON=function(f){return f.ip?new xnm.aio.marantz.WebAVR(f.ip,f.port,f.uuid,f.name,f.model):null};
xnm.aio.denon.DM=function(){var f=function(a,e){this.code=a;this.message=e;this.stack=Error().stack};f.prototype=Error();f.prototype.name="DenonDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",
name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"Quick Select 1",ref:{value:"Quick1"}},{type:"enum",name:"Quick Select 2",ref:{value:"Quick2"}},{type:"enum",name:"Quick Select 3",ref:{value:"Quick3"}},{type:"enum",name:"Quick Select 4",ref:{value:"Quick4"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"Internetradio",
value:"netradio",children:[{type:"enum",name:"play/pause",ref:{value:"playPause"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",
ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;Online Music;Bluetooth;Internetradio;Media Server;CD;PHONO".split(";")}},
{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}},{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",
children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",
extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;Media Player;iPod/USB;Tuner;Online Music;Bluetooth;Internetradio;Media Server;Source".split(";")}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",
ext:"%d",extMeta:"1-50",scale:"1"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},
{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;Media Player;iPod/USB;Tuner;Online Music;Bluetooth;Internetradio;Media Server;Source".split(";")}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},
{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on",
"off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:"Direct;Stereo;Dolby Surrounds;DTS Surrounds;Auto;Multi Ch Stereo;Super Stadium;Rock Arena;Jazz Club;Classic Concert;Mono Movie;Matrix;Video Game;Virtual".split(";")}}]},
{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}}]},
{type:"root",name:"zone 3",value:"zone3",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:"CBL/SAT;DVD/Blu-ray;Blu-ray;Game;AUX;AUX2;Media Player;iPod/USB;TV Audio;Tuner;NETHOME;Bluetooth;Internetradio;SERVER;CD;PHONO".split(";")}}]}]},
avr2:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"tuner",value:"radio",children:[{type:"enum",name:"set band",ref:{value:"band",ext:"%e",extMeta:["am",
"fm"]}},{type:"enum",name:"previous preset",ref:{value:"previousPreset"}},{type:"enum",name:"next preset",ref:{value:"nextPreset"}},{type:"int",name:"preset",ref:{value:"preset",ext:"%d",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},
{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:"MOVIE;MUSIC;GAME;DIRECT;PURE DIRECT;STEREO;AUTO;DOLBY DIGITAL;DTS SURROUND;AURO3D;AURO2DSURR;MCH STEREO;WIDE SCREEN;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",
ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",
ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",
ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},
{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"radio",value:"radio",children:[{type:"enum",name:"band",ref:{value:"band",
options:["am","fm"]}},{type:"int",name:"current preset",ref:{value:"preset",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (db)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",
options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:"MOVIE;MUSIC;GAME;DIRECT;PURE DIRECT;STEREO;AUTO;DOLBY DIGITAL;DTS SURROUND;AURO3D;AURO2DSURR;MCH STEREO;WIDE SCREEN;SUPER STADIUM;ROCK ARENA;JAZZ CLUB;CLASSIC CONCERT;MONO MOVIE;MATRIX;VIDEO GAME;VIRTUAL".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",
ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",
children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"PHONO CD DVD BD TV SAT/CBL MPLAY GAME TUNER HDRADIO IRADIO SERVER FAVORITES AUX1 AUX2 AUX3 AUX4 AUX5 AUX6 AUX7 NET BT".split(" ")}}]}]}};
return{SYS:"denon",MARANTZ_SYS:"marantz",getIPDeviceType:function(){return[{sys:this.SYS,name:"Denon AV Receiver",type:"avr"},{sys:this.SYS,name:"Denon AV Receiver - 2018",type:"avr2"},{sys:this.MARANTZ_SYS,name:"Marantz AV Receiver",type:"avr"}]},createDevice:function(a,e,g){e=f.ERROR_CODE;a?a.ip?g(null,a):g(new f(e.INVALID,"ip is invalid")):g(new f(e.INVALID,"info is invalid"))},updateDevice:function(a,e,g){e=f.ERROR_CODE;a?a.ip?g(null,a):g(new f(e.INVALID,"ip is invalid")):g(new f(e.INVALID,"info is invalid"))},
deleteDevice:function(a,e,g){g()},applyUIFilter:function(a,e,g){var c=this,b=function(a,c,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var g=b(a.children,c,d);g&&0<g.length&&(a.children=g,e.push(a))}else{g=d.elems;if("*"==g)g=!0;else{for(var f=!1,h=0;h<g.length;h++)if(g[h]==a.type){f=!0;break}g=f}g&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},d=function(a,d){var e=[],f=c.getCommandStatusMap(a,g);if(f){var h=[];switch(d.catagory){case "command":f.command&&
(h=b(f.command,a,d));break;case "status":f.status&&(h=b(f.status,a,d))}e=e.concat(h)}return e};if(!a.sys)return null;var f=JSON.parse(JSON.stringify(a)),k=null;switch(e.catagory){case "command":k=d(a,e);f.command=k;break;case "status":k=d(a,e);f.status=k;break;default:return null}return k&&0!=k.length?f:null},getCommandStatusMap:function(d){if(!d||!d.type)return null;if(d.sys==this.MARANTZ_SYS){if(!a[d.type])return null;d=JSON.parse(JSON.stringify(a[d.type]));if(d.command&&d.command[0]&&d.command[0].children){for(var e=
-1,g=d.command[0].children,c=0;c<g.length;c++)if(g[c]&&g[c].ref&&g[c].ref.value&&"openNative"==g[c].ref.value){e=c;break}-1!=e&&(g[c].name="open marantz Remote App")}return d}return a[d.type]}}}();
xnm.aio.denon.Handler=function(){var f=function(){this.detectedAVRs={};this.detectedMarantzAVRs={}};f.prototype.AVR=xnm.aio.denon.WebAVR;f.prototype.MarantzAVR=xnm.aio.marantz.WebAVR;f.prototype.AVR2=xnm.aio.denon.AVR2;f.prototype.devicemanager=xnm.aio.denon.DM;f.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"denon");a.register(this.devicemanager.MARANTZ_SYS,"denon")};f.prototype.resolveDevice=function(a){if(!a)return null;switch(a.sys){case this.devicemanager.SYS:switch(a.type){case "avr":return this.AVR.parseJSON(a);
case "avr2":return this.AVR2.parseJSON(a);default:return null}case this.devicemanager.MARANTZ_SYS:switch(a.type){case "avr":return this.MarantzAVR.parseJSON(a);default:return null}default:return null}};f.prototype.getDeviceCommands=function(a,d){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];d&&d(null,a)};f.prototype.getDeviceStatus=function(a,d){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];d&&d(null,a)};f.prototype.doCommand=
function(a,d,e){var g=this.resolveDevice(a);g?g.executeCommandCreator(a,d,function(a){e&&e(a)}):e&&e(Error("device json format invalid"))};f.prototype.doStatus=function(a,d,e,g){var c=this.resolveDevice(d);c?c.getStatesCreator(null,[{id:a,device:d,status:e}],function(a,c){a?g&&g(a):g&&g(null,c[0])}):g&&g(Error("device json format invalid"))};f.prototype.discoverDevices=function(a){var d=require("x.upnp.js");if(d){var e=this;d.discoverDevicesWithTimeout(3E3,function(d){if(0==d.name.indexOf("Denon AVR")){var c=
d.modelName;c&&"*"==c.charAt(0)&&(c=c.substr(1));c=new xnm.aio.denon.AVR2({ip:d.ip,port:null,uuid:d.uuid,name:d.name,model:c});e.detectedAVRs["uuid:"+d.uuid]||(e.detectedAVRs["uuid:"+d.uuid]=c);a(c)}})}};f.prototype.discoverWithTimeout=function(a,d){var e={};this.discoverDevices(function(a){a&&a._uuid&&!e[a._uuid]&&(e[a._uuid]=a)});setTimeout(function(){var a=[],c;for(c in e)e.hasOwnProperty(c)&&a.push(e[c]);d&&d(null,a)},a)};f.prototype.discoverMarantz=function(a){var d=require("x.upnp.js");if(d){var e=
this;d.discoverDevicesWithTimeout(3E3,function(d){if(d.name&&0==d.name.toLowerCase().indexOf("marantz")){var c=d.modelName;c&&"*"==c.charAt(0)&&(c=c.substr(1));c=new xnm.aio.marantz.WebAVR(d.ip,null,d.uuid,d.name,c);e.detectedMarantzAVRs["uuid:"+d.uuid]||(e.detectedMarantzAVRs["uuid:"+d.uuid]=c);a(c)}})}};f.prototype.discoverMarantzWithTimeout=function(a,d){var e={};this.discoverMarantz(function(a){a&&a.uuid&&!e[a.uuid]&&(e[a.uuid]=a)});setTimeout(function(){var a=[],c;for(c in e)e.hasOwnProperty(c)&&
a.push(e[c]);d&&d(null,a)},a)};f.prototype.getStateValues=function(a,d){return(new xnm.aio.denon.WebAVR).getStateValues(a.type,d)};f.prototype.getDeviceCommandList=function(a,d,e){var f=[];if(d)f.push({id:window.XC_Text.on,cmd:"on"}),f.push({id:window.XC_Text.off,cmd:"off"});else if(e&&"avr"==a.type){f.push({id:"on",cmd:"on"});f.push({id:"off",cmd:"off"});f.push({id:"toggle",cmd:"toggle"});f.push({id:"volumeDown",cmd:"volumeDown"});f.push({id:"volumeUp",cmd:"volumeUp"});f.push({id:"mute",cmd:"mute"});
f.push({id:"unmute",cmd:"unmute"});f.push({id:"toggleMute",cmd:"toggleMute"});e=f.length;for(a=0;a<e;a++)d=JSON.parse(JSON.stringify(f[a])),d.ch="mainzone",f.push(d),d=JSON.parse(JSON.stringify(f[a])),d.ch="zone2",f.push(d);f.push({id:"set volume",cmd:"setTo",step:"0.5",max:"98",ch:"mainzone"});f.push({id:"set volume",cmd:"setTo",step:"1",max:"80",ch:"zone2"});var c=[];c.push({id:"CBLSAT",cmd:"CBLSAT"});c.push({id:"DVDBlu-ray",cmd:"DVDBlu-ray"});c.push({id:"Blu-ray",cmd:"Blu-ray"});c.push({id:"Game",
cmd:"Game"});c.push({id:"AUX",cmd:"AUX"});c.push({id:"AUX2",cmd:"AUX2"});c.push({id:"MediaPlayer",cmd:"MediaPlayer"});c.push({id:"iPodUSB",cmd:"iPodUSB"});c.push({id:"TVAudio",cmd:"TVAudio"});c.push({id:"Tuner",cmd:"Tuner"});c.push({id:"NETHOME",cmd:"NETHOME"});c.push({id:"Bluetooth",cmd:"Bluetooth"});c.push({id:"IRADIO",cmd:"IRADIO"});c.push({id:"SERVER",cmd:"SERVER"});c.push({id:"CD",cmd:"CD"});c.push({id:"PHONO",cmd:"PHONO"});c.push({id:"HDRADIO",cmd:"HDRADIO"});c.push({id:"tunerUp",cmd:"tunerUp"});
c.push({id:"tunerDown",cmd:"tunerDown"});c.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"50"});e=c.length;for(a=0;a<e;a++)d=JSON.parse(JSON.stringify(c[a])),d.ch="mainzone",f.push(d),d=JSON.parse(JSON.stringify(c[a])),d.ch="zone2",f.push(d);d=(new xnm.aio.denon.WebAVR).audioModes;for(a=0;a<d.length;a++)f.push({id:d[a],cmd:d[a]});f.push({id:"Quick1",cmd:"Quick1"});f.push({id:"Quick2",cmd:"Quick2"});f.push({id:"Quick3",cmd:"Quick3"});f.push({id:"Quick4",cmd:"Quick4"});f.push({id:"playPause",
cmd:"playPause"});f.push({id:"previous",cmd:"previous"});f.push({id:"next",cmd:"next"})}return f};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.denon.Handler);
