var m=m||{};m.aio=m.aio||{};m.aio.automation=m.aio.automation||{};m.aio.automation.Logger=null;
m.aio.automation.Task=function(){var a=function(a){this._id=a.id&&0<a.id?a.id:0;this._name=a.name;this._active=a.active?!0:!1;this._triggers=[];this._actions=[];var b;if(a.triggers)for(b=0;b<a.triggers.length;b++){var e=m.aio.automation.Trigger.parse(a.triggers[b]);e&&this._triggers.push(e)}if(a.actions)for(b=0;b<a.actions.length;b++)(e=m.aio.automation.Action.parse(a.actions[b]))&&this._actions.push(e)};a.prototype.added=function(){var a=this;this._triggers.forEach(function(b){b.added(a)});this._actions.forEach(function(b){b.added(a)})};
a.prototype.deleted=function(){var a=this;this._triggers.forEach(function(b){b.deleted(a)});this._actions.forEach(function(b){b.deleted(a)})};a.prototype.toJSON=function(){var a=[];this._triggers.forEach(function(b){a.push(b.toJSON())});var c=[];this._actions.forEach(function(a){c.push(a.toJSON())});return{id:this._id,name:this._name,active:this._active,triggers:a,actions:c}};a.parse=function(b){return b.name?new a(b):null};return a}();
m.aio.automation.Trigger=function(){var a=function(a){this._id=a.id&&0<a.id?a.id:0;this._active=a.active?!0:!1;this._condition=this._input=null;a.input&&(this._input=m.aio.automation.Input.parse(a.input));a.condition&&(this._condition=m.aio.automation.Contidion.parse(a.condition))};a.prototype.added=function(a){var b;this._input&&this._input.type&&(b=m.aio.automation.Inputhandler.getHandler(this._input.type))&&b.added&&"function"==typeof b.added&&b.added(a._id,this._id,this._input)};a.prototype.deleted=
function(a){var b;this._input&&this._input.type&&(b=m.aio.automation.Inputhandler.getHandler(this._input.type))&&b.deleted&&"function"==typeof b.deleted&&b.deleted(a._id,this._id,this._input)};a.prototype.toJSON=function(){return{id:this._id,active:this._active,input:this._input?this._input.toJSON():null,condition:this._condition?this._condition.toJSON():null}};a.parse=function(b){return b.input?new a(b):null};return a}();
m.aio.automation.Action=function(){var a=function(a){this._id=a.id&&0<a.id?a.id:0;this._active=a.active?!0:!1;this._output=null;a.output&&(this._output=m.aio.automation.Output.parse(a.output))};a.prototype.added=function(a){var b;this._output&&this._output.type&&(b=m.aio.automation.Inputhandler.getHandler(this._output.type))&&b.added&&"function"==typeof b.added&&b.added(a._id,this._id,this._output)};a.prototype.deleted=function(a){};a.prototype.toJSON=function(){return{id:this._id,active:this._active,
output:this._output?this._output.toJSON():null}};a.parse=function(b){return b.output?new a(b):null};return a}();m.aio.automation.Output=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Outputhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();
m.aio.automation.Input=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Inputhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();m.aio.automation.Contidion=function(){var a=function(a){this.type=a.type};a.parse=function(a){if(!a.type)return null;var b=m.aio.automation.Conditionhandler.getHandler(a.type);return b&&b.parse&&"function"==typeof b.parse?b.parse(a):null};return a}();
m.aio.automation.OPERATION={CREATE:"post",READ:"get",UPDATE:"put",DELETE:"delete"};m.aio.automation.Outputhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};m.aio.automation.Conditionhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};m.aio.automation.Inputhandler={_handlers:{},getHandler:function(a){return a?this._handlers[a]?this._handlers[a].handler:null:null}};
m.aio.automation.Actionhandler={execute:function(a,b,c,e,d){if(a)if(c)if(c=c.split("/"),"action"!=c[0])d&&d(Error("path invalid"));else switch(b){case m.aio.automation.OPERATION.CREATE:if(1!=c.length){d&&d(Error("path invalid"));break}this._createAction(a,e,d);break;case m.aio.automation.OPERATION.READ:1==c.length?this._readActions(a,d):this._readAction(a,c[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=c.length){d&&d(Error("path invalid"));break}this._updateAction(a,c[1],e,d);break;case m.aio.automation.OPERATION.DELETE:if(2!=
c.length){d&&d(Error("path invalid"));break}this._deleteAction(a,c[1],d);break;default:d&&d(Error("no such operation"))}else d&&d(Error("path invalid"));else d&&d(Error("task invalid"))},_findAction:function(a,b){for(var c=b.length;c--;)if(b[c]&&b[c]._id==a)return b[c];return null},_createAction:function(a,b,c){var e=m.aio.automation.Action.parse(b);if(e){b=1;for(var d=-1,f=0;f<a._actions.length;f++){if(a._actions[f]._id!=b){d=f;break}b++}e._id=b;d=-1==d?a._actions.length:d;a._actions.splice(d,0,
e);this._saveTasks(function(b){b?a._actions.splice(d,1):e.added(a);c&&c(b,b?null:e.toJSON())})}else c&&c(Error("data invalid"))},_readActions:function(a,b){for(var c=[],e=0;e<a._actions.length;e++){var d=a._actions[e]?a._actions[e].toJSON():null;d&&c.push(d)}b&&b(null,c)},_readAction:function(a,b,c){a=this._findAction(b,a._actions);c&&c(a?null:Error("no such actoin"),a?a.toJSON():null)},_updateAction:function(a,b,c,e){for(var d,f=a._actions.length;f--;)if(a._actions[f]&&a._actions[f]._id==b){d=a._actions[f];
break}if(d){var g=m.aio.automation.Action.parse(c);g?g._id&&g._id==d._id?(a._actions.splice(f,1,g),this._saveTasks(function(b){b?a._actions.splice(f,1,d):(d.deleted(a),g.added(a));e&&e(b,b?null:g.toJSON())})):e&&e(Error("new action id invalid")):e&&e(Error("data invalid"))}else e&&e(Error("no such action"))},_deleteAction:function(a,b,c){for(var e=a._actions.length,d;e--;)if(a._actions[e]&&a._actions[e]._id==b){d=a._actions[e];break}d?(a._actions.splice(e,1),this._saveTasks(function(b){b?a._actions.splice(e,
0,d):d.deleted(a);c&&c(b)})):c&&c(Error("no such action"))},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},fireAction:function(a,b){if(a&&a._active&&a._output&&a._output.type){var c=m.aio.automation.Outputhandler.getHandler(a._output.type);c&&c.execute&&"function"==typeof c.execute?c.execute(a._output,function(){b&&b()}):b&&b()}else b&&b()}};
m.aio.automation.Triggerhandler={execute:function(a,b,c,e,d){if(a)if(c)if(c=c.split("/"),"trigger"!=c[0])d&&d(Error("path invalid"));else switch(b){case m.aio.automation.OPERATION.CREATE:if(1!=c.length){d&&d(Error("path invalid"));break}this._createTrigger(a,e,d);break;case m.aio.automation.OPERATION.READ:1==c.length?this._readTriggers(a,d):this._readTrigger(a,c[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=c.length){d&&d(Error("path invalid"));break}this._updateTrigger(a,c[1],e,d);break;
case m.aio.automation.OPERATION.DELETE:if(2!=c.length){d&&d(Error("path invalid"));break}this._deleteTrigger(a,c[1],d);break;default:d&&d(Error("no such operation"))}else d&&d(Error("path invalid"));else d&&d(Error("task invalid"))},_findTrigger:function(a,b){for(var c=b.length;c--;)if(b[c]&&b[c]._id==a)return b[c];return null},_createTrigger:function(a,b,c){var e=m.aio.automation.Trigger.parse(b);if(e){b=1;for(var d=-1,f=0;f<a._triggers.length;f++){if(a._triggers[f]._id!=b){d=f;break}b++}e._id=b;
d=-1==d?a._triggers.length:d;a._triggers.splice(d,0,e);this._saveTasks(function(b){b?a._triggers.splice(d,1):e.added(a);c&&c(b,b?null:e.toJSON())})}else c&&c(Error("data invalid"))},_readTriggers:function(a,b){for(var c=[],e=0;e<a._triggers.length;e++){var d=a._triggers[e]?a._triggers[e].toJSON():null;d&&c.push(d)}b&&b(null,c)},_readTrigger:function(a,b,c){a=this._findTrigger(b,a._triggers);c&&c(a?null:Error("no such trigger"),a?a.toJSON():null)},_updateTrigger:function(a,b,c,e){for(var d,f=a._triggers.length;f--;)if(a._triggers[f]&&
a._triggers[f]._id==b){d=a._triggers[f];break}if(d){var g=m.aio.automation.Trigger.parse(c);g?g._id&&g._id==d._id?(a._triggers.splice(f,1,g),this._saveTasks(function(b){b?a._triggers.splice(f,1,d):(d.deleted(a),g.added(a));e&&e(b,b?null:g.toJSON())})):e&&e(Error("new trigger id invalid")):e&&e(Error("data invalid"))}else e&&e(Error("no such trigger"))},_deleteTrigger:function(a,b,c){for(var e=a._triggers.length,d;e--;)if(a._triggers[e]&&a._triggers[e]._id==b){d=a._triggers[e];break}d?(a._triggers.splice(e,
1),this._saveTasks(function(b){b?a._triggers.splice(e,0,d):d.deleted(a);c&&c(b)})):c&&c(Error("no such trigger"))},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},fireTrigger:function(a,b,c){var e=this._findTrigger(b,a._triggers);e&&e._active&&(e._condition&&e._condition.match&&"function"==typeof e._condition.match?e._condition.match(c,function(c){c&&(m.aio.automation.Logger.log("trace","fire trigger "+b+" in task "+a._id),m.aio.automation.Taskhandler.fireTask(a._id))}):(m.aio.automation.Logger.log("trace",
"fire trigger "+b+" in task "+a._id),m.aio.automation.Taskhandler.fireTask(a._id)))}};
m.aio.automation.Taskhandler={_firedTask:{},execute:function(a,b,c,e,d){if(a)if(c)if(a=c.split("/"),"task"!=a[0])d&&d(Error("path invalid"));else{var f=this;if(2<a.length){if(!a[1]||!a[1].match(/^\d+$/)){d&&d(Error("path invalid"));return}c=this._findTask(a[1],m.aio.automation.Manager._tasks);if(!c){d&&d(Error("no such task"));return}a.splice(0,2);switch(a[0]){case "trigger":m.aio.automation.Triggerhandler.execute(c,b,a.join("/"),e,function(a,b){a?d&&d(a):f._saveTasks(function(a){d&&d(a,b)})});return;
case "action":m.aio.automation.Actionhandler.execute(c,b,a.join("/"),e,function(a,b){a?d&&d(a):f._saveTasks(function(a){d&&d(a,b)})});return;default:d&&d(Error("path invalid"));return}}switch(b){case m.aio.automation.OPERATION.CREATE:if(1!=a.length){d&&d(Error("path invalid"));break}this._createTask(e,d);break;case m.aio.automation.OPERATION.READ:1==a.length?this._readTasks(d):this._readTask(a[1],d);break;case m.aio.automation.OPERATION.UPDATE:if(2!=a.length){d&&d(Error("path invalid"));break}this._updateTask(a[1],
e,d);break;case m.aio.automation.OPERATION.DELETE:if(2!=a.length){d&&d(Error("path invalid"));break}this._deleteTask(a[1],d);break;default:d&&d(Error("no such operation"))}}else d&&d(Error("path invalid"));else d&&d(Error("tasks invalid"))},_findTask:function(a,b){for(var c=b.length;c--;)if(b[c]&&b[c]._id==a)return b[c];return null},_saveTasks:function(a){m.aio.automation.Manager.saveDatabase(a)},_createTask:function(a,b){var c=m.aio.automation.Manager._tasks,e=m.aio.automation.Task.parse(a);if(e)if(e._name){a=
1;for(var d=-1,f,g=0;g<c.length;g++)if(c[g]._id==a?a++:-1==d&&(d=g),c[g]&&c[g]._name==e._name){f=c[g];break}f?b&&b(Error("another task has the same name")):(e._id=a,d=-1==d?c.length:d,c.splice(d,0,e),this._saveTasks(function(a){a?c.splice(d,1):e.added();b&&b(a,a?null:e.toJSON())}))}else b&&b(Error("new task name invalid"));else b&&b(Error("data invalid"))},_readTasks:function(a){for(var b=m.aio.automation.Manager._tasks,c=[],e=0;e<b.length;e++){var d=b[e]?b[e].toJSON():null;d&&c.push(d)}a&&a(null,
c)},_readTask:function(a,b){a=this._findTask(a,m.aio.automation.Manager._tasks);b&&b(a?null:Error("no such task"),a?a.toJSON():null)},_updateTask:function(a,b,c){var e=m.aio.automation.Manager._tasks,d=this._findTask(a,e);if(d)if(a=m.aio.automation.Task.parse(b))if(a._id&&a._id==d._id){b=e.length;for(var f;b--;)if(e[b]&&e[b]._id!=d._id&&e[b]._name!=a._name){f=e[b];break}if(f)c&&c(Error("another task has the same name"));else{var g=d._name,k=d._active;d._name=a._name;d._active=a._active;this._saveTasks(function(a){a&&
(d._name=g,d._active=k);c&&c(a,a?null:d.toJSON())})}}else c&&c(Error("new task id invalid"));else c&&c(Error("data invalid"));else c&&c(Error("no such task"))},_deleteTask:function(a,b){for(var c=m.aio.automation.Manager._tasks,e=c.length,d;e--;)if(c[e]&&c[e]._id==a){d=c[e];break}d?(m.aio.automation.Manager._tasks.splice(e,1),this._saveTasks(function(a){a?m.aio.automation.Manager._tasks.splice(e,0,d):d.deleted();b&&b(a)})):b&&b(Error("no such task"))},tasks2json:function(a){var b=[];a.forEach(function(a){a&&
b.push(a.toJSON())});return b},json2tasks:function(a){var b=[];a.forEach(function(a){(a=m.aio.automation.Task.parse(a))&&b.push(a)});return b},getInputs:function(a){var b=[];m.aio.automation.Manager._tasks.forEach(function(c){c&&c._triggers&&c._triggers.forEach(function(e){e&&e._input&&e._input.type==a&&b.push({taskId:c._id,triggerId:e._id,input:e._input})})});return b},fireTask:function(a){var b=this._findTask(a,m.aio.automation.Manager._tasks);if(b&&b._active){var c=(new Date).getTime(),e=this._firedTask[b._id];
if(!e||1E3<Math.abs(c-e))this._firedTask[b._id]=c,m.aio.automation.Logger.log("trace","fire task "+a),this._executeNextAction(0,b._actions)}},_executeNextAction:function(a,b){if(b&&0!=b.length&&!(b.length<a+1)){var c=b[a],e=this;c?m.aio.automation.Actionhandler.fireAction(c,function(){a+=1;e._executeNextAction(a,b)}):(a+=1,this._executeNextAction(a,b))}}};
m.aio.automation.Devicehandler={DEVICE:"device_db",DEVICE_INFO:"deviceinfo.xml",_folder:null,_fm:null,_dm:null,init:function(a,b,c){this._fm=a;this._folder=b;this._dm=require("m.aio.devicemanager.js");this._loadDeviceManager(function(){c&&c()})},uploadDevice:function(a,b){var c=this,e=require("fs-extra"),d=this._getDevicePath();e.writeFile(d,JSON.stringify(a),function(a){a?b&&b(a):(c._dm.handlers=[],c._loadDeviceManager(function(a){b&&b(a)}))})},uploadDeviceinfo:function(a,b){var c=this,e=require("fs-extra"),
d=this._getDeviceinfoPath();e.writeFile(d,a,function(a){a?b&&b(a):(c._dm.handlers=[],c._loadDeviceManager(function(a){b&&b(a)}))})},_loadDeviceManager:function(a){var b=this;this._dm._loadTenant({index:1,getFolderPath:function(){var a=require("path");return b._fm.getUserRootDataPath()+a.sep+b._folder}},function(b){a&&a(b)})},_getDevicePath:function(){return this._getFilePath(this.DEVICE)},_getDeviceinfoPath:function(){return this._getFilePath(this.DEVICE_INFO)},_getFilePath:function(a){if(!this._fm)return null;
var b=require("path");return this._fm.getUserRootDataPath()+b.sep+this._folder+b.sep+a},getDevices:function(a,b){this._dm.execute("readWithoutLicense",1,"device",a,b)},getGateway:function(a,b){this._dm?this._dm.execute("readWithoutLicense",1,"gateway",{filter:"prop","info.sys":a},function(a,e){b&&b(a,e)}):b&&b(Error("device manager is null"))}};
m.aio.automation.Manager={FOLDER:"automation",DB:"db",_modules:[],_fm:null,_tasks:[],init:function(a,b){if(a&&a.fileManager){m.aio.automation.Logger=require("x.logger.js").getLogger("m.aio.automation");var c=this;this._fm=a.fileManager;if(a.modules)for(var e=0;e<a.modules.length;e++){var d=a.modules[e];d&&d.dir&&d.handler&&d.handler.init&&"function"==typeof d.handler.init&&(this._modules.push({id:e+1,dir:d.dir,handler:d.handler}),d.handler.init(e+1,this))}(a=this._getDbPath())?require("fs-extra").ensureFile(a,
function(a){a?b&&b(a):m.aio.automation.Devicehandler.init(c._fm,c.FOLDER,function(){c.loadDatabase(function(){c._modules.forEach(function(a){a&&a.handler&&a.handler.initFinish&&"function"==typeof a.handler.initFinish&&a.handler.initFinish()});b&&b()})})}):b&&b(Error("database file invalid"))}else b&&b(Error("argument error"))},saveDatabase:function(a){var b=this._getDbPath();if(b){var c=require("fs"),e=m.aio.automation.Taskhandler.tasks2json(this._tasks);c.writeFile(b,JSON.stringify(e),function(b){a&&
a(b)})}else a&&a(Error("database file invalid"))},loadDatabase:function(a){var b=this._getDbPath();if(b){var c=this;require("fs").readFile(b,{encoding:"utf8"},function(b,d){if(b)a&&a(b);else{if(d)try{var e=JSON.parse(d);Array.isArray(e)&&(e=m.aio.automation.Taskhandler.json2tasks(e))&&(c._tasks=e)}catch(g){}a&&a()}})}else a&&a(Error("database file invalid"))},_getDbPath:function(){if(!this._fm)return null;var a=require("path");return this._fm.getUserRootDataPath()+a.sep+this.FOLDER+a.sep+this.DB},
_getModule:function(a){for(var b=0;b<this._modules.length;b++)if(this._modules[b]&&this._modules[b].id==a)return this._modules[b];return null},registInputHandler:function(a,b,c,e){if(!(a&&b&&c&&e)||m.aio.automation.Inputhandler._handlers[b])return!1;m.aio.automation.Inputhandler._handlers[b]={id:a,handler:c,ui:e};return!0},registConditionHandler:function(a,b,c,e){if(!(a&&b&&c&&e)||m.aio.automation.Conditionhandler._handlers[b])return!1;m.aio.automation.Conditionhandler._handlers[b]={id:a,handler:c,
ui:e};return!0},registOutputHandler:function(a,b,c,e){if(!(a&&b&&c&&e)||m.aio.automation.Outputhandler._handlers[b])return!1;m.aio.automation.Outputhandler._handlers[b]={id:a,handler:c,ui:e};return!0},getInputs:function(a){return m.aio.automation.Taskhandler.getInputs(a)},fireTrigger:function(a,b,c){(a=m.aio.automation.Taskhandler._findTask(a,this._tasks))&&m.aio.automation.Triggerhandler.fireTrigger(a,b,c)}};
m.aio.automation.Handler=function(){var a=function(){};a.prototype.init=function(a,c){a&&a.fileManager?m.aio.automation.Manager.init(a,c):c&&c(Error("invalid params"))};a.prototype.execute=function(a,c,e,d){m.aio.automation.Taskhandler.execute(m.aio.automation.Manager._tasks,a,c,e,d)};a.prototype.getUiJs=function(a,c){if(!c)return null;var b=require("path");switch(a){case "input":var d=m.aio.automation.Inputhandler._handlers[c];break;case "output":d=m.aio.automation.Outputhandler._handlers[c];break;
case "condition":d=m.aio.automation.Conditionhandler._handlers[c]}return d&&d.id&&d.handler&&d.ui?(a=m.aio.automation.Manager._getModule(d.id))&&a.dir?a.dir+b.sep+d.ui:null:null};a.prototype.listUiJs=function(){var a={input:[],condition:[],output:[]},c,e;for(e in m.aio.automation.Inputhandler._handlers)m.aio.automation.Inputhandler._handlers.hasOwnProperty(e)&&(c=m.aio.automation.Inputhandler._handlers[e])&&c.ui&&a.input.push({type:e,js:"/js/automation/input/"+e+"/ui.js"});for(e in m.aio.automation.Conditionhandler._handlers)m.aio.automation.Conditionhandler._handlers.hasOwnProperty(e)&&
(c=m.aio.automation.Conditionhandler._handlers[e])&&c.ui&&a.condition.push({type:e,js:"/js/automation/condition/"+e+"/ui.js"});for(e in m.aio.automation.Outputhandler._handlers)m.aio.automation.Outputhandler._handlers.hasOwnProperty(e)&&(c=m.aio.automation.Outputhandler._handlers[e])&&c.ui&&a.output.push({type:e,js:"/js/automation/output/"+e+"/ui.js"});return a};a.prototype.uploadDevice=function(a,c){m.aio.automation.Devicehandler.uploadDevice(a,c)};a.prototype.uploadDeviceinfo=function(a,c){m.aio.automation.Devicehandler.uploadDeviceinfo(a,
c)};a.prototype.onHttpGetInput=function(a,c,e,d,f){var b=f;if(f=m.aio.automation.Manager.getInputs("http"))for(var k=f.length,h=0;h<f.length;h++)f[h].input&&f[h].input.test(f[h],{path:a,query:c,username:e,password:d},function(a){k--;a&&b&&(b(),b=null);0==k&&b&&b(Error("no matched http input"))})};a.prototype.getDevices=function(a,c){m.aio.automation.Devicehandler.getDevices(a,c)};a.prototype.getGateway=function(a,c){m.aio.automation.Devicehandler.getGateway(a,c)};return a}();
"undefined"!=typeof module&&(module.exports=new m.aio.automation.Handler);
