var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.mystrom=xnm.aio.mystrom||{};
xnm.aio.mystrom.WifiDevice=function(){var e=function(b,g,a){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiDevice");this.ip=b;this.port=g;this.uuid=a;this.port||(this.port=80);this.timeout=2E3};e.prototype.executeCommandCreator=function(b,g,a){g&&g.value?this.executeCommand(g,function(b){a&&a(b)}):a&&a(Error("command value is empty"))};e.prototype.getStatesCreator=function(b,a,d){this.getStates(function(b,g){b=[];for(var n=
0;n<a.length;n++)if(a[n]&&a[n].id&&g&&a[n].status&&a[n].status.value){var f=g[a[n].status.value];"undefined"!=typeof f&&null!=f&&b.push({id:a[n].id,status:f})}d&&d(null,b)})};e.prototype._doRequest=function(b,a,d,e,c){var g=a,f;a="http://"+this.ip+":"+this.port+a;if(d){var q=[];for(f in d)if(d.hasOwnProperty(f)){var h=f+"=";var l=d[f];"undefined"!=typeof l&&null!=l&&(h+=encodeURIComponent(l));q.push(h)}a+="?"+q.join("&");g+="?"+q.join("&")}d="";if(e){h=[];for(f in e)e.hasOwnProperty(f)&&h.push(f+
"="+e[f]);d=h.join("&")}this._logger.log("trace","send "+b+" to url:"+a+" with data:"+d);b={host:this.ip,port:this.port,path:g,method:b,headers:{"Content-Type":'application/x-www-form-urlencoded; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};d&&(b.headers["Content-Length"]=d.length);var p=this,k=c,m=require("http").request(b,function(b){var a="";b.setEncoding("utf-8");b.on("data",function(b){a+=b});b.on("end",function(){p._logger.log("trace","recevice "+b.statusCode+" response:"+a);
if(a)try{var g=JSON.parse(a);k&&(k(null,b.statusCode,g),k=null)}catch(r){k&&(k(r,b.statusCode),k=null)}else k&&(k(null,b.statusCode,""),k=null)})});m.setTimeout(this.timeout,function(){p._logger.log("trace","http request timeout");m.abort();k&&(k(Error("timeout")),k=null)});m.on("error",function(b){p._logger.log("trace","http request error:"+b.message);k&&(k(b),k=null)});d&&m.write(d);m.end()};e.prototype.toJSON=function(){return{ip:this.ip,port:this.port,uuid:this.uuid}};e.build=function(b){if(!b||
!b.type||!b.ip)return null;switch(b.type){case "switch":return new a(b.ip,b.port,b.uuid);case "bulb":return new d(b.ip,b.port,b.uuid);case "strip":return new c(b.ip,b.port,b.uuid);case "button":return new h(b.ip,b.port,b.uuid)}};var a=function(b,a,d){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiSwitch");e.call(this,b,a,d)};a.prototype=new e;a.prototype.constructor=a;a.prototype.executeCommand=function(b,a){if(b){switch(b.value){case "on":b="/relay";var d={state:1};break;case "off":b=
"/relay";d={state:0};break;case "toggle":b="/toggle";break;default:a&&a(Error("unknown command"));return}this._doRequest("GET",b,d,null,a)}else a&&a(Error("command object is null"))};a.prototype.getStates=function(b){this._doRequest("GET","/report",null,null,function(a,d,e){a?b&&b(a):e?(e.state=e.relay?"on":"off",b&&b(null,e)):b&&b(Error("get states result invalid"))})};a.prototype.toJSON=function(){var b=e.prototype.toJSON.call(this);b.type="switch";return b};a.prototype.equalsTo=function(b){return b&&
b instanceof a?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var d=function(b,a,d){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");e.call(this,b,a,d);this._stateBufferTS=this._stateBuffer=null};d.prototype=new e;d.prototype.constructor=d;d.prototype.executeCommand=function(b,a){if(b)if(this.uuid){var d=this,e="/api/v1/device/"+this.uuid.toUpperCase(),c=null;switch(b.value){case "on":c={action:"on"};break;
case "off":c={action:"off"};break;case "toggle":c={action:"toggle"};break;case "white":this.getStatesIncludBuffer(function(b,c){b?a&&a(b):(b=100,c&&c.color&&(c=c.color.split(";"),b=3>c.length?c[1]:c[2]),d._doRequest("POST",e,void 0,{mode:"mono",color:"18;"+b},a))});return;case "dimTo":case "dimUp":case "dimDown":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(c,g){if(c)a&&a(c);else if(g&&g.color){c=g.color.split(";");var f=2==
c.length?c[1]:c[2];switch(b.value){case "dimTo":f=parseInt(b.ext);break;case "dimUp":f=parseInt(f)+parseInt(b.ext);break;case "dimDown":f=parseInt(f)-parseInt(b.ext)}0>f&&(f=0);100<f&&(f=100);2==c.length?c[1]=f:c[2]=f;d._doRequest("POST",e,void 0,{action:"on",ramp:g.ramp,color:c.join(";")},a)}else a&&a(Error("can not get color state"))});return;case "setCT":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(c,g){if(c)a&&a(c);else{c=
parseInt(b.ext);var f=100;1>c&&(c=1);18<c&&(c=18);g&&g.color&&(g=g.color.split(";"),f=3>g.length?g[1]:g[2]);d._doRequest("POST",e,void 0,{mode:"mono",color:c+";"+f},a)}});return;case "setRGB":if("undefined"==typeof b.ext||null==b.ext){a&&a(Error("command ext is null"));return}this.getStatesIncludBuffer(function(c,g){if(c)a&&a(c);else{c=parseInt(b.ext.substr(0,2),16);var f=parseInt(b.ext.substr(2,2),16),h=parseInt(b.ext.substr(4,2),16);c/=255;f/=255;h/=255;var l=Math.max(c,f,h),p=Math.min(c,f,h),k=
l-p;if(l==p)var m=0;else{switch(l){case c:m=(f-h)/k+(f<h?6:0);break;case f:m=(h-c)/k+2;break;case h:m=(c-f)/k+4}m/=6}m=[m,0==l?0:k/l,l];c=[];g&&g.color&&(c=g.color.split(";"),3>c.length&&(c[2]=c[1]));c[0]=Math.round(360*m[0]);c[1]=Math.round(100*m[1]);c[2]||(c[2]=Math.round(100*m[2]));d._doRequest("POST",e,void 0,{color:c.join(";")},a)}});return;default:a&&a(Error("unknown command"));return}this._doRequest("POST",e,void 0,c,a)}else a&&a(Error("mac address is null"));else a&&a(Error("command object is null"))};
d.prototype.getStates=function(b){if(this.uuid){var a=this;this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(c,d,e){if(c)b&&b(c);else if(e)if(c=e[a.uuid.toUpperCase()]){c.state=c.on?"on":"off";if(d=c.color)d=d.split(";"),2==d.length?(c.ct=parseInt(d[0]),c.level=parseInt(d[1])):c.level=parseInt(d[2]);a._stateBuffer=c;a._stateBufferTS=(new Date).getTime();b&&b(null,c)}else b&&b(Error("get states result do not contain this device"));else b&&b(Error("get states result invalid"))})}else b&&
b(Error("mac address in null"))};d.prototype.getStatesIncludBuffer=function(b){var a=(new Date).getTime();this._stateBuffer&&this._stateBufferTS&&3E4>a-this._stateBufferTS?b&&b(null,this._stateBuffer):(this._stateBufferTS=this._stateBuffer=null,this.getStates(b))};d.prototype.toJSON=function(){var b=e.prototype.toJSON.call(this);b.type="bulb";return b};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var c=function(b,a,c){this._logger=
require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb");e.call(this,b,a,c);this._stateBufferTS=this._stateBuffer=null};c.prototype=new d;c.prototype.constructor=c;c.prototype.toJSON=function(){var b=d.prototype.toJSON.call(this);b.type="strip";return b};c.prototype.equalsTo=function(b){return b&&b instanceof c?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};var h=function(b,a,c){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiButton");e.call(this,b,a,c)};h.prototype=
new e;h.prototype.constructor=h;h.prototype.getInfo=function(b){this.uuid?this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(a,c,d){a?b&&b(a):d?b&&b(null,d):b&&b(Error("get info result invalid"))}):b&&b(Error("mac address in null"))};h.prototype.toJSON=function(){var b=e.prototype.toJSON.call(this);b.type="button";return b};h.prototype.equalsTo=function(b){return b&&b instanceof h?this.ip==b.ip&&this.port==b.port&&this.uuid==b.uuid:!1};e.Switch=a;e.Bulb=d;e.Strip=c;
e.Button=h;return e}();
xnm.aio.mystrom.Discovery=function(){var e=function(){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.Discovery");this._devices={};this._callbacks=[];this._searchTimeout=null;this._sockets=[]};e.prototype.start=function(a,d){d||(d=function(){});if(!a||0>a)a=1E4;var c=this._callbacks.length;-1==this._callbacks.indexOf(d)&&this._callbacks.push(d);if(!c){var e=this;this._searchTimeout=setTimeout(function(){e._searchFinish()},a);this._searchStart()}};e.prototype._searchStart=function(){this._logger.log("debug",
"start search for devices");var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var d in a){for(var c=a[d],e=0;e<c.length;e++)this._addDiscoverSocket(7979,c[e]);this._addDiscoverSocket(7979,null)}}else this._addDiscoverSocket(7979,null);var b=this;(d=require("x.upnp.js"))&&d.discoverDevices(function(a){if(0==a.name.indexOf("myStrom")){b._logger.log("debug","upnp find switch:"+a.uuid+" ip:"+a.ip);var c=a.ip;a=a.uuid.substr(a.uuid.length-12,12);b._devices[c]=
new xnm.aio.mystrom.WifiDevice.Switch(c,null,a)}})};e.prototype._searchFinish=function(){this._searchTimeout=null;var a=this._sockets;this._sockets=[];for(var d=a.length;d--;){var c=a[d];c&&c.close()}a=this._callbacks;this._callbacks=[];d=a.length;c=[];for(var e in this._devices)if(this._devices.hasOwnProperty(e)){var b=this._devices[e];b&&c.push(b)}for(this._devices={};d--;)(e=a[d])&&e(null,c)};e.prototype._receivedData=function(a,d){d=d.toString("hex");this._logger.log("debug","received data from "+
a+" ("+d+")");if(!(14>d.length)){var c=d.substr(0,12);d=d.substr(12,2);d=parseInt(d,16);switch(d){case 101:case 106:case 107:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Switch(a,null,c);break;case 102:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Bulb(a,null,c);break;case 105:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Strip(a,null,c);break;case 103:case 104:this._devices[a]=new xnm.aio.mystrom.WifiDevice.Button(a,null,c)}}};e.prototype._addDiscoverSocket=function(a,d){var c=require("dgram"),
e=this;if(!d){try{var b=c.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){b=c.createSocket("udp4")}b.on("message",function(a,b){e._receivedData(b.address,a)});b.on("error",function(a){});b.bind(a);this._sockets.push(b)}else if("IPv4"==d.family&&0==d.internal){try{b=c.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){b=c.createSocket("udp4")}b.on("listening",function(){b.setBroadcast(!0)});b.on("message",function(a,b){e._receivedData(b.address,a)});b.on("error",function(a){});b.bind(a,d.address);
this._sockets.push(b)}};return e}();
xnm.aio.mystrom.DM=function(){var e=function(a,d){this.code=a;this.message=d;this.stack=Error().stack};e.prototype=Error();e.prototype.name="MystromDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"mystrom",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}}]},bulb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},
{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]},strip:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},
{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]}},getIPDeviceType:function(){return[{sys:this.SYS,name:"myStrom"}]},createDevice:function(a,d,c){d=e.ERROR_CODE;a?a.ip?a.type?c(null,a):c(new e(d.INVALID,"type is invalid")):c(new e(d.INVALID,"ip is invalid")):c(new e(d.INVALID,"info is invalid"))},updateDevice:function(a,
d,c){d=e.ERROR_CODE;a?a.ip?a.type?c(null,a):c(new e(d.INVALID,"type is invalid")):c(new e(d.INVALID,"ip is invalid")):c(new e(d.INVALID,"info is invalid"))},deleteDevice:function(a,d,c){c()},applyUIFilter:function(a,d){var c=this,e=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},b=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;
case "status":a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},g=function(a,d){var e=[],f=c.getCommandStatusMap(a);f&&(a=b(f,a,d),e=e.concat(a));return e};if(!a||null==a.type||"undefined"==typeof a.type)return null;var f=JSON.parse(JSON.stringify(a)),l=null;switch(d.catagory){case "command":l=g(a,d);f.command=l;break;case "status":l=g(a,d);f.status=l;break;default:return null}return l&&0!=l.length?f:null},getCommandStatusMap:function(a){return this.MAP[a.type]}}}();
xnm.aio.mystrom.Handler=function(){var e=function(){this._discovery=new xnm.aio.mystrom.Discovery};e.prototype.devicemanager=xnm.aio.mystrom.DM;e.prototype.Device=xnm.aio.mystrom.WifiDevice;e.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"mystrom")};e.prototype.resolveDevice=function(a){return a&&a.type&&a.ip?this.Device.build(a):null};e.prototype.getDeviceCommands=function(a,d){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];d&&d(null,
a)};e.prototype.getDeviceStatus=function(a,d){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];d&&d(null,a)};e.prototype.doCommand=function(a,d,c){var e=this.resolveDevice(a);e?e.executeCommandCreator(a,d,function(a){c&&c(a)}):c&&c(Error("gateway json format invalid"))};e.prototype.doStatus=function(a,d,c,e){var b=this.resolveDevice(d);b?b.getStatesCreator(null,[{id:a,device:d,status:c}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};
e.prototype.discovery=function(a){this._discovery.start(1E4,a)};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.mystrom.Handler);
