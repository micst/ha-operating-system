var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(d,b,c){if(null==d)throw new TypeError("The 'this' value for String.prototype."+c+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+c+" must not be a regular expression");return d+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,c){d!=Array.prototype&&d!=Object.prototype&&(d[b]=c.value)};$jscomp.getGlobal=function(d){d=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,d];for(var b=0;b<d.length;++b){var c=d[b];if(c&&c.Math==Math)return c}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,b,c,a){if(b){c=$jscomp.global;d=d.split(".");for(a=0;a<d.length-1;a++){var e=d[a];e in c||(c[e]={});c=c[e]}d=d[d.length-1];a=c[d];b=b(a);b!=a&&null!=b&&$jscomp.defineProperty(c,d,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.repeat",function(d){return d?d:function(b){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var a="";b;)if(b&1&&(a+=c),b>>>=1)c+=c;return a}},"es6","es3");var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.sonos=x.hub.m.sonos||{};x.hub.m.sonos.MODULE=require("xnm.aio.sonos.js");
x.hub.m.sonos.AudioPlayer=function(){var d=function(){this._process={}};d.prototype.playFile=function(b,c,a){if(c&&c.file){var e=require("x.hub.resource.js").getFileURL(c.file,b.ip);e?(c.url=e,this.playUrl(b,c,a)):a&&a(Error("no such file"))}else a&&a(Error("invalid file"))};d.prototype.playUrl=function(b,c,a){if(c){var e=c.url;e||(e=c.ext);if(e){var d=x.hub.m.sonos.MODULE.resolveDevice(b);if(d){var f=this;this._cancelPlay(d,function(b){b?a&&a(b):f._setVolume(d,c.volume,function(b){b?a&&a(b):f._unmute(d,
function(b){b?a&&a(b):f._playUrl(d,e,function(b){b?a&&a(b):f._setRepeat(d,c.repeat,function(b){b?a&&a(b):c.repeat&&-1!=c.repeat&&(f._process[d.ip]={url:e},f._process[d.ip].timeout=setTimeout(function(){var a=f._process[d.ip].url;f._process[d.ip]=null;f._stopPlay(d,a)},1E3*parseInt(c.repeat)))})})})})});a&&a(null,1)}else a&&a(Error("invalid device json"))}else a&&a(Error("invalid url"))}else a&&a(Error("invalid command"))};d.prototype._cancelPlay=function(b,c){if(b.ip&&this._process[b.ip]){this._process[b.ip].timeout&&
clearTimeout(this._process[b.ip].timeout);var a=this._process[b.ip].url;this._process[b.ip]=null;a?this._stopPlay(b,a,c):c&&c()}else c&&c()};d.prototype._stopPlay=function(b,c,a){b.getMediaInfo(function(d,g){d||!g?b.stop(a):g.currentURI&&g.currentURI!=c?a&&a():b.stop(a)})};d.prototype._setVolume=function(b,c,a){c?b.setVolume(c,a):a&&a()};d.prototype._setRepeat=function(b,c,a){c?b.repeatOne(a):b.repeatOff(a)};d.prototype._unmute=function(b,c){b.unmute(c)};d.prototype._playUrl=function(b,c,a){c?b.playUrl(c,
a):a&&a(Error("invalid url"))};return d}();
x.hub.m.sonos.Handler=function(){var d=function(){this._audioPlayer=new x.hub.m.sonos.AudioPlayer};util.inherits(d,EventEmitter);d.prototype.init=function(b){b&&b()};d.prototype.getSystems=function(){return["sonos"]};d.prototype.executeCommand=function(b,c,a){c?"playFile"==c.value?this._audioPlayer.playFile(b,c,function(b){a&&a({error:b})}):"playUrl"==c.value?this._audioPlayer.playUrl(b,c,function(b){a&&a({error:b})}):x.hub.m.sonos.MODULE.doCommand(b,c,a):a&&a({error:Error("invalid command")})};d.prototype.executeCommandV6=
function(b,c,a,d){if(b&&b.address)if(a){b={sys:"sonos",ip:b.address,port:b.port};var e=x.hub.m.sonos.MODULE.resolveDevice(b);if(e)if("alarm"==a.command)a.value&&a.value.file?(c={},c.volume=a.value.volume,c.repeat=a.value.time,a=a.value.file,"file://file/"==a.substr(0,12)?(c.value="playFile",c.file=a.substr(12),this.executeCommand(b,c,function(a){a&&a.error?d&&d(a.error):d&&d()})):(c.value="playUrl",c.url=a,this.executeCommand(b,c,function(a){a&&a.error?d&&d(a.error):d&&d()}))):(a=Error("invalid command"),
a.code="000000",d&&d(a));else{c={value:null,ext:null};switch(a.command){case "pause":case "stop":case "previous":case "next":case "mute":case "unmute":c.value=a.command;break;case "play":a.value?(c.value="playUrl",c.ext=a.value):c.value="play";break;case "volume":c.value="volume";c.ext=a.value;break;default:a=Error("unknown command");a.code="000000";d&&d(a);return}e.executeCommandCreator(b,c,function(a){a&&(a.code="000000");d&&d(a)})}else a=Error("invalid device json"),a.code="000000",d&&d(a)}else a=
Error("invalid command"),a.code="000000",d&&d(a);else a=Error("invalid device json"),a.code="000000",d&&d(a)};d.prototype.getStatesV6=function(b,c,a){b&&b.address?(b={sys:"sonos",ip:b.address,port:b.port},(c=x.hub.m.sonos.MODULE.resolveDevice(b))?c.getStatesCreator(null,[{id:"playState",device:b,status:{value:"playState"}},{id:"volume",device:b,status:{value:"volume"}},{id:"muted",device:b,status:{value:"muted"}}],function(b,c){if(b)a&&a(b);else{b={};if(c)for(var d=0;d<c.length;d++){var e=c[d];e&&
("playState"==e.id&&e.status?b.state="PLAYING"==e.status?"playing":"paused":"volume"==e.id&&null!=e.status&&void 0!=e.status?b.volume=parseInt(e.status):"muted"==e.id&&(b.muted="true"==e.status||1==e.status))}a&&a(null,b)}}):(b=Error("invalid device json"),b.code="000000",a&&a(b))):(b=Error("invalid device json"),b.code="000000",a&&a(b))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.sonos.Handler);
