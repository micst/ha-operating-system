var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.eltako=xnm.aio.eltako||{};xnm.aio.eltako.Gateway=function(){var d=function(c){this._ip=c.ip;this._port=c.port;this._username=c.username;this._password=c.password;this._uuid=c.uuid;this._port||(this._port=35689)};d.parseJSON=function(c){return c&&c.ip?new d(c):null};return d}();
xnm.aio.eltako._Session=function(){var d=[135,168,230,29,180,182,102,60,255,187,209,156,101,25,89,153,140,238,246,8,102,13,208,242,93,44,238,212,67,94,59,0,224,13,248,241,214,25,87,212,250,247,223,69,97,178,170,48,22,195,217,17,52,9,111,170,59,244,41,109,131,14,154,124,32,158,12,100,151,81,122,189,90,138,157,48,107,207,103,237,145,249,230,114,91,71,88,192,34,224,177,239,66,117,191,123,108,91,252,17,212,95,144,136,185,65,245,78,177,229,155,184,188,57,160,191,18,48,127,92,79,219,112,197,129,178,63,
118,182,58,202,225,202,166,183,144,45,82,82,103,53,72,138,14,241,60,109,154,81,191,164,171,58,216,52,119,150,82,77,142,246,161,103,181,164,24,37,217,103,225,68,229,20,5,100,37,28,202,203,131,230,180,134,246,179,202,63,121,113,80,96,38,192,184,87,246,137,150,40,86,222,212,1,10,189,11,230,33,195,163,150,10,84,231,16,195,117,242,99,117,215,1,65,3,164,181,67,48,193,152,175,18,97,22,210,39,110,17,113,95,105,56,119,250,215,239,9,202,219,9,74,233,30,26,21,151],c=[63,179,44,155,115,19,77,11,46,119,80,102,
96,237,189,72,76,167,177,143,33,239,32,84,7,244,121,58,26,11,161,37,16,219,193,80,119,190,70,63,255,79,237,74,172,11,181,85,190,58,108,27,12,107,71,177,188,55,115,191,126,140,111,98,144,18,40,248,194,140,187,24,165,90,227,19,65,0,10,101,1,150,249,49,199,122,87,242,221,244,99,229,233,236,20,75,119,125,230,42,170,184,168,98,138,195,118,210,130,214,237,56,100,230,121,130,66,142,188,131,29,20,52,143,111,47,145,147,181,4,90,242,118,113,100,225,223,201,103,193,251,63,46,85,164,189,27,255,232,59,156,128,
208,82,185,133,209,130,234,10,219,42,59,115,19,211,254,20,200,72,75,30,5,37,136,185,183,210,187,210,223,1,97,153,236,208,110,21,87,205,9,21,179,53,59,187,100,224,236,55,127,208,40,55,13,249,43,82,199,137,20,40,205,198,126,182,24,75,82,61,29,178,70,195,47,99,7,132,144,240,14,248,214,71,209,72,212,121,84,81,94,35,39,207,239,152,197,130,102,75,76,15,108,196,22,89],a=function(b){if(!b)throw Error("options is null");if(!b.ip)throw Error("no ip");this._timeout=3E3;this._ip=b.ip;this._port=b.port;this._port||
(this._port=35689);this._username=b.username;this._password=b.password;this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Session.{"+this._ip+":"+this._port+"}");this._state="IDLE";this._listeners={};this._socket=null;this._sequenceID=0;this._buffer={};this._auth=this._settings=null};a.prototype.on=function(b,a){b&&a&&(this._listeners[b]||(this._listeners[b]=[]),-1==this._listeners[b].indexOf(a)&&this._listeners[b].push(a))};a.prototype.off=function(b,a){b&&a&&this._listeners[b]&&(a=this._listeners[b].indexOf(a),
-1!=a&&this._listeners[b].splice(a,1))};a.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var b=this;this._state="CONNECT";var a=new xnm.aio.eltako._Socket({ip:this._ip,port:this._port});this._logger.log("trace","start session to "+this._ip+":"+this._port);a.on("open",function(){b._logger.log("trace","_socket success connect to "+b._ip+":"+b._port);b._init()});a.on("data",function(a){b._onData(a)});a.on("error",function(a){b._logger.log("trace","_socket error: "+a.message);b._emitEvent("error",
a)});a.on("close",function(){b._logger.log("trace","_socket closed");b._onClose()});a.open();this._socket=a}};a.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.close(),this._onClose())};a.prototype.sendObject=function(b,a){"CONNECTED"!=this._state?a&&a(Error("session not connected")):this._sendObject(b,a)};a.prototype._sendObject=function(b,a){var c=this;this._sequenceID++;var f={classType:"bsc.api.transport.TransmissionObject",object:b};f.id=(new Date).getTime()+"";f.sequenceID=
this._sequenceID;this._buffer[f.id]={callback:a,timeout:setTimeout(function(){c._onTimeout(f.id)},this._timeout)};this._logger.log("trace","send object:"+JSON.stringify(f));b=this._buildData(JSON.stringify(f));this._socket.sendData(b)};a.prototype._emitEvent=function(b,a){if(b){var c=this._listeners[b];if(c&&0<c.length)for(var f=0;f<c.length;f++){var d=c[f];try{d(a)}catch(h){this._logger.log("trace","call "+b+" listener failed, error:"+h.message)}}}};a.prototype._buildData=function(b){return require("x.crypt.js").stringToUtf8ByteArray(b)};
a.prototype._parseObject=function(b){b=require("x.crypt.js").utf8ByteArrayToString(b);try{return JSON.parse(b)}catch(f){return null}};a.prototype._init=function(){var b=this;this._doConnectRequest(function(a,c){a?(b._emitEvent("error",a),b.close()):b._sendCaps(null,null,null,c.apiVersions?c.apiVersions[0]:null,c.apiExtensions,function(a,c){a?(b._emitEvent("error",a),b.close()):(b._settings=c,a=b._genKeySig(b._username,b._password),b._sendAuth(b._username,a.key,a.signature,function(a,c){a?(b._emitEvent("error",
a),b.close()):(b._auth=c,b._emitEvent("open",b._settings,b._auth))}))})})};a.prototype._genKeySig=function(b,a){var c=this._genDHKey(),f=(new Buffer(c,"hex")).toString("base64");b=this._genSignature(b,a,c);b=(new Buffer(b,"hex")).toString("base64");return{key:f,signature:b}};a.prototype._genDHKey=function(){var b=require("x.crypt.js"),a=b.bigInt(b.byteArrayToHex(d),16);b=b.bigInt.randBetween(b.bigInt("730750818665451459101842416358141509827966271488"),a.minus(2));a=require("crypto").createDiffieHellman(new Buffer(d),
null,new Buffer(c),null);a.setPrivateKey(b.toString(16),"hex");return a.generateKeys("hex")};a.prototype._genSignature=function(b,a,c){var f=require("crypto"),d=f.createHash("sha256");d.update(a);d=d.digest("hex");b+=d;d=f.createHash("sha256");d.update(c,"hex");c=d.digest("hex");d=f.createHash("sha256");d.update(b,"utf8");d=d.digest("hex");f=f.createCipher("aes-128-cbc",new Buffer(d,"hex"));c=f.update(new Buffer(c,"hex"),null,"hex");return c+=f.final("hex")};a.prototype._doConnectRequest=function(a){this._sendObject({classType:"bsc.api.transport.commands.ConnectionRequest",
metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["M2M->VID","0#2#0010F3601410"]]}},function(b,c){b?a&&a(b):c.object&&"bsc.api.transport.result.ObjectResult"==c.classType?(b=c.object)&&"bsc.api.transport.model.Caps"==b.classType?(c={protocols:[],encryptions:[],compressions:[],apiVersions:[],apiExtension:[]},b.protocols&&b.protocols.data&&(c.protocols=b.protocols.data),b.encryptions&&b.encryptions.data&&(c.encryptions=b.encryptions.data),b.compressions&&b.compressions.data&&
(c.compressions=b.compressions.data),b.apiVersions&&b.apiVersions.data&&(c.apiVersions=b.apiVersions.data),b.apiExtensions&&b.apiExtensions.data&&(c.apiExtensions=b.apiExtensions.data),a&&a(null,c)):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse.object))):a&&a(Error("do ConnectionRequest failed:"+JSON.stringify(reponse)))})};a.prototype._sendCaps=function(b,a,c,d,k,h){b||(b={classType:"Enum",enumType:"bsc.api.Enumerations$ProtocolType",name:"JSON"});a||(a={classType:"Enum",enumType:"bsc.api.Enumerations$EncryptionType",
name:"NONE"});c||(c={classType:"Enum",enumType:"bsc.api.Enumerations$CompressionType",name:"NONE"});d||(d={classType:"Enum",enumType:"bsc.api.Enumerations$ApiVersion",name:"Ver_2_1_0"});k||(k="CORE VOICECONTROL TEACHIN TIMER M2M CAMERA CONNECTIONS USERMANAGEMENT OBJECT_TAG MESSAGE BSC ALEXA QoS HEATER USERCONFIG PARAMETER HISTORY".split(" "));this._sendObject({classType:"bsc.api.transport.model.Caps",protocols:{classType:"List",valueType:"bsc.api.Enumerations$ProtocolType",data:[b]},encryptions:{classType:"List",
valueType:"bsc.api.Enumerations$EncryptionType",data:[a]},compressions:{classType:"List",valueType:"bsc.api.Enumerations$CompressionType",data:[c]},apiVersions:{classType:"List",valueType:"bsc.api.Enumerations$ApiVersion",data:[d]},apiExtensions:{classType:"List",valueType:"String",data:k},metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["BSC->PRODUCT","10004"]]}},function(a,b){a?h&&h(a):b.object&&"bsc.api.transport.result.ObjectResult"==b.classType?(a=b.object)&&"bsc.api.transport.model.Settings"==
a.classType?(a={protocol:a.protocol,encryption:a.encryption,compression:a.compression,apiVersion:a.apiVersion,apiExtensions:a.apiExtensions},h&&h(null,a)):h&&h(Error("send Caps failed:"+JSON.stringify(reponse.object))):h&&h(Error("send Caps failed:"+JSON.stringify(reponse)))})};a.prototype._sendAuth=function(a,c,d,e){this._sendObject({classType:"bsc.api.transport.model.Auth",key:c,signature:d,user:a},function(a,b){a?e&&e(a):b.object&&"bsc.api.transport.result.ObjectResult"==b.classType?(a=b.object)&&
"bsc.api.transport.model.Auth"==a.classType?(a={user:a.user,signature:a.signature,sessionID:a.sessionID},e&&e(null,a)):e&&e(Error("send Auth failed:"+JSON.stringify(reponse.object))):e&&e(Error("send Auth failed:"+JSON.stringify(reponse)))})};a.prototype._onTimeout=function(a){var b=this._buffer[a];b&&(delete this._buffer[a],b.timeout&&clearTimeout(b.timeout),b.callback&&b.callback(Error("response timeout")))};a.prototype._onData=function(a){a=this._parseObject(a);this._logger.log("trace","receive object:"+
JSON.stringify(a));if(a&&a.id&&a.object)if(a.sequenceID&&(this._sequenceID=a.sequenceID),a.object.resultType){var b=this._buffer[a.id];b&&a.object.resultType&&"bsc.api.transport.result.Result$ResultType"==a.object.resultType.enumType?(delete this._buffer[a.id],b.timeout&&clearTimeout(b.timeout),b.callback&&b.callback(null,a.object)):this._emitEvent("object",a.object,function(a){})}else this._emitEvent("object",a.object,function(a){})};a.prototype._onClose=function(){this._state="CLOSED";this._socket=
null;this._emitEvent("close");this._listeners={};var a=this._buffer;this._buffer={};this._sequenceID=0;this._settings=null;for(var c in a){var d=a[c];d&&(d.timeout&&clearTimeout(d.timeout),d.callback&&d.callback(Error("session closed")))}};return a}();
xnm.aio.eltako._Socket=function(){var d=function(c){if(!c)throw Error("options is null");if(!c.ip)throw Error("no ip");this._ip=c.ip;this._port=c.port;this._port||(this._port=35689);this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Socket.{"+this._ip+":"+this._port+"}");this._timeout=2E3;this._listeners={};this._state="IDLE";this._encrypt=this._compress=this._buf=this._socket=null};d.prototype.on=function(c,a){c&&a&&(this._listeners[c]||(this._listeners[c]=[]),-1==this._listeners[c].indexOf(a)&&
this._listeners[c].push(a))};d.prototype.off=function(c,a){c&&a&&this._listeners[c]&&(a=this._listeners[c].indexOf(a),-1!=a&&this._listeners[c].splice(a,1))};d.prototype.setCompress=function(c){this._compress=c};d.prototype.setEncrpty=function(c){this._encrypt=c};d.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var c=this;this._state="CONNECT";this._buf="";var a=require("net").connect({port:this._port,host:this._ip});a.setTimeout(this._timeout);this._logger.log("trace","start connect to "+
this._ip+":"+this._port);a.on("connect",function(){c._logger.log("trace","success to connect "+c._ip+":"+c._port);c._state="CONNECTED";c._emitEvent("open")});a.on("data",function(a){a.readUInt8&&(a=c._bufferToArray(a));var b=require("x.crypt.js");c._logger.log("trace","receive data: "+b.byteArrayToHex(a));c._onData(a)});a.on("error",function(a){c._logger.log("trace","socket error: "+a.message);c._emitEvent("error",a)});a.on("timeout",function(){"CONNECT"==c._state&&(c._logger.log("trace","connect timeout"),
c._emitEvent("error",Error("connect timeout")),c.close())});a.on("close",function(){c._logger.log("trace","socket closed");c._onClose()});a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();this._socket=a}};d.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose())};d.prototype.sendData=function(c,a){var b=require("x.crypt.js");this._logger.log("trace","send data:"+b.byteArrayToHex(c));"CONNECTED"!=this._state?a&&a(Error("socket not connected")):
(c=this._buildPacket(c),this._logger.log("trace","send packet:"+b.byteArrayToHex(c)),this._socket.write(new Buffer(c),"binary",function(b){a&&a(b)}))};d.prototype._buildPacket=function(c){var a=c.length;a=this._int32ToArray(2).concat(this._int32ToArray(a));var b=require("x.crypt.js"),d=b.CRC32(a);b=b.CRC32(c);d=this._int32ToArray(d).concat(this._int32ToArray(b));return[85].concat(a).concat(d).concat(c)};d.prototype._emitEvent=function(c,a){if(c){var b=this._listeners[c];if(b&&0<b.length)for(var d=
0;d<b.length;d++){var g=b[d];try{g(a)}catch(e){this._logger.log("trace","call "+c+" listener failed, error:"+e.message)}}}};d.prototype._arrayToInt32=function(c){c=((c[0]&255)<<24)+((c[1]&255)<<16)+((c[2]&255)<<8)+(c[3]&255);return 0>c?4294967296+c:c};d.prototype._int32ToArray=function(c){return[c>>24&255,c>>16&255,c>>8&255,c&255]};d.prototype._bufferToArray=function(c){for(var a=[],b=0;b<c.length;b++)a.push(c[b]);return a};d.prototype._onData=function(c){this._buf=this._buf?this._buf.concat(c):c;
c=this._buf.length;for(var a=0;a<c;){if(85==this._buf[a]){if(c<=a+17)break;var b=this._buf.slice(a+5,a+9);b=this._arrayToInt32(b);if(c<a+17+b)break;var d=this._buf.slice(a,a+17+b);(d=this._parsePacket(d))&&this._emitEvent("data",d);a+=17+b-1}a++}this._buf=a==c?null:this._buf.slice(a)};d.prototype._parsePacket=function(c){var a=require("x.crypt.js");this._logger.log("trace","receive packet:"+a.byteArrayToHex(c));var b=c.slice(1,9),d=c.slice(9,17);c=c.slice(17);var g=this._arrayToInt32(b.slice(0,4)),
e=this._arrayToInt32(b.slice(4)),k=this._arrayToInt32(d.slice(0,4));d=this._arrayToInt32(d.slice(4));b=a.CRC32(b);a=a.CRC32(c);this._logger.log("trace","parse packet t:"+g+" l:"+e+" crc_h:<"+k+","+b+"> crc_d:<"+d+","+a+">");return c};d.prototype._onClose=function(){this._state="CLOSED";this._socket=null;this._emitEvent("close");this._listeners={};this._buf=null};return d}();
xnm.aio.eltako.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="HEOSDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},
{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},
{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on",
"off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"string",name:"play state",ref:{value:"playState",options:["play","pause","stop"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",
name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]};return{SYS:"eltako",getGatewayType:function(){return[{sys:this.SYS,name:"HEOS Controller",port:1255}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"player",name:"Player"},{sys:this.SYS,type:"group",name:"Group"}]},createGateway:function(a,b,c){b=d.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,b,c,g){a=d.ERROR_CODE;b?b.ip?
g(null,b):g(new d(a.INVALID,"ip is invalid")):g(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var f=d.ERROR_CODE;if(a)if(a.gateway)if(null==a.type||"undefined"==typeof a.type)c(new d(f.INVALID,"type is invalid"));else if("player"!=a.type||null!=a.pid&&"undefined"!=typeof a.pid)if("group"!=a.type||null!=a.gid&&"undefined"!=typeof a.gid){b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var k=b[e];break}k?c(null,a):c(new d(f.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"))}else c(new d(f.INVALID,"gid is invalid"));else c(new d(f.INVALID,"pid is invalid"));else c(new d(f.INVALID,"gateway is invalid"));else c(new d(f.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var f=d.ERROR_CODE;if(a)if(a.gateway)if(null==a.type||"undefined"==typeof a.type)c(new d(f.INVALID,"type is invalid"));else if("player"!=a.type||null!=a.pid&&"undefined"!=typeof a.pid)if("group"!=a.type||null!=a.gid&&"undefined"!=typeof a.gid){b=b.data.gateways;
var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var k=b[e];break}k?c(null,a):c(new d(f.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else c(new d(f.INVALID,"gid is invalid"));else c(new d(f.INVALID,"pid is invalid"));else c(new d(f.INVALID,"gateway is invalid"));else c(new d(f.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(a,b,c){var f=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=
d(a.children,b,c);e&&0<e.length&&(a.children=e,f.push(a))}else{e=c.elems;if("*"==e)e=!0;else{for(var g=!1,h=0;h<e.length;h++)if(e[h]==a.type){g=!0;break}e=g}e&&(a=JSON.parse(JSON.stringify(a)),f.push(a))}});return f},e=function(a,b){var f=[],e=c.getCommandStatusMap(a);if(e){var h=[];switch(b.catagory){case "command":e.command&&(h=d(e.command,a,b));break;case "status":e.status&&(h=d(e.status,a,b))}f=f.concat(h)}return f};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=
e(a,b);k.command=h;break;case "status":h=e(a,b);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(a){return a&&"undefined"!=typeof a.type&&null!=a.type?c:null}}}();
xnm.aio.eltako.Handler=function(){var d=function(){this._getDeviceListTo=this._controller=null};d.prototype.Socket=xnm.aio.eltako._Socket;d.prototype.Session=xnm.aio.eltako._Session;d.prototype.Gateway=xnm.aio.eltako.Gateway;d.prototype.devicemanager=xnm.aio.eltako.DM;d.prototype.registModule=function(c){c.register(this.devicemanager.SYS,"eltako")};d.prototype.resolveGateway=function(c){return c?this.Gateway.parseJSON(c):null};d.prototype.getDeviceCommands=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,
{catagory:"command",elems:"*"}))?c.command:[];a&&a(null,c)};d.prototype.getDeviceStatus=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];a&&a(null,c)};d.prototype.doCommand=function(c,a,b,d){(c=this.resolveGateway(c))?c.executeCommandCreator(a,b,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(c,a,b,d,g){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:c,device:b,status:d}],function(a,b){a?g&&g(a):
g&&g(null,b[0])}):g&&g(Error("device json format invalid"))};d.prototype.getController=function(){this._controller||(this._controller=new this.Controller);return this._controller};d.prototype.discoverDevices=function(c){var a={};require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",5E3,function(b){b&&b.ip&&b.uuid&&(a[b.uuid]={sys:"heos",ip:b.ip,uuid:b.uuid})});setTimeout(function(){var b=null,d;for(d in a){var g=a[d];if(g){b=g;break}}c&&c(null,b)},5E3)};d.prototype.getDeviceList=
function(c,a){_getDeviceList=function(a,b){var c=[];a.getPlayers(function(d,e){d?b&&b(d):(e&&e.map(function(a){a.sys="heos";a.type="player";return a}),a.getGroups(function(a,d){a?b&&b(a):(d&&d.map(function(a){a.sys="heos";a.type="group";delete a.players;return a}),e&&(c=c.concat(e)),d&&(c=c.concat(d)),b&&b(null,c))}))})};var b=this.resolveGateway(c);if(b)if(this._getDeviceListTo)a&&a(Error("another get device list process running"));else{var d=this.getController();if(d.isOpen())_getDeviceList(b,a);
else{var g=this,e=function(){d.off("run",e);g._getDeviceListTo&&(clearTimeout(g._getDeviceListTo),g._getDeviceListTo=null);_getDeviceList(b,a)};d.on("open",e);this._getDeviceListTo=setTimeout(function(){d.off("run",e);g._getDeviceListTo=null;a&&a(Error("start heo controller timeout"))},5E3);d.open(b.toJSON())}}else a&&a(Error("gateway json format invalid"))};d.prototype.finalize=function(c){this._controller&&this._controller.close();setTimeout(function(){c&&c()},1E3)};d.prototype.pause=function(c){this.finalize(c)};
return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.eltako.Handler);
