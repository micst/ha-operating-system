var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tado=xnm.aio.tado||{};
xnm.aio.tado.Bridge=function(){var f=function(e,b){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.Bridge");this.user=e;this.password=b};f.prototype.executeCommandCreator=function(e,b,a){if(b&&b.value){e=b.value;if("setTo"==b.value){if(null==b.ext||"undefined"==typeof b.ext){a&&a(Error("command ext format invalid"));return}e=b.value+b.ext}this.executeCommand(e,function(d){a&&a(d)})}else a&&a(Error("command format invalid"))};f.prototype.getStatesCreator=function(e,b,a){b?this.getState(function(d,
c){d=[];for(var k=0;k<b.length;k++){var e=b[k],f="?";if(e.id&&e.status&&e.status.value&&c){var g=c[e.status.value];null!=g&&"undefined"!=typeof g&&(f=g)}d.push({id:e.id,status:f})}a&&a(null,d)}):a&&a(Error("deviceList is null"))};f.prototype._doRequest=function(e,b,a){var d=e+"?";e=null;if(b)for(var c in b)b.hasOwnProperty(c)&&(d+=c+"="+encodeURIComponent(b[c])+"&");e=d;d+="username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);b={host:"my.tado.com",path:d,method:"GET",
headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","send https request to:"+(e+"username=xxxxxx&password=xxxxxx"));var k=this,f=require("https").request(b,function(c){c.setEncoding("utf-8");var d="";c.on("data",function(a){d+=a});c.on("end",function(){k._logger.log("trace","receive https response code:"+c.statusCode+" body:"+d);if(200==c.statusCode){var b=null;try{b=JSON.parse(d),a&&(a(null,b),a=null)}catch(n){a&&(a(Error("https response invalid json")),
a=null)}}else a&&(a(Error("https response code:"+c.statusCode),d),a=null)})});f.on("error",function(c){k._logger.log("trace","send https request err:"+c.message);a&&(a(c),a=null)});f.setTimeout(2E3,function(){k._logger.log("trace","send https request timeout");f.abort();a&&(a(Error("https request timeout")),a=null)});f.end()};f.prototype.executeCommand=function(e,b){var a=!0,d=null,c=null,k=this;if("auto"==e)d="/mobile/1.9/updateThermostatSettings",c={setMode:"AUTO"};else if("up"==e||"down"==e)this.getState(function(a,
d){a?b&&b(a):d&&d.mode&&d.temp?(a=parseFloat(d.temp),a="up"==e?a+.5:a-.5,5>a?a=5:25<a&&(a=25),a=a.toFixed(1),c={setMode:"MANUAL",manualTemp:a},k._doRequest("/mobile/1.9/updateThermostatSettings",c,function(a){b&&b(a)})):b&&b(a,d)}),a=!1;else if(0==e.indexOf("setTo")){e=e.replace(/setTo/g,"");e=e.replace(/%/g,"");var f=parseFloat(e);5>f?f=5:25<f&&(f=25);f=f.toFixed(1);d="/mobile/1.9/updateThermostatSettings";c={setMode:"MANUAL",manualTemp:f}}d?this._doRequest(d,c,function(a){b&&b(a)}):a&&b&&b()};f.prototype.getState=
function(e){var b={},a=this;this._doRequest("/mobile/1.9/getCurrentState",null,function(d,c){d?e(d):(c&&(b.heatingOn=c.heatingOn,b.temp=parseFloat(c.setPointTemp).toFixed(1),b.insideTemp=parseFloat(c.insideTemp).toFixed(1),b.mode=c.operation),c.homeId?a._doRequest("/api/v1/home/"+c.homeId+"/hvacState",null,function(a,d){d&&d.humidity&&(b.humidity=d.humidity.percentage);e&&e(a,b)}):e&&e(d,b))})};f.prototype.getStateValues=function(e,b){return b};f.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,
username:this.user,password:this.password}};f.prototype.equalsTo=function(e){return e&&e instanceof f?this.user==e.user&&this.password==e.password:!1};f.parseJSON=function(e){return e.username&&e.password?new f(e.username,e.password):null};return f}();
xnm.aio.tado.BridgeV2=function(){var f={},e=function(a,d){var c={temp:20,type:"MANUAL",durationInSeconds:60};return f[a+"_"+d]=c},b=function(a,d){this._logger=require("x.logger.js").getLogger("xnm.aio.tado.BridgeV2");this.user=a;this.password=d;this._zoneStateCBS={}};b.prototype.getZones=function(a){var d=this;this._getMe(function(c,b){if(c)a&&a(c);else{var k=[],e=b.homes,f=0,h=function(c,b){if(!c&&b){c=e[f].id;for(var g=0;g<b.length;g++){var m=b[g];k.push({name:m.name,type:"zone",homeID:c,zoneID:m.id})}}f++;
f<e.length?d._getZones(e[f].id,h):a&&a(null,k)};d._getZones(e[f].id,h)}})};b.prototype.executeCommandCreator=function(a,d,c){d&&d.value?a&&"thermo"==a.type?(new xnm.aio.tado.Bridge(this.user,this.password)).executeCommandCreator(a,d,c):this.executeCommand(a,d,function(a){c&&c(a)}):c&&c(Error("command format invalid"))};b.prototype.getStatesCreator=function(a,d,c){if(d){for(var b=[],e=[],f=[],g=0;g<d.length;g++){var h=d[g];h&&h.device&&"thermo"==h.device.type&&f.push(h);h.device&&h.device.homeID&&
h.device.zoneID&&-1==b.indexOf(h.device.homeID+"_"+h.device.zoneID)&&e.push(h.device)}var n=1,p=[];0<f.length&&(n=2,(new xnm.aio.tado.Bridge(this.user,this.password)).getStatesCreator(a,f,function(a,d){n--;!a&&d&&(p=p.concat(d));0==n&&c&&c(null,p)}));this.getState(e,function(a,b){for(var k=0;k<d.length;k++){var e=d[k];if(e&&e.id){var f="?";if(!a&&b&&e.device&&e.device.homeID&&e.device.zoneID){var g=b[e.device.homeID+"_"+e.device.zoneID];g&&e.status&&e.status.value&&(g=g[e.status.value],null!=g&&"undefined"!=
typeof g&&(f=g))}p.push({id:e.id,status:f})}}n--;0==n&&c&&c(null,p)})}else c&&c(Error("deviceList is null"))};b.prototype.executeCommand=function(a,d,c){if(a&&"zone"==a.type&&a.homeID&&a.zoneID)if(d&&d.value){var b="GET",m="/api/v2/homes/"+a.homeID+"/zones/"+a.zoneID+"/overlay",l=null;switch(d.value){case "auto":b="DELETE";break;case "off":var g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));b="PUT";l={setting:{type:"HEATING",power:"OFF"},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=
g.durationInSeconds);break;case "start":g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));b="PUT";l={setting:{type:"HEATING",power:"ON",temperature:{celsius:g.temp}},termination:{type:g.type}};"TIMER"==g.type&&(l.termination.durationInSeconds=g.durationInSeconds);break;case "setManuEndMode":switch(d.ext){case "MANUAL":case "TIMER":case "TADO_MODE":g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));g.type=d.ext;c&&c();break;default:c&&c(Error("setManuEndMode ext invalid"))}return;
case "setManuEndTimer":if(!d.ext){c&&c(Error("setManuEndTimer ext invalid"));return}d=parseInt(d.ext);isNaN(d)&&(d=1);1>d&&(d=1);g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));g.durationInSeconds=60*d;c&&c();return;case "setTo":if(!d.ext){c&&c(Error("setTo ext invalid"));return}var h=parseFloat(d.ext);5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));g.temp=h;c&&c();break;case "up":case "down":b=parseFloat(d.ext);if(!b||isNaN(b))b=
1;g=a.homeID+"_"+a.zoneID;(g=f[g])||(g=e(a.homeID,a.zoneID));h=g.temp;h="up"==d.value?h+b:h-b;5>h?h=5:25<h&&(h=25);h=h.toFixed(1);h=parseFloat(h);g.temp=h;c&&c();return;default:c&&c(Error("unknown command"));return}this._doRequest(b,m,JSON.stringify(l),function(a){c&&c(a)})}else c&&c(Error("command json invalid"));else c&&c(Error("device json invalid"))};b.prototype.getState=function(a,d){for(var c={},b=a.length,e=b,f=function(){b--;0==b&&d&&d(null,c)};e--;){var g=a[e];g&&g.homeID&&g.zoneID?this.getZoneState(g.homeID,
g.zoneID,function(a,d,b,e){!a&&d&&(c[b+"_"+e]=d);f()}):f()}};b.prototype.getZoneState=function(a,d,c){var b=a+"_"+d,e=this._zoneStateCBS[b];e||(e=[],this._zoneStateCBS[b]=e);var f=e.length;c||(c=function(){});-1==e.indexOf(c)&&e.push(c);if(0==f){var g=this;this._getZoneState(a,d,function(c,f){delete g._zoneStateCBS[b];var k=e.length;if(c)for(;k--;)e[k]&&e[k](c);else for(c=g._resolveZoneState(f),k=g._getZoneManuTermination(a,d),c||(c={}),c.setManutemp=k.setManutemp,c.setManuEndMode=k.setManuEndMode,
c.setManuEndTimer=k.setManuEndTimer,k=e.length;k--;)e[k]&&e[k](null,c,a,d)})}};b.prototype._getZoneManuTermination=function(a,d){var c=f[a+"_"+d];c||(c=e(a,d));a={};a.setManutemp=c.temp;a.setManuEndMode=c.type;a.setManuEndTimer=c.durationInSeconds;a.setManuEndTimer&&(a.setManuEndTimer/=60);return a};b.prototype._resolveZoneState=function(a){var d={manuEndTimer:0,manuEndTimerRemainS:0,manuEndTimerRemain:0,manuEndTimerRemainTxt:"",manuEndAutoExpire:null};a.tadoMode&&(d.mode=a.tadoMode);a.overlayType&&
(d.mode=a.overlayType);var c=a.setting,b;c&&((b=c.temperature)&&"undefined"!=typeof b.celsius&&null!=b.celsius&&(d.temp=b.celsius),c.power&&(d.power=c.power,"OFF"==c.power&&(d.temp=0,d.mode="FROZEN_PROTECTION")));(c=a.activityDataPoints)&&(c=c.heatingPower)&&"undefined"!=typeof c.percentage&&null!=c.percentage&&(d.heatingPower=c.percentage);if(c=a.sensorDataPoints)(b=c.insideTemperature)&&"undefined"!=typeof b.celsius&&null!=b.celsius&&(d.insideTemp=b.celsius),(c=c.humidity)&&"undefined"!=typeof c.percentage&&
null!=c.percentage&&(d.humidity=c.percentage);if(a=a.overlay){if(c=a.setting)(b=c.temperature)&&"undefined"!=typeof b.celsius&&null!=b.celsius&&(d.temp=b.celsius),c.power&&(d.power=c.power,"OFF"==c.power&&(d.temp=0,d.mode="FROZEN_PROTECTION"));if(b=a.termination)b.type&&(d.manuEndMode=b.type),"TIMER"==b.type?(d.manuEndTimer=Math.round(b.durationInSeconds/60),d.manuEndTimerRemainS=b.remainingTimeInSeconds,d.manuEndTimerRemain=Math.round(b.remainingTimeInSeconds/60),a=Math.floor(b.remainingTimeInSeconds/
3600),c=Math.floor(b.remainingTimeInSeconds%3600/60),b=b.remainingTimeInSeconds%60,a=""+a,2>a.length&&(a="0"+a),c=""+c,2>c.length&&(c="0"+c),b=""+b,2>b.length&&(b="0"+b),d.manuEndTimerRemainTxt=a+":"+c+":"+b,d.manuEndAutoExpire=null):"TADO_MODE"==b.type?(d.manuEndTimer=0,d.manuEndTimerRemainS=0,d.manuEndTimerRemain=0,d.manuEndTimerRemainTxt="",d.manuEndAutoExpire=(new Date(b.projectedExpiry)).toTimeString()):(d.manuEndTimer=0,d.manuEndTimerRemainS=0,d.manuEndTimerRemain=0,d.manuEndTimerRemainTxt=
"",d.manuEndAutoExpire=null)}return d};b.prototype._getMe=function(a){this._doRequest("GET","/api/v2/me",null,function(b,c){a&&a(b,c)})};b.prototype._getZones=function(a,b){this._doRequest("GET","/api/v2/homes/"+a+"/zones",null,function(a,d){b&&b(a,d)})};b.prototype._getZoneState=function(a,b,c){this._doRequest("GET","/api/v2/homes/"+a+"/zones/"+b+"/state",null,function(a,b){c&&c(a,b)})};b.prototype._doRequest=function(a,b,c,e){var d=b;b+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password);
b={host:"my.tado.com",path:b,method:a,headers:{Connection:"close","Content-Type":'application/json; charset="UTF-8"'}};this._logger.log("trace","do https "+a+" request:"+(d+"?username=xxxxxx&password=xxxxxx"));c&&this._logger.log("trace","https body:"+c);var f=this,g=require("https").request(b,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace","receive https response code:"+a.statusCode+" body:"+b);if(200==a.statusCode||204==a.statusCode){var c=
null;try{c=JSON.parse(b),e&&(e(null,c),e=null)}catch(q){e&&(e(Error("https response invalid json")),e=null)}}else e&&(e(Error("https response code:"+a.statusCode),b),e=null)})});g.on("error",function(a){f._logger.log("trace","send https request err:"+a.message);e&&(e(a),e=null)});g.setTimeout(2E3,function(){f._logger.log("trace","send https request timeout");g.abort();e&&(e(Error("https request timeout")),e=null)});c&&g.write(c);g.end()};b.prototype.toJSON=function(){return{sys:xnm.aio.tado.DM.SYS,
username:this.user,password:this.password}};b.prototype.equalsTo=function(a){return a&&a instanceof b?this.user==a.user&&this.password==a.password:!1};b.parseJSON=function(a){return a.username&&a.password?new b(a.username,a.password):null};return b}();
xnm.aio.tado.DM=function(){var f=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};f.prototype=Error();f.prototype.name="TadoDMError";f.prototype.code=0;f.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"float",name:"manu",ref:{value:"setTo",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}}],
status:[{type:"enum",name:"mode",ref:{value:"mode",options:["HOME","SLEEP","AWAY","MANUAL","NO_FREEZE"]}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}}]},zone:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"start",ref:{value:"start"}},{type:"float",name:"set manu temperature",
ref:{value:"setTo",value_t:"temperature",ext:"%f",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",extMeta:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"float",name:"up",ref:{value:"up",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}},{type:"float",name:"down",ref:{value:"down",ext:"%f",extMeta:"0.1-5.0",scale:"0.1"}}],status:[{type:"enum",
name:"mode",ref:{value:"mode",options:"HOME SLEEP AWAY MANUAL NO_FREEZE FROZEN_PROTECTION".split(" ")}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"insideTemp"}},{type:"int",name:"humidity",ref:{value:"humidity"}},{type:"int",name:"heating power",ref:{value:"heatingPower"}},{type:"float",name:"set temperature",ref:{value:"temp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"current manu termination mode",ref:{value:"manuEndMode",
ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"current manu termination timer",ref:{value:"manuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}},{type:"string",name:"current manu termination auto expire time",ref:{value:"manuEndAutoExpire",ext:"%s"}},{type:"int",name:"current manu termination timer remain (min)",ref:{value:"manuEndTimerRemain",unit:"min"}},{type:"int",name:"current manu termination timer remain (s)",ref:{value:"manuEndTimerRemainS",unit:"s"}},{type:"string",name:"current manu termination timer remain (text)",
ref:{value:"manuEndTimerRemainTxt"}},{type:"float",name:"set manu temperature",ref:{value:"setManutemp",extMeta:"5.0-25.0",scale:"0.1"}},{type:"enum",name:"set manu termination mode",ref:{value:"setManuEndMode",ext:"%e",options:["MANUAL","TIMER","TADO_MODE"]}},{type:"int",name:"set manu termination timer",ref:{value:"setManuEndTimer",ext:"%d",extMeta:"1-720",unit:"min"}}]}};return{SYS:"tado",getGatewayType:function(){return[{sys:this.SYS,name:"tado\u00b0"}]},getGatewayDeviceType:function(b,a){return[{type:"thermo",
name:"Smart Thermostat",sys:this.SYS}]},createGateway:function(b,a,d){a=f.ERROR_CODE;b?b.username?b.password?d(null,b):d(new f(a.INVALID,"password is invalid")):d(new f(a.INVALID,"username is invalid")):d(new f(a.INVALID,"info is invalid"))},updateGateway:function(b,a,d,c){b=f.ERROR_CODE;a?a.username?a.password?c(null,a):c(new f(b.INVALID,"password is invalid")):c(new f(b.INVALID,"username is invalid")):c(new f(b.INVALID,"info is invalid"))},deleteGateway:function(b,a,d){d()},createDevice:function(b,
a,d){var c=f.ERROR_CODE;if(b)if(b.gateway)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===b.gateway){var m=a[e];break}m?d(null,b):d(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else d(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else d(new f(c.INVALID,"type is invalid"));else d(new f(c.INVALID,"gateway is invalid"));else d(new f(c.INVALID,"info is invalid"))},updateDevice:function(b,
a,d){var c=f.ERROR_CODE;if(b)if(b.gateway)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var e;for(e=0;e<a.length;e++)if(a[e].index===b.gateway){var m=a[e];break}m?d(null,b):d(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else d(new f(c.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else d(new f(c.INVALID,"type is invalid"));else d(new f(c.INVALID,"gateway is invalid"));else d(new f(c.INVALID,"info is invalid"))},deleteDevice:function(b,
a,d){d()},applyUIFilter:function(b,a,d){var c=this,e=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=e(a.children,b,c);f&&0<f.length&&(a.children=f,d.push(a))}else{f=c.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},f=function(a,b){var f=[],g=c.getCommandStatusMap(a,d);if(g){var h=[];switch(b.catagory){case "command":g.command&&(h=e(g.command,
a,b));break;case "status":g.status&&(h=e(g.status,a,b))}f=f.concat(h)}return f};if(!b.sys)return null;var l=JSON.parse(JSON.stringify(b)),g=null;switch(a.catagory){case "command":g=f(b,a);l.command=g;break;case "status":g=f(b,a);l.status=g;break;default:return null}return g&&0!=g.length?l:null},getCommandStatusMap:function(b){return b&&b.type?e[b.type]:null}}}();
xnm.aio.tado.Handler=function(){var f=function(){};f.prototype.Bridge=xnm.aio.tado.Bridge;f.prototype.BridgeV2=xnm.aio.tado.BridgeV2;f.prototype.devicemanager=xnm.aio.tado.DM;f.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"tado")};f.prototype.resolveGateway=function(e){return e?this.BridgeV2.parseJSON(e):null};f.prototype.getDeviceCommands=function(e,b){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}))?e.command:[];b&&b(null,e)};f.prototype.getDeviceStatus=
function(e,b){e=(e=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}))?e.status:[];b&&b(null,e)};f.prototype.doCommand=function(e,b,a,d){(e=this.resolveGateway(e))?e.executeCommandCreator(b,a,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};f.prototype.doStatus=function(e,b,a,d,c){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:e,device:a,status:d}],function(a,b){a?c&&c(a):c&&c(null,b[0])}):c&&c(Error("gateway json format invalid"))};f.prototype.getDeviceList=
function(e,b){(e=this.resolveGateway(e))?e.getZones(function(a,d){b&&b(a,d)}):b&&b(Error("gateway json format invalid"))};f.prototype.getStateValues=function(e,b){};f.prototype.getDeviceCommandList=function(e,b,a){e=[];b&&(e.push({id:window.XC_Text.on,cmd:"on"}),e.push({id:window.XC_Text.off,cmd:"off"}));return e};return f}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.tado.Handler);
