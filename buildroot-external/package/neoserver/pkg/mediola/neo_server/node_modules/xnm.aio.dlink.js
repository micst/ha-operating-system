var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,b,a){d instanceof String&&(d=String(d));for(var c=d.length,e=0;e<c;e++){var f=d[e];if(b.call(a,f,e,d))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,b,a){d!=Array.prototype&&d!=Object.prototype&&(d[b]=a.value)};$jscomp.getGlobal=function(d){d=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,d];for(var b=0;b<d.length;++b){var a=d[b];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,b,a,c){if(b){a=$jscomp.global;d=d.split(".");for(c=0;c<d.length-1;c++){var e=d[c];e in a||(a[e]={});a=a[e]}d=d[d.length-1];c=a[d];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,d,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.dlink=xnm.aio.dlink||{};
xnm.aio.dlink.WifiDevice=function(){var d=function(b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiDevice");b&&(this.ip=b.ip,this.port=b.port,this.port||(this.port=80),this.username=b.username,this.username||(this.username="admin"),this.password=b.password,this.model=b.model,this.mac=b.mac);this._logginTime=this._cookie=this._privateKey=this._challenge=null;this._loginRunning=!1;this._loginCallbacks=[]};d.prototype.HNAP_PATH=
"/HNAP1";d.prototype.HNAP_METHOD="POST";d.prototype.HNAP1_XMLNS="http://purenetworks.com/HNAP1/";d.prototype.HNAP_LOGIN_ACTION="Login";d.prototype.toJSON=function(){return{sys:"dlink",type:"wifi",model:this.model,mac:this.mac,ip:this.ip,port:this.port,username:this.username,password:this.password}};d.prototype.equalsTo=function(b){return b&&b instanceof d?this.type==b.type&&this.data==b.data&&this.ip==b.ip&&this.port==b.port&&this.username==b.username&&this.password==b.password:!1};d.prototype.getStatesCreator=
function(b,a,c){b=[];for(var e=0;e<a.length;e++)if(a[e]&&a[e].id&&a[e].status&&a[e].status.value){var f=a[e].status.value;-1==b.indexOf(f)&&b.push(f)}this._getStates(b,function(b,e){b=[];for(var f=0;f<a.length;f++)if(a[f]&&a[f].id){var g="?";if(e&&a[f].status&&a[f].status.value){var h=a[f].status.value;null!=e[h]&&"undefined"!=typeof e[h]&&(g=e[h])}b.push({id:a[f].id,status:g})}c&&c(null,b)})};d.prototype._getModuleProfile=function(b,a){this._doAction("GetModuleProfile",this._requestBody("GetModuleProfile",
this._moduleParameters(b)),"GetModuleProfileResponse",function(b,e){b?a&&a(b):e?(b=e.find("GetModuleProfileResult"))&&0!=b.length?"OK"!=$(b[0]).text()?a&&a(Error("get module profile fail")):a&&a(null,e):a&&a(Error("get module profile without GetModuleProfileResult")):a&&a(Error("get module profile format error"))})};d.prototype._moduleParameters=function(b){return"<ModuleID>"+b+"</ModuleID>"};d.prototype._doAction=function(b,a,c,e){if(this._logginTime){var f=(new Date).getTime()-this._logginTime;
if(0>f||3E5<f)this._logginTime=this._cookie=this._privateKey=this._challenge=null}if(this._challenge&&this._privateKey&&this._cookie)this._soapAction(b,a,c,e);else{var g=this;this._login(function(f){f?e&&e(f):g._doAction(b,a,c,e)})}};d.prototype._loginRequest=function(){return"<Action>request</Action><Username>"+this.username+"</Username><LoginPassword></LoginPassword><Captcha></Captcha>"};d.prototype._loginParameters=function(){var b=require("x.crypt.js").HMAC_MD5(this._privateKey,this._challenge);
return"<Action>login</Action><Username>"+this.username+"</Username><LoginPassword>"+b.toUpperCase()+"</LoginPassword><Captcha></Captcha>"};d.prototype._handleLoginResult=function(b){var a=b.find("Challenge")[0];if(!a)return!1;this._challenge=a=$(a).text();var c=b.find("PublicKey")[0];if(!c)return!1;c=$(c).text();b=b.find("Cookie")[0];if(!b)return!1;this._cookie=b=$(b).text();this._privateKey=require("x.crypt.js").HMAC_MD5(c+this.password,a).toUpperCase();return!0};d.prototype._login=function(b){b&&
-1==this._loginCallbacks.indexOf(b)&&this._loginCallbacks.push(b);if(!this._loginRunning){this._loginRunning=!0;var a=this;this._soapAction(this.HNAP_LOGIN_ACTION,this._requestBody(this.HNAP_LOGIN_ACTION,this._loginRequest()),"LoginResponse",function(b,e){b?(a._loginRunning=!1,e=a._loginCallbacks,a._loginCallbacks=[],e.forEach(function(a){a&&a(b)})):a._handleLoginResult(e)?(a._logginTime=(new Date).getTime(),a._soapAction(a.HNAP_LOGIN_ACTION,a._requestBody(a.HNAP_LOGIN_ACTION,a._loginParameters()),
"LoginResult",function(b,c){!b&&c&&"success"!=c.text()&&(b=Error("login failed"));a._loginRunning=!1;c=a._loginCallbacks;a._loginCallbacks=[];c.forEach(function(a){a&&a(b)})})):(b=Error("LoginResponse format error"),a._loginRunning=!1,e=a._loginCallbacks,a._loginCallbacks=[],e.forEach(function(a){a&&a(b)}))})}};d.prototype._requestBody=function(b,a){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+
b+' xmlns="'+this.HNAP1_XMLNS+'">'+a+"</"+b+"></soap:Body></soap:Envelope>"};d.prototype._getHnapAuth=function(b,a){var c=Math.round((new Date).getTime()/1E3);return require("x.crypt.js").HMAC_MD5(a,c+b).toUpperCase()+" "+c};d.prototype._soapAction=function(b,a,c,e){var f={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"'+this.HNAP1_XMLNS+b+'"'};this._privateKey&&(f.HNAP_AUTH=this._getHnapAuth('"'+this.HNAP1_XMLNS+b+'"',this._privateKey));this._cookie&&(f.Cookie="uid="+this._cookie);var g=this;
this._doRequest(this.HNAP_METHOD,this.HNAP_PATH,f,a,function(f,d,k){if(f)e&&e(f);else if(401==k)g._logger.log("warn","unauthorized soap action"),g._challenge=null,g._privateKey=null,g._cookie=null,g._login(function(f){f?e&&e(f):g._soapAction(b,a,c,e)});else if(200!=k)g._logger.log("warn","http request error with status code:"+k),e&&e(Error("http request error with status code:"+k));else try{var h=null;$($($.parseXML(d)).children()[0]).find(c).each(function(){h=$(this)});h?e&&e(null,h):e&&e(Error("no response element:"+
c))}catch(n){e&&e(n)}})};d.prototype._doRequest=function(b,a,c,e,f){this._reqBuffer||(this._reqBuffer=[],this._totalReqNo=0);for(var g=0,h=0;h<this._reqBuffer.length;h++)this._reqBuffer[h].running&&g++;b={method:b,path:a,headers:c,data:e,callback:f,running:!1,no:this._totalReqNo++};this._reqBuffer.push(b);10>g&&this._doNextReq()};d.prototype._doNextReq=function(){for(var b=this,a=null,c=0;c<this._reqBuffer.length;c++)if(!this._reqBuffer[c].running){a=this._reqBuffer[c];break}if(a){a.running=!0;var e=
function(c,g,h){a.callback&&a.callback(c,g,h);c=b._reqBuffer.indexOf(e.__req);b._reqBuffer.splice(c,1);b._doNextReq()};e.__req=a;this._doRequest_(a.method,a.path,a.headers,a.data,e)}};d.prototype._doRequest_=function(b,a,c,e,f){var g=this;this._logger.log("trace","send "+b+" to url:http://"+(this.ip+":"+this.port+a));this._logger.log("trace","with headers:"+JSON.stringify(c));this._logger.log("trace","with data:"+e);var h=f;b={host:this.ip,port:this.port,path:a,method:b,headers:c};b.headers||(b.headers=
{});b.headers["Content-Type"]="text/xml";b.headers["Content-Length"]=e.length;b.headers["User-Agent"]="mediola";b.headers.Connection="close";var d="",k=require("http").request(b,function(b){b.on("data",function(b){d+=b});b.on("end",function(){g._logger.log("trace","http reponse status code:"+b.statusCode);g._logger.log("trace","http reponse:"+d);h&&h(null,d,b.statusCode);h=null})});k.setTimeout&&k.setTimeout(2E4,function(){k.abort()});if(k.on&&"function"==typeof k.on)k.on("error",function(b){b||(b=
Error("http request error"));h&&h(b);h=null});k.write(e);k.end()};d.parseJSON=function(b){if(!(b&&"wifi"==b.type&&b.data&&b.ip&&b.password))return null;switch(b.data){case "switch":return new xnm.aio.dlink.WifiPlug(b);case "motion":return new xnm.aio.dlink.WifiMotion(b);case "siren":return new xnm.aio.dlink.WifiSiren(b);case "water":return new xnm.aio.dlink.WifiWater(b);case "hub":return new xnm.aio.dlink.WifiHub(b);default:return null}};return d}();
xnm.aio.dlink.WifiPlug=function(){var d=function(b){xnm.aio.dlink.WifiDevice.call(this,b);this._getSettingsCbs=[];this._getReadyCbs=[];this._getTempCbs=[];this._getPowerCbs=[];this._getTotalPCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiPlug")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var b=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);b.data="switch";
return b};d.prototype.executeCommandCreator=function(b,a,c){if(a&&a.value){var e=this;switch(a.value){case "on":case "off":xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0)?"on"==a.value?this._on(c):this._off(c):this._getSocketSettings(function(f){f?c&&c(f):e.executeCommandCreator(b,a,c)});break;case "toggle":this._getOnOffState(function(a,g){a?c&&c(a):e.executeCommandCreator(b,{value:"off"==g?"on":"off"},c)});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command json format invalid"))};
d.prototype._controlParameters=function(b,a,c,e){return this._moduleParameters(b)+"<NickName>"+a+"</NickName><Description>"+c+"</Description><OPStatus>"+e+"</OPStatus><Controller>1</Controller>"};d.prototype._on=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),c=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,a.nickName,a.description,!0)),"SetSocketSettingsResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("turn plug on failed"));
a||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,{opStatus:"true"});b&&b(a)})};d.prototype._off=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),c=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,a.nickName,a.description,!1)),"SetSocketSettingsResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("turn plug off failed"));a||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,{opStatus:"false"});b&&b(a)})};d.prototype._getStates=
function(b,a){if(b&&0!=b.length)for(var c={},e=0,f=function(){e++;e==b.length&&a&&a(null,c)},g=0;g<b.length;g++)switch(b[g]){case "ready":this._getDeviceReadyState(function(b,a){!b&&a&&(c.ready=a);f()});break;case "state":this._getOnOffState(function(b,a){!b&&a&&(c.state=a);f()});break;case "temp":this._getTempState(function(b,a){!b&&a&&(c.temp=a);f()});break;case "power":this._getCurrentPowerState(function(b,a){!b&&a&&(c.power=a);f()});break;case "totalPower":this._getTotalPowerState(function(b,
a){!b&&a&&(c.totalPower=a);f()});break;default:f()}else a&&a(null,{})};d.prototype._getSocketSettings=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&a.opStatus&&a.nickName&&a.description)b&&b(null,a);else if(a=this._getSettingsCbs.length,b&&-1==this._getSettingsCbs.indexOf(b)&&this._getSettingsCbs.push(b),0==a){var c=this;this._doAction("GetSocketSettings",this._requestBody("GetSocketSettings",this._moduleParameters(1)),"GetSocketSettingsResponse",function(b,a){var e=
c._getSettingsCbs;c._getSettingsCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var f=a.find("GetSocketSettingsResult");if(f&&f[0]&&"OK"==$(f[0]).text()){var d=null,k=null,l=null;a.find("NickName").each(function(){k||(k=$(this).text())});a.find("Description").each(function(){l||(l=$(this).text())});a.find("OPStatus").each(function(){d||(d=$(this).text())});var n={nickName:k,description:l,opStatus:d};xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,n);e.forEach(function(b){b&&b(null,n)})}else b=
Error("get socket settings failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get switch on/off state result format error"),e.forEach(function(a){a&&a(b)})})}};d.prototype._getDeviceReadyState=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.ready&&null!=a.ready)b&&b(null,a.ready);else if(a=this._getReadyCbs.length,b&&-1==this._getReadyCbs.indexOf(b)&&this._getReadyCbs.push(b),0==a){var c=this;this._doAction("IsDeviceReady",this._requestBody("IsDeviceReady",
""),"IsDeviceReadyResult",function(b,a){var e=c._getReadyCbs;c._getReadyCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var f="OK"==a.text()?"true":"false";xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,{ready:f});e.forEach(function(b){b&&b(null,f)})}else b=Error("get device ready state result format error"),e.forEach(function(a){a&&a(b)})})}};d.prototype._getOnOffState=function(b){this._getSocketSettings(function(a,c){a?b&&b(a):(a=c.opStatus,b&&b(null,"true"==a?"on":"false"==a?"off":"?"))})};
d.prototype._getTempState=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.temp&&null!=a.temp)b&&b(null,a.temp);else if(a=this._getTempCbs.length,b&&-1==this._getTempCbs.indexOf(b)&&this._getTempCbs.push(b),0==a){var c=this;this._doAction("GetCurrentTemperature",this._requestBody("GetCurrentTemperature",this._moduleParameters(3)),"CurrentTemperature",function(b,a){var e=c._getTempCbs;c._getTempCbs=[];b?e.forEach(function(a){a&&a(b)}):a?(xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,
0,{temp:a.text()}),e.forEach(function(b){b&&b(null,a.text())})):(b=Error("get temperature state result format error"),e.forEach(function(a){a&&a(b)}))})}};d.prototype._getCurrentPowerState=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.power&&null!=a.power)b&&b(null,a.power);else if(a=this._getPowerCbs.length,b&&-1==this._getPowerCbs.indexOf(b)&&this._getPowerCbs.push(b),0==a){var c=this;this._doAction("GetCurrentPowerConsumption",this._requestBody("GetCurrentPowerConsumption",
this._moduleParameters(2)),"CurrentConsumption",function(a,b){var e=c._getPowerCbs;c._getPowerCbs=[];a?e.forEach(function(b){b&&b(a)}):b?(xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,{power:b.text()}),e.forEach(function(a){a&&a(null,b.text())})):(a=Error("get current power state result format error"),e.forEach(function(b){b&&b(a)}))})}};d.prototype._getTotalPowerState=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(a&&"undefined"!=typeof a.totalPower&&null!=a.totalPower)b&&
b(null,a.totalPower);else if(a=this._getTotalPCbs.length,b&&-1==this._getTotalPCbs.indexOf(b)&&this._getTotalPCbs.push(b),0==a){var c=this;this._doAction("GetPMWarningThreshold",this._requestBody("GetPMWarningThreshold",this._moduleParameters(2)),"TotalConsumption",function(b,a){var e=c._getTotalPCbs;c._getTotalPCbs=[];b?e.forEach(function(a){a&&a(b)}):a?(xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,0,{totalPower:a.text()}),e.forEach(function(b){b&&b(null,a.text())})):(b=Error("get total power state result format error"),
e.forEach(function(a){a&&a(b)}))})}};return d}();
xnm.aio.dlink.WifiMotion=function(){var d=function(b){xnm.aio.dlink.WifiDevice.call(this,b);this._getSettingsCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiMotion")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var b=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);b.data="motion";return b};d.prototype.executeCommandCreator=function(b,
a,c){if(a&&a.value){var e=this;switch(a.value){case "activate":case "deactivate":case "actToggle":case "sensTo":case "sensUp":case "sensDown":this._getMotionDetectorSettings(function(b,g){if(b)c&&c(b);else switch(a.value){case "activate":case "deactivate":e._setDetectorActive("activate"==a.value,c);break;case "actToggle":e._setDetectorActive("true"!=g.opStatus,c);break;case "sensTo":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}b=parseInt(a.ext);0>=b&&(b=1);100<
b&&(b=100);e._setDetectorSensitivity(b,c);break;case "sensUp":case "sensDown":b=parseInt(g.sensitivity),b="sensUp"==a.value?b+5:b-5,0>=b&&(b=1),100<b&&(b=100),e._setDetectorSensitivity(b,c)}});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command json format invalid"))};d.prototype._controlParameters=function(b,a){return this._moduleParameters(b)+"<NickName>"+a.nickName+"</NickName><Description>"+a.description+"</Description><OPStatus>"+a.opStatus+"</OPStatus><Sensitivity>"+a.sensitivity+
"</Sensitivity><Backoff>"+a.backoff+"</Backoff>"};d.prototype._getStates=function(b,a){if(b&&0!=b.length)for(var c={},e=0,f=function(){e++;e==b.length&&a&&a(null,c)},g=0;g<b.length;g++)switch(b[g]){case "active":this._getActiveState(function(b,a){!b&&a&&(c.active=a);f()});break;case "sens":this._getSensitivityState(function(b,a){!b&&a&&(c.sens=a);f()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(b,a){!b&&a&&(c.dectTime=a,c.dectTimeStr=(new Date(1E3*a)).toLocaleString());
f()});break;default:f()}else a&&a(null,{})};d.prototype._setDetectorActive=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.opStatus=b+"";this._setMotionDetectorSettings(c,a)};d.prototype._setDetectorSensitivity=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.sensitivity=b+"";this._setMotionDetectorSettings(c,a)};d.prototype._setMotionDetectorSettings=function(b,a){var c=this;this._doAction("SetMotionDetectorSettings",this._requestBody("SetMotionDetectorSettings",
this._controlParameters(1,b)),"SetMotionDetectorSettingsResult",function(e,f){e||f&&"OK"==f.text()||(e=Error("turn plug on failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,b);a&&a(e)})};d.prototype._getActiveState=function(b){this._getMotionDetectorSettings(function(a,c){a?b&&b(a):(a=c.opStatus,b&&b(null,a))})};d.prototype._getSensitivityState=function(b){this._getMotionDetectorSettings(function(a,c){a?b&&b(a):(a=c.sensitivity,b&&b(null,a))})};d.prototype._getMotionDetectorSettings=function(b){var a=
xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.backoff&&a.sensitivity&&a.opStatus&&a.nickName&&a.description)b&&b(null,a);else if(a=this._getSettingsCbs.length,b&&-1==this._getSettingsCbs.indexOf(b)&&this._getSettingsCbs.push(b),0==a){var c=this;this._doAction("GetMotionDetectorSettings",this._requestBody("GetMotionDetectorSettings",this._moduleParameters(1)),"GetMotionDetectorSettingsResponse",function(b,a){var e=c._getSettingsCbs;c._getSettingsCbs=[];if(b)e.forEach(function(a){a&&
a(b)});else if(a){var f=a.find("GetMotionDetectorSettingsResult");if(f&&f[0]&&"OK"==$(f[0]).text()){var d={nickName:null,description:null,opStatus:null,sensitivity:null,backoff:null};a.find("NickName").each(function(){d.nickName=$(this).text()});a.find("Description").each(function(){d.description=$(this).text()});a.find("OPStatus").each(function(){d.opStatus=$(this).text()});a.find("Sensitivity").each(function(){d.sensitivity=$(this).text()});a.find("Backoff").each(function(){d.backoff=$(this).text()});
xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,d);e.forEach(function(b){b&&b(null,d)})}else b=Error("get socket settings failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get motion detector settings result format error"),e.forEach(function(a){a&&a(b)})})}};d.prototype._getDetectTime=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.lastDetect)b&&b(null,a.lastDetect);else if(a=this._getLastDetectCbs.length,b&&-1==this._getLastDetectCbs.indexOf(b)&&this._getLastDetectCbs.push(b),
0==a){var c=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(b,a){var e=c._getLastDetectCbs;c._getLastDetectCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var f=a.find("GetLatestDetectionResult");if(f&&f[0]&&"OK"==$(f[0]).text())if((a=a.find("LatestDetectTime"))&&a[0]){var d=$(a[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,{lastDetect:d});e.forEach(function(b){b&&b(null,d)})}else b=
Error("get motion detector no LatestDetectTime parameter"),e.forEach(function(a){a&&a(b)});else b=Error("get motion detector last detection failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get motion detector last detection result format error"),e.forEach(function(a){a&&a(b)})})}};return d}();
xnm.aio.dlink.WifiSiren=function(){var d=function(b){xnm.aio.dlink.WifiDevice.call(this,b);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiSiren")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");d.prototype.toJSON=function(){var b=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);b.data=
"siren";return b};d.prototype.executeCommandCreator=function(b,a,c){if(a&&a.value){var e=this,f;switch(a.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(function(b,d){if(b)c&&c(b);else switch(a.value){case "activate":case "deactivate":e._setSirenActive("activate"==a.value,function(b){c&&c(b)});break;case "actToggle":e._setSirenActive("true"!=d.opStatus,
function(b){c&&c(b)});break;case "setVolume":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}f=parseInt(a.ext);0>f&&(f=0);100<f&&(f=100);e._setSirenVolumn(f,function(b){c&&c(b)});break;case "volumeUp":case "volumeDown":f=parseInt(d.volume);100<f&&(f=100);f="volumeUp"==a.value?f+5:f-5;0>f&&(f=0);100<f&&(f=100);e._setSirenVolumn(f,function(b){c&&c(b)});break;case "setDuration":case "setDurationP":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));
break}e._setSirenDuration(a.ext,function(b){c&&c(b)});break;case "setTone":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}e._setSirenTone(a.ext,function(b){c&&c(b)});break;case "play":e._doAlarm(function(b){c&&c(b)})}});break;case "stop":this._stopAlarm(function(b){c&&c(b)});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command invalid"))};d.prototype._controlParameters=function(b,a,c,e,f,d,h){return this._moduleParameters(b)+"<NickName>"+a+"</NickName><Description>"+
c+"</Description><DefaultSound>"+e+"</DefaultSound><OPStatus>"+d+"</OPStatus><Volume>"+f+"</Volume><Duration>"+h+"</Duration>"};d.prototype._soundPlayParameters=function(b,a,c,e){return this._moduleParameters(b)+"<SoundType>"+a+"</SoundType><Volume>"+c+"</Volume><Duration>"+e+"</Duration><Controller>1</Controller>"};d.prototype._dissmissParameters=function(b){return this._moduleParameters(b)+"<Controller>1</Controller>"};d.prototype._doAlarm=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,
1),c=this;this._doAction("SetSoundPlay",this._requestBody("SetSoundPlay",this._soundPlayParameters(1,a.defaultSound,a.volume,a.duration)),"SetSoundPlayResult",function(a,f){a||f&&"OK"==f.text()||(a=Error("play siren failed"));a||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,{alarm:"true"});b&&b(a)})};d.prototype._stopAlarm=function(b){var a=this;this._doAction("SetAlarmDismissed",this._requestBody("SetAlarmDismissed",this._dissmissParameters(1)),"SetAlarmDismissedResult",function(c,e){c||e&&"OK"==
e.text()||(c=Error("stop siren failed"));c||xnm.aio.dlink._SettingsBuffer.setSettings(a.ip,1,{alarm:"false"});b&&b(c)})};d.prototype._setSirenActive=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.opStatus=b+"";this._setSirenAlarmSettings(c,a)};d.prototype._setSirenVolumn=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.volume=b+"";this._setSirenAlarmSettings(c,a)};d.prototype._setSirenDuration=function(b,a){switch(b){case "3s":b=3;break;case "10s":b=
10;break;case "30s":b=30;break;case "1min":b=60;break;case "repeat":b=88888;break;default:b=parseInt(b);if(isNaN(b)){a&&a(Error("invalid duration"));return}0>=b&&(b=1);86400<b&&(b=86400)}var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.duration=b+"";this._setSirenAlarmSettings(c,a)};d.prototype._setSirenTone=function(b,a){if(b=this.TONE.indexOf(b)+1){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.defaultSound=b+"";this._setSirenAlarmSettings(c,a)}else a&&a(Error("no such tone"))};
d.prototype._setSirenAlarmSettings=function(b,a){var c=this;this._doAction("SetSirenAlarmSettings",this._requestBody("SetSirenAlarmSettings",this._controlParameters(1,b.nickName,b.description,b.defaultSound,b.volume,b.opStatus,b.duration)),"SetSirenAlarmSettingsResult",function(e,f){e||f&&"OK"==f.text()||(e=Error("set siren settings failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,b);a&&a(e)})};d.prototype._getStates=function(b,a){if(b&&0!=b.length)for(var c={},e=0,f=function(){e++;e==
b.length&&a&&a(null,c)},d=this,h=!1,m=0;m<b.length;m++)switch(b[m]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":h?f():(h=!0,this._getSirenAlarmSettings(function(b,a){!b&&a&&(c.active=a.opStatus,c.tone=d.TONE[parseInt(a.defaultSound)-1],c.volume=parseInt(a.volume),999==c.volume&&(c.volume=100),c.alarm=a.alarm,c.duration=parseInt(a.duration),60>c.duration?c.durationStr=c.duration+"s":88888==c.duration||9999==c.duration?c.durationStr="repeat":(b=Math.floor(c.duration/
60),a=c.duration-60*b,c.durationStr=(b?b+"m":"")+(a?a+"s":"")));f()}));break;default:f()}else a&&a(null,{})};d.prototype._getSirenAlarmSettings=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.defaultSound&&a.opStatus&&a.nickName&&a.description&&a.volume&&a.duration&&a.alarm)b&&b(null,a);else if(a=this._getSettingsCbs.length,b&&-1==this._getSettingsCbs.indexOf(b)&&this._getSettingsCbs.push(b),0==a){var c=this;this._doAction("GetSirenAlarmSettings",this._requestBody("GetSirenAlarmSettings",
this._moduleParameters(1)),"GetSirenAlarmSettingsResponse",function(b,a){var e=c._getSettingsCbs;c._getSettingsCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var f=a.find("GetSirenAlarmSettingsResult");if(f&&f[0]&&"OK"==$(f[0]).text()){var d={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};a.find("NickName").each(function(){d.nickName=$(this).text()});a.find("Description").each(function(){d.description=$(this).text()});a.find("OPStatus").each(function(){d.opStatus=
$(this).text()});a.find("Volume").each(function(){d.volume=$(this).text()});a.find("Duration").each(function(){d.duration=$(this).text()});a.find("DefaultSound").each(function(){d.defaultSound=$(this).text()});a.find("IsSounding").each(function(){d.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,d);e.forEach(function(b){b&&b(null,d)})}else b=Error("get siren settings failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get siren settings result format error"),e.forEach(function(a){a&&
a(b)})})}};return d}();
xnm.aio.dlink.WifiWater=function(){var d=function(b){xnm.aio.dlink.WifiDevice.call(this,b);this._getSettingsCbs=[];this._getStateCbs=[];this._getLastDetectCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiWater")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var b=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);b.data="water";return b};d.prototype.executeCommandCreator=
function(b,a,c){if(a&&a.value){var e=this;switch(a.value){case "activate":case "deactivate":case "actToggle":this._getWaterDetectorSettings(function(b,d){if(b)c&&c(b);else switch(a.value){case "activate":case "deactivate":e._setDetectorActive("activate"==a.value,c);break;case "actToggle":e._setDetectorActive("true"!=d.opStatus,c)}});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command json format invalid"))};d.prototype._controlParameters=function(b,a){return this._moduleParameters(b)+
"<NickName>"+a.nickName+"</NickName><Description>"+a.description+"</Description><OPStatus>"+a.opStatus+"</OPStatus>"};d.prototype._setDetectorActive=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);c.opStatus=b+"";this._setWaterDetectorSettings(c,a)};d.prototype._setWaterDetectorSettings=function(b,a){var c=this;this._doAction("SetWaterDetectorSettings",this._requestBody("SetWaterDetectorSettings",this._controlParameters(1,b)),"SetWaterDetectorSettingsResult",function(e,f){e||
f&&"OK"==f.text()||(e=Error("turn plug on failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,b);a&&a(e)})};d.prototype._getStates=function(b,a){if(b&&0!=b.length)for(var c={},e=0,f=function(){e++;e==b.length&&a&&a(null,c)},d=0;d<b.length;d++)switch(b[d]){case "active":this._getActiveState(function(b,a){!b&&a&&(c.active=a);f()});break;case "state":this._getWaterDetectorState(function(b,a){!b&&a&&(c.state="true"==a?"water":"dry");f()});break;case "dectTime":case "dectTimeStr":this._getDetectTime(function(b,
a){!b&&a&&(c.dectTime=a,c.dectTimeStr=(new Date(1E3*a)).toLocaleString());f()});break;default:f()}else a&&a(null,{})};d.prototype._getActiveState=function(b){this._getWaterDetectorSettings(function(a,c){a?b&&b(a):(a=c.opStatus,b&&b(null,a))})};d.prototype._getDetectTime=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.lastDetect)b&&b(null,a.lastDetect);else if(a=this._getLastDetectCbs.length,b&&-1==this._getLastDetectCbs.indexOf(b)&&this._getLastDetectCbs.push(b),0==
a){var c=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(a,b){var e=c._getLastDetectCbs;c._getLastDetectCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(b){var f=b.find("GetLatestDetectionResult");if(f&&f[0]&&"OK"==$(f[0]).text())if((b=b.find("LatestDetectTime"))&&b[0]){var d=$(b[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,{lastDetect:d});e.forEach(function(b){b&&b(null,d)})}else a=
Error("get water detector no LatestDetectTime parameter"),e.forEach(function(b){b&&b(a)});else a=Error("get water detector detection time failed"),e.forEach(function(b){b&&b(a)})}else a=Error("get water detector detection time result format error"),e.forEach(function(b){b&&b(a)})})}};d.prototype._getWaterDetectorState=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.watering)b&&b(null,a.watering);else if(a=this._getStateCbs.length,b&&-1==this._getStateCbs.indexOf(b)&&
this._getStateCbs.push(b),0==a){var c=this;this._doAction("GetWaterDetectorState",this._requestBody("GetWaterDetectorState",this._moduleParameters(1)),"GetWaterDetectorStateResponse",function(b,a){var e=c._getStateCbs;c._getStateCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var f=a.find("GetWaterDetectorStateResult");if(f&&f[0]&&"OK"==$(f[0]).text())if((a=a.find("IsWater"))&&a[0]){var d=$(a[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,{watering:d});e.forEach(function(b){b&&
b(null,d)})}else b=Error("get water detector no IsWater parameter"),e.forEach(function(a){a&&a(b)});else b=Error("get water detector state failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get water detector state result format error"),e.forEach(function(a){a&&a(b)})})}};d.prototype._getWaterDetectorSettings=function(b){var a=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(a&&a.opStatus&&a.nickName&&a.description)b&&b(null,a);else if(a=this._getSettingsCbs.length,b&&-1==this._getSettingsCbs.indexOf(b)&&
this._getSettingsCbs.push(b),0==a){var c=this;this._doAction("GetWaterDetectorSettings",this._requestBody("GetWaterDetectorSettings",this._moduleParameters(1)),"GetWaterDetectorSettingsResponse",function(b,a){var e=c._getSettingsCbs;c._getSettingsCbs=[];if(b)e.forEach(function(a){a&&a(b)});else if(a){var d=a.find("GetWaterDetectorSettingsResult");if(d&&d[0]&&"OK"==$(d[0]).text()){var f={nickName:null,description:null,opStatus:null};a.find("NickName").each(function(){f.nickName=$(this).text()});a.find("Description").each(function(){f.description=
$(this).text()});a.find("OPStatus").each(function(){f.opStatus=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(c.ip,1,f);e.forEach(function(b){b&&b(null,f)})}else b=Error("get water detector settings failed"),e.forEach(function(a){a&&a(b)})}else b=Error("get water detector settings result format error"),e.forEach(function(a){a&&a(b)})})}};return d}();
xnm.aio.dlink.WifiHub=function(){var d=function(b){xnm.aio.dlink.WifiDevice.call(this,b);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.WifiHub")};d.prototype=new xnm.aio.dlink.WifiDevice;d.prototype.constructor=d;d.prototype.toJSON=function(){var b=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);b.data="hub";return b};d.prototype.listZwaveDevice=function(b){this._getModuleProfile(0,function(a,c){if(a)b&&b(a);else{var e=
[];c.find("ModuleProfile").each(function(){var b=$(this),a=b.find("ModuleID");a&&a[0]&&(a=$(a[0]).text());(b=b.find("ModuleSubType"))&&b[0]&&(b=$(b[0]).text());switch(b){case "Contact Sensor":e.push({sys:"dlink",type:"zwave",data:"contact",model:"DCH-Z110",node_id:a.substr(0,a.length-2)});break;case "Motion Detector":e.push({sys:"dlink",type:"zwave",data:"motion",model:"DCH-Z120",node_id:a.substr(0,a.length-2)});break;case "Siren Alarm":e.push({sys:"dlink",type:"zwave",data:"siren",model:"DCH-Z510",
node_id:a.substr(0,a.length-2)})}});b&&b(null,e)}})};d.prototype.executeCommandCreator=function(b,a,c){b?(b=xnm.aio.dlink.ZwaveDevice.parseJSON(b))?b.executeCommand(this,a,c):c&&c(Error("deviceJSON invalid")):c&&c(Error("gateway command not suppoort"))};d.prototype.getStatesCreator=function(b,a,c){for(var e={querys:[],dpts:[]},d={},g,h=0;h<a.length;h++)if(a[h]&&a[h].id&&a[h].device&&a[h].status)if(g=a[h].device,"wifi"==g.type&&"hub"==g.data)e.querys.push(a[h]),(g=a[h].status.value)&&-1==e.dpts.indexOf(g)&&
e.dpts.push(g);else if("zwave"==g.type&&g.data&&g.node_id){var m=g.node_id+"@"+g.data,k=d[m];k||(d[m]={device:g,querys:[]},k=d[m]);k.querys.push(a[h])}var l=this;this._getWifiStatesCreator(b,e,function(a,e){if(a)c&&c(a);else{var f=[];e&&(f=f.concat(e));l._getZwaveStatesCreator(b,d,function(a,b){!a&&b&&(f=f.concat(b));c&&c(null,f)})}})};d.prototype._getWifiStatesCreator=function(b,a,c){if(a&&a.querys&&0!=a.querys.length){var e=a.querys;this._getStates(a.dpts,function(a,b){a=[];for(var d=0;d<e.length;d++)if(e[d]&&
e[d].id){var f="?";if(b&&e[d].status&&e[d].status.value){var g=e[d].status.value;null!=b[g]&&"undefined"!=typeof b[g]&&(f=b[g])}a.push({id:e[d].id,status:f})}c&&c(null,a)})}else c&&c(null,[])};d.prototype._getZwaveStatesCreator=function(b,a,c){var e=[],d=0,g=0,h;for(h in a)a.hasOwnProperty(h)&&a[h]&&(e.push(a[h]),g++);if(0==g)c&&c(null,[]);else{var m=[],k=this,l=function(){d++;d==g&&(c&&c(null,m),c=null)};e.forEach(function(a){if(a.device&&a.querys&&0!=a.querys.length){var c=xnm.aio.dlink.ZwaveDevice.parseJSON(a.device);
c?c.getStatesCreator(k,b,a.querys,function(a,b){!a&&b&&(m=m.concat(b));l()}):l()}else l()})}};d.prototype._getStates=function(b,a){b&&0!=b.length||a&&a(null,{})};return d}();
xnm.aio.dlink._SettingsBuffer={_buffer:{},getSettings:function(d,b){if(!this._buffer[d]||!this._buffer[d][b])return null;d=this._buffer[d][b];b={};var a=Math.round((new Date).getTime()/1E3),c=0,e;for(e in d)if(d.hasOwnProperty(e)){var f=d[e];!f||!f.time||5<a-f.time||(c++,b[e]=f.value)}return c?b:null},setSettings:function(d,b,a){this._buffer[d]||(this._buffer[d]={});this._buffer[d][b]||(this._buffer[d][b]={});var c=Math.round((new Date).getTime()/1E3),e;for(e in a)a.hasOwnProperty(e)&&(this._buffer[d][b][e]||
(this._buffer[d][b][e]={}),this._buffer[d][b][e].value=a[e],this._buffer[d][b][e].time=c)}};
xnm.aio.dlink.ZwaveDevice=function(){var d=function(b){b&&(this.node_id=b.node_id);this._getTempCbs=[];this._getBriCbs=[];this._getBatCbs=[];this._getSabCbs=[]};d.prototype.getStatesCreator=function(b,a,c,e){a=[];for(var d=0;d<c.length;d++)if(c[d]&&c[d].id&&c[d].status&&c[d].status.value){var g=c[d].status.value;-1==a.indexOf(g)&&a.push(g)}this._getStates(b,a,function(a,b){a=[];for(var d=0;d<c.length;d++)if(c[d]&&c[d].id){var f="?";if(b&&c[d].status&&c[d].status.value){var g=c[d].status.value;null!=
b[g]&&"undefined"!=typeof b[g]&&(f=b[g])}a.push({id:c[d].id,status:f})}e&&e(null,a)})};d.prototype._moduleParameters=function(b){return"<ModuleID>"+b+"</ModuleID>"};d.prototype._getTempState=function(b,a,c){this._logger.log("debug","get zwave "+a+" temperature");var e=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(e&&"undefined"!=typeof e.temp&&null!=e.temp)c&&c(null,e.temp);else{var d=this._getTempCbs.length;c&&-1==this._getTempCbs.indexOf(c)&&this._getTempCbs.push(c);if(0==d){var g=
this;b._doAction("GetCurrentTemperature",b._requestBody("GetCurrentTemperature",this._moduleParameters(a)),"CurrentTemperature",function(c,d){var f=g._getTempCbs;g._getTempCbs=[];c?(g._logger.log("warn","get zwave "+a+" temperature error:"+c.stack),f.forEach(function(a){a&&a(c)})):d?(e||(e={}),e.temp=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,g.node_id,e),f.forEach(function(a){a&&a(null,d.text())})):(g._logger.log("warn","get zwave "+a+" temperature result format error"),c=Error("get contact temperature state result format error"),
f.forEach(function(a){a&&a(c)}))})}}};d.prototype._getBriState=function(b,a,c){this._logger.log("debug","get zwave "+a+" brightness");var e=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(e&&"undefined"!=typeof e.bri&&null!=e.bri)c&&c(null,e.bri);else{var d=this._getBriCbs.length;c&&-1==this._getBriCbs.indexOf(c)&&this._getBriCbs.push(c);if(0==d){var g=this;b._doAction("GetIllumination",b._requestBody("GetIllumination",this._moduleParameters(a)),"Illumination",function(c,d){var f=
g._getTempCbs;g._getTempCbs=[];c?(g._logger.log("warn","get zwave "+a+" brightness error:"+c.stack),f.forEach(function(a){a&&a(c)})):d?(e||(e={}),e.bri=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,g.node_id,e),f.forEach(function(a){a&&a(null,d.text())})):(g._logger.log("warn","get zwave "+a+" brightness result format error"),c=Error("get contact brightness state result format error"),f.forEach(function(a){a&&a(c)}))})}}};d.prototype._getBatteryState=function(b,a,c){this._logger.log("debug",
"get zwave "+a+" battery");var e=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(e&&"undefined"!=typeof e.bat&&null!=e.bat)c&&c(null,e.bat);else{var d=this._getBatCbs.length;c&&-1==this._getBatCbs.indexOf(c)&&this._getBatCbs.push(c);if(0==d){var g=this;b._doAction("GetBatteryLevel",b._requestBody("GetBatteryLevel",this._moduleParameters(a)),"BatteryLevel",function(c,d){var f=g._getBatCbs;g._getBatCbs=[];c?(g._logger.log("warn","get zwave "+a+" battery error:"+c.stack),f.forEach(function(a){a&&
a(c)})):d?(e||(e={}),e.bat=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,g.node_id,e),f.forEach(function(a){a&&a(null,d.text())})):(g._logger.log("warn","get zwave "+a+" battery result format error"),c=Error("get contact battery state result format error"),f.forEach(function(a){a&&a(c)}))})}}};d.prototype._getSaboState=function(b,a,c){this._logger.log("debug","get zwave "+a+" sabotage");var e=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(e&&"undefined"!=typeof e.sabo&&
null!=e.sabo)c&&c(null,e.sabo);else{var d=this._getSabCbs.length;c&&-1==this._getSabCbs.indexOf(c)&&this._getSabCbs.push(c);if(0==d){var g=this;b._doAction("GetTamperSensorState",b._requestBody("GetTamperSensorState",this._moduleParameters(a)),"TamperState",function(c,d){var f=g._getSabCbs;g._getSabCbs=[];c?(g._logger.log("warn","get zwave "+a+" sabotage error:"+c.stack),f.forEach(function(a){a&&a(c)})):d?(e||(e={}),e.sabo=d.text(),xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,g.node_id,e),f.forEach(function(a){a&&
a(null,d.text())})):(g._logger.log("warn","get zwave "+a+" sabotage result format error"),c=Error("get contact sabotage state result format error"),f.forEach(function(a){a&&a(c)}))})}}};d.parseJSON=function(b){if(!b||"zwave"!=b.type||!b.data||!b.node_id)return null;switch(b.data){case "contact":return new xnm.aio.dlink.ZwaveContact(b);case "motion":return new xnm.aio.dlink.ZwaveMotion(b);case "siren":return new xnm.aio.dlink.ZwaveSiren(b);default:return null}};return d}();
xnm.aio.dlink.ZwaveContact=function(){var d=function(b){xnm.aio.dlink.ZwaveDevice.call(this,b);this._getActivCbs=[];this._getOpenCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveContact ")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.executeCommand=function(b,a,c){if(a&&a.value){var e=this;switch(a.value){case "activate":case "deactivate":this._setActive(b,"activate"==a.value,
c);break;case "actToggle":this._getActiveState(b,function(a,d){a?c&&c(a):e.executeCommand(b,{value:"true"==d?"deactivate":"activate"},c)});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command invalid"))};d.prototype._getStates=function(b,a,c){if(a&&0!=a.length)for(var e={},d=0,g=function(){d++;d==a.length&&c&&c(null,e)},h=0;h<a.length;h++)switch(a[h]){case "active":this._getActiveState(b,function(a,b){!a&&b&&(e.active=b);g()});break;case "state":this._getOpenState(b,function(a,b){!a&&
b&&(e.state=b);g()});break;case "temp":this._getTempState(b,this.node_id+"03",function(a,b){!a&&b&&(e.temp=b);g()});break;case "bri":this._getBriState(b,this.node_id+"04",function(a,b){!a&&b&&(e.bri=b);g()});break;case "bat":this._getBatteryState(b,this.node_id+"05",function(a,b){!a&&b&&(e.bat=b);g()});break;case "sabo":this._getSaboState(b,this.node_id+"02",function(a,b){!a&&b&&(e.sabo=b);g()});break;default:g()}else c&&c(null,{})};d.prototype._controlParameters=function(b,a){return this._moduleParameters(b)+
"<OPStatus>"+a+"</OPStatus>"};d.prototype._setActive=function(b,a,c){var e=this;b._doAction("SetContactSensorSettings",b._requestBody("SetContactSensorSettings",this._controlParameters(this.node_id+"01",a)),"SetContactSensorSettingsResult",function(d,g){d||g&&"OK"==g.text()||(d=Error("activate contact failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,e.node_id,{active:a+""});c&&c(d)})};d.prototype._getActiveState=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);
if(c&&"undefined"!=typeof c.active&&null!=c.active)a&&a(null,c.active);else{var e=this._getActivCbs.length;a&&-1==this._getActivCbs.indexOf(a)&&this._getActivCbs.push(a);if(0==e){var d=this;b._doAction("GetContactSensorSettings",b._requestBody("GetContactSensorSettings",this._moduleParameters(this.node_id+"01")),"OPStatus",function(e,f){var g=d._getActivCbs;d._getActivCbs=[];e?g.forEach(function(a){a&&a(e)}):f?(c||(c={}),c.active=f.text(),xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,c),
a&&a(null,f.text())):(e=Error("get contact active state result format error"),g.forEach(function(a){a&&a(e)}))})}}};d.prototype._getOpenState=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(c&&"undefined"!=typeof c.state&&null!=c.state)a&&a(null,c.state);else{var e=this._getOpenCbs.length;a&&-1==this._getOpenCbs.indexOf(a)&&this._getOpenCbs.push(a);if(0==e){var d=this;b._doAction("GetContactSensorState",b._requestBody("GetContactSensorState",this._moduleParameters(this.node_id+
"01")),"ContactState",function(e,f){var g=d._getOpenCbs;d._getOpenCbs=[];e?g.forEach(function(a){a&&a(e)}):f?(f=f.text(),"true"==f?f="closed":"false"==f&&(f="open"),c||(c={}),c.state=f,xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,c),a&&a(null,f)):(e=Error("get contact open state result format error"),g.forEach(function(a){a&&a(e)}))})}}};return d}();
xnm.aio.dlink.ZwaveMotion=function(){var d=function(b){xnm.aio.dlink.ZwaveDevice.call(this,b);this._getSettingsCbs=[];this._getDetecCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveMotion")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.executeCommand=function(b,a,c){if(a&&a.value){var e=this,d;switch(a.value){case "activate":case "deactivate":(d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,
this.node_id))?this._setMotionDetectorActive(b,"activate"==a.value,function(a){c&&c(a)}):this._getMotionDetectorSettings(b,function(d){d?c&&c(d):e.executeCommand(b,a,c)});break;case "actToggle":this._getMotionDetectorSettings(b,function(a,d){a?c&&c(a):e.executeCommand(b,{value:"true"==d.opStatus?"deactivate":"activate"},c)});break;case "sensTo":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}var g=parseInt(a.ext);1>g&&(g=1);100<g&&(g=100);(d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,
this.node_id))?this._setMotionDetectorSensitivity(b,g,function(a){c&&c(a)}):this._getMotionDetectorSettings(b,function(d){d?c&&c(d):e.executeCommand(b,a,c)});break;case "sensUp":case "sensDown":this._getMotionDetectorSettings(b,function(d,f){d?c&&c(d):(d=parseInt(f.sensitivity),1==d||100==d?c&&c():("sensUp"==a.value?d+=5:"sensDown"==a.value&&(d-=5),e.executeCommand(b,{value:"sensTo",ext:d},c)))});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command invalid"))};d.prototype._getStates=
function(b,a,c){if(a&&0!=a.length)for(var e={},d=0,g=function(){d++;d==a.length&&c&&c(null,e)},h=!1,m=!1,k=0;k<a.length;k++)switch(a[k]){case "active":case "sens":h?g():(h=!0,this._getMotionDetectorSettings(b,function(a,b){!a&&b&&(e.active=b.opStatus,e.sens=b.sensitivity);g()}));break;case "dectTime":case "dectTimeStr":m?g():(m=!0,this._getLastDetectionState(b,function(a,b){!a&&b&&(e.dectTime=b,b=parseInt(b),e.dectTimeStr=(new Date(1E3*b)).toLocaleString());g()}));break;case "temp":this._getTempState(b,
this.node_id+"03",function(a,b){!a&&b&&(e.temp=b);g()});break;case "bri":this._getBriState(b,this.node_id+"04",function(a,b){!a&&b&&(e.bri=b);g()});break;case "bat":this._getBatteryState(b,this.node_id+"05",function(a,b){!a&&b&&(e.bat=b);g()});break;case "sabo":this._getSaboState(b,this.node_id+"02",function(a,b){!a&&b&&(e.sabo=b);g()});break;default:g()}else c&&c(null,{})};d.prototype._controlParameters=function(b,a,c,d,f,g){return this._moduleParameters(b)+"<NickName>"+a+"</NickName><Description>"+
c+"</Description><Sensitivity>"+d+"</Sensitivity><OPStatus>"+f+"</OPStatus><Backoff>"+g+"</Backoff>"};d.prototype._setMotionDetectorActive=function(b,a,c){var d=this.node_id+"01",f=this,g=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);b._doAction("SetMotionDetectorSettings",b._requestBody("SetMotionDetectorSettings",this._controlParameters(d,g.nickName,g.description,g.sensitivity,a,g.backoff)),"SetMotionDetectorSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("activate contact failed"));
d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,f.node_id,{opStatus:a+""});c&&c(d)})};d.prototype._setMotionDetectorSensitivity=function(b,a,c){var d=this.node_id+"01",f=this,g=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);b._doAction("SetMotionDetectorSettings",b._requestBody("SetMotionDetectorSettings",this._controlParameters(d,g.nickName,g.description,a,g.opStatus,g.backoff)),"SetMotionDetectorSettingsResult",function(d,e){d||e&&"OK"==e.text()||(d=Error("activate contact failed"));
d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,f.node_id,{sensitivity:a+""});c&&c(d)})};d.prototype._getMotionDetectorSettings=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);if(c&&c.sensitivity&&c.opStatus&&c.nickName&&c.description&&c.backoff)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==c){var d=this;b._doAction("GetMotionDetectorSettings",b._requestBody("GetMotionDetectorSettings",
this._moduleParameters(this.node_id+"01")),"GetMotionDetectorSettingsResponse",function(a,c){var e=d._getSettingsCbs;d._getSettingsCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(c){var f=c.find("GetMotionDetectorSettingsResult");if(f&&f[0]&&"OK"==$(f[0]).text()){var g=null,l=null,n=null,p=null,q=null;c.find("NickName").each(function(){n||(n=$(this).text())});c.find("Description").each(function(){p||(p=$(this).text())});c.find("OPStatus").each(function(){g||(g=$(this).text())});c.find("Sensitivity").each(function(){l||
(l=$(this).text())});c.find("Backoff").each(function(){q||(q=$(this).text())});var r={nickName:n,description:p,opStatus:g,sensitivity:l,backoff:q};xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,r);e.forEach(function(a){a&&a(null,r)})}else a=Error("get contact settings failed"),e.forEach(function(b){b&&b(a)})}else a=Error("get contact settings result format error"),e.forEach(function(b){b&&b(a)})})}};d.prototype._getLastDetectionState=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,
this.node_id);if(c&&c.dectTime)a&&a(null,c.dectTime);else if(c=this._getDetecCbs.length,a&&-1==this._getDetecCbs.indexOf(a)&&this._getDetecCbs.push(a),0==c){var d=this;b._doAction("GetLatestDetection",b._requestBody("GetLatestDetection",this._moduleParameters(this.node_id+"01")),"LatestDetectTime",function(a,c){var e=d._getDetecCbs;d._getDetecCbs=[];a?e.forEach(function(b){b&&b(a)}):c?(xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,{dectTime:c.text()}),e.forEach(function(a){a&&a(null,c.text())})):
(a=Error("get contact open state result format error"),e.forEach(function(b){b&&b(a)}))})}};return d}();
xnm.aio.dlink.ZwaveSiren=function(){var d=function(b){xnm.aio.dlink.ZwaveDevice.call(this,b);this._getSettingsCbs=[];this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveSiren")};d.prototype=new xnm.aio.dlink.ZwaveDevice;d.prototype.constructor=d;d.prototype.TONE="emergency fire ambulance police doorbell acoustic_signal".split(" ");d.prototype.executeCommand=function(b,a,c){if(a&&a.value){var d=this,f;switch(a.value){case "activate":case "deactivate":case "actToggle":case "setTone":case "setDuration":case "setDurationP":case "setVolume":case "volumeUp":case "volumeDown":case "play":this._getSirenAlarmSettings(b,
function(e,h){if(e)c&&c(e);else switch(a.value){case "activate":case "deactivate":d._setSirenActive(b,"activate"==a.value,function(a){c&&c(a)});break;case "actToggle":d._setSirenActive(b,"true"!=h.opStatus,function(a){c&&c(a)});break;case "setVolume":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}f=parseInt(a.ext);0>f&&(f=0);100<f&&(f=100);d._setSirenVolumn(b,f,function(a){c&&c(a)});break;case "volumeUp":case "volumeDown":f=parseInt(h.volume);100<f&&(f=100);f=
"volumeUp"==a.value?f+5:f-5;0>f&&(f=0);100<f&&(f=100);d._setSirenVolumn(b,f,function(a){c&&c(a)});break;case "setDuration":case "setDurationP":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}d._setSirenDuration(b,a.ext,function(a){c&&c(a)});break;case "setTone":if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("command ext invalid"));break}d._setSirenTone(b,a.ext,function(a){c&&c(a)});break;case "play":d._doAlarm(b,function(a){c&&c(a)})}});break;case "stop":this._stopAlarm(b,
function(a){c&&c(a)});break;default:c&&c(Error("unknown command"))}}else c&&c(Error("command invalid"))};d.prototype._controlParameters=function(b,a,c,d,f,g,h){return this._moduleParameters(b)+"<NickName>"+a+"</NickName><Description>"+c+"</Description><DefaultSound>"+d+"</DefaultSound><OPStatus>"+g+"</OPStatus><Volume>"+f+"</Volume><Duration>"+h+"</Duration>"};d.prototype._soundPlayParameters=function(b,a,c,d){return this._moduleParameters(b)+"<SoundType>"+a+"</SoundType><Volume>"+c+"</Volume><Duration>"+
d+"</Duration><Controller>1</Controller>"};d.prototype._dissmissParameters=function(b){return this._moduleParameters(b)+"<Controller>1</Controller>"};d.prototype._doAlarm=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id),d=this;b._doAction("SetSoundPlay",b._requestBody("SetSoundPlay",this._soundPlayParameters(this.node_id+"09",c.defaultSound,c.volume,c.duration)),"SetSoundPlayResult",function(c,e){c||e&&"OK"==e.text()||(c=Error("play siren failed"));c||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,
d.node_id,{alarm:"true"});a&&a(c)})};d.prototype._stopAlarm=function(b,a){var c=this;b._doAction("SetAlarmDismissed",b._requestBody("SetAlarmDismissed",this._dissmissParameters(this.node_id+"09")),"SetAlarmDismissedResult",function(d,f){d||f&&"OK"==f.text()||(d=Error("stop siren failed"));d||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,c.node_id,{alarm:"false"});a&&a(d)})};d.prototype._setSirenActive=function(b,a,c){var d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);d.opStatus=a+
"";this._setSirenAlarmSettings(b,d,c)};d.prototype._setSirenVolumn=function(b,a,c){var d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);d.volume=a+"";this._setSirenAlarmSettings(b,d,c)};d.prototype._setSirenDuration=function(b,a,c){switch(a){case "30s":a=30;break;case "60s":a=60;break;case "90s":a=90;break;case "3min":a=180;break;case "repeat":a=88888;break;default:a=parseInt(a);if(isNaN(a)){c&&c(Error("invalid duration"));return}0>=a&&(a=1);86400<a&&(a=86400)}var d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,
this.node_id);d.duration=a+"";this._setSirenAlarmSettings(b,d,c)};d.prototype._setSirenTone=function(b,a,c){if(a=this.TONE.indexOf(a)+1){var d=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,this.node_id);d.defaultSound=a+"";this._setSirenAlarmSettings(b,d,c)}else c&&c(Error("no such tone"))};d.prototype._setSirenAlarmSettings=function(b,a,c){var d=this;b._doAction("SetSirenAlarmSettings",b._requestBody("SetSirenAlarmSettings",this._controlParameters(this.node_id+"09",a.nickName,a.description,a.defaultSound,
a.volume,a.opStatus,a.duration)),"SetSirenAlarmSettingsResult",function(e,g){e||g&&"OK"==g.text()||(e=Error("set siren settings failed"));e||xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,a);c&&c(e)})};d.prototype._getStates=function(b,a,c){if(a&&0!=a.length)for(var d={},f=0,g=function(){f++;f==a.length&&c&&c(null,d)},h=this,m=!1,k=0;k<a.length;k++)switch(a[k]){case "active":case "tone":case "volume":case "duration":case "durationStr":case "alarm":m?g():(m=!0,this._getSirenAlarmSettings(b,
function(a,b){!a&&b&&(d.active=b.opStatus,d.tone=h.TONE[parseInt(b.defaultSound)-1],d.volume=parseInt(b.volume),999==d.volume&&(d.volume=100),d.alarm=b.alarm,d.duration=parseInt(b.duration),180>d.duration?d.durationStr=d.duration+"s":88888==d.duration||9999==d.duration?d.durationStr="repeat":(a=Math.floor(d.duration/60),b=d.duration-60*a,d.durationStr=(a?a+"m":"")+(b?b+"s":"")));g()}));break;default:g()}else c&&c(null,{})};d.prototype._getSirenAlarmSettings=function(b,a){var c=xnm.aio.dlink._SettingsBuffer.getSettings(b.ip,
this.node_id);if(c&&c.defaultSound&&c.opStatus&&c.nickName&&c.description&&c.volume&&c.duration&&c.alarm)a&&a(null,c);else if(c=this._getSettingsCbs.length,a&&-1==this._getSettingsCbs.indexOf(a)&&this._getSettingsCbs.push(a),0==c){var d=this;b._doAction("GetSirenAlarmSettings",b._requestBody("GetSirenAlarmSettings",this._moduleParameters(this.node_id+"09")),"GetSirenAlarmSettingsResponse",function(a,c){var e=d._getSettingsCbs;d._getSettingsCbs=[];if(a)e.forEach(function(b){b&&b(a)});else if(c){var f=
c.find("GetSirenAlarmSettingsResult");if(f&&f[0]&&"OK"==$(f[0]).text()){var g={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};c.find("NickName").each(function(){g.nickName=$(this).text()});c.find("Description").each(function(){g.description=$(this).text()});c.find("OPStatus").each(function(){g.opStatus=$(this).text()});c.find("Volume").each(function(){g.volume=$(this).text()});c.find("Duration").each(function(){g.duration=$(this).text()});c.find("DefaultSound").each(function(){g.defaultSound=
$(this).text()});c.find("IsSounding").each(function(){g.alarm=$(this).text()});xnm.aio.dlink._SettingsBuffer.setSettings(b.ip,d.node_id,g);e.forEach(function(a){a&&a(null,g)})}else a=Error("get siren settings failed"),e.forEach(function(b){b&&b(a)})}else a=Error("get contact settings result format error"),e.forEach(function(b){b&&b(a)})})}};return d}();
xnm.aio.dlink.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="DlinkDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var b={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"device ready",ref:{value:"ready",options:["true",
"false"]}},{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"float",name:"current consumption",ref:{value:"power"}},{type:"float",name:"total consumption",ref:{value:"totalPower"}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",
ext:"%d",extMeta:"1-100"}},{type:"enum",name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",
ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["3s","10s","30s","1min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",
ext:"%d",extMeta:"1-86400",unit:"s"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]},water:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["water",
"dry"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}}]}},a={contact:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},
{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",ext:"%d",extMeta:"1-100"}},{type:"enum",
name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}},{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",
ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["30s","60s","90s","3min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",extMeta:"1-86400",unit:"s"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:"emergency fire ambulance police doorbell acoustic_signal".split(" ")}},
{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]}};return{SYS:"dlink",getIPDeviceType:function(){return[{sys:this.SYS,name:"mydlink Connected Home",port:80}]},getGatewayType:function(){return{sys:this.SYS,name:"mydlink Connected Home Hub",port:80}},getGatewayDeviceType:function(a){return[{sys:this.SYS,data:"contact",name:"Home Door/Window Sensor"},{sys:this.SYS,data:"motion",name:"Battery Motion Sensor"},{sys:this.SYS,data:"siren",
name:"Siren"}]},createGateway:function(a,b,f){b=d.ERROR_CODE;a?a.ip?a.password?f(null,a):f(new d(b.INVALID,"password is invalid")):f(new d(b.INVALID,"ip is invalid")):f(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,b,f,g){a=d.ERROR_CODE;b?b.ip?b.password?g(null,b):g(new d(a.INVALID,"password is invalid")):g(new d(a.INVALID,"ip is invalid")):g(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,d){d()},createDevice:function(a,b,f){var c=d.ERROR_CODE;if(a)if(a.type)if(a.data){if("wifi"==
a.type){if(!a.ip){f(new d(c.INVALID,"ip is invalid"));return}if(!a.password){f(new d(c.INVALID,"password is invalid"));return}}else if("zwave"==a.type){if(!a.gateway){f(new d(c.INVALID,"gateway is invalid"));return}if(!a.node_id){f(new d(c.INVALID,"node_id is invalid"));return}if(!b.data||!b.data.gateways||0===b.data.gateways.length){f(new d(c.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));return}b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var m=b[e];break}if(!m){f(new d(c.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"));return}}f(null,a)}else f(new d(c.INVALID,"data is invalid"));else f(new d(c.INVALID,"type is invalid"));else f(new d(c.INVALID,"info is invalid"))},updateDevice:function(a,b,f){var c=d.ERROR_CODE;if(a)if(a.type)if(a.data){if("wifi"==a.type){if(!a.ip){f(new d(c.INVALID,"ip is invalid"));return}if(!a.password){f(new d(c.INVALID,"password is invalid"));return}}else if("zwave"==a.type){if(!a.gateway){f(new d(c.INVALID,"gateway is invalid"));return}if(!a.node_id){f(new d(c.INVALID,
"node_id is invalid"));return}if(!b.data||!b.data.gateways||0===b.data.gateways.length){f(new d(c.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));return}b=b.data.gateways;var e;for(e=0;e<b.length;e++)if(b[e].index===a.gateway){var m=b[e];break}if(!m){f(new d(c.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));return}}f(null,a)}else f(new d(c.INVALID,"data is invalid"));else f(new d(c.INVALID,"type is invalid"));else f(new d(c.INVALID,"info is invalid"))},deleteDevice:function(a,
b,d){d()},applyUIFilter:function(a,b,d){var c=this,e=function(a,b,c){var d=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=e(a.children,b,c);f&&0<f.length&&(a.children=f,d.push(a))}else{f=c.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),d.push(a))}});return d},f=function(a,b){var f=[],g=c.getCommandStatusMap(a,d);if(g){var h=[];switch(b.catagory){case "command":g.command&&(h=e(g.command,
a,b));break;case "status":g.status&&(h=e(g.status,a,b))}f=f.concat(h)}return f};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),l=null;switch(b.catagory){case "command":l=f(a,b);k.command=l;break;case "status":l=f(a,b);k.status=l;break;default:return null}return l&&0!=l.length?k:null},getCommandStatusMap:function(c){return c&&c.type&&c.data?"wifi"==c.type?b[c.data]:"zwave"==c.type?a[c.data]:null:null}}}();
xnm.aio.dlink.Handler=function(){var d=function(){};d.prototype.WifiPlug=xnm.aio.dlink.WifiPlug;d.prototype.WifiMotion=xnm.aio.dlink.WifiMotion;d.prototype.WifiSiren=xnm.aio.dlink.WifiSiren;d.prototype.WifiWater=xnm.aio.dlink.WifiWater;d.prototype.WifiHub=xnm.aio.dlink.WifiHub;d.prototype.devicemanager=xnm.aio.dlink.DM;d.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"dlink")};d.prototype.resolveGateway=function(b){return b?"wifi"==b.type&&"hub"==b.data?xnm.aio.dlink.WifiDevice.parseJSON(b):
null:null};d.prototype.resolveDevice=function(b){if(!b)return null;switch(b.type){case "wifi":return xnm.aio.dlink.WifiDevice.parseJSON(b);default:return null}};d.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};d.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};d.prototype.doCommand=function(b,a,c,d){(b=b?this.resolveGateway(b):
this.resolveDevice(a))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway/device json format invalid"))};d.prototype.doStatus=function(b,a,c,d,f){(a=a?this.resolveGateway(a):this.resolveDevice(c))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("device json format invalid"))};d.prototype.discoverWifiDevice=function(b,a){var c=require("x.mdns.js");c.clearRecordBuffer();c.discoverServiceWithTimeout("_dhnap._tcp.local",b,function(b,
c){if(b)a&&a(b);else{for(var d=[],e=0;e<c.length;e++){var f=c[e],k=null;if(f.info&&f.ip&&0<f.ip.length){var l={ip:f.ip[0],mac:f.info.mac,model:f.info.model_number};switch(f.info.model_number){case "DSP-W215":k=new xnm.aio.dlink.WifiPlug(l);break;case "DCH-G020":k=new xnm.aio.dlink.WifiHub(l);break;case "DCH-S150":k=new xnm.aio.dlink.WifiMotion(l);break;case "DCH-S220":k=new xnm.aio.dlink.WifiSiren(l);break;case "DCH-S160":k=new xnm.aio.dlink.WifiWater(l)}k&&d.push(k)}}a&&a(b,d)}})};d.prototype.listZwaveDevice=
function(b,a){(b=this.resolveGateway(b))?b.listZwaveDevice(a):a&&a(Error("gateway json format invalid"))};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.dlink.Handler);
