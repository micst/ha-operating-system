var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,c,a){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var g=b[e];if(c.call(a,g,e,b))return{i:e,v:g}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,a){b!=Array.prototype&&b!=Object.prototype&&(b[c]=a.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var c=0;c<b.length;++c){var a=b[c];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,c,a,d){if(c){a=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in a||(a[e]={});a=a[e]}b=b[b.length-1];d=a[b];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(c,a){return $jscomp.findInternal(this,c,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rwe=xnm.aio.rwe||{};
xnm.aio.rwe.Cache={STATUS_EXPIRE_TO:3E5,_cache:{},_statusBuffer:{},_stateMachine:{},_centralBuffer:{},_getCache:function(b){return b?this._cache[b]:null},_ensureCache:function(b){if(!b)return null;this._cache[b]||(this._cache[b]={});return this._cache[b]},_getStateMachine:function(b){return b?this._stateMachine[b]:null},_ensureStateMachine:function(b){if(!b)return null;this._stateMachine[b]||(this._stateMachine[b]={state:0,loginCallbacks:[]});return this._stateMachine[b]},_getStateBuffer:function(b){return b?
this._statusBuffer[b]:null},_ensureStateBuffer:function(b){if(!b)return null;this._statusBuffer[b]||(this._statusBuffer[b]={});return this._statusBuffer[b]},setSessionID:function(b,c){if(!b)return null;b=this._ensureCache(b);if(!b)return null;b.sessionID=c},getSessionID:function(b){return b?(b=this._getCache(b))?b.sessionID:null:null},setCurrentConfig:function(b,c){if(!b)return null;b=this._ensureCache(b);if(!b)return null;b.currentConfig=c},getCurrentConfig:function(b){return b?(b=this._getCache(b))?
b.currentConfig:null:null},setVersion:function(b,c){if(!b)return null;b=this._ensureCache(b);if(!b)return null;b.version=c},getVersion:function(b){return b?(b=this._getCache(b))&&b.version?b.version:"1.70":null},setStateMachineState:function(b,c){b&&(b=this._ensureStateMachine(b))&&(b.state=c?c:0)},getStateMachineState:function(b){return b?(b=this._getStateMachine(b))&&b.state?b.state:0:null},addLoginCallback:function(b,c){if(!b||!c)return null;if(b=this._ensureStateMachine(b))b.loginCallbacks||(b.loginCallbacks=
[]),b.loginCallbacks.push(c)},getLoginCallbacks:function(b){return b?(b=this._getStateMachine(b))?b.loginCallbacks:null:null},clearLoginCallbacks:function(b){if(!b)return null;if(b=this._getStateMachine(b))b.loginCallbacks=[]},setCentral:function(b,c){if(!b)return null;this._centralBuffer[b]=c},getCentral:function(b){return this._centralBuffer[b]},setStatusBuffer:function(b,c){if(!b)return null;var a=this._ensureStateBuffer(b);if(a){var d=this;null==a.timer&&(a.timer=setInterval(function(){var a=
d.getCentral(b);a&&a.refreshStates()},2E3));a.status=c;a.timestamp=(new Date).getTime()}},getStatusBuffer:function(b){if(!b)return null;var c=(new Date).getTime(),a=this._ensureStateBuffer(b);if(!a.status)return a.status={},a.timestamp=c,null;if(a.timestamp&&-a.timestamp>this.STATUS_EXPIRE_TO)return a.timestamp=c,null;var d=this;null==a.timer&&(a.timer=setInterval(function(){var a=d.getCentral(b);a&&a.refreshStates()},2E3));return a.status},updateStatusBuffer:function(b,c){if(!b||!c)return null;b=
this._ensureStateBuffer(b);b.status||(b.status={});var a=!1,d;for(d in c)c.hasOwnProperty(d)&&c[d]&&(a=!0,b.status[d]=c[d]);a&&(b.timestamp=(new Date).getTime())},getSingleBufferedStatus:function(b,c){if(!b||!c)return null;b=this._ensureStateBuffer(b);return b.status?b.status[c]:null},finalize:function(b){var c=(new Date).getTime()-24E4,a;for(a in this._statusBuffer)if(this._statusBuffer.hasOwnProperty(a)){var d=this._statusBuffer[a];d&&(d.timer&&(clearInterval(d.timer),d.timer=null),d.timestamp=
c)}b&&b()}};
xnm.aio.rwe.Central=function(){var b=function(c,a,d,b){this._logger=require("x.logger.js").getLogger("xnm.aio.rwe.Central");this.ip=c;this.port=a;a||(this.port=443);this.user=d;this.password=b;this._clientID=this._generateGUID();this.CommandHandler=null};b.DEVICE_TYPE_LIST="SwitchActuator DimmerActuator RollerShutterActuator RoomHumiditySensor RoomTemperatureSensor RoomTemperatureActuator AlarmActuator WindowDoorSensor SmokeDetectionSensor GenericActuator".split(" ");b.prototype._getSessionID=function(){return xnm.aio.rwe.Cache.getSessionID(this.ip)};
b.prototype._setSessionID=function(c){return xnm.aio.rwe.Cache.setSessionID(this.ip,c)};b.prototype._getCurrentConfig=function(){return xnm.aio.rwe.Cache.getCurrentConfig(this.ip)};b.prototype._setCurrentConfig=function(c){return xnm.aio.rwe.Cache.setCurrentConfig(this.ip,c)};b.prototype._getVersion=function(){return xnm.aio.rwe.Cache.getVersion(this.ip)};b.prototype._setVersion=function(c){return xnm.aio.rwe.Cache.setVersion(this.ip,c)};b.prototype._getStateMachineState=function(){return xnm.aio.rwe.Cache.getStateMachineState(this.ip)};
b.prototype._setStateMachineState=function(c){xnm.aio.rwe.Cache.setStateMachineState(this.ip,c)};b.prototype._addLoginCallback=function(c){xnm.aio.rwe.Cache.addLoginCallback(this.ip,c)};b.prototype._getLoginCallbacks=function(){return xnm.aio.rwe.Cache.getLoginCallbacks(this.ip)};b.prototype._clearLoginCallbacks=function(){xnm.aio.rwe.Cache.clearLoginCallbacks(this.ip)};b.prototype._setBufferedCentral=function(){xnm.aio.rwe.Cache.setCentral(this.ip,this)};b.prototype._getStatusBuffer=function(){return xnm.aio.rwe.Cache.getStatusBuffer(this.ip)};
b.prototype._setStatusBuffer=function(c){xnm.aio.rwe.Cache.setStatusBuffer(this.ip,c)};b.prototype._updateStatusBuffer=function(c){xnm.aio.rwe.Cache.updateStatusBuffer(this.ip,c)};b.prototype._getSingleBufferedStatus=function(c){return xnm.aio.rwe.Cache.getSingleBufferedStatus(this.ip,c)};b.prototype._generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var a=16*Math.random()|0;return("x"==c?a:a&3|8).toString(16)})};b.prototype._parseDeviceData=function(c){var a=
{},d={},e={},g={};c.find("LC").each(function(){var a=$(this),c=a.find("Name");a=a.find("Id");c&&a&&(d[$(a[0]).text()]={name:$(c[0]).text(),devices:{}})});c.find("BD").each(function(){var a=$(this).find("Id");a&&(e[$(a[0]).text()]={address:$(a[0]).text(),channels:{}})});c.find("LD").each(function(){var a=$(this),c=a.attr("xsi:type");if(c){var d=a.attr("Name"),b=a.attr("LCID"),e=a.find("BDId");e=e&&0<e.length?$(e[0]).text():null;var f=a.find("UDvIds");f=f&&0<f.length?(f=$(f[0]).find("guid"))&&0<f.length?
$(f[0]).text():null:null;var h=a.find("Id");h=h&&0<h.length?$(h[0]).text():null;c={name:d,type:c,address:h,bid:e,udvid:f,lid:b};(a=a.find("ActCls"))&&0<a.length&&(c.data=$(a[0]).text());g[h]=c}});for(var h in g)if(g.hasOwnProperty(h)){var f=g[h];if(f.type&&-1!=b.DEVICE_TYPE_LIST.indexOf(f.type)&&f.lid&&d[f.lid])if("GenericActuator"==f.type&&f.address)d[f.lid].devices[f.address]={address:f.address,channels:{}},c=d[f.lid].devices[f.address],delete f.bid,delete f.udvid,delete f.lid,c.channels[f.address]=
f;else{var k=f.bid;!k&&f.udvid&&g[f.udvid]&&g[f.udvid].bid&&(k=g[f.udvid].bid);k&&e[k]&&f.address&&(c=d[f.lid].devices[k],c||(d[f.lid].devices[k]=e[k],c=d[f.lid].devices[k]),delete f.bid,delete f.udvid,delete f.lid,c.channels[f.address]=f)}}a.data=d;return a};b.prototype._parseMessageData=function(c){var a={},d={};c.find("MessageContainer").each(function(){var a=$(this),c=a.attr("State");if(a=a.find("Message")){a=$(a[0]);var b=a.attr("Id"),f=a.attr("Type"),k=a.attr("TimeStamp");if(b&&f&&k){d[b]={type:f,
time:k,read:"Read"==c};var l={};a.find("MessageParameter").each(function(){var a=$(this),c=a.attr("Key");a=a.attr("Value");c&&a&&(l[c]=a)});d[b].params=l}}});a.data=d;return a};b.prototype._parseDeviceStateData=function(c){var a={},d={};c.find("LogicalDeviceState").each(function(){var a=$(this),c=a.attr("LID"),b=a.attr("xsi:type");if(c&&b){var f=null;if("SwitchActuatorState"==b){f={state:"?"};var k=a.attr("IsOn");"True"==k?f.state="on":"False"==k&&(f.state="off")}else if("DimmerActuatorState"==b)f=
{state:"?"},k=a.attr("DmLvl")||"0","string"==typeof k&&0<k.length&&(f.state=parseInt(k));else if("RollerShutterActuatorState"==b)f={state:"?"},(a=a.find("ShutterLevel"))&&0<a.length&&(f.state=parseInt($(a[0]).text())||0);else if("RoomHumiditySensorState"==b)f={state:"?"},k=a.attr("Humidity"),"string"==typeof k&&0<k.length&&(f.state=k);else if("RoomTemperatureSensorState"==b)f={state:"?"},k=a.attr("Temperature"),"string"==typeof k&&0<k.length&&(f.state=parseFloat(k).toFixed(1));else if("RoomTemperatureActuatorState"==
b)f={state:"?"},k=a.attr("PtTmp"),"string"==typeof k&&0<k.length&&(f.state=parseFloat(k).toFixed(1)),k=a.attr("OpnMd"),"string"==typeof k&&0<k.length&&(f.mode=k.toLowerCase());else if("AlarmActuatorState"==b)f={state:"?"},(k=a.attr("IsOn"))&&(k=k.toLowerCase()),"true"==k?f.state="on":"false"==k&&(f.state="off");else if("WindowDoorSensorState"==b)f={state:"?"},(a=a.find("IsOpen"))&&0<a.length&&((k=$(a[0]).text())&&(k=k.toLowerCase()),"true"==k?f.state="open":"false"==k&&(f.state="closed"));else if("SmokeDetectionSensorState"==
b)f={state:"?"},(a=a.find("IsSmokeAlarm"))&&0<a.length&&((k=$(a[0]).text())&&(k=k.toLowerCase()),"true"==k?f.state="on":"false"==k&&(f.state="off"));else if("GenericDeviceState"==b){f={state:"?"};var l=a.find("Ppt");if(l&&0<l.length){l=$(l[0]);a=l.attr("xsi:type");k=l.attr("Name");l=l.attr("Value");if("undefined"==typeof l||null==l)l="?";"string"==typeof a&&0<a.length&&"string"==typeof k&&0<k.length&&"string"==typeof l&&("BooleanProperty"==a?(f.state=l.toLowerCase(),b="BooleanProperty:Value"):(f.state=
l,b=a+":"+k))}}f&&(d[c]={state:f,type:b})}});a.data=d;return a};b.prototype._parseResult=function(c){var a={};c=$($($.parseXML(c)).children()[0]);if(!c)return a.error="invalid reponse",a;if("NotificationList"==c.prop("tagName"))a=this._parseDeviceStateData(c);else switch(c.attr("xsi:type")){case "AuthenticationErrorResponse":a.error=c.attr("Error");break;case "VersionMismatchErrorResponse":var b=c.attr("Version");this._setVersion(b);a.error="VersionMismatch";break;case "AcknowledgeResponse":a.data=
{result:"ok"};break;case "ControlResultResponse":"Ok"==c.attr("Result")?a.data={result:"ok"}:a.error=c.attr("Result");break;case "LoginResponse":(b=c.attr("SessionId"))&&this._setSessionID(b);(c=c.attr("CurrentConfigurationVersion"))&&this._setCurrentConfig(c);a.data={sessionID:b,currentConfig:c};break;case "GetEntitiesResponse":a=this._parseDeviceData(c);break;case "GetAllLogicalDeviceStatesResponse":"Ok"==c.attr("Result")?a=this._parseDeviceStateData(c):a.error=c.attr("Result");break;case "MessageListResponse":a=
this._parseMessageData(c);break;default:c.attr("Error")?a.error=c.attr("Error"):a.error="unknown response type:"+c.attr("xsi:type")}return a};b.prototype._doRequest=function(c,a,b,e){c||(c="/cmd");if("object"==typeof b&&b&&b.body)var d=b.body;else{d='<BaseRequest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="'+this._getVersion()+'" RequestId="'+this._generateGUID()+'" ';var h=this._getSessionID();h&&(d+='SessionId="'+h+'" ');d=(h=this._getCurrentConfig())?d+('BasedOnConfigVersion="'+
h+'" '):d+'BasedOnConfigVersion="0" ';for(var f in a)d+=f+'="'+a[f]+'" ';d=b&&0<b.length?d+(">"+b+"</BaseRequest>"):d+"/>"}f={};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",f=require("constants"));f={host:this.ip,port:this.port,path:c,method:"POST",headers:{Referer:"https://smarthome.blob.core.windows.net/silverlight/latest/application/RWE.SmartHome.UI.Shell.xap",ClientId:this._clientID,"Content-Type":"text/xml; charset=UTF-8","cache-control":"no-cache",
pragma:"no-cache","User-Agent":"Java/1.7.0_07",Accept:"text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",Connection:"close","Content-Length":d.length},rejectUnauthorized:!1,secureOptions:f.SSL_OP_NO_TLSv1,strictSSL:!1,secureProtocol:"TLSv1_client_method"};this._logger.log("trace","do request:"+JSON.stringify(f));var k=this,l=e,m=require("https").request(f,function(d){d.setEncoding("utf-8");var f="";d.on("data",function(a){f+=a});d.on("end",function(){k._logger.log("trace","receive code:"+d.statusCode+
" headers:"+JSON.stringify(d.headers)+" response:"+f);var g;if(200==d.statusCode)try{if((g=k._parseResult(f))&&"VersionMismatch"==g.error){k._doRequest(c,a,b,e);return}}catch(p){console.error(p);var h=p}l&&(l(h,g,d),l=null)})});if(m.on)m.on("error",function(a){k._logger.log("trace","do request error:"+a.message);l&&(l(a),l=null)});m.setTimeout&&m.setTimeout(6E4,function(){k._logger.log("trace","do request timeout");m.abort();l&&(l(Error("timeout")),l=null)});this._logger.log("trace","do request send body:"+
d);m.write(d);m.end()};b.prototype._sendRequest=function(c,a,b,e){var d=this,h=this._getSessionID(),f=this._getCurrentConfig();h&&f?this._doRequest(c,a,b,function(f,g,h){f?e&&e(f):h&&401==h.statusCode?(d._logger.log("debug","http request error with code:"+h.statusCode),d._setSessionID(null),d._setCurrentConfig(null),d._sendRequest(c,a,b,e)):h&&200!=h.statusCode?(f=Error("http request error with code:"+h.statusCode),e&&e(f)):!g||"IllegalSessionId"!=g.error&&"ConfigurationOutOfDate"!=g.error?(g&&g.error&&
(d._logger.log("debug","send request response error:"+g.error),f||(f=Error(g.error))),e&&e(f,g?g.data:g)):(d._logger.log("debug","send request response error:"+g.error),d._setSessionID(null),d._setCurrentConfig(null),d._sendRequest(c,a,b,e))}):this._login(function(f){f?e&&e(f):d._sendRequest(c,a,b,e)})};b.prototype._login=function(c){this._logger.log("debug","LoginRequest");if(this.user&&this.password){if(this._addLoginCallback(c),1!=this._getStateMachineState()){this._setStateMachineState(1);c=require("x.crypt.js");
c=(new Buffer(c.SHA256(this.password),"hex")).toString("base64");var a=this;this._doRequest(null,{"xsi:type":"LoginRequest",UserName:this.user,Password:c},null,function(c,b,g){var d=a._getLoginCallbacks();a._clearLoginCallbacks();c?a._logger.log("debug","login error:"+c.message):g&&200!=g.statusCode?(a._logger.log("debug","login http error:"+g.statusCode),c=Error("login http request error with code:"+g.statusCode)):b&&b.error&&(a._logger.log("debug","login response error:"+b.error),c=Error(b.error));
c?(a._setStateMachineState(0),d&&d.forEach(function(a){a&&a(c)})):a._subscribeNotification(function(c){c?(a._setStateMachineState(0),d&&d.forEach(function(a){a&&a(c)})):(a._logger.log("debug","login success:"+JSON.stringify(b)),a._setStateMachineState(2),a._setBufferedCentral(),d&&d.forEach(function(a){a&&a(null,b?b.data:b)}))})})}}else c&&c(Error("username or password in null"))};b.prototype._subscribeNotification=function(c){this._logger.log("debug","NotificationRequest");var a=this;this._sendRequest(null,
{"xsi:type":"NotificationRequest"},"<Action>Subscribe</Action><NotificationType>DeviceStateChanges</NotificationType>",function(b,e){b&&a._logger.log("debug","NotificationRequest error:"+b.message);e&&a._logger.log("debug","NotificationRequest response:"+JSON.stringify(e));c&&c(b,e)})};b.prototype._getUpd=function(c){this._logger.log("debug","Get Update Notification");var a=this;this._sendRequest("/upd",null,{body:"upd"},function(b,e){b&&a._logger.log("debug","Update Notification error:"+b.message);
e&&a._logger.log("debug","Update Notification response:"+JSON.stringify(e));c&&c(b,e)})};b.prototype._getEntities=function(c){this._logger.log("debug","GetEntitiesRequest");var a=this;this._sendRequest(null,{"xsi:type":"GetEntitiesRequest"},"<EntityType>Configuration</EntityType>",function(b,e){b&&a._logger.log("debug","GetEntitiesRequest error:"+b.message);e&&a._logger.log("debug","GetEntitiesRequest response:"+JSON.stringify(e));c&&c(b,e)})};b.prototype._getDeviceStates=function(c){this._logger.log("debug",
"_getDeviceStates");var a=this._getStatusBuffer();if(a)console.log("status buffer",a),c&&c(null,a);else{this._logger.log("debug","GetAllLogicalDeviceStatesRequest");var b=this;this._sendRequest(null,{"xsi:type":"GetAllLogicalDeviceStatesRequest"},null,function(a,d){a?(b._logger.log("debug","GetAllLogicalDeviceStatesRequest error:"+a.message),b._setStatusBuffer(null),c&&c(a)):(d&&(b._logger.log("debug","GetAllLogicalDeviceStatesRequest response:"+JSON.stringify(d)),b._setStatusBuffer(d)),c&&c(null,
d))})}};b.prototype._getDeviceState=function(c,a){this._getDeviceStates(function(b,e){b?a&&a(b):(b=null,e&&e[c]&&(b=e[c].state),a&&a(null,b))})};b.prototype._addSpecialTypesFromStates=function(c,a){for(var b in c){var e=[],g=c[b],h;for(h in g.devices){var f=g.devices[h],k;for(k in f.channels){var l=f.channels[k];l.data&&"Generic"!=l.data||!a[k]||(a[k].type&&-1==a[k].type.indexOf(":")&&"Generic"==l.data?e.push(h):l.data=a[k].type)}}for(f=0;f<e.length;f++)e[f]&&delete g.devices[e[f]]}return c};b.prototype.getDevices=
function(c){var a=this;this._getEntities(function(b,e){b?c&&c(b):a._getDeviceStates(function(b,d){b?c&&c(b):(b=a._addSpecialTypesFromStates(e,d),c&&c(null,b))})})};b.prototype.getMessages=function(c){this._doRequest(null,{"xsi:type":"GetMessageListRequest"},null,function(a){c&&(a&&a.data?c&&c(a.data):c&&c(null))})};b.prototype.executeCommand=function(c,a,b){if(c&&c.channels){var d=null,g=null;if("on"==a||"off"==a||"toggle"==a)g="SwitchActuator";else if("auto"==a||"manu"==a||"tempOff"==a||0==a.indexOf("tempTo"))g=
"RoomTemperatureActuator";else if("dimUp"==a||"dimDown"==a||0==a.indexOf("dimTo"))g="DimmerActuator";else if("moveUp"==a||"moveDown"==a||0==a.indexOf("moveTo"))g="RollerShutterActuator";else if("alarmOn"==a||"alarmOff"==a||"alarmToggle"==a)g="AlarmActuator";else if("boolTrue"==a||"boolFalse"==a||"boolToggle"==a||0==a.indexOf("numTo"))g="GenericActuator";if(g){for(var h in c.channels)if(c.channels.hasOwnProperty(h)&&c.channels[h]&&c.channels[h].type==g){d=c.channels[h];break}d?this._executeCommand(d,
a,b):b&&b(Error("device has no channel:"+g))}else b&&b(Error("unknown command"))}else b&&b(Error("device format invalid"))};b.prototype._executeCommand=function(c,a,b){if(c&&c.type&&c.address)if("undefined"==typeof a||null==a)b&&b(Error("command invalid"));else{var d=this,g=null,h=null,f=!0;switch(c.type){case "SwitchActuator":switch(a){case "on":h="True";break;case "off":h="False";break;case "toggle":f=!1,this._getDeviceState(c.address,function(a,e){a||!e?(a||(a=Error("current state rsp of switch is invalid")),
b&&b(a)):"off"==e.state?d._executeCommand(c,"on",b):d._executeCommand(c,"off",b)})}h&&(g='<ActuatorStates><LogicalDeviceState xsi:type="SwitchActuatorState" LID="'+c.address+'" IsOn="'+h+'" /></ActuatorStates>');break;case "DimmerActuator":switch(a){case "dimUp":case "dimDown":f=!1;this._getDeviceState(c.address,function(e,f){e||!f?(e||(e=Error("current state rsp of dimmer is invalid")),b&&b(e)):(e=parseInt(f.state),isNaN(e)?b&&b(Error("current dimmer state invalid")):(e="dimUp"==a?e+5:e-5,d._executeCommand(c,
"dimTo"+e,b)))});break;default:0==a.indexOf("dimTo")&&(h=parseInt(a.replace(/dimTo/g,"")),0>h&&(h=0),100<h&&(h=100))}"undefined"!=typeof h&&null!=h&&(g='<ActuatorStates><LogicalDeviceState xsi:type="DimmerActuatorState" LID="'+c.address+'" DmLvl="'+h+'" /></ActuatorStates>');break;case "RollerShutterActuator":switch(a){case "moveUp":case "moveDown":f=!1;this._getDeviceState(c.address,function(e,f){e||!f?(e||(e=Error("current state rsp of blind is invalid")),b&&b(e)):(e=parseInt(f.state),isNaN(e)?
b&&b(Error("current blind state invalid")):(e="moveUp"==a?e+5:e-5,d._executeCommand(c,"moveTo"+e,b)))});break;default:0==a.indexOf("moveTo")&&(h=parseInt(a.replace(/moveTo/g,"")),0>h&&(h=0),100<h&&(h=100))}"undefined"!=typeof h&&null!=h&&(g='<ActuatorStates><LogicalDeviceState xsi:type="RollerShutterActuatorState" LID="'+c.address+'" ><ShutterLevel>'+h+"</ShutterLevel></LogicalDeviceState></ActuatorStates>");break;case "RoomTemperatureActuator":switch(a){case "manu":g='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
c.address+'" OpnMd="Manu" /></ActuatorStates>';break;case "auto":g='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+c.address+'" OpnMd="Auto" /></ActuatorStates>';break;case "tempOff":g='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+c.address+'" PtTmp="6.0" /></ActuatorStates>';break;default:0==a.indexOf("tempTo")&&(h=a.replace(/tempTo/g,""),h=(parseFloat(h)/2).toFixed(1),g='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+
c.address+'" PtTmp="'+h+'" /></ActuatorStates>')}break;case "AlarmActuator":switch(a){case "alarmOn":h="True";break;case "alarmOff":h="False";break;case "alarmToggle":f=!1,this._getDeviceState(c.address,function(a,e){a?b&&b(a):e&&"off"==e.state?d._executeCommand(c,"alarmOn",b):d._executeCommand(c,"alarmOff",b)})}h&&(g='<ActuatorStates><LogicalDeviceState xsi:type="AlarmActuatorState" LID="'+c.address+'" IsOn="'+h+'" /></ActuatorStates>');break;case "GenericActuator":var k=null,l=null;h=null;if(c.data){var m=
c.data.split(":");if(2==m.length)if(k=m[0],l=m[1],"on"==a||"true"==a||"boolTrue"==a)h="True";else if("off"==a||"false"==a||"boolFalse"==a)h="False";else if(0==a.indexOf("numTo"))h=a.replace(/numTo/g,""),h=parseFloat(h),(m=this._buildCMDStatus(c,a))&&this._updateStatusBuffer(m);else if("boolToggle"==a){f=!1;this._getDeviceState(c.address,function(a,e){a||!e?(a||(a=Error("current state rsp of switch is invalid")),b&&b(a)):"false"==e.state?d._executeCommand(c,"true",b):d._executeCommand(c,"false",b)});
break}}k&&l&&null!=h&&(g='<ActuatorStates><LogicalDeviceState xsi:type="GenericDeviceState" LID="'+c.address+'"><Ppts><Ppt xsi:type="'+k+'" Name="'+l+'" Value="'+h+'" /></Ppts></LogicalDeviceState></ActuatorStates>')}f&&(g?this._sendRequest(null,{"xsi:type":"SetActuatorStatesRequest"},g,function(e){if(!e){var f=d._buildCMDStatus(c,a);f&&d._updateStatusBuffer(f)}b&&b(e)}):b&&b(Error("unknow command")))}else b&&b(Error("channel format invalid"))};b.prototype._buildCMDStatus=function(c,a){if(!(c&&c.address&&
c.type&&a))return null;var b=null;switch(c.type){case "SwitchActuator":if("on"==a||"off"==a)b={},b[c.address]={state:{state:a},type:"SwitchActuatorState"};break;case "DimmerActuator":0==a.indexOf("dimTo")&&(b={},a=parseInt(a.replace(/dimTo/g,"")),0>a&&(a=0),100<a&&(a=100),b[c.address]={state:{state:""+a},type:"DimmerActuatorState"});break;case "RollerShutterActuator":0==a.indexOf("moveTo")&&(b={},a=parseInt(a.replace(/moveTo/g,"")),0>a&&(a=0),100<a&&(a=100),b[c.address]={state:{state:""+a},type:"RollerShutterActuatorState"});
break;case "RoomTemperatureActuator":if("auto"==a||"manu"==a)b={},b[c.address]={state:{mode:a},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(c.address))&&a.state&&(b[c.address].state.state=a.state.state);else if("tempOff"==a||0==a.indexOf("tempTo"))b={},"tempOff"==a?a="6.0":(a=a.replace(/tempTo/g,""),a=(parseFloat(a)/2).toFixed(1)),b[c.address]={state:{state:a},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(c.address))&&a.state&&(b[c.address].state.mode=
a.state.mode);break;case "AlarmActuator":if("alarmOn"==a||"alarmOff"==a)b={},b[c.address]={state:{state:"alarmOn"==a?"on":"off"},type:"AlarmActuatorState"};break;case "GenericActuator":"boolTrue"==a||"boolFalse"==a?(b={},b[c.address]={state:{state:"boolTrue"==a?"true":"false"},type:c.data}):0==a.indexOf("numTo")&&(b={},a=parseFloat(a.replace(/numTo/g,"")),b[c.address]={state:{state:""+a},type:c.data});break;default:return null}return b};b.prototype.getStates=function(b,a,d){var c=this;this.CommandHandler=
b;this._getDeviceStates(function(b,e){for(var f=0;f<a.length;f++)if(e&&e[a[f].address]){var g=a[f],h=e[a[f].address].state,m=c.getStateValues(g.subtype,h);if(c.CommandHandler&&c.CommandHandler.setState)for(var n in m)"state"==n?c.CommandHandler.setState(g.id,m[n]):c.CommandHandler.setState(g.id+":"+n,m[n]);else c.CommandHandler&&c.CommandHandler.receivedState&&c.CommandHandler.receivedState("rwe",g.address,h);if(d)for(n in m);}d&&d(b,e)})};b.prototype.getStateValues=function(b,a){return a};b.prototype.executeCommandCreator=
function(b,a,d){if(b)if(a&&a.value){var c=a.value;if("tempAuto"==a.value)c="auto";else if("tempManu"==a.value)c="manu";else if("tempTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command setTo ext format invalid"));return}c=parseFloat(a.ext);c=a.value+2*c}else if("dimTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command dimTo ext format invalid"));return}c=a.value+a.ext}else if("moveTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command dimTo ext format invalid"));
return}c=a.value+a.ext}else if("numTo"==a.value){if("undefined"==typeof a.ext||null==a.ext){d&&d(Error("command numTo ext format invalid"));return}c=a.value+a.ext}this.executeCommand(b,c,function(a){d&&d(a)})}else d&&d(Error("command json format invalid"));else d&&d(Error("device json format invalid"))};b.prototype.getStatesCreator=function(b,a,d){if(a)if(0==a.length)d&&d(null,[]);else{var c=this;this.getStates(b,[],function(b,e){b=[];if(e)for(var f=0;f<a.length;f++)if(a[f]&&a[f].id){var g="?",h=
c._findStatusChannel(a[f].device,a[f].status);h&&h.address&&a[f].status&&a[f].status.value&&e[h.address]&&(g=c._resolveState(h,a[f].status,e[h.address]));if("undefined"==typeof g||null==g)g="?";b.push({id:a[f].id,status:g})}d&&d(null,b)})}else d&&d(Error("deviceList is null"))};b.prototype.refreshStates=function(){var b=this;this._getUpd(function(a,c){!a&&c&&b._updateStatusBuffer(c)})};b.prototype._findStatusChannel=function(b,a){if(!(b&&b.channels&&a&&a.value))return null;var c=null;switch(a.value){case "switchState":a=
"SwitchActuator";break;case "dimLevel":a="DimmerActuator";break;case "blindPos":a="RollerShutterActuator";break;case "humState":a="RoomHumiditySensor";break;case "tempState":a="RoomTemperatureSensor";break;case "tempMode":case "setTempState":a="RoomTemperatureActuator";break;case "alarmState":a="AlarmActuator";break;case "contactState":a="WindowDoorSensor";break;case "smokeState":a="SmokeDetectionSensor";break;case "boolState":case "numState":case "stringState":a="GenericActuator";break;default:return null}if(!a)return null;
for(var e in b.channels)if(b.channels.hasOwnProperty(e)&&b.channels[e]&&b.channels[e].type==a){c=b.channels[e];break}return c};b.prototype._resolveState=function(b,a,d){if(!(b&&b.type&&a&&a.value&&d&&d.type&&d.state))return null;var c=null;switch(b.type){case "SwitchActuator":"SwitchActuatorState"==d.type&&(c=d.state.state);break;case "DimmerActuator":"DimmerActuatorState"==d.type&&(c=parseInt(d.state.state));break;case "RollerShutterActuator":"RollerShutterActuatorState"==d.type&&(c=parseInt(d.state.state));
break;case "RoomHumiditySensor":"RoomHumiditySensorState"==d.type&&(c=parseFloat(d.state.state).toFixed(1));break;case "RoomTemperatureSensor":"RoomTemperatureSensorState"==d.type&&(c=parseFloat(d.state.state).toFixed(1));break;case "RoomTemperatureActuator":"RoomTemperatureActuatorState"==d.type&&("setTempState"==a.value?c=parseFloat(d.state.state).toFixed(1):"tempMode"==a.value&&(c=d.state.mode));break;case "AlarmActuator":"AlarmActuatorState"==d.type&&(c=d.state.state);break;case "WindowDoorSensor":"WindowDoorSensorState"==
d.type&&(c=d.state.state);break;case "SmokeDetectionSensor":"SmokeDetectionSensorState"==d.type&&(c=d.state.state);break;case "GenericActuator":d.type==b.data&&(c=d.state.state);break;default:return null}return c};b.prototype.toJSON=function(){return{sys:"rwe",ip:this.ip,port:this.port,username:this.user,password:this.password}};b.prototype.equalsTo=function(c){return c&&c instanceof b?this.ip==c.ip&&this.port==c.port&&this.user==c.user&&this.password==c.password:!1};return b}();
xnm.aio.rwe.DM=function(){var b=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};b.prototype=Error();b.prototype.name="RWEDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"rwe",MAP:{SwitchActuator:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",
options:["on","off"]}}]},DimmerActuator:{command:[{type:"enum",name:"dim down",ref:{value:"dimUp"}},{type:"enum",name:"dim up",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d"}}],status:[{type:"int",name:"dim level",ref:{value:"dimLevel"}}]},RollerShutterActuator:{command:[{type:"enum",name:"move down",ref:{value:"moveUp"}},{type:"enum",name:"move up",ref:{value:"moveDown"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d"}}],status:[{type:"int",name:"blind position",
ref:{value:"blindPos"}}]},RoomHumiditySensor:{status:[{type:"float",name:"humidity",ref:{value:"humState"}}]},RoomTemperatureSensor:{status:[{type:"float",name:"temperature",ref:{value:"tempState"}}]},RoomTemperatureActuator:{command:[{type:"enum",name:"auto mode",ref:{value:"tempAuto"}},{type:"enum",name:"manual mode",ref:{value:"tempManu"}},{type:"enum",name:"thermostat off",ref:{value:"tempOff"}},{type:"float",name:"set temperature",ref:{value:"tempTo",ext:"%f",extMeta:"6.0-30.0",scale:"0.5"}}],
status:[{type:"enum",name:"thermostat mode",ref:{value:"tempMode",options:["auto","manu"]}},{type:"float",name:"target temperature",ref:{value:"setTempState"}}]},AlarmActuator:{command:[{type:"enum",name:"alarm off",ref:{value:"alarmOff"}},{type:"enum",name:"alarm on",ref:{value:"alarmOn"}},{type:"enum",name:"alarm toggle",ref:{value:"alarmToggle"}}],status:[{type:"enum",name:"alarm status",ref:{value:"alarmState",options:["on","off"]}}]},WindowDoorSensor:{status:[{type:"enum",name:"contact status",
ref:{value:"contactState",options:["open","closed"]}}]},SmokeDetectionSensor:{status:[{type:"enum",name:"smoke alarm status",ref:{value:"smokeState",options:["on","off"]}}]},GenericActuator:{BooleanProperty:{command:[{type:"enum",name:"set true",ref:{value:"boolTrue"}},{type:"enum",name:"set false",ref:{value:"boolFalse"}},{type:"enum",name:"boolean toggle",ref:{value:"boolToggle"}}],status:[{type:"enum",name:"boolean state",ref:{value:"boolState",options:["true","false"]}}]},NumericProperty:{command:[{type:"float",
name:"set numeric value",ref:{value:"numTo",ext:"%f"}}],status:[{type:"float",name:"numberic state",ref:{value:"numState",options:["true","false"]}}]}}},getGatewayType:function(){return[{sys:this.SYS,name:"RWE / innogy SmartHome",port:443}]},getGatewayDeviceType:function(){return[]},createGateway:function(c,a,d){a=b.ERROR_CODE;c?c.ip?c.username?c.password?d(null,c):d(new b(a.INVALID,"password is invalid")):d(new b(a.INVALID,"username is invalid")):d(new b(a.INVALID,"ip is invalid")):d(new b(a.INVALID,
"info is invalid"))},updateGateway:function(c,a,d,e){c=b.ERROR_CODE;a?a.ip?a.username?a.password?e(null,a):e(new b(c.INVALID,"password is invalid")):e(new b(c.INVALID,"username is invalid")):e(new b(c.INVALID,"ip is invalid")):e(new b(c.INVALID,"update is invalid"))},deleteGateway:function(b,a,d){d()},createDevice:function(c,a,d){var e=b.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var g;for(g=0;g<a.length;g++)if(a[g].index===
c.gateway){var h=a[g];break}h?d(null,c):d(new b(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new b(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new b(e.INVALID,"type is invalid"));else d(new b(e.INVALID,"address is invalid"));else d(new b(e.INVALID,"gateway is invalid"));else d(new b(e.INVALID,"info is invalid"))},updateDevice:function(c,a,d){var e=b.ERROR_CODE;if(c)if(c.gateway)if(c.address)if(c.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var g;for(g=0;g<a.length;g++)if(a[g].index===c.gateway){var h=a[g];break}h?d(null,c):d(new b(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"))}else d(new b(e.NOT_FOUND,"gateway with index "+c.gateway+" not exists"));else d(new b(e.INVALID,"type is invalid"));else d(new b(e.INVALID,"address is invalid"));else d(new b(e.INVALID,"gateway is invalid"));else d(new b(e.INVALID,"info is invalid"))},deleteDevice:function(b,a,d){d()},applyUIFilter:function(b,a){var c=this,e=function(a,
b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},g=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){e(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},h=function(a,b){var d=[],e=c.getCommandStatusMap(a);e&&(a=g(e,a,b),d=d.concat(a));return d};if(!b)return null;var f=
JSON.parse(JSON.stringify(b)),k=null;switch(a.catagory){case "command":k=h(b,a);f.command=k;break;case "status":k=h(b,a);f.status=k;break;default:return null}return k&&0!=k.length?f:null},getCommandStatusMap:function(b){if(!b||!b.channels)return null;var a={command:[],status:[]},c;for(c in b.channels){var e=b.channels[c];if(e&&e.type&&this.MAP[e.type]){var g=this.MAP[e.type];if("GenericActuator"==e.type&&e.data&&(e=e.data.split(":"),2<=e.length&&g[e[0]]))return g[e[0]];g&&g.command&&(a.command=a.command.concat(g.command));
g&&g.status&&(a.status=a.status.concat(g.status))}}return a}}}();
xnm.aio.rwe.Handler=function(){var b=function(){};b.prototype.Central=xnm.aio.rwe.Central;b.prototype.devicemanager=xnm.aio.rwe.DM;b.prototype.discoverCentrals=function(b,a){var c=require("x.mdns.js");c.clearRecordBuffer();c.discoverServiceWithTimeout("_http._tcp.local",b,function(b,c){if(b)a&&a(b);else{b=[];for(var d=0;d<c.length;d++){var e=c[d];e.target&&e.ip&&0<e.ip.length&&0==e.target.indexOf("SMARTHOME")&&(e=new xnm.aio.rwe.Central(e.ip[0]),b.push(e))}a&&a(null,b)}})};b.prototype.registModule=
function(b){b.register(this.devicemanager.SYS,"rwe")};b.prototype.resolveGateway=function(b){return b&&b.ip?new this.Central(b.ip,b.port,b.username,b.password):null};b.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};b.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};b.prototype.doCommand=function(b,a,d,e){(b=this.resolveGateway(b))?
b.executeCommandCreator(a,d,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};b.prototype.doStatus=function(b,a,d,e,g){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:d,status:e}],function(a,b){a?g&&g(a):g&&g(null,b[0])}):g&&g(Error("gateway json format invalid"))};b.prototype.getDeviceList=function(b,a){(b=this.resolveGateway(b))?b.getDevices(function(b,c){a&&a(b,c)}):a&&a(Error("gateway json format invalid"))};b.prototype.getStateValues=function(b,a){return(new xnm.aio.rwe.Central).getStateValues(b.type,
a)};b.prototype.getDeviceCommandList=function(b,a,d){var c=[];a?(c.push({id:window.XC_Text.on,cmd:"on"}),c.push({id:window.XC_Text.off,cmd:"off"})):d&&("SwitchActuator"==b.type?(c.push({id:"on",cmd:"on"}),c.push({id:"off",cmd:"off"}),c.push({id:"toggle",cmd:"toggle"})):"DimmerActuator"==b.type?(c.push({id:"off",cmd:"dimTo0"}),c.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"RollerShutterActuator"==b.type?(c.push({id:"moveUp",cmd:"moveTo0"}),c.push({id:"moveDown",cmd:"moveTo100"}),c.push({id:"moveTo",
cmd:"moveTo",step:"1",min:"0",max:"100"})):"RoomTemperatureActuator"==b.type?(c.push({id:"setTo",cmd:"tempTo",step:"0.5",min:"6.5",max:"30",fact:"2"}),c.push({id:"off",cmd:"tempTo12"}),c.push({id:"setAuto",cmd:"auto"}),c.push({id:"setManu",cmd:"manu"})):"GenericActuator"==b.type&&("BooleanProperty:Value"==b.data?(c.push({id:"true",cmd:"true"}),c.push({id:"false",cmd:"false"})):"NumericProperty:Brightness"==b.data&&(c.push({id:"off",cmd:"setTo0"}),c.push({id:"setTo",cmd:"setTo",step:"1",min:"0",max:"100"}))));
return c};b.prototype.finalize=function(b){var a=b;setTimeout(function(){a&&(a(),a=null)},3E3);xnm.aio.rwe.Cache.finalize(function(){a&&(a(),a=null)})};b.prototype.pause=function(b){this.finalize(b)};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rwe.Handler);
