var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.warema=xnm.aio.warema||{};
xnm.aio.warema.WebControl=function(){var g={_buffer:[],addComm:function(a){this._buffer.push(a)},removeComm:function(a){a=this._buffer.indexOf(a);-1!=a&&this._buffer.splice(a)},finalize:function(){for(var a=0;a<this._buffer.length;a++)this._buffer[a]&&this._buffer[a].close();this._buffer=[]}},h=function(a){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl.Comm");this._listener=a;this._connectCallbacks=[];this._port=this._host=null;this._packetBuffer=[];this._status=0;this._timeout=
1E3;this._responseTimeout=2E3;this._idleTimeout=15E3;this._idleTO=null;this._cnt=0;this._socket=null};h.prototype.connect=function(a,b,c){if(2==this._status)c&&c();else if(c&&-1==this._connectCallbacks.indexOf(c)&&this._connectCallbacks.push(c),1!=this._status){this._host=a;this._port=b;this._logger.log("trace","connect socket:"+this._host);var d=this;a={port:this._port,host:this._host};var f=require("net").connect(a);f.setTimeout(this._timeout);this._status=1;f.on("connect",function(){d._logger.log("trace",
"connected to warema:"+d._host);f.__disconnected||d._onSocketConnect()});f.on("data",function(a){d._logger.log("trace","receive from warema "+(f.__disconnected?"(closed)":"")+":"+d._host+" data:"+a.toString("hex"));f.__disconnected||d._onSocketData(a)});f.on("error",function(a){d._logger.log("trace","warema gateway:"+d._host+" error:"+a.message);f.__disconnected||(1==d._status?d._onSocketConnect(a):(f.destroy&&f.destroy(),f.end(),d._onSocketClose(a)))});f.on("timeout",function(){f.__disconnected||
1!=d._status||(d._logger.log("trace","warema connect:"+d._host+" timeout"),f.destroy&&f.destroy(),d._onSocketConnect(Error("connect timeout")))});f.on("close",function(){d._logger.log("trace","warema gateway:"+(f.__disconnected?"(closed)":"")+":"+d._host+" close socket");f.__disconnected||d._onSocketClose()});f._doConnect&&"function"==typeof f._doConnect&&f._doConnect();this._socket=f}};h.prototype.close=function(){this._logger.log("trace","close socket");this._socket&&(this._socket.__disconnected=
!0,this._socket.end());this._onSocketClose()};h.prototype.sendPacket=function(a,b){if(2!=this._status)b&&b(Error("socket not connected"));else{var c=this;this._cnt++;255<this._cnt&&(this._cnt=0);var d={cnt:this._cnt,data:a,callback:b};this._packetBuffer.push(d);d.timeout=setTimeout(function(){c._logger.log("trace","response timeout for packet:"+d.cnt);var a=c._packetBuffer.indexOf(d);-1!=a&&c._packetBuffer.splice(a,1);b&&b(Error("reponse timeout"))},this._responseTimeout);this._send(d.cnt,a)}};h.prototype._send=
function(a,b){this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);var c=this;this._idleTO=setTimeout(function(){c._logger.log("trace","idle timeout");c.close()},this._idleTimeout);a=[144,this._cnt,b.length].concat(b);this._logger.log("trace","send data:"+(new Buffer(a)).toString("hex"));this._socket&&this._socket.write(new Buffer(a))};h.prototype._onSocketConnect=function(a){this._status=a?0:2;var b=this._connectCallbacks;this._connectCallbacks=[];for(var c=0;c<b.length;c++){var d=b[c];d&&
d(a)}if(!a){var f=this;this._idleTO&&clearTimeout(this._idleTO);this._idleTO=setTimeout(function(){f._logger.log("trace","connection idle timeout");f.close()},this._idleTimeout)}a||g.addComm(this)};h.prototype._onSocketClose=function(a){this._logger.log("trace","socket closed with err:"+(a?a.message:null));g.removeComm(this);this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);this._socket&&(this._socket.__disconnected=!0);this._status=0;this._socket=null;var b=this._packetBuffer;this._packetBuffer=
[];for(var c=0;c<b.length;c++){var d=b[c];d.timeout&&clearTimeout(d.timeout);a||(a=Error("socket closed"));d.callback&&d.callback(a)}};h.prototype._onSocketData=function(a){var b=-1;if(2<a.length)for(var c=a[1],d=0;d<this._packetBuffer.length;d++){var f=this._packetBuffer[d];if(f&&f.cnt==c){f.timeout&&clearTimeout(f.timeout);b=d;f.callback&&f.callback(null,a.slice(2));break}}-1!=b&&this._packetBuffer.splice(b,1)};var e=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl");
this._host=a;this._port=b;this._port||(this._port=5E4);this._comm=new h(this);this.CommandHandler=null;this._reqBuffer=[];this._positionReqCallbacks={};this._blackList=[]};e.prototype._setPersistantData=function(a){};e.prototype._getString=function(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return b};e.prototype._adr2id=function(a){var b=a.split(".");a=parseInt(b[0]);b=parseInt(b[1]);return{roomid:a,deviceid:b}};e.prototype._sendRequest=function(a,b){var c=this;this._comm.connect(this._host,
this._port,function(d){d?b&&b(d):c._comm.sendPacket(a,function(a,c){a?b&&b(a):c?b&&b(a,c):b&&b(Error("response is null"))})})};e.prototype.POLL_MAP={33:0,35:1,103:11};e.prototype._doRequest=function(a,b){var c=this;this._sendRequest(a,function(d,f){if(d)b&&b(d);else if(3==f[0]&&52==f[1])d=Error("error message"),d.requestID=f[2],d.errorCode=f[3],b&&b(d);else if(3==f[0]&&51==f[1]){var k=c.POLL_MAP[a[0]];if(2==f[3])d=Error("gateway stack timeout"),d.errorCode=-2,b&&b(d);else{var e=function(f,d){f?b&&
b(f):51==d[1]||50==d[1]?51==d[1]&&2==d[3]||50==d[1]&&2==d[5]?(f=Error("gateway stack timeout"),f.errorCode=-2,b&&b(f)):setTimeout(function(){c._poll(a[1],a[2],k,e)},50):b&&b(null,d)};c._poll(a[1],a[2],k,e)}}else b&&b(null,f)})};e.prototype._executeNextRequest=function(){if(0!=this._reqBuffer.length){for(var a=-1,b=0;b<this._reqBuffer.length;b++){var c=this._reqBuffer[b];if(c&&c.data&&35!=c.data[0]){a=b;break}}-1==a&&(a=0);var d=this,f=this._reqBuffer[a];f.timeout&&(clearTimeout(f.timeout),f.timeout=
null);this._doRequest(f.data,function(a,b){f.callback&&f.callback(a,b);a=d._reqBuffer.indexOf(f);-1!=a&&d._reqBuffer.splice(a,1);d._executeNextRequest()})}};e.prototype._executeRequest=function(a,b){var c=this,d=this._reqBuffer.length,f={data:a,callback:b};f.timeout=setTimeout(function(){var a=c._reqBuffer.indexOf(f);-1!=a&&c._reqBuffer.splice(a,1);b&&b(Error("queue busy"))},1E4);this._reqBuffer.push(f);0==d&&this._executeNextRequest()};e.prototype._closeSocket=function(){this._comm.close()};e.prototype._getRoomDevice=
function(a,b,c){var d=this;this._doRequest([13,a,b],function(a,k){a?c&&c(a):!k||6>k[0]||14!=k[1]?c&&c(Error("response invalid")):6==k[0]?c&&c(null,null):(a={},a.name=d._getString(k.slice(7)),a.id=b,0==k[4]?(a.type="device",7==k[6]?a.type="switch":2==k[6]?a.type="blind":3==k[6]?a.type="shutter":4==k[6]?a.type="awning":4==k[5]&&5==k[6]||6==k[5]&&5==k[6]?a.type="awning_valance":22==k[5]&&5==k[6]||23==k[5]&&5==k[6]?a.type="awning_valance2":15==k[5]&&1==k[6]?a.type="window":26==k[5]&&6==k[6]&&(a.type=
"dimmer"),a.data=[k[5],k[6]]):(a.type="scene",a.data=[k[4]]),c&&c(null,a))})};e.prototype._getRoomDevices=function(a,b){var c=this,d=0,f=[],k=function(e,g){e?2==e.errorCode?b&&b(null,f):b&&b(e):g?(g.address=a+"."+g.id,f.push(g),c._getRoomDevice(a,++d,k)):b&&b(null,f)};this._getRoomDevice(a,d,k)};e.prototype._getRoom=function(a,b){var c=this;this._doRequest([3,a],function(d,f){if(d)b&&b(d);else if(!f||2>f[0]||4!=f[1])b&&b(Error("response invalid"));else if(2==f[0])b&&b(null,null);else{var k=c._getString(f.slice(3));
c._getRoomDevices(a,function(c,d){b&&b(c,c?null:{name:k,id:a,devices:d})})}})};e.prototype._poll=function(a,b,c,d){this._sendRequest([49,a,b,c],function(a,b){a?d&&d(a):b?d&&d(null,b):d&&d(Error("response invalid"))})};e.prototype._getPosition=function(a,b,c){this._executeRequest([35,a,b],function(a,b){a?c&&c(a):!b||8>b[0]||36!=b[1]?c&&c(Error("response invalid")):(a={},a.roomid=b[2],a.deviceid=b[3],a.fahrt=b[4],a.position=b[5],a.winkel=b[6],a.pos_volant1=b[7],a.pos_volant2=b[8],c&&c(null,a))})};e.prototype._control=
function(a,b,c,d,f){a=[33,a,b,c];d||(d=[255,255,255,255]);a=a.concat(d);this._executeRequest(a,function(a,b){if(a)f&&f(a);else if(b){var c=null;4==b[0]&&34==b[1]&&(c={code:b[1],roomid:b[2],deviceid:b[3],feedback:b[4]});c||(a=Error("unknow response"));f&&f(a,c)}else f&&f(Error("response is null"))})};e.prototype._comfort=function(a,b,c,d){this._executeRequest([103,a,b,c],function(a,b){if(a)d&&d(a);else if(b){var c=null;4==b[0]&&104==b[1]&&(c={code:b[1],roomid:b[2],deviceid:b[3],execution:b[4]});c||
(a=Error("unknow response"));d&&d(a,c)}else d&&d(Error("response is null"))})};e.prototype._resolveStates=function(a,b){var c=null;if(null==a)return{timeout:!0};switch(b.type){case "switch":200==a.position?c={state:"on"}:0==a.position&&(c={state:"off"});break;case "dimmer":c={};c.state=a.position/2;break;case "blind":case "shutter":case "awning":case "window":case "awning_valance":case "awning_valance2":c={};c.position=a.position/2;c.positionT=30>=c.position?"top":70<=c.position?"bottom":"middle";
c.winkel=a.winkel-127;c.posVolant1=a.pos_volant1/2;c.posVolant2=a.pos_volant2/2;break;default:return null}c&&(c.timeout=!1);return c};e.prototype._getStates=function(a,b){if(-1!=this._blackList.indexOf(a)){var c=Error("device unreachable");c.errorCode=-2;b&&b(c)}else{c=this._positionReqCallbacks[a];c||(c=[],this._positionReqCallbacks[a]=c);var d=c.length;b&&-1==c.indexOf(b)&&c.push(b);if(0==d){b=this._adr2id(a);var f=this;this._getPosition(b.roomid,b.deviceid,function(b,c){b&&-2==b.errorCode&&f._blackList.push(a);
var d=f._positionReqCallbacks[a];f._positionReqCallbacks[a]=[];for(var e=0;e<d.length;e++)d[e]&&d[e](b,c)})}}};e.prototype.getDevices=function(a){var b=this,c=0,d=[],f=function(e,g){e?1==e.errorCode?a&&a(null,d):a&&a(e):g?(d.push(g),b._getRoom(++c,f)):a&&a(null,d)};this._getRoom(c,f)};e.prototype.executeCommandCreator=function(a,b,c){if(a&&a.address)if(b){var d=a.address.split(".");if(2!=d.length)c&&c(Error("device address invalid"));else{var f=parseInt(d[0]);d=parseInt(d[1]);var e=null,g=this;if("reset"==
b.value)f=this._blackList.indexOf(a.address),-1!=f&&(this._blackList.splice(f,1),c&&c());else{switch(a.type){case "switch":switch(b.value){case "on":var h=21;break;case "off":h=22;break;case "toggle":h=10;break;default:c&&c(Error("no such command"));return}break;case "dimmer":switch(b.value){case "on":h=28;e=[0,0,0,0];break;case "off":h=24;e=[0,0,0,0];break;case "dimTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);h=3;e=[2*b,255,255,255];
break;default:c&&c(Error("no such command"));return}break;case "awning":case "shutter":case "window":switch(b.value){case "stepUp":this._getStates(a.address,function(b,d){b?c&&c(b):(b=g._resolveStates(d,a))?(b=b.position,0==b?c&&c():g.executeCommandCreator(a,{value:"moveTo",ext:b-.5},c)):c&&c(Error("get rolladen states return invalid"))});return;case "stepDown":this._getStates(a.address,function(b,d){b?c&&c(b):(b=g._resolveStates(d,a))?(b=b.position,0==b?c&&c():g.executeCommandCreator(a,{value:"moveTo",
ext:b+.5},c)):c&&c(Error("get rolladen states return invalid"))});return}case "blind":case "awning_valance":case "awning_valance2":switch(b.value){case "moveTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);h=2;e=[2*b,255,255,255];break;case "winkelTo":if("undefined"==typeof b.ext||null==b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);h=3;e=[255,b+127,255,255];break;case "valanceTo":if("undefined"==typeof b.ext||null==
b.ext){c&&c(Error("command ext invalid"));return}b=parseFloat(b.ext);h=3;"awning_valance"==a.type?e=[255,255,2*b,255]:"awning_valance2"==a.type&&(e=[255,255,2*b,2*b]);break;case "stepUp":h=4;break;case "stepDown":h=5;break;case "up":h=6;break;case "down":h=7;break;case "stop":h=1;break;case "comfort":this._comfort(f,d,1,c);return;default:c&&c(Error("no such command"));return}break;case "scene":switch(b.value){case "run":h=8;break;default:c&&c(Error("no such command"));return}}this._control(f,d,h,
e,function(a,b){c&&c(a,b)})}}}else c&&c(Error("command is null"));else c&&c(Error("device format invalid"))};e.prototype.getStatesCreator=function(a,b,c){var d=function(a,b){for(var c=a.roomid+"."+a.deviceid,d=[],e=0;e<b.length;e++)if(b[e]&&b[e].id){var g="?";if(b[e]&&b[e].device&&b[e].status&&b[e].status.value){var h=b[e].status.value,k=b[e].device;if(k.address&&k.address==c){(k=a.timeout?{timeout:!0}:f._resolveStates(a,k))&&(g=k[h]);if("undefined"==typeof g||null==g)g="?";d.push({id:b[e].id,status:g})}}}return d},
f=this;this.CommandHandler=a;var e=[];for(a=0;a<b.length;a++)if(b[a]&&b[a].device){var g=b[a].device;g.address&&-1==e.indexOf(g.address)&&e.push(g.address)}var h=0,l=[],m=function(a,g){if(a&&-2==a.errorCode){var k=f._adr2id(e[h]);k.timeout=!0;(k=d(k,b))&&(l=l.concat(k))}!a&&g&&(k=d(g,b))&&(l=l.concat(k));h++;h==e.length?c&&c(null,l):f._getStates(e[h],m)};this._getStates(e[h],m)};e.prototype.toJSON=function(){return{sys:"warema",ip:this._host,port:this._port}};e.prototype.equalsTo=function(a){return a&&
a instanceof e?this._host==a._host&&this._port==a._port:!1};e.finalize=function(){g.finalize()};return e}();
xnm.aio.warema.DM=function(){var g=function(e,a){this.code=e;this.message=a;this.stack=Error().stack};g.prototype=Error();g.prototype.name="WaremaDMError";g.prototype.code=0;g.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var h={"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"enum",
name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"state",ref:{value:"state",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",
options:["true","false"]}}]},blind:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"winkel to",ref:{value:"winkelTo",ext:"%d",extMeta:"-80-80"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"winkel",ref:{value:"winkel",ext:"%d",extMeta:"-80-80"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},shutter:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",
name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top",
"middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",
name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},
{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle",
"bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance2:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",
ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true",
"false"]}}]},window:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zur\u00fccksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",
ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"run"}}]}};return{SYS:"warema",getGatewayType:function(){return[{sys:this.SYS,name:"warema WebControl",port:5E4}]},getGatewayDeviceType:function(){return[{sys:this.SYS,name:"Switch",type:"switch"},{sys:this.SYS,name:"Dimmer",type:"dimmer"},
{sys:this.SYS,name:"Blind",type:"blind"},{sys:this.SYS,name:"Shutter",type:"shutter"},{sys:this.SYS,name:"Awning",type:"awning"},{sys:this.SYS,name:"Awning with Valance",type:"awning_valance"},{sys:this.SYS,name:"Awning with 2 Valance",type:"awning_valance2"},{sys:this.SYS,name:"Scene",type:"scene"}]},createGateway:function(e,a,b){a=g.ERROR_CODE;e?e.ip?b(null,e):b(new g(a.INVALID,"ip is invalid")):b(new g(a.INVALID,"info is invalid"))},updateGateway:function(e,a,b,c){e=g.ERROR_CODE;a?a.ip?c(null,
a):c(new g(e.INVALID,"ip is invalid")):c(new g(e.INVALID,"update is invalid"))},deleteGateway:function(e,a,b){b()},createDevice:function(e,a,b){var c=g.ERROR_CODE;if(e)if(e.gateway)if(null==e.address||"undefined"==typeof e.address)b(new g(c.INVALID,"address is invalid"));else if(null==e.type||"undefined"==typeof e.type)b(new g(c.INVALID,"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var d;for(d=0;d<a.length;d++)if(a[d].index===e.gateway){var f=a[d];
break}f?b(null,e):b(new g(c.NOT_FOUND,"gateway with index "+e.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,"info is invalid"))},updateDevice:function(e,a,b){var c=g.ERROR_CODE;if(e)if(e.gateway)if(null==e.address||"undefined"==typeof e.address)b(new g(c.INVALID,"address is invalid"));else if(null==e.type||"undefined"==typeof e.type)b(new g(c.INVALID,"type is invalid"));else if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var d;for(d=0;d<a.length;d++)if(a[d].index===e.gateway){var f=a[d];break}f?b(null,e):b(new g(c.NOT_FOUND,"gateway with index "+e.gateway+" not exists"))}else b(new g(c.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));else b(new g(c.INVALID,"gateway is invalid"));else b(new g(c.INVALID,"info is invalid"))},deleteDevice:function(e,a,b){b()},applyUIFilter:function(e,a,b){var c=function(a,b,d){var e=[];a.forEach(function(a){if("root"==
a.type){a=JSON.parse(JSON.stringify(a));var f=c(a.children,b,d);f&&0<f.length&&(a.children=f,e.push(a))}else{f=d.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},d=function(a,d){var e=[],f=xnm.aio.warema.DM.getCommandStatusMap(a,b);if(f){var g=[];switch(d.catagory){case "command":f.command&&(g=c(f.command,a,d));break;case "status":f.status&&(g=c(f.status,a,d))}e=e.concat(g)}return e};if(!e.sys)return null;
var f=JSON.parse(JSON.stringify(e)),g=null;switch(a.catagory){case "command":g=d(e,a);f.command=g;break;case "status":g=d(e,a);f.status=g;break;default:return null}return g&&0!=g.length?f:null},getCommandStatusMap:function(e){return e&&e.type?h[e.type]:null}}}();xnm.aio.warema.Handler=function(){this.detectedWebControls={}};xnm.aio.warema.Handler.prototype.getStateValues=function(g,h){return(new xnm.aio.warema.WebControl).getStateValues(g.type,h)};
xnm.aio.warema.Handler.prototype.getDeviceCommandList=function(g,h,e){h=[];"Switch"==g.type&&(h.push({id:"on",cmd:"ON"}),h.push({id:"off",cmd:"OFF"}));return h};xnm.aio.warema.Handler.prototype.WebControl=xnm.aio.warema.WebControl;xnm.aio.warema.Handler.prototype.devicemanager=xnm.aio.warema.DM;xnm.aio.warema.Handler.prototype.registModule=function(g){g.register(this.devicemanager.SYS,"warema")};
xnm.aio.warema.Handler.prototype.resolveGateway=function(g){return g&&g.ip?new this.WebControl(g.ip,g.port):null};xnm.aio.warema.Handler.prototype.getDeviceCommands=function(g,h){g=(g=this.devicemanager.applyUIFilter(g,{catagory:"command",elems:"*"}))?g.command:[];h&&h(null,g)};xnm.aio.warema.Handler.prototype.getDeviceStatus=function(g,h){g=(g=this.devicemanager.applyUIFilter(g,{catagory:"status",elems:"*"}))?g.status:[];h&&h(null,g)};
xnm.aio.warema.Handler.prototype.doCommand=function(g,h,e,a){(g=this.resolveGateway(g))?g.executeCommandCreator(h,e,function(b){a&&a(b)}):a&&a(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.doStatus=function(g,h,e,a,b){(h=this.resolveGateway(h))?h.getStatesCreator(null,[{id:g,device:e,status:a}],function(a,d){a?b&&b(a):b&&b(null,d[0])}):b&&b(Error("gateway json format invalid"))};
xnm.aio.warema.Handler.prototype.discoveryWithTimeout=function(g,h){var e=this,a=require("x.mdns.js");a.clearRecordBuffer();a.discoverServiceWithTimeout("_ipp._tcp.local",g,function(a,c){if(a)h&&h(a);else{for(var b=[],f=0;f<c.length;f++){var g=c[f];g.target&&g.ip&&0<g.ip.length&&-1!=g.target.toLowerCase().indexOf("webcontrol")&&(g=new e.WebControl(g.ip[0]),b.push(g))}h&&h(a,b)}})};
xnm.aio.warema.Handler.prototype.getDeviceList=function(g,h){(g=this.resolveGateway(g))?g.getDevices(function(e,a){h&&h(e,a)}):h&&h(Error("gateway json format invalid"))};xnm.aio.warema.Handler.prototype.finalize=function(g){var h=g;setTimeout(function(){h&&(h(),h=null)},3E3);this.WebControl.finalize(function(){h&&(h(),h=null)})};xnm.aio.warema.Handler.prototype.pause=function(g){this.finalize(g)};"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.warema.Handler);
