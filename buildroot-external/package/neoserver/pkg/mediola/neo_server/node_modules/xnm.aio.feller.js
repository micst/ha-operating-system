var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,c,a){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(c.call(a,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,a){b!=Array.prototype&&b!=Object.prototype&&(b[c]=a.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var c=0;c<b.length;++c){var a=b[c];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,c,a,d){if(c){a=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in a||(a[e]={});a=a[e]}b=b[b.length-1];d=a[b];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:c})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(c,a){return $jscomp.findInternal(this,c,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.feller=xnm.aio.feller||{};
xnm.aio.feller.Zeptrion=function(){var b=function(c,a,d,b){this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.feller.Zeptrion");this.ip=c;this.port=a;this.port||(this.port=80);this.type=d;this.uuid=b;this.CommandHandler=null};b.prototype.getDevice=function(c,a,d,b){var e=this;$.ajax({url:"http://"+this.ip+"/zrap/net",method:"POST",data:{ssid:c,pw:a,enc:d},statusCode:{302:function(){e._reboot(function(a){b&&b(a)})}}})};b.prototype._doRequest=
function(c,a,d,b){var e=this;a="http://"+this.ip+":"+this.port+a;this._logger.log("trace","send "+c+" to url:"+a+" data:"+d);var g=b;$.ajax({url:a,type:c,timeout:1E4,data:d,dataType:"text",cache:!0,success:function(a){e._logger.log("trace","http request success:"+a);g&&(g(null,a),g=null)},error:function(a,c){c="http request error:"+(a?a.status:"0")+"-"+c;e._logger.log("trace",c);c=Error(c);c.code=a?a.status:0;g&&(g(c),g=null)}})};b.prototype._reboot=function(c){$.ajax({url:"http://"+this.ip+"/zrap/sys",
method:"POST",data:{cmd:"reboot"},statusCode:{302:function(){var a="Device is now in network: "+ssid;c&&c(a)}}})};b.prototype.getState=function(c,a){this._doRequest("/zrap/chscan/ch"+c,function(d,b){d=$.parseXML(b);d=$(d).find("ch"+c);d=d[0]._children[0]._value;a&&a(d)})};b.prototype.chScan=function(c){this._doRequest("GET","/zrap/chscan",null,function(a,d){if(a)c&&c(a);else try{var b=$($.parseXML(d));if(b){a={};var f=b.find("ch1 val");f&&0<f.length&&(a.ch1=$(f[0]).text());var g=b.find("ch2 val");
g&&0<g.length&&(a.ch2=$(g[0]).text());var h=b.find("ch3 val");h&&0<h.length&&(a.ch3=$(h[0]).text());var l=b.find("ch4 val");l&&0<l.length&&(a.ch4=$(l[0]).text());c&&c(null,a)}else c&&c(Error("chscan response invalid"))}catch(k){c&&c(k)}})};b.prototype.notify=function(c,a){this._doRequest("/zrap/chnotify/ch"+c,function(b,e){e=$.parseXML(e);c=$(e).find("ch"+c);e=c[0]._children[0]._value;var d={state:"?",current:"?"};!b&&e&&(100==e?d.state="on":0==e?d.state="off":-1==e&&(d.state="?"),a&&a(d))})};b.prototype.parseState=
function(c,a){a=parseInt(a);switch(c){case "switch":return{state:0==a?"off":"on"};case "dimmer":return{state:a};default:return null}};b.prototype.executeCommand=function(c,a,b){a?c?this._doRequest("POST","/zrap/chctrl/ch"+a,"cmd="+c,function(a){a&&302==a.code&&(a=null);b&&b(a)}):b&&b(Error("command is null")):b&&b(Error("channel is null"))};b.prototype.executeCommandCreator=function(b,a,d){if(a&&a.value)if(b&&b.address){var c=a.value;switch(a.value){case "recall_s":case "store_s":case "delete_s":if(!a.ext){d&&
d(Error("command ext invalid"));return}c+=a.ext}this.executeCommand(c,b.address,function(a){d&&d(a)})}else d&&d(Error("device json invalid"));else d&&d(Error("command json invalid"))};b.prototype.getStatesCreator=function(b,a,d){if(a)if(0==a.length)d&&d(null,[]);else{var c=this;this.chScan(function(b,e){if(b)d&&d(b);else{b=[];for(var f=0;f<a.length;f++)if(a[f].id){var g="?";if(a[f].status&&a[f].status.value&&a[f].device&&a[f].device.address){var k="ch"+a[f].device.address;e&&e[k]&&(k=c.parseState(a[f].device.type,
e[k]))&&(g=k[a[f].status.value]);if("undefined"==typeof g||null==g)g="?"}b.push({id:a[f].id,status:g})}d&&d(null,b)}})}else d&&d(Error("deviceList is null"))};b.prototype.toJSON=function(){return{sys:"feller",ip:this.ip,port:this.port,type:this.type,uuid:this.uuid}};b.prototype.equalsTo=function(b){return b&&b instanceof xnm.aio.feller.Zeptrion?this.ip==b.ip:!1};b.parseJSON=function(c){return c.ip&&c.type?new b(c.ip,c.port,c.type,c.uuid):null};return b}();
xnm.aio.feller.DM=function(){var b=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};b.prototype=Error();b.prototype.name="FellerDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var c={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},
{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dim_up"}},{type:"enum",name:"dim down",ref:{value:"dim_down"}},{type:"enum",name:"stop",
ref:{value:"stop"}},{type:"int",name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"move_open"}},{type:"enum",name:"move close",ref:{value:"move_close"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",
name:"call scene",ref:{value:"recall_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"store scene",ref:{value:"store_s",ext:"%d",extMeta:"1-4"}},{type:"int",name:"delete scene",ref:{value:"delete_s",ext:"%d",extMeta:"1-4"}}]}};return{SYS:"feller",getGatewayType:function(){return[{sys:this.SYS,name:"Feller Zeptrion",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,
type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}]},createGateway:function(a,c,e){c=b.ERROR_CODE;a?a.ip?a.port?a.type?e(null,a):e(new b(c.INVALID,"type is invalid")):e(new b(c.INVALID,"port is invalid")):e(new b(c.INVALID,"ip is invalid")):e(new b(c.INVALID,"info is invalid"))},updateGateway:function(a,c,e,f){a=b.ERROR_CODE;c?c.ip?c.port?c.type?f(null,c):f(new b(a.INVALID,"type is invalid")):f(new b(a.INVALID,"port is invalid")):f(new b(a.INVALID,"ip is invalid")):f(new b(a.INVALID,
"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,c,e){var d=b.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===a.gateway){var h=c[g];break}h?e&&e(null,a):e(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new b(d.INVALID,"gateway is invalid"));else e(new b(d.INVALID,"type is invalid"));else e(new b(d.INVALID,"address is invalid"));else e(new b(d.INVALID,"info is invalid"))},
updateDevice:function(a,c,e){var d=b.ERROR_CODE;if(a)if(a.address)if(a.type)if(a.gateway){c=c.data.gateways;var g;for(g=0;g<c.length;g++)if(c[g].index===a.gateway){var h=c[g];break}h?e(null,a):e(new b(d.NOT_FOUND,"gateway with index "+a.gateway+" not exists"))}else e(new b(d.INVALID,"gateway is invalid"));else e(new b(d.INVALID,"type is invalid"));else e(new b(d.INVALID,"address is invalid"));else e(new b(d.INVALID,"info is invalid"))},deleteDevice:function(a,c,b){b()},applyUIFilter:function(a,c,
b){var d=function(a,c){if("*"==a)return!0;for(var b=!1,d=0;d<a.length;d++)if(a[d]==c){b=!0;break}return b},e=function(a,c,b){var e=[];"command"==b.catagory?a.command&&a.command.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}):"status"==b.catagory&&a.status&&a.status.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});return e},h=function(a,c){var d=[],f=xnm.aio.feller.DM.getCommandStatusMap(a,b);f&&(a=e(f,a,c),d=d.concat(a));return d};
if(!a.sys)return null;var l=JSON.parse(JSON.stringify(a)),k=null;if("command"==c.catagory)k=h(a,c),l.command=k;else if("status"==c.catagory)k=h(a,c),l.status=k;else return null;return k&&0!=k.length?l:null},getCommandStatusMap:function(a,b){return a.type?c[a.type]:null}}}();
xnm.aio.feller.Handler=function(){var b=function(){};b.prototype.devicemanager=xnm.aio.feller.DM;b.prototype.Zeptrion=xnm.aio.feller.Zeptrion;b.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"feller")};b.prototype.resolveGateway=function(b){return b?this.Zeptrion.parseJSON(b):null};b.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};b.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,
{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};b.prototype.doCommand=function(b,a,d,e){(b=this.resolveGateway(b))?b.executeCommandCreator(a,d,function(a){e&&e(a)}):e&&e(Error("gateway json format invalid"))};b.prototype.doStatus=function(b,a,d,e,f){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:d,status:e}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};b.prototype.discover=function(b,a){var c=this,e=require("x.mdns.js");e.clearRecordBuffer();
var f={},g=2;e.discoverServiceWithTimeout("_zapp._tcp.local",b,function(b,d){g--;if(b)a&&a(b);else{for(b=0;b<d.length;b++){var e=d[b];if(e.target&&e.ip&&0<e.ip.length){var h=e.target.toLowerCase(),l=h.indexOf("-"),m=h.indexOf(".");h=h.substring(l+1,m);f[h]=new c.Zeptrion(e.ip[0],null,e.info.type,h)}}if(0==g){d=[];for(var n in f)d.push(f[n]);a&&a(null,d)}}});e.discoverServiceWithTimeout("_http._tcp.local",b,function(b,d){g--;if(b)a&&a(b);else{for(b=0;b<d.length;b++){var e=d[b];if(e.target&&e.ip&&0<
e.ip.length){var h=e.target.toLowerCase();if("zapp"==h.substr(0,4)){var l=h.indexOf("-"),m=h.indexOf(".");h=h.substring(l+1,m);e=new c.Zeptrion(e.ip[0],null,e.info.type,h);f[h]||(f[h]=e)}}}if(0==g){d=[];for(var n in f)d.push(f[n]);a&&a(null,d)}}})};b.prototype.getDeviceList=function(b,a){b&&b.type?0==b.type.indexOf("3340-4")?a&&a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""},{sys:"feller",address:3,type:""},{sys:"feller",address:4,type:""}]):0==b.type.indexOf("3340-2")?a&&
a(null,[{sys:"feller",address:1,type:""},{sys:"feller",address:2,type:""}]):a&&a(Error("unknow gateway type")):a&&a(Error("gateway json invalid"))};return b}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.feller.Handler);
