var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.checkStringArgs=function(c,b,d){if(null==c)throw new TypeError("The 'this' value for String.prototype."+d+" must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype."+d+" must not be a regular expression");return c+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,b,d){c!=Array.prototype&&c!=Object.prototype&&(c[b]=d.value)};$jscomp.getGlobal=function(c){c=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,c];for(var b=0;b<c.length;++b){var d=c[b];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(c,b,d,f){if(b){d=$jscomp.global;c=c.split(".");for(f=0;f<c.length-1;f++){var k=c[f];k in d||(d[k]={});d=d[k]}c=c[c.length-1];f=d[c];b=b(f);b!=f&&null!=b&&$jscomp.defineProperty(d,c,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("String.prototype.repeat",function(c){return c?c:function(b){var d=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var f="";b;)if(b&1&&(f+=d),b>>>=1)d+=d;return f}},"es6","es3");var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),Logger=require("x.logger.js"),deviceman=require("x.hub.deviceman.js"),fileman=require("x.hub.fileman.js"),x=x||{};
x.hub=x.hub||{};x.hub.taskman=x.hub.taskman||{};x.hub.taskman.ERROR_CODE={General_Error:"100000",Pin_Error:"100001"};
x.hub.taskman.Cloud=function(){var c=function(){};c.prototype.URL="https://webservice.mediola.com";c.prototype._doRequest=function(b,d,f,k,c,a,g){d=require("url").parse(this.URL+d);b={host:d.hostname,port:d.port,path:d.path,method:b,headers:k};if(c||a)b.auth=(c?c:"")+":"+(a?a:"");c=require("http");"https:"==d.protocol?(c=require("https"),process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),b.port||(b.port=443)):b.port||(b.port=80);var l=g;g=c.request(b,function(a){var d="";a.on("data",
function(a){d+=a});a.on("end",function(){var b=null;200!=a.statusCode&&(b=Error("http response error"));l&&l(b,d,a.statusCode,a.headers)})});g.setTimeout(5E3,function(){l&&l(Error("timeout"));l=null});g.on("error",function(a){l&&l(a);l=null});f&&g.write(f);g.end()};return c}();
x.hub.taskman._Util={TimeZone_MAP:[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},
{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,
dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},
{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],_getTimeZone:function(){if("CA"==global.HARDWARE_VERSION||"A1"==global.HARDWARE_VERSION)return require("x.hub.js").getServer().getTimezoneSync();var c="8C";localStorage.getItem("x.hub.Server.timezone")&&(c=localStorage.getItem("x.hub.Server.timezone"));
c=parseInt(c,16);var b=0!=(c&128),d=(c&31)-11,f=null;this.TimeZone_MAP.forEach(function(c){c.utc==d&&c.dst==b&&(f=c.zone)});f||(f="Europe/Berlin");return f},_getlatlong:function(){if("CA"==global.HARDWARE_VERSION){var c="020D",b="0087";localStorage.getItem("x.hub.Server.geo.lat")&&(c=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(b=localStorage.getItem("x.hub.Server.geo.long"));c=parseInt(c,16);32768<c&&(c=32768-c);c/=10;b=parseInt(b,16);32768<b&&(b=
32768-b);return{lat:c,long:b/10}}c="1392";b="035C";localStorage.getItem("x.hub.Server.geo.lat")&&(c=localStorage.getItem("x.hub.Server.geo.lat"));localStorage.getItem("x.hub.Server.geo.long")&&(b=localStorage.getItem("x.hub.Server.geo.long"));c=parseInt(c,16);32768<c&&(c=32768-c);c/=100;b=parseInt(b,16);32768<b&&(b=32768-b);return{lat:c,long:b/100}}};
x.hub.taskman._TimerManager=function(){var c=function(d,b){this._logger=require("x.logger.js").getLogger("x.hub.taskman._TimerManager.CronTimer");this.taskID=d;this.timer=b;this._cronJob=null};c.prototype.start=function(){if(this.timer.time){var d=[],b=this.timer.time.indexOf(":"),c=this.timer.time.substr(0,b);b=this.timer.time.substr(b+1);d.push("00");d.push(b);d.push(c);d.push("*");d.push("*");c="0-6";if(this.timer.week&&7==this.timer.week.length){c=[];"1"==this.timer.week.charAt(6)&&c.push(0);
for(b=0;6>b;b++)"1"==this.timer.week.charAt(b)&&c.push(b+1);c=c.join(",")}d.push(c);d=d.join(" ");c=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+d+" tz:"+c);this._cronJob=new (require("cron").CronJob)(d,this.onTick.bind(this),null,!0,c)}};c.prototype.stop=function(){this._logger.log("debug","#"+this.taskID+" stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),
this._cronJob=null)};c.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" timer tick:"+JSON.stringify(this.timer));var d=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=d.tz(c,b);var h=c.year(),a=!1,g=!1,l=null,p=null;c=c.valueOf();var m=this.timer.start;m&&("00"==m.substr(0,2)&&(a=!0,m=h+m.substr(2)),m=d.tz(m,b),m.set({hour:0,minute:0,second:0,millisecond:0}),l=m.valueOf());var r=this.timer.end;r&&("00"==r.substr(0,2)&&(g=!0,r=h+r.substr(2)),
r=d.tz(r,b),r.set({hour:23,minute:59,second:59,millisecond:999}),p=r.valueOf());if(a&&g&&l>p){if(p<c&&l>c)return}else if(m&&l>c||r&&p<c)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID)};c.prototype.onLocationChange=function(){this.stop();this.start()};c.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(d,b){d=new c(d,b);this._timers.push(d);d.start()};b.prototype.stopTimer=function(b){var d=[];this._timers.forEach(function(f){f.taskID==
b?f.stop():d.push(f)});this._timers=d};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};return new b}();
x.hub.taskman._AstroManager=function(){var c=function(b,f){this._logger=require("x.logger.js").getLogger("x.hub.taskman._AstroManager.AstroTimer");this.taskID=b;this.astro=f;this._job=null};c.prototype.start=function(){this.astro.astro&&(this._logger.log("debug","#"+this.taskID+" start astro:"+JSON.stringify(this.astro)),this._startNextTick())};c.prototype.stop=function(){this._logger.log("debug","stop astro:"+JSON.stringify(this.astro));this._job&&(clearTimeout(this._job),this._job=null)};c.prototype._startNextTick=
function(){var b=this._getNextTickTime();this._logger.log("debug","#"+this.taskID+" next "+this.astro.astro+":"+new Date(b));var f=(new Date).getTime(),c=this;this._job=setTimeout(function(){try{c.onTick()}catch(h){}c._startNextTick()},b-f)};c.prototype._getNextTickTime=function(){var b=x.hub.taskman._Util._getlatlong(),f=require("suncalc"),c=new Date,h=f.getTimes(c,b.lat,b.long);h="sunrise"==this.astro.astro?h.sunrise:h.sunset;h=h.getTime();this.astro.delay&&(h+=6E4*parseInt(this.astro.delay));h<=
c.getTime()&&(c=new Date(c.getTime()+864E5),h=f.getTimes(c,b.lat,b.long),h="sunrise"==this.astro.astro?h.sunrise:h.sunset,h=h.getTime(),this.astro.delay&&(h+=6E4*parseInt(this.astro.delay)));return h};c.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" astro tick:"+JSON.stringify(this.astro));var b=require("moment-timezone"),f=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=b.tz(c,f);var h=c.year();if(this.astro.offTime){var a=this.astro.offTime.indexOf(":"),g=this.astro.offTime.substr(0,
a);a=this.astro.offTime.substr(a+1);g=parseInt(g);a=parseInt(a);if(c.hour()<g||c.hour()==g&&c.minute()<=a)return}g=c.day();0==g&&(g=7);if(!this.astro.week||7!=this.astro.week.length||"0"!=this.astro.week.charAt(g-1)){a=g=!1;var l=null,p=null;c=c.valueOf();var m=this.astro.start;m&&("00"==m.substr(0,2)&&(g=!0,m=h+m.substr(2)),m=b.tz(m,f),m.set({hour:0,minute:0,second:0,millisecond:0}),l=m.valueOf());var r=this.astro.end;r&&("00"==r.substr(0,2)&&(a=!0,r=h+r.substr(2)),r=b.tz(r,f),r.set({hour:23,minute:59,
second:59,millisecond:999}),p=r.valueOf());if(g&&a&&l>p){if(p<c&&l>c)return}else if(m&&l>c||r&&p<c)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.astro))}};c.prototype.onLocationChange=function(){this.stop();this.start()};c.prototype.onTimeChange=function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,f){b=new c(b,f);this._timers.push(b);b.start()};b.prototype.stopTimer=function(b){var d=[];this._timers.forEach(function(c){c.taskID==
b?c.stop():d.push(c)});this._timers=d};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;this._timers=[];b.forEach(function(b){b.stop()})};b.prototype.getSunriseSunset=function(b){var d=require("moment-timezone"),c=x.hub.taskman._Util._getTimeZone();b=d.tz(b,c);b.set({hour:12,minute:0,second:0,millisecond:0});d=x.hub.taskman._Util._getlatlong();
return require("suncalc").getTimes(b.toDate(),d.lat,d.long)};return new b}();
x.hub.taskman._PeriodicTimerManager=function(){var c=function(b,c){this._logger=require("x.logger.js").getLogger("x.hub.taskman._PeriodicTimerManager.CronTimer");this.taskID=b;this.timer=c;this._repeater=this._cronJob=this._starter=null};c.prototype.start=function(){if(this.timer.interval){var b=this.timer.startTime,c=this.timer.endTime;b||(b="00:00");c||(c="23:59");var k=[],h=b.indexOf(":"),a=b.substr(0,h);h=b.substr(h+1);k.push("00");k.push(h);k.push(a);k.push("*");k.push("*");var g="0-6";if(this.timer.week&&
7==this.timer.week.length){g=[];"1"==this.timer.week.charAt(6)&&g.push(0);for(var l=0;6>l;l++)"1"==this.timer.week.charAt(l)&&g.push(l+1);g=g.join(",")}k.push(g);k=k.join(" ");g=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer));this._logger.log("trace","start cron job:"+k+" tz:"+g);this._cronJob=new (require("cron").CronJob)(k,this.onFirstTick.bind(this),null,!0,g);l=require("moment-timezone");var p=(new Date).getTime();k=l.tz(p,
g);a=k.year();var m=!1;h=!1;var r=null,t=null,q=k.valueOf(),u=this.timer.start;u&&("00"==u.substr(0,2)&&(m=!0,u=a+u.substr(2)),u=l.tz(u,g),u.set({hour:0,minute:0,second:0,millisecond:0}),r=u.valueOf());var w=this.timer.end;w&&("00"==w.substr(0,2)&&(h=!0,w=a+w.substr(2)),w=l.tz(w,g),w.set({hour:23,minute:59,second:59,millisecond:999}),t=w.valueOf());if(m&&h&&r>t){if(t<q&&r>q)return}else if(u&&r>q||w&&t<q)return;if(a=this.timer.week)if(m=k.isoWeekday(),"1"!=a.charAt(m-1))return;m=l.tz(p,g);h=b.indexOf(":");
a=b.substr(0,h);h=b.substr(h+1);m.set({hour:parseInt(a),minute:parseInt(h),second:0,millisecond:0});if(!(m.valueOf()>k.valueOf()||(b=l.tz(p,g),h=c.indexOf(":"),a=c.substr(0,h),h=c.substr(h+1),b.set({hour:parseInt(a),minute:parseInt(h),second:0,millisecond:0}),b.valueOf()<k.valueOf()||!(c=this.timer.interval)))){c=1E3*parseInt(c);c=Math.ceil((k.valueOf()-m.valueOf())/c)*c+m.valueOf()-k.valueOf();this._logger.log("trace","first tick in "+c/1E3+" seconds");var v=this;this._starter=setTimeout(function(){v.onFirstTick()},
c)}}};c.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._starter&&(clearTimeout(this._starter),this._starter=null)};c.prototype.onFirstTick=function(){this._logger.log("debug","periodic timer first tick:"+JSON.stringify(this.timer));var b=this.timer.interval;if(b){b=1E3*parseInt(b);var c=this;this._starter&&(clearTimeout(this._starter),
this._starter=null);this._repeater&&(clearInterval(this._repeater),this._repeater=null);this._repeater=setInterval(function(){c.onTick()},b);this.onTick()}};c.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" periodic timer tick:"+JSON.stringify(this.timer));var b=require("moment-timezone"),c=this.timer.interval;c=1E3*parseInt(c);var k=x.hub.taskman._Util._getTimeZone(),h=(new Date).getTime();c=h+c;var a=b.tz(h,k);h=b.tz(h,k);var g=h.year(),l=!1,p=!1,m=null,r=null,t=h.valueOf(),
q=this.timer.start;q&&("00"==q.substr(0,2)&&(l=!0,q=g+q.substr(2)),q=b.tz(q,k),q.set({hour:0,minute:0,second:0,millisecond:0}),m=q.valueOf());var u=this.timer.end;u&&("00"==u.substr(0,2)&&(p=!0,u=g+u.substr(2)),u=b.tz(u,k),u.set({hour:23,minute:59,second:59,millisecond:999}),r=u.valueOf());if(l&&p&&m>r){if(r<t&&m>t)return}else if(q&&m>t||u&&r<t)return;(k=this.timer.endTime)||(k="23:59");g=k.indexOf(":");b=k.substr(0,g);k=k.substr(g+1);a.set({hour:parseInt(b),minute:parseInt(k),second:59,millisecond:999});
a.valueOf()<h.valueOf()?(this._logger.log("trace","repeater exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)):(c>a.valueOf()&&(this._logger.log("trace","repeater next tick will exceed end time:"+a.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)),require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.timer)))};c.prototype.onLocationChange=function(){this.stop();this.start()};c.prototype.onTimeChange=
function(){this.stop();this.start()};var b=function(){this._timers=[]};b.prototype.startTimer=function(b,f){b=new c(b,f);this._timers.push(b);b.start()};b.prototype.stopTimer=function(b){var d=[];this._timers.forEach(function(c){c.taskID==b?c.stop():d.push(c)});this._timers=d};b.prototype.onLocationChange=function(){this._timers.forEach(function(b){b.onLocationChange()})};b.prototype.onTimeChange=function(){this._timers.forEach(function(b){b.onTimeChange()})};b.prototype.clear=function(){var b=this._timers;
this._timers=[];b.forEach(function(b){b.stop()})};return new b}();
x.hub.taskman._Block=function(){var c=function(e){this.type=e;this._parent=null;this._canceling=this._running=!1;this._trace=null};c.prototype.isRunning=function(){return this._running};c.prototype.do=function(e){e&&e()};c.prototype.cancel=function(e){var a=this._running;this._canceling=this._running=!1;e&&e(null,a)};c.prototype.toJSON=function(){return{type:this.type}};c.prototype.fromJSON=function(){};c.prototype.setTrace=function(e){this._trace=e};var b=function(){c.call(this);this.type=b.TYPE;
this.subtype=null;this.flowIf=[];this.flowThen=[];this.flowElse=[]};util.inherits(b,c);b.TYPE="condition";b.prototype.isRunning=function(){var e=!1;this.flowIf&&this.flowIf.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});this.flowThen&&this.flowThen.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});this.flowElse&&this.flowElse.forEach(function(a){a&&a.isRunning&&(e|=a.isRunning())});return e?!0:!1};b.prototype.do=function(e,a){var b=this;this._trace&&this._trace.log('condition | check "if"');
this._checkIfBlocks(function(n,d){b._trace&&b._trace.log('condition | check "if" - '+(n?"error:"+n.message:d));n?e&&e(n):d?(b._trace&&b._trace.log('condition | do "then"'),b._doThenBlocks(e,a)):(b._trace&&b._trace.log('condition | do "else"'),b._doElseBlocks(e,a))},a)};b.prototype.cancel=function(e){var a=0;this.flowIf&&this.flowIf.forEach(function(e){e&&e.cancel?e.cancel():a++});this.flowThen&&this.flowThen.forEach(function(e){e&&e.cancel?e.cancel():a++});this.flowElse&&this.flowElse.forEach(function(e){e&&
e.cancel?e.cancel():a++})};b.prototype.toJSON=function(){var e={type:this.type,subtype:this.subtype,if:[],then:[],else:[]};this.flowIf&&this.flowIf.forEach(function(a){a&&e.if.push(a.toJSON())});this.flowThen&&this.flowThen.forEach(function(a){a&&e.then.push(a.toJSON())});this.flowElse&&this.flowElse.forEach(function(a){a&&e.else.push(a.toJSON())});return e};b.prototype.fromJSON=function(e){if(e){var a=this;this.subtype=e.subtype;e.if&&0<e.if.length&&e.if.forEach(function(e){e&&(e=c.parse(e))&&(e._parent=
a,a.flowIf.push(e))});e.then&&0<e.then.length&&e.then.forEach(function(e){e&&(e=c.parse(e))&&a.flowThen.push(e)});e.else&&0<e.else.length&&e.else.forEach(function(e){e&&(e=c.parse(e))&&a.flowElse.push(e)})}};b.prototype._checkIfBlocks=function(e,a){var b=[],n=0,d=this;if(this.flowIf&&0!=this.flowIf.length){var c=function(g,f){n++;g?b.push(!1):b.push(f);if(n<d.flowIf.length)d.flowIf[n].do(c,a);else if(0==b.length)e&&e(null,!0);else{g=1;for(f=b[0];g<b.length&&g+1!=b.length;)"AND"==b[g]?f&=b[g+1]:"OR"==
b[g]?f|=b[g+1]:"XOR"==b[g]&&(f=f!=b[g+1]),g+=2;e&&e(null,f)}};this.flowIf[n].do(c,a)}else e&&e(null,!0)};b.prototype._doThenBlocks=function(e,a){var b=0,n=this;if(this.flowThen&&0!=this.flowThen.length){var d=function(){b++;b<n.flowThen.length?n.flowThen[b].do(d,a):e&&e()};this.flowThen[b].do(d,a)}else e&&e()};b.prototype._doElseBlocks=function(e,a){var b=0,n=this;if(this.flowElse&&0!=this.flowElse.length){var d=function(){b++;b<n.flowElse.length?n.flowElse[b].do(d,a):e&&e()};this.flowElse[b].do(d,
a)}else e&&e()};b.prototype.setTrace=function(e){this._trace=e;this.flowIf&&this.flowIf.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowThen&&this.flowThen.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowElse&&this.flowElse.forEach(function(a){a&&a.setTrace&&a.setTrace(e)})};c.Condition=b;var d=function(){b.call(this);this.type=c.Root.TYPE;this._lastTiggerTime=this._taskID=null;this.singleton=!1;this.singletonMethod="ignore";this._task=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Root")};
util.inherits(d,b);d.TYPE="root";d.prototype.init=function(e){this._taskID=e;this.flowIf.forEach(function(a){a&&a.init&&a.init(e)})};d.prototype.finalize=function(e){this.flowIf.forEach(function(a){a&&a.finalize&&a.finalize(e)})};d.prototype.getTriggers=function(){return this.flowIf?this.flowIf:[]};d.prototype._onTriggered=function(e,a){var b=(new Date).getTime();if(!(this._lastTiggerTime&&400>b-this._lastTiggerTime)){if(this.singleton&&this._running){if("ignore"==this.singletonMethod){this._logger.log("debug",
"task "+this._taskID+" is running and ignore the new trigger");e&&e();return}this._logger.log("debug","task "+this._taskID+" is running and cancel it");this.cancel()}this._logger.log("info","task "+this._taskID+" triggered");this._logger.log("trace","task "+this._taskID+" is "+(this._running?"running":"not running"));this._lastTiggerTime=b;this._trace&&this._trace.log("root | task:"+this._taskID+" triggered");this._running=!0;var d=this;this._doThenBlocks(function(){d._running=!1;e&&e()},{trigger:a,
task:this._task})}};d.prototype.onStatusEvt=function(e){var a=!1;this._logger.log("trace","check trigger for status event");for(var b=null,d=0;d<this.flowIf.length;d++){var g=this.flowIf[d];if((g.type==m.TYPE||g.type==t.TYPE)&&g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};d.prototype.onDedicatedStatusEvt=function(e){var a=!1;this._logger.log("trace","check trigger for status event");for(var b=null,d=0;d<this.flowIf.length;d++){var g=
this.flowIf[d];if(g.type==m.TYPE){if(g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}else if(g.type==t.TYPE&&g.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(g.toJSON()));a=!0;b=g;break}}a&&this._onTriggered(null,b)};d.prototype.onIREvt=function(e){this._trace&&this._trace.log("root | receive ir event:"+JSON.stringify(e));var a=!1;this._logger.log("trace","check trigger for ir event");for(var b=0;b<this.flowIf.length;b++){var d=
this.flowIf[b];if(d.type==p.TYPE&&d.isMatch(e)){this._logger.log("debug","trigger hit:"+JSON.stringify(d.toJSON()));a=!0;break}}a&&this._onTriggered()};d.prototype.onTimerTick=function(e){this._trace&&this._trace.log("root | timer tick:"+e);this._onTriggered()};d.prototype.onHttpEvt=function(e,a){this._trace&&this._trace.log("root | receive http event:"+JSON.stringify(e));for(var b=!1,d=0;d<this.flowIf.length;d++){var g=this.flowIf[d];if(g.type==h.TYPE&&g.isMatch(e)){this._logger.log("info","trigger hit:"+
JSON.stringify(g.toJSON()));b=!0;break}}b&&this._onTriggered();a&&a(null,b)};d.prototype.setTrace=function(e){this._trace=e;this.flowIf&&this.flowIf.forEach(function(a){a&&a.setTrace&&a.setTrace(e)});this.flowThen&&this.flowThen.forEach(function(a){a&&a.setTrace&&a.setTrace(e)})};d.prototype.hasCloudTrigger=function(){if(!this.flowIf||0==this.flowIf.length)return!1;for(var e=0;e<this.flowIf.length;e++)if(this.flowIf[e]instanceof r)return!0;return!1};d.prototype.toCloudRuleFormat=function(){if(!this.flowIf||
0==this.flowIf.length)return[];for(var e=[],a=0;a<this.flowIf.length;a++){var b=this.flowIf[a];b instanceof r&&(b=b.toCloudRuleFormat())&&e.push(b)}return e};c.Root=d;var f=function(e){c.call(this);this.type=f.TYPE;e&&(this.op=e.op)};util.inherits(f,c);f.TYPE="logic.operator";f.prototype.do=function(e){e&&e(null,this.op)};f.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.op=this.op;return e};f.prototype.fromJSON=function(e){e&&(this.op=e.op)};c.LogicOP=f;var k=function(){c.call(this);
this.type=k.TYPE;this.children=[]};util.inherits(k,c);k.TYPE="bracket";k.prototype.do=function(e){var a=[],b=0,d=this;if(this.children&&0!==this.children.length){var g=function(c,n){b++;c?a.push(!1):a.push(n);if(b<d.children.length)d.children[b].do(g);else if(0===a.length)e&&e(null,!0);else{c=1;for(n=a[0];c<a.length&&c+1!=a.length;)"AND"==a[c]?n&=a[c+1]:"OR"==a[c]?n|=a[c+1]:"XOR"==a[c]&&(n=n!=a[c+1]),c+=2;e&&e(null,n)}};this.children[b].do(g)}else e&&e(null,!0)};k.prototype.toJSON=function(){var e=
c.prototype.toJSON.call(this);e.children=[];this.children&&this.children.forEach(function(a){a&&e.children.push(a.toJSON())});return e};k.prototype.fromJSON=function(e){if(e){var a=this;e.children&&0<e.children.length&&e.children.forEach(function(e){e&&(e=c.parse(e))&&a.children.push(e)})}};c.Bracket=k;var h=function(){c.call(this);this.type=h.TYPE;this.params=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpTrigger")};util.inherits(h,c);h.TYPE="http.trigger";h.prototype.isMatch=
function(e){if(!e||!this.params)return!1;for(var a in this.params)if(a&&this.params[a]!=e[a]&&this.params[a]!=e[encodeURIComponent(a)])return!1;this._logger.log("trace","trigger hit:"+JSON.stringify(this.toJSON()));return!0};h.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.params=this.params;return e};h.prototype.fromJSON=function(e){e&&(this.params=e.params)};c.HttpTrigger=h;var a=function(){c.call(this);this.type=a.TYPE;this.op=this.end=this.start=this.week=this.time=null;this._logger=
require("x.logger.js").getLogger("x.hub.taskman._Block.Timer")};util.inherits(a,c);a.TYPE="timer";a.prototype.init=function(e){x.hub.taskman._TimerManager.startTimer(e,this)};a.prototype.do=function(e){this._trace&&this._trace.log("check time | "+this._getDescription());var a=require("moment-timezone"),b=x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=a.tz(d,b);var g=d.year(),c=!1,f=!1,l=null,p=null,k=d.valueOf(),h=this.start;h&&("00"==h.substr(0,2)&&(c=!0,h=g+h.substr(2)),h=a.tz(h,b),
h.set({hour:0,minute:0,second:0,millisecond:0}),l=h.valueOf());var m=this.end;m&&("00"==m.substr(0,2)&&(f=!0,m=g+m.substr(2)),m=a.tz(m,b),m.set({hour:23,minute:59,second:59,millisecond:999}),p=m.valueOf());if(c&&f&&l>p){if(p<k&&l>k){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if(h&&l>k||m&&p<k){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}if(a=this.week)if(b=d.day(),0==b&&(b=7),"1"!=
a.charAt(b-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}if(this.time&&this.op)if(b=this.time.indexOf(":"),a=this.time.substr(0,b),b=this.time.substr(b+1),a=parseInt(a),b=parseInt(b),g=d.hour(),d=d.minute(),">="==this.op){if(g<a||g==a&&d<b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if(">"==this.op){if(g<a||g==a&&d<=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
e&&e(null,!1);return}}else if("<="==this.op){if(g>a||g==a&&d>b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if("<"==this.op){if(g>a||g==a&&d>=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}}else if("="==this.op||"=="==this.op)if(g!=a||g==a&&d!=b){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}this._logger.log("trace","condition match:"+
JSON.stringify(this.toJSON()));e&&e(null,!0)};a.prototype.finalize=function(e){x.hub.taskman._TimerManager.stopTimer(e)};a.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.time=this.time;e.week=this.week;e.start=this.start;e.end=this.end;e.op=this.op;return e};a.prototype.fromJSON=function(e){e&&(this.time=e.time,this.week=e.week,this.start=e.start,this.end=e.end,this.op=e.op)};a.prototype._getDescription=function(){var e="time:"+this.time;e+=" week:"+this.week;e+=" start:"+this.start;
e+=" end:"+this.end;return e+=" op:"+this.op};c.Timer=a;var g=function(){c.call(this);this.type=g.TYPE;this.op=this.end=this.start=this.week=this.delay=this.offTime=this.astro=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Astro")};util.inherits(g,c);g.TYPE="astro";g.prototype.init=function(e){x.hub.taskman._AstroManager.startTimer(e,this)};g.prototype.do=function(e){this._trace&&this._trace.log("check astro | "+this._getDescription());var a=require("moment-timezone"),b=
x.hub.taskman._Util._getTimeZone(),d=(new Date).getTime();d=a.tz(d,b);var g=d.year(),c=!1,f=!1,l=null,p=null,k=d.valueOf(),h=this.start;h&&("00"==h.substr(0,2)&&(c=!0,h=g+h.substr(2)),h=a.tz(h,b),h.set({hour:0,minute:0,second:0,millisecond:0}),l=h.valueOf());var m=this.end;m&&("00"==m.substr(0,2)&&(f=!0,m=g+m.substr(2)),m=a.tz(m,b),m.set({hour:23,minute:59,second:59,millisecond:999}),p=m.valueOf());if(c&&f&&l>p){if(p<k&&l>k){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));
e&&e(null,!1);return}}else if(h&&l>k||m&&p<k){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}if(a=this.week)if(b=d.day(),0==b&&(b=7),"1"!=a.charAt(b-1)){this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON()));e&&e(null,!1);return}a=!1;this.astro&&this.op&&(b=x.hub.taskman._AstroManager.getSunriseSunset(d.toDate()),b="sunrise"==this.astro?b.sunrise.getTime():b.sunset.getTime(),this.delay&&(b+=6E4*parseInt(this.delay)),">="==
this.op&&d.valueOf()>=b?a=!0:">"==this.op&&d.valueOf()>b?a=!0:"<="==this.op&&d.valueOf()<=b?a=!0:"<"==this.op&&d.valueOf()<b?a=!0:("="==this.op||"=="==this.op)&&d.valueOf()==b&&(a=!0));this._logger.log("trace","condition "+(a?"match":"mismatch")+":"+JSON.stringify(this.toJSON()));e&&e(null,a)};g.prototype.finalize=function(e){x.hub.taskman._AstroManager.stopTimer(e)};g.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.astro=this.astro;e.offTime=this.offTime;e.delay=this.delay;e.week=
this.week;e.start=this.start;e.end=this.end;e.op=this.op;return e};g.prototype.fromJSON=function(e){e&&(this.astro=e.astro,this.offTime=e.offTime,this.delay=e.delay,this.week=e.week,this.start=e.start,this.end=e.end,this.op=e.op)};g.prototype._getDescription=function(){var e="astro:"+this.astro;e+=" offTime:"+this.offTime;e+=" delay:"+this.delay;e+=" week:"+this.week;e+=" start:"+this.start;e+=" end:"+this.end;return e+=" op:"+this.op};c.Astro=g;var l=function(){c.call(this);this.type=l.TYPE;this.end=
this.start=this.week=this.endTime=this.startTime=this.interval=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Periodic")};util.inherits(l,c);l.TYPE="periodic";l.prototype.init=function(e){x.hub.taskman._PeriodicTimerManager.startTimer(e,this)};l.prototype.finalize=function(e){x.hub.taskman._PeriodicTimerManager.stopTimer(e)};l.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.interval=this.interval;e.startTime=this.startTime;e.endTime=this.endTime;e.week=
this.week;e.start=this.start;e.end=this.end;return e};l.prototype.fromJSON=function(e){e&&(this.interval=e.interval,this.startTime=e.startTime,this.endTime=e.endTime,this.week=e.week,this.start=e.start,this.end=e.end)};c.Periodic=l;var p=function(){c.call(this);this.type=p.TYPE;this._lastTiggerTime=this.ir=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IRTrigger")};util.inherits(p,c);p.TYPE="ir";p.prototype.isMatch=function(e){if(!(e&&e.code&&this.ir&&this.ir.code))return!1;
var a=this._getDataCode(this.ir.code);e=this._getDataCode(e.code);if(a==e){a=(new Date).getTime();if(!this._lastTiggerTime)return this._lastTiggerTime=a,!0;if(1E3>a-this._lastTiggerTime)return!1;this._lastTiggerTime=a;return!0}return!1};p.prototype.toJSON=function(){var e=c.prototype.toJSON.call(this);e.ir=this.ir;return e};p.prototype.fromJSON=function(e){e&&(this.ir=e.ir)};p.prototype._getDataCode=function(e){e=new Buffer(e,"hex");var a=e.readInt8(8);return e.slice(4*a+9).toString("hex")};c.IRTrigger=
p;var m=function(){c.call(this);this.type=m.TYPE;this._cancelCB=this._lastStatus=this._lastTiggerTime=this.hysteresis=this.value=this.op=this.status=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DeviceStatus");this._gatewayName=this._deviceName=null};util.inherits(m,c);m.TYPE="device.status";m.prototype.init=function(e){if((this.device||this.gateway)&&this.status){var a=null;this.gateway&&this.gateway.sys&&(a=this.gateway.sys);!a&&this.device&&this.device.sys&&
(a=this.device.sys);if(a&&("hm"!=a||this.gateway?"neoserver"==a&&(a="aio"):a="aio",(a=require("x.hub.moduleman.js").modulemanager.getModule(a))&&a.addStateDevice)){var b={},d=this._getDevice(),g=this._getGateway();d&&(b=d);delete b.gateway;g&&(b.gateway=g);d=this.status;d.ref&&d.ref.value?d=d.ref.value:d.value&&(d=d.value);a.addStateDevice(b,null,{taskID:e,statusKey:d,src:"taskman",callback:this})}}};m.prototype.finalize=function(e){if(this.device||this.gateway){var a=null;this.gateway&&this.gateway.sys&&
(a=this.gateway.sys);!a&&this.device&&this.device.sys&&(a=this.device.sys);if(a&&("hm"!=a||this.gateway?"neoserver"==a&&(a="aio"):a="aio",(a=require("x.hub.moduleman.js").modulemanager.getModule(a))&&a.removeStateDevice)){var b={},d=this._getDevice(),g=this._getGateway();d&&(b=d);delete b.gateway;g&&(b.gateway=g);d=this.status;d.ref&&d.ref.value?d=d.ref.value:d.value&&(d=d.value);a.removeStateDevice(b,null,{taskID:e,statusKey:d,src:"taskman",callback:this})}}};m.prototype.do=function(a){if(this.device||
this.gateway)if(this.status&&this.op){var e=this.status;this.status.ref&&(e=this.status.ref);e.value&&(e=e.value);e={value:e};this.status&&this.status.value?e=this.status:this.status&&this.status.ref&&(e=this.status.ref);var b=this,d=this._getDevice(),g=this._getGateway();this._logger.log("trace","get states:"+JSON.stringify(this._toBluredJSON()));this._trace&&this._trace.log("get status | "+this._getDescription());this._running=!0;require("x.hub.commandman.js").commandHandler.getState(d,g,e,function(e){if(b._canceling){b._logger.log("trace",
"get states canceled:"+JSON.stringify(b._toBluredJSON()));b._canceling=!1;e=b._running;b._running=!1;var d=b._cancelCB;b._cancelCB=null;d&&d(null,e)}else if(b._running=!1,!e||e.error?b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:"+(e?e.error.message:"invalid response")):("undefined"==typeof e.data||null==e.data)&&b._trace&&b._trace.log("get status | "+b._getDescription()+" | error:no status"),!e||e.error)a&&a(e?e.error:Error("get state error"));else if("undefined"==typeof e.data||
null==e.data)a&&a(null,!1);else{d=e.data.value;var g=!1;"="==b.op||"=="==b.op?g="true"==b.value?"true"==String(d):"false"==b.value?"false"==String(d):d==b.value:"!="==b.op?g="true"==b.value?"true"!=String(d):"false"==b.value?"false"!=String(d):d!=b.value:">="==b.op?g=parseFloat(d)>=parseFloat(b.value):">"==b.op?g=parseFloat(d)>parseFloat(b.value):"<="==b.op?g=parseFloat(d)<=parseFloat(b.value):"<"==b.op&&(g=parseFloat(d)<parseFloat(b.value));b._logger.log("trace","condition "+(g?"match":"mismatch")+
":"+JSON.stringify(b.toJSON()));b._trace&&b._trace.log("get status | "+b._getDescription()+" | success:"+JSON.stringify(e.data)+" | match="+g);a&&a(null,g)}})}else a&&a(Error("no status point or operator"));else a&&a(Error("no device or gateway"))};m.prototype.cancel=function(e){this._running?(this._canceling=!0,this._cancelCB=e):e&&e(null,this._running)};m.prototype.isMatch=function(e){if(!e||!e.device)return!1;var a=e.device.sys;a&&"neoserver"!=a||(a="aio");a=require("x.hub.moduleman.js").modulemanager.getModule(a);
if(!a||!a.checkDeviceMatch)return!1;var b=this._getDevice(),d=this._getGateway();if(!a.checkDeviceMatch({device:b,gateway:d},e))return!1;a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);return a!=e.data.key?!1:this.isValueMatch(e)};m.prototype.isValueMatch=function(a){if(!a||!a.data)return!1;var e=(new Date).getTime(),b=!1,d=this._lastStatus,g=a.data.value;this._lastStatus=g;"="==this.op||"changeTo"==this.op?(b="true"==this.value?"true"==String(a.data.value):"false"==this.value?
"false"==String(a.data.value):this.value==a.data.value,"changeTo"==this.op&&g==d&&(b=!1)):">="==this.op?b=parseFloat(a.data.value)>=parseFloat(this.value):">"==this.op?b=parseFloat(a.data.value)>parseFloat(this.value):"<="==this.op?b=parseFloat(a.data.value)<=parseFloat(this.value):"<"==this.op?b=parseFloat(a.data.value)<parseFloat(this.value):"changed"==this.op?g!=d&&(b=!0):b=!1;d=this.value;"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&(d=this.hysteresis);g=!1;if(">"==this.op)g=parseFloat(a.data.value)<=
parseFloat(d);else if(">="==this.op)g=parseFloat(a.data.value)<parseFloat(d);else if("<"==this.op)g=parseFloat(a.data.value)>=parseFloat(d);else if("<="==this.op)g=parseFloat(a.data.value)>parseFloat(d);else if("="==this.op||"=="==this.op)g=a.data.value!=d;g&&(this._lastTiggerTime=null);this._trace&&(this._trace.log("trigger | "+this._getDescription()),this._trace.log("receive event | "+JSON.stringify(a.data)+" | hysteresis="+this.hysteresis+" | hit="+b));if(b){if(!this._lastTiggerTime)return this._lastTiggerTime=
e,!0;if(1E3>e-this._lastTiggerTime||"undefined"!=typeof this.hysteresis&&null!=this.hysteresis&&this._lastTiggerTime||(a=this._getDevice())&&"aio"==a.sys&&"ENOCEAN"==a.type&&("bb-aa-cc"==a.data||"d2-06-10"==a.data)&&this._lastTiggerTime)return!1;this._lastTiggerTime=e;return!0}return!1};m.prototype.onEvent=function(a){try{this.isValueMatch(a)&&this._parent&&this._parent._onTriggered&&this._parent._onTriggered(null,this)}catch(n){}};m.prototype.toJSON=function(){var a=c.prototype.toJSON.call(this);
a.device=this.device;a.gateway=this.gateway;a.status=this.status;a.op=this.op;a.value=this.value;a.hysteresis=this.hysteresis;return a};m.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.status=a.status,this.op=a.op,this.value=a.value,this.hysteresis=a.hysteresis)};m.prototype._toBluredJSON=function(){try{var a=JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username="xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&
(a.gateway.username&&(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(n){return this.toJSON()}};m.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};m.prototype._getGateway=
function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};m.prototype._getDescription=function(){var a=null,b=null;if(this._deviceName||this._gatewayName)a=
this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{b=JSON.parse(JSON.stringify(this.device)),b.username&&(b.username="xxxxxx"),b.password&&(b.password="xxxxxx"),a=JSON.stringify(b)}catch(J){a=JSON.stringify(this.device)}else if(this.gateway)try{b=JSON.parse(JSON.stringify(this.gateway)),b.username&&(b.username="xxxxxx"),b.password&&(b.password="xxxxxx"),a=JSON.stringify(b)}catch(J){a=JSON.stringify(this.gateway)}b=this.status;this.status.ref&&(b=this.status.ref);b.value&&
(b=b.value);return a+" | "+b+" "+this.op+" "+this.value};c.DeviceStatus=m;var r=function(){m.call(this);this.type=r.TYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudDeviceTrigger");this._cloudRuleID=null};util.inherits(r,m);r.TYPE="cloud.trigger.device";r.prototype.init=function(a){};r.prototype.finalize=function(a){};r.prototype.toCloudTriggerFormat=function(){var a=this.status;a.ref&&a.ref.value?a=a.ref.value:a.value&&(a=a.value);a={event:{sys:this.device.module,data:{connection:this.device.connection,
id:this.device.id,state:a},comp:{value:this.value,operator:this.op}}};if("undefined"!=typeof this.hysteresis&&null!=this.hysteresis)if("="==this.op||"=="==this.op)a.event.comp.hyst=.1;else if(">="==this.op||">"==this.op)a.event.comp.hyst=parseFloat(this.value)-parseFloat(this.hysteresis);else if("<="==this.op||"<"==this.op)a.event.comp.hyst=parseFloat(this.hysteresis)-parseFloat(this.value);return a};c.CloudDeviceTrigger=r;var t=function(){c.call(this);this.type=t.TYPE;this.gateway=this.device=null;
this.upperThreshold={type:null,op:null,value:null,delay:null,repeat:null};this.lowerThreshold={type:null,op:null,value:null,delay:null,repeat:null};this._upper_threshold_state=0;this._upper_threshold_repeat_to=this._upper_threshold_deley_to=null;this._lower_threshold_state=0;this._lower_threshold_repeat_to=this._lower_threshold_deley_to=null;this._lastTigger={upperThreshold:!1,lowerThreshold:!1};this._upperMatchCount=0;this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DominoswissWS");
this._lastHit=null};util.inherits(t,m);t.TYPE="device.dominoswiss.weatherstation";t.prototype.init=function(a){if(this.device||this.gateway){var b=null;this.gateway&&this.gateway.sys&&(b=this.gateway.sys);!b&&this.device&&this.device.sys&&(b=this.device.sys);if(b&&(b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.addStateDevice){var e={},d=this._getDevice(),g=this._getGateway();d&&(e=d);delete e.gateway;g&&(e.gateway=g);b.addStateDevice(e,null,{taskID:a,statusKey:"*",src:"taskman"})}}};
t.prototype.finalize=function(a){if(this.device||this.gateway){var b=null;this.gateway&&this.gateway.sys&&(b=this.gateway.sys);!b&&this.device&&this.device.sys&&(b=this.device.sys);if(b&&(b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.removeStateDevice){var e={},d=this._getDevice(),g=this._getGateway();d&&(e=d);delete e.gateway;g&&(e.gateway=g);b.removeStateDevice(e,null,{taskID:a,statusKey:"*",src:"taskman"})}}};t.prototype.isMatch=function(a){if(!a||!a.device||!a.device.sys)return!1;
var b=require("x.hub.moduleman.js").modulemanager.getModule(a.device.sys);if(!b||!b.checkDeviceMatch)return!1;var e=this._getDevice(),d=this._getGateway();if(!b.checkDeviceMatch({device:e,gateway:d},a))return!1;this._logger.log("trace","receive event for device:"+JSON.stringify(a));e=b=!1;d=this._matchUpperThreshold(a);a=this._matchLowerThreshold(a);this._logger.log("trace","upperMatch:"+d+" - lowerMatch:"+a);if("upper"==this._lastHit&&!a)return this._logger.log("trace","lastHit:upper - lowerMatch:"+
a),!1;if("lower"==this._lastHit&&!d)return this._logger.log("trace","lastHit:lower - upperMatch:"+d),!1;"upper"==this._lastHit&&a&&(this._lastHit=null);"lower"==this._lastHit&&d&&(this._lastHit=null);1==d&&(this._upperMatchCount+=1,65535<this._upperMatchCount&&(this._upperMatchCount=1));switch(this._upper_threshold_state){case 0:1==d&&("undefined"!=typeof this.upperThreshold.delay&&null!=this.upperThreshold.delay&&0<parseInt(this.upperThreshold.delay)?this._handleUpperThresholdDelay():(b=!0,this.upperThreshold.repeat&&
this._handleUpperThresholdRepeat()));break;case 1:0==d&&(this._logger.log("trace","upper threshold not match, clear delay timeout"),this._upper_threshold_deley_to&&(clearTimeout(this._upper_threshold_deley_to),this._upper_threshold_deley_to=null),this._upper_threshold_state=0);break;case 2:0==d&&(this._logger.log("trace","upper threshold not match, clear repeat timeout"),this._upper_threshold_repeat_to&&(clearTimeout(this._upper_threshold_repeat_to),this._upper_threshold_repeat_to=null),this._upper_threshold_state=
0)}switch(this._lower_threshold_state){case 0:1==a&&0<this._upperMatchCount&&("undefined"!=typeof this.lowerThreshold.delay&&null!=this.lowerThreshold.delay&&0<parseInt(this.lowerThreshold.delay)?this._handleLowerThresholdDelay():(e=!0,this._upperMatchCount=0,this.lowerThreshold.repeat&&this._handleLowerThresholdRepeat()));break;case 1:0==a&&(this._logger.log("trace","lower threshold not match, clear delay timeout"),this._lower_threshold_deley_to&&(clearTimeout(this._lower_threshold_deley_to),this._lower_threshold_deley_to=
null),this._lower_threshold_state=0);break;case 2:0==a&&(this._logger.log("trace","lower threshold not match, clear repeat timeout"),this._lower_threshold_repeat_to&&(clearTimeout(this._lower_threshold_repeat_to),this._lower_threshold_repeat_to=null),this._lower_threshold_state=0)}this._lastTigger={upperThreshold:b,lowerThreshold:e};this._logger.log("trace","upperHit:"+b+" - lowerHit:"+e);b?this._lastHit="upper":e&&(this._lastHit="lower");return b|e};t.prototype._matchUpperThreshold=function(a){if(!(this.upperThreshold&&
this.upperThreshold.type&&a&&a.data&&a.data.key&&this.upperThreshold.type==a.data.key))return null;var b=this.upperThreshold.op;b||(b=">=");var e=this.upperThreshold.value;if("undefined"==typeof e||null==e)e=0;return this._matchThreshold(b,e,a.data.value)};t.prototype._matchLowerThreshold=function(a){if(!(this.lowerThreshold&&this.lowerThreshold.type&&a&&a.data&&a.data.key&&this.lowerThreshold.type==a.data.key))return null;var b=this.lowerThreshold.op;b||(b=">=");var e=this.lowerThreshold.value;if("undefined"==
typeof e||null==e)e=0;return this._matchThreshold(b,e,a.data.value)};t.prototype._matchThreshold=function(a,b,d){return"="==a||"=="==a?"true"==b?"true"==String(d):"false"==b?"false"==String(d):b==d:">="==a?parseFloat(d)>=parseFloat(b):">"==a?parseFloat(d)>parseFloat(b):"<="==a?parseFloat(d)<=parseFloat(b):"<"==a?parseFloat(d)<parseFloat(b):!1};t.prototype._handleUpperThresholdDelay=function(){var a=this;this._upper_threshold_state=1;this._logger.log("trace","start upper threshold hit delay timeout:"+
parseInt(this.upperThreshold.delay));this._upper_threshold_deley_to=setTimeout(function(){a._logger.log("trace","upper threshold delay timeout expired");a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,a)}catch(n){}a.upperThreshold.repeat?a._handleUpperThresholdRepeat():a._upper_threshold_state=0},1E3*parseInt(this.upperThreshold.delay))};t.prototype._handleLowerThresholdDelay=function(){var a=this;this._lower_threshold_state=
1;this._logger.log("trace","start lower threshold hit delay timeout:"+parseInt(this.lowerThreshold.delay));this._lower_threshold_delay_to=setTimeout(function(){a._lastTigger={upperThreshold:!1,lowerThreshold:!0};a._upperMatchCount=0;a._logger.log("trace","lower threshold delay timeout expired");if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",a._parent._onTriggered(null,a)}catch(n){}a.lowerThreshold.repeat?a._handleLowerThresholdRepeat():a._lower_threshold_state=0},1E3*parseInt(this.lowerThreshold.delay))};
t.prototype._handleUpperThresholdRepeat=function(){var a=this;this._upper_threshold_state=2;var b=this.upperThreshold.repeat,d=0;if(b&&"string"==typeof b&&b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){d=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=d.tz(c,g);var f=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=d.tz(l,g);l.set({hour:f,minute:b,second:0,millisecond:0});d=l.valueOf()-c.valueOf();
if(0>d){this._upper_threshold_state=0;return}}else if(0<parseInt(b))d=1E3*parseInt(b);else{this._upper_threshold_state=0;return}this._logger.log("trace","start upper threshold hit repeat timeout:"+Math.round(d/1E3));this._upper_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","upper threshold repeat timeout expired");a._upper_threshold_state=0;a._lastTigger={upperThreshold:!0,lowerThreshold:!1};if(a._parent&&"root"==a._parent.type)try{a._lastHit="upper",a._parent._onTriggered(null,
a)}catch(N){}},d)};t.prototype._handleLowerThresholdRepeat=function(){var a=this;this._lower_threshold_state=2;var b=this.lowerThreshold.repeat,d=0;if(b&&"string"==typeof b&&b.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){d=require("moment-timezone");var g=x.hub.taskman._Util._getTimeZone(),c=(new Date).getTime();c=d.tz(c,g);var f=parseInt(b.substr(0,b.indexOf(":")));b=parseInt(b.substr(b.indexOf(":")+1));var l=(new Date).getTime();l=d.tz(l,g);l.set({hour:f,minute:b,second:0,millisecond:0});d=l.valueOf()-
c.valueOf();if(0>d){this._lower_threshold_state=0;return}}else if(0<parseInt(b))d=1E3*parseInt(b);else{this._lower_threshold_state=0;return}this._logger.log("trace","start lower threshold hit repeat timeout:"+Math.round(d/1E3));this._lower_threshold_repeat_to=setTimeout(function(){a._logger.log("trace","lower threshold repeat timeout expired");a._upperMatchCount=0;a._lower_threshold_state=0;a._lastTigger={upperThreshold:!1,lowerThreshold:!0};if(a._parent&&"root"==a._parent.type)try{a._lastHit="lower",
a._parent._onTriggered(null,a)}catch(N){}},d)};t.prototype.toJSON=function(){var a=c.prototype.toJSON.call(this);a.device=this.device;a.gateway=this.gateway;a.upperThreshold=this.upperThreshold;a.lowerThreshold=this.lowerThreshold;return a};t.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.upperThreshold=a.upperThreshold,this.lowerThreshold=a.lowerThreshold)};c.DominoswissWS=t;var q=function(){c.call(this);this.type=q.TYPE};util.inherits(q,c);q.TYPE="action";c.Action=
q;var u=function(){q.call(this);this.subtype=u.SUBTYPE;this.body=this.event=this.key=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IFTTTMakerAction")};util.inherits(u,q);u.SUBTYPE="iftttmaker";u.prototype.do=function(a){if(this.key||this.event){var b=a;a={hostname:"maker.ifttt.com",port:443,path:"/trigger/"+this.event+"/with/key/"+this.key,method:"POST",headers:{"Content-Type":"application/json"}};this._logger.log("trace","send https:"+JSON.stringify(a));this._logger.log("trace",
"with data:"+JSON.stringify(this.body));var e=this;a=require("https").request(a,function(a){a.setEncoding("utf8");var d="";a.on("data",function(a){d+=a});a.on("end",function(){e._logger.log("trace","action response:"+a.statusCode);e._logger.log("trace","with data:"+d);b&&(b(null,a.statusCode,d),b=null)})});a.on("error",function(a){e._logger.log("debug","do action err:"+a.stack);b&&(b(a),b=null)});a.setTimeout(5E3,function(){e._logger.log("debug","do action timeout");b&&(b(Error("timeout")),b=null)});
if(this.body)try{var d=JSON.stringify(this.body);a.write(d)}catch(P){}a.end()}else a&&a(Error("no key or event"))};u.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.key=this.key;a.event=this.event;a.body=this.body;return a};u.prototype.fromJSON=function(a){a&&(this.key=a.key,this.event=a.event,this.body=a.body)};c.IFTTTMakerAction=u;var w=function(){q.call(this);this.subtype=w.SUBTYPE;this._cancelCB=this._doCB=this.body=this.headers=this.query=this.pathname=
this.port=this.hostname=this.auth=this.protocol=this.method=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpAction")};util.inherits(w,q);w.SUBTYPE="http.action";w.prototype.do=function(a){var b=this.method;b||(b="GET");var e=this.protocol;e||(e="http");var d=this.port;if(!d||0>=parseInt(d))d="https"==e?443:80;var g=require("querystring"),c=this.pathname?this.pathname:"/";this.query&&(c+="?"+g.stringify(this.query));d={hostname:this.hostname,port:d,path:c,method:b,headers:this.headers};
this.auth&&(d.auth=this.auth);this._logger.log("trace","send "+e+" "+b+":"+JSON.stringify(d));this._logger.log("trace","with data:"+JSON.stringify(this.body));this._trace&&(this._trace.log("execute http | "+e+" "+b+":"+JSON.stringify(d)),this._trace.log("execute http | with data:"+JSON.stringify(this.body)));this._running=!0;this._doCB=a;var f=this;a=require(e).request(d,function(a){a.setEncoding("utf8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){f._logger.log("trace","action response:"+
a.statusCode);f._logger.log("trace","with data:"+b);f._trace&&(f._trace.log("execute http | response code:"+a.statusCode),f._trace.log("execute http | response data:"+b));f._doCB&&(f._running=!1,f._doCB(null,a.statusCode,b),f._doCB=null)})});a.on("error",function(a){f._trace&&f._trace.log("execute http | error:"+a.message);f._logger.log("debug","do action err:"+a.stack);f._doCB&&(f._running=!1,f._doCB(a),f._doCB=null)});a.setTimeout(5E3,function(){f._trace&&f._trace.log("execute http | error:timeout");
f._logger.log("debug","do action timeout");f._doCB&&(f._running=!1,f._doCB(Error("timeout")),f._doCB=null)});if(this.body&&"GET"!=b&&"DELETE"!=b)if("string"==typeof this.body)a.write(this.body);else try{var l=JSON.stringify(this.body);a.write(l)}catch(Q){}a.end()};w.prototype.cancel=function(a){this._running?(this._logger.log("trace","http action canceled"),this._doCB=null,this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};w.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=
this.subtype;a.method=this.method;a.protocol=this.protocol;a.auth=this.auth;a.hostname=this.hostname;a.port=this.port;a.pathname=this.pathname;a.query=this.query;a.headers=this.headers;a.body=this.body;return a};w.prototype.fromJSON=function(a){a&&(this.subtype=a.subtype,this.method=a.method,this.protocol=a.protocol,this.auth=a.auth,this.hostname=a.hostname,this.port=a.port,this.pathname=a.pathname,this.query=a.query,this.headers=a.headers,this.body=a.body)};c.HttpAction=w;var v=function(){q.call(this);
this.subtype=v.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CommandAction");this._gatewayName=this._deviceName=null};util.inherits(v,q);v.SUBTYPE="command";v.prototype.do=function(a,b){if(this.device||this.gateway)if(this.command){b=this.command;b.ref&&(b=b.ref);var e=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do command:"+JSON.stringify(this._toBluredJSON()));var d=this._getDevice(),
g=this._getGateway();if(d&&"sonos"==d.sys&&b&&"playAlarm"==b.value&&(b=this._buildSonosCommand(b.ext),!b))return;this._running=!0;this._trace&&this._trace.log("execute command | "+this._getDescription());var c=this;e.executeCommand(d,g,b,function(b){b&&b.error?c._trace&&c._trace.log("execute command | "+c._getDescription()+" | error:"+b.error.message):c._trace&&c._trace.log("execute command | "+c._getDescription()+" | success");if(c._canceling){c._logger.log("trace","command action canceled:"+JSON.stringify(c._toBluredJSON()));
c._canceling=!1;b=c._running;c._running=!1;var e=c._cancelCB;c._cancelCB=null;e&&e(null,b)}else c._running=!1,a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};v.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};v.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};v.prototype.fromJSON=function(a){a&&
(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};v.prototype._toBluredJSON=function(){try{var a=JSON.parse(JSON.stringify(this.toJSON()));a.device&&(a.device.username&&(a.device.username="xxxxxx"),a.device.password&&(a.device.password="xxxxxx"));a.gateway&&(a.gateway.username&&(a.gateway.username="xxxxxx"),a.gateway.password&&(a.gateway.password="xxxxxx"));return a}catch(n){return this.toJSON()}};v.prototype._getDevice=function(){if(!this.device)return null;var a=null;if(this.device.__neoIndex&&
deviceman.deviceManager)try{var b=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);b&&b.info&&(this._deviceName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||(a=JSON.parse(JSON.stringify(this.device)));return a};v.prototype._getGateway=function(){if(!this.gateway)return null;var a=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var b=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);b&&b.info&&(this._gatewayName=b.name,a=JSON.parse(JSON.stringify(b.info)))}catch(J){}a||
(a=JSON.parse(JSON.stringify(this.gateway)));a&&this.gateway.__neoIndex&&(a.__neoInfo={db:1,index:this.gateway.__neoIndex});return a};v.prototype._getDescription=function(){var a=null;if(this._deviceName||this._gatewayName)a=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{tmp=JSON.parse(JSON.stringify(this.device)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(J){a=JSON.stringify(this.device)}else if(this.gateway)try{tmp=
JSON.parse(JSON.stringify(this.gateway)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),a=JSON.stringify(tmp)}catch(J){a=JSON.stringify(this.gateway)}var b=this.command;b.ref&&(b=b.ref);return a+" | "+JSON.stringify(b)};v.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var d=a[b],g=0;g<d.length;g++){var c=d[g];if(c&&"IPv4"==c.family&&0==c.internal)return c.address}return null};v.prototype._getLocalPort=function(){var a=require("x.hub.js");
return a.server?a.server._port:null};v.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),d=this._getLocalPort();if(!b||!d)return null;switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+d+"/resources/rehau_alarm/"+a}};c.CommandAction=v;var K=function(){q.call(this);this.subtype=K.SUBTYPE;this._cancelCB=this.command=
this.gateway=this.device=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagUpperThresholdAction")};util.inherits(K,v);K.SUBTYPE="command.dominoswiss.upperthreshold";K.prototype.do=function(a,b){if(b&&b.trigger&&b.trigger.type==t.TYPE){var d=b.trigger._lastTigger;d&&d.upperThreshold?v.prototype.do.call(this,a,b):a&&a()}else a&&a()};c.BrelagUpperThresholdAction=K;var L=function(){q.call(this);this.subtype=L.SUBTYPE;this._cancelCB=this.command=this.gateway=this.device=null;
this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagLowerThresholdAction")};util.inherits(L,v);L.SUBTYPE="command.dominoswiss.lowerthreshold";L.prototype.do=function(a,b){if(b&&b.trigger&&b.trigger.type==t.TYPE){var d=b.trigger._lastTigger;d&&d.lowerThreshold?v.prototype.do.call(this,a,b):a&&a()}else a&&a()};c.BrelagUpperThresholdAction=L;var E=function(){q.call(this);this.subtype=E.SUBTYPE;this.actionID=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudAction")};
util.inherits(E,q);E.SUBTYPE="cloud_action";E.prototype.do=function(a){if(this.actionID){this._logger.log("trace","do cloud action:"+this.actionID);var b=require("x.hub.js").server;if(b)if(b=b._cloudConnect){var d=JSON.stringify({type:"ACTION",data:this.actionID});d=new Buffer("EVT:"+d,"utf8");b.sendMessageActive("0103"+d.toString("hex"),function(b){a&&a(b)})}else a&&a(Error("no cloud connect"));else a&&a(Error("no server in hub"))}else a&&a(Error("action id is empty"))};E.prototype.cancel=function(a){a&&
a(null,!1)};E.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.actionID=this.actionID;return a};E.prototype.fromJSON=function(a){a&&(this.actionID=a.actionID)};var y=function(){q.call(this);this.subtype=y.SUBTYPE;this.macroName=this.groupName=null;this._canceling=!1;this._macroExecutorID=this._cancelCB=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.MacroAction")};util.inherits(y,q);y.SUBTYPE="macro";y.prototype.do=function(a){if(this.groupName&&
this.macroName){var b=require("x.hub.macroman.js");this._logger.log("trace","do macro:"+JSON.stringify(this.toJSON()));var d=this;this._running=!0;this._trace&&this._trace.log("execute macro | "+this._getDescription());b.execute(this.groupName,this.macroName,function(b){d._trace&&d._trace.log("execute macro | "+d._getDescription()+" | return:"+JSON.stringify(b));d._canceling?(d._logger.log("trace","macro action canceled:"+JSON.stringify(d.toJSON())),d._canceling=!1,d._running=!1,b=d._cancelCB,d._cancelCB=
null,b&&b()):(d._running=!1,a&&a(b))},function(a){a&&a.id&&(d._macroExecutorID=a.id)})}else a&&a(Error("no group or macro"))};y.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a,this._macroExecutorID&&require("x.hub.macroman.js").cancel(this._macroExecutorID)):a&&a(null,this._running)};y.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.groupName=this.groupName;a.macroName=this.macroName;return a};y.prototype.fromJSON=function(a){a&&
(this.groupName=a.groupName,this.macroName=a.macroName)};y.prototype._getDescription=function(){return this.groupName+"."+this.macroName};c.MacroAction=y;var C=function(){q.call(this);this._cancelCB=this.token=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.SnsAction")};util.inherits(C,q);C.prototype.do=function(a){if(this.token){var b=this;this._logger.log("trace","do sns:"+JSON.stringify(this.toJSON()));var d=new x.hub.taskman.Cloud;this._running=!0;this._trace&&this._trace.log("execute sns | "+
this._getDescription());d._doRequest("GET","/xhub/sns/dosns?token="+this.token,null,null,null,null,function(d,e){b._trace&&b._trace.log("execute sns | "+b._getDescription()+" | "+(d?"error:"+d.message:"response:"+e));b._canceling?(b._logger.log("trace","sns action canceled:"+JSON.stringify(b.toJSON())),b._canceling=!1,d=b._running,b._running=!1,e=b._cancelCB,b._cancelCB=null,e&&e(null,d)):(b._running=!1,d&&b._logger.log("warn","do sns error:"+d.stack),a&&a(d))})}else a&&a(Error("token is empty"))};
C.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};C.prototype._getDescription=function(){return this.subtype+"."+this.token};var G=function(){C.call(this);this.subtype=G.SUBTYPE;this.token=null};util.inherits(G,C);G.SUBTYPE="EMAIL";G.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};G.prototype.fromJSON=function(a){a&&(this.token=a.token)};c.EmailAction=G;var H=function(){C.call(this);
this.subtype=H.SUBTYPE;this.token=null};util.inherits(H,C);H.SUBTYPE="PUSH";H.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};H.prototype.fromJSON=function(a){a&&(this.token=a.token)};c.PushAction=H;var I=function(){C.call(this);this.subtype=I.SUBTYPE;this.token=null};util.inherits(I,C);I.SUBTYPE="SMS";I.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.token=this.token;return a};I.prototype.fromJSON=
function(a){a&&(this.token=a.token)};c.SmsAction=I;var O=function(a,b){this._runCallback=b;this._finishCallback=null;this._action=a;var d=this;this.runCallback=function(a){d._action.removeRunTask(d);d._runCallback&&d._runCallback(a)};this.finishCallback=function(){d._action.removeRunTask(d)}},z=function(){q.call(this);this.subtype=z.SUBTYPE;this.name=this.id=null;this._scriptRunTasks=[];this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ScriptAction")};util.inherits(z,q);z.SUBTYPE=
"script";z.prototype.do=function(a){if(this.id){var b=require("x.hub.scriptman.js").scriptManager;this._logger.log("trace","do script:"+JSON.stringify(this.toJSON()));this._running=!0;a=new O(this,a);this._scriptRunTasks.push(a);this._trace&&this._trace.log("execute skript | "+this.id);b.runScript(this.id,a.runCallback,a.finishCallback)}else a&&a(Error("no script id"))};z.prototype.cancel=function(a){if(this._running){var b=require("x.hub.scriptman.js").scriptManager;this._scriptRunTasks=[];this._running=
!1;this._logger.log("trace","script action canceled:"+JSON.stringify(this.toJSON()));b.stopScript(this.id,function(){a&&a(null,!0)})}else a&&a(null,this._running)};z.prototype.removeRunTask=function(a){a=this._scriptRunTasks.indexOf(a);-1!=a&&this._scriptRunTasks.splice(a,1);0==this._scriptRunTasks.length&&(this._running=!1)};z.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.id=this.id;a.name=this.name;return a};z.prototype.fromJSON=function(a){a&&(this.id=
a.id,this.name=a.name)};c.ScriptAction=z;var D=function(){q.call(this);this.subtype=D.SUBTYPE;this._to=this.value=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.WaitAction")};util.inherits(D,q);D.SUBTYPE="wait";D.prototype.do=function(a){if(this.value){this._running=!0;var b=this;this._trace&&this._trace.log("execute wait | wait "+this.value+" ms");this._to=setTimeout(function(){b._trace&&b._trace.log("execute wait | wait expired");b._running=!1;b._to=null;a&&a()},this.value)}else a&&
a()};D.prototype.cancel=function(a){this._running?(this._to&&(this._logger.log("trace","wait action canceled:"+JSON.stringify(this.toJSON())),clearTimeout(this._to),this._to=null),this._running=!1,a&&a(null,!0)):a&&a(null,this._running)};D.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.value=this.value;return a};D.prototype.fromJSON=function(a){a&&(this.value=a.value)};c.WaitAction=D;var A=function(){q.call(this);this.subtype=A.SUBTYPE;this.page=this.remote=
null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ChangePageAction");this._cancelCB=null};util.inherits(A,q);A.SUBTYPE="remote.changepage";A.prototype.do=function(a){this._trace&&this._trace.log("execute change page | "+this.remote+"."+this.page);this._running=!0;var b=[],d=require("os").networkInterfaces(),g;for(g in d)for(var e=d[g],c=0;c<e.length;c++){var f=e[c];"IPv4"==f.family&&0==f.internal&&b.push(f.address)}var l=this,p=0,k=function(){if(l._canceling){l._logger.log("trace",
"change page action canceled:"+JSON.stringify(l.toJSON()));l._canceling=!1;var d=l._running;l._running=!1;var g=l._cancelCB;l._cancelCB=null;g&&g(null,d)}else p++,p>=b.length?(l._running=!1,a&&a()):l._sendEvent(b[p],k)};this._sendEvent(b[p],k)};A.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};A.prototype._sendEvent=function(a,b){var d=require("dgram"),g=require("unorm"),c={func:"changePage",remote:g.nfc(this.remote),page:g.nfc(this.page),
time:Date.now()};c=new Buffer("{XC_EVT}"+JSON.stringify(c),"utf8");var e=d.createSocket({type:"udp4",reuseAddr:!0});e.bind(a,function(){e.setBroadcast(!0);e.send(c,0,c.length,1902,"255.255.255.255");e.send(c,0,c.length,1902,"255.255.255.255",function(a){e.close();b&&b(a)})})};A.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.page=this.page;return a};A.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.page=a.page)};c.ChangePageAction=
A;var B=function(){q.call(this);this.subtype=B.SUBTYPE;this.template=this.settings=this.action=this.popup=this.remote=null;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.PopupAction");this._cancelCB=null};util.inherits(B,q);B.SUBTYPE="remote.popup";B.prototype.do=function(a){this._trace&&this._trace.log("execute popup action | "+this.remote+"."+this.popup+"."+this.action);this._running=!0;var b=[],d=require("os").networkInterfaces(),g;for(g in d)for(var c=d[g],e=0;e<c.length;e++){var f=
c[e];"IPv4"==f.family&&0==f.internal&&b.push(f.address)}var l=this,p=0,k=function(){if(l._canceling){l._logger.log("trace","popup action canceled:"+JSON.stringify(l.toJSON()));l._canceling=!1;var d=l._running;l._running=!1;var g=l._cancelCB;l._cancelCB=null;g&&g(null,d)}else p++,p>=b.length?(l._running=!1,a&&a()):l._sendEvent(b[p],k)};this._sendEvent(b[p],k)};B.prototype.cancel=function(a){this._running?(this._canceling=!0,this._cancelCB=a):a&&a(null,this._running)};B.prototype._sendEvent=function(a,
b){var d=require("dgram"),g=require("unorm"),c={func:"popup",remote:g.nfc(this.remote),action:g.nfc(this.action),time:Date.now()};if(this.popup&&"open"===this.action&&(c.popup=g.nfc(this.popup),this.settings))try{c.settings=g.nfc(JSON.stringify(this.settings))}catch(M){self._logger.log("error",M.message)}c=new Buffer("{XC_EVT}"+JSON.stringify(c),"utf8");var e=d.createSocket({type:"udp4",reuseAddr:!0});e.bind(a,function(){e.setBroadcast(!0);e.send(c,0,c.length,1902,"255.255.255.255");e.send(c,0,c.length,
1902,"255.255.255.255",function(a){e.close();b&&b(a)})})};B.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.remote=this.remote;a.popup=this.popup;a.action=this.action;a.settings=this.settings;a.template=this.template;return a};B.prototype.fromJSON=function(a){a&&(this.remote=a.remote,this.popup=a.popup,this.action=a.action,this.settings=a.settings,this.template=a.template)};c.PopupAction=B;var F=function(){v.call(this);this.subtype=F.SUBTYPE;this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.AudioAction")};
util.inherits(F,v);F.SUBTYPE="audio";F.prototype.do=function(a){if(this.device||this.gateway)if(this.command){var b=this.command;b.ref&&(b=b.ref);this._logger.log("trace","do audio command:"+JSON.stringify(this._toBluredJSON()));var d=this._getDevice(),g=this._getGateway();this._running=!0;this._trace&&this._trace.log("execute audio command | "+this._getDescription());var c=this;require("x.hub.commandman.js").commandHandler.executeCommand(d,g,b,function(b){b&&b.error?c._trace&&c._trace.log("execute command | "+
c._getDescription()+" | error:"+b.error.message):c._trace&&c._trace.log("execute command | "+c._getDescription()+" | success");c._running=!1;a&&a()})}else a&&a(Error("no command"));else a&&a(Error("no device or gateway"))};F.prototype.toJSON=function(){var a=q.prototype.toJSON.call(this);a.subtype=this.subtype;a.device=this.device;a.gateway=this.gateway;a.command=this.command;return a};F.prototype.fromJSON=function(a){a&&(this.device=a.device,this.gateway=a.gateway,this.command=a.command)};c.AudioAction=
F;c.parse=function(e){if(!e||!e.type)return null;switch(e.type){case d.TYPE:var n=c.Root;break;case b.TYPE:n=b;break;case q.TYPE:switch(e.subtype){case v.SUBTYPE:n=v;break;case K.SUBTYPE:n=K;break;case L.SUBTYPE:n=L;break;case G.SUBTYPE:n=G;break;case H.SUBTYPE:n=H;break;case I.SUBTYPE:n=I;break;case z.SUBTYPE:n=z;break;case D.SUBTYPE:n=D;break;case y.SUBTYPE:n=y;break;case u.SUBTYPE:n=u;break;case w.SUBTYPE:n=w;break;case A.SUBTYPE:n=A;break;case E.SUBTYPE:n=E;break;case F.SUBTYPE:n=F;break;case B.SUBTYPE:n=
B;break;default:return null}break;case m.TYPE:n=m;break;case t.TYPE:n=t;break;case a.TYPE:n=a;break;case g.TYPE:n=g;break;case l.TYPE:n=l;break;case f.TYPE:n=f;break;case k.TYPE:n=k;break;case h.TYPE:n=h;break;case p.TYPE:n=p;break;case r.TYPE:n=r;break;default:return null}n=new n;n.fromJSON(e);return n};return c}();
x.hub.taskman.Task=function(){var c=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Task");this.root=this.name=this.id=null;this.active=!0;this.singleton=this.rehauAlarmTask=this.isAlarmTask=!1;this.singletonMethod="ignore";this._trace=null;b&&(this.id=b.id,this.name=b.name,this.active=b.active,this.isAlarmTask=b.isAlarmTask,this.rehauAlarmTask=b.rehauAlarmTask,this.singleton=b.singleton,this.singletonMethod=b.singletonMethod);if("undefined"==typeof this.active||null==this.active)this.active=
!0;if("undefined"==typeof this.isAlarmTask||null==this.isAlarmTask)this.isAlarmTask=!1;if("undefined"==typeof this.rehauAlarmTask||null==this.rehauAlarmTask)this.rehauAlarmTask=!1};c.prototype.init=function(){this.root&&this.root.init(this.id)};c.prototype.getTriggers=function(){return this.root?this.root.getTriggers():[]};c.prototype.finalize=function(){try{this.root&&this.root.finalize(this.id)}catch(b){this._logger.log("warn","finalize task "+this.id+" error:"+b.message)}};c.prototype.trigger=
function(b){this.root?(this.root._onTriggered(),b&&b()):b&&b(Error("no content"))};c.prototype.cancel=function(b){this.root?(this.root.cancel(),b&&b()):b&&b(Error("no content"))};c.prototype.isActive=function(){return this.active};c.prototype.setActive=function(b){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);this.active=b};c.prototype.toggleActive=function(){this.active=!this.active};c.prototype.setRehauAlarmTask=function(b){this.rehauAlarmTask=b};c.prototype.isRehauAlarmTask=
function(){return this.rehauAlarmTask};c.prototype.setAlarmTask=function(b){if("undefined"==typeof b||null==b)b=!1;"string"==typeof b&&(b="false"==b?!1:!0);this.isAlarmTask=b};c.prototype.isRunning=function(){return this.root?this.root.isRunning():!1};c.prototype.onStatusEvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onStatusEvt(b)};
c.prototype.onStatusEvtForTask=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive dedicated status");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onDedicatedStatusEvt(b)};c.prototype.onIREvt=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive ir event");if(this.active&&this.root&&(!this.isAlarmTask||
require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onIREvt(b)};c.prototype.onTimerTick=function(b){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive timer tick");if(this.active&&this.root&&(!this.isAlarmTask||require("x.hub.taskman.js").taskManager._alarmTask._active))this.root.onTimerTick(b)};c.prototype.onHttpEvt=function(b,d){this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+(this.root?!0:!1)+") receive http event");
if(this.active&&this.root)if(this.isAlarmTask&&!require("x.hub.taskman.js").taskManager._alarmTask._active)d&&d(null,!1);else this.root.onHttpEvt(b,d);else d&&d(null,!1)};c.prototype.toJSON=function(){var b={id:this.id,name:this.name,active:this.active,isAlarmTask:this.isAlarmTask,rehauAlarmTask:this.rehauAlarmTask,singleton:this.singleton,singletonMethod:this.singletonMethod,root:{}};this.root&&(b.root=this.root.toJSON());return b};c.prototype.startTaskTrace=function(b,d){this._trace||(this._trace=
new x.hub.taskman.TaskTrace(this),this.root&&this.root.setTrace(this._trace));this._trace.addListener(b);d&&d()};c.prototype.stopTaskTrace=function(b,d){this._trace&&(this._trace.removeListener(b),0==this._trace.getListeners().length&&(this.root&&this.root.setTrace(null),this._trace=null));d&&d()};c.prototype.toCloudRuleJSON=function(b,d,c,k,h){var a=[],g=this.getTriggers();if(!g||0==g.length)return null;for(var f=0;f<g.length;f++){var p=g[f];p&&"cloud.trigger.device"==p.type&&(p=p.toCloudTriggerFormat())&&
a.push(p)}return 0==a.length?null:{name:this.name,owner:d,app:b,action:[{sys:"mediola",data:{data:{XC_FNC:"DoTask",id:this.id},token:h,ccs:c+(k?":"+k:""),cmd:"cmd"}}],trigger:a}};c.prototype.getCloudDeviceTriggerGateway=function(){if(!this.root)return null;var b=this.root.getTriggers(),d=null;if(!b||0>=b.length)return null;for(var c=0;c<b.length;c++){var k=b[c];if(k&&"cloud.trigger.device"==k.type&&(d=k._getGateway()))break}return d};c.parse=function(b){if(!b||!b.id||!b.name)return null;var d=new c(b);
b.root&&(d.root=x.hub.taskman._Block.parse(b.root),d.root&&(d.root._task=d,d.root.singleton=d.singleton,d.root.singletonMethod=d.singletonMethod));return d};return c}();
x.hub.taskman.AlarmTask=function(){var c=function(){this._active=!1;this._delay=0;this._activateDelayTO=null};c.prototype.init=function(){this._active="true"==localStorage.getItem("x.hub.taskman.TaskManager.alarmActive");this._delay=parseInt(localStorage.getItem("x.hub.taskman.TaskManager.alarmDelay"))};c.prototype.setAlarmActive=function(b,d,c,k){var f=function(a,b,d){if("undefined"==typeof b||null==b)b=!0;"string"==typeof b&&(b="false"==b?!1:!0);a._tasks.forEach(function(a){a.isAlarmTask&&(a.active=
b)});a._writeData(d)};if(this._getAlarmPin()!=d)d=Error("pin error"),d.code=x.hub.taskman.ERROR_CODE.Pin_Error,k&&k(d);else if(this._activateDelayTO&&(clearTimeout(this._activateDelayTO),this._activateDelayTO=null),this._delay&&b){var a=this;this._activateDelayTO=setTimeout(function(){localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b);a._active=b;a._activateDelayTO=null;f(c,b)},1E3*this._delay);k&&k()}else localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",b),this._active=b,
f(c,b,k)};c.prototype.setAlarmDelay=function(b,d,c){this._getAlarmPin()!=d?(b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmDelay",b),this._delay=b,c&&c())};c.prototype.getAlarmInfo=function(b){b&&b(null,{active:this._active,delay:this._delay?this._delay:0,pendingActive:null!=this._activateDelayTO})};c.prototype.selectAlarmTask=function(b,d,c,k,h){if(b){for(var a=null,g=0;g<k.length;g++){var f=k[g];if(f.id==b){a=f;break}}a?
(b=this._getAlarmPin(),c&&c==b?this._active?h&&h(Error("alarm task active")):(a.setAlarmTask(d),h&&h()):(d=Error("pin error"),d.code=x.hub.taskman.ERROR_CODE.Pin_Error,h&&h(d))):h&&h(Error("no such task:"+b))}else h&&h(Error("task id is null"))};c.prototype._getAlarmPin=function(){return localStorage.getItem("x.hub.taskman.TaskManager.alarmPin")?localStorage.getItem("x.hub.taskman.TaskManager.alarmPin"):c.DEFAULT_PIN};c.prototype.setAlarmPin=function(b,d,c){var f=this._getAlarmPin();b?d!=f?(b=Error("pin error"),
b.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(b)):(localStorage.setItem("x.hub.taskman.TaskManager.alarmPin",b),c&&c()):c&&c(Error("new pin invalid"))};c.DEFAULT_PIN="0000";return c}();
x.hub.taskman.TaskTrace=function(){var c=function(b){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskTrace");this._task=b;this._listeners=[]};c.prototype.addListener=function(b){b&&-1==this._listeners.indexOf(b)&&this._listeners.push(b)};c.prototype.removeListener=function(b){b&&(b=this._listeners.indexOf(b),-1!=b&&this._listeners.splice(b,1))};c.prototype.getListeners=function(b){return this._listeners};c.prototype.log=function(b){this._logger.log("trace","[Task "+this._task.id+
"]:"+b);b="["+this._getTimestamp()+"] "+b;this._listeners.forEach(function(d){d&&d(b)})};c.prototype._getTimestamp=function(){return(new Date).toTimeString()};return c}();x.hub.taskman.rehau={};
x.hub.taskman.rehau.AlarmTaskManager=function(){var c=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmDoor");this._alarmTask=this._activateEvent=this._device=this._id=null};c.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.addStateDevice&&this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};
c.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");a&&a.removeStateDevice&&this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"})}};c.prototype.setAlarmTask=function(a){this._alarmTask=a};c.prototype.getID=function(){return this._id};c.prototype.setID=function(a){this._id=a};c.prototype.setDevice=function(a){this._device=
a};c.prototype.setActivateEvent=function(a){this._activateEvent=a};c.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent}};c.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};c.prototype.onStatusEvt=function(a){a&&a.data&&this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value&&(this._logger.log("trace","alarm door:"+this._device.address+
" receive event:"+a.data.value+" and trigger door alarm"),this._alarmTask&&this._alarmTask.triggerDoorAlarm())};c.buildDoorfromJSON=function(a){if(!a||!a.device)return null;var b=new c;b.setID(a.id);b.setDevice(a.device);b.setActivateEvent(a.activateEvent);return b};var b=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmKey");this._alarmTask=this._deactivateEvent=this._activateEvent=this._device=this._id=null};b.prototype.init=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.addStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.finalize=function(){if(this._device){var a=require("x.hub.moduleman.js").modulemanager.getModule("aio");
a&&a.removeStateDevice&&(this._activateEvent&&this._activateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&a.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}))}};b.prototype.setAlarmTask=function(a){this._alarmTask=a};b.prototype.getID=function(){return this._id};
b.prototype.setID=function(a){this._id=a};b.prototype.setDevice=function(a){this._device=a};b.prototype.setActivateEvent=function(a){this._activateEvent=a};b.prototype.setDeactivateEvent=function(a){this._deactivateEvent=a};b.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent,deactivateEvent:this._deactivateEvent}};b.prototype.matchDevice=function(a){return this._device&&a?this._device.type==a.type&&this._device.address==a.address:!1};b.prototype.onStatusEvt=
function(a){if(a&&a.data)if(this._activateEvent&&this._activateEvent.status==a.data.key&&this._activateEvent.value==a.data.value){if(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+a.data.key+" and activate alarm task"),this._alarmTask){a=this._alarmTask.getManager();var b=this._alarmTask.getID();a._setAlarmActive(b,!0,function(a){})}}else this._deactivateEvent&&this._deactivateEvent.status==a.data.key&&this._deactivateEvent.value==a.data.value&&(this._logger.log("trace",
"alarm key:"+this._device.address+" receive event:"+a.data.key+" and deactivate alarm task"),this._alarmTask&&this._alarmTask.deactivate())};b.buildKeyfromJSON=function(a){if(!a||!a.device)return null;var d=new b;d.setID(a.id);d.setDevice(a.device);d.setActivateEvent(a.activateEvent);d.setDeactivateEvent(a.deactivateEvent);return d};var d=function(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmConfirmation");this._alarmTask=this._preAlarmNotificationInterval=this._deactivateAction=
this._activateAction=this._device=this._id=null};d.prototype.setAlarmTask=function(a){this._alarmTask=a};d.prototype.getID=function(){return this._id};d.prototype.setID=function(a){this._id=a};d.prototype.setDevice=function(a){this._device=a};d.prototype.setActivateAction=function(a){this._activateAction=a};d.prototype.setDeactivateAction=function(a){this._deactivateAction=a};d.prototype.toJSON=function(){return{id:this._id,device:this._device,activateAction:this._activateAction,deactivateAction:this._deactivateAction}};
d.prototype.activationBlockedForAlarmKey=function(){if(this._device&&this._activateAction&&"aio"==this._device.sys&&"HM"==this._device.type&&"ip_siren"==this._device.data){var a=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var b=this;a.executeCommand(this._device,null,{value:"triggerAlarm12,6,2,0",ext:[{value:"alarmAudio",ext:"FREQUENCY_FALLING"},{value:"alarmVisual",ext:"BLINKING_ALTERNATELY_REPEATING"},{value:"alarmDur",
ext:1},{value:"alarmDurUnit",ext:"S"}]},function(a){a&&a.error&&b._logger.log("trace","do activate confirmation error:"+a.error.message)})}};d.prototype.onActivated=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand(this._activateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var d=this;b.executeCommand(this._device,
null,a,function(a){a&&a.error&&d._logger.log("trace","do activate confirmation error:"+a.error.message)})}};d.prototype.onDeactivated=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null);if(this._device&&this._deactivateAction){var a=this._deactivateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand(this._deactivateAction.ext),!a))return;var b=require("x.hub.commandman.js").commandHandler;
this._logger.log("trace","do deactivate confirmation:"+JSON.stringify(this.toJSON()));var d=this;b.executeCommand(this._device,null,a,function(a){a&&d._logger.log("trace","do deactivate confirmation error:"+a.message)})}};d.prototype.startPreAlarmNotification=function(){if(!this._preAlarmNotificationInterval){var a=this;this._doPreAlarmNotification();this._preAlarmNotificationInterval=setInterval(function(){a._doPreAlarmNotification()},7E3)}};d.prototype.stopPreAlarmNotification=function(){this._preAlarmNotificationInterval&&
(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null)};d.prototype._doPreAlarmNotification=function(){if(this._device&&this._activateAction){var a=this._activateAction;a.ref&&(a=a.ref);if("sonos"==this._device.sys&&(a=this._buildSonosCommand("pre_alarm"),!a))return;var b=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do pre alarm notification:"+JSON.stringify(this.toJSON()));var d=this;b.executeCommand(this._device,null,a,function(a){a&&
a.error&&d._logger.log("trace","do pre alarm notification error:"+a.error.message)})}};d.prototype._getLocalIP=function(){var a=require("os").networkInterfaces(),b;for(b in a)for(var d=a[b],c=0;c<d.length;c++){var f=d[c];if(f&&"IPv4"==f.family&&0==f.internal)return f.address}return null};d.prototype._getLocalPort=function(){var a=require("x.hub.js");return a.server?a.server._port:null};d.prototype._buildSonosCommand=function(a){var b=this._getLocalIP(),d=this._getLocalPort();if(!b||!d)return null;
switch(a){case "alarm_on":a="alarm_on.mp3";break;case "alarm_off":a="alarm_off.mp3";break;case "pre_alarm":a="pre_alarm.mp3";break;case "alarm":a="alarm.mp3";break;default:return null}return{value:"playUrl",ext:"http://"+b+":"+d+"/resources/rehau_alarm/"+a,timeout:15}};d.buildConfirmationfromJSON=function(a){if(!a||!a.device)return null;var b=new d;b.setID(a.id);b.setDevice(a.device);b.setActivateAction(a.activateAction);b.setDeactivateAction(a.deactivateAction);return b};var f=function(a){this._logger=
Logger.getLogger("x.hub.taskman.rehau.AlarmTask");this._id=a;this._pin=null;this._active=!1;this._delay=0;this._doorAlarmDelay=5;this._alarmKeys=[];this._alarmDoors=[];this._manager=this._doorAlarmDelayTimer=this._activateDelayTimer=this._associateTaskId_prealarm=this._associateTaskId_alarm=this._alarmConfirmation=null};f.DEFAULT_PIN="0000";f.prototype.init=function(a){this._logger.log("trace","init rehau alarm task");this._initAllAlarmKeys();this._initAllAlarmDoors();this._initAllAlarmWindowsSensors();
a&&a()};f.prototype._initAllAlarmKeys=function(){for(var a=0;a<this._alarmKeys.length;a++){var b=this._alarmKeys[a];b&&b.init()}};f.prototype._initAllAlarmDoors=function(){for(var a=0;a<this._alarmDoors.length;a++){var b=this._alarmDoors[a];b&&b.init()}};f.prototype._initAllAlarmWindowsSensors=function(){this._active&&require("x.hub.m.enocean.js").setRehauAlarm(this._active)};f.prototype.setManager=function(a){this._manager=a};f.prototype.getManager=function(){return this._manager};f.prototype.getID=
function(){return this._id};f.prototype.getDelay=function(){return this._delay};f.prototype.setDelay=function(a){this._delay=a};f.prototype.getAssociateTaskIdAlarm=function(){return this._associateTaskId_alarm};f.prototype.setAssociateTaskIdAlarm=function(a){this._associateTaskId_alarm=a};f.prototype.getAssociateTaskIdPreAlarm=function(){return this._associateTaskId_prealarm};f.prototype.setAssociateTaskIdPreAlarm=function(a){this._associateTaskId_prealarm=a};f.prototype.getPin=function(){return this._pin?
this._pin:f.DEFAULT_PIN};f.prototype.setPin=function(a){this._pin=a};f.prototype.getDoorAlarmDelay=function(){return this._doorAlarmDelay};f.prototype.setDoorAlarmDelay=function(a){this._doorAlarmDelay=a};f.prototype.isActive=function(){return this._active};f.prototype.isWaitForActive=function(){return this._activateDelayTimer&&!this._active?!0:!1};f.prototype.cancelDelayActive=function(){this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=null;this._doorAlarmDelayTimer&&
clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null};f.prototype.activate=function(){var a=require("x.hub.m.enocean.js");if(a.isRehauWindowOpen()||require("x.hub.m.hm.js").isWindowOpen())return!0;var b=this;if(this._delay)this._logger.log("trace","activate alarm task:"+this._id+" after "+this._delay+" seconds"),this._activateDelayTimer=setTimeout(function(){b._logger.log("trace","activate alarm task:"+this._id);b._active=!0;b._setAssociateTaskActive(!0);b._manager&&b._manager.save();
a.setRehauAlarm(!0);b._activateDelayTimer=null;if(b._alarmConfirmation)b._alarmConfirmation.onActivated()},1E3*this._delay);else if(this._logger.log("trace","activate alarm task:"+this._id),this._active=!0,this._setAssociateTaskActive(!0),this._manager&&this._manager.save(),a.setRehauAlarm(!0),this._alarmConfirmation)this._alarmConfirmation.onActivated();return!1};f.prototype.deactivate=function(){this._active=!1;this._activateDelayTimer&&clearTimeout(this._activateDelayTimer);this._activateDelayTimer=
null;this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer);this._doorAlarmDelayTimer=null;this._logger.log("trace","deactivate alarm task:"+this._id);this._setAssociateTaskActive(!1);this._manager&&this._manager.save();require("x.hub.m.enocean.js").setRehauAlarm(!1);if(this._alarmConfirmation)this._alarmConfirmation.onDeactivated()};f.prototype._setAssociateTaskActive=function(a,b){if(this._manager){var d=0;this._associateTaskId_alarm&&(d+=1);this._associateTaskId_prealarm&&(d+=1);var c=
function(){d--;0==d&&b&&b()};this._associateTaskId_alarm&&this._manager.setAssociateTaskActive(this._associateTaskId_alarm,a,c);this._associateTaskId_prealarm&&this._manager.setAssociateTaskActive(this._associateTaskId_prealarm,a,c)}else b&&b(Error("manager is null"))};f.prototype.activationBlockedForAlarmKey=function(){this._alarmConfirmation&&this._alarmConfirmation.activationBlockedForAlarmKey()};f.prototype.addAlarmKey=function(a,d){if(a)if(a=b.buildKeyfromJSON(a))if(a.getID())d&&d(Error("id for new alarm key is not null "));
else{a.setID(this._generateAlarmKeyID());this._addAlarmKeySync(a);var c=this;this._manager.save(function(a){d&&d(a,c.toJSON())})}else d&&d(Error("alarm key json invalid"));else d&&d(Error("alarm key json is null"))};f.prototype.updateAlarmKey=function(a,d){if(a)if(a=b.buildKeyfromJSON(a)){var c=a.getID();if(c){var g=this._getAlarmKeySync(c);if(g){this._deleteAlarmKeySync(g);this._addAlarmKeySync(a);var f=this;this._manager.save(function(a){d&&d(a,f.toJSON())})}else d&&d(Error("no such alarm key with id:"+
c))}else d&&d(Error("id for alarm key is null"))}else d&&d(Error("alarm key json invalid"));else d&&d(Error("alarm key json is null"))};f.prototype.deleteAlarmKey=function(a,b){if(a){var d=this._getAlarmKeySync(a.id);if(d){this._deleteAlarmKeySync(d);var c=this;this._manager.save(function(a){b&&b(a,c.toJSON())})}else b&&b(Error("no such alarm key with id:"+a.id))}else b&&b(Error("alarm key is null"))};f.prototype.addAlarmDoor=function(a,b){if(a)if(a=c.buildDoorfromJSON(a))if(a.getID())b&&b(Error("id for new alarm door is not null "));
else{a.setID(this._generateAlarmDoorID());this._addAlarmDoorSync(a);var d=this;this._manager.save(function(a){b&&b(a,d.toJSON())})}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};f.prototype.updateAlarmDoor=function(a,b){if(a)if(a=c.buildDoorfromJSON(a)){var d=a.getID();if(d){var g=this._getAlarmDoorSync(d);if(g){this._deleteAlarmDoorSync(g);this._addAlarmDoorSync(a);var f=this;this._manager.save(function(a){b&&b(a,f.toJSON())})}else b&&b(Error("no such alarm door with id:"+
d))}else b&&b(Error("id for alarm door is null"))}else b&&b(Error("alarm door json invalid"));else b&&b(Error("alarm door json is null"))};f.prototype.deleteAlarmDoor=function(a,b){if(a){var d=this._getAlarmDoorSync(a.id);if(d){this._deleteAlarmDoorSync(d);var c=this;this._manager.save(function(a){b&&b(a,c.toJSON())})}else b&&b(Error("no such alarm door with id:"+a.id))}else b&&b(Error("alarm door is null"))};f.prototype.setAlarmConfirmation=function(a,b){if(a)if(a=d.buildConfirmationfromJSON(a)){a.setAlarmTask(this);
var c=this;this._alarmConfirmation=a;this._manager.save(function(a){b&&b(a,c.toJSON())})}else b&&b(Error("alarm confirmation json invalid"));else b&&b(Error("alarm confirmation json is null"))};f.prototype.getAlarmTaskSync=function(a){return this._taskmanager.readTaskSync(a)};f.prototype.triggerDoorAlarm=function(){if(this._active)if(!this._doorAlarmDelay)this._logger.log("trace","no door alarm delay, execute associated task:"+this._associateTaskId_alarm),this._associateTaskId_alarm&&this._manager&&
this._manager.executeAssociateTask(this._associateTaskId_alarm);else if(!this._doorAlarmDelayTimer){this._alarmConfirmation&&(this._logger.log("trace","door alarm start pre-alarm notification"),this._alarmConfirmation.startPreAlarmNotification());this._logger.log("trace","door alarm execute associated task:"+this._associateTaskId_alarm+" after "+this._doorAlarmDelay+" seconds");var a=this;this._doorAlarmDelayTimer=setTimeout(function(){a._doorAlarmDelayTimer=null;a._alarmConfirmation&&(a._logger.log("trace",
"door alarm stop pre-alarm notification"),a._alarmConfirmation.stopPreAlarmNotification());a._associateTaskId_alarm&&(a._logger.log("trace","door alarm execute associated task:"+a._associateTaskId_alarm),a._manager&&a._manager.executeAssociateTask(a._associateTaskId_alarm))},1E3*this._doorAlarmDelay)}};f.prototype.triggerWindowSensorAlarm=function(a){this._active&&(a&&this._associateTaskId_prealarm?this._manager&&this._manager.executeAssociateTask(this._associateTaskId_prealarm):!a&&this._associateTaskId_alarm&&
this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm))};f.prototype.onStatusEvt=function(a){if(a){for(var b=0;b<this._alarmKeys.length;b++){var d=this._alarmKeys[b];if(d&&d.matchDevice(a.device))d.onStatusEvt(a)}for(b=0;b<this._alarmDoors.length;b++)if((d=this._alarmDoors[b])&&d.matchDevice(a.device))d.onStatusEvt(a)}};f.prototype._getAlarmKeySync=function(a){if(!a)return null;var b=this._alarmKeys.length;if(!b)return null;for(;b--;){var d=this._alarmKeys[b];if(d&&d.getID()==
a)return d}return null};f.prototype._addAlarmKeySync=function(a){a.setAlarmTask(this);this._alarmKeys.push(a);a.init()};f.prototype._deleteAlarmKeySync=function(a){a.finalize();a=this._alarmKeys.indexOf(a);-1!=a&&this._alarmKeys.splice(a,1)};f.prototype._getAlarmDoorSync=function(a){if(!a)return null;var b=this._alarmDoors.length;if(!b)return null;for(;b--;){var d=this._alarmDoors[b];if(d&&d.getID()==a)return d}return null};f.prototype._addAlarmDoorSync=function(a){a.setAlarmTask(this);this._alarmDoors.push(a);
a.init()};f.prototype._deleteAlarmDoorSync=function(a){a.finalize();a=this._alarmDoors.indexOf(a);-1!=a&&this._alarmDoors.splice(a,1)};f.prototype._generateAlarmKeyID=function(){var a=[],b=this._alarmKeys.length;if(0==b)return 1;for(;b--;){var d=this._alarmKeys[b];d&&(a[d.getID()]=!0)}for(b=1;a[b];)b++;return b};f.prototype._generateAlarmDoorID=function(){var a=[],b=this._alarmDoors.length;if(0==b)return 1;for(;b--;){var d=this._alarmDoors[b];d&&(a[d.getID()]=!0)}for(b=1;a[b];)b++;return b};f.prototype._getActivationDelayTimer=
function(a){return this._activateDelayTimer[a]};f.prototype._clearActivationDelayTimer=function(a){var b=this._activateDelayTimer[a];b&&clearTimeout(b);delete this._activateDelayTimer[a]};f.prototype.toJSON=function(){for(var a={id:this._id,active:this._active,delay:this._delay,doorAlarmDelay:this._doorAlarmDelay,alarmKeys:[],alarmDoors:[],alarmConfirmation:null,associateTaskId_alarm:this._associateTaskId_alarm,associateTaskId_prealarm:this._associateTaskId_prealarm},b=0;b<this._alarmKeys.length;b++){var d=
this._alarmKeys[b];d&&(d=d.toJSON())&&a.alarmKeys.push(d)}for(b=0;b<this._alarmDoors.length;b++)(d=this._alarmDoors[b])&&(d=d.toJSON())&&a.alarmDoors.push(d);this._alarmConfirmation&&(a.alarmConfirmation=this._alarmConfirmation.toJSON());return a};f.buldTaskFromJSON=function(a){if(!a||!a.id)return null;var g=new f(a.id);g._pin=a.pin;g._active=a.active;g._delay=a.delay;g._doorAlarmDelay=a.doorAlarmDelay;g._associateTaskId_alarm=a.associateTaskId_alarm;g._associateTaskId_prealarm=a.associateTaskId_prealarm;
if(a.alarmKeys)for(var k=0;k<a.alarmKeys.length;k++){var h=a.alarmKeys[k];h&&(h=b.buildKeyfromJSON(h))&&(h.setAlarmTask(g),g._alarmKeys.push(h))}if(a.alarmDoors)for(k=0;k<a.alarmDoors.length;k++)if(h=a.alarmDoors[k])if(h=c.buildDoorfromJSON(h))h.setAlarmTask(g),g._alarmDoors.push(h);a.alarmConfirmation&&(a=d.buildConfirmationfromJSON(a.alarmConfirmation))&&(a.setAlarmTask(g),g._alarmConfirmation=a);return g};var k=function(a){this._alarmTaskTokenPoll=[];this._manager=a};k.prototype.generateToken=
function(a){var b=this._manager._getAlarmTask(a);if(null==b||100<this._alarmTaskTokenPoll.length)return null;for(var d=this._generateNonce();this._nonceExist(d);)d=this._generateNonce();b=b.getPin();b=this._hashPin(d,b);var c=this,f={nonce:d,hash:b,taskID:a,timeout:null,failedCount:0};this._alarmTaskTokenPoll.push(f);f.timeout=setTimeout(function(){c._tokenExpired(f)},3E4);return d};k.prototype.authenticate=function(a,b){if(null==this._manager._getAlarmTask(a)||20>=b.length)return!1;var d=b.substr(0,
20);b=b.substr(20);for(var c=null,f=0;f<this._alarmTaskTokenPoll.length;f++){var g=this._alarmTaskTokenPoll[f];if(g&&g.nonce==d&&g.hash==b&&g.taskID==a)return this._tokenExpired(g),!0;g&&g.nonce==d&&(c=g)}c&&(c.failedCount+=1,3<=c.failedCount&&this._tokenExpired(c));return!1};k.prototype.expireAllToken=function(a){var b=[],d,c;for(d=0;d<this._alarmTaskTokenPoll.length;d++)(c=this._alarmTaskTokenPoll[d])&&c.taskID==a&&b.push(c);if(b&&0<b.length)for(d=0;d<this._alarmTaskTokenPoll.length;d++)c=this._alarmTaskTokenPoll[d],
this._tokenExpired(c);return!1};k.prototype._tokenExpired=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null);a=this._alarmTaskTokenPoll.indexOf(a);-1!=a&&this._alarmTaskTokenPoll.splice(a,1)};k.prototype._nonceExist=function(a){for(var b=0;b<this._alarmTaskTokenPoll.length;b++){var d=this._alarmTaskTokenPoll[b];if(d&&d.nonce==a)return!0}return!1};k.prototype._generateNonce=function(){return require("crypto").randomBytes(10).toString("hex")};k.prototype._hashPin=function(a,b){a=a.substr(5,
4);var d=require("crypto").createHash("sha1");d.update(a+b);return d.digest("hex")};var h=function(a){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTaskManager");this._taskmanager=a;this._alarmTasks=[];this._auth=new k(this)};h.FILE_NAME="alarm_rehau.json";h.prototype.init=function(a){this._logger.log("trace","init rehau alarm task manager");var b=this;this._loadSettings(function(d){d&&b._logger.log("warn","init rehau alarm task manager error:"+d.message);b._setupDefaultAlarmTask();b._initAllAlarmTasks();
a&&a()})};h.prototype.save=function(a){this._saveSettings(a)};h.prototype.challenge=function(a,b){this._getAlarmTask(a)?(a=this._auth.generateToken(a),b&&b(a?null:Error("generate token failed"),{token:a})):b&&b(Error("no such alarm task with id:"+a))};h.prototype.getAlarmInfo=function(a){var b=this._toSettingsJSON();a&&a(null,b)};h.prototype.setAlarmDelay=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?(f.setDelay(b),this._saveSettings(function(a){c&&
c(a,f.toJSON())})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskAlarm=function(a,b,d,c){var f=this._getAlarmTask(a);if(f){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),!g)){c&&c(Error("no such task with id:"+b));return}if(f.isActive())c&&c(Error("alarm task is active"));else if(this._auth.authenticate(a,d)){a=f.getAssociateTaskIdPreAlarm();(d=f.getAssociateTaskIdAlarm())&&d!=b&&d!=a&&(a=
this._taskmanager.readTaskSync(d))&&a.setRehauAlarmTask(!1);f.setAssociateTaskIdAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?c&&c(a):k._taskmanager.save(function(a){c&&c(a,f.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(b)}else c&&c(Error("no such alarm task with id:"+a))};h.prototype.selectAssociateTaskPreAlarm=function(a,b,d,c){var f=this._getAlarmTask(a);if(f){var g=null;if(b&&(g=this._taskmanager.readTaskSync(b),
!g)){c&&c(Error("no such task with id:"+b));return}if(f.isActive())c&&c(Error("alarm task is active"));else if(this._auth.authenticate(a,d)){a=f.getAssociateTaskIdAlarm();(d=f.getAssociateTaskIdPreAlarm())&&d!=b&&d!=a&&(a=this._taskmanager.readTaskSync(d))&&a.setRehauAlarmTask(!1);f.setAssociateTaskIdPreAlarm(b);g&&(g.setRehauAlarmTask(!0),g.setActive(!1));var k=this;this._saveSettings(function(a){a?c&&c(a):k._taskmanager.save(function(a){c&&c(a,f.toJSON())})})}else b=Error("pin error"),b.code=x.hub.taskman.ERROR_CODE.Pin_Error,
c&&c(b)}else c&&c(Error("no such alarm task with id:"+a))};h.prototype.setAlarmActive=function(a,b,d,c){b||this._auth.authenticate(a,d)?this._setAlarmActive(a,b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a))};h.prototype._setAlarmActive=function(a,b,d){for(var c=null,f=0;f<this._alarmTasks.length;f++)if(this._alarmTasks[f])if(this._alarmTasks[f].getID()==a)c=this._alarmTasks[f];else{if(this._alarmTasks[f].isActive()){d&&d(Error("another alarm task with id:"+this._alarmTasks[f].getID()+
" is active"));return}this._alarmTasks[f].isWaitForActive()&&this._alarmTasks[f].cancelDelayActive()}c?b&&c.isActive()?d&&d(null,c.toJSON()):b&&!c.isActive()?c.activate()?(a=Error("rehau window is open"),a.code="200002",d&&d(a)):d&&d(null,c.toJSON()):(c.deactivate(),d&&d(null,c.toJSON())):d&&d(Error("no such alarm task with id:"+a))};h.prototype.setNewPin=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.getPin()==b?c&&
c():(f.setPin(b),this._auth.expireAllToken(a),this._saveSettings(function(a){c&&c(a)})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.setDoorAlarmDelay=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?(f.setDoorAlarmDelay(b),this._saveSettings(function(a){c&&c(a,f.toJSON())})):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,
c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.addAlarmKey=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.addAlarmKey(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmKey=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.updateAlarmKey(b,
c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmKey=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.deleteAlarmKey(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.addAlarmDoor=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?
c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.addAlarmDoor(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.updateAlarmDoor=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.updateAlarmDoor(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.deleteAlarmDoor=
function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.deleteAlarmDoor(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.setAlarmConfirmation=function(a,b,d,c){var f=this._getAlarmTask(a);f?f.isActive()?c&&c(Error("alarm task is active")):this._auth.authenticate(a,d)?f.setAlarmConfirmation(b,c):(a=Error("pin error"),a.code=x.hub.taskman.ERROR_CODE.Pin_Error,
c&&c(a)):c&&c(Error("no such alarm task with id:"+a))};h.prototype.setAssociateTaskActive=function(a,b,d){var c=this._taskmanager.readTaskSync(a);c?(c.setActive(b),this._taskmanager.save(d)):d&&d(Error("no such task with id:"+a))};h.prototype.executeAssociateTask=function(a,b){var d=this._taskmanager.readTaskSync(a);d?d.trigger(b):b&&b(Error("no such task with id:"+a))};h.prototype.onStatusEvtForTask=function(a,b){this._logger.log("debug","for task:"+b+" receive status event:"+JSON.stringify(a));
if(b=this._getAlarmTask(b))b.onStatusEvt(a)};h.prototype.onWindowSensorAlarmTriggered=function(a){for(var b=0;b<this._alarmTasks.length;b++){var d=this._alarmTasks[b];d&&d.isActive()&&d.triggerWindowSensorAlarm(a)}};h.prototype._getAlarmTask=function(a){for(var b=0;b<this._alarmTasks.length;b++){var d=this._alarmTasks[b];if(d&&d.getID()==a)return d}return null};h.prototype._isAlarmTaskActive=function(a){};h.prototype._setupDefaultAlarmTask=function(){if(0==this._alarmTasks.length){var a=new f(1);
a.setManager(this);this._alarmTasks.push(a)}1==this._alarmTasks.length&&(a=this._alarmTasks[0],a=1==a.getID()?2:1,a=new f(a),a.setManager(this),this._alarmTasks.push(a))};h.prototype._initAllAlarmTasks=function(){for(var a=0;a<this._alarmTasks.length;a++){var b=this._alarmTasks[a];b&&b.init()}};h.prototype._loadSettings=function(a){var b=this,d=this._getFile();fs_extra.ensureFile(d,function(c){c?a&&a(c):b._loadFile(d,function(d,c){d?a&&a(d):(b._fromSettingsJSON(c),a&&a())})})};h.prototype._saveSettings=
function(a){var b=this._getFile(),d=this._toSettingsJSON();this._saveFile(b,d,function(b){a&&a(b)})};h.prototype._fromSettingsJSON=function(a){if(a&&Array.isArray(a))for(var b=0;b<a.length;b++){var d=f.buldTaskFromJSON(a[b]);d&&(d.setManager(this),this._alarmTasks.push(d))}};h.prototype._toSettingsJSON=function(){for(var a=[],b=0;b<this._alarmTasks.length;b++){var d=this._alarmTasks[b];d&&a.push(d.toJSON())}return a};h.prototype._loadFile=function(a,b){fs.readFile(a,"utf8",function(a,d){if(a)b&&b(a);
else if(d)try{var c=JSON.parse(d);b&&b(null,c)}catch(r){b&&b(r)}else b&&b(null,null)})};h.prototype._saveFile=function(a,b,d){fs.writeFile(a,JSON.stringify(b,null,2),function(a){d&&d(a)})};h.prototype._getFile=function(){var a=fileman.fileManager.getUserRootDataPath();return path.resolve(a,h.FILE_NAME)};return h}();
x.hub.taskman.TaskManager=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskManager");this.version=c.TMP_VERSION;this._tasks=[];this._alarmTask=new x.hub.taskman.AlarmTask;this._mode=31;this._lock=!1};c.TMP_VERSION="1.0.0";c.NS_VERSION="2.3.2";c.FILE_NAME="tm.json";c.prototype.init=function(b){this._alarmTask.init();this._load(b)};c.prototype.clear=function(){for(var b=0;b<this._tasks.length;b++)try{this._tasks[b].finalize()}catch(d){}x.hub.taskman._TimerManager.clear();
x.hub.taskman._AstroManager.clear();x.hub.taskman._PeriodicTimerManager.clear();this._tasks=[]};c.prototype.save=function(b){this._writeData(b)};c.prototype.reload=function(b){this.clear();this._load(b)};c.prototype.import=function(b,d){var c=this;this._writeFile(b,function(b){b?d&&d(b):c.reload(d)})};c.prototype._load=function(b){var d=this,c=require("fs-extra"),k=this._getFile();c.ensureFile(k,function(c){c?b&&b(c):d._loadData(function(a,c){a?b&&b(a):(d._tasks=c,d._sort(),d._lock||c.forEach(function(a){try{a.init()}catch(p){console.error(p)}}),
b&&b())})})};c.prototype.lock=function(){this._lock=!0};c.prototype.unlock=function(){this._lock=!1};c.prototype.createTask=function(b,d){if(b){for(var c=1,k=-1,h=0;h<this._tasks.length;h++)if(this._tasks[h].id>c){b.id=c;k=h;break}else c++;-1==k&&(b.id=c,k=this._tasks.length);this._tasks.splice(k,0,b);this._lock||b.init();this._writeData(function(a){a?d&&d(a):d&&d(null,b.toJSON())})}else d&&d(Error("task is null"))};c.prototype.readTask=function(b,d){if(b){for(var c=null,k=0;k<this._tasks.length;k++){var h=
this._tasks[k];if(h.id==b){c=h;break}}c?d&&d(null,c):d&&d(Error("no such task with id:"+b))}else d&&d(Error("task id is null"))};c.prototype.readAllTasks=function(b){b&&b(null,this._tasks)};c.prototype.updateTask=function(b,d,c){for(var f=null,h=-1,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b.id){f=g;h=a;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){c&&c(Error("alarm task active"));return}a=this._alarmTask._getAlarmPin();if(!d||d!=a){b=Error("pin error");b.code=x.hub.taskman.ERROR_CODE.Pin_Error;
c&&c(b);return}}f.isRehauAlarmTask()&&f.isActive()?c&&c(Error("rehau alarm task active")):(f.finalize(),this._tasks.splice(h,1,b),this._lock||b.init(),this._writeData(c))}else c&&c(Error("no such task with id:"+b.id))};c.prototype.deleteTask=function(b,d,c){if(b){for(var f=-1,h=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){f=a;h=g;break}}if(h.isAlarmTask){if(this._alarmTask._active){c&&c(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!d||d!=b){d=Error("pin error");
d.code=x.hub.taskman.ERROR_CODE.Pin_Error;c&&c(d);return}}h.isRehauAlarmTask()&&h.isActive()?c&&c(Error("rehau alarm task active")):(h.finalize(),-1!=f&&this._tasks.splice(f,1),this._writeData(c))}else c&&c(Error("task id is null"))};c.prototype.setTaskActive=function(b,d,c,k){if(b){for(var f=null,a=0;a<this._tasks.length;a++){var g=this._tasks[a];if(g.id==b){f=g;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){k&&k(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!c||
c!=b){d=Error("pin error");d.code=x.hub.taskman.ERROR_CODE.Pin_Error;k&&k(d);return}}f.isRehauAlarmTask()?k&&k(Error("do not allow to set active state for rehau alarm task")):(f.setActive(d),this._writeData(k))}else k&&k(Error("no such task:"+b))}else k&&k(Error("task id is null"))};c.prototype.doTask=function(b,d,c){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f.isAlarmTask){if(this._alarmTask._active){c&&c(Error("alarm task active"));return}b=
this._alarmTask._getAlarmPin();if(!d||d!=b){d=Error("pin error");d.code=x.hub.taskman.ERROR_CODE.Pin_Error;c&&c(d);return}}f.trigger(c)}else c&&c(Error("task id is null"))};c.prototype.cancelTask=function(b,d,c){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f){if(f.isAlarmTask){if(this._alarmTask._active){c&&c(Error("alarm task active"));return}b=this._alarmTask._getAlarmPin();if(!d||d!=b){d=Error("pin error");d.code=x.hub.taskman.ERROR_CODE.Pin_Error;
c&&c(d);return}}f.cancel(c)}else c&&c(Error("no such task"))}else c&&c(Error("task id is null"))};c.prototype.toggleTaskActive=function(b,d,c){if(b){for(var f=null,h=0;h<this._tasks.length;h++){var a=this._tasks[h];if(a.id==b){f=a;break}}if(f){if(f.isAlarmTask&&(b=this._alarmTask._getAlarmPin(),!d||d!=b)){d=Error("pin error");d.code=x.hub.taskman.ERROR_CODE.Pin_Error;c&&c(d);return}f.toggleActive();this._writeData(c)}else c&&c(Error("no such task:"+b))}else c&&c(Error("task id is null"))};c.prototype.isTaskRunning=
function(b,d){if(b){for(var c=null,k=0;k<this._tasks.length;k++){var h=this._tasks[k];if(h.id==b){c=h;break}}c?d&&d(null,c.isRunning()):d&&d(Error("no such task"))}else d&&d(Error("task id is null"))};c.prototype.getCloudDeviceTriggerGateway=function(b){for(var d=null,c=0;c<this._tasks.length;c++){var k=this._tasks[c];if(k&&(d=k.getCloudDeviceTriggerGateway()))break}b&&b(null,d)};c.prototype.readTaskSync=function(b){if(!b)return null;for(var d=null,c=0;c<this._tasks.length;c++){var k=this._tasks[c];
if(k.id==b){d=k;break}}return d};c.prototype.startTaskTrace=function(b,d,c){this.readTask(b,function(b,f){b?c&&c(b):f.startTaskTrace(d,function(a){c&&c(a)})})};c.prototype.stopTaskTrace=function(b,d,c){this.readTask(b,function(b,f){b?c&&c(b):f.stopTaskTrace(d,function(a){c&&c(a)})})};c.prototype.setAlarmActive=function(b,d,c){this._alarmTask.setAlarmActive(b,d,this,c)};c.prototype.setAlarmDelay=function(b,d,c){this._alarmTask.setAlarmDelay(b,d,c)};c.prototype.getAlarmInfo=function(b){this._alarmTask.getAlarmInfo(b)};
c.prototype.selectAlarmTask=function(b,d,c,k){var f=this;this._alarmTask.selectAlarmTask(b,d,c,this._tasks,function(a){a?k&&k(a):f._writeData(k)})};c.prototype._getAlarmPin=function(){return this._alarmTask._getAlarmPin()};c.prototype.setAlarmPin=function(b,d,c){this._alarmTask.setAlarmPin(b,d,c)};c.prototype.onStatusEvt=function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","receive status event:"+JSON.stringify(b));for(var d=0;d<this._tasks.length&&
!(2<=d&&0!=this._mode%31);d++)this._tasks[d].onStatusEvt(b)}};c.prototype.onStatusEvtForTask=function(b,d){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","for task:"+d+" receive status event:"+JSON.stringify(b));for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++){var k=this._tasks[c];if(k.id==d)k.onStatusEvtForTask(b)}}};c.prototype.onIREvt=function(b){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive ir event:"+JSON.stringify(b));for(var d=0;d<this._tasks.length&&!(2<=d&&0!=this._mode%31);d++)this._tasks[d].onIREvt(b)}};c.prototype.onLocationChange=function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onLocationChange(b),x.hub.taskman._AstroManager.onLocationChange(b),x.hub.taskman._PeriodicTimerManager.onLocationChange(b))};c.prototype.onTimeChange=function(b){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onTimeChange(b),
x.hub.taskman._AstroManager.onTimeChange(b),x.hub.taskman._PeriodicTimerManager.onTimeChange(b))};c.prototype.onTimerTick=function(b,d){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive time tick for task:"+b);for(var c=0;c<this._tasks.length&&!(2<=c&&0!=this._mode%31);c++){var k=this._tasks[c];if(k.id==b)k.onTimerTick(d)}}};c.prototype.onHttpEvt=function(b,d){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info",
"receive http event"+JSON.stringify(b));var c=!1,k=0;k=this._tasks.length;0!=this._mode%31&&2<k&&(k=2);for(var h=0;h<this._tasks.length&&!(2<=h&&0!=this._mode%31);h++)this._tasks[h].onHttpEvt(b,function(a,b){b&&(c=!0);k--;0==k&&d&&d(null,c)})}};c.prototype.onActivation=function(b){this.version=b?c.NS_VERSION:c.TMP_VERSION};c.prototype._writeData=function(b){var d=[];this._tasks.forEach(function(b){b&&d.push(b.toJSON())});this._writeFile(d,b)};c.prototype._loadData=function(b){var d=require("fs"),
c=this._getFile();d.readFile(c,"utf8",function(d,c){if(d)b&&b(d);else if(c)try{var a=JSON.parse(c),f=[];Array.isArray(a)&&a.forEach(function(a){(a=x.hub.taskman.Task.parse(a))&&f.push(a)});b&&b(null,f?f:[])}catch(l){b&&b(l)}else b&&b(null,[])})};c.prototype._writeFile=function(b,d){var c=require("fs"),k=this._getFile();c.writeFile(k,JSON.stringify(b,null,2),function(b){d&&d(b)})};c.prototype._getFile=function(){var b=require("x.hub.fileman.js").fileManager,d=require("path");require("fs");b=b.getUserRootDataPath();
return d.resolve(b,c.FILE_NAME)};c.prototype._sort=function(){var b=this._tasks.length-1;do{var d=!1;for(var c=0;c<b;++c)this._tasks[c].id>this._tasks[c+1].id&&(d=this._tasks[c],this._tasks[c]=this._tasks[c+1],this._tasks[c+1]=d,d=!0)}while(d)};return c}();
x.hub.taskman.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Handler");this.taskManager=new x.hub.taskman.TaskManager;this._rehauAlarmTaskManager=new x.hub.taskman.rehau.AlarmTaskManager(this.taskManager);var b=require("x.hub.eventbus.js");b.on("status",this.onStatusEvt.bind(this));b.on("irevt",this.onIREvt.bind(this));b.on("locationchange",this.onLocationChange.bind(this));b.on("timechange",this.onTimeChange.bind(this));b.on("neoserver_activation",
this.onActivation.bind(this))};c.prototype.TaskManager=x.hub.taskman.TaskManager;c.prototype.Task=x.hub.taskman.Task;c.prototype.Cloud=x.hub.taskman.Cloud;c.prototype.Util=x.hub.taskman._Util;c.prototype.init=function(b){this._logger.log("info","init task manager");if(localStorage){"true"==localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(this.taskManager.version=x.hub.taskman.TaskManager.NS_VERSION);var d=localStorage.getItem("x.hub.taskman.CLOUD_SERVER");d&&(x.hub.taskman.Cloud.prototype.URL=d)}var c=
this;this.taskManager.init(function(){c._rehauAlarmTaskManager.init(b)})};c.prototype.getRehauAlarmTaskManager=function(){return this._rehauAlarmTaskManager};c.prototype.lock=function(){this.taskManager.lock()};c.prototype.unlock=function(){this.taskManager.unlock()};c.prototype.doWebRequest=function(b,d,c){var f=function(b){if(b.error){var a=x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);c(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else c(JSON.stringify({XC_SUC:"undefined"!=
typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "Read":b=d.query.id;"undefined"==typeof b?this.readAllTasks(f):this.readTask(b,f);break;case "Create":this.createTask(d.query.data,f);break;case "Update":this.updateTask(d.query.data,d.query.pin,f);break;case "Delete":this.deleteTask(d.query.id,d.query.pin,f);break;case "Do":this.doTask(d.query.id,d.query.pin,f);break;case "Cancel":this.cancelTask(d.query.id,d.query.pin,f);break;case "isRunning":this.isTaskRunning(d.query.id,f);break;case "SetTaskActive":this.setTaskActive(d.query.id,
d.query.active,d.query.pin,f);break;case "ToggleTaskActive":this.toggleTaskActive(d.query.id,d.query.pin,f);break;case "SetAlarmActive":this.setAlarmActive(d.query.active,d.query.pin,f);break;case "SetAlarmDelay":this.setAlarmDelay(d.query.delay,d.query.pin,f);break;case "GetAlarmInfo":this.getAlarmInfo(f);break;case "SelectAlarmTask":this.selectAlarmTask(d.query.id,d.query.isAlarmTask,d.query.pin,f);break;case "SetAlarmPin":this.setAlarmPin(d.query.newPin,d.query.pin,f);break;case "GetCloudServer":f({data:x.hub.taskman.Cloud.prototype.URL});
break;case "SetCloudServer":if(!d.query.url){f({error:Error("url invalid")});break}"http"!=d.query.url.substr(0,4)&&(d.query.url="https://"+d.query.url);localStorage.setItem("x.hub.taskman.CLOUD_SERVER",d.query.url);x.hub.taskman.Cloud.prototype.URL=d.query.url;f({data:"success"});break;case "GetCloudDeviceTriggerGateway":this.getCloudDeviceTriggerGateway(f);break;default:b&&0==b.indexOf("Rehau")&&this.doRehauWebRequest(b,d,c)}};c.prototype.doRehauWebRequest=function(b,d,c){var f=function(b){if(b.error){var a=
x.hub.taskman.ERROR_CODE.General_Error;b.error.code&&(a=b.error.code);c(JSON.stringify({XC_ERR:{code:a,msg:b.error.message}}))}else c(JSON.stringify({XC_SUC:"undefined"!=typeof b.data&&null!=b.data?b.data:""}))};switch(b){case "RehauPinChallenge":this._rehauAlarmTaskManager.challenge(d.query.id,function(b,a){f({error:b,data:a})});break;case "RehauGetAlarmInfo":this._rehauAlarmTaskManager.getAlarmInfo(function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmDelay":this._rehauAlarmTaskManager.setAlarmDelay(d.query.id,
d.query.delay,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetDoorAlarmDelay":this._rehauAlarmTaskManager.setDoorAlarmDelay(d.query.id,d.query.delay,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmActive":this._rehauAlarmTaskManager.setAlarmActive(d.query.id,d.query.active,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSelectAssociateTaskAlarm":this._rehauAlarmTaskManager.selectAssociateTaskAlarm(d.query.id,d.query.associateTaskId,
d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSelectAssociateTaskPreAlarm":this._rehauAlarmTaskManager.selectAssociateTaskPreAlarm(d.query.id,d.query.associateTaskId,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetNewPin":this._rehauAlarmTaskManager.setNewPin(d.query.id,d.query.pin,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauAddAlarmKey":this._rehauAlarmTaskManager.addAlarmKey(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,
data:a})});break;case "RehauUpdateAlarmKey":this._rehauAlarmTaskManager.updateAlarmKey(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauDeleteAlarmKey":this._rehauAlarmTaskManager.deleteAlarmKey(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauAddAlarmDoor":this._rehauAlarmTaskManager.addAlarmDoor(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauUpdateAlarmDoor":this._rehauAlarmTaskManager.updateAlarmDoor(d.query.id,
d.query.data,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauDeleteAlarmDoor":this._rehauAlarmTaskManager.deleteAlarmDoor(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,data:a})});break;case "RehauSetAlarmConfirmation":this._rehauAlarmTaskManager.setAlarmConfirmation(d.query.id,d.query.data,d.query.token,function(b,a){f({error:b,data:a})})}};c.prototype.readAllTasks=function(b){this.taskManager.readAllTasks(function(d,c){if(d)b&&b({error:d});else{var f=[];c.forEach(function(b){f.push(b.toJSON())});
b&&b({data:f})}})};c.prototype.createTask=function(b,d){b?(b.id||(b.id=-1),(b=x.hub.taskman.Task.parse(b))?this.taskManager.createTask(b,function(b,c){d&&d({error:b,data:c})}):d&&d({error:Error("task json invalid")})):d&&d({error:Error("task json is null")})};c.prototype.readTask=function(b,d){this.taskManager.readTask(b,function(b,c){d&&d({error:b,data:c?c.toJSON():null})})};c.prototype.updateTask=function(b,d,c){b?(b=x.hub.taskman.Task.parse(b))?this.taskManager.updateTask(b,d,function(b){c&&c({error:b})}):
c&&c({error:Error("task json invalid")}):c&&c({error:Error("task json is null")})};c.prototype.deleteTask=function(b,d,c){this.taskManager.deleteTask(b,d,function(b){c&&c({error:b})})};c.prototype.setTaskActive=function(b,d,c,k){this.taskManager.setTaskActive(b,d,c,function(b){k&&k({error:b})})};c.prototype.doTask=function(b,d,c){this.taskManager.doTask(b,d,function(b){c&&c({error:b})})};c.prototype.cancelTask=function(b,d,c){this.taskManager.cancelTask(b,d,function(b){c&&c({error:b})})};c.prototype.toggleTaskActive=
function(b,d,c){this.taskManager.toggleTaskActive(b,d,function(b){c&&c({error:b})})};c.prototype.isTaskRunning=function(b,d){this.taskManager.isTaskRunning(b,function(b,c){d&&d({error:b,data:c})})};c.prototype.getCloudDeviceTriggerGateway=function(b){this.taskManager.getCloudDeviceTriggerGateway(function(d,c){d?b&&b({error:d}):(c||(c={}),b&&b({data:c}))})};c.prototype.importTasks=function(b,d){this.taskManager.import(b,function(b){d&&d({error:b})})};c.prototype.startTaskTrace=function(b,d,c){this.taskManager.startTaskTrace(b,
d,function(b){c&&c({error:b})})};c.prototype.stopTaskTrace=function(b,d,c){this.taskManager.stopTaskTrace(b,d,function(b){c&&c({error:b})})};c.prototype.setAlarmActive=function(b,d,c){this.taskManager.setAlarmActive(b,d,function(b){c&&c({error:b})})};c.prototype.setAlarmDelay=function(b,c,f){this.taskManager.setAlarmDelay(b,c,function(b){f&&f({error:b})})};c.prototype.getAlarmInfo=function(b){this.taskManager.getAlarmInfo(function(c,f){b&&b({error:c,data:f})})};c.prototype.selectAlarmTask=function(b,
c,f,k){this.taskManager.selectAlarmTask(b,c,f,function(b){k&&k({error:b})})};c.prototype.setAlarmPin=function(b,c,f){this.taskManager.setAlarmPin(b,c,function(b){f&&f({error:b})})};c.prototype._getAlarmPin=function(){return this.taskManager._getAlarmPin()};c.prototype.onStatusEvt=function(b,c){c&&"taskman"==c.src&&c.taskID?(this._logger.log("trace","receive for task: "+c.taskID+" status event:"+JSON.stringify(b)),this.taskManager.onStatusEvtForTask(b,c.taskID)):c&&"rehau:alarmTask"==c.src&&c.alarmTaskID?
(this._logger.log("trace","receive for rehau alarm task: "+c.alarmTaskID+" status event:"+JSON.stringify(b)),this._rehauAlarmTaskManager.onStatusEvtForTask(b,c.alarmTaskID)):(this._logger.log("trace","receive status event:"+JSON.stringify(b)),this.taskManager.onStatusEvt(b))};c.prototype.onIREvt=function(b){this._logger.log("trace","receive ir event:"+JSON.stringify(b));this.taskManager.onIREvt(b)};c.prototype.onLocationChange=function(b){this._logger.log("trace","receive location change event:"+
JSON.stringify(b));this.taskManager.onLocationChange(b)};c.prototype.onTimeChange=function(b){this._logger.log("trace","receive time change event:"+JSON.stringify(b));this.taskManager.onTimeChange(b)};c.prototype.onActivation=function(b){this._logger.log("trace","receive activation change event:"+b);var c=!1;"true"==b&&(c=!0);this.taskManager.onActivation(c)};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.taskman.Handler);
