var util=require("util"),taskman=require("x.hub.taskman.js"),actman=require("x.hub.action.js"),commandman=require("x.hub.commandman.js"),eventbus=require("x.hub.eventbus.js"),moment=require("moment-timezone"),x=x||{};x.hub=x.hub||{};x.hub.rule=x.hub.rule||{};
x.hub.rule.RuleManager=function(){var r={getMomentNow:function(){var a=taskman.Util._getTimeZone(),c=(new Date).getTime();return moment.tz(c,a)}},l=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.CronTimer");this._ruleManager=a;this._cronJob=null};l.prototype.start=function(){var a=taskman.Util._getTimeZone();this._logger.log("trace","start cron job:00 * * * * * tz:"+a);this._cronJob=new (require("cron").CronJob)("00 * * * * *",this.onTick.bind(this),null,!0,a)};
l.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer));this._cronJob&&(this._cronJob.stop(),this._cronJob=null)};l.prototype.onTick=function(){this._logger.log("trace","timer tick");this._ruleManager.onTimerTick(r.getMomentNow())};l.prototype.onLocationChange=function(){this.stop();this.start()};l.prototype.onTimeChange=function(){this.stop();this.start()};var m=function(a){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager.Rule.#"+a);this._id=
a;this._ruleManager=this._json=null;this._state=0;this._activateCallbacks=[]};m.prototype.finalize=function(){};m.prototype.executeCommand=function(a,c){a&&a.command?"activate"==a.command?this.setActive(!0,function(a){c&&c(a)}):"deactivate"==a.command?this.setActive(!1,function(a){c&&c(a)}):"execute"==a.command?this.doActions(function(a){c&&c(a)}):c&&c(Error("invalid command")):c&&c(Error("invalid command"))};m.prototype.getStates=function(a){a&&a(null,{active:this.isActive()})};m.prototype.isActive=
function(){return this._json&&1==this._json.active};m.prototype.setActive=function(a,c){if(this._json){var b=this.isActive();if(b&&a||!b&&!a)c&&c();else if(1!=this._state||a)if(2==this._state&&a)c&&c(Error("deactivate process is rinning"));else{if(c&&-1==this._activateCallbacks.indexOf(c)&&this._activateCallbacks.push(c),0==this._state){var e=this;this._state=a?1:2;this[a?"_doActivate":"_doDeactivate"](function(a){e._state=0;var c=e._activateCallbacks;e._activateCallbacks=[];c.forEach(function(c){try{c&&
c(a)}catch(k){}})})}}else c&&c(Error("activate process is rinning"))}else c&&c(Error("invalid rule"))};m.prototype._doActivate=function(a){this._json.active=1;this._ruleManager.onRuleChanged(this._id,function(c){a&&a(c)})};m.prototype._doDeactivate=function(a){this._json.active=0;this._ruleManager.onRuleChanged(this._id,function(c){a&&a(c)})};m.prototype.matchTimeRequirement=function(a){if(!this._json)return!1;var c=this._json,b=taskman.Util._getTimeZone(),e=a.valueOf();if(c.start&&"0000-00-00"!=
c.start){var d=moment.tz(c.start,b);d.set({hour:0,minute:0,second:0,millisecond:0});if(d.valueOf()>e)return!1}return c.end&&"0000-00-00"!=c.end&&(b=moment.tz(c.end,b),b.set({hour:23,minute:59,second:59,millisecond:999}),b.valueOf()<e)||c.days&&(a=a.day(),0==a&&(a=7),"1"!=c.days.charAt(a-1))?!1:!0};m.prototype.getType=function(){return this._json?this._json.type:null};m.prototype.doActions=function(a){if(this._json)if(this._json.actions&&this._json.actions.length){this._logger.log("trace","do actions");
var c=this,b=actman.getActionManager(),e="executeAction";1==this._json.restart&&(e="executeActionSingelton");b[e]("rle:"+this._id,this._json.actions,function(b){c._logger.log("trace","finish do actions "+(b?"failed:"+b.message:"success"));a&&a(b)})}else a&&a();else a&&a(Error("invalid rule"))};m.prototype.onTriggered=function(a,c){this._logger.log("trace","triggered by trigger with index ["+a+"]");this.doActions()};m.prototype.onDeviceEvent=function(a,c,b){if(this._json){var e=this.isActive();b=this.matchTimeRequirement(b);
this._logger.log("trace","active:"+e+" | date match:"+b+" | check device "+a+":"+JSON.stringify(c));if(e&&b){var d=this._json;if(d.trigger&&d.trigger.length){var g=this,t=0,k=[],f=function(b,e){!b&&e&&k.push(t);t++;if(t<d.trigger.length)g._hitDeviceTrigger(t,d.trigger[t],a,c,f);else if(k.length)g.onTriggered(k[0],d.trigger[k[0]]);else g._logger.log("trace","no trigger hit")};this._hitDeviceTrigger(t,d.trigger[t],a,c,f)}}}};m.prototype.onTimerTick=function(a){if(this._json){var c=this.isActive(),b=
this.matchTimeRequirement(a);if(c&&b){var e=this._json;if(e.trigger&&e.trigger.length)for(var d=0;d<e.trigger.length;d++){var g=e.trigger[d];if(this._hitTimeTrigger(g,a)){this._logger.log("trace","active:"+c+" | date match:"+b+" | time trigger hit");this.onTriggered(d,g);break}}}}};m.prototype.toJSON=function(){return this._json};m.prototype._hitDeviceTrigger=function(a,c,b,e,d){a=function(a,c,b){if(!a)return!1;if("event"==c){if(!a.event)return!1;b.sys||(b.sys="mediola");return a.event.sys==b.sys&&
"mediola"==b.sys&&a.event.data?a.event.data.type==b.type&&a.event.data.data==b.data:!1}if("state"==c){if(!(a.state&&a.state.devices&&a.state.devices.length&&a.state.data&&a.state.data.length))return!1;for(c=0;c<a.state.devices.length;c++){var e=a.state.devices[c];if(e){var d=!1;e.id&&e.id==b.id?d=!0:e.device&&e.device.id&&e.device.id==b.sid&&(d=!0);if(d)for(e=0;e<a.state.data.length;e++){var k=a.state.data[e];if(k){var g=k.value;g||(g="state");d=!1;var f=b.changed?-1!=b.changed.indexOf(g):!1;k=k.states;
g=b.state?b.state[g]:null;void 0!=g&&null!=g&&k&&(d="true"==g||1==g?-1!=k.indexOf("true")||-1!=k.indexOf(!0):"false"==g||0==g?-1!=k.indexOf("false")||-1!=k.indexOf(!1):-1!=k.indexOf(g));if(d&&f)return!0}}}}}return!1}(c,b,e);d(null,a)};m.prototype._hitTimeTrigger=function(a,c){if(!a||!a.time)return!1;var b=a.time.split(":");if(2>b.length)return!1;a=parseInt(b[0]);b=parseInt(b[1]);return a==c.hour()&&b==c.minute()};m.parseJSON=function(a,c){if(!a||!c)return null;switch(c.type){case "heatingschedule":a=
new f(a);break;case "link":a=new q(a);break;case "alarm":a=new h(a);break;default:a=new m(a)}a._json=c;return a};var q=function(a){m.call(this,a);this._stateBuffer=null};util.inherits(q,m);q.prototype.onDeviceEvent=function(a,c,b){if(this._json&&(this._logger.log("trace","check link device with "+a+":"+JSON.stringify(c)),this._json.link&&this._json.link.device)){b=this._json.link;var e=b.device;if("state"==a&&c.state&&(a=!1,e.device&&e.device.id&&e.device.id==c.sid&&(a=!0),a)){this._logger.log("trace",
"match link device");a=!1;e=[];if(b.value){var d=!0;c.changed&&-1==c.changed.indexOf(b.value)&&(d=!1);var g=c.state[b.value];void 0!=g&&null!=g&&d&&(a=!0,this._logger.log("trace","match link device state:"+b.value),b.command&&e.push({command:b.command,value:g}))}else if(b.values&&b.values.length)for(var f=0;f<b.values.length;f++){var k=b.values[f];if(!k)return;var h=k.value;h||(h="state");d=!0;c.changed&&-1==c.changed.indexOf(h)&&(d=!1);g=c.state[h];if(void 0!=g&&null!=g&&d){if(k.hyst)if(g=parseFloat(g),
d=this._stateBuffer?this._stateBuffer[h]:null,void 0!=d&&null!=d){if(g-d>k.hyst||d-g>k.hyst)a=!0}else a=!0;else k.states?(1==g||"true"==g?a=-1!=k.states.indexOf(!0)||-1!=k.states.indexOf("true"):0==g||"false"==g?a=-1!=k.states.indexOf(!1)||-1!=k.states.indexOf("false"):-1!=k.states.indexOf(g)&&(a=!0),g=null):a=!0;this._logger.log("trace","match link device values("+f+") state:"+h);if(k.ranges&&k.ranges.length)for(g=parseFloat(g),d=0;d<k.ranges.length;d++){var p=k.ranges[d];if(p&&!(void 0!=p.to&&null!=
p.to&&g>p.to||void 0!=p.from&&null!=p.from&&g<p.from)){var u=null;p.command?u=p.command:k.command&&(u=k.command);p=void 0!=p.value&&null!=p.value?p.value:g;void 0!=u&&null!=u&&e.push({command:u,value:p,source:h})}}else k.command?e.push({command:k.command,value:g,source:h}):e.push({command:g,source:h})}}this._stateBuffer=c.state;a&&e.length&&this._doAction(e)}}};q.prototype._doAction=function(a){if(this._json)if(this._logger.log("trace","forward commands:"+JSON.stringify(a)),this._json.devices&&this._json.devices.length){for(var c=
this._json.devices,b=[],e=0;e<c.length;e++){var d=c[e];if(d)for(var g=0;g<a.length;g++){var f=a[g];if(f){var k=JSON.parse(JSON.stringify(d)),h;for(h in f)k[h]=f[h];b.push(k)}}}if(b.length){this._logger.log("trace","do actions");var p=this;actman.getActionManager().executeActionSingelton("rle:"+this._id,b,function(a){p._logger.log("trace","finish do actions "+(a?"failed:"+a.message:"success"));callback&&callback(a)})}else this._logger.log("trace","no devices")}else this._logger.log("trace","no devices")};
var h=function(a){m.call(this,a);this._triggerDelayTimeout=null};util.inherits(h,m);h.prototype.finalize=function(){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null)};h.prototype._doDeactivate=function(a){var c=this,b=this._json;this._logger.log("trace","do ondeactivation actions");(function(a){var e=function(a,b,e){if(b&&b.state&&b.state.ondeactivate&&b.state.devices&&b.state.devices.length)try{var d=[];b.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));
for(var c in b.state.ondeactivate)a[c]=b.state.ondeactivate[c];d.push(a)});d.length?actman.getActionManager().executeAction("rle:"+c._id+"@t"+a+"-ondeactivate",d,function(a){e(a)}):e()}catch(u){e(u)}else c._logger.log("trace","trigger("+a+") has no ondeactivate actions"),e()},g=function(a){if(b.trigger&&b.trigger.length){var d=0,g=[],f=function(k){c._logger.log("trace","do trigger("+d+") ondeactivation actions "+(k?"fail:"+k.message:"success"));k&&g.push(d);d++;d<b.trigger.length?(c._logger.log("trace",
"do trigger("+d+") ondeactivation actions"),e(d,b.trigger[d],f)):a(g.length?Error("ondeactivation actions failed for triggers ["+g.join(",")+"]"):null)};c._logger.log("trace","do trigger("+d+") ondeactivation actions");e(d,b.trigger[d],f)}else a()};c._logger.log("trace","do main ondeactivation actions");(function(a){b.ondeactivation&&b.ondeactivation.length?actman.getActionManager().executeAction("rle:"+c._id+"@ondeactivation",b.ondeactivation,function(c){a(c)}):a()})(function(b){c._logger.log("trace",
"finish main ondeactivation actions "+(b?"fail:"+b.message:"success"));c._logger.log("trace","do triggers ondeactivation actions");g(function(e){c._logger.log("trace","finish triggers ondeactivation actions "+(e?"fail:"+e.message:"success"));var d=null;if(b||e)d=b?"main ondeactivation failed":"",d=Error(d+((d?", ":"")+e?"triggers ondeactivation failed":""));a(d)})})})(function(b){c._logger.log("trace","finish ondeactivation actions "+(b?"fail:"+b.message:"success"));c._json.active=0;c._logger.log("trace",
"save rule deactivated");c._ruleManager.onRuleChanged(c._id,function(b){c._logger.log("trace","finish save rule deactivated "+(b?"fail:"+b.message:"success"));a&&a(b?Error("save rule deactivated failed:"+b.message):null)})})};h.prototype._doActivate=function(a){var c=this,b=this._json,e=function(a){var e=function(a,b,e){if(b&&b.state&&b.state.onactivate&&b.state.devices&&b.state.devices.length)try{var d=[];b.state.devices.forEach(function(a){a=JSON.parse(JSON.stringify(a));for(var c in b.state.onactivate)a[c]=
b.state.onactivate[c];d.push(a)});d.length?actman.getActionManager().executeAction("rle:"+c._id+"@t"+a+"-onactivate",d,function(a){e(a)}):e()}catch(v){e(v)}else c._logger.log("trace","trigger("+a+") has no onactivate actions"),e()},d=function(a){if(b.trigger&&b.trigger.length){var d=0,g=[],f=function(h){c._logger.log("trace","do trigger("+d+") onactivation actions "+(h?"fail:"+h.message:"success"));h&&g.push(d);d++;d<b.trigger.length?(c._logger.log("trace","do trigger("+d+") onactivation actions"),
e(d,b.trigger[d],f)):a(g.length?Error("onactivation actions failed for triggers ["+g.join(",")+"]"):null)};c._logger.log("trace","do trigger("+d+") onactivation actions");e(d,b.trigger[d],f)}else a()};c._logger.log("trace","do main onactivation actions");(function(a){b.onactivation&&b.onactivation.length?actman.getActionManager().executeAction("rle:"+c._id+"@onactivation",b.onactivation,function(c){a(c)}):a()})(function(b){c._logger.log("trace","finish main onactivation actions "+(b?"fail:"+b.message:
"success"));c._logger.log("trace","do triggers onactivation actions");d(function(e){c._logger.log("trace","finish triggers onactivation actions "+(e?"fail:"+e.message:"success"));var d=null;if(b||e)d=b?"main onactivation failed":"",d=Error(d+((d?",":"")+e?"triggers onactivation failed":""));a(d)})})},d=function(a){b.onchecksuccess&&b.onchecksuccess.length?actman.getActionManager().executeAction("rle:"+c._id+"@onchecksuccess",b.onchecksuccess,function(c){a(c)}):a()},g=function(a){b.oncheckfail&&b.oncheckfail.length?
actman.getActionManager().executeAction("rle:"+c._id+"@oncheckfail",b.oncheckfail,function(c){a(c)}):a()},f=function(a,c){commandman.commandHandlerV6.getDeviceStatesWithStateInfo(a,c)},h=function(a,b,e,d,g){if(d){var h=b.state.check;b=b.state.data;var k=[],m=!0;h&&h.length?(h.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),a.value||(a.value="state"),k.push(a))}),m=!0):b&&b.length&&(b.forEach(function(a){a&&a.states&&a.states.length&&(a=JSON.parse(JSON.stringify(a)),
a.value||(a.value="state"),k.push(a))}),m=!1);k.length?f(d,function(b,d){if(b)c._logger.log("trace","get trigger("+a+") device("+e+") states fail:"+b.message),g(b);else if(d){for(b=0;b<k.length;b++){var f=d[k[b].value];if(void 0==f||null==f){c._logger.log("trace","check trigger("+a+") device("+e+") state "+k[b].value+" fail: value unknown");g(Error("state value unknown"));return}c._logger.log("trace","check trigger("+a+") device("+e+") state "+k[b].value+"="+f);var h=!1;m&&-1!=k[b].states.indexOf(f)?
h=!0:m||-1!=k[b].states.indexOf(f)||(h=!0);if(!h){g(null,h);return}}g(null,!0)}else c._logger.log("trace","check trigger("+a+") device("+e+") state fail: states response is null"),g(Error("states response is null"))}):(c._logger.log("trace","get trigger("+a+") device("+e+") has no states to check"),g(null,!0))}else c._logger.log("trace","get trigger("+a+") device("+e+") json is null"),g(null,!0)},m=function(a,b,e){if(b&&b.state&&b.state.devices&&b.state.devices.length){var d=0,g=function(f,k){c._logger.log("trace",
"check trigger("+a+") device("+d+") "+(f?"fail:"+f.message:"success:match="+k));f||!k?e(f,k):(d++,d<b.state.devices.length?(c._logger.log("trace","check trigger("+a+") device("+d+")"),h(a,b,d,b.state.devices[d],g)):e(null,!0))};c._logger.log("trace","check trigger("+a+") device("+d+")");h(a,b,d,b.state.devices[d],g)}else c._logger.log("trace","trigger("+a+") has no checkable devices"),e(null,!0)};this._logger.log("trace","check triggers (value="+b.checktriggers+")");(function(a){if(1!=b.checktriggers)a();
else if(b.trigger&&b.trigger.length){var d=0,e=function(g,f){c._logger.log("trace","check trigger("+d+") "+(g?"fail:"+g.message:"success:match="+f));g||!f?a(g,f):(d++,d<b.trigger.length?(c._logger.log("trace","check trigger("+d+")"),m(d,b.trigger[d],e)):a(null,!0))};c._logger.log("trace","check trigger("+d+")");m(d,b.trigger[d],e)}else a()})(function(b,f){c._logger.log("trace","finish check triggers "+(b?"fail:"+b.message:"success:match="+f));b||!f?(c._logger.log("trace","do oncheckfail actions"),
g(function(d){c._logger.log("trace","finish oncheckfail actions "+(d?"fail:"+d.message:"success"));var e="check triggers failed:"+(b?b.message:"device state not match");d&&(e+="; oncheckfail actions failed:"+d.message);a&&a(Error(e))})):(c._logger.log("trace","do onchecksuccess actions"),d(function(b){c._logger.log("trace","finish onchecksuccess actions "+(b?"fail:"+b.message:"success"));b?a&&a(Error("onchecksuccess actions failed:"+b.message)):(c._logger.log("trace","do onactivation actions"),e(function(b){c._logger.log("trace",
"finish onactivation actions "+(b?"fail:"+b.message:"success"));c._json.active=1;c._logger.log("trace","save rule activated");c._ruleManager.onRuleChanged(c._id,function(b){c._logger.log("trace","finish save rule activated "+(b?"fail:"+b.message:"success"));a&&a(b?Error("save rule activated failed:"+b.message):null)})}))}))})};h.prototype.onTriggered=function(a,c){this._triggerDelayTimeout&&(clearTimeout(this._triggerDelayTimeout),this._triggerDelayTimeout=null);var b=this;c.delay?(this._logger.log("trace",
"triggered by trigger("+a+") with delay "+c.delay),this._triggerDelayTimeout=setTimeout(function(){b._logger.log("trace","do delayed action by trigger("+a+")");b.doActions()},1E3*c.delay)):(this._logger.log("trace","triggered by trigger("+a+") and do actions"),this.doActions())};h.prototype._hitDeviceTrigger=function(a,c,b,e,d){var g=this;m.prototype._hitDeviceTrigger.call(this,a,c,b,e,function(b,e){b||!e?d(b,e):(c.state&&c.state.ontrigger&&(g._logger.log("trace","do trigger("+a+") ontrigger actions"),
actman.getActionManager().executeAction("rle:"+g._id+"@t"+a+"-ontrigger",c.state.ontrigger,function(b){g._logger.log("trace","do trigger("+a+") ontrigger actions "+(b?"fail:"+b.message:"success"))})),d(null,e))})};var f=function(a){m.call(this,a)};util.inherits(f,m);f.prototype.onTriggered=function(a,c){this._logger.log("trace","triggered by periods with index ["+a+"]");a=JSON.parse(JSON.stringify(c));a.command||(a.command="temperature");if((c=this._json)&&c.devices&&0<c.devices.length){for(var b=
[],e=0;e<c.devices.length;e++){var d=c.devices[e];if(d)try{var g=JSON.parse(JSON.stringify(d)),f;for(f in a)g[f]=a[f];b.push(g)}catch(k){}}this._logger.log("trace","do actions");actman.getActionManager().executeAction("rle:"+this._id,b,function(a){callback&&callback(a)})}};f.prototype.onTimerTick=function(a){if(this._json){var c=this.isActive(),b=this.matchTimeRequirement(a);if(c&&b){var e=this._json;if(e.periods&&0!=e.periods.length)for(var d=0;d<e.periods.length;d++){var g=e.periods[d];if(this._hitPeriodTrigger(g,
a)){this._logger.log("trace","active:"+c+" | date match:"+b+" | time trigger hit");this.onTriggered(d,g);break}}}}};f.prototype.onDeviceEvent=function(a,c,b){};f.prototype._hitPeriodTrigger=function(a,c){if(!a||!a.start)return!1;var b=a.start.split(":");if(2>b.length)return!1;a=parseInt(b[0]);b=parseInt(b[1]);return a==c.hour()&&b==c.minute()};var n=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.RuleManager");this._cronTimer=this._rules=this._dataFolder=null;this._writing=!1;
this._writeCallbacks=[]};n.FILE_NAME="rule.json";n.prototype.init=function(a,c){this._logger.log("info","init rule manager");this._dataFolder=a.getUserRootDataPath();this._cronTimer=new l(this);var b=this;this._loadRules(function(a){a?c&&c(a):b._initRules(function(){c&&c()})})};n.prototype.getRules=function(){return this._rules};n.prototype.getRule=function(a){return this._rules?this._rules[a]:null};n.prototype.setRule=function(a,c,b){if(a){var e=this._rules[a];if(c){this._logger.log("trace","update rule "+
a);var d=m.parseJSON(a,c);if(!d){b&&b(Error("invalid rule json"));return}d._ruleManager=this;this._rules[a]=d}else this._logger.log("trace","delete rule "+a),delete this._rules[a];e&&(this._logger.log("trace","call finialize of old rule "+a),e.finalize());this._writeRules(function(a){b&&b(a,c)})}else b&&b(Error("invalid rule id"))};n.prototype.onRuleChanged=function(a,c){this._writeRules(function(a){c&&c(a)})};n.prototype.onTimerTick=function(a){if(this._rules)for(var c in this._rules){var b=this._rules[c];
if(b)b.onTimerTick(a)}};n.prototype.onLocationChange=function(a){this._logger.log("trace","receive location change event:"+JSON.stringify(a));this._cronTimer.onLocationChange(a)};n.prototype.onTimeChange=function(a){this._logger.log("trace","receive time change event:"+JSON.stringify(a));this._cronTimer.onTimeChange(a)};n.prototype.onDeviceEvent=function(a,c){this._logger.log("trace","receive "+a+" event:"+JSON.stringify(c));var b=r.getMomentNow(),e;for(e in this._rules){var d=this._rules[e];if(d)d.onDeviceEvent(a,
c,b)}};n.prototype._initRules=function(a){this._cronTimer.start();a()};n.prototype._loadRules=function(a){var c=require("fs-extra"),b=this._getFile(),e=this;c.ensureFile(b,function(b){b?a(b):e._loadFile(function(b,c){if(b)a(b);else{e._rules={};if(c)for(var d in c)if(b=m.parseJSON(d,c[d]))b._ruleManager=e,e._rules[d]=b;a()}})})};n.prototype._writeRules=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var c=
this._writeCallbacks;this._writeCallbacks=[];a={};for(var b in this._rules){var e=this._rules[b];e&&e.toJSON&&(a[b]=e.toJSON())}var d=this;this._writeFile(a,function(a){d._writing=!1;c.forEach(function(b){try{b&&b(a)}catch(k){}});d._writeRules()})}};n.prototype._getFile=function(){return require("path").resolve(this._dataFolder,n.FILE_NAME)};n.prototype._loadFile=function(a){var c=require("fs"),b=this._getFile();c.readFile(b,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,
d)}catch(t){a(null,{})}else a(null,{})})};n.prototype._writeFile=function(a,c){var b=require("fs"),e=this._getFile();b.writeFile(e,JSON.stringify(a,null,2),function(a){c&&c(a)})};return n}();
x.hub.rule.Handler=function(){var r=function(){this._logger=require("x.logger.js").getLogger("x.hub.rule.Handler");this._ruleManager=new x.hub.rule.RuleManager};r.prototype.init=function(l,m,q){var h=this;eventbus.on("locationchange",this._onLocationChange.bind(this));eventbus.on("timechange",this._onTimeChange.bind(this));eventbus.on("gatewayevent",function(f,m,a){h._onGatewayEvent(f,m,a)});"CA"==global.HARDWARE_VERSION?this._initHttpApiNew(l):this._initHttpApi(l);this._ruleManager.init(m,function(f){f&&
q(f)})};r.prototype.getRuleManager=function(){return this._ruleManager};r.prototype._onLocationChange=function(l){this._logger.log("trace","receive location change event:"+JSON.stringify(l));this._ruleManager.onLocationChange(l)};r.prototype._onTimeChange=function(l){this._logger.log("trace","receive time change event:"+JSON.stringify(l));this._ruleManager.onTimeChange(l)};r.prototype._onGatewayEvent=function(l,m,q){this._logger.log("trace","receive gateway "+q+" event:"+JSON.stringify(l)+" from:"+
JSON.stringify(m));if(m&&"ST"==m.address){var h="STA"==q?"state":"event";if(l){var f=this;process.nextTick(function(){f._ruleManager.onDeviceEvent(h,l)})}}};r.prototype._initHttpApiNew=function(l){var m=this;l=require("x.hub.js").getServer();l.addRoute("/api/rules",{method:"GET"},function(l,h,f){l=m._ruleManager.getRules();h.json({XC_SUC:l?l:{}})});l.addRoute("/data/rle/",{method:"GET"},function(l,h,f){l=l.path.substr(10);(l=m._ruleManager.getRule(l))?h.json({XC_SUC:l}):h.json({XC_ERR:{code:"000101",
msg:"failed to open file"}})});l.addRoute("/data/rle/",{method:"POST",lock:1},function(l,h){var f=l.path.substr(10);try{m._ruleManager.setRule(f,l.json,function(f,a){f?h.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+f.message}}):a?h.json({XC_SUC:{bytes:l.size}}):h.json({XC_SUC:{bytes:0}})})}catch(n){h.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+n.message}})}});l.addRoute("/api/trigger",{method:"POST"},function(l,h){try{var f=l.json;f&&"time"==f.type&&f.value?(h.json({XC_SUC:{}}),
process.nextTick(function(){var h=require("moment-timezone"),a=taskman.Util._getTimeZone(),c=parseInt(f.value.split(":")[0]),b=parseInt(f.value.split(":")[1]),e=new Date;e.setHours(c);e.setMinutes(b);e=h.tz(e.getTime(),a);m._ruleManager.onTimerTick(e)})):f&&"event"==f.type&&f.value?(h.json({XC_SUC:{}}),process.nextTick(function(){m._ruleManager.onDeviceEvent(f.type,f.value)})):f&&"state"==f.type&&f.value?(h.json({XC_SUC:{}}),process.nextTick(function(){m._ruleManager.onDeviceEvent(f.type,f.value)})):
h.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(n){h.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+n.message}})}})};r.prototype._initHttpApi=function(l){var m=this,q=require("x.hub.js").getServer();l.get("/api/rules",function(h,f,l){q.auth(h)?(h=m._ruleManager.getRules(),f.json({XC_SUC:h?h:{}})):f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.get("/data/rle/:id",function(h,f,l){q.auth(h)?(h=m._ruleManager.getRule(h.params.id))?f.json({XC_SUC:h}):f.json({XC_ERR:{code:"000101",
msg:"failed to open file"}}):f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.post("/data/rle/:id",function(h,f){if(q.auth(h)){var l=new Buffer(0);h.on("data",function(a){l=Buffer.concat([l,a])});h.on("end",function(){var a=h.params.id,c=l.toString("utf8");try{var b=null;c&&(b=JSON.parse(c));m._ruleManager.setRule(a,b,function(a,b){a?f.json({XC_ERR:{code:"000101",msg:"failed to set rule:"+a.message}}):b?f.json({XC_SUC:{bytes:l.length}}):f.json({XC_SUC:{bytes:0}})})}catch(e){f.json({XC_ERR:{code:"000101",
msg:"failed to set rule:"+e.message}})}})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})});l.post("/api/trigger",function(h,f){if(q.auth(h)){var l=new Buffer(0);h.on("data",function(a){l=Buffer.concat([l,a])});h.on("end",function(){var a=l.toString("utf8");try{var c=null;a&&(c=JSON.parse(a));if(c&&"time"==c.type&&c.value){var b=require("moment-timezone"),e=taskman.Util._getTimeZone(),d=parseInt(c.value.split(":")[0]),g=parseInt(c.value.split(":")[1]),h=new Date;h.setHours(d);h.setMinutes(g);
h=b.tz(h.getTime(),e);m._ruleManager.onTimerTick(h);f.json({XC_SUC:{}})}else f.json({XC_ERR:{code:"000101",msg:"unknown trigger type"}})}catch(k){f.json({XC_ERR:{code:"000101",msg:"failed to trigger:"+k.message}})}})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})})};return r}();module.exports=new x.hub.rule.Handler;
