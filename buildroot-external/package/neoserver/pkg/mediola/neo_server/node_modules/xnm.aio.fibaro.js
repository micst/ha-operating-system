var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.fibaro=xnm.aio.fibaro||{};xnm.aio.fibaro.Util={clearHttpOptionForLog:function(e){try{var b=JSON.parse(JSON.stringify(e));b.auth&&(b.auth="xxxxxx:xxxxxx");if(b.headers)for(var a in headers)if(a&&"authorization"==a.toLocaleLowerCase()){var c=headers[a];if(c){var d=c.indexOf(" ");headers[a]=-1==d?"xxxxxx":c.substr(0,d)+" xxxxxx"}}return b}catch(f){return e}}};
xnm.aio.fibaro.HomeCenter=function(){var e=function(b,a,c,d,f){var k=require("x.logger.js");this._logger=k?k.getLogger("xnm.aio.fibaro.HomeCenter"):{log:function(){}};this.ip=b;this.uuid=d;this.user=a;this.password=c;this.name=f;this.CommandHandler=null;this._getStatesCBs=[]};e.ACTION_LIST="turnOn turnOff setValue startLevelIncrease startLevelDecrease stopLevelChange close open stop pressButton setArmed setSetpointMode setThermostatSetpoint setMode setFanMode setTargetLevel setTime setColor startProgram".split(" ");
e.PROPERTY_LIST="value state batteryLevel power energy armed tamper on mute volume mode targetLevel wakeUpTime Humidity Pressure Temperature WeatherCondition Wind".split(" ");e.SET_POINT_MODES=["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"];e.OP_MODES="OFF HEATING COOLING AUTO PENDING_HEAT PENDING_COOL VENT_ECONOMIZER AUX_HEATING 2ND_STAGE_HEATING 2ND_STAGE_COOLING 2ND_STAGE_AUX_HEAT 3RD_STAGE_AUX_HEAT".split(" ");
e.FAN_MODES="AUTO_LOW LOW AUTO_HIGH HIGH AUTO_MEDIUM MEDIUM CIRCULATION HUMIDITY LEFT_RIGHT UP_DOWN QUIET 3RD_STAGE_AUX_HEAT".split(" ");e.prototype._callAction=function(b,a,c,d){b="/api/callAction?deviceID="+b+"&name="+a;for(a=0;a<c.length;a++)b+="&arg"+(a+1)+"="+encodeURIComponent(c[a]);this._doRestApi("GET",b,null,function(a,c){d&&d(a,c)})};e.prototype._getRooms=function(b){this._doRestApi("GET","/api/rooms",null,function(a,c){b&&b(a,c)})};e.prototype._getDevices=function(b){this._doRestApi("GET",
"/api/devices",null,function(a,c){b&&b(a,c)})};e.prototype._getGlobalVariables=function(b){this._doRestApi("GET","/api/globalVariables",null,function(a,c){b&&b(a,c)})};e.prototype._setGlobalVariableValue=function(b,a,c){this._doRestApi("PUT","/api/globalVariables/"+b,JSON.stringify({name:b,value:a+""}),function(a,b){c&&c(a,b)})};e.prototype._doRestApi=function(b,a,c,d){this._doRequest(b,a,c,function(a,c,b){if(a)a.code="timeout"==a.reason?2:1,d&&d(a);else if(200!=b&&202!=b)a=Error("http result status code:"+
b),a.code=b,d&&d(a);else try{var f=JSON.parse(c);d&&d(null,f)}catch(m){m.code=3,d&&d(m)}})};e.prototype._doRequest=function(b,a,c,d){b={host:this.ip,path:a,method:b,headers:{Authorization:"Basic "+(new Buffer(this.user+":"+this.password)).toString("base64"),Connection:"close","Content-Type":"text/plain"}};c&&(b.headers["Content-Length"]=c.length);var f=this;a=require("http");this._logger.log("trace","do http request:"+JSON.stringify(xnm.aio.fibaro.Util.clearHttpOptionForLog(b)));b=a.request(b,function(a){a.setEncoding("utf-8");
var c="";a.on("data",function(a){c+=a});a.on("end",function(){f._logger.log("trace","receive http response:"+c+" with code:"+a.statusCode);d&&d(null,c,a.statusCode);d=null})});b.on("error",function(a){f._logger.log("warn","do http request error:"+a.message);d&&d(a);d=null});b.setTimeout(4E3,function(){f._logger.log("warn","do http request timeout");var a=Error("timeout");a.reason="timeout";d&&d(a);d=null});c&&b.write(c);b.end()};e.prototype.executeCommandCreator=function(b,a,c){if(b&&b.address)if(a&&
a.value){var d=a.value;if("global_variable"==b.type)d=a.ext;else if("setSetpointMode"==d){if(!a.ext){c&&c(Error("setSetpointMode invalid"));return}a=e.SET_POINT_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setSetpointMode mode"));return}d+=a}else if(0==d.indexOf("setThermostatSetpoint")){if(!a.ext){c&&c(Error("setThermostatSetpoint invalid"));return}d+=":"+a.ext}else if("setMode"==d){if(!a.ext){c&&c(Error("setMode invalid"));return}a=e.OP_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setMode mode"));
return}d+=a}else if("setFanMode"==d){if(!a.ext){c&&c(Error("setFanMode invalid"));return}a=e.FAN_MODES.indexOf(a.ext);if(-1==a){c&&c(Error("unknown setFanMode mode"));return}d+=a}else if(0==d.indexOf("setTargetLevel")){if(!a.ext){c&&c(Error("setTargetLevel invalid"));return}d+=a.ext}else if(0==d.indexOf("setTime")){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("setTime invalid"));return}d+=a.ext}else if("rgbw"==d){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("rgbw invalid"));return}d=
"setColor"+a.ext}else if("startProgram"==d){if("undefined"==typeof a.ext||null==a.ext){c&&c(Error("startProgram invalid"));return}d+=a.ext}else"undefined"!=typeof a.ext&&null!=a.ext&&("setValue"==d&&(d+=a.ext),"disarm"==d&&(d+=a.ext));this.executeCommand(b,d,function(a,b){c&&c(a,b)})}else c&&c(Error("command invalid"));else c&&c(Error("device invalid"))};e.prototype.getStatesCreator=function(b,a,c){if(a)if(0==a.length)c&&c(null,[]);else if(a){for(var d=[],f=0;f<a.length;f++){var k=a[f];k&&k.device&&
k.device.address&&d.push(k.device.address)}this.getStates(b,d,function(b,d,f){if(b)c&&c(b);else{b=[];if(d)for(var k=0;k<a.length;k++)if(a[k]){var m=a[k].id,g=a[k].device,h=a[k].status;if(m&&h&&h.value&&g&&g.address){var l="?";if("global_variable"==g.type)g=f[g.address],l=parseInt(g);else if(g=d[g.address])switch(h.value){case "onoffValue":l=g.value;l="true"==l?"on":"off";break;case "intValue":l=g.value;l=parseInt(l);break;case "boolValue":l=g.value;break;case "floatValue":l=g.value;l=parseFloat(l);
break;case "setpointMode":l=g.mode;l=e.SET_POINT_MODES[parseInt(l)];break;case "opMode":l=g.mode;l=e.OP_MODES[parseInt(l)];break;case "fanMode":l=g.mode;l=e.FAN_MODES[parseInt(l)];break;default:l=g[h.value]}if("undefined"==typeof l||null==l)l="?";b.push({id:m,status:l})}}c&&c(null,b)}})}else c&&c(Error("deviceList is null"));else c&&c(Error("deviceList is null"))};e.prototype.getDevices=function(b){var a={},c={};a[0]={name:"Unassigned"};var d=this;this._getRooms(function(f,e){if(f)b&&b(f);else{if(e)for(f=
0;f<e.length;f++)a[e[f].id]={name:e[f].name,section:e[f].sectionID};d._getDevices(function(f,e){if(f)b&&b(f);else{if(e)for(f=0;f<e.length;f++){var g=e[f];g.visible&&"HC_user"!=g.type&&(c[g.id]={sys:"fibaro",name:g.name,address:g.id,room:g.roomID,type:g.type,baseType:g.baseType,actions:g.actions,states:g.properties})}d._getGlobalVariables(function(d,f){if(d)b&&b(d);else{d={};for(var e=0;e<f.length;e++){var g=f[e];g&&g.name&&(d[g.name]={sys:"fibaro",name:g.name,address:g.name,readOnly:g.readOnly,isEnum:g.isEnum,
type:"global_variable"})}b&&b(null,{rooms:a,devices:c,variables:d})}})}})}})};e.prototype.executeCommand=function(b,a,c){if("global_variable"==b.type)"undefined"==typeof a&&null==a?c&&c(Error("command ext invalid")):this._setGlobalVariableValue(b.address,a,function(a){c&&c(a)});else{var d=a,f=[];if("number"==typeof a)d="setValue",f.push(a);else if("string"==typeof a)if("on"==a)d="turnOn";else if("off"==a)d="turnOff";else{if("toggle"==a){var e=this;this._getDevices(function(a,d){if(a)c&&c(a);else{a=
null;for(var f=0;f<d.length;f++){var g=d[f];if(g.id&&g.properties&&g.id==b.address){"false"==g.properties.value?a="on":"true"==g.properties.value&&(a="off");break}}a?e.executeCommand(b,a,c):c&&c(Error("device has no on/off state"))}});return}if("arm"==a)d="setArmed",f=[1];else if(0==a.indexOf("disarm"))f=[0],f.push(a.replace(/disarm/g,"")),d="setArmed";else if(0==a.indexOf("dimTo"))f.push(parseInt(a.replace(/dimTo/g,""))),d="setValue";else if(0==a.indexOf("moveTo"))f.push(parseInt(a.replace(/moveTo/g,
""))),d="setValue";else if(0==a.indexOf("setTo"))f.push(parseInt(a.replace(/setTo/g,""))),d="setValue";else if(0==a.indexOf("setValue"))f.push(parseInt(a.replace(/setValue/g,""))),d="setValue";else if(0==a.indexOf("setSetpointMode"))f.push(parseInt(a.replace(/setSetpointMode/g,""))),d="setSetpointMode";else if(0==a.indexOf("setThermostatSetpoint"))a=a.replace(/setThermostatSetpoint/g,""),a=a.split(":"),f.push(parseInt(a[0]),parseFloat(a[1])),d="setThermostatSetpoint";else if(0==a.indexOf("setMode"))f.push(parseInt(a.replace(/setMode/g,
""))),d="setMode";else if(0==a.indexOf("setFanMode"))f.push(parseInt(a.replace(/setFanMode/g,""))),d="setFanMode";else if(0==a.indexOf("setTargetLevel"))f.push(parseFloat(a.replace(/setTargetLevel/g,""))),d="setTargetLevel";else if(0==a.indexOf("setTime"))f.push(parseInt(a.replace(/setTime/g,""))),d="setTime";else if(0==a.indexOf("setColor")){var g=a.replace(/setColor/g,"");f=g.substr(0,2);a=g.substr(2,2);d=g.substr(4,2);g=g.substr(6,2);f=[parseInt(f,16),parseInt(a,16),parseInt(d,16),parseInt(g,16)];
d="setColor"}else 0==a.indexOf("startProgram")?(f.push(parseInt(a.replace(/startProgram/g,""))),d="startProgram"):d=a}this._callAction(b.address,d,f,function(a,d){c&&c(a,d)})}};e.prototype.getStates=function(b,a,c){c||(c=function(){});var d=this._getStatesCBs.length;-1==this._getStatesCBs.indexOf(c)&&this._getStatesCBs.push(c);if(!(0<d)){var f=this;this.CommandHandler=b;this._getGlobalVariables(function(c,d){if(c){d=f._getStatesCBs;f._getStatesCBs=[];for(var b=0;b<d.length;b++)d[b](c)}else{var g=
{};for(b=0;b<d.length;b++)(c=d[b])&&c.name&&(g[c.name]=c.value);f._getDevices(function(c,d){if(c){d=f._getStatesCBs;f._getStatesCBs=[];for(var b=0;b<d.length;b++)d[b](c)}else{c={};for(b=0;b<d.length;b++){var k=d[b];if(k.id&&k.properties&&(null==a||-1!=a.indexOf(k.id))){c[k.id]={};for(var m in k.properties)-1!=e.PROPERTY_LIST.indexOf(m)&&(c[k.id][m]=k.properties[m])}}d=f._getStatesCBs;f._getStatesCBs=[];for(b=0;b<d.length;b++)d[b](null,c,g)}})}})}};e.prototype.getStateValues=function(b,a){return a};
e.prototype.toJSON=function(){return{sys:"fibaro",ip:this.ip,username:this.user,password:this.password,uuid:this.uuid,name:this.name}};e.prototype.equalsTo=function(b){return b&&b instanceof e?this.ip==b.ip&&this.user==b.user&&this.password==b.password:!1};e.Discovery=function(){this._homeCenters=[];this._sockets=[];this._searchTimeout=null;this._running=!1;this._listeners=[];this._callbacks=[];var b=require("x.logger.js");this._logger=b?b.getLogger("xnm.aio.fibaro.HomeCenter.Discovery"):{log:function(){}};
this.discoverHomeCenters=function(a,c,b){c&&-1==this._listeners.indexOf(c)&&this._listeners.push(c);b&&-1==this._callbacks.indexOf(b)&&this._callbacks.push(b);a||(a=5E3);if(!this._running){this._logger.log("debug","start search home center");var d=this;this._running=!0;this._createSockets(function(c){c?d._finishDiscover(c):(d._sendDiscoveryMessages(),d._searchTimeout=setTimeout(function(){d._finishDiscover(null,d._homeCenters)},a))})}};this._createSockets=function(a){var c=require("os");require("dgram");
var b=this;if(c&&c.networkInterfaces){c=c.networkInterfaces();var f=[];for(n in c)if(c.hasOwnProperty(n))for(var e=c[n],g=0;g<e.length;g++)"IPv4"==e[g].family&&0==e[g].internal&&f.push(e[g]);var h=0,m=0;var n=function(c,d){h++;c&&(m++,d&&(d=b._sockets.indexOf(d),-1!=d&&b._sockets.splice(d,1)));h==f.length&&(m==h?a&&a(c):a&&a())};for(c=0;c<f.length;c++)this._addDiscoverSocket(44444,f[c],n)}else this._addDiscoverSocket(44444,null,function(c,d){c&&d&&(d=b._sockets.indexOf(d),-1!=d&&b._sockets.splice(d,
1));a&&a(c)})};this._closeSockets=function(){for(var a=0;a<this._sockets.length;a++)this._sockets[a].close()};this._addDiscoverSocket=function(a,c,b){var d=this,e=require("dgram");try{var g=e.createSocket({reuseAddr:!0,type:"udp4"})}catch(h){g=e.createSocket("udp4")}g.on("listening",function(){g.setBroadcast(!0);g._listening=!0;d._logger.log("trace","success to bind on port:"+a+(c?" with interface:"+c.address:""));b&&b(null,g)});g.on("message",function(a,c){d._receivedData(c.address,a)});g.on("error",
function(f){g._listening||(d._logger.log("trace","failed to bind on port:"+a+(c?" with interface:"+c.address:"")),b&&b(f,g))});try{c?(d._logger.log("trace","try to bind on port:"+a+" with interface:"+c.address),g.bind(a,c.address)):(d._logger.log("trace","try to bind on port:"+a),g.bind(a)),this._sockets.push(g)}catch(h){b&&b(h)}};this._sendDiscoveryMessages=function(){for(var a=new Buffer([70,73,66,65,82,79]),c=0;c<this._sockets.length;c++)this._sockets[c].send(a,0,a.length,44444,"255.255.255.255")};
this._receivedData=function(a,c){c=c.toString("hex");c=new Buffer(c,"hex");if(3<=c.length&&(c=c.toString(),this._logger.log("trace","receive packet:"+c+" from:"+a),c=c.split(" "),3==c.length&&"ACK"==c[0])){a=new e(a,null,null,c[2]);a.name=c[1];var b=!1;for(c=0;c<this._homeCenters.length;c++){var f=this._homeCenters[c];if(f&&f.uuid==a.uuid){b=!0;break}}if(!b)for(this._homeCenters.push(a),b=0;c<this._listeners.length;b++)this._listeners[b](a)}};this._finishDiscover=function(a,c){var b=this._callbacks;
this._closeSockets();this._sockets=[];this._homeCenters=[];this._running=!1;this._listeners=[];this._callbacks=[];for(var f=0;f<b.length;f++){var e=b[f];e&&e(a,c)}}};return e}();
xnm.aio.fibaro.DM=function(){var e=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};e.prototype=Error();e.prototype.name="FibaroDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"fibaro",getGatewayType:function(){return[{sys:this.SYS,name:"FIBARO Home Center 2"}]},getGatewayDeviceType:function(){return[]},createGateway:function(b,a,c){a=e.ERROR_CODE;b?b.ip?b.username?b.password?c(null,b):c(new e(a.INVALID,
"password is invalid")):c(new e(a.INVALID,"username is invalid")):c(new e(a.INVALID,"ip is invalid")):c(new e(a.INVALID,"info is invalid"))},updateGateway:function(b,a,c,d){b=e.ERROR_CODE;a?a.ip?a.username?a.password?d(null,a):d(new e(b.INVALID,"password is invalid")):d(new e(b.INVALID,"username is invalid")):d(new e(b.INVALID,"ip is invalid")):d(new e(b.INVALID,"update is invalid"))},deleteGateway:function(b,a,c){c()},createDevice:function(b,a,c){var d=e.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&
a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){var k=a[f];break}k?c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new e(d.INVALID,"type is invalid"));else c(new e(d.INVALID,"address is invalid"));else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,"info is invalid"))},updateDevice:function(b,a,c){var d=
e.ERROR_CODE;if(b)if(b.gateway)if(b.address)if(b.type)if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===b.gateway){var k=a[f];break}k?c(null,b):c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"))}else c(new e(d.NOT_FOUND,"gateway with index "+b.gateway+" not exists"));else c(new e(d.INVALID,"type is invalid"));else c(new e(d.INVALID,"address is invalid"));else c(new e(d.INVALID,"gateway is invalid"));else c(new e(d.INVALID,
"info is invalid"))},deleteDevice:function(b,a,c){c()},applyUIFilter:function(b,a){var c=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,c,b){var f=[];switch(b.catagory){case "command":a.command&&a.command.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(b.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),f.push(a))})}return f},e=function(a,
b){var d=[],e=c.getCommandStatusMap(a);e&&(a=f(e,a,b),d=d.concat(a));return d};if(!b||null==b.type||"undefined"==typeof b.type)return null;var g=JSON.parse(JSON.stringify(b)),h=null;switch(a.catagory){case "command":h=e(b,a);g.command=h;break;case "status":h=e(b,a);g.status=h;break;default:return null}return h&&0!=h.length?g:null},getCommandStatusMap:function(b){if(!b)return null;var a={command:[],status:[]};if("global_variable"==b.type)return b.readOnly||a.command.push({type:"int",name:"set value",
ref:{value:"setValue",ext:"%d"}}),a.status.push({type:"int",name:"value",ref:{value:"value"}}),a;var c=b.actions,d=b.states;if(c)for(var f in c)if(f&&-1!=xnm.aio.fibaro.HomeCenter.ACTION_LIST.indexOf(f))switch(f){case "turnOn":a.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case "turnOff":a.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case "setValue":a.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d",extMeta:"0-100"}});break;case "startLevelIncrease":a.command.push({type:"enum",
name:"up",ref:{value:"startLevelIncrease"}});break;case "startLevelDecrease":a.command.push({type:"enum",name:"down",ref:{value:"startLevelDecrease"}});break;case "stopLevelChange":a.command.push({type:"enum",name:"stop level change",ref:{value:"stopLevelChange"}});break;case "setArmed":a.command.push({type:"enum",name:"arm",ref:{value:"arm"}});a.command.push({type:"string",name:"disarm",ref:{value:"disarm",ext:"%s",unit:"(pin)"}});break;case "setTargetLevel":b&&"com.fibaro.hvac"==b.baseType?a.command.push({type:"float",
name:"set point",ref:{value:"setTargetLevel",ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}}):a.command.push({type:"float",name:"set target level",ref:{value:"setTargetLevel",ext:"%f"}});break;case "setTime":a.command.push({type:"int",name:"set time",ref:{value:"setTime",ext:"%d",extMeta:"0-21600",unit:"s"}});break;case "setSetpointMode":if(d&&d.supportedModes){var e=d.supportedModes.split(",");if(0<e.length){var g={type:"enum",name:"set point mode",ref:{value:"setSetpointMode",ext:"%e",extMeta:[]}};e.forEach(function(a){(a=
xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(a)])&&g.ref.extMeta.push(a)});a.command.push(g)}}break;case "setThermostatSetpoint":d&&d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&e.forEach(function(b){var c=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(b)];c&&a.command.push({type:"float",name:"set point ("+c+")",ref:{value:"setThermostatSetpoint"+b,ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}})}));break;case "setMode":d&&d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&
(g={type:"enum",name:"set op mode",ref:{value:"setMode",ext:"%e",extMeta:[]}},e.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(a)])&&g.ref.extMeta.push(a)}),a.command.push(g)));break;case "setFanMode":d&&d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&(g={type:"enum",name:"set fan mode",ref:{value:"setFanMode",ext:"%e",extMeta:[]}},e.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(a)])&&g.ref.extMeta.push(a)}),a.command.push(g)));break;case "setColor":a.command.push({type:"rgbw",
name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}});break;case "startProgram":a.command.push({type:"int",name:"start program",ref:{value:"startProgram",ext:"%d"}});break;default:a.command.push({type:"enum",name:f,ref:{value:f}})}if(d)for(var h in d)if(h&&-1!=xnm.aio.fibaro.HomeCenter.PROPERTY_LIST.indexOf(h))switch(h){case "value":c&&c.setValue?a.status.push({type:"int",name:"value",ref:{value:"intValue",ext:"%d"}}):c&&c.setThermostatSetpoint?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",
ext:"%f"}}):b&&"com.fibaro.hvac"==b.baseType?a.status.push({type:"float",name:"set point value",ref:{value:"floatValue",ext:"%f"}}):c&&"undefined"!=typeof c.turnOn&&null!=c.turnOn?(a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}}),a.status.push({type:"enum",name:"value",ref:{value:"onoffValue",options:["on","off"]}})):"true"==d.value||"false"==d.value?a.status.push({type:"enum",name:"value",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"value",
ref:{value:"floatValue",ext:"%f"}});break;case "targetLevel":c&&c.setThermostatSetpoint?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):b&&"com.fibaro.hvac"==b.baseType?a.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):a.status.push({type:"float",name:"target level",ref:{value:"targetLevel",ext:"%f"}});break;case "mode":c&&c.setSetpointMode?d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&(g={type:"enum",name:"set point mode",
ref:{value:"setpointMode",options:[]}},e.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(a)])&&g.ref.options.push(a)}),a.status.push(g))):c&&c.setMode?d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&(g={type:"enum",name:"op mode",ref:{value:"opMode",options:[]}},e.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(a)])&&g.ref.options.push(a)}),a.status.push(g))):c&&c.setFanMode?d.supportedModes&&(e=d.supportedModes.split(","),0<e.length&&(g={type:"enum",
name:"fan mode",ref:{value:"fanMode",options:[]}},e.forEach(function(a){(a=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(a)])&&g.ref.options.push(a)}),a.status.push(g))):"true"==d.value||"false"==d.value?a.status.push({type:"enum",name:"state",ref:{value:"boolValue",options:["true","false"]}}):a.status.push({type:"float",name:"state",ref:{value:"floatValue",ext:"%f"}});break;case "armed":case "tamper":a.status.push({type:"enum",name:h,ref:{value:h,options:["true","false"]}});break;case "WeatherCondition":a.status.push({type:"string",
name:h,ref:{value:h}});break;default:a.status.push({type:"float",name:h,ref:{value:h,ext:"%f"}})}return a}}}();
xnm.aio.fibaro.Handler=function(){var e=function(){this.detectedHomecenters={};this.discovery=new this.HomeCenter.Discovery};e.prototype.HomeCenter=xnm.aio.fibaro.HomeCenter;e.prototype.devicemanager=xnm.aio.fibaro.DM;e.prototype.registModule=function(b){b.register(this.devicemanager.SYS,"fibaro")};e.prototype.discoverHomeCenters=function(b,a){this.discovery.discoverHomeCenters(b,null,function(b,d){a&&a(b,d)})};e.prototype.resolveGateway=function(b){return b&&b.ip&&b.username?new this.HomeCenter(b.ip,
b.username,b.password,b.uuid,b.name):null};e.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};e.prototype.getDeviceStatus=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};e.prototype.doCommand=function(b,a,c,d){(b=this.resolveGateway(b))?b.executeCommandCreator(a,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};e.prototype.doStatus=
function(b,a,c,d,e){(a=this.resolveGateway(a))?a.getStatesCreator(null,[{id:b,device:c,status:d}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};e.prototype.getDeviceList=function(b,a){(b=this.resolveGateway(b))?b.getDevices(function(b,d){a&&a(b,d)}):a&&a(Error("gateway json format invalid"))};e.prototype.getStateValues=function(b,a){return(new xnm.aio.fibaro.HomeCenter).getStateValues(b.type,a)};e.prototype.getDeviceCommandList=function(b,a,c){a=[];if(b.actions)for(var d in b.actions)switch(d){case "setVolume":a.push({id:d,
cmd:"setTo",step:"1",min:"0",max:"100"});break;default:a.push({id:d,cmd:d})}return a};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fibaro.Handler);
