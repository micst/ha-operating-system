var x=x||{};x.hub=x.hub||{};x.hub.deviceman=x.hub.deviceman||{};
x.hub.deviceman.DeviceManager=function(){var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager");this._tenant=null;this._folder=a;this._folder||(this._folder="db");this._tenantIdx=b;this._tenantIdx||(this._tenantIdx=1)};d.prototype.init=function(a,b){this._logger.log("info","init device managaer:"+this._folder);var c=require("m.aio.configmanager.js");a=this._generateTenantParent(a);this._tenant=new c.Tenant(a);this._tenant.index=this._tenantIdx;this._tenant.license=
"dummy";this._tenant.folder=this._folder;var e=this;require("fs-extra").ensureDir(this._tenant.getFolderPath(),function(){e._load(b)})};d.prototype.reload=function(a){var b=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(c){c&&b._logger.log("warn","reload device error:"+c.message);a&&a(c)})};d.prototype.execute=function(a,b,c,e,f){try{require("m.aio.devicemanager.js").execute(a,this._tenant.index,c,e,f)}catch(g){console.error(g.stack)}};d.prototype.getDeviceInfo=function(){var a=
require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return a?a.getDeviceInfo():null};d.prototype.findDevice=function(a,b){var c=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return c?c.findDeviceIgnoreLicense(a,b):null};d.prototype.findGateway=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.findGatewayIgnoreLicense(a):null};d.prototype.findGatewayWithIndex=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);
return b?b.findGatewayWithIndexIngnoreLicense(a):null};d.prototype.findDeviceWithIndex=function(a){var b=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return b?b.findDeviceWithIndexIngnoreLicense(a):null};d.prototype.getAllGeneralDevice=function(a){var b=this;require("m.aio.devicemanager.js").execute("readWithoutLicense",this._tenant.index,"device",{filter:"prop","cloud.enabled":!0},function(c,e){if(c)a&&a(c);else{var f=[];if(e&&0!=e.length){var g=0,d=function(c,h){!c&&h&&(h._origin=
e[g],f.push(h));g++;g<e.length?b.toGeneralDevice(e[g].index,d):a&&a(null,f)};b.toGeneralDevice(e[g].index,d)}else a&&a(null,f)}})};d.prototype.toGeneralDevice=function(a,b){require("m.aio.devicemanager.js").toGeneralDevice(this._tenant.index,a,!0,function(a,e){b&&b(a,e)})};d.prototype.getOwnIdx=function(){return localStorage?localStorage.getItem("x.hub.m.gateway.DB"+this._tenantIdx+"NeoIdx"):-1};d.prototype._load=function(a){var b=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(c){c&&
b._logger.log("warn","init device error:"+c.message);a&&a(c)})};d.prototype._generateTenantParent=function(a){return{fileManager:a,getFolderPath:function(){return this.fileManager.getUserRootDataPath()},getFolder:function(){return""}}};return d}();
x.hub.deviceman.DeviceManagerV6=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManagerV6");this._devices=this._dataFolder=null;this._statesBuffer={}};d.FILE_NAME="db_v6.enc";d.prototype.getGateways=function(){return this._devices&&this._devices.gateways?this._devices.gateways:{}};d.prototype.getGateway=function(a){return this._devices&&this._devices.gateways&&this._devices.gateways[a]?this._devices.gateways[a]:null};d.prototype.setGateway=function(a,
b,c){a?(b?this._devices.gateways[a]=b:delete this._devices.gateways[a],this._writeDB(function(a){c&&c(a,b)})):c&&c(Error("invalid gateway id"))};d.prototype.getDevices=function(){return this._devices&&this._devices.devices?this._devices.devices:{}};d.prototype.getDevice=function(a){return this._devices&&this._devices.devices&&this._devices.devices[a]?this._devices.devices[a]:null};d.prototype.setDevice=function(a,b,c){a?(b?this._devices.devices[a]=b:(delete this._devices.devices[a],delete this._statesBuffer[a]),
this._writeDB(function(a){c&&c(a,b)})):c&&c(Error("invalid device id"))};d.prototype.setBufferedStates=function(a,b){a&&(b?this._statesBuffer[a]=b:delete this._statesBuffer[a])};d.prototype.getAllBufferedStates=function(){return this._statesBuffer};d.prototype.init=function(a,b,c){var e=require("path");b=b.getUserRootDataPath();this._dataFolder=e.resolve(b,"db_v6");this._logger.log("info","init device manager v6:"+this._dataFolder);"CA"==global.HARDWARE_VERSION?this._initHttpApi(a):this._initHttpApiOld(a);
this._loadDB(function(a){c&&c(a)})};d.prototype._initHttpApi=function(a){var b=this;a=require("x.hub.js").getServer();a.addRoute("/api/gateways",{method:"GET"},function(a,e,f){a=b.getGateways();e.json({XC_SUC:a?a:{}})});a.addRoute("/data/gtw/",{method:"GET"},function(a,e,f){a=a.path.substr(10);(a=b.getGateway(a))?e.json({XC_SUC:a}):e.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});a.addRoute("/data/gtw/",{method:"POST"},function(a,e){var c=a.path.substr(10);try{b.setGateway(c,a.json,function(b,
c){b?e.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+b.message}}):c?e.json({XC_SUC:{bytes:a.size}}):e.json({XC_SUC:{bytes:0}})})}catch(g){e.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+g.message}})}});a.addRoute("/api/devices",{method:"GET"},function(a,e,f){a=b.getDevices();e.json({XC_SUC:a?a:{}})});a.addRoute("/data/dev/",{method:"GET"},function(a,e,f){a=a.path.substr(10);(a=b.getDevice(a))?e.json({XC_SUC:a}):e.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});a.addRoute("/data/dev/",
{method:"POST"},function(a,e){var c=a.path.substr(10);try{b.setDevice(c,a.json,function(b,c){b?e.json({XC_ERR:{code:"000101",msg:"failed to set device:"+b.message}}):c?e.json({XC_SUC:{bytes:a.size}}):e.json({XC_SUC:{bytes:0}})})}catch(g){e.json({XC_ERR:{code:"000101",msg:"failed to set device:"+g.message}})}})};d.prototype._initHttpApiOld=function(a){var b=this,c=require("x.hub.js").getServer();a.get("/api/gateways",function(a,f,d){c.auth(a)?(a=b.getGateways(),f.json({XC_SUC:a?a:{}})):f.json({XC_ERR:{code:"000007",
msg:"access denied"}})});a.get("/data/gtw/:id",function(a,f,d){c.auth(a)?(a=b.getGateway(a.params.id))?f.json({XC_SUC:a}):f.json({XC_ERR:{code:"000101",msg:"failed to open file"}}):f.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.post("/data/gtw/:id",function(a,f){if(c.auth(a)){var e=new Buffer(0);a.on("data",function(a){e=Buffer.concat([e,a])});a.on("end",function(){var c=a.params.id,d=e.toString("utf8");try{var g=null;d&&(g=JSON.parse(d));b.setGateway(c,g,function(a,b){a?f.json({XC_ERR:{code:"000101",
msg:"failed to set gateway:"+a.message}}):b?f.json({XC_SUC:{bytes:e.length}}):f.json({XC_SUC:{bytes:0}})})}catch(l){f.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+l.message}})}})}else f.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.get("/api/devices",function(a,d,g){c.auth(a)?(a=b.getDevices(),d.json({XC_SUC:a?a:{}})):d.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.get("/data/dev/:id",function(a,d,g){c.auth(a)?(a=b.getDevice(a.params.id))?d.json({XC_SUC:a}):d.json({XC_ERR:{code:"000101",
msg:"failed to open file"}}):d.json({XC_ERR:{code:"000007",msg:"access denied"}})});a.post("/data/dev/:id",function(a,d){if(c.auth(a)){var e=new Buffer(0);a.on("data",function(a){e=Buffer.concat([e,a])});a.on("end",function(){var c=a.params.id,f=e.toString("utf8");try{var g=null;f&&(g=JSON.parse(f));b.setDevice(c,g,function(a,b){a?d.json({XC_ERR:{code:"000101",msg:"failed to set device:"+a.message}}):b?d.json({XC_SUC:{bytes:e.length}}):d.json({XC_SUC:{bytes:0}})})}catch(l){d.json({XC_ERR:{code:"000101",
msg:"failed to set device:"+l.message}})}})}else d.json({XC_ERR:{code:"000007",msg:"access denied"}})})};d.prototype._loadDB=function(a){var b=require("fs-extra"),c=this._getFile(),e=this;b.ensureFile(c,function(b){b?a(b):e._loadFile(function(b,c){b?(e._devices={gateways:{},devices:{}},a(b)):(e._devices=c?c:{gateways:{},devices:{}},a())})})};d.prototype._writeDB=function(a){this._writeFile(this._devices,function(b){a(b)})};d.prototype._getFile=function(){return require("path").resolve(this._dataFolder,
d.FILE_NAME)};d.prototype._loadFile=function(a){var b=require("fs"),c=this._getFile(),e=this;b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{c=require("x.crypt").AES.decodeString(c,e._ml_v1_info());var d=JSON.parse(c);a(null,d)}catch(k){a(null,{})}else a(null,"")})};d.prototype._writeFile=function(a,b){var c=require("fs"),d=require("x.crypt.js"),f=this._getFile();try{var g=d.AES.encodeString(JSON.stringify(a),this._ml_v1_info());c.writeFile(f,g,function(a){b&&b(a)})}catch(h){b&&b(h)}};d.prototype._ml_v1_info=
function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3")};return d}();x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1);this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2);this.deviceManagerV6=new x.hub.deviceman.DeviceManagerV6};x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager;
x.hub.deviceman.Handler.prototype.init=function(d,a,b){this._config(d);var c=0;this.deviceManager.init(a,function(a){c++;3==c&&b&&b(a)});this.deviceManager2.init(a,function(a){c++;3==c&&b&&b(a)});this.deviceManagerV6.init(d,a,function(a){c++;3==c&&b&&b(a)})};
x.hub.deviceman.Handler.prototype._config=function(d){var a=this;d.use("/xhub/devicemanager/:id/:type",function(a,c,d){if(a._body)return d();a.body=a.body||{};if("GET"==a.method||"HEAD"==a.method||!a.is("text/xml"))return d();a._body=!0;var b="";a.setEncoding("utf8");a.on("data",function(a){b+=a});a.on("end",function(){a.body=b;d()})});d.use("/xhub/devicemanager/:id/:type",function(b,c){var d=b.method.toLowerCase(),f=b.params.id,g=b.params.type,h=null,k=null;switch(d){case "get":k="readWithoutLicense";
h=b.query;break;case "post":k="create";h=b.body;break;case "put":k="update";h=b.body;break;case "delete":k="delete",h=b.query.index}k?a.deviceManager.execute(k,f,g,h,function(a,b){a?c.send(this.error2json(a)):b.toJSON&&"function"==typeof b.toJSON?c.send(b.toJSON()):(g&&"deviceinfo"==g&&c.set("Content-Type","text/xml"),c.send(b))}.bind(this)):(b=Error("invalid http method"),b.code=500,c.send(this.error2json(b)))}.bind(this))};module.exports=new x.hub.deviceman.Handler;
