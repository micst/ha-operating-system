var m=m||{};m.aio=m.aio||{};m.aio.activationcdemgmt=m.aio.activationcdemgmt||{};m.aio.activationcdemgmt.ActivateManager=function(){this._logger=require("x.logger.js").getLogger("m.aio.activationcdemgmt.ActivateManager");this._configmanager=null;this._serverport=8080;this._serverhost="127.0.0.1";this._serverpath="/creatorneo/activate/feature";process&&"local"==process.env.CLOUD&&(m.aio.activationcdemgmt.ActivateManager.PROTOCOL="http",this._serverpath="/webservice"+this._serverpath)};
m.aio.activationcdemgmt.ActivateManager.PROTOCOL="https";
m.aio.activationcdemgmt.ActivateManager.prototype={init:function(a,c,d,b){this._configmanager=a;this._serverhost=c?c:this._serverhost;this._serverport=d?d:this._serverport;process&&"local"!=process.env.CLOUD&&80==d&&(this._serverport=443);b&&b()},activateFeature:function(a,c,d,b){if(a)if(d){var e=this,f="config/tenants/"+a+"/license",g=this._configmanager;g.execute("read",f,null,function(a,c){a?b&&b(a):c&&c.license?c.valid?e._doRequest(d,c.license,function(a,c){if(a)b&&b(a);else try{var d=JSON.parse(c);
g.execute("update",f,{classid:"license",license:d.license},function(a){b&&b(a,d.license)})}catch(h){b&&b(h)}}):b&&b(Error("tenant license is invalid")):b&&b(Error("tenant has no license"))})}else b&&b(Error("invalid activation code"));else b&&b(Error("invalid tenant index"))},_doRequest:function(a,c,d){var b=d;a={host:this._serverhost,port:this._serverport,path:this._serverpath+"?license="+c+"&code="+a,method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",Connection:"close"}};var e="";a=require(m.aio.activationcdemgmt.ActivateManager.PROTOCOL).request(a,
function(a){a.setEncoding("binary");a.on("data",function(a){e+=a});a.on("end",function(){b&&(200==a.statusCode?b(null,e):b(Error(e)));b=null})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){b&&b(a);b=null});a.setTimeout&&a.setTimeout(2E4);a.end()}};m.aio.activationcdemgmt.AM=new m.aio.activationcdemgmt.ActivateManager;"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.activationcdemgmt.AM);
