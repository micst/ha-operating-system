var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.gealan=xnm.aio.gealan||{};
xnm.aio.gealan.Fan=function(){var h={_stateTimeout:10,_errorTimeout:5,_buffer:{},getFanStates:function(a){var b=this._buffer[a];b||(this._buffer[a]={},b=this._buffer[a]);if(a=b.fan){b=a.time;var d=Math.round((new Date).getTime()/1E3);if(!(!b||d-b>this._stateTimeout||null==a.states&&d-b>this._errorTimeout))return a.states}else b.fan={}},setFanStates:function(a,b){var d=this._buffer[a];d||(this._buffer[a]={},d=this._buffer[a]);a=d.fan;a||(d.fan={},a=d.fan);d=Math.round((new Date).getTime()/1E3);a.states=
b;a.time=d},getFilterStates:function(a){var b=this._buffer[a];b||(this._buffer[a]={},b=this._buffer[a]);if(a=b.filter){b=a.time;var d=Math.round((new Date).getTime()/1E3);if(!(!b||d-b>this._stateTimeout||null==a.states&&d-b>this._errorTimeout))return a.states}else b.filter={}},setFilterStates:function(a,b){var d=this._buffer[a];d||(this._buffer[a]={},d=this._buffer[a]);a=d.filter;a||(d.filter={},a=d.filter);d=Math.round((new Date).getTime()/1E3);a.states=b;a.time=d}},c=function(a,b,d,c){this._logger=
require("x.logger.js").getLogger("xnm.aio.gealan.Fan");this._ip=a;this._port=b;this._port||(this._port=443);80==this._port&&(this._port=443);this._username=d;this._password=c;this._timeout=5E3;this._readMainCallbacks=[];this._readAmbientsCallbacks=[];this._readFilterCallbacks=[];this._readLogCallbacks=[];this._readFanCallbacks=[];this._readWlanScanCallbacks=[];this._readCounterCallbacks=[];this._httpReqBuffer=[];this._configUdpServerInterval=null;"undefined"!=typeof process&&null!=process&&process.env&&
(this._keepAliveAgent=new (require("https").Agent)({keepAlive:!0,maxSockets:1}))};c.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value)switch(b.value){case "setLevel":a=parseInt(b.ext);if(isNaN(a)){d&&d(Error("level value invalid"));break}switch(a){case 0:this._setStandBy(d);break;case 1:this._setLevel1(d);break;case 2:this._setLevel2(d);break;case 3:this._setLevel3(d);break;case 4:this._setLevel4(d);break;case 5:this._setLevel5(d);break;default:d&&d(Error("level value out of range"))}break;
case "automatic":this._setAutomatic(d);break;case "manual":this._setManual(d);break;case "nextLevel":this._setNextLevel(d);break;case "previousLevel":this._setPreviousLevel(d);break;case "nightIn":a=parseInt(b.ext);if(isNaN(a)){d&&d(Error("night in value invalid"));break}switch(a){case 1:this._setNightIn1(d);break;case 2:this._setNightIn2(d);break;case 3:this._setNightIn3(d);break;default:d&&d(Error("night in value out of range"))}break;case "nightOut":a=parseInt(b.ext);if(isNaN(a)){d&&d(Error("night out value invalid"));
break}switch(a){case 1:this._setNightOut1(d);break;case 2:this._setNightOut2(d);break;case 3:this._setNightOut3(d);break;default:d&&d(Error("night out value out of range"))}break;case "resetFilter":this._resetFilter(calllback);break;case "resetError":this._resetError(calllback)}else d&&d(Error("command value is empty"))};c.prototype.getStatesCreator=function(a,b,d){for(var c=this,f=function(a,b,d){var g=[],f,e;switch(a){case "main":c.getMainStates(function(a,c){if(a)d(a);else{for(f=0;f<b.length;f++)if((e=
b[f])&&e.id&&e.status)switch(e.status.value){case "tempIn":case "tempOut":case "humIn":case "humOut":g.push({id:e.id,status:c[e.status.value]})}d(null,g)}});break;case "general":c.getGeneralStates(function(a,c){if(a)d(a);else{for(f=0;f<b.length;f++)if((e=b[f])&&e.id&&e.status)switch(e.status.value){case "level":case "mode":case "stateNr":case "stateNrInt":case "error":case "errorNr":case "nightSpeed":case "filterReplace":case "logEntries":case "humidityNr":case "freezeNr":case "usageMode":case "nightModeState":g.push({id:e.id,
status:c[e.status.value]})}d(null,g)}});break;case "ambients":c.getAmbientsStates(function(a,c){if(a)d(a);else{for(f=0;f<b.length;f++)if((e=b[f])&&e.id&&e.status)switch(e.status.value){case "temp1":case "temp2":case "temp3":case "temp4":case "hum1":case "hum2":g.push({id:e.id,status:c[e.status.value]})}d(null,g)}});break;case "filter":c.getFilterStates(function(a,c){if(a)d(a);else{for(f=0;f<b.length;f++)if((e=b[f])&&e.id&&e.status)switch(e.status.value){case "elapsed":case "remaining":g.push({id:e.id,
status:c?c[e.status.value]:"?"})}d(null,g)}});break;case "fan":c.getFanStates(function(a,c){if(a)d(a);else{for(f=0;f<b.length;f++)if((e=b[f])&&e.id&&e.status)switch(e.status.value){case "targetRSIn":case "currentRSIn":case "targetRSOut":case "currentRSOut":case "maxRS":case "minRS":g.push({id:e.id,status:c?c[e.status.value]:"?"})}d(null,g)}})}},e=[],k=0;k<b.length;k++){var m=b[k];if(m&&m.id&&m.status&&m.status.value)switch(m.status.value){case "tempIn":case "tempOut":case "humIn":case "humOut":-1==
e.indexOf("main")&&e.push("main");break;case "level":case "mode":case "stateNr":case "stateNrInt":case "error":case "errorNr":case "nightSpeed":case "filterReplace":case "logEntries":case "humidityNr":case "freezeNr":case "usageMode":case "nightModeState":-1==e.indexOf("general")&&e.push("general");break;case "temp1":case "temp2":case "temp3":case "temp4":case "hum1":case "hum2":-1==e.indexOf("ambients")&&e.push("ambients");break;case "elapsed":case "remaining":-1==e.indexOf("filter")&&e.push("filter");
break;case "targetRSIn":case "currentRSIn":case "targetRSOut":case "currentRSOut":case "maxRS":case "minRS":-1==e.indexOf("fan")&&e.push("fan")}}if(0==e.length)d&&d(null,[]);else{var l=0,n=[],h=function(c,g){l++;!c&&g&&(n=n.concat(g),"undefined"!=typeof a&&null!=a&&"undefined"!=typeof a.reportStates&&null!=a.reportStates&&a.reportStates(null,g));l<e.length?f(e[l],b,h):d&&d(null,n)};f(e[l],b,h)}};c.prototype.getMainStates=function(a){var b=this;this._readMain(function(d,c){d?a&&a(d):(d=b._resolveMainStates(c),
a&&a(null,d))})};c.prototype._resolveMainStates=function(a){var b={};b.tempIn=parseInt(a.TempIn)/100;b.tempOut=parseInt(a.TempOut)/100;b.humIn=parseInt(a.HumidityIn)/100;b.humOut=parseInt(a.HumidityOut)/100;return b};c.prototype.getGeneralStates=function(a){var b=this;this._readStatus(function(d,c){d?a&&a(d):(d=b._resolveGeneralStates(c),a&&a(null,d))})};c.prototype._resolveGeneralStates=function(a){var b={};b.stateNr=parseInt(a.StateNr);5>=b.stateNr?(b.level=b.stateNr,b.mode="MANUAL"):(b.level="",
b.mode=a.State);10==b.stateNr?(b.error=a.Error,b.errorNr=a.ErrorNr):(b.error="",b.errorNr="");b.nightSpeed=7==b.stateNr||8==b.stateNr?parseInt(a.NightSpeed):"";b.stateNrInt=parseInt(a.StateNrInternal);b.logEntries=parseInt(a.LOGEntries);b.filterReplace="yes"==a.ReplaceFilter;b.humidityNr=parseInt(a.StateOfHumidityNr);b.freezeNr=parseInt(a.StateOfFreezeNr);b.usageMode=parseInt(a.UsageMode);b.nightModeState=parseInt(a.NightModeState);return b};c.prototype.getAmbientsStates=function(a){var b=this;this._readAmbients(function(d,
c){d?a&&a(d):(d=b._resolveAmbientsStates(c),a&&a(null,d))})};c.prototype._resolveAmbientsStates=function(a){var b={};b.temp1=parseInt(a.Temp1)/100;b.temp2=parseInt(a.Temp2)/100;b.temp3=parseInt(a.Temp3)/100;b.temp4=parseInt(a.Temp4)/100;b.hum1=parseInt(a.Humidity1)/100;b.hum2=parseInt(a.Humidity2)/100;return b};c.prototype.getFilterStates=function(a){var b=h.getFilterStates(this._ip);if("undefined"!=typeof b)null!=b&&(b=this._resolveFilterStates(b)),a&&a(null,b);else{var d=this;this.readFilter(function(b,
c){h.setFilterStates(d._ip,b?null:c);b=d._resolveFilterStates(c);a&&a(null,b)})}};c.prototype._resolveFilterStates=function(a){var b={};b.elapsed=parseInt(a.Elapsed);b.remaining=parseInt(a.Remaining);return b};c.prototype.getFanStates=function(a){var b=h.getFanStates(this._ip);if("undefined"!=typeof b)null!=b&&(b=this._resolveFanStates(b)),a&&a(null,b);else{var d=this;this.readFan(function(b,c){h.setFanStates(d._ip,b?null:c);b=d._resolveFanStates(c);a&&a(null,b)})}};c.prototype._resolveFanStates=
function(a){var b={};b.targetRSIn=parseInt(a.TargetRotationSpeedIN);b.currentRSIn=parseInt(a.ActualRotationSpeedIN);b.targetRSOut=parseInt(a.TargetRotationSpeedOUT);b.currentRSOut=parseInt(a.ActualRotationSpeedOUT);b.maxRS=parseInt(a.MaxRotationSpeed);b.minRS=parseInt(a.MinRotationSpeed);return b};c.prototype.configUdpServer=function(a,b,d){a||(a="255.255.255.255");b||(b=1903);var c=this;this.setUdpServer(a,b,function(g){g?d&&d(g):(c._configUdpServerInterval&&clearInterval(c._configUdpServerInterval),
c._configUdpServerInterval=setInterval(function(){c.setUdpServer(a,b)},6E5),d&&d())})};c.prototype.setStandBy=function(a){this._setStandBy(a)};c.prototype._setStandBy=function(a){this._doRequest("POST","/CommandSET_STANDBY.cmd",null,function(b){a&&a(b)})};c.prototype.setOn=function(a){this._setOn(a)};c.prototype._setOn=function(a){this._doRequest("POST","/CommandSET_ON.cmd",null,function(b){a&&a(b)})};c.prototype.setLevel1=function(a){this._setLevel1(a)};c.prototype._setLevel1=function(a){this._doRequest("POST",
"/CommandSET_LEVEL1.cmd",null,function(b){a&&a(b)})};c.prototype.setLevel2=function(a){this._setLevel2(a)};c.prototype._setLevel2=function(a){this._doRequest("POST","/CommandSET_LEVEL2.cmd",null,function(b){a&&a(b)})};c.prototype.setLevel3=function(a){this._setLevel3(a)};c.prototype._setLevel3=function(a){this._doRequest("POST","/CommandSET_LEVEL3.cmd",null,function(b){a&&a(b)})};c.prototype.setLevel4=function(a){this._setLevel4(a)};c.prototype._setLevel4=function(a){this._doRequest("POST","/CommandSET_LEVEL4.cmd",
null,function(b){a&&a(b)})};c.prototype.setLevel5=function(a){this._setLevel5(a)};c.prototype._setLevel5=function(a){this._doRequest("POST","/CommandSET_LEVEL5.cmd",null,function(b){a&&a(b)})};c.prototype.setAutomatic=function(a){this._setAutomatic(a)};c.prototype._setAutomatic=function(a){this._doRequest("POST","/CommandSET_AUTOMATIC.cmd",null,function(b){a&&a(b)})};c.prototype.setManual=function(a){this._setManual(a)};c.prototype._setManual=function(a){this._doRequest("POST","/CommandSET_MANUAL.cmd",
null,function(b){a&&a(b)})};c.prototype.setNextLevel=function(a){this._setNextLevel(a)};c.prototype._setNextLevel=function(a){this._doRequest("POST","/CommandSET_NEXT_LEVEL.cmd",null,function(b){a&&a(b)})};c.prototype.setPreviousLevel=function(a){this._setPreviousLevel(a)};c.prototype._setPreviousLevel=function(a){this._doRequest("POST","/CommandSET_PREV_LEVEL.cmd",null,function(b){a&&a(b)})};c.prototype.setNightIn1=function(a){this._setNightIn1(a)};c.prototype._setNightIn1=function(a){this._doRequest("POST",
"/CommandSET_N_IN1.cmd",null,function(b){a&&a(b)})};c.prototype.setNightIn2=function(a){this._setNightIn2(a)};c.prototype._setNightIn2=function(a){this._doRequest("POST","/CommandSET_N_IN2.cmd",null,function(b){a&&a(b)})};c.prototype.setNightIn3=function(a){this._setNightIn3(a)};c.prototype._setNightIn3=function(a){this._doRequest("POST","/CommandSET_N_IN3.cmd",null,function(b){a&&a(b)})};c.prototype.setNightOut1=function(a){this._setNightOut1(a)};c.prototype._setNightOut1=function(a){this._doRequest("POST",
"/CommandSET_N_OUT1.cmd",null,function(b){a&&a(b)})};c.prototype.setNightOut2=function(a){this._setNightOut2(a)};c.prototype._setNightOut2=function(a){this._doRequest("POST","/CommandSET_N_OUT2.cmd",null,function(b){a&&a(b)})};c.prototype.setNightOut3=function(a){this._setNightOut3(a)};c.prototype._setNightOut3=function(a){this._doRequest("POST","/CommandSET_N_OUT3.cmd",null,function(b){a&&a(b)})};c.prototype._resetFilter=function(a){this._doRequest("POST","/CommandRESET_FILTER.cmd",null,function(b){a&&
a(b)})};c.prototype.readMainA=function(a){this._readMain(function(b,d){a&&a(b,d)})};c.prototype.readMainB=function(a){this._asyncRead("_readMainCallbacks","_cmdReadMain","_readMain",a)};c.prototype._cmdReadMain=function(a){this._doRequest("POST","/CommandREAD_MAIN.cmd",null,function(b){a&&a(b)})};c.prototype._readMain=function(a){this._doRequestXML("GET","/CmdResultREAD_MAIN.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_MAIN response invalid"))})};c.prototype.readStatus=
function(a){this._readStatus(function(b,d){a&&a(b,d)})};c.prototype._readStatus=function(a){this._doRequestXML("GET","/CmdResultREAD_STATUS.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_STATUS response invalid"))})};c.prototype.readSoftware=function(a){this._readSoftware(function(b,d){a&&a(b,d)})};c.prototype._readSoftware=function(a){this._doRequestXML("GET","/CmdResultREAD_SOFTWARE.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_SOFTWARE response invalid"))})};
c.prototype.readAmbientsA=function(a){this._readAmbients(function(b,d){a&&a(b,d)})};c.prototype.readAmbientsB=function(a){this._asyncRead("_readAmbientsCallbacks","_cmdReadAmbients","_readAmbients",a)};c.prototype._cmdReadAmbients=function(a){this._doRequest("POST","/CommandREAD_AMBIENTS.cmd",null,function(b){a&&a(b)})};c.prototype._readAmbients=function(a){this._doRequestXML("GET","/CmdResultREAD_AMBIENTS.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_AMBIENTS response invalid"))})};
c.prototype.readFilter=function(a){this._asyncRead("_readFilterCallbacks","_cmdReadFilter","_readFilter",a)};c.prototype.readFilter2=function(a){this._readFilter(function(b,d){a&&a(b,d)})};c.prototype._cmdReadFilter=function(a){this._doRequest("GET","/CommandREAD_FILTER.cmd",null,function(b){a&&a(b)})};c.prototype._readFilter=function(a){this._doRequestXML("GET","/CmdResultREAD_FILTER.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_FILTER response invalid"))})};c.prototype.readLog=
function(a,b){var d=this._readLogCallbacks.length;b&&-1==this._readLogCallbacks.indexOf(b)&&this._readLogCallbacks.push(b);if(0==d){var c=this,f=function(a,b){var d=c._readLogCallbacks;c._readLogCallbacks=[];for(var e=0;e<d.length;e++)try{d[e](a,b)}catch(n){}};this._cmdParameterReadLog(a,function(b){if(b)f(b);else{var d=0,e=function(b,g){b?f(b):"yes"==g.ready?f(null,g):50<d?f(Error("result not ready")):(d++,setTimeout(function(){c._readLog(a,e)},500))};c._readLog(a,e)}})}};c.prototype._cmdParameterReadLog=
function(a,b){this._doRequest("POST","/CommandPARAMETER_READ_LOG"+a+".cmd",null,function(a){b&&b(a)})};c.prototype._readLog=function(a,b){this._doRequestXML("GET","/CmdResultPARAMETER_READ_LOG"+a+".cmd",null,function(a,c){a?b&&b(a):c&&c.State?b&&b(null,c.State):b&&b(Error("PARAMETER_READ_LOG response invalid"))})};c.prototype.readFan=function(a){this._asyncRead("_readFanCallbacks","_cmdReadFan","_readFan",a)};c.prototype._cmdReadFan=function(a){this._doRequest("POST","/CommandREAD_FAN.cmd",null,function(b){a&&
a(b)})};c.prototype._readFan=function(a){this._doRequestXML("GET","/CmdResultREAD_FAN.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_FAN response invalid"))})};c.prototype.readWlanScan=function(a){this._asyncRead("_readWlanScanCallbacks","_cmdReadWlanScan","_readWlanScan",a)};c.prototype._cmdReadWlanScan=function(a){this._doRequest("POST","/CommandREAD_WLANSCAN.cmd",null,function(b){a&&a(b)})};c.prototype._readWlanScan=function(a){this._doRequestXML("GET","/CmdResultREAD_WLANSCAN.cmd",
null,function(b,d){b?a&&a(b):d&&d.WiFi?a&&a(null,d.WiFi):a&&a(Error("READ_WLANSCAN response invalid"))})};c.prototype.readIpMac=function(a){this._readIpMac(function(b,d){a&&a(b,d)})};c.prototype._readIpMac=function(a){this._doRequestXML("GET","/CmdResultREAD_IPMAC.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("CmdResultREAD_IPMAC.cmd response invalid"))})};c.prototype.readWifiSettings=function(a){this._readWifiSettings(function(b,d){a&&a(b,d)})};c.prototype._readWifiSettings=
function(a){this._doRequestXML("GET","/CmdResultREAD_WIFISETTINGS.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_MAIN response invalid"))})};c.prototype.readSignal=function(a){this._readSignal(function(b,d){a&&a(b,d)})};c.prototype._readSignal=function(a){this._doRequestXML("GET","/CmdResultREAD_SIGNAL.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_SIGNAL response invalid"))})};c.prototype.readLED=function(a){this._readLED(function(b,
d){a&&a(b,d)})};c.prototype._readLED=function(a){this._doRequestXML("GET","/CmdResultREAD_LED.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_LED response invalid"))})};c.prototype.readCommon=function(a){this._readCommon(function(b,d){a&&a(b,d)})};c.prototype._readCommon=function(a){this._doRequestXML("GET","/CmdResultREAD_COMMON.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_COMMON response invalid"))})};c.prototype.readCounter=function(a){this._asyncRead("_readCounterCallbacks",
"_cmdReadCounter","_readCounter",a)};c.prototype._cmdReadCounter=function(a){this._doRequest("GET","/CommandREAD_COUNTER.cmd",null,function(b){a&&a(b)})};c.prototype._readCounter=function(a){this._doRequestXML("GET","/CmdResultREAD_COUNTER.cmd",null,function(b,d){b?a&&a(b):d&&d.State?a&&a(null,d.State):a&&a(Error("READ_COUNTER response invalid"))})};c.prototype.readSerial=function(a){this._readSerial(function(b,d){a&&a(b,d)})};c.prototype._readSerial=function(a){this._doRequest("GET","/CmdResultREAD_SERIALNR.cmd",
null,function(b,d){a&&a(b,d)})};c.prototype.readName=function(a){this._readName(function(b,d){a&&a(b,d)})};c.prototype._readName=function(a){this._doRequest("GET","/CmdResultREAD_NAME.cmd",null,function(b,d){a&&a(b,d)})};c.prototype.changeName=function(a,b){this._cmdParamChangeName(a,function(a){b&&b(a)})};c.prototype._cmdParamChangeName=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHANGE_NAME"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.setWlanOff=function(a,b){this._cmdParamWlanOff(a,
function(a){b&&b(a)})};c.prototype._cmdParamWlanOff=function(a,b){this._doRequest("POST","/CommandPARAMETER_WLAN_OFF"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.selectSTA=function(a,b,d){var c=this;this._cmdParamChooseWlanNet(a,function(a){a?d&&d(a):c._cmdParamChooseWlanPwd(b,function(a){a?d&&d(a):c._cmdSelectSTA(function(a){d&&d(a)})})})};c.prototype._cmdParamChooseWlanNet=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANNET"+a+".cmd",null,function(a){b&&b(a)})};c.prototype._cmdParamChooseWlanPwd=
function(a,b){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANPWD"+a+".cmd",null,function(a){b&&b(a)})};c.prototype._cmdSelectSTA=function(a){this._doRequest("POST","/CommandSELECT_STA.cmd",null,function(b){a&&a(b)})};c.prototype.setLedTimeout=function(a,b){this._cmdParamLedTimeout(a,function(a){b&&b(a)})};c.prototype._cmdParamLedTimeout=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_TIMEOUT"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.setLedIntensity=function(a,b){this._cmdParamLedIntensity(a,
function(a){b&&b(a)})};c.prototype._cmdParamLedIntensity=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_INTENSITY"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.setLedReverseDirection=function(a,b){this._cmdParamLedReverseDirection(a?"yes":"no",function(a){b&&b(a)})};c.prototype._cmdParamLedReverseDirection=function(a,b){this._doRequest("POST","/CommandPARAMETER_LED_REVERSE_DIRECTION"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.setExtKeyActive=function(a,b){this._cmdParamExtkeyActive(a?
"yes":"no",function(a){b&&b(a)})};c.prototype._cmdParamExtkeyActive=function(a,b){this._doRequest("POST","/CommandPARAMETER_EXTKEY_ACTIVE"+a+".cmd",null,function(a){b&&b(a)})};c.prototype.setUdpServer=function(a,b,d){this._cmdParamUdpServer(a,b,function(a){d&&d(a)})};c.prototype._cmdParamUdpServer=function(a,b,d){this._doRequest("POST","/CommandPARAMETER_UDP_SERVER"+a+":"+b+".cmd",null,function(a){d&&d(a)})};c.prototype.identify=function(a,b,d){this._cmdParamIdentify(a,b,function(a){d&&d(a)})};c.prototype._cmdParamIdentify=
function(a,b,d){this._doRequest("POST","/CommandPARAMETER_IDENTIFY"+a+"_"+b+".cmd",null,function(a){d&&d(a)})};c.prototype.startTestRGBs=function(a,b){this._cmdParamTestRGBs(a,1,function(a){b&&b(a)})};c.prototype.stopTestRGBs=function(a){this._cmdParamTestRGBs("ffffff",0,function(b){a&&a(b)})};c.prototype._cmdParamTestRGBs=function(a,b,d){this._doRequest("POST","/CommandPARAMETER_TESTRGBS"+a+"_"+b+".cmd",null,function(a){d&&d(a)})};c.prototype.resetError=function(a){this._resetError(function(b){a&&
a(b)})};c.prototype._resetError=function(a){this._doRequest("POST","/CommandRESET_ERROR.cmd",null,function(b){a&&a(b)})};c.prototype.quitError=function(a){this._cmdQuitError(function(b){a&&a(b)})};c.prototype._cmdQuitError=function(a){this._doRequest("POST","/CommandQUIT_ERROR.cmd",null,function(b){a&&a(b)})};c.prototype.restart=function(a){this._cmdRestart(function(b){a&&a(b)})};c.prototype._cmdRestart=function(a){this._doRequest("POST","/CommandRESTART.cmd",null,function(b){a&&a(b)})};c.prototype.resetWlan=
function(a){this._cmdResetWlan(function(b){a&&a(b)})};c.prototype._cmdResetWlan=function(a){this._doRequest("POST","/CommandRESET_WLAN.cmd",null,function(b){a&&a(b)})};c.prototype.resetData=function(a){this._cmdResetData(function(b){a&&a(b)})};c.prototype._cmdResetData=function(a){this._doRequest("POST","/CommandRESET_DATA.cmd",null,function(b){a&&a(b)})};c.prototype.saveStampStartup=function(a,b){var d=a.getFullYear()+"";d=d.substr(2,2);var c=a.getMonth()+1+"";2>c.length&&(c="0"+c);var f=a.getDate()+
"";2>f.length&&(f="0"+f);var e=a.getHours()+"";2>e.length&&(e="0"+e);a=a.getMinutes()+"";2>a.length&&(a="0"+a);this._cmdParamStampStartup(d,c,f,e,a,function(a){b&&b(a)})};c.prototype._cmdParamStampStartup=function(a,b,d,c,f,e){this._doRequest("POST","/CommandPARAMETER_STAMP_STARTUP"+a+b+d+c+f+".cmd",null,function(a){e&&e(a)})};c.prototype.changeAPPwd=function(a,b){this._cmdParamChangeAppwd(a,function(a){b&&b(a)})};c.prototype._cmdParamChangeAppwd=function(a,b){this._doRequest("POST","/CommandPARAMETER_CHANGE_APPWD"+
a+".cmd",null,function(a){b&&b(a)})};c.prototype._asyncRead=function(a,b,d,c){var f=this[a].length;c&&-1==this[a].indexOf(c)&&this[a].push(c);if(0==f){var e=this,g=function(b,d){var c=e[a];e[a]=[];for(var f=0;f<c.length;f++)try{c[f](b,d)}catch(p){}};this[b](function(a){if(a)g(a);else{var b=0,c=function(a,f){a?g(a):"yes"==f.ready?g(null,f):50<b?g(Error("result not ready")):(b++,setTimeout(function(){e[d](c)},500))};e[d](c)}})}};c.prototype._doRequestXML=function(a,b,d,c){var f=this;this._doRequest(a,
b,d,function(a,b){a?c&&c(a):(a=null,b&&(a=f._xml2json(b)),c&&c(null,a))})};c.prototype._xml2json=function(a){var b=function(a){var c={};a.children().each(function(){var a=$(this),d=a.prop("tagName");a=0==a.children().length?a.text():b(a);var e=c[d];"undefined"==typeof e||null==e?c[d]=a:Array.isArray(e)?e.push(a):c[d]=[e,a]});return c};try{var c=$($.parseXML(a));var g=c.getRootNode?c.getRootNode():$(c.children()[0]);if(!g)return null;var f=g.prop("tagName"),e=b(g);a={};a[f]=e;return a}catch(k){return null}};
c.prototype._doRequest=function(a,b,c,g){var d=this._httpReqBuffer.length;this._httpReqBuffer.push({method:a,path:b,data:c,callback:g});0==d&&this._doNextHttpReq()};c.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var a=this._httpReqBuffer[0],b=this;this._doRequestHttp(a.method,a.path,a.data,function(c,g){a.callback&&a.callback(c,g);b._httpReqBuffer.splice(0,1);b._doNextHttpReq()})}};c.prototype._doRequestHttp=function(a,b,c,g){var d="https://"+this._ip+":"+this._port+b;this._logger.log("trace",
"send "+a+" to url: "+d+" data:"+c);a={host:this._ip,port:this._port,path:b,method:a,headers:{}};if(this._username||this._password)a.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),a.headers.Authorization="Basic "+(new Buffer((this._username?this._username:"")+":"+(this._password?this._password:""))).toString("base64");var e=this,k=g;g=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",a.agent=this._keepAliveAgent);
var h=g.request(a,function(a){a.setEncoding("utf-8");var b="";a.on("data",function(a){b+=a});a.on("end",function(){e._logger.log("trace",d+" response "+a.statusCode+": "+b);if(200==a.statusCode)k&&k(null,b);else{var c=Error("http response "+a.statusCode);k&&k(c)}k=null})});h.setTimeout(this._timeout,function(){e._logger.log("trace","http request "+d+" timeout");k&&(k(Error("http request timeout")),k=null);h.abort()});h.on("error",function(a){e._logger.log("trace","http request "+d+" error:"+a.message);
k&&(k(a),k=null)});c&&h.write(c);h.end()};c.prototype._doRequestAjax=function(a,b,c,g){var d=this;b="http://"+this._ip+":"+this._port+b;this._logger.log("trace","send "+a+" to url:"+b+" data:"+c);var e=g;$.ajax({url:b,type:a,timeout:this._timeout,data:c,dataType:"text",cache:!1,username:this._username,password:this._password,success:function(a){d._logger.log("trace","http request success:"+a);e&&(e(null,a),e=null)},error:function(a,b){a="http request error:"+(a?a.status:"0")+"-"+b;d._logger.log("trace",
a);e&&(e(Error(a)),e=null)}})};c.prototype.toJSON=function(){return{sys:"gealan",ip:this._ip,port:this._port,username:this._username,password:this._password}};c.prototype.equalsTo=function(a){return a&&a instanceof c?this._ip==a._ip&&this._port==a._port:!1};c.parseJSON=function(a){return a&&a.ip?new c(a.ip,a.port,a.username,a.password):null};return c}();
xnm.aio.gealan.UdpListener=function(){var h=function(c){this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.EventListener");this._port=c;this._port||(this._port=1903);this._state=0;this._socket=null;this._callbacks=[];this._listeners=[]};h.prototype.start=function(c){if(2==this._state)c&&c();else if(1==this._state)c&&-1==this._callbacks.indexOf(c)&&this._callbacks.push(c);else{var a=this;this._state=1;this._logger.log("debug","start listen to port "+this._port);this._startUdpListener(this._port,
function(b,c){b?(a._state=0,a._logger.log("debug","failed to listen to port "+a._port+":"+b.message)):(a._state=2,a._socket=c,a._logger.log("debug","listen to port "+a._port+" success"));c=a._callbacks;a._callbacks=[];for(var d=0;d<c.length;d++)c[d](b)})}};h.prototype.stop=function(c){0!=this._state&&(this._socket&&(this._socket.close(),this._socket=null),this._state=0);c&&c()};h.prototype.addListener=function(c){c&&-1==this._listeners.indexOf(c)&&this._listeners.push(c)};h.prototype.removeListener=
function(c){c&&(c=this._listeners.indexOf(c),-1!=c&&this._listeners.splice(c,1))};h.prototype._startUdpListener=function(c,a){var b=this,d=a,g=require("dgram").createSocket({type:"udp4",reuseAddr:!0});g.on("listening",function(){g.setBroadcast&&g.setBroadcast(!0);b._logger.log("trace","udp listener started at port:"+c);d&&(d(null,g),d=null)});g.on("error",function(a){d?(b._logger.log("trace","bind udp listener at port:"+c+" error:"+a.stack),d(a),d=null):(b._logger.log("trace","udp listener at port:"+
c+" error:"+a.stack),b.stop())});g.on("message",function(a,d){a=a.toString();b._logger.log("trace","receive udp message at port:"+c+" from:"+d.address+" data:"+a);a=a.split(" ");a="Status"==a[0]&&"changed"==a[1]?{key:"Status changed",value:a[2]}:"new"==a[0]&&"IP"==a[1]?{key:"new IP",value:a[2]}:{key:a[0],value:a[1]};for(var e=0;e<b._listeners.length;e++)try{b._listeners[e](a,d)}catch(m){}});g.bind(c)};return h}();
xnm.aio.gealan.DM=function(){var h={command:[{type:"int",name:"set level",ref:{value:"setLevel",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"automatic",ref:{value:"automatic"}},{type:"enum",name:"manual",ref:{value:"manual"}},{type:"enum",name:"next level",ref:{value:"nextLevel"}},{type:"enum",name:"previous level",ref:{value:"previousLevel"}},{type:"enum",name:"reset filter",ref:{value:"resetFilter"}},{type:"enum",name:"reset error",ref:{value:"resetError"}}],status:[{type:"int",name:"temperature inside",
ref:{value:"tempIn",ext:"%d"}},{type:"int",name:"temperature outside",ref:{value:"tempOut",ext:"%d"}},{type:"int",name:"humidity inside",ref:{value:"humIn",ext:"%d"}},{type:"int",name:"humidity outside",ref:{value:"humOut",ext:"%d"}},{type:"int",name:"level",ref:{value:"level",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"mode",ref:{value:"mode",options:"MANUAL AUTOMATIC NIGHT_IN NIGHT_OUT FLAP_CLOSED ERROR FROST_PROTECTION MOISTURE_PROTECTION".split(" ")}},{type:"int",name:"state no.",ref:{value:"stateNr",
ext:"%d",extMeta:"0-12"}},{type:"int",name:"state no. (internal)",ref:{value:"stateNrInt",ext:"%d"}},{type:"string",name:"error message",ref:{value:"error",ext:"%s"}},{type:"int",name:"error no.",ref:{value:"errorNr",ext:"%d"}},{type:"int",name:"night speed",ref:{value:"nightSpeed",ext:"%d",extMeta:"1-3"}},{type:"enum",name:"replace filter",ref:{value:"filterReplace",options:["true","false"]}},{type:"int",name:"log entries",ref:{value:"logEntries",ext:"%d"}},{type:"int",name:"humidity no.",ref:{value:"humidityNr",
ext:"%d"}},{type:"int",name:"freeze no.",ref:{value:"freezeNr",ext:"%d"}},{type:"int",name:"usage mode",ref:{value:"usageMode",ext:"%d"}},{type:"int",name:"night mode state",ref:{value:"nightModeState",ext:"%d"}},{type:"int",name:"temperature exhaust air (outside)",ref:{value:"temp1",ext:"%d"}},{type:"int",name:"temperature supply air (inside)",ref:{value:"temp2",ext:"%d"}},{type:"int",name:"temperature supply air (outside)",ref:{value:"temp3",ext:"%d"}},{type:"int",name:"temperature exhaust air (inside)",
ref:{value:"temp4",ext:"%d"}},{type:"int",name:"humidity supply air (outside)",ref:{value:"hum1",ext:"%d"}},{type:"int",name:"humidity exhaust air (inside)",ref:{value:"hum2",ext:"%d"}},{type:"int",name:"filter elapsed time",ref:{value:"elapsed",ext:"%d"}},{type:"int",name:"filter remaining time",ref:{value:"remaining",ext:"%d"}},{type:"int",name:"target rotation speed in",ref:{value:"targetRSIn",ext:"%d"}},{type:"int",name:"actual rotation speed in",ref:{value:"currentRSIn",ext:"%d"}},{type:"int",
name:"target rotation speed out",ref:{value:"targetRSOut",ext:"%d"}},{type:"int",name:"actual rotation speed out",ref:{value:"currentRSOut",ext:"%d"}},{type:"int",name:"max rotation speed",ref:{value:"maxRS",ext:"%d"}},{type:"int",name:"min rotation speed",ref:{value:"minRS",ext:"%d"}}]},c=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};c.prototype=Error();c.prototype.name="GealanDMError";c.prototype.code=0;c.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,
IP_EXISTS:6};return{SYS:"gealan",getIPDeviceType:function(){return[{sys:this.SYS,name:"Gealan Fan"}]},createDevice:function(a,b,d){b=c.ERROR_CODE;a?a.type?a.ip?d(null,a):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,"type is invalid")):d(new c(b.INVALID,"info is invalid"))},updateDevice:function(a,b,d){b=c.ERROR_CODE;a?a.type?a.ip?d(null,a):d(new c(b.INVALID,"ip is invalid")):d(new c(b.INVALID,"type is invalid")):d(new c(b.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,
b,c){var d=this,f=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,c){var d=[];switch(c.catagory){case "command":a.command&&a.command.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))});break;case "status":a.status&&a.status.forEach(function(a){f(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),d.push(a))})}return d},h=function(a,b){var f=[],g=d.getCommandStatusMap(a,c);g&&(a=e(g,a,b),f=f.concat(a));
return f};if(!a.sys)return null;var m=JSON.parse(JSON.stringify(a)),l=null;switch(b.catagory){case "command":l=h(a,b);m.command=l;break;case "status":l=h(a,b);m.status=l;break;default:return null}return l&&0!=l.length?m:null},getCommandStatusMap:function(a,b){return h}}}();
xnm.aio.gealan.Handler=function(){var h=function(){this._udpListener=new xnm.aio.gealan.UdpListener(1903)};h.prototype.devicemanager=xnm.aio.gealan.DM;h.prototype.Fan=xnm.aio.gealan.Fan;h.prototype.registModule=function(c){c.register("gealan","gealan")};h.prototype.resolveDevice=function(c){return this.Fan.parseJSON(c)};h.prototype.getDeviceCommands=function(c,a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];a&&a(null,c)};h.prototype.getDeviceStatus=function(c,
a){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];a&&a(null,c)};h.prototype.doCommand=function(c,a,b){var d=this.resolveDevice(c);d?d.executeCommandCreator(c,a,function(a){b&&b(a)}):b&&b(Error("device json format invalid"))};h.prototype.doStatus=function(c,a,b,d){var g=this.resolveDevice(a);g?g.getStatesCreator(null,[{id:c,device:a,status:b}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};h.prototype.getUdpListener=function(){return this._udpListener};
return h}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gealan.Handler);
