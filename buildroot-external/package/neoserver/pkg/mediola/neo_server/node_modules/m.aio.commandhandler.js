var m=m||{};m.aio=m.aio||{};m.aio.commandhandler=m.aio.commandhandler||{};m.aio.commandhandler.Task=function(a,c){this.type=a;this.callback=c;this.devices=this.command=this.device=null};m.aio.commandhandler.Task.TYPE={DO_COMMAND:0,DO_STATUS:1,DO_SINGLE_DEVICE_STATUS:2};m.aio.commandhandler.Queue=function(){this._queue=[]};m.aio.commandhandler.Queue.prototype.push=function(a){this._queue.push(a)};
m.aio.commandhandler.Queue.prototype.pop=function(){var a=this._queue.splice(0,1);return a.length?a[0]:null};m.aio.commandhandler.Queue.prototype.size=function(){return this._queue.length};m.aio.commandhandler.ExecutionQueue=function(a){this._executor=a;this._state=0;this._queue=new m.aio.commandhandler.Queue};m.aio.commandhandler.ExecutionQueue.prototype.pushTask=function(a){this._executeTask(a)};
m.aio.commandhandler.ExecutionQueue.prototype._executeTask=function(a){this._executor.executeTask(a,function(){}.bind(this))};m.aio.commandhandler.Executor=function(a,c,d){this.sys=a;this._host=c;this._queue=new m.aio.commandhandler.ExecutionQueue(this);this._handler=d};m.aio.commandhandler.Executor.prototype.getHost=function(){return this._host};m.aio.commandhandler.Executor.prototype.execute=function(a){this._queue.pushTask(a)};
m.aio.commandhandler.Executor.prototype.executeTask=function(a,c){switch(a.type){case m.aio.commandhandler.Task.TYPE.DO_COMMAND:if(!this._host||!this._host.executeCommandCreator){a.callback&&a.callback(Error("device accept no command"));break}this._host.executeCommandCreator(a.device,a.command,function(d,b){a.callback&&a.callback(d,b);c&&c()});break;case m.aio.commandhandler.Task.TYPE.DO_STATUS:if(!this._host||!this._host.getStatesCreator){a.callback&&a.callback(Error("device has no states"));break}this._host.getStatesCreator(this._handler,
a.devices,function(d,b){a.callback&&a.callback(d,b);c&&c()});break;case m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS:if(!this._host||!this._host.getSingleDeviceStatesCreator){a.callback&&a.callback(Error("device has no such function"));break}this._host.getSingleDeviceStatesCreator(this._handler,a.device,a.devices,function(d,b){a.callback&&a.callback(d,b);c&&c()});break;default:c&&c()}};m.aio.commandhandler.ExecutorPool=function(){this._executors=[]};
m.aio.commandhandler.ExecutorPool.prototype.getExecutor=function(a,c){for(var d=null,b=0;b<this._executors.length;b++){var e=this._executors[b];if(e.sys==a&&e._host&&e._host.equalsTo&&"function"==typeof e._host.equalsTo&&e._host.equalsTo(c)){d=e;break}}return d};m.aio.commandhandler.ExecutorPool.prototype.addExecutor=function(a){this._executors.push(a)};m.aio.commandhandler.IntHandler=function(){this._executorPool=new m.aio.commandhandler.ExecutorPool;this._statesListener=this._cloudForwardHost=null};
m.aio.commandhandler.IntHandler.prototype.setStatesListener=function(a){this._statesListener=a};
m.aio.commandhandler.IntHandler.prototype.resolveHost=function(a,c,d,b){if(a){if(!a.sys){b&&b(Error("gateway json format in valid"));return}var e=a.sys}else{if(!c.sys){b&&b(Error("device json format in valid"));return}e=c.sys}var g=require("m.aio.devicemanager").getModule(e);if(g){var f;a&&g.resolveGateway&&"function"==typeof g.resolveGateway?f=g.resolveGateway(a):g.resolveDevice&&"function"==typeof g.resolveDevice&&(f=g.resolveDevice(c,d));f?b&&b(null,f,e):b&&b(Error("resolve device object error"))}else b&&
b(Error("module "+e+" do not exist"))};
m.aio.commandhandler.IntHandler.prototype.executeCommand=function(a,c,d,b,e,g,f){if(c)if(f=this._executorPool.getExecutor(a,c),f||(f=new m.aio.commandhandler.Executor(a,c,this),c._deviceInfo||this._executorPool.addExecutor(f)),c=f.getHost(),this._cloudForwardHost&&this._cloudForwardHost!=c)this._cloudForwardHost.forwardExecuteCommand(g,d,b,e);else{if(("aio"==a||"neoserver"==a)&&b&&"cfOn"==b.value||"cfOff"==b.value)this._cloudForwardHost="cfOn"==b.value?c:null;a=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_COMMAND,
e);a.device=d;a.command=b;f.execute(a)}else e&&e(Error("invalid host"))};m.aio.commandhandler.IntHandler.prototype.getStates=function(a,c,d,b,e,g,f){c?(f=this._executorPool.getExecutor(a,c),f||(f=new m.aio.commandhandler.Executor(a,c,this),this._executorPool.addExecutor(f)),a=f.getHost(),this._cloudForwardHost&&this._cloudForwardHost!=a?this._cloudForwardHost.forwardGetStates(e,g,d,b):(b=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_STATUS,b),b.devices=d,f.execute(b))):b&&b(Error("invalid host"))};
m.aio.commandhandler.IntHandler.prototype.getStatesForSingleDevice=function(a,c,d,b,e){if(c){var g=this._executorPool.getExecutor(a,c);g||(g=new m.aio.commandhandler.Executor(a,c,this),this._executorPool.addExecutor(g));a=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS,e);a.device=d;a.devices=b;g.execute(a)}else e&&e(Error("invalid host"))};
m.aio.commandhandler.IntHandler.prototype.reportStates=function(a,c){this._statesListener&&this._statesListener.reportStates&&this._statesListener.reportStates(a,c)};m.aio.commandhandler._SingeltonHandler=new m.aio.commandhandler.IntHandler;m.aio.commandhandler.Handler=function(){};m.aio.commandhandler.Handler.prototype.Handler=m.aio.commandhandler.IntHandler;m.aio.commandhandler.Handler.prototype.CentralHandler=m.aio.commandhandler._SingeltonHandler;
"undefined"!==typeof module&&null!=module&&module.exports&&(module.exports=new m.aio.commandhandler.Handler);
