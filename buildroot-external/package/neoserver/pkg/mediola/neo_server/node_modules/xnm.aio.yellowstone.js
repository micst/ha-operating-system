var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.yellowstone=xnm.aio.yellowstone||{};
xnm.aio.yellowstone.Cloudy=function(){var l=[1,2,3,4,5],c=function(a,b,d){this._taskBuffer=null;this._cloudy=a;this._command=b;this._callback=d};c.prototype.run=function(){this._cloudy._logger.log("debug","run command task: "+JSON.stringify(this._command));var a=this;if(this._command.raw)var b=this._cloudy._buildRawCommandReq(this._command.raw);else if(this._command.hexValue)b=this._cloudy._buildHexCommandReq(this._command.bg,this._command.sig,this._command.hexValue);else if("toggle"==this._command.command){var d=
this._cloudy._buildStateReq(this._command.bg);this._cloudy._doStateReq(d,function(d,c){if(d)!d||1!=d.errorCode&&2!=d.errorCode&&3!=d.errorCode?a._taskBuffer._finishLastTask(d):a._taskBuffer._finishAllTask(d);else{var g=a._command.sig;c&&c.intState&&"undefined"!=typeof c.intState[g]&&null!=c.intState[g]?(b=a._cloudy._buildCommandReq(a._command.bg,a._command.sig,0==c.intState[g]?1:0),a._cloudy._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):
a._taskBuffer._finishAllTask(b)})):a._taskBuffer._finishLastTask(d)}})}else b=this._cloudy._buildCommandReq(this._command.bg,this._command.sig,this._command.value);b&&this._cloudy._doCommandReq(b,function(b){!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode?a._taskBuffer._finishLastTask(b):a._taskBuffer._finishAllTask(b)})};var f=function(a,b,d){this._taskBuffer=null;this._cloudy=a;this._bgs=b;this._callback=d};f.prototype.run=function(){this._cloudy._logger.log("debug","run status task: "+JSON.stringify(this._bgs));
var a=this,b={},d=0,g=function(c,h){c&&4!=c.errorCode&&5!=c.errorCode?1==c.errorCode||2==c.errorCode||3==c.errorCode?a._taskBuffer._finishAllTask(c):a._taskBuffer._finishLastTask(c):(h&&(b[a._bgs[d]]=h),d++,d<a._bgs.length?(c=-1==a._bgs[d]?a._cloudy._buildRawMsgReq():a._cloudy._buildStateReq(a._bgs[d]),a._cloudy._doStateReq(c,g)):a._taskBuffer._finishLastTask(null,b))};var c=-1==this._bgs[d]?this._cloudy._buildRawMsgReq():this._cloudy._buildStateReq(this._bgs[d]);this._cloudy._doStateReq(c,g)};var m=
function(a){this._cloudy=a;this._buffer=[]};m.prototype.executeTask=function(a){var b=this._buffer.length;a._taskBuffer=this;this._buffer.push(a);0==b&&this._doNextTask()};m.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};m.prototype._finishLastTask=function(a,b){if(0<this._buffer.length){var d=this._buffer[0];d&&d._callback&&(d._callback(a,b),d._callback=null);this._buffer.splice(0,1)}this._doNextTask()};m.prototype._finishAllTask=function(a){var b=this._buffer;this._buffer=
[];for(var d=0;d<b.length;d++)b[d]&&b[d]._callback&&(b[d]._callback(a),b[d]._callback=null)};var k=function(a){this._cloudy=a;this._logger=a._logger;this._buffer=[];this._dataBuffer=this._bufferEmptyTo=null};k.prototype.RESPONSE_TO=2E3;k.prototype.sendPacket=function(a,b){if(a){var d=this._buffer.length;this._buffer.push({packet:a,callback:b});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==d&&this._sendNextPacket()}else b&&b(Error("message is null"))};k.prototype._sendNextPacket=
function(){if(0!=this._buffer.length){var a=this,b=this._buffer[0];this._cloudy._sendPacket(b.packet,function(d){d?(d.errorCode=l[0],a._finishAllPacket(d)):b.timeout=setTimeout(function(){a._logger.log("warn","packet response timeout");var b=Error("packet reponse timeout");b.errorCode=l[3];a._finishLastPacket(b)},a.RESPONSE_TO)})}};k.prototype._finishLastPacket=function(a,b){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=
null),this._buffer[0].callback&&(this._buffer[0].callback(a,b),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var d=this;this._bufferEmptyTo=setTimeout(function(){d._bufferEmptyTo=null;0==d._buffer.length&&d._cloudy._disconnect()},500)}else this._sendNextPacket()};k.prototype._finishAllPacket=function(a){var b=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var d=0;d<b.length;d++)b[d]&&(b[d].timeout&&
(clearTimeout(b[d].timeout),b[d].timeout=null),b[d].callback&&(b[d].callback(a),b[d].callback=null))};k.prototype._hex2ascii=function(a){for(var b="",d=0;d<a.length;d+=2)b+=String.fromCharCode(parseInt(a.substr(d,2),16));return b};k.prototype._handlePacket=function(a){if(0<this._buffer.length&&this._buffer[0]){var b=this._buffer[0].packet;if(b&&3<=b.length)switch(b.substr(0,3)){case "CRO":case "CWO":case "CRS":a.raw&&2<=a.raw.length&&(a.params=a.raw.substr(1));break;case "CGO":a.raw&&2<=a.raw.length&&
(a.params=a.raw.substr(1).trim().split(" "))}this._logger.log("trace","parsed packet:"+JSON.stringify(a));this._finishLastPacket(null,a)}};k.prototype._handleData=function(){for(var a=null,b=!1,d=0;d<=this._dataBuffer.length-2;d+=2){var g=this._dataBuffer.substr(d,2),c=null;d<=this._dataBuffer.length-4&&(c=this._dataBuffer.substr(d+2,2));if("04"==g.toLowerCase()){a=this._dataBuffer.substr(0,d);b=!0;this._dataBuffer=d==this._dataBuffer.length-2?null:this._dataBuffer.substr(d+2);break}else if(("0d"==
g.toLowerCase()||"0a"==g.toLowerCase())&&"03"==c.toLowerCase()){a=this._dataBuffer.substr(0,d);this._dataBuffer=d==this._dataBuffer.length-4?null:this._dataBuffer.substr(d+4);break}}"undefined"!=typeof a&&null!=a&&(a=this._hex2ascii(a),d={},d.interrupt=b,d.raw=a,d.ok=">"==a.charAt(0),this._logger.log("trace","receive packet:"+JSON.stringify(d)),this._handlePacket(d));"undefined"!=typeof a&&null!=a&&this._dataBuffer&&this._handleData()};k.prototype._onSocketData=function(a){a&&(this._dataBuffer=this._dataBuffer?
this._dataBuffer+a:a);this._dataBuffer&&this._handleData()};k.prototype._onSocketTimeout=function(){};k.prototype._onSocketError=function(a){a.errorCode=l[1];this._finishAllPacket(a)};k.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=l[2];this._finishAllPacket(a)};var e=function(a,b){this._logger=require("x.logger.js").getLogger("xnm.aio.yellowstone.Cloudy");this._ip=a;this._port=b;this._port||(this._port=4E3);this._socket=null;this._taskBuffer=new m(this);this._packetBuffer=
new k(this)};e.prototype.executeCommandCreator=function(a,b,d){if(b&&b.value){switch(b.value){case "rawCmd":if(!b.ext){d&&d(Error("command rawCmd ext null"));return}var g={raw:b.ext};break;default:if(!a||"undefined"==typeof a.bg||null==a.bg||"undefined"==typeof a.sig||null==a.sig){d&&d(Error("device invalid"));return}switch(b.value){case "on":g={bg:a.bg,sig:a.sig,value:1};break;case "off":g={bg:a.bg,sig:a.sig,value:0};break;case "toggle":g={bg:a.bg,sig:a.sig,command:"toggle"};break;default:if("undefined"==
typeof b.ext||null==b.ext){d&&d(Error("command setValue ext null"));return}switch(b.value){case "setHex":g={bg:a.bg,sig:a.sig,hexValue:b.ext};break;case "setInt":b=parseInt(b.ext);g={bg:a.bg,sig:a.sig,value:b};break;case "setFloat":b=parseFloat(b.ext);if(0==parseFloat(a.scale))b=0;else{g=parseFloat(a.scale);if(isNaN(g)||!g)g=1;b=Math.round(b/g)}g={bg:a.bg,sig:a.sig,value:b}}}}g?this._executeCommand(g,d):d&&d(Error("no such command"))}else d&&d(Error("command is null"))};e.prototype.getStatesCreator=
function(a,b,d){if(b)if(0==b.length)d&&d(null,[]);else{a=[];for(var g=0;g<b.length;g++){var c=b[g];c&&(c=!c.device||c.device.ip?-1:c.device.bg,-1==a.indexOf(c)&&a.push(c))}this._getStates(a,function(a,g){a=[];if(g)for(var c=0;c<b.length;c++)if(b[c]&&b[c].id){var e="?";if((!b[c].device||b[c].device.ip)&&b[c].status&&b[c].status.value)"undefined"!=typeof g["-1"]&&null!=g["-1"]&&(e=g["-1"]);else if(b[c].device&&b[c].status&&b[c].status.value){var h=b[c].device.bg,f=b[c].device.sig,k=b[c].device.scale;
if("undefined"!=typeof h&&null!=h&&"undefined"!=typeof f&&null!=f&&g[h]&&(h=g[h],"undefined"!=typeof h&&null!=h))switch(b[c].status.value){case "stateHex":h.hexState&&h.hexState[f]&&(e=h.hexState[f]);break;case "stateFloat":h.intState&&"undefined"!=typeof h.intState[f]&&null!=h.intState[f]&&(e=h.intState[f],"undefined"!=typeof k&&null!=k&&(e*=parseFloat(k)));break;case "stateInt":h.intState&&"undefined"!=typeof h.intState[f]&&null!=h.intState[f]&&(e=h.intState[f]);break;case "stateBi":h.intState&&
"undefined"!=typeof h.intState[f]&&null!=h.intState[f]&&(e=h.intState[f],e=0==e?"off":"on")}}if("undefined"==typeof e||null==e)e="?";a.push({id:b[c].id,status:e})}d&&d(null,a)})}else d&&d(Error("deviceList is null"))};e.prototype._executeCommand=function(a,b){this._logger.log("debug","execute command: "+JSON.stringify(a));a=new c(this,a,b);this._taskBuffer.executeTask(a)};e.prototype._getStates=function(a,b){this._logger.log("debug","get states: "+JSON.stringify(a));a=new f(this,a,b);this._taskBuffer.executeTask(a)};
e.prototype._resolveMsg=function(a){var b=null;a&&(a=a.params.replace(/"/g,""),">"==a.charAt(0)&&1<a.length&&(a=a.substr(1)),b=a.trim());return b};e.prototype._resolveStatus=function(a){var b=[],d=[];if(a.params)for(var c=0;c<a.params.length;c++){var h=parseInt(a.params[c],16);h&2147483648&&(h=(h&2147483647)-2147483648);for(var e=a.params[c];8>e.length;)e="0"+e;d.push(e);b.push(h)}return{hexState:d,intState:b}};e.prototype._doCommandReq=function(a,b){this._packetBuffer.sendPacket(a,function(a,c){a?
b(a):c&&!c.interrupt&&c.ok&&c.params?b():(a=Error("CWO response error"),a.errorCode=5,b(a))})};e.prototype._doStateReq=function(a,b){var d=this;this._packetBuffer.sendPacket(a,function(c,e){c?b(c):e&&!e.interrupt&&e.ok&&e.params?(c=0==a.indexOf("CRS")?d._resolveMsg(e):d._resolveStatus(e),b(null,c)):(c=Error("state (CGO, CRS) response error"),c.errorCode=5,b(c))})};e.prototype._buildCommandReq=function(a,b,d){-2147483648>d&&(d=-2147483648);2147483647<d&&(d=2147483647);0>d&&(d=d+2147483648|2147483648);
return"CWO "+a+" "+b+" "+d.toString(16)};e.prototype._buildRawCommandReq=function(a){return'CWR "'+a+'"'};e.prototype._buildHexCommandReq=function(a,b,d){8<d.length&&(d=d.substr(d.length-8));return"CWO "+a+" "+b+" "+d};e.prototype._buildStateReq=function(a){return"CGO "+a+" 0 64"};e.prototype._buildRawMsgReq=function(){return"CRS"};e.prototype._buildData=function(a){for(var b=[],d=0;d<a.length;d++)b.push(a.charCodeAt(d));b.push(13);b.push(3);return new Buffer(b)};e.prototype._sendPacket=function(a,
b){if(this._socket){this._logger.log("trace","send packet:"+a);var d=this._buildData(a);this._socket.write(d,"binary");b()}else{var c=this;this._connect(function(d){d?b(d):c._sendPacket(a,b)})}};e.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var b=this,d={port:this._port,host:this._ip},c=require("net").connect(d);c.setTimeout(5E3);c.__connected=!1;c.setEncoding("hex");c.on("connect",function(){b._logger.log("trace","connect to cloudy:"+b._ip);c.__connected=!0;
b._socket=c;a()});c.on("data",function(a){b._logger.log("trace","receive from cloudy "+(c.__disconnected?"(closed)":"")+":"+b._ip+" data:"+a);c.__disconnected||b._packetBuffer._onSocketData(a)});c.on("error",function(d){c.__connected?(b._logger.log("trace","cloudy"+(c.__disconnected?"(closed)":"")+":"+b._ip+" error:"+d.message),c.destroy(),c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketError(d))):(b._logger.log("trace","cloudy:"+b._ip+" connection error:"+d.message),
a(d))});c.on("timeout",function(){c.__connected?(b._logger.log("trace","cloudy"+(c.__disconnected?"(closed)":"")+":"+b._ip+" data timeout"),c.__disconnected||b._packetBuffer._onSocketTimeout()):(b._logger.log("trace","cloudy:"+b._ip+" connection timeout"),c.destroy&&c.destroy(),a(Error("timeout")))});c.on("close",function(){b._logger.log("trace","cloudy"+(c.__disconnected?"(closed)":"")+":"+b._ip+" close socket");c.__disconnected||(c.__disconnected=!0,b._socket=null,b._packetBuffer._onSocketClose(c))});
c._doConnect&&"function"==typeof c._doConnect&&c._doConnect();return c};e.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};e.prototype.toJSON=function(){return{sys:"cloudy",ip:this._ip,port:this._port}};e.prototype.equalsTo=function(a){return a&&a instanceof e?this._ip==a._ip&&this._port==a._port:!1};return e}();
xnm.aio.yellowstone.Handler=function(){var l=function(){};l.prototype.Cloudy=xnm.aio.yellowstone.Cloudy;l.prototype.devicemanager=null;l.prototype.registModule=function(c){c.register("cloudy","yellowstone")};l.prototype.resolveGateway=function(c){return c&&c.ip?new xnm.aio.yellowstone.Cloudy(c.ip,c.port):null};l.prototype.getDeviceCommands=function(c,f){c=(c=this.devicemanager.applyUIFilter(c,{catagory:"command",elems:"*"}))?c.command:[];f&&f(null,c)};l.prototype.getDeviceStatus=function(c,f){c=(c=
this.devicemanager.applyUIFilter(c,{catagory:"status",elems:"*"}))?c.status:[];f&&f(null,c)};l.prototype.getGatewayCommands=function(c,f){c=(c=this.devicemanager.applyUIFilterGateway(c,{catagory:"command",elems:"*"}))?c.command:[];f&&f(null,c)};l.prototype.getGatewayStatus=function(c,f){c=(c=this.devicemanager.applyUIFilterGateway(c,{catagory:"status",elems:"*"}))?c.status:[];f&&f(null,c)};l.prototype.doCommand=function(c,f,l,k){(c=this.resolveGateway(c))?c.executeCommandCreator(f,l,function(c){k&&
k(c)}):k&&k(Error("gateway json format invalid"))};l.prototype.doStatus=function(c,f,l,k,e){(f=this.resolveGateway(f))?f.getStatesCreator(null,[{id:c,device:l,status:k}],function(a,b){a?e&&e(a):e&&e(null,b[0])}):e&&e(Error("gateway json format invalid"))};l.prototype.getDeviceList=function(c,f){this.resolveGateway(c)?f&&f(null,this.devicemanager.BG_LIST):f&&f(Error("gateway json format invalid"))};return l}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.yellowstone.Handler);
