var x=x||{};x.hub=x.hub||{};x.hub.password=x.hub.password||{};
x.hub.password.PasswordManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.password.PasswordManager");this._pinHash=this._fileManager=null;this._secureClients={}};e.MAX_SECURE_CLIENT_COUNT=5;e.prototype.init=function(a,b){this._fileManager=a;this._pinHash=localStorage.getItem("x.hub.Server.pin");b&&b()};e.prototype.setPin=function(a,b){if(!this.checkPin(a)||!b)return!1;this._pinHash=this._hashPin(b);localStorage.setItem("x.hub.Server.pin",this._pinHash);return!0};
e.prototype.checkPin=function(a){if(!a)return!1;a=this._hashPin(a);var b=this._pinHash?this._pinHash:this._hashPin("0000");return a==b};e.prototype.reset=function(){this._pinHash=null;if(this._fileManager){var a=require("fs"),b=require("fs-extra"),c=require("path"),d=this._fileManager.getUserRootDataPath();c=c.join(d,"localstorage","x.hub.Server.pin");a.existsSync(c)&&(this._logger.log("trace","remove file "+c),b.removeSync(c))}};e.prototype._hashPin=function(a){return require("x.crypt.js").MD5(a+
"_SALT!")};e.prototype.addSecureClient=function(a,b,c){if(a){var d=0,f=null,g=null,h,k;for(k in this._secureClients)k==a?delete this._secureClients[k]:(h=this._secureClients[k])&&h.lastAccess?(d++,g)?h.lastAccess<f&&(g=k,f=h.lastAccess):(g=k,f=h.lastAccess):delete this._secureClients[k];d>=e.MAX_SECURE_CLIENT_COUNT&&delete this._secureClients[g];f=require("crypto");g=require("x.crypt.js");h=f.randomBytes(32).toString("hex");d=(new Buffer(g.Curve25519.curve25519(h))).toString("hex");g=g.Curve25519.curve25519(h,
b);b=g.slice(0,16);g=g.slice(16,32);f=f.randomBytes(16).toString("hex");this._secureClients[a]={token:f,key:b,iv:g,lastAccess:null};c&&c(null,this._secureClients[a],d)}else c&&c(Error("invalid client ip"))};e.prototype.decodeSecureReq=function(a,b,c){if(a)if(this._secureClients[a])if(b.body){a=this._secureClients[a];var d=require("x.crypt.js");d.AES.setSize(128);var f=d.AES.decrypt(d.AES.h2a(b.body),a.key,a.iv,!1);d=d.AES.a2s(f);32>d.length?c&&c(Error("invalid secure request")):d.substr(0,32)!=a.token?
c&&c(Error("unknown client token")):(d=d.substr(32),a=require("url").parse(d),b.method="GET",b.url=d,a.pathname&&(b.path=a.pathname),a.query&&(d=require("querystring"),b.query=d.parse(a.query)),c&&c(null,b))}else c&&c(Error("invalid secure request"));else c&&c(Error("unknown client ip"));else c&&c(Error("invalid client ip"))};e.prototype.encodeSecureRsp=function(a,b,c){if(a)if(this._secureClients[a])if(b){var d=this._secureClients[a];a=require("x.crypt.js");a.AES.setSize(128);var f=new Buffer(b,"utf8");
Array.prototype.slice.call(f);b=a.AES.encrypt(a.AES.s2a(b),d.key,d.iv);c&&c(null,a.AES.a2h(b))}else c&&c(null,b);else c&&c(Error("unknown client ip"));else c&&c(Error("invalid client ip"))};return e}();
x.hub.password.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.password.Handler");this._passwordManager=new x.hub.password.PasswordManager};e.prototype.init=function(a,b){this._initHttpApi();this._passwordManager.init(a,function(a){a&&b(a)})};e.prototype._initHttpApi=function(){var a=this;require("x.hub.js").getServer().addRoute("/pwd",{method:"GET",source:1,lock:1},function(b,c,d){(b=b.query?b.query.pin:null)?a.checkPin(b)?c.json({XC_SUC:{}}):c.json({XC_ERR:{code:"000003",
msg:"check failed"}}):c.json({XC_ERR:{code:"000005",msg:"invalid parameter"}})})};e.prototype.checkPin=function(a){return this._passwordManager.checkPin(a)};e.prototype.setPin=function(a,b){return this._passwordManager.setPin(a,b)};e.prototype.reset=function(a){this._passwordManager.reset();a&&a()};e.prototype.registSecureClient=function(a,b,c){this._passwordManager.addSecureClient(a,b,function(a,b,e){a?c&&c(a):(a=require("x.crypt.js"),a.AES.setSize(128),b=a.AES.encrypt(a.AES.h2a(b.token),b.key,b.iv),
b=a.AES.a2h(b),c&&c(null,{key:e,token:b}))})};e.prototype.decodeSecureReq=function(a,b,c){this._passwordManager.decodeSecureReq(a,b,function(a,b){c&&c(a,b)})};e.prototype.encodeSecureRsp=function(a,b,c){this._passwordManager.encodeSecureRsp(a,b,function(a,b){c&&c(a,b)})};return e}();module.exports=new x.hub.password.Handler;
