var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var e=a.length,c=0;c<e;c++){var f=a[c];if(b.call(d,f,c,a))return{i:c,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,d,e){if(b){d=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var c=a[e];c in d||(d[c]={});d=d[c]}a=a[a.length-1];e=d[a];b=b(e);b!=e&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");var m=m||{};m.aio=m.aio||{};m.aio.skinmanager=m.aio.skinmanager||{};
m.aio.skinmanager.Resource=function(){this.mtime=this.size=this.sha1=this.file=this.name=this.widget=null};m.aio.skinmanager.Resource.load=function(a,b,d,e){var c=require("unorm"),f=new m.aio.skinmanager.Resource;f.widget=d;f.name=c.nfc(b);f.file=a;e&&e(null,f)};m.aio.skinmanager.Resource.loadSync=function(a,b,d){var e=require("unorm"),c=new m.aio.skinmanager.Resource;c.widget=d;c.name=e.nfc(b);c.file=a;return c};
m.aio.skinmanager.Resource.prototype={copy:function(a,b,d){this._copy(this.file,a,b,d)},copySync:function(a,b){this._copySync(this.file,a,b)},_copy:function(a,b,d,e){var c=require("fs-extra"),f=require("path");b?d?this.widget&&this.widget.type&&this.widget.name?this.file?(b=b+f.sep+d+f.sep+this.widget.type+f.sep+this.widget.name+f.sep+this.name,b==this.file?e&&e():c.copy(a,b,{clobber:!0},function(a){e&&e(a)})):e&&e(Error("resource file invalid")):e&&e(Error("resource widget invalid")):e&&e(Error("skinId invalid")):
e&&e(Error("skinFolder invalid"))},_copySync:function(a,b,d){var e=require("fs-extra"),c=require("path");if(!b)throw Error("skinFolder invalid");if(!d)throw Error("skinId invalid");if(!this.widget||!this.widget.type||!this.widget.name)throw Error("resource widget invalid");if(!this.file)throw Error("resource file invalid");b=b+c.sep+d+c.sep+this.widget.type+c.sep+this.widget.name+c.sep+this.name;b!=this.file&&e.copySync(a,b,{clobber:!0})},del:function(a){this.file?require("fs").unlink(this.file,function(b){a&&
a(b)}.bind(this)):a&&a(Error("resource file invalid"))},getRef:function(){if(!this.widget||!this.widget.skin)return null;var a="";if(this.widget.skin instanceof m.aio.skinmanager.DummySkin||this.widget.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin)a=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/";return a+this.widget.type+"/"+this.widget.name+"/"+this.name},getURL:function(){if(!this.widget||!this.widget.skin)return null;var a=this.widget.skin.getURL();a.widgetType=
this.widget.type;a.widgetName=this.widget.name;a.resourcePath=this.name;return a.toString()},toJSON:function(){return{name:this.name,ref:this.getRef(),url:this.getURL()}}};m.aio.skinmanager.Widget=function(){this.name=this.type=this.skin=null;this.resources=[]};m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE="misc";m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME="default";
m.aio.skinmanager.Widget.loadType=function(a,b,d,e){var c=require("fs"),f=require("async"),g=require("path");c.readdir(a,function(c,n){if(c)e&&e(c);else{var k=[];f.eachLimit(n,100,function(c,e){m.aio.skinmanager.Widget.load(a+g.sep+c,b,c,d,function(a,b){!a&&b&&k.push(b);e()})},function(a){e&&e(a,k)})}})};
m.aio.skinmanager.Widget.load=function(a,b,d,e,c){var f=require("fs"),g=require("path");require("async");f.readdir(a,function(f,n){if(f)c&&c(f);else{f=require("unorm");var k=new m.aio.skinmanager.Widget;k.skin=e;k.type=f.nfc(b);k.name=f.nfc(d);var h=[];n.forEach(function(b){".DS_Store"!==b&&(b=new m.aio.skinmanager.Resource.loadSync(a+g.sep+b,b,k),h.push(b))});h&&0!=h.length?(k.resources=h,c&&c(null,k)):c&&c(Error("widget has no resources"))}})};
m.aio.skinmanager.Widget.prototype={getLocation:function(){var a=null;this.skin&&(a=this.skin instanceof m.aio.skinmanager.DummySkin?"in_remote_custom":this.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin?"local_custom":this.skin instanceof m.aio.skinmanager.RemoteSkin?"in_remote_skin":this.skin instanceof m.aio.skinmanager.CustomSkin?"local_custom_skin":"local_skin");return a},copy:function(a,b,d){this._copy(this.skin.path,a,b,d)},copySync:function(a,b){this._copySync(this.skin.path,
a,b)},_copy:function(a,b,d,e){var c=require("fs-extra"),f=require("path");a?b?d?this.type&&this.name?c.copy(a+f.sep+this.type+f.sep+this.name,b+f.sep+d+f.sep+this.type+f.sep+this.name,{clobber:!0},function(a){e&&e(a)}):e&&e(Error("widget type or name invalid")):e&&e(Error("skinId invalid")):e&&e(Error("dstSkinFolder invalid")):e&&e(Error("srcSkinFolder invalid"))},_copySync:function(a,b,d){var e=require("fs-extra"),c=require("path");if(!a)throw Error("srcSkinFolder invalid");if(!b)throw Error("dstSkinFolder invalid");
if(!d)throw Error("skinId invalid");if(!this.type||!this.name)throw Error("widget type or name invalid");e.copySync(a+c.sep+this.type+c.sep+this.name,b+c.sep+d+c.sep+this.type+c.sep+this.name,{clobber:!0})},del:function(a){if(this.skin)if(this.type)if(this.name){var b=this.skin.path;if(b){var d=require("path");require("fs-extra").remove(b+d.sep+this.type+d.sep+this.name,function(b){a&&a(b)})}else a&&a(Error("skin path is null"))}else a&&a(Error("widgetName is null"));else a&&a(Error("widgetType is null"));
else a&&a(Error("skin is null"))},hasSameRef:function(a){return this.type==a.type&&this.name==a.name},merge:function(a){if(a.resources&&0!=a.resources.length)if(this.resources&&0!=this.resources.length){for(var b=[],d=0;d<a.resources.length;d++){for(var e=!1,c=0;c<this.resources.length;c++)if(this.resources[c].name==a.resources[d].name){e=!0;this.resources[c]=a.resources[d];break}e||b.push(a.resources[d])}this.resources=this.resources.concat(b)}else this.resources=a.resources},toJSON:function(){var a=
{type:this.type,name:this.name,resources:[]};a._loc=this.getLocation();this.resources.forEach(function(b){a.resources.push(b.toJSON())});return a}};m.aio.skinmanager.Skin=function(a){this.type=a;this.path=this.info=this.schema=this.base=this.system=this.version=this.name=this.id=null};m.aio.skinmanager.Skin.SETTINGS_FILE="settings";m.aio.skinmanager.Skin.TYPE={SYSTEM:1,CUSTOM:2,REMOTE:3,DUMMY:4};
m.aio.skinmanager.Skin.load=function(a,b,d,e){if(a){var c=require("fs"),f=require("path"),g=a+f.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;c.readFile(g,{encoding:"utf8"},function(c,f){if(c){if(d.skinType!==m.aio.skinmanager.Skin.TYPE.REMOTE){e&&e(c);return}f=JSON.stringify({id:b,name:"in-remote",system:1})}if(f&&0!=f.length){c=null;try{c=JSON.parse(f)}catch(l){e&&e(Error("settings file of "+g+" is not in json"));return}if(c.name){switch(d.skinType){case m.aio.skinmanager.Skin.TYPE.SYSTEM:f=new m.aio.skinmanager.SystemSkin;
break;case m.aio.skinmanager.Skin.TYPE.CUSTOM:f=new m.aio.skinmanager.CustomSkin;break;case m.aio.skinmanager.Skin.TYPE.REMOTE:if(!d.tenantId||!d.remoteId){e&&e(Error("skinType info invalid"));return}f=new m.aio.skinmanager.RemoteSkin(d.tenantId,d.remoteId);break;case m.aio.skinmanager.Skin.TYPE.DUMMY:if(!d.tenantId||!d.remoteId){e&&e(Error("skinType info invalid"));return}f=new m.aio.skinmanager.DummySkin(d.tenantId,d.remoteId);break;default:e&&e(Error("skin type invalid"));return}f.id=b;f.name=
c.name;f.version=c.version?c.version:0;f.system=c.system?c.system:1;f.base=c.base;f.schema=c.schema?c.schema:0;f.info=c.info||null;f.path=a;e&&e(null,f)}else e&&e(Error("skin has no name"))}else e&&e(Error("settings file of "+g+" is empty"))})}else e&&e(Error("invalid skin path"))};
m.aio.skinmanager.Skin.prototype={updateVersion:function(a,b){var d=this,e=require("fs"),c=require("path"),f=this.path+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;e.readFile(f,{encoding:"utf8"},function(c,k){if(c)b&&b(c);else if(k&&0!=k.length){c=null;try{c=JSON.parse(k)}catch(n){b&&b(Error("settings file of "+f+" is not in json"));return}parseInt(c.version)==parseInt(a)?b&&b(null):(c.version=parseInt(a),e.writeFile(f,JSON.stringify(c),{encoding:"utf8"},function(c){c||(d.version=parseInt(a));b&&b(c)}))}else b&&
b(Error("settings file of "+f+" is empty"))})},loadWidgets:function(a){var b=require("fs"),d=require("path"),e=require("async");b.readdir(this.path,function(b,f){if(b)a&&a(b);else{var c=[];e.eachLimit(f,100,function(a,b){m.aio.skinmanager.Widget.loadType(this.path+d.sep+a,a,this,function(a,d){!a&&d&&(c=c.concat(d));b()})}.bind(this),function(b){a&&a(b,c)}.bind(this))}}.bind(this))},toJSON:function(){return{type:this.type,id:this.id,name:this.name,version:this.version,system:this.system,base:this.base,
schema:this.schema,folder:this.path,info:this.info}}};m.aio.skinmanager.SystemSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.SYSTEM)};m.aio.skinmanager.SystemSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.SystemSkin.prototype.constructor=m.aio.skinmanager.SystemSkin;m.aio.skinmanager.SystemSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.CustomSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.CUSTOM)};m.aio.skinmanager.CustomSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.CustomSkin.prototype.constructor=m.aio.skinmanager.CustomSkin;m.aio.skinmanager.CustomSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.LocalUrl;a.skinId=this.id;return a};
m.aio.skinmanager.RemoteSkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.REMOTE);this.tenantId=a;this.remoteId=b};m.aio.skinmanager.RemoteSkin.URL_PREFIX="REMOTE";m.aio.skinmanager.RemoteSkin.prototype=new m.aio.skinmanager.Skin;m.aio.skinmanager.RemoteSkin.prototype.constructor=m.aio.skinmanager.RemoteSkin;
m.aio.skinmanager.RemoteSkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;a.skinId=this.id;return a};m.aio.skinmanager.DummySkin=function(a,b){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY);this.id=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;this.tenantId=a;this.remoteId=b};m.aio.skinmanager.DummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.DummySkin.prototype.constructor=m.aio.skinmanager.DummySkin;m.aio.skinmanager.DummySkin.prototype.getURL=function(){var a=new m.aio.skinmanager.InRemoteCustomWidgetUrl;a.tenantId=this.tenantId;a.remoteId=this.remoteId;return a};m.aio.skinmanager.LocalCustomWidgetDummySkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY)};m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype=new m.aio.skinmanager.Skin;
m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetDummySkin;m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.getURL=function(){return new m.aio.skinmanager.LocalCustomWidgetUrl};m.aio.skinmanager.Url=function(a){this.prefix=a};m.aio.skinmanager.Url.PREFIX={LOCAL:"LOCAL",INREMOTE:"INREMOTE"};
m.aio.skinmanager.Url.resolve=function(a){a=a.split("/");switch(a[0]){case m.aio.skinmanager.Url.PREFIX.LOCAL:if(2>a.length)return null;switch(a[1]){case "skins":if(6>a.length)return null;var b=new m.aio.skinmanager.LocalUrl;b.skinId=a[2];b.widgetType=a[3];b.widgetName=a[4];var d=a.slice(5);b.resourcePath=d.join("/");break;case "custom":if(5>a.length)return null;b=new m.aio.skinmanager.LocalCustomWidgetUrl;b.widgetType=a[2];b.widgetName=a[3];d=a.slice(4);b.resourcePath=d.join("/");break;default:return null}break;
case m.aio.skinmanager.Url.PREFIX.INREMOTE:if(6>a.length||"tenant"!=a[1]||"remote"!=a[3])return null;switch(a[5]){case m.aio.skinmanager.SkinManager.SKIN_FLODER:b=new m.aio.skinmanager.InRemoteUrl;if(10>a.length)return null;b.skinId=a[6];b.widgetType=a[7];b.widgetName=a[8];d=a.slice(9);b.resourcePath=d.join("/");break;case m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER:b=new m.aio.skinmanager.InRemoteCustomWidgetUrl;if(9>a.length)return null;b.widgetType=a[6];b.widgetName=a[7];d=a.slice(8);
b.resourcePath=d.join("/");break;default:return null}b.tenantId=a[2];b.remoteId=a[4];break;default:return null}return b};m.aio.skinmanager.LocalUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=this.skinId=null};m.aio.skinmanager.LocalUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.LocalUrl.prototype.constructor=m.aio.skinmanager.LocalUrl;
m.aio.skinmanager.LocalUrl.prototype.toString=function(){return this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};m.aio.skinmanager.LocalCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL);this.resourcePath=this.widgetName=this.widgetType=null};m.aio.skinmanager.LocalCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;
m.aio.skinmanager.LocalCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetUrl;m.aio.skinmanager.LocalCustomWidgetUrl.prototype.toString=function(){return this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.skinId=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteUrl.prototype.constructor=m.aio.skinmanager.InRemoteUrl;
m.aio.skinmanager.InRemoteUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.InRemoteCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE);this.resourcePath=this.widgetName=this.widgetType=this.remoteId=this.tenantId=null};m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype=new m.aio.skinmanager.Url;m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.InRemoteCustomWidgetUrl;
m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null};
m.aio.skinmanager.SkinManager={SKIN_FLODER:"skins",CUSTOM_IN_REMOTE_WIDGET_FOLDER:"custom",RESOURCE_FOLDER:"resources",sysSkinsPath:null,customSkinsPath:null,customWidgetPath:null,_configmanager:null,skins:[],_logger:null,init:function(a,b,d){var e=function(a){var b=require("async"),c=require("fs");b.parallel([function(a){c.mkdir(this.sysSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customSkinsPath,function(){a()})}.bind(this),function(a){c.mkdir(this.customWidgetPath,function(){a()})}.bind(this)],
function(){a&&a()})}.bind(this);this._logger=require("x.logger.js").getLogger("m.aio.skinmanager.SkinManager");var c=require("path"),f=a.getAppResourcePath();f?(a=a.getUserResourcePath())?(this.sysSkinsPath=f+c.sep+this.SKIN_FLODER,this.customSkinsPath=a+c.sep+this.SKIN_FLODER,this.customWidgetPath=a+c.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this._configmanager=b,require("async").series([function(a){e(a)}.bind(this),function(a){this._loadAllSkins(function(b,c){!b&&c&&(this.skins=c);a()}.bind(this))}.bind(this)],
function(){d&&d()}.bind(this))):d&&d(Error("user resource path invalid")):d&&d(Error("app resource path invalid"))},_loadAllSkins:function(a){var b=[];require("async").parallel([function(a){this._loadSkins(this.sysSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.SYSTEM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this),function(a){this._loadSkins(this.customSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.CUSTOM},function(d,c){!d&&c&&(b=b.concat(c));a()})}.bind(this)],function(d){a&&a(d,b)})},
_loadSkins:function(a,b,d){var e=require("fs"),c=require("path"),f=require("async"),g=[];e.readdir(a,function(e,n){!e&&n?f.each(n,function(d,e){m.aio.skinmanager.Skin.load(a+c.sep+d,d,b,function(a,b){!a&&b&&g.push(b);e()})}.bind(this),function(a){d(a,g)}):d(null,g)}.bind(this))},_getPermittedSkins:function(a,b,d){this._configmanager.trace("config/tenants/"+a,function(a,c){if(a)d&&d(a);else{a=c.license;c=[];for(var e=require("m.aio.infomanager"),g=0;g<b.length;g++)b[g]&&b[g].id&&(2==b[g].type?c.push(b[g]):
e.permitSkin(b[g].id,a)&&c.push(b[g]));d&&d(null,c)}}.bind(this))},_isSkinPermitted:function(a,b,d){for(var e=0;e<this.skins.length;e++)if(this.skins[e]&&this.skins[e].id&&this.skins[e]&&this.skins[e].id==b&&2==this.skins[e].type){d&&d(null,!0);return}e=this._configmanager;var c=require("m.aio.infomanager");e.trace("config/tenants/"+a,function(a,e){a?d&&d(a):d&&d(null,c.permitSkin(b,e.license))}.bind(this))},getResourceByURL:function(a,b){var d=function(a,b,c){var d=this._getSkin(a,b.skinId);d?e(d,
b,function(f,g){!f&&g?c&&c(null,g):d.base?(d=this._getSkin(a,d.base))?e(d,b,function(a,b){a?c&&c(a):c&&c(null,b)}):c&&c(Error("invalid resource path")):c&&c(Error("invalid resource path"))}.bind(this)):c&&c(Error("no such skin"))},e=function(a,b,c){var d=require("path"),e=require("fs"),f=d.join(a.path,b.widgetType,b.widgetName,b.resourcePath);e.exists(f,function(a){a?c&&c(null,f):c&&c(Error("no such resource"))})},c=require("path"),f=require("fs"),g=m.aio.skinmanager.Url.resolve(a);if(g instanceof
m.aio.skinmanager.LocalUrl)d.call(this,this.skins,g,b);else if(g instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var k=this.customWidgetPath+c.sep+g.widgetType+c.sep+g.widgetName+c.sep+g.resourcePath;f.exists(k,function(a){a?b&&b(null,k):b&&b(Error("no such resource"))})}else g instanceof m.aio.skinmanager.InRemoteUrl?this._getInRemoteSkins(g.tenantId,g.remoteId,function(a,c){a?b&&b(a):d.call(this,c,g,b)}.bind(this)):g instanceof m.aio.skinmanager.InRemoteCustomWidgetUrl?this._getRemoteFolder(g.tenantId,
g.remoteId,function(a,d){if(a)b&&b(a);else{var e=c.join(d+c.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER+c.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,g.widgetType,g.widgetName,g.resourcePath);f.exists(e,function(a){a?b&&b(null,e):b&&b(Error("no such resource"))})}}.bind(this)):b&&b(Error("no such resource"))},deleteResourceByURL:function(a,b){var d=require("path"),e=require("fs");a=m.aio.skinmanager.Url.resolve(a);if(a instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var c=
this.customWidgetPath+d.sep+a.widgetType+d.sep+a.widgetName+d.sep+a.resourcePath;e.exists(c,function(a){a?e.unlink(c,function(a){b&&b(a)}):b&&b()})}else b&&b(Error("can not delete this type of resource"))},getSkinList:function(a,b,d){var e=[];a&&b?this._getInRemoteSkins(a,b,function(c,b){!c&&b&&(e=e.concat(b));this._getPermittedSkins(a,this.skins,function(a,b){!a&&b&&(e=e.concat(b));d&&d(null,e)})}.bind(this)):this._getPermittedSkins(a,this.skins,function(a,b){!a&&b&&(e=e.concat(b));d&&d(null,e)})},
uploadResource:function(a,b,d,e,c,f){if(a&&b){d||(d=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE);e||(e=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME);c||(c=a);a=require("path");var g=require("async"),k=require("fs-extra"),n=require("fs-extra"),l=this.customWidgetPath+a.sep+d+a.sep+e,h=l+a.sep+c;g.series([function(a){k.ensureDir(l,a)},function(a){k.exists(h,function(b){b?n.move(h,h+"_del",function(b){b?a(b):k.unlink(h+"_del",function(b){a(b)})}):a()})},function(a){n.move(b,h,function(b){a(b)})}],
function(a){a?f&&f(a):(a=new m.aio.skinmanager.LocalCustomWidgetUrl,a.widgetType=d,a.widgetName=e,a.resourcePath=c,f&&f(null,a.toString()))})}else f&&f(Error("invalid paramters"))},_uploadResource:function(a,b,d,e,c){if(a&&b&&d&&e){var f=require("path");this._getRemoteFolder(a,b,function(g,k){if(g)c&&c(g);else{g=require("async");var n=require("fs"),l=k+f.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER;g.series([function(a){n.mkdir(l,function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER;
n.mkdir(l,function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE;n.mkdir(l,function(){a()})},function(a){l=l+f.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME;n.mkdir(l,function(){a()})}],function(g){g?c&&c(g):n.rename(e,l+f.sep+d,function(e){e?c&&c(e):(e=new m.aio.skinmanager.InRemoteCustomWidgetUrl,e.tenantId=a,e.remoteId=b,e.widgetType=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,e.widgetName=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,
e.resourcePath=d,c&&c(null,e.toString()))})})}})}else c&&c(Error("invalid paramters"))},getRemoteWidgets:function(a,b,d,e,c){if(a)if(b){"string"==typeof e&&(e="true"==e);var f=[];require("async").parallel([function(c){this._getInRemoteCustomWidgets(a,b,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this),function(a){this._getLocalCustomWidgets(function(b,c){!b&&c&&(f=f.concat(c));a()}.bind(this))}.bind(this),function(c){d?e?this._getInRemoteSkinWidgets(a,b,d,function(a,b){!a&&b&&(f=f.concat(b));
c()}):this._isSkinPermitted(a,d,function(a,b){a||!b?c():this._getLocalSkinWidgets(d,function(a,b){!a&&b&&(f=f.concat(b));c()})}.bind(this)):c()}.bind(this)],function(a){c&&c(a,f)})}else c&&c(Error("remote id invalid"));else c&&c(Error("tenant id invalid"))},_getLocalSkinWidgets:function(a,b){a?this._getSkinWidgets(this.skins,a,function(a,e){b&&b(a,e)}):b&&b(Error("skin id invalid"))},_getLocalCustomWidgets:function(a){var b=new m.aio.skinmanager.LocalCustomWidgetDummySkin;b.path=this.customWidgetPath;
b.loadWidgets(function(b,e){a&&a(b,e)})},_getInRemoteSkinWidgets:function(a,b,d,e){this._getInRemoteSkins(a,b,function(a,b){a?e&&e(a):this._getSkinWidgets(b,d,function(a,b){e&&e(a,b)})}.bind(this))},_getInRemoteSkins:function(a,b,d){var e=require("path");this._getRemoteFolder(a,b,function(c,f){c?d&&d(c):this._loadSkins(f+e.sep+this.RESOURCE_FOLDER+e.sep+this.SKIN_FLODER,{skinType:m.aio.skinmanager.Skin.TYPE.REMOTE,tenantId:a,remoteId:b},function(a,b){d&&d(a,b)}.bind(this))}.bind(this))},_getInRemoteCustomWidgets:function(a,
b,d){var e=require("path");this._getRemoteFolder(a,b,function(c,f){c?d&&d(c):(c=f+e.sep+this.RESOURCE_FOLDER+e.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,f=new m.aio.skinmanager.DummySkin(a,b),f.path=c,f.loadWidgets(function(a,b){d&&d(a,b)}))}.bind(this))},_getRemoteFolder:function(a,b,d){require("fs");require("path");this._configmanager.trace("config/tenants/"+a+"/remotes/"+b,function(a,b){a?d&&d(a):(a=b.getFolderPath())?d&&d(null,a):d&&d(Error("remote folder path invalid"))}.bind(this))},_getSkin:function(a,
b){for(var d=0;d<a.length;d++)if(a[d].id==b)return a[d];return null},_getSkinWidgets:function(a,b,d){var e=this._getSkin(a,b);if(e){b=e;if(e.base)for(var c=0;c<a.length;c++)if(a[c].id==e.base){b=a[c];break}b.loadWidgets(function(a,b){a?d&&d(a):e.base?e.loadWidgets(function(a,c){if(a)d&&d(a);else{a=[];for(var e=0;e<c.length;e++){for(var f=!1,g=0;g<b.length;g++)if(c[e].hasSameRef(b[g])){f=!0;b[g].merge(c[e]);break}f||a.push(c[e])}b=b.concat(a);d&&d(null,b)}}):d&&d(null,b)})}else d&&d(Error("no skin has id "+
b))},_getInRemoteResourceFolder:function(a){return require("path").join(a,this.RESOURCE_FOLDER)},_getInRemoteSkinsFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.SKIN_FLODER)},_getInRemoteCustomWidgetFolder:function(a){return require("path").join(this._getInRemoteResourceFolder(a),this.CUSTOM_IN_REMOTE_WIDGET_FOLDER)},_getLocalSkinResourcePath:function(a,b){var d=require("path"),e=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;d=d.join(a.path,
b);return e.existsSync(d)?d:a.base?this._getLocalSkinResourcePath(a.base,b):null},_getLocalSkinWidgetPath:function(a,b,d){var e=require("path"),c=require("fs");a=this._getSkin(this.skins,a);if(!a||!a.path)return null;e=e.join(a.path,b,d);return c.existsSync(e)?e:a.base?this._getLocalSkinResourcePath(a.base,b,d):null},saveRemote2:function(a,b,d){var e=require("fs-extra"),c=require("path"),f=require("async"),g=a.getFolderPath();if(g){var k=a.index,n=a.parent.parent.index,l=b&&b.skin&&b.skin.id?b.skin.id:
null,h=!(!a||!a.skin||!a.skin.id),r=b&&b.skin&&b.skin.inRemote,z=(new Date).getTime(),v=this._getInRemoteSkinsFolder(g),w=this._getInRemoteCustomWidgetFolder(g),x=g+c.sep+this.RESOURCE_FOLDER,B=g+c.sep+this.RESOURCE_FOLDER+"_"+z,E=g+c.sep+this.RESOURCE_FOLDER+"_"+z+c.sep+this.SKIN_FLODER,y=v+c.sep+b.skin.id,A=function(a){a=a.split("/");if("custom"!=a[0])return!1;if(2<a.length&&"custom"==a[0]){if(a[1].match(/^.+__\d+$/))return!1;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-2].match(/^\d+$/))return!1}return!0},
F=function(a,b){a=a.toString();b=b.split(".");2==b.length?b.splice(1,0,a):3<=b.length&&(b[b.length-2].match(/^\d+$/)?parseInt(b[b.length-2])<parseInt(a)&&(b[b.length-2]=a):b.splice([b.length-2],0,a));return b.join(".")},t=function(a,b,c){var d=require("fs-extra"),e=require("path"),f=require("crypto"),u=function(a){a=d.readFileSync(a);var b=f.createHash("md5");b.update(a);return b.digest("hex")},p=0;b=F(p,b);for(var g=a+e.sep+b;d.existsSync(g);){if(d.statSync(g).size==d.statSync(c).size&&u(g)==u(g))return b;
p++;b=F(p,b);g=a+e.sep+b}d.copySync(c,g,{clobber:!0});return b},D=function(a,b){var d,f=b.length;a:{var g=a.split("/");if(2<g.length&&"custom"==g[0]){if(g[1].match(/^.+__\d+$/)){var h=!0;break a}g=g[g.length-1].split(".");if(3<=g.length&&g[g.length-2].match(/^\d+$/)){h=!0;break a}}h=!1}for(var u=A(a);f--;){var p=b[f].getLocation();switch(p){case "local_custom":if(u)for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a)return p=x+c.sep+"custom"+c.sep+b[f].type+c.sep+b[f].name,(d=t(p,b[f].resources[g].name,
b[f].resources[g].file))?"custom/"+b[f].type+"/"+b[f].name+"/"+d:null;break;case "in_remote_custom":if(u)for(g=b[f].resources.length;g--;){if(b[f].resources[g].getRef()==a){var q=b[f];d=b[f].resources[g];break}}else if(h)for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a)return a=b[f].skin.path,"\\"==c.sep&&(a=a.replace(/\\/g,"/")),a=a.split("/"),2<a.length&&(a[a.length-2]=a[a.length-2]+"_"+z),a=a.join(c.sep),a=a+c.sep+b[f].type+c.sep+b[f].name+c.sep+b[f].resources[g].name,q=b[f].type,
d=q.indexOf("__"),0<d&&(q=q.substr(0,d)),p=w+c.sep+q+c.sep+b[f].name,(d=t(p,b[f].resources[g].name,a))?"custom/"+q+"/"+b[f].name+"/"+d:null;break;default:if(0==a.indexOf(b[f].type+"/"+b[f].name))for(g=b[f].resources.length;g--;)if(b[f].resources[g].getRef()==a){"in_remote_skin"==p?(a=E,a=a+c.sep+b[f].type+c.sep+b[f].name+c.sep+b[f].resources[g].name,p=v+c.sep+l+c.sep+b[f].type+c.sep+b[f].name+c.sep+b[f].resources[g].name,e.copySync(a,p,{clobber:!0})):b[f].resources[g].copySync(v,l);return}}}if(q&&
d)return a=q.skin.path,"\\"==c.sep&&(a=a.replace(/\\/g,"/")),a=a.split("/"),2<a.length&&(a[a.length-2]=a[a.length-2]+"_"+z),a=a.join(c.sep),a=a+c.sep+q.type+c.sep+q.name+c.sep+d.name,p=w+c.sep+q.type+c.sep+q.name,(d=t(p,d.name,a))?"custom/"+q.type+"/"+q.name+"/"+d:null};f.waterfall([function(a){r?a():e.remove(v,function(b){a(b)})},function(a){this.getRemoteWidgets(n,k,h?l:null,r,function(b,c){b?a(b):e.exists(x,function(b){b?e.move(x,B,function(b){a(b,c)}):a(null,c)})}.bind(this))}.bind(this),function(b,
e){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a){for(var c=0;c<this.resourceBuf.length;c++)if(this.resourceBuf[c]&&this.resourceBuf[c].ref==a)return this.resourceBuf[c].newRef;try{var d=D(a,b);this.resourceBuf.push({ref:a,newRef:d});return d}catch(G){return null}},processWidgetSync:function(a){for(var e=0;e<this.widgetBuf.length;e++){var f=this.widgetBuf[e];if(f&&f.widgetType==a.widgetType&&f.widgetName==a.widgetName)return}try{for(e=0;e<b.length;e++)if(a.widgetType==
b[e].type&&a.widgetName==b[e].name){var g=b[e];break}if(g)switch(g.getLocation()){case "in_remote_skin":case "in_remote_custom":var u=g.skin.path;"\\"==c.sep&&(u=u.replace(/\\/g,"/"));var p=u.split("/");3<p.length&&(p[p.length-3]=p[p.length-3]+"_"+z);u=p.join(c.sep);g._copySync(u,v,l);break;default:g.copySync(v,l,d)}this.widgetBuf.push(a)}catch(q){}}},function(a){e(a)})},function(a){e.remove(B,a)},function(a){e.ensureDir(y,function(d){d?a(d):e.writeFile(y+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,
JSON.stringify({name:"in-remote"}),function(c){c||(b.skin.inRemote=!0);a(c)})})}],function(a){d&&d(a,b)})}else d&&d(Error("remote folder path invalid"))},saveRemote:function(a,b,d){var e=require("fs-extra"),c=require("path"),f=require("async"),g=require("m.aio.skinmanager.js"),k=a.getFolderPath();if(k){var n=b&&b.skin&&b.skin.id?b.skin.id:null,l=b&&b.skin&&b.skin.inRemote,h=this._getInRemoteResourceFolder(k),r=this._getInRemoteSkinsFolder(k),z=this.customWidgetPath.replace(this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,
""),v=r+c.sep+b.skin.id,w=function(a){return"custom"==a.split("/")[0]},x=function(a){if(!w(a))return!1;a=a.split("/");if(2<a.length){if(a[1].match(/^.+__\d+$/))return!0;a=a[a.length-1].split(".");if(3<=a.length&&a[a.length-2].match(/^\d+$/))return!0}return!1},B=function(a){return w(a)?!x(a):!1},E=function(a){return w(a)?!1:!(w(a)?0:l)},y=function(a,b){if(x(a)||B(a))return c.join(h,a);E(a);return c.join(r,b||n,a)},A=function(a,b){b=b.split("/");var c=b[b.length-1].split(".");c.splice(c.length-1,0,
""+a);b[b.length-1]=c.join(".");return b.join("/")},F=function(a,b){var c=require("fs-extra"),d=require("crypto"),e=function(a){a=c.readFileSync(a);var b=d.createHash("md5");b.update(a);return b.digest("hex")};if(c.existsSync(b))return c.statSync(b).size==c.statSync(a).size&&e(b)==e(a)?b:null;c.copySync(a,b,{clobber:!0});return b},t=[],D=[],C={},H={},I=function(a,b,d){var f=b+":"+(d||a);if(C[f])return C[f];var p=x(a)?c.join(h,a):B(a)?c.join(z,a):E(a)?g._getLocalSkinResourcePath(b||n,a):c.join(r,a);
b=y(d||a,b);if(x(a)||(w(a)?0:l))return C[f]=d||a,t.push(b),a;if(B(a)){var q=A(0,d||a);b=y(q);for(var k=0;!F(p,b);)q=A(++k,d||a),b=y(q);C[f]=q;t.push(b);return q}e.copySync(p,b,{clobber:!0});C[f]=d||a;t.push(b)},J=function(a){for(var b=e.readdirSync(a),d=0,f,g=0;g<b.length;g++)f=c.join(a,b[g]),(f=e.statSync(f).isDirectory()?J(f):L(f))&&d++;return d==b.length?(e.removeSync(a),!0):!1},L=function(a){if(-1!=t.indexOf(a))return!1;var b=require("unorm").nfc(a);if(-1!=t.indexOf(b))return!1;for(b=0;b<D.length;b++){var c=
D[b];if(a.substr(0,c.length)==c)return!1}e.removeSync(a);return!0},G={};f.waterfall([function(a){l?a():e.remove(r,function(b){a(b)})},function(b){a.processResourceList({resourceBuf:[],widgetBuf:[],processResourceSync:function(a,b){b&&(G[b]=1);try{var c=I(a,b);this.resourceBuf.push({ref:a,newRef:c});return c}catch(N){return null}},processWidgetSync:function(a){try{a&&"object"===typeof a&&"string"===typeof a.widgetSkin&&(G[a.widgetSkin]=1);var b=a.widgetType+"/"+a.widgetName;a.widgetSkin&&(b=a.widgetSkin+
"/"+b);if(!H[b]){var d=l?c.join(r,a.widgetSkin||n,a.widgetType,a.widgetName):g._getLocalSkinWidgetPath(a.widgetSkin||n,a.widgetType,a.widgetName);var f=c.join(r,a.widgetSkin||n,a.widgetType,a.widgetName);l||e.copySync(d,f,{clobber:!0});H[b]=!0;D.push(f)}this.widgetBuf.push(a)}catch(K){}},processDefaultImageSync:function(a){try{var b=a._default,c=b.split("/");c.splice(c.length-1,1,"default.png");var d=c.join("/");d=I(b,a.img_skin,d);this.resourceBuf.push({ref:b,newRef:d});return d}catch(K){return console.error(K),
null}}},function(a){b(a)})},function(a){try{for(var b=require("unorm"),c=0;c<t.length;c++)t[c]=b.nfc(t[c]);e.existsSync(h)&&J(h);a(null)}catch(M){a(M)}},function(a){var d=[],f;for(f in G)if(f!==b.skin.id){var g=m.aio.skinmanager.SkinManager.skins.find(function(a){return 1===a.type||2===a.type?a.id===f:!1});g&&d.push(g)}var h=function(b){if(b>=d.length)a();else{var f=d[b];e.ensureDir(r+c.sep+f.id+c.sep,function(a){a?h(b+1):e.writeFile(r+c.sep+f.id+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify({name:"in-remote",
original:f.id,system:f.system||1,version:f.version}),function(a){h(b+1)})})}};h(0)},function(a){e.ensureDir(v,function(d){if(d)a(d);else{d={name:"in-remote",original:b.skin.id};var f=m.aio.skinmanager.SkinManager.skins.find(function(a){return 1===a.type||2===a.type?a.id===b.skin.id:!1});f&&(d.system=f.system||1,d.version=f.version);e.writeFile(v+c.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify(d),function(c){c||(b.skin.inRemote=!0);a(c)})}})}],function(a){a&&(console.error(a),this._logger.log("error",
a));d&&d(a,b)}.bind(this))}else d&&d(Error("remote folder path invalid"))},downloadSystemSkin:function(a,b,d,e,c){var f="webservice.mediola.com",g=443,k="";switch(process.env.CLOUD){case "local":f=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost";g=8080;k="/webservice";break;case "dev":f=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com";g=80;break;default:f=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",g=443}d=Number(d);isNaN(d)&&(d=
0);var n=function(a,b,c){var e=c;c=443===g?require("https"):require("http");a={host:f,port:g,path:k+"/creatorneo/skin/getSkinUrl?license="+a+"&skinName="+encodeURIComponent(b)+"&level_support="+d,method:"GET",timeout:2E4,headers:{"User-Agent":"mediola",Connection:"close"}};var h="";a=c.request(a,function(a){a.setEncoding("utf8");a.on("data",function(a){h+=a});a.on("end",function(){if(e)if(200==a.statusCode){try{var b=JSON.parse(h)}catch(A){e(Error("request response invalid:"+h))}b&&b.url?e(null,b.url,
b.version):e(Error("request response invalid:"+h))}else e(Error("request failed:"+h));e=null})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){e&&e(a);e=null});a.setTimeout&&a.setTimeout(2E4);a.end()},l=this,h=this._logger,r=this._configmanager;a="config/tenants/"+a;h.log("debug","start to download system skin "+b);e&&e(0,"start");r.trace(a,function(a,d){if(a)c&&c(a);else{var f=d.license;e&&e(1,"get skin info from server");h.log("debug","try to get skin "+b+" info from server");n(f.licenseTxt,
b,function(a,d,g){a?c&&c(a):l._checkSystemSkinExists(b,g,function(a,k){a?c&&c(a):k?(h.log("debug","find system skin "+b),l._updateInfomanager(f,b,function(){c&&c()})):l._downloadAndSaveSkin(f,d,b,g,e,function(a){a?c&&c(a):l._updateInfomanager(f,b,function(){c&&c()})})})})}})},_checkSystemSkinExists:function(a,b,d){for(var e=!1,c=0;c<this.skins.length;c++)if(this.skins[c]&&1==this.skins[c].type&&this.skins[c].id==a){var f=this.skins[c].version?parseInt(this.skins[c].version):0,g=b?parseInt(b):0;if(f>=
g){e=!0;break}}d&&d(null,e)},_downloadAndSaveSkin:function(a,b,d,e,c,f){var g=this,k=this._logger,n=function(a,b,c){var d=require("m.aio.filemanager.js").getTmpDir(),e=require("path"),f=require("fs-extra"),h=e.join(d,b);try{f.existsSync(h)&&f.removeSync(h),f.ensureDirSync(h)}catch(y){c&&c(y);return}var k=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(k,function(b){g._logger.log("debug","Checked CPU for features: "+k.join(", ")+". Result: "+b);if(b){b=new (require("adm-zip"))(a);try{b.extractAllTo(h,
!0),c&&c(null,h)}catch(A){c&&c(A)}}else XC.unzip(a,h,g._logger,c)})},l=function(a,b,c,d){var e=require("path"),f=require("fs-extra"),g=e.join(a,c);f.existsSync(g)&&f.removeSync(g);f.move(b,g,{limit:100},function(a){f.chmod(g,511,function(a){d&&d(a,g)})})};c&&c(1,"get skin info from server");k.log("debug","start download skin "+d+" zip from server");c&&c(2,"download skin");(function(a,b,c){var d=c;a=require("url").parse(a);c=require("http");-1!=a.protocol.indexOf("https")&&(c=require("https"));a.method=
"GET";a.timeout=2E4;var e=require("m.aio.filemanager.js").getTmpDir(),f=require("path"),g=require("fs"),h=0,l=f.join(e,(new Date).getTime()+".zip"),n=g.createWriteStream(l);n.on("error",function(a){d&&d(a);d=null});a=c.request(a,function(a){var c=a.headers["content-length"];k.log("trace","http skin zip length:"+c);var e=!1,f=!1;a.pipe(n);n.on("finish",function(){n.close(function(){f=!0;e&&f&&d&&(200!=a.statusCode?d(Error("http response code:"+a.statusCode)):d(null,l),d=null)})});a.on("data",function(a){h+=
a.length;k.log("trace","receive chunk:"+a.length+" total:"+h+"/"+c);b&&b(parseFloat("2."+h),"download chunk "+h,{count:h,total:parseInt(c)})});a.on("end",function(){(e=!0,f)&&d&&(200!=a.statusCode?d(Error("http response code:"+a.statusCode)):d(null,l),d=null)})});if(a.on&&"function"==typeof a.on)a.on("error",function(a){d&&d(a);d=null});a.setTimeout&&a.setTimeout(2E4);a.end()})(b,c,function(a,b){a?f&&f(a):(c&&c(3,"unpack skin"),k.log("debug","start unpack skin from file:"+b),n(b,d,function(a,b){a?
f&&f(a):(k.log("debug","move skin from:"+b+" to:"+g.sysSkinsPath),l(g.sysSkinsPath,b,d,function(a,b){a?f&&f(a):(c&&c(4,"load skin"),k.log("debug","load skin "+d+" from:"+b),m.aio.skinmanager.Skin.load(b,d,{skinType:1},function(a,b){if(a)f&&f(a);else{a=-1;for(var c=0;c<g.skins.length;c++)if(g.skins[c]&&g.skins[c].type==b.type&&g.skins[c].id==b.id){a=c;break}-1!=a&&g.skins.splice(a,1);g.skins.push(b);b.updateVersion(e,function(a){f&&f(a)})}}))}))}))})},_updateInfomanager:function(a,b,d){require("m.aio.infomanager").updateDownloadSkin(a,
b,function(){d&&d()})}};"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.skinmanager.SkinManager);
