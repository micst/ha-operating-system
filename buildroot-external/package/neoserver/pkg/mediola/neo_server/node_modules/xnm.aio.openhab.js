var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.openhab=xnm.aio.openhab||{};
xnm.aio.openhab.Server=function(){var d=function(a){if(!a)throw Error("invalud argument");this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.openhab.Server");this.ip=a.ip;this.port=a.port;this.port||(this.port=8080);this.timeout=1E4};d.prototype.executeCommandCreator=function(a,b,c){if(a&&a.address)if(b&&b.value){switch(b.value){case "on":b="ON";break;case "off":b="OFF";break;case "toggle":b="TOGGLE";break;default:c&&c(Error("no such command"));
return}this._sendItemCommand(a.address,b,c)}else c&&c(Error("command json format invalid"));else c&&c(Error("device json format invalid"))};d.prototype.getStatesCreator=function(a,b,c){var e=this;this.getStates(function(a,d){a=[];for(var f=0;f<b.length;f++)if(b[f]&&b[f].id){var g="?";if(d&&b[f].status&&b[f].status.value&&b[f].device&&b[f].device.address){var m=b[f].status.value,k=b[f].device.address;d[k]&&(g=(g=e._toState(b[f].device,d[k]))?g[m]:null,"undefined"==typeof g||null==g)&&(g="?")}a.push({id:b[f].id,
status:g})}c&&c(null,a)})};d.prototype.getDevices=function(a){var b=this;this._listItems(null,function(c,e){if(c)a&&a(c);else{c=[];if(e)for(var f=0;f<e.length;f++){var d=e[f];d&&(d=b._toDevice(d))&&c.push(d)}a&&a(null,c)}})};d.prototype.getStates=function(a){this._listItems({recursive:!0,fields:"name,state"},function(b,c){if(b)a&&a(b);else{b={};if(c)for(var e=0;e<c.length;e++){var f=c[e];f.name&&(b[f.name]=f)}a&&a(null,b)}})};d.prototype._toDevice=function(a){var b=null;switch(a.type){case "Switch":b=
{sys:"openhab",type:"switch",address:a.name,data:a.type,stateDescription:a.stateDescription}}return b};d.prototype._toState=function(a,b){var c=null;"switch"==a.type?"Switch"==a.data&&(c={state:b.state.toLowerCase()}):"contact"==a.type&&"Switch"==a.data&&(c={state:"ON"==b.state?"open":"closed"});return c};d.prototype._sendItemCommand=function(a,b,c){this._callRestAPI("POST","/items/"+a,b,function(a,b){c&&c(a,b)})};d.prototype._listItems=function(a,b){var c="/items";if(a){c+="?";for(var e in a)c+=
e+"="+encodeURIComponent(a[e]),c+="&"}this._callRestAPI("GET",c,null,function(a,c){b&&b(a,c)})};d.prototype._callRestAPI=function(a,b,c,e){var d=null;c&&(d="string"==typeof c?c:JSON.stringify(c));this._doRequest(a,"/rest"+b,d,function(a,b,c){if(a)e&&e(a);else if(200!=b)e&&e(Error("http error: "+b));else try{e&&e(null,c?JSON.parse(c):null)}catch(m){e&&e(m)}})};d.prototype._doRequest=function(a,b,c,d){this._logger.log("trace","send "+a+" to url:http://"+(this.ip+":"+this.port+b));c&&this._logger.log("trace",
"with data: "+c);a={host:this.ip,port:this.port,path:b,method:a,headers:{"User-Agent":"mediola",Connection:"close"}};c&&(a.headers["Content-Length"]=c.length);var e=this,g=d;d=require("http").request(a,function(a){var b="";a.setEncoding("utf-8");a.on("data",function(a){b+=a});a.on("end",function(){e._logger.log("trace","recevice "+a.statusCode+" response:"+b);g&&(g(null,a.statusCode,b),g=null)})});d.setTimeout(this.timeout,function(){e._logger.log("trace","http request timeout");g&&(g(Error("timeout")),
g=null)});d.on("error",function(a){e._logger.log("trace","http request error:"+a.message);g&&(g(a),g=null)});c&&d.write(c);d.end()};d.prototype.toJSON=function(){return{sys:"openhab",ip:this.ip,port:this.port}};d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip===a.ip&&this.port===a.port:!1};return d}();
xnm.aio.openhab.DM=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="OpenHABDMError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"openhab",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",
options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]},contact:{status:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}}]}},getGatewayType:function(){return[{sys:this.SYS,name:"openHAB Server",port:8080}]},getGatewayDeviceType:function(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}]},createGateway:function(a,b,c){b=d.ERROR_CODE;a?a.ip?c(null,
a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"info is invalid"))},updateGateway:function(a,b,c,e){a=d.ERROR_CODE;b?b.ip?e(null,b):e(new d(a.INVALID,"ip is invalid")):e(new d(a.INVALID,"update is invalid"))},deleteGateway:function(a,b,c){c()},createDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):c(new d(e.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){var e=d.ERROR_CODE;if(a)if(a.gateway)if(a.address)if(b.data&&b.data.gateways&&0!==b.data.gateways.length){b=b.data.gateways;var f;for(f=0;f<b.length;f++)if(b[f].index===a.gateway){var g=b[f];break}g?c(null,a):c(new d(e.NOT_FOUND,
"gateway with index "+a.gateway+" not exists"))}else c(new d(e.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));else c(new d(e.INVALID,"address is invalid"));else c(new d(e.INVALID,"gateway is invalid"));else c(new d(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},applyUIFilter:function(a,b){var c=this,d=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},f=function(a,b,c){var e=[];switch(c.catagory){case "command":a.command&&
a.command.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){d(c.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},g=function(a,b){var d=[],e=c.getCommandStatusMap(a);e&&(a=f(e,a,b),d=d.concat(a));return d};if(!a||null==a.type||"undefined"==typeof a.type)return null;var l=JSON.parse(JSON.stringify(a)),h=null;switch(b.catagory){case "command":h=g(a,b);l.command=h;break;case "status":h=
g(a,b);l.status=h;break;default:return null}return h&&0!=h.length?l:null},applyIPEventFilter:function(a,b){if(!a.sys)return null;b=this.getCommandStatusMap(a);if(!b)return null;a=JSON.parse(JSON.stringify(a));a.ipevt=b.ipevt;return a},getCommandStatusMap:function(a){var b=this.MAP[a.type];a&&a.stateDescription&&1==a.stateDescription.readOnly&&(b=JSON.parse(JSON.stringify(b)),delete b.command);return b}}}();
xnm.aio.openhab.Handler=function(){var d=function(){};d.prototype.devicemanager=xnm.aio.openhab.DM;d.prototype.Server=xnm.aio.openhab.Server;d.prototype.registModule=function(a){a.register(this.devicemanager.SYS,"openhab")};d.prototype.resolveGateway=function(a){return a&&a.ip?new this.Server(a):null};d.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,
{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};d.prototype.doCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.doStatus=function(a,b,c,d,f){(b=this.resolveGateway(b))?b.getStatesCreator(null,[{id:a,device:c,status:d}],function(a,b){a?f&&f(a):f&&f(null,b[0])}):f&&f(Error("gateway json format invalid"))};d.prototype.getDeviceList=function(a,b){(a=this.resolveGateway(a))?a.getDevices(function(a,
d){b&&b(a,d)}):b&&b(Error("gateway json format invalid"))};d.prototype.discover=function(a,b){var d=this,e=require("x.mdns.js");e.clearRecordBuffer();var f={};e.discoverServiceWithTimeout("_openhab-server._tcp.local",a,function(a,c){if(a)b&&b(a);else{for(a=0;a<c.length;a++){var e=c[a];if(e.target&&e.ip&&0<e.ip.length){var g=e.ip[0];e=new d.Server({ip:e.ip[0]});f[g]||(f[g]=e)}}c=[];for(var k in f)c.push(f[k]);b&&b(null,c)}})};return d}();
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.openhab.Handler);
