var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.artnet=xnm.aio.artnet||{};xnm.aio.artnet.Controller=function(a,b,d){this.ip=a;this.port=b;this.port||(this.port=6454);this.name=d;this._DMXdata=[]};
xnm.aio.artnet.Controller.prototype._doRequest=function(a,b,d){var c=[65,114,116,45,78,101,116,0];c=c.concat(a.concat([0,14]));c.push(0);c.push(0);c.push(0);c.push(0);a=b.length;512<a&&(a=512);c.push((a&65280)>>8);c.push(a&255);c=c.concat(b);b=require("dgram").createSocket("udp4");b.on("message",function(a,b){XC.debugf(a)});c=new Buffer(c);XC.debugf(c);b.send(c,0,18+a,this.port,this.ip,function(a,b){d&&d()})};
xnm.aio.artnet.Controller.prototype.sendDMX512Data=function(a){this._doRequest([0,80],this._DMXdata,a)};xnm.aio.artnet.Controller.prototype.setDMX512Data=function(a){this._DMXdata=a};xnm.aio.artnet.Controller.prototype.setDMX512Channel=function(a,b){512<a&&(a=512);--a;if(!(0>a)){for(;this._DMXdata.length<=a;)this._DMXdata.push(0);this._DMXdata[a]=b}};
xnm.aio.artnet.Discovery=function(){this.detectedControllers={};this._sockets=[];var a=require("os"),b=require("dgram");if(a&&a.networkInterfaces){var d=this;b=b.createSocket("udp4");b.bind(6454,"0.0.0.0");b.on("message",function(a,b){d._receivedData(b.address,a)});a=a.networkInterfaces();for(var c in a){b=a[c];for(var e=0;e<b.length;e++)this._addDiscoverSocket(6454,b[e])}}else this._addDiscoverSocket(6454,null)};
xnm.aio.artnet.Discovery.prototype._receivedData=function(a,b){if(110<b.length&&(b instanceof Array||b instanceof Buffer)&&0==b[8]&&33==b[9]){a=b[10]+"."+b[11]+"."+b[12]+"."+b[13];for(var d="",c=44;108>c&&0!=b[c];c++)d+=String.fromCharCode(b[c]);this.detectedControllers[a]||(this.detectedControllers[a]=new xnm.aio.artnet.Controller(a,null,d),this._callback&&this._callback(this.detectedControllers[a]))}};
xnm.aio.artnet.Discovery.prototype._addDiscoverSocket=function(a,b){var d=require("dgram"),c=this;if(b)"IPv4"==b.family&&0==b.internal&&(e=d.createSocket("udp4"),e.on("listening",function(){e.setBroadcast(!0)}),e.bind(a,b.address),this._sockets.push(e));else{var e=d.createSocket("udp4");e.on("message",function(a,b){c._receivedData(b.address,a)});this._sockets.push(e)}};
xnm.aio.artnet.Discovery.prototype._sendDiscoveryMessages=function(a,b,d,c){a=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]);for(b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,6454,"255.255.255.255")};xnm.aio.artnet.Discovery.prototype.discoverControllers=function(a){this._callback=a;var b=this,d=0,c=setInterval(function(){b._sendDiscoveryMessages();1<=d++&&clearInterval(c)},250)};xnm.aio.artnet.Handler=function(){this._discovery=null};
xnm.aio.artnet.Handler.prototype.discoverControllers=function(a){this._discovery||(this._discovery=new xnm.aio.artnet.Discovery);this._discovery.discoverControllers(a)};xnm.aio.artnet.Handler.prototype.Controller=xnm.aio.artnet.Controller;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.artnet.Handler);
