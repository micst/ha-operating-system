var x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.nanoleaf=x.hub.m.nanoleaf||{};
x.hub.m.nanoleaf.Monitor={_devices:{},_logger:require("x.logger.js").getLogger("x.hub.m.nanoleaf.Monitor"),_timeout:null,handler:null,module:require("xnm.aio.nanoleaf.js"),interval:3E5,isRunning:!1,_checkDevices:function(a){for(var c=0;c<a.length;c++){var b=a[c],e=String(b.id).toLowerCase(),d=this._devices[e];d&&d.ip!==b.ip&&(this._logger.log("debug","IP of device "+e+" has changed: from "+d.ip+" to "+b.ip),e=this.handler._connections[d.ip],this.handler.removeStateDevice(d),d.ip=b.ip,this.handler.addStateDevice(d),
this.handler._connections[b.ip].callbacks=e.callbacks)}},_search:function(){if(this.isRunning){var a=this;this.module.discoverWithTimeout(5E3,function(c,b){a.isRunning&&(!c&&Array.isArray(b)&&a._checkDevices(b),a._timeout=setTimeout(function(){a._search()},a.interval))})}},addDevice:function(a){if(a&&a.id){var c=String(a.id).toLowerCase();this._devices[c]=a}},removeDevice:function(a){a&&a.id&&(a=String(a.id).toLowerCase(),delete this._devices[a])},start:function(){this.isRunning||(this._logger.log("debug",
"Starting monitor."),this.isRunning=!0,this._search())},stop:function(){this.isRunning=!1;clearTimeout(this._timeout);this._logger.log("debug","Stopped monitor.")}};x.hub.m.nanoleaf.Handler=function(){this._callbacks=[];this._connections={};this._device=null;this._logger=require("x.logger.js").getLogger("x.hub.m.nanoleaf.Handler");x.hub.m.nanoleaf.Monitor.handler=this};
x.hub.m.nanoleaf.Handler.prototype={_buildEvent:function(a,c,b){if(!b)return null;var e=[],d=null,g=null,f=null,h=null;1===c?(f=b.value,1===b.attr?d="on":2===b.attr?d="brightness":3===b.attr?d="hue":4===b.attr?d="sat":5===b.attr?d="ct":6===b.attr&&(d="colorMode")):2!==c&&(3===c?1===b.attr&&(d="effectSelected",f=b.value):4===c&&(0===b.gesture?(d="gestureTap",f="single tap",0<=b.panelId&&(g="gestureSingleTapPanel",h=b.panelId)):1===b.gesture?(d="gestureTap",f="double tap",0<=b.panelId&&(g="gestureDoubleTapPanel",
h=b.panelId)):2===b.gesture?(d="gestureSwipe",f="swipe up"):3===b.gesture?(d="gestureSwipe",f="swipe down"):4===b.gesture?(d="gestureSwipe",f="swipe left"):5===b.gesture&&(d="gestureSwipe",f="swipe right")));if(null===d||null===f)return null;e.push({module:"nanoleaf",device:a,data:{key:d,value:f,changed:!0}});null!==g&&null!==h&&e.push({module:"nanoleaf",device:a,data:{key:g,value:h,changed:!0}});return e},_handleEventStream:function(a,c,b){if(200!==a.statusCode)a=Error("Server responded with status code: "+
a.statusCode),this._logger.log("error","[_handleEventStream] "+a.message),c&&c({error:a});else{this._logger.log("debug","[_handleEventStream] Connection for "+b.ip+" has been opened.");var e=this,d="";this._connections[b.ip].stream=a;this._connections[b.ip].status="connected";a.on("data",function(a){d+=String(a);0<=d.indexOf("\n\n")?(a=d.split("\n\n"),d="",e._parseIncomingMessage(b,a)):2E4<d.length&&(e._logger.log("warn","[_handleEventStream] Incoming message string has become too long ("+d.length+
"). Discarding message."),d="")});a.on("end",function(){e._logger.log("debug","[_handleEventStream] Event stream ended for device "+b.ip+".")});a.on("close",function(){e._logger.log("debug","[_handleEventStream] Event stream closed for device: "+b.ip+".");e._connections[b.ip]&&(e._connections[b.ip].stream=null,e._connections[b.ip].status="disconnected",e._retryWithTimeout(b))})}},_parseIncomingMessage:function(a,c){var b=this._connections[a.ip];if(b&&b.callbacks)for(var e=0;e<c.length;e++){for(var d=
c[e].trim().split("\n"),g=null,f=null,h=0;h<d.length;h++){var k=d[h].trim();if(0===k.indexOf("id:"))g=parseInt(k.replace("id:","").trim(),10);else if(0===k.indexOf("data:")){f=k.replace("data:","").trim();try{f=JSON.parse(f)}catch(l){f=null}}}if(g&&f&&Array.isArray(f.events))for(d=0;d<f.events.length;d++)for(h=this._buildEvent(a,g,f.events[d]),k=0;k<h.length;k++)this._sendEvent(h[k],b.callbacks)}},_retryWithTimeout:function(a,c){if("number"!==typeof c||isNaN(c)||0>c)c=12E4;if(this._connections[a.ip]){var b=
this;setTimeout(function(){b.addStateDevice(a,null)},c)}else this._logger.log("debug","Device connection data does not exist anymore. Will not retry connection.")},_sendEvent:function(a,c){if(!a||!a.data)return null;this._logger.log("trace","[_sendEvent] "+a.data.key+": "+a.data.value);for(var b in c)if(b===a.data.key)for(var e=c[b],d=0;d<e.length;d++){var g=e[d];if(g&&"function"===typeof g.onEvent)try{g.onEvent(a)}catch(f){this._logger.log("error","[_sendEvent] "+f.message)}}},addCallback:function(a,
c){if(a&&c&&c.callback&&c.statusKey&&(a=this._connections[a.ip])){var b=c.statusKey;a.callbacks[b]||(a.callbacks[b]=[]);0>a.callbacks[b].indexOf(c.callback)&&a.callbacks[b].push(c.callback)}},addStateDevice:function(a,c,b){var e=null;if(a.token)if(a.ip)if((e=this._connections[a.ip])&&(e.stream||"connecting"===e.status))b&&this.addCallback(a,b),this._logger.log("debug","[addStateDevice] Device connection for "+a.ip+" already exists."),c&&c();else{e||(this._connections[a.ip]={callbacks:{},device:a,
status:"connecting",stream:null});b&&this.addCallback(a,b);this._logger.log("debug","[addStateDevice] Opening connection for event stream to device "+a.ip+"...");x.hub.m.nanoleaf.Monitor.addDevice(a);x.hub.m.nanoleaf.Monitor.start();var d=this;b=require("http").request({host:a.ip,port:a.port||16021,path:"/api/v1/"+a.token+"/events?id=1,3,4",method:"GET",headers:{Accept:"text/event-stream","Cache-Control":"no-cache"}},function(b){d._handleEventStream(b,c,a)});"function"===typeof b.setEncoding&&b.setEncoding("utf8");
b.on("error",function(b){d._logger.log("error","[addStateDevice] Request error: "+b.message);d._retryWithTimeout(a)});b.end()}else e=Error("Nanoleaf device has no IP."),this._logger.log("error","[addStateDevice] "+e.message),c&&c({error:e});else e=Error("Nanoleaf device has no auth token."),this._logger.log("error","[addStateDevice] "+e.message),c&&c({error:e})},checkDeviceMatch:function(a,c){return c&&c.device&&a&&a.device?c.device.ip===a.device.ip:!1},removeCallback:function(a,c){a&&c&&c.statusKey&&
c.callback&&(a=this._connections[a.ip])&&(a=a.callbacks[c.statusKey])&&(c=a.indexOf(c.callback),0<=c&&a.splice(c,1))},removeStateDevice:function(a,c,b){b&&this.removeCallback(a,b);if(c=this._connections[a.ip])delete this._connections[a.ip],c.stream&&c.stream.destroy()},getSystems:function(){return["nanoleaf"]},init:function(a){a&&a()}};"undefined"!==typeof exports&&"undefined"!==typeof module&&module.exports&&(exports=module.exports=new x.hub.m.nanoleaf.Handler);
