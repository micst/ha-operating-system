var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rehau=xnm.aio.rehau||{};
xnm.aio.rehau.Gauzy=function(){var e=function(a,b){this.address=a;this.port=b;b&&""!=b||(this.port=5E3)};e.prototype._setScene=function(a,b){this._doJsonRequest("POST","/scene",{scene:a},function(a,d){b&&b(a,d)})};e.prototype._setInvert=function(a,b){var c=this;this._getBlindStates(function(d,f){d?b&&b(d):c._setInvertAndBlindOpacity(a,f.opacity,b)})};e.prototype._setBlindPosition=function(a,b){var c=this;this._getBlindStates(function(d,f){d?b&&b(d):c._setInvertAndBlindOpacity(f.invert,a,b)})};e.prototype._setBlindOpacity=
function(a,b){var c=this;this._getBlindStates(function(d,f){d?b&&b(d):c._setInvertAndBlindOpacity(f.invert,a,b)})};e.prototype._setInvertAndBlindOpacity=function(a,b,c){this._doJsonRequest("POST","/blind",{opacity:b,invert:a},function(b,a){c&&c(b,a)})};e.prototype._setLightsensor=function(a,b){var c=this;this._getLEDStates(function(d,f){d?b&&b(d):c._setLedPaintAndLightsensor(f.ledpaint,a,b)})};e.prototype._setLedPaint=function(a,b){var c=this;this._getLEDStates(function(d,f){d?b&&b(d):c._setLedPaintAndLightsensor(a,
f.lightsensoractive,b)})};e.prototype._setLedPaintAndLightsensor=function(a,b,c){this._doJsonRequest("POST","/external",{ledpaint:a,lightsensoractive:b},function(b,a){c&&c(b,a)})};e.prototype.getAllStates=function(a){this._getAllStates(function(b,c){b?a&&a(b):(c&&(c.ledpaint=c.ledpaint?"on":"off",c.lightsensoractive=c.lightsensoractive?"on":"off",c.invert=c.invert?"on":"off"),a&&a(null,c))})};e.prototype._getAllStates=function(a){var b=function(b){[].slice.call(arguments,1).forEach(function(a){for(var c in a)b[c]=
a[c]});return b},c=this;this._getBlindStates(function(d,e){d?a&&a(d):c._getLEDStates(function(c,d){c?a&&a(c):(c=b({},d,e),a&&a(null,c))})})};e.prototype._getLEDStates=function(a){this._doJsonRequest("GET","/external",null,function(b,c){a&&a(b,c)})};e.prototype._getBlindStates=function(a){this._doJsonRequest("GET","/blind",null,function(b,c){a&&a(b,c)})};e.prototype._doJsonRequest=function(a,b,c,d){try{var e=c?JSON.stringify(c):null;this._doRequest(a,b,e,function(b,a){if(b)d&&d(b);else try{b=null,
a&&(b=JSON.parse(a)),d&&d(null,b)}catch(h){d&&d(h)}})}catch(g){d&&d(g)}};e.prototype._doRequest=function(a,b,c,d){a={host:this.address,port:this.port,path:b,method:a,headers:{"Content-Type":"application/json"}};a=require("http").request(a,function(b){b.setEncoding("utf-8");var a="";b.on("data",function(b){a+=b});b.on("end",function(){d&&d(null,a)})});c&&a.write(c);a.setTimeout&&a.setTimeout(2E3,function(){d&&d(Error("http request timeout"))});a.on("error",function(b){d&&d(b)});a.end()};e.prototype.executeCommand=
function(a,b,c){console.log("======> command",b);if(b){var d=this;if(0<=b&&100>=b)this._getBlindStates(function(a,e){a?c&&c(a):d._setInvertAndBlindOpacity(e.invert,0==e.invert?100-b:b,c)});else if(-1!=b.indexOf("lightsensoractive")||-1!=b.indexOf("ledpaint")){a=b.split("_");if(-1!=b.indexOf("lightsensoractive")){var e=parseInt(a[1]);var g="?"!=a[2]?parseInt(a[2]):0}else-1!=b.indexOf("ledpaint")&&(g=parseInt(a[1]),e="?"!=a[2]?parseInt(a[2]):0);this._setLedPaintAndLightsensor(g,e,c)}else-1!=b.indexOf("scene")?
(a=b.split("_"),this._setScene(parseInt(a[1]),c)):-1!=b.indexOf("invert")&&(a=b.split("_"),g=parseInt(a[1]),a=parseInt(a[2]),this._setInvertAndBlindOpacity(g,a,c,!0))}else c&&c("missing params")};e.prototype.getStates=function(a,b,c){this._getAllStates(function(c,e){if(!c&&e&&a)for(var d in e)e.hasOwnProperty(d)&&("opacity"==d?(c=e.opacity,0===e.invert&&(c=100-e.opacity),a.setState(b.id+":opacity",e.opacity),a.setState(b.id+":slider_opacity",c)):a.setState(b.id+":"+d,e[d]))})};e.prototype.executeCommandCreator=
function(a,b,c){if(b&&b.value)switch(b.value){case "invertOn":case "invertOff":a=0;"invertOn"==b.value&&(a=1);this._setInvert(a,c);break;case "ledpaintOn":case "ledpaintOff":a=0;"ledpaintOn"==b.value&&(a=1);this._setLedPaint(a,c);break;case "lightsensorOn":case "lightsensorOff":a=0;"lightsensorOn"==b.value&&(a=1);this._setLightsensor(a,c);break;case "doScene":if("undefined"==typeof b.ext||null==b.ext){c&&c("command ext invalid");break}b=parseInt(b.ext);1>b&&(b=1);6<b&&(b=6);this._setScene(b,c);break;
case "moveTo":if("undefined"==typeof b.ext||null==b.ext){c&&c("command ext invalid");break}b=parseInt(b.ext);0>b&&(b=0);100<b&&(b=100);this._setBlindPosition(b,c);break;default:c&&c(Error("unknown command"))}else c&&c(Error("command json format invalid"))};e.prototype.getStatesCreator=function(a,b,c){this._getAllStates(function(a,e){if(a)c&&c(a);else{a=[];for(var d=0;d<b.length;d++)if(b[d]&&b[d].id&&b[d].status&&b[d].status.value){var f=e[b[d].status.value];"undefined"!=typeof f&&null!=f&&a.push({id:b[d].id,
status:f})}c&&c(null,a)}})};e.prototype.getSingleDeviceStatesCreator=function(a,b,c,d){this.getAllStates(function(b,a){d&&d(b,a)})};e.prototype.toJSON=function(){return{sys:"rehau",type:"gauzy",address:this.address,port:this.port}};e.prototype.equalsTo=function(a){return a&&a instanceof e?this.address==a.address&&this.port==a.port:!1};return e}();
xnm.aio.rehau.DM=function(){var e=function(b,a){this.code=b;this.message=a;this.stack=Error().stack};e.prototype=Error();e.prototype.name="RehauDMError";e.prototype.code=0;e.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var a={gauzy:{command:[{type:"enum",name:"invert on",ref:{value:"invertOn"}},{type:"enum",name:"invert off",ref:{value:"invertOff"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"enum",name:"LED-Paint on",
ref:{value:"ledpaintOn"}},{type:"enum",name:"LED-Paint off",ref:{value:"ledpaintOff"}},{type:"enum",name:"activate light sensor",ref:{value:"lightsensorOn"}},{type:"enum",name:"deactivate light sensor",ref:{value:"lightsensorOff"}},{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d",extMeta:"1-6",scale:"1"}}],status:[{type:"int",name:"position",ref:{value:"position",extMeta:"0-100",scale:"5"}},{type:"enum",name:"invert",ref:{value:"invert",options:["on","off"]}},{type:"enum",name:"LED-Paint",
ref:{value:"ledpaint",options:["on","off"]}},{type:"enum",name:"light sensor",ref:{value:"lightsensoractive",options:["on","off"]}}]}};return{SYS:"rehau",getIPDeviceType:function(){return[{sys:this.SYS,name:"Gauzy Scheibe",type:"gauzy"}]},createDevice:function(b,a,d){a=e.ERROR_CODE;b?b.address?d(null,b):d(new e(a.INVALID,"address is invalid")):d(new e(a.INVALID,"info is invalid"))},updateDevice:function(b,a,d){a=e.ERROR_CODE;b?b.address?d(null,b):d(new e(a.INVALID,"address is invalid")):d(new e(a.INVALID,
"info is invalid"))},deleteDevice:function(b,a,d){d()},applyUIFilter:function(a,c,d){var b=function(a,c,d){var e=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var f=b(a.children,c,d);f&&0<f.length&&(a.children=f,e.push(a))}else{f=d.elems;if("*"==f)f=!0;else{for(var g=!1,h=0;h<f.length;h++)if(f[h]==a.type){g=!0;break}f=g}f&&(a=JSON.parse(JSON.stringify(a)),e.push(a))}});return e},e=function(a,c){var e=[],f=xnm.aio.pioneer.DM.getCommandStatusMap(a,d);if(f){var g=[];switch(c.catagory){case "command":f.command&&
(g=b(f.command,a,c));break;case "status":f.status&&(g=b(f.status,a,c))}e=e.concat(g)}return e};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),h=null;switch(c.catagory){case "command":h=e(a,c);k.command=h;break;case "status":h=e(a,c);k.status=h;break;default:return null}return h&&0!=h.length?k:null},getCommandStatusMap:function(b){return b&&b.type?a[b.type]:null}}}();
xnm.aio.rehau.Handler=function(){var e=function(){};e.prototype.devicemanager=xnm.aio.rehau.DM;e.prototype.Gauzy=xnm.aio.rehau.Gauzy;e.prototype.registModule=function(a){a.register("rehau","rehau")};e.prototype.resolveDevice=function(a){if(!a)return null;switch(a.type){case "gauzy":return a.address?new this.Gauzy(a.address,a.port):null;default:return null}};e.prototype.getDeviceCommands=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};
e.prototype.getDeviceStatus=function(a,b){a=(a=this.devicemanager.applyUIFilter(a,{catagory:"status",elems:"*"}))?a.status:[];b&&b(null,a)};e.prototype.doCommand=function(a,b,c){var d=this.resolveDevice(a);d?d.executeCommandCreator(a,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};e.prototype.doStatus=function(a,b,c,d){var e=this.resolveDevice(b);e?e.getStatesCreator(null,[{id:a,device:b,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};
e.prototype.getDevice=function(a){return new xnm.aio.rehau.Gauzy(a.address,a.port)};return e}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rehau.Handler);
