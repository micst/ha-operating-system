var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(d){var a=0;return function(){return a<d.length?{done:!1,value:d[a++]}:{done:!0}}};$jscomp.arrayIterator=function(d){return{next:$jscomp.arrayIteratorImpl(d)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,a,b){d!=Array.prototype&&d!=Object.prototype&&(d[a]=b.value)};$jscomp.getGlobal=function(d){d=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,d];for(var a=0;a<d.length;++a){var b=d[a];if(b&&b.Math==Math)return b}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(d,a){this.$jscomp$symbol$id_=d;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:a})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function d(b){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(b||"")+"_"+a++,b)}var a=0;return d}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.asyncIterator;d||(d=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};
$jscomp.iteratorFromArray=function(d,a){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var b=0,e={next:function(){if(b<d.length){var g=b++;return{value:a(g,d[g]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(d,a,b,e){if(a){b=$jscomp.global;d=d.split(".");for(e=0;e<d.length-1;e++){var g=d[e];g in b||(b[g]={});b=b[g]}d=d[d.length-1];e=b[d];a=a(e);a!=e&&null!=a&&$jscomp.defineProperty(b,d,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.checkStringArgs=function(d,a,b){if(null==d)throw new TypeError("The 'this' value for String.prototype."+b+" must not be null or undefined");if(a instanceof RegExp)throw new TypeError("First argument to String.prototype."+b+" must not be a regular expression");return d+""};
$jscomp.polyfill("String.prototype.startsWith",function(d){return d?d:function(a,b){var e=$jscomp.checkStringArgs(this,a,"startsWith");a+="";var g=e.length,c=a.length;b=Math.max(0,Math.min(b|0,e.length));for(var f=0;f<c&&b<g;)if(e[b++]!=a[f++])return!1;return f>=c}},"es6","es3");var x=x||{};x.hub=x.hub||{};x.hub.v6=x.hub.v6||{};
x.hub.v6.API=function(){var d=function(a){this._version="v1";this._handler=a};d.prototype.init=function(a,b){var e=this;a.addRoute("/api/"+this._version+"/command",function(a,c){e._handler.command(a.body,function(f,a){c.json(e._buildResponseJSON(f,a))})});a.addRoute("/api/"+this._version+"/state",function(a,c){e._handler.state(a.query,function(f,a){c.json(e._buildResponseJSON(f,a))})});b&&b()};d.prototype.handleTunnelReuqest=function(a,b){var e=a.pathname.split("/"),g=this;"state"==e[3]?this._handler.state(a.query,
function(c,a){b&&b(g._buildResponseJSON(c,a))}):"command"==e[3]?this._handler.command(a.body,function(c,a){b&&b(g._buildResponseJSON(c,a))}):b&&b(g._buildResponseJSON(Error("invalid request")))};d.prototype._buildResponseJSON=function(a,b){if(a){for((b=a.code+"")||(b="0");6>b.length;)b="0"+b;return{XC_ERR:{code:b,msg:a.message}}}return{XC_SUC:b?b:{}}};return{V1:d}}();
x.hub.v6.CentralUnit=function(){var d=function(a){this._api=new x.hub.v6.API.V1(this);this._server=a};d.prototype.init=function(a){this._api.init(this._server,a)};d.prototype.handleTunnelReuqest=function(a,b){this._api.handleTunnelReuqest(a,b)};d.prototype.command=function(a,b){};d.prototype.state=function(a,b){a&&"true"==a.force?this._updatesStates(a,b):b&&b(null,null)};d.prototype._updatesStates=function(a,b){a&&a.id?this._getStates(a.id,function(e,g){e?b&&b(e):g?(e={},e[a.id]={},a.key?e[a.id][a.key]=
g[a.key]:e[a.id]=g,b&&b(null,e)):b&&b(null,{})}):this._updateStatesAll(a.timeout,b)};d.prototype._updateStatesAll=function(a,b){a&&(a*=1E3);require("x.hub.commandman.js").commandHandler2.updateGeneralDeviceStates(a,b)};d.prototype._updateStates=function(a,b){require("x.hub.deviceman.js").deviceManager2.toGeneralDevice(a,function(e,g){if(e)b&&b(e);else if(g)if(g.states&&g.details&&g.details.states){e=[];for(var c in g.details.states){var f=g.details.states[c];f&&f.value&&e.push({id:c,value:f.value})}0==
e.length?b&&b(null,null):require("x.hub.commandman.js").commandHandler2.getStatesWithIdx(a,null,e,function(c){c&&c.data?b&&b(null,c.data):b&&b(Error("get device states error"))})}else b&&b(null,null);else b&&b(Error("can not find general device"))})};return d}();
x.hub.v6.Time=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Time");this._handler=a;this._writeRTCInterval=null;this._tz=d.DEFAULT_TZ;this._timezone=d.DEFAULT_TTIMEZONE;this._ntpServers=["0.de.pool.ntp.org","1.de.pool.ntp.org","2.de.pool.ntp.org","3.de.pool.ntp.org"]};d.TimeZone_MAP=[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"Europe/Dublin"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,
zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},
{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},
{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},
{utc:-11,dst:!0,zone:"Etc/GMT+11"}];d.DEFAULT_TZ="21";d.DEFAULT_TTIMEZONE="Europe/Berlin";d.TIMEZONE_SCRIPT="/etc/init.d/S00settimezone";d.TIMEZONE_CONF="/etc/timezone";d.NTP_SCRIPT="/etc/init.d/S49ntp";d.NTP_CONF="/etc/ntp.conf";d.WRITE_RTC_PERIOD=6E5;d.prototype.init=function(a){global.SYSTEM_ROOT&&(d.TIMEZONE_SCRIPT=SYSTEM_ROOT+d.TIMEZONE_SCRIPT,d.TIMEZONE_CONF=SYSTEM_ROOT+d.TIMEZONE_CONF,d.NTP_CONF=SYSTEM_ROOT+d.NTP_CONF,d.NTP_SCRIPT=SYSTEM_ROOT+d.NTP_SCRIPT);var b=this;if(localStorage){var e=
localStorage.getItem("x.hub.Server.timezone");e&&(b._tz=e)}this._writeRTCInterval=setInterval(function(){var a=Math.round((new Date).getTime()/1E3);b._writeTimeToRTC(a)},d.WRITE_RTC_PERIOD);this._readNTPConf(function(){b._readTimezoneConf(function(){a&&a()})})};d.prototype.getNTPServers=function(a){a&&a(null,this._ntpServers)};d.prototype.setNTPServers=function(a,b){if(a&&a.length){var e=a.filter(function(c){return!!c});if(e&&e.length){var g=this;this._handler._sysConf.setValue("NTP",e.join(","),
function(c){c?b&&b(c):g._restartNTPD(function(c){c?b&&b(c):(g._ntpServers=e,b&&b())})})}else b&&b(Error("invalid ntp servers"))}else b&&b(Error("invalid ntp servers"))};d.prototype.getTimezoneSync=function(){return this._decodeTimeZone(this._tz)};d.prototype.getTimezoneEncoded=function(a){a&&a(null,this._tz)};d.prototype.setTimezoneEncoded=function(a,b){if(a){var e=this._decodeTimeZone(a);if(e){var g=this;this._handler._sysConf.setValue("TZ",e,function(c){c?b&&b(c):g._reloadTimeZone(function(c){c?
b&&b(c):(localStorage&&localStorage.setItem("x.hub.Server.timezone",a),g._tz=a,g._timezone=e,g._handler._stm.sendCommand(16,"XC_FNC=setTZ&data="+a,function(c){b&&b(c?c.error:null)}))})})}else b&&b(Error("invalid timezone"))}else b&&b(Error("invalid timezone"))};d.prototype.setTime=function(a,b){if(a){var e=a.year,g=a.month+"";1==g.length&&(g="0"+g);var c=a.date+"";1==c.length&&(c="0"+c);var f=a.hour+"";1==f.length&&(f="0"+f);a=a.minute+"";1==a.length&&(a="0"+a);var h=this;this._logger.log("trace",
"set system time: "+e+"-"+g+"-"+c+" "+f+":"+a);this._setSystemTime({year:e,month:g,date:c,hour:f,minute:a},function(c){h._logger.log("trace","set system time "+(c?"failed:"+c.message:"success"));c?b&&b(c):(c=new Date,c=Math.round(c.getTime()/1E3),h._logger.log("trace","set stm time: "+c),h._writeTimeToRTC(c,function(c){h._logger.log("trace","set stm time "+(c?"failed:"+c.message:"success"));b&&b(c)}))})}else b&&b(Error("invalid time"))};d.prototype.restore=function(a,b,e){this._logger.log("trace",
"restore timezone");var g=require("fs"),c=null,f=this,h=function(){if(!c)c=d.DEFAULT_TZ;else if(b&&"v5+"==b.backupType){c=parseInt(c,16);var a=(c&31)-11;c=0!=(c&128)?32:0;0>a&&(c|=16,a=0-a);c|=a&15;c=c.toString(16);2>c.length&&(c="0"+c);f._logger.log("trace","convert v5+ timezone to v6+ format: "+c);try{f._logger.log("trace","overwrite v6+ format tz to "+l),g.writeFileSync(l,c.toUpperCase())}catch(m){f._logger.log("trace","overwrite v6+ format tz to "+l+" failed:"+m.message)}}f.setTimezoneEncoded(c,
e)},l=require("path").join(a,"data","localstorage","x.hub.Server.timezone");g.existsSync(l)?(this._logger.log("trace","read timezone from backup file: "+l),g.readFile(l,{encoding:"utf8"},function(a,b){f._logger.log("trace","read timezone from backup file"+(a?" failed:"+a.message:" success:"+b));!a&&b&&(c=b);h()})):h()};d.prototype._setSystemTime=function(a,b){if("PI-CM3+"!=global.PLATFORM)b&&b();else{a="date +%Y%m%d%H%M -s "+(a.year+a.month+a.date+a.hour+a.minute);var e=require("child_process").exec;
a=e(a);a.on("error",function(a){b&&(b(a),b=null)});a.on("close",function(a){b&&(b(0==a?null:Error("set system time failed")),b=null)})}};d.prototype._restartNTPD=function(a){var b=require("child_process").exec;b=b(d.NTP_SCRIPT+" restart");b.stdout.on("data",function(a){console.log(String(a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("restart ntpd failed")),a=null)})};d.prototype._readNTPConf=function(a){var b=this;require("fs").readFile(d.NTP_CONF,
{encoding:"utf8"},function(e,d){if(!e&&d){e=[];d=d.split("\n");for(var c=0;c<d.length;c++){var f=d[c].trim();f&&"server"==f.substr(0,6)&&(f=f.split(" "),2<=f.length&&f[1]&&-1==e.indexOf(f[1])&&e.push(f[1]))}b._ntpServers=e}a()})};d.prototype._readTimezoneConf=function(a){var b=this;require("fs").readFile(d.TIMEZONE_CONF,{encoding:"utf8"},function(e,d){!e&&d&&(b._timezone=d.trim());a()})};d.prototype._decodeTimeZone=function(a){a=parseInt(a,16);var b=0!=(a&32),e=a&15;a&16&&(e=0-e);a&64&&(e-=.5);var g=
null;d.TimeZone_MAP.forEach(function(c){c.utc==e&&c.dst==b&&(g=c.zone)});return g};d.prototype._reloadTimeZone=function(a){var b=require("child_process").exec;b=b(d.TIMEZONE_SCRIPT+" reload");var e=this;b.stdout.on("data",function(a){e._logger.log("trace","_reloadTimeZone:"+String(a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("reload timezone failed")),a=null)})};d.prototype._writeTimeToRTC=function(a,b){var e=new Buffer(4);e.writeInt32BE(a);var d=
this;this._logger.log("trace","write time "+a+" to stm "+e.toString("hex"));this._handler._stm.sendCommand(55,e,function(c){d._logger.log("trace","write time to stm "+(c&&c.error?" failed:"+c.error:" success"));b&&b(c?c.error:null,c?c.data:null)})};return d}();
x.hub.v6.Network=function(){var d={calculate:function(c,a){var f=[];try{var b=this.toDecimal(c);var e=this.toDecimal(a)}catch(m){return null}if(e<b)return null;for(c=b;c<=e;){c=this.getOptimalRange(c,e);if(null===c)return null;f.push(c);c=c.ipHigh+1}return f},calculateSubnetMask:function(c,a){try{var f=this.toDecimal(c)}catch(l){return null}return this.getMaskRange(f,a)},calculateCIDRPrefix:function(c,a){var f=0;try{var b=this.toDecimal(c);var e=this.toDecimal(a)}catch(m){return null}for(c=0;32>c&&
(f=f+(1<<32-(c+1))>>>0,(e&f)>>>0===f);c++);return this.getMaskRange(b,c)},getOptimalRange:function(c,a){var f,b=null;for(f=32;0<=f;f--){var e=this.getMaskRange(c,f);if(e.ipLow===c&&e.ipHigh<=a)b=e;else break}return b},getMaskRange:function(c,a){var f=this.getPrefixMask(a),b=this.getMask(32-a),e=(c&f)>>>0;c=((c&f)>>>0)+b>>>0;return{ipLow:e,ipLowStr:this.toString(e),ipHigh:c,ipHighStr:this.toString(c),prefixMask:f,prefixMaskStr:this.toString(f),prefixSize:a,invertedMask:b,invertedMaskStr:this.toString(b),
invertedSize:32-a}},getPrefixMask:function(c){var a=0,h;for(h=0;h<c;h++)a+=1<<32-(h+1)>>>0;return a},getMask:function(c){var a=0,h;for(h=0;h<c;h++)a+=1<<h>>>0;return a},isIp:function(c){if("string"!==typeof c)return!1;c=c.match(/^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/);if(null===c)return!1;for(var a=1;4>=a;a++){var h=parseInt(c[a],10);if(255<h||0>h)return!1}return!0},isDecimalIp:function(c){return"number"===typeof c&&0===c%1&&0<=c&&4294967295>=c},toDecimal:function(c){if("number"===
typeof c&&!0===this.isDecimalIp(c))return c;if(!1===this.isIp(c))throw Error("Not an IP address: "+c);c=c.split(".");return 256*(256*(256*+c[0]+ +c[1])+ +c[2])+ +c[3]},toString:function(c){if("string"===typeof c&&!0===this.isIp(c))return c;if(!1===this.isDecimalIp(c))throw Error("Not a numeric IP address: "+c);for(var a=c%256,h=3;0<h;h--)c=Math.floor(c/256),a=c%256+"."+a;return a}},a=function(c){this._file=c;this._file||(this._file=a.FILE);this._globalOptions=[];this._interfaceOptions={}};a.FILE=
"/etc/dhcpcd.conf";a.prototype.init=function(c){this._read(function(a){c&&c(a)})};a.prototype.getConfig=function(c){var a={dhcp:!0};if(!this._interfaceOptions||!this._interfaceOptions[c])return a;c=this._interfaceOptions[c];for(var h=0;h<c.length;h++){var b=c[h];if(b&&"static"==b.substr(0,6)){a.dhcp=!1;b=b.substr(6).trim();var e=b.indexOf("=");if(-1!=e){var g=b.substr(0,e);b=b.substr(e+1);switch(g){case "ip_address":g=b.split("/");1==g.length?(a.ip=g[0],a.subnet="255.255.255.0"):(b=d.calculateSubnetMask(g[0],
parseInt(g[1])),a.ip=g[0],a.subnet=b.prefixMaskStr);break;case "routers":a.router=b.split(" ");break;case "domain_name_servers":a.dns=b.split(" ")}}}}return a};a.prototype.setConfig=function(c,a,b){if(c&&a)if(a.dhcp||a.ip&&a.subnet&&a.router&&a.dns){if(a.dhcp)delete this._interfaceOptions[c];else{var f=d.calculateSubnetMask(a.ip,a.subnet);if(!f){b&&b(Error("invalid argument"));return}this._interfaceOptions[c]=["static ip_address="+a.ip+"/"+f.prefixSize,"static routers="+(Array.isArray(a.router)?a.router.join(" "):
a.router),"static domain_name_servers="+(Array.isArray(a.dns)?a.dns.join(" "):a.dns)]}this._write(function(a){b&&b(a)})}else b&&b(Error("invalid argument"));else b&&b(Error("invalid argument"))};a.prototype._read=function(a){var c=this;require("fs").readFile(this._file,{encoding:"utf8"},function(f,b){if(f)a(f);else{if(b){f=b.split("\n");b=null;for(var h=0;h<f.length;h++){var e=f[h].trim();e&&"#"!=e.charAt(0)&&(e=e.trim(),"interface"==e.substr(0,9)?b=e.substr(9).trim():b?(c._interfaceOptions[b]||(c._interfaceOptions[b]=
[]),c._interfaceOptions[b].push(e)):c._globalOptions.push(e))}}a()}})};a.prototype._write=function(a){var c="";this._globalOptions.forEach(function(a){c+=a+"\n\n"});for(var b in this._interfaceOptions){c+="interface "+b+"\n";for(var e=this._interfaceOptions[e],d=0;d<e.length;d++)c+="  "+e[d]+"\n";c+="\n"}require("fs").writeFile(this._file,c,function(c){a(c)})};var b=function(a){this._file=a;a||(this._file=b.FILE)};b.FILE="/etc/resolv.conf";b.prototype.getDns=function(a){require("fs").readFile(this._file,
{encoding:"utf8"},function(c,b){if(c)a&&a(c);else{c=[];b=b.split("\n");for(var f=0;f<b.length;f++){var h=b[f].trim();"#"!=h.charAt(0)&&"nameserver"==h.substr(0,10)&&(h=h.substr(10).trim(),c.push(h))}a&&a(null,c)}})};var e=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network.Wifi");this._file=a;a||(this._file=e.FILE);this._networks=[];this._wpaSocket=null;this._state=-2;this._initFinish=!1;this._scanCallback=null;this._scanTimeout=2E4;this._scanTo=null};e.FILE="/config/wpa_supplicant.conf";
e.SOCKET_PATH="/var/run/wpa_supplicant";e.prototype.init=function(a){var c=this;this._read(function(f,b){c._initFinish=!0;!f&&b&&(c._networks=b);a&&a(f);0==c._state&&c._checkInitWifiStatus()})};e.prototype.getFile=function(){return this._file};e.prototype.reset=function(a){this._logger.log("trace","reset");var c=this;this._networks=[];this._write(function(f){c._logger.log("trace","reset "+(f?" failed: "+f.message:"success"));a&&a(f)})};e.prototype.restore=function(a,f){this._logger.log("trace","restore from:"+
a);var c=require("fs"),b=require("fs-extra");try{c.existsSync(a+"/config/wpa_supplicant.conf")&&b.copySync(a+"/config/wpa_supplicant.conf",this._file),this._logger.log("trace","restore success"),f&&f()}catch(k){this._logger.log("trace","restore failed: "+k.message),f&&f(k)}};e.prototype.backup=function(a,f){this._logger.log("trace","backup to:"+a);var c=this;require("fs-extra").copy(this._file,a+"/config/wpa_supplicant.conf",function(a){c._logger.log("trace","backup "+(a?"failed: "+a.message:"success"));
f&&f(a)})};e.prototype.info=function(a,f){this._logger.log("trace","get wifi info");if(this._wpaSocket)if(0!=this._state)f&&f(Error("current state not idle:"+this._state));else{var c=this,b={};this._status(function(a,h){a?f&&f(a):(b.status={connected:!1},h&&("COMPLETED"==h.wpa_state&&(b.status.connected=!0),h.ssid&&(b.status.ssid=h.ssid)),b.networks=c._networks.map(function(a){var c=a.ssid;'"'==c.charAt(0)?(c=c.substr(1),'"'==c.charAt(c.length-1)&&(c=c.substr(0,c.length-1))):c=(new Buffer(a.ssid,
"hex")).toString("utf8");return{ssid:c}}),b.status.connected?c._signalPoll(function(a,c){!a&&c&&(b.status.rssi=parseInt(c.RSSI));f&&f(null,b)}):f&&f(null,b))})}else f&&f(Error("wlan not exist"))};e.prototype.scan=function(a,f){this._logger.log("trace","scan wifi on "+a);if(this._wpaSocket)if(0!=this._state)f&&f(Error("current state not idle:"+this._state));else{var c=this;this._state=1;this._scanCallback=f;this._scan(function(a){a?(c._state=0,c._scanCallback=null,f&&f(a)):c._scanTo=setTimeout(function(){c._logger.log("trace",
"scan wifi timeout");c._state=0;c._scanTo=null;c._scanCallback&&(c._scanCallback(Error("scan wifi timeout")),c._scanCallback=null)},c._scanTimeout)})}else f&&f(Error("wlan not exist"))};e.prototype.connect=function(a,f,b){if(a&&f&&f.ssid&&f.password)if(this._logger.log("trace","connect wifi on "+a+" to "+f.ssid),this._wpaSocket)if(0!=this._state)b&&b(Error("current state not idle:"+this._state));else{var c=this;this._state=2;this._logger.log("trace","calculate wpa passphrase");this._wpaPassphrase(f.ssid,
f.password,function(a,h){a?(c._logger.log("trace","calculate wpa passphrase failed:"+a.message),c._state=0,b&&b(a)):(a=(new Buffer(f.ssid)).toString("hex"),c._networks=[{ssid:a,psk:h,id_str:'"'+f.ssid+'"'}],c._write(function(a){b&&b(a)}))})}else b&&b(Error("wlan not exist"));else b&&b(Error("invalid arguments"))};e.prototype.disconnect=function(a,b,h){a?(this._logger.log("trace","disconnect wifi on "+a),this._wpaSocket?0!=this._state?h&&h(Error("current state not idle:"+this._state)):(this._networks=
[],this._write(function(a){h&&h(a)})):h&&h(Error("wlan not exist"))):h&&h(Error("invalid arguments"))};e.prototype.startWPAClient=function(a,b){this._logger.log("trace","start wpa client on "+a);if(this._wpaSocket)b&&b();else{var c=this;this._state=-1;this._checkWPADaemon(function(f){c._state=0;if(f)c._logger.log("trace","wpa_supplicant not running"),b&&b(f);else{f=new (require("wpa-client-socket"));var h=e.SOCKET_PATH+"/"+a;f.on("data",function(a){c._onWPAData(a.toString("utf8"))});f.bind(h);f.start();
c._wpaSocket=f;b&&b();c._initFinish&&c._checkInitWifiStatus()}})}};e.prototype._onWPAData=function(a){a=a.trim();this._logger.log("trace","wpa data:"+a);"<"==a.charAt(0)&&">"==a.charAt(2)&&(a=a.substr(3));var c=this;"CTRL-EVENT-SCAN-RESULTS"==a.substr(0,23)?1==this._state&&this._scanResults(function(a,b){c._state=0;c._scanTo&&(clearTimeout(c._scanTo),c._scanTo=0);c._scanCallback&&(c._scanCallback(a,b),c._scanCallback=null)}):"CTRL-EVENT-CONNECTED"==a.substr(0,20)?require("x.hub.v6.js")._led.stopWifiDisconnect():
"CTRL-EVENT-DISCONNECTED"==a.substr(0,23)&&require("x.hub.v6.js")._led.startWifiDisconnect()};e.prototype._status=function(a){this._logger.log("trace","do STATUS command");var c=this._wpaSocket.write("STATUS");this._logger.log("trace","STATUS command result:\n"+c.toString("utf8"));var b=c.toString("utf8");if(b){c={};b=b.trim().split("\n");for(var e=0;e<b.length;e++){var d=b[e].trim();if(d){var g=d.indexOf("=");if(-1!=g){var n=d.substr(0,g);d=d.substr(g+1);n&&(c[n]="ssid"==n?this._ssid2utf8(d):d)}}}a(null,
c)}else a(Error("do STATUS command failed"))};e.prototype._scan=function(a){this._logger.log("trace","do SCAN command");var c=this._wpaSocket.write("SCAN");this._logger.log("trace","SCAN command result:\n"+c.toString());"OK\n"!=c.toString()?a(Error("do scan command failed")):a()};e.prototype._scanResults=function(a){this._logger.log("trace","do SCAN_RESULTS command");var c=this._wpaSocket.write("SCAN_RESULTS");this._logger.log("trace","SCAN_RESULTS command result:\n"+c.toString("utf8"));var b=c.toString("utf8");
if(b){c=[];b=b.trim().split("\n");for(var e=1;e<b.length;e++){var d=b[e].trim();if(d&&(d=d.split("\t"),5<=d.length&&d[4])){var g=d[4].trim();if(g=this._ssid2utf8(g).trim())d={bssid:d[0].trim(),frequency:parseInt(d[1].trim()),signal:parseInt(d[2].trim()),flags:d[3].trim(),ssid:g},c.push(d)}}a(null,c)}else a(Error("do SCAN_RESULTS command failed"))};e.prototype._signalPoll=function(a){this._logger.log("trace","do SIGNAL_POLL command");var c=this._wpaSocket.write("SIGNAL_POLL");this._logger.log("trace",
"SIGNAL_POLL command result:\n"+c.toString("utf8"));var b=c.toString("utf8");if(b){c={};b=b.trim().split("\n");for(var e=0;e<b.length;e++){var d=b[e].trim();if(d){var g=d.indexOf("=");if(-1!=g){var n=d.substr(0,g);d=d.substr(g+1);n&&(c[n]=d)}}}a(null,c)}else a(Error("do SIGNAL_POLL command failed"))};e.prototype._checkInitWifiStatus=function(){var a=this;this._status(function(c,b){!c&&b&&"COMPLETED"!=b.wpa_state&&a._networks.length&&require("x.hub.v6.js")._led.startWifiDisconnect()})};e.prototype._wpaPassphrase=
function(a,b,h){this._logger.log("trace","call wpa_passphrase wiht ssid:"+a+" password:********");var c=require("child_process").exec;a=c('wpa_passphrase "'+a+'" "'+b+'"');var f=this,e=null;a.stdout.on("data",function(a){e+=String(a)});a.on("error",function(a){h&&(h(a),h=null)});a.on("close",function(a){if(0==a){a=null;for(var c=e.split("\n"),b=0;b<c.length;b++){var d=c[b].trim();if(d&&"psk="==d.substr(0,4)){a=d.substr(4);break}}f._logger.log("trace","call wpa_passphrase get psk:"+a);h&&(h(null,a),
h=null)}else h&&(h(Error("exit with code:"+a)),h=null)})};e.prototype._read=function(a){require("fs").readFile(this._file,{encoding:"utf8"},function(c,b){if(c)a(c);else{c=[];if(b){b=b.split("\n");for(var f=null,h=0;h<b.length;h++){var e=b[h].trim();if(e&&"#"!=e.charAt(0))if("network="==e.substr(0,8))f={};else if("}"==e)f&&c.push(f),f=null;else if(f){var d=e.split("=");e=d[0];d=d[1];e&&(f[e]=d)}}}a(null,c)}})};e.prototype._write=function(a){var c="ctrl_interface=/var/run/wpa_supplicant\nupdate_config=1\n\n";
for(var b=0;b<this._networks.length;b++){var e=this._networks[b];if(e){c+="network={\n";for(var d in e)c+="\t"+d+"="+e[d]+"\n";c+="}\n"}}require("fs").writeFile(this._file,c,function(c){a(c)})};e.prototype._checkWPADaemon=function(a){var c=0,b=this,e=function(f,h){c++;!f&&h?a():10<=c?a(Error("no pid")):setTimeout(function(){b._getWpaSupplicantPID(e)},1E3)};this._getWpaSupplicantPID(e)};e.prototype._getWpaSupplicantPID=function(a){var c=require("child_process").exec;c=c("pidof wpa_supplicant");var b=
null;c.stdout.on("data",function(a){b=String(a).trim()});c.on("error",function(c){a&&(a(c),a=null)});c.on("close",function(c){a&&(a(null,b),a=null)})};e.prototype._ssid2utf8=function(a){for(var c=[],b=0;b<a.length;)if("\\"!=a.charAt(b))c.push(a.charCodeAt(b)),b++;else if(b==a.length-1)c.push(a.charCodeAt(b)),b++;else if("x"!=a.charAt(b+1))c.push(a.charCodeAt(b+1)),b+=2;else{if(!(b+3>=a.length)){var e=a.charAt(b+2)+a.charAt(b+3);e=parseInt(e,16);isNaN(e)||c.push(e)}b+=4}return(new Buffer(c)).toString("utf8")};
var g=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Network");this._handler=a;this._wlan0=this._eth0=this._wifi=this._resolvConf=this._dhcpcdConf=null};g.DHCPCD_CONF="/etc/dhcpcd.conf";g.RESOLV_CONF="/etc/resolv.conf";g.WPA_SUPPLICANT_CONF="/config/wpa_supplicant.conf";g.SET_MAC_SCRIPT="/opt/scripts/set_mac_address.sh";g.prototype.init=function(c){global.SYSTEM_ROOT&&(g.DHCPCD_CONF=global.SYSTEM_ROOT+g.DHCPCD_CONF,g.RESOLV_CONF=global.SYSTEM_ROOT+g.RESOLV_CONF,g.WPA_SUPPLICANT_CONF=
global.SYSTEM_ROOT+g.WPA_SUPPLICANT_CONF,g.SET_MAC_SCRIPT=global.SYSTEM_ROOT+g.SET_MAC_SCRIPT);var f=require("x.hub.eventbus.js");f.on("x.hub.peripheralman.ADD_WLAN",function(a){h._logger.log("debug","insert wlan usb stick: "+a.port);"wlan0"==a.port&&h._readMac(a.port,function(a,c){!a&&c&&(h._wlan0={mac:c});h._wifi.startWPAClient("wlan0")})});f.on("x.hub.peripheralman.REMOVE_WLAN",function(a){h._logger.log("debug","eject wlan usb stick: "+a.port);"wlan0"==a.port&&(h._wlan0=null)});this._resolvConf=
new b(g.RESOLV_CONF);this._dhcpcdConf=new a(g.DHCPCD_CONF);this._wifi=new e(g.WPA_SUPPLICANT_CONF);var h=this;this._readMac("eth0",function(a,b){!a&&b&&(h._eth0={mac:b});h._dhcpcdConf.init(function(){h._wifi.init(c)})})};g.prototype.getMediolaMac=function(){return this._eth0?this._eth0.mac:null};g.prototype.getNetwork=function(a){var c=this;this._getDNS(function(b,f){c._getRouter(function(b,e){b=require("os").networkInterfaces();var h={},d;for(d in b)if("lo"!=d.substr(0,2))for(var g=b[d],l=0;l<g.length;l++){var k=
g[l];if(!k.internal&&"IPv4"==k.family){k={ip:k.address,subnet:k.netmask,mac:k.mac};var m=c._dhcpcdConf.getConfig(d);(k.dhcp=m.dhcp)?(k.router=e?e[d]:null,k.dns=f):(k.router=m.router[0],k.dns=m.dns);h[d]=k}}c._eth0&&!h.eth0&&(h.eth0={mac:c._eth0.mac});c._wlan0&&!h.wlan0&&(h.wlan0={mac:c._wlan0.mac});a&&a(null,h)})})};g.prototype.setNetwork=function(a,b,e){if(b)if(1!=b.dhcp&&0!=b.dhcp)e&&e(Error("invalid argument"));else{a||(a="eth0");var c={};"eth0"==a?1==b.dhcp?c.ETH0_DHCP="true":0==b.dhcp&&(c.ETH0_DHCP=
"false",c.ETH0_IP=b.ip,c.ETH0_MASK=b.subnet,c.ETH0_ROUTER=b.router,c.ETH0_DNS=b.dns.join(" ")):"wlan0"==a&&(1==b.dhcp?c.WLAN0_DHCP="true":0==b.dhcp&&(c.WLAN0_DHCP="false",c.WLAN0_IP=b.ip,c.WLAN0_MASK=b.subnet,c.WLAN0_ROUTER=b.router,c.WLAN0_DNS=b.dns.join(" ")));this._handler._sysConf.setValues(c,function(a){e&&e(a)})}else e&&e(Error("invalid argument"))};g.prototype.setMAC=function(a,b){var c=require("child_process").exec;a=c(g.SET_MAC_SCRIPT+" "+a);a.stdout.on("data",function(a){console.log(String(a))});
a.on("error",function(a){b&&(b(a),b=null)});a.on("close",function(a){b&&(b(0==a?null:Error("set mac address failed")),b=null)})};g.prototype.scanWifi=function(a,b){if(this._wlan0){var c=this;this._logger.log("debug","scan wifi with options: "+JSON.stringify(a));this._wifi.scan("wlan0",function(a,f){c._logger.log("debug","scan wifi "+(a?"failed: "+a.message:"success: "+JSON.stringify(f)));!a&&f&&(f=f.filter(function(a){return a&&a.flags&&-1==a.flags.indexOf("EAP")&&-1==a.flags.indexOf("WEP")?!0:!1}));
b&&b(a,f)})}else b&&b(Error("wlan not avaliable"))};g.prototype.connectWifi=function(a,b){if(this._wlan0)if(a&&a.ssid&&a.password){var c=!1;if("true"==a.dhcp||"1"==a.dhcp||1==a.dhcp)c=!0;var f=this;this._logger.log("debug","connect to wifi to: "+a.ssid+(c?" (dhcp=true)":""));this._wifi.connect("wlan0",a,function(a){f._logger.log("debug","connect wifi "+(a?"failed: "+a.message:"success"));a?b&&b(a):c?(f._logger.log("debug","enable dhcp of wlan0"),f._handler._sysConf.setValues({WLAN0_DHCP:"true"},function(a){f._logger.log("debug",
"enable dhcp of wlan0 "+(a?" failed: "+a.message:" success"));b&&b(a)})):b&&b()})}else b&&b(Error("invalid arguments"));else b&&b(Error("wlan not avaliable"))};g.prototype.disconnectWifi=function(a,b){if(this._wlan0){var c=this;this._logger.log("debug","disconnect wifi");this._wifi.disconnect("wlan0",a,function(a){c._logger.log("debug","disconnect wifi "+(a?"failed: "+a.message:"success"));b&&b(a)})}else b&&b(Error("wlan not avaliable"))};g.prototype.getWifiInfo=function(a,b){if(this._wlan0){var c=
this;this._logger.log("debug","get wifi info");this._wifi.info(null,function(a,f){c._logger.log("debug","get wifi status "+(a?" failed:"+a.message:" success:"+JSON.stringify(f)));if(a)b&&b(a);else{var e=c._handler._sysConf.getValueSync("WLAN0_DHCP");f.config={wlan0:{dhcp:"true"==e||1==e||""==e}};f.config.wlan0.dhcp||(f.config.wlan0.ip=c._handler._sysConf.getValueSync("WLAN0_IP"),f.config.wlan0.subnet=c._handler._sysConf.getValueSync("WLAN0_MASK"),f.config.wlan0.router=c._handler._sysConf.getValueSync("WLAN0_ROUTER"),
e=c._handler._sysConf.getValueSync("WLAN0_DNS"),f.config.wlan0.dns=e?e.split(" "):[]);b&&b(a,f)}})}else b&&b(Error("wlan not avaliable"))};g.prototype.resetNetwork=function(a){this._logger.log("debug","reset");var c=this;this._wifi.reset(function(b){b?(c._logger.log("debug","reset wifi failed: "+b.message),a&&a(b)):c._handler._sysConf.setValues({ETH0_DHCP:"true",WLAN0_DHCP:"true"},function(b){b?c._logger.log("debug","reset to dhcp failed: "+b.message):c._logger.log("debug","reset success");a&&a(b)})})};
g.prototype.restore=function(a,b){this._logger.log("debug","restore from:"+a);var c=this;this._wifi.restore(a,function(a){c._logger.log("debug","restore "+(a?"failed: "+a.message:"success"));b&&b(a)})};g.prototype.backup=function(a,b){this._logger.log("debug","backup to:"+a);var c=this;this._wifi.backup(a,function(a){c._logger.log("debug","backup "+(a?"failed: "+a.message:"success"));b&&b(a)})};g.prototype._getDNS=function(a){this._resolvConf.getDns(a)};g.prototype._getRouter=function(a){var c=require("child_process").exec;
c=c("route -n");var b=null;c.stdout.on("data",function(a){b+=String(a)});c.on("error",function(c){a&&(a(c),a=null)});c.on("close",function(c){if(0==c){c={};for(var e=b.split("\n"),f=2;f<e.length;f++){var d=e[f].trim().split(" ").filter(function(a){return!!a});d.length&&"0.0.0.0"==d[0].trim()&&(c[d[7].trim()]=d[1].trim())}a&&(a(null,c),a=null)}else a&&(a(Error("exit with code:"+c)),a=null)})};g.prototype._readMac=function(a,b){if("PI-CM3+"!=global.PLATFORM)b();else{var c=this;this._logger.log("trace",
"read "+a+" mac");require("fs").readFile("/sys/class/net/"+a+"/address",{encoding:"utf8"},function(e,f){c._logger.log("trace","read "+a+" mac "+(e?" failed:"+e.message:" success:"+f));if(f){f=f.trim();var d=f.replace(/:/g,"-")}b(e,d)})}};return g}();
x.hub.v6.SystemConf=function(){var d=function(){this._conf={};this._writeCallbacks=[];this._writing=!1};d.FILE="/config/system.conf";d.prototype.init=function(a){global.SYSTEM_ROOT&&(d.FILE=SYSTEM_ROOT+d.FILE);this._readConf(function(){a&&a()})};d.prototype.getValueSync=function(a){if(void 0==a||null==a||"string"!=typeof a)throw Error("invalid key");a=this._conf[a];if(void 0==a||null==a)a="";return a};d.prototype.getValue=function(a,b){if(void 0==a||null==a||"string"!=typeof a)b&&b(Error("invalid key"));
else{a=this._conf[a];if(void 0==a||null==a)a="";b&&b(null,a)}};d.prototype.setValue=function(a,b,e){void 0==a||null==a||"string"!=typeof a?e&&e(Error("invalid key")):void 0==b||null==b||"string"!=typeof b?e&&e(Error("invalid value")):(this._conf[a]=b,e&&this._writeCallbacks.push(e),this._writing||this._doNextWrite())};d.prototype.setValues=function(a,b){if(a){var e=0,d;for(d in a)if(void 0!=d&&null!=d&&"string"==typeof d){var c=a[d];void 0!=c&&null!=c&&"string"==typeof c&&(e++,this._conf[d]=c)}0==
e?b&&b(Error("no valid entry")):(b&&this._writeCallbacks.push(b),this._writing||this._doNextWrite())}else b&&b(Error("invalid map"))};d.prototype.reset=function(a){this._conf={};a&&this._writeCallbacks.push(a);this._writing||this._doNextWrite()};d.prototype.restore=function(a,b){var e=require("fs"),g=require("fs-extra");if(e.existsSync(a+"/config/system.conf"))try{g.copySync(a+"/config/system.conf",d.FILE)}catch(c){}b&&b()};d.prototype.backup=function(a,b){require("fs-extra").copy(d.FILE,a+"/config/system.conf",
function(a){b&&b(a)})};d.prototype._doNextWrite=function(){var a=this._writeCallbacks;this._writeCallbacks=[];this._writing=!0;var b=this;this._writeConf(function(e){b._writing=!1;for(var d=0;d<a.length;d++){var c=a[d];try{c(e)}catch(f){}}b._writeCallbacks&&b._writeCallbacks.length&&b._doNextWrite()})};d.prototype._readConf=function(a){var b=this;this._readFile(function(e,d){if(!e&&d)for(e=d.split("\n"),d=0;d<e.length;d++){var c=e[d].trim();if(c){var f=c.indexOf("=");if(-1!=f){var h=c.substr(0,f).trim();
c=c.substr(f+1).trim();h&&(b._conf[h]=c)}}}a()})};d.prototype._writeConf=function(a){var b="",e;for(e in this._conf)b+=e+"="+this._conf[e]+"\n";this._writeFile(b,a)};d.prototype._readFile=function(a){require("fs").readFile(d.FILE,{encoding:"utf8"},function(b,e){a(b,e)})};d.prototype._writeFile=function(a,b){require("fs").writeFile(d.FILE,a,function(a){b(a)})};return d}();
x.hub.v6.Location=function(){var d=function(a){this._logger=require("x.logger.js").getLogger("x.hub.v6.Location");this._lat=d.DEFAULT_LATITUDE;this._long=d.DEFAULT_LONGITUDE;this._handler=a};d.DEFAULT_LATITUDE="020D";d.DEFAULT_LONGITUDE="0087";d.prototype.init=function(a){if(localStorage){var b=localStorage.getItem("x.hub.Server.geo.lat");b&&(self._lat=b);if(b=localStorage.getItem("x.hub.Server.geo.long"))self._long=b}a&&a()};d.prototype.setLocation=function(a,b,e){this._logger.log("debug","set location lat="+
a+" long="+b);if(a&&b){this._lat=a;this._long=b;var d=this;this._handler._stm.sendCommand(16,"XC_FNC=setLocation&lat="+a+"&long="+b,function(c){d._logger.log("debug","set location to stm lat="+a+" long="+b+" result:"+JSON.stringify(c));localStorage&&(localStorage.setItem("x.hub.Server.geo.lat",a),localStorage.setItem("x.hub.Server.geo.long",b));e&&e(c?c.error:null)})}else e&&e(Error("invalid lat/long"))};d.prototype.getLocation=function(a){a&&a(null,this._lat,this._long)};d.prototype.restore=function(a,
b,e){this._logger.log("trace","restore geo location");var g=require("fs"),c=require("path"),f=null,h=null,l=0,k=this,m=function(){l++;if(2==l){if(b&&"v5+"==b.backupType){f&&h||(f="1392",h="035C");var a=parseInt(f,16);a=Math.round(a/10);for(a=a.toString(16);4>a.length;)a="0"+a;var c=parseInt(h,16);c=Math.round(c/10);for(c=c.toString(16);4>c.length;)c="0"+c;k._logger.log("trace","convert v5+ format to v6+ format: "+a+","+c);f=a;h=c;try{k._logger.log("trace","overwrite v6+ format latitude to "+n),g.writeFileSync(n,
f.toUpperCase())}catch(v){k._logger.log("trace","overwrite v6+ format latitude to "+n+" failed:"+v.message)}try{k._logger.log("trace","overwrite v6+ format longitude to "+p),g.writeFileSync(p,h.toUpperCase())}catch(v){k._logger.log("trace","overwrite v6+ format longitude to "+p+" failed:"+v.message)}}else f&&h||(f=d.DEFAULT_LATITUDE,h=d.DEFAULT_LONGITUDE);k.setLocation(f,h,e)}},n=c.join(a,"data","localstorage","x.hub.Server.geo.lat");g.existsSync(n)?(this._logger.log("trace","read latitude from backup file: "+
n),g.readFile(n,{encoding:"utf8"},function(a,c){k._logger.log("trace","read latitude from backup file"+(a?" failed:"+a.message:" success:"+c));!a&&c&&(f=c);m()})):m();var p=c.join(a,"data","localstorage","x.hub.Server.geo.long");g.existsSync(p)?(this._logger.log("trace","read longitude from backup file: "+n),g.readFile(p,{encoding:"utf8"},function(a,c){k._logger.log("trace","read longitude from backup file"+(a?" failed:"+a.message:" success:"+c));!a&&c&&(h=c);m()})):m()};return d}();
x.hub.v6.STM=function(){var d=require("util"),a=require("events"),b=require("x.hub.v5.js").USBSerial,e=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM.Serial");this._port=a?a:g.SERIAL_PORT;this._baudrate=b?b:g.SERIAL_BAUDRATE;this._stmUSBSerial=null;this._receiveBuffer=new Buffer([]);this._onData=null;this._useAck=!0;this._reqFifo=[];this.REQ_FIFO_MAX_LEN=5;this.ACK_TO=200;this.RSP_TO=1E4;this.MAX_RSP_TO=3E4;this.RSP_END_TO=2E3};d.inherits(e,b);e.prototype._openSTMUSB=function(a){if(this._stmUSBSerial)a&&
a(!0);else{var c=this,b=a;a=require("xnm.aio.m10T.js");var e=this._baudrate,d=new a.STMUSBSerial;d.on("error",function(){c._logger.log("trace","st port error");try{c._stmUSBSerial.close()}catch(m){}c._stmUSBSerial=null;b&&b(!1);b=null});d.on("timeout",function(){c._logger.log("trace","st port timeout")});d.on("data",function(a){c._logger.log("trace","st data:"+a.toString("hex"));c._receiveBuffer=Buffer.concat([c._receiveBuffer,a]);for(a=c._getNextDataPackage();a;){c._logger.log("trace","st package:"+
a.toString("hex"));var b=a.slice(1,a.length-1);switch(a[0]){case 80:c._logger.log("info","receive st event:"+b.toString());c._sendAck();break;case 0:c._onNak();break;case 1:c._onAck();break;case 34:c._sendAck();c._onRspError(b);break;case 32:c._sendAck();c._onRsp(b);break;case 33:c._sendAck();c._onRspEnd(b);break;default:c._sendAck()}c._onData&&c._onData({type:a[0],data:b});a=c._getNextDataPackage()}});d.open(this._port,function(){c._logger.log("trace","st connected");c._stmUSBSerial=d;b&&b(!0);b=
null},e)}};var g=function(a,b,d,l){this._logger=require("x.logger.js").getLogger("x.hub.v6.STM");this._handler=a;this._pin=l?l:g.RESET_PIN;this._last_error=this._state=0;var c=this;this._serial=new e(b?b:g.SERIAL_PORT,d?d:g.SERIAL_BAUDRATE);this._serial.on("data",function(a){c._onData(a)});this._flashTO=this._flashCB=this._resetTO=this._resetCB=null};d.inherits(g,a);g.SERIAL_PORT="/dev/ttyS0";g.SERIAL_BAUDRATE=230400;g.BOOT_PIN=4;g.RESET_PIN=5;g.MODE_SCRIPT="/opt/scripts/set_stm_mode.sh";g.FIRMWARE_FILE=
"/opt/firmware/latest.bin";g.prototype.init=function(a){global.SYSTEM_ROOT&&(g.MODE_SCRIPT=SYSTEM_ROOT+g.MODE_SCRIPT,g.FIRMWARE_FILE=SYSTEM_ROOT+g.FIRMWARE_FILE);var c=this;this._state=1;this._serial._openSTMUSB(function(b){b?c._state=2:(c._state=0,c._last_error=1);a&&a(b)})};g.prototype.reset=function(a){if(5==this._state)a&&a(Error("stm is resetting"));else if(2!=this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","do stm factory reset");var c=this;this._state=5;
this._serial.reset(function(){c._serial.sendCommand(53,[],function(b){var e=null;if(!b||b.error)e=b?b.error:Error("reset stm failed");e?(c._logger.log("trace","do stm factory reset failed:"+e.message),a&&a(e)):(c._resetCB=function(){c._resetTO&&(clearTimeout(c._resetTO),c._resetTO=null);c._state=2;a&&a()},c._resetTO=setTimeout(function(){c._resetTO=null;c._state=2;a&&a(Error("reset timeout"))},3E4))})})}};g.prototype.reboot=function(a){if(3==this._state)a&&a(Error("stm is rebooting"));else if(2!=
this._state)a&&a(Error("stm has state:"+this._state));else{this._logger.log("trace","reboot stm");var c=this;this._state=3;this._serial.reset(function(){c._setSTMMode("reboot",function(b){c._logger.log("trace","reboot stm "+(b?"failed:"+b.message:"success"));c._state=2;a&&a(b)})})}};g.prototype.backup=function(a,b){var c=this,e=function(a,b,e){c.sendCommand(16,a,function(a){a&&a.data?a.error?e(Error("response error:"+a.data.toString())):require("fs").writeFile(b,a.data.toString(),function(a){e(a)}):
e(Error("invalid response"))})};c._logger.log("trace","backup get all");e("XC_FNC=GetAll",a+"/all.json",function(d){c._logger.log("trace","backup get states");e("XC_FNC=GetStates&config=1",a+"/states.json",function(d){d?(c._logger.log("warn","backup get states failed:"+d.message),b&&b(d)):(c._logger.log("trace","backup get si"),e("XC_FNC=GetSI",a+"/si.json",function(d){d?(c._logger.log("warn","backup get si failed:"+d.message),b&&b(d)):(c._logger.log("trace","backup get config (hmip)"),e("XC_FNC=GetConfig&sys=HmIP",
a+"/conf_hmip.json",function(d){d?(c._logger.log("warn","backup get config (hmip) failed:"+d.message),b&&b(d)):(c._logger.log("trace","backup get sys (hmip)"),e("XC_FNC=GetSys&sys=HmIP",a+"/sys_hmip.json",function(a){a&&c._logger.log("warn","backup get sys (hmip) failed:"+a.message);b&&b(a)}))}))}))})})};g.prototype.restore=function(a,b){if(6==this._state)b&&b(Error("stm restore process is running"));else if(2!=this._state)b&&b(Error("stm has state:"+this._state));else{this._state=6;var c=this,e=
function(a,b){var e=function(a,b){a.TZ?c._serial.sendCommand(16,"XC_FNC=setTZ&data="+a.TZ,function(a){b()}):b()},d=function(a,b){a.LAT&&a.LONG?c._serial.sendCommand(16,"XC_FNC=setLocation&lat="+a.LAT+"&long="+a.LONG,function(a){b()}):b()},f=function(a,b){var e="XC_FNC=setRFM&data="+a.mode;a.type&&(e+="&type="+a.type);c._serial.sendCommand(16,e,function(a){b()})},g=function(a,b){var e=null;a.ER&&"object"===typeof a.ER&&"string"===typeof a.ER.ADR?e=a.ER.ADR:"string"===typeof a.EID&&(e=a.EID,isLegacy=
!0);e?c._serial.sendCommand(16,"XC_FNC=setConfig&type=ER&adr="+e,function(a){b()}):b()},h=function(a,b){var e=null;a.HM&&"object"===typeof a.HM&&"string"===typeof a.HM.ADR?e=a.HM.ADR:"string"===typeof a.HMADR&&(e=a.HMADR);e?c._serial.sendCommand(16,"XC_FNC=setConfig&sys=HM&type=ADR&config="+e,function(a){b()}):b()},l=function(a,b){c._logger.log("trace","restore tz");e(a,function(e){e&&c._logger.log("warn","restore tz failed:"+e.message);c._logger.log("trace","restore geo location");d(a,function(e){e&&
c._logger.log("warn","restore geo location failed:"+e.message);var d={mode:a.RFM.substr(2,2),type:433};c._logger.log("trace","restore 433 sensor mode");f(d,function(e){e&&c._logger.log("warn","restore 433 sensor mode failed:"+e.message);d={mode:a.RFM.substr(0,2)};c._logger.log("trace","restore 868 sensor mode");f(d,function(e){e&&c._logger.log("warn","restore 868 sensor mode failed:"+e.message);c._logger.log("trace","restore elero address");g(a,function(e){e&&c._logger.log("warn","restore elero address failed:"+
e.message);c._logger.log("trace","restore hm address");h(a,function(a){a&&c._logger.log("warn","restore hm address failed:"+a.message);b()})})})})})})};(function(a,c){var b=require("fs-extra");a+="/si.json";b.existsSync(a)?b.readFile(a,{encoding:"utf8"},function(a,b){if(a)c(a);else if(b)try{var e=JSON.parse(b);c(null,e)}catch(z){c(z)}else c(null,null)}):c()})(a,function(a,c){a?b(a):c&&0!=Object.keys(c).length?l(c,function(){b()}):b()})},d=function(a,b){var e=function(a,b){if(a.length){var d=a.pop();
if("string"!==typeof d.sys)e(a,b);else{var f="Add"+d.sys.charAt(0).toUpperCase()+d.sys.slice(1).toLowerCase();"sevent"===d.sys.toLowerCase()&&(f="AddSensorEvent");d.XC_FNC=f;c._serial.sendCommand(17,JSON.stringify(d),function(c){e(a,b)})}}else b()};(function(a,c){var b=require("fs-extra");a+="/all.json";b.existsSync(a)?b.readFile(a,{encoding:"utf8"},function(a,b){if(a)c(a);else if(a=[],b)try{var e=JSON.parse(b);c(null,e)}catch(q){c(q)}else c(null,a)}):c()})(a,function(a,c){a?b(a):c&&0!=c.length?e(c,
function(){b()}):b()})},f=function(a,b){var e=function(a,b){if(a.length){var d=require("querystring"),f=a.pop();if("EVENT"==f.type)e(a,b);else{if("HM"===f.type||"HMFHT"===f.type){if(String(f.adr).toUpperCase().startsWith("HMIP-")){e(a,b);return}var g=null;12==f.adr.length?(g=f.adr.substr(-4),f.adr=f.adr.substr(0,8)):g="FFFF";f.adr=g+f.adr;"HMFHT"===f.type&&delete f.state}else"CF4"==f.type&&(f.adr="0001"+f.adr);d=d.stringify(f);c._serial.sendCommand(16,"XC_FNC=AddSensor&"+d,function(c){e(a,b)})}}else b()};
(function(a,c){var b=require("fs-extra");a+="/states.json";b.existsSync(a)?b.readFile(a,{encoding:"utf8"},function(a,b){if(a)c(a);else if(a=[],b)try{var e=JSON.parse(b);c(null,e)}catch(q){c(q)}else c(null,a)}):c()})(a,function(a,c){a?b(a):c&&0!=c.length?e(c,function(){b()}):b()})},g=function(a,b){var e=function(a,b){a.XC_FNC="setConfig";a.sys="HmIP";c._serial.sendCommand(17,JSON.stringify(a),function(a){a&&a.data?b(null,a.data.toString()):a&&a.error?b(Error(a.error)):b(Error("fail"))})};(function(a,
c){var b=require("fs-extra");a+="/conf_hmip.json";b.existsSync(a)?b.readFile(a,{encoding:"utf8"},function(a,b){if(a)c(a);else if(b)try{var e=JSON.parse(b);c(null,e)}catch(q){c(q)}else c(null,null)}):c()})(a,function(a,c){a?b(a):c?e(c,b):b()})},p=function(a,b){var e=function(a,b){if(a.length){var d=a.pop();d?(d.XC_FNC="addSensor",d.type&&"HmIP"==d.type||(d.type="HmIP"),c._serial.sendCommand(17,JSON.stringify(d),function(c){e(a,b)})):e(a,b)}else b()};(function(a,c){var b=require("fs-extra");a+="/sys_hmip.json";
b.existsSync(a)?b.readFile(a,{encoding:"utf8"},function(a,b){if(a)c(a);else if(b)try{var e=JSON.parse(b);c(null,e)}catch(q){c(q)}else c(null,null)}):c()})(a,function(a,c){a?b(a):c&&0!=c.length?e(c,function(){b()}):b()})};c._logger.log("trace","reset stm for restore");(function(a){c._serial.reset(function(){c._serial.sendCommand(53,[],function(b){var e=null;if(!b||b.error)e=b?b.error:Error("reset stm failed");e?a(e):(c._resetCB=function(){c._resetTO&&(clearTimeout(c._resetTO),c._resetTO=null);a()},
c._resetTO=setTimeout(function(){c._resetTO=null;a(Error("reset timeout"))},3E4))})})})(function(h){h?(c._state=2,c._logger.log("warn","reset stm for restore failed:"+h.message),b&&b(h)):(c._logger.log("trace","restore system info"),e(a,function(e){e&&c._logger.log("warn","restore system info failed:"+e.message);c._logger.log("trace","restore tasks");d(a,function(e){e&&c._logger.log("warn","restore tasks failed:"+e.message);c._logger.log("trace","restore state devices");f(a,function(e){e&&c._logger.log("warn",
"restore state devices failed:"+e.message);c._logger.log("trace","restore config (hmip)");g(a,function(e){e&&c._logger.log("warn","restore config (hmip) failed:"+e.message);c._logger.log("trace","restore sys (hmip)");p(a,function(a){a&&c._logger.log("warn","restore sys (hmip) failed:"+a.message);c._state=2;b&&b()})})})})}))})}};g.prototype.flashFirmware=function(a,b){if(4==this._state)b&&b(Error("flash stm firmware proceess is running"));else if(0!=this._state&&2!=this._state)b&&b(Error("stm has state:"+
this._state));else{a||(a=g.FIRMWARE_FILE);this._logger.log("trace","start to flash stm firmware:"+a);var c=this._state;this._state=4;var e=this,d=function(a){e._logger.log("trace","wait stm reboot");e._flashCB=function(){e._logger.log("trace","stm reboot finish");e._flashTO&&(clearTimeout(e._flashTO),e._flashTO=null);e._state=c;b&&b(a)};e._flashTO=setTimeout(function(){e._logger.log("trace","stm reboot timeout");e._flashTO=null;e._state=c;b&&b(Error("reboot timeout"))},1E4)};this._serial.reset(function(){e._setSTMMode("bootloader",
function(f){f?(e._logger.logger("trace","flash stm failed to enter bootloader mode:"+f.message),e._setSTMMode("reboot",function(){e._state=c;b&&b(f)})):e._flashFirmware(a,function(a){a?e._setSTMMode("reboot",function(){e._state=c;b&&b(a)}):(e._logger.log("trace","flash stm firmware finish success"),d())})})})}};g.prototype.sendCommand=function(a,b,e){2!=this._state?(this._logger.log("trace","reject send stm command, stm connection state:"+this._state),e&&e({error:"stm connection state:"+this._state})):
this._serial.sendCommand(a,b,e)};g.prototype._onData=function(a){if(a&&a.type&&a.data)if(80==a.type){a=a.data.toString();var b=null;8<a.length&&"{XC_EVT}"==a.substr(0,8)?(a=a.substr(8),b="EVT"):4<a.length&&"EVT:"==a.substr(0,4)?(a=a.substr(4),b="EVT"):4<a.length&&"STA:"==a.substr(0,4)&&(a=a.substr(4),b="STA");this.emit("event",a,b)}else if(87==a.type)if(5==this._state||6==this._state){if(this._resetCB){try{this._resetCB()}catch(h){}this._resetCB=null}}else{if(4==this._state&&this._flashCB){try{this._flashCB()}catch(h){}this._flashCB=
null}}else if(81==a.type||83==a.type)b=a.data.readUInt8(0),b=b.toString(16),0!=b.length%2&&(b="0"+b),require("x.hub.commandman.js").commandHandlerV6.executeCommandWithCommandInfo(81==a.type?{legacycloudaction:b}:{cloudaction:b},function(){},"stm");else if(69==a.type)b=a.data.readUInt8(0),a=require("x.hub.v6.js")._led,b?a.startDutyCycle():a.stopDutyCycle();else if(70==a.type)switch(b=a.data.readUInt8(1),a=require("x.hub.v6.js")._led,b){case 0:a.setColor(0,0,0);break;case 1:a.setColor(0,255,0);break;
case 2:a.setColor(0,0,255);break;case 3:a.setColor(255,0,0);break;case 4:a.setColor(255,255,0);break;case 5:a.setColor(255,255,255);break;case 6:a.setColor(255,0,255);break;case 7:a.setColor(0,255,255)}else 90==a.type&&(b=a.data.readUInt8(0),require("x.hub.action.js").getActionManager().executeActionWithId(b,function(){}))};g.prototype._setSTMMode=function(a,b){var c=require("child_process").exec;c=c(g.MODE_SCRIPT+" "+a);c.on("error",function(a){b&&(b(a),b=null)});c.on("close",function(c){b&&(b(0==
c?null:Error("set stm mode: "+a+" failed")),b=null)})};g.prototype._flashFirmware=function(a,b){var c=this;a=new (require("xnm.aio.m10T.js").STMUpdater)(a);this._logger.log("trace","flash stm with dfu-util");a.startDFUUpdate("dfu-util",function(a){b&&a&&(a.error?(c._logger.log("trace","flash stm failed:"+a.error),b(Error(a.error)),b=null):a.state&&(c._logger.log("trace","flash stm progress:"+a.state),c.emit("flash",{progress:a.state}),100==a.state&&(c._logger.log("trace","flash stm success"),b(),
b=null)))},null,"v6p")};return g}();
x.hub.v6.LED=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.LED");this._rgb=[255,255,255];this._state=0;this._buffer=[]};d.STATE_NORMAL=0;d.STATE_BLINK=1;d.STATE_WIFI_DISCONNECT=2;d.STATE_DUTY_CYCLE=3;d.STATE_FLASH_STM=4;d.STATE_INIT_SYSTEM=5;d.STATE_RESET_SYSTEM=6;d.PROCESS="setlight";d.NAMED_PIPE="/tmp/rgb.cfg";d.prototype.init=function(){if(localStorage){var a=localStorage.getItem("x.hub.Server.led");a&&6==a.length&&a.match(/^([a-fA-F0-9]){6}/g)&&(this._rgb=
[parseInt(a.substr(0,2),16),parseInt(a.substr(2,2),16),parseInt(a.substr(4,2),16)])}};d.prototype.saveColor=function(a,b,e,d){var c=this;this.setColor(a,b,e,function(f){if(!f&&localStorage){c._rgb=[a,b,e];for(var g=(new Buffer(c._rgb)).toString("hex");6>g.length;)g="0"+g;localStorage.setItem("x.hub.Server.led",g)}d&&d(f)})};d.prototype.setColor=function(a,b,e,g){if(this._state>d.STATE_BLINK)g&&g(Error("led state:"+this._state));else{var c=this;this._state=d.STATE_NORMAL;this._buffer[d.STATE_BLINK]=
null;this._setColor(a,b,e,function(f){f||(c._buffer[d.STATE_NORMAL]=[a,b,e]);g&&g(f)})}};d.prototype.blinkColor=function(a,b,e,g,c){if(this._state>d.STATE_BLINK)c&&c(Error("led state:"+this._state));else{var f=this;this._state=d.STATE_BLINK;this._buffer[d.STATE_BLINK]=[a,b,e,g];this._blinkColor(a,b,e,g,function(a){a?(f._state=d.STATE_NORMAL,f._buffer[d.STATE_BLINK]=null,f._setLastColor(function(){c&&c(a)})):c&&c()})}};d.prototype.stopBlinkColor=function(a){this._state!=d.STATE_BLINK?a&&a():(this._state=
d.STATE_NORMAL,this._buffer[d.STATE_BLINK]=null,this._setLastColor(function(b){a&&a(b)}))};d.prototype.startWifiDisconnect=function(a){this._logger.log("trace","start wifi disconnect (state="+this._state+")");if(this._state==d.STATE_WIFI_DISCONNECT)a&&a();else if(this._buffer[d.STATE_WIFI_DISCONNECT]=!0,this._state>d.STATE_WIFI_DISCONNECT)a&&a(Error("led state:"+this._state));else{var b=this;this._state=d.STATE_WIFI_DISCONNECT;this._blinkColor(255,255,0,1E3,function(e){e&&(b._state=d.STATE_NORMAL,
b._buffer[d.STATE_WIFI_DISCONNECT]=null,b._setLastColor(a));a&&a(e)})}};d.prototype.stopWifiDisconnect=function(a){this._buffer[d.STATE_WIFI_DISCONNECT]=null;this._state!=d.STATE_WIFI_DISCONNECT?a&&a():(this._state=d.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};d.prototype.startDutyCycle=function(a){this._logger.log("trace","start duty cycle");if(this._state==d.STATE_DUTY_CYCLE)a&&a();else if(this._buffer[d.STATE_DUTY_CYCLE]=!0,this._state>d.STATE_DUTY_CYCLE)a&&a(Error("led state:"+this._state));
else{var b=this;this._state=d.STATE_DUTY_CYCLE;this._blinkColor(255,0,0,500,function(e){e&&(b._state=d.STATE_NORMAL,b._buffer[d.STATE_DUTY_CYCLE]=null,b._setLastColor(a));a&&a(e)})}};d.prototype.stopDutyCycle=function(a){this._logger.log("trace","stop duty cycle");this._buffer[d.STATE_DUTY_CYCLE]=null;this._state!=d.STATE_DUTY_CYCLE?a&&a():(this._state=d.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};d.prototype.startFlashSTM=function(a){if(this._state==d.STATE_FLASH_STM)a&&a();else if(this._state>
d.STATE_FLASH_STM)a&&a(Error("led state:"+this._state));else{var b=this;this._state=d.STATE_FLASH_STM;this._buffer[d.STATE_FLASH_STM]=!0;this._blinkColor(255,255,0,50,function(e){e&&(b._state=d.STATE_NORMAL,b._buffer[d.STATE_FLASH_STM]=null,b._setLastColor(a));a&&a(e)})}};d.prototype.stopFlashSTM=function(a){this._buffer[d.STATE_FLASH_STM]=null;this._state!=d.STATE_FLASH_STM?a&&a():(this._state=d.STATE_NORMAL,this._setLastColor(function(b){a&&a(b)}))};d.prototype.startSystemInit=function(a){this._logger.log("trace",
"start system init");if(this._state==d.STATE_INIT_SYSTEM)a&&a();else if(this._state>d.STATE_INIT_SYSTEM)a&&a(Error("led state:"+this._state));else{var b=this;this._state=d.STATE_INIT_SYSTEM;this._buffer[d.STATE_INIT_SYSTEM]=!0;this._blinkColor(255,255,255,1E3,function(e){e&&(b._state=d.STATE_NORMAL,b._buffer[d.STATE_INIT_SYSTEM]=null,b._setLastColor(a));a&&a(e)})}};d.prototype.stopSystemInit=function(a){this._logger.log("trace","stop system init");this._state!=d.STATE_INIT_SYSTEM?a&&a():(this._state=
d.STATE_NORMAL,this._buffer[d.STATE_INIT_SYSTEM]=null,this._setLastColor(function(b){a&&a(b)}))};d.prototype.startResetSystem=function(a,b,e,g){if(this._state>d.STATE_RESET_SYSTEM)g&&g(Error("led state:"+this._state));else{var c=this;this._state=d.STATE_RESET_SYSTEM;this._buffer[d.STATE_RESET_SYSTEM]=[a,b,e];this._setColor(a,b,e,function(a){a&&(c._state=d.STATE_NORMAL,c._buffer[d.STATE_RESET_SYSTEM]=null,c._setLastColor(g));g&&g(a)})}};d.prototype.stopResetSystem=function(a){this._state>d.STATE_RESET_SYSTEM?
a&&a(Error("led state:"+this._state)):(this._state=d.STATE_NORMAL,this._buffer[d.STATE_RESET_SYSTEM]=null,this._setColor(0,0,0,function(b){a&&a(b)}))};d.prototype._setLastColor=function(a){this._buffer[d.STATE_INIT_SYSTEM]?this.startSystemInit(a):this._buffer[d.STATE_FLASH_STM]?this.startFlashSTM(a):this._buffer[d.STATE_DUTY_CYCLE]?this.startDutyCycle(a):this._buffer[d.STATE_WIFI_DISCONNECT]?this.startWifiDisconnect(a):this._buffer[d.STATE_BLINK]?this.blinkColor(this._buffer[1][0],this._buffer[1][1],
this._buffer[1][2],this._buffer[1][3],a):this._buffer[d.STATE_NORMAL]?this.setColor(this._buffer[0][0],this._buffer[0][1],this._buffer[0][2],a):this.setColor(this._rgb[0],this._rgb[1],this._rgb[2],a)};d.prototype._setColor=function(a,b,e,d){a=this._buildCommand([1,a,b,e,0,0]);this._logger.log("trace","set color:"+a.toString("hex"));this._doCommand(a,function(a){d&&d(a)})};d.prototype._blinkColor=function(a,b,e,d,c){a=[1,a,b,e,0,0];0==d%1E3?a[4]=d/1E3:(a[4]=Math.floor(d/1E3),a[5]=Math.round(d%1E3/
20));d=this._buildCommand(a);this._logger.log("trace","blink color:"+d.toString("hex"));this._doCommand(d,function(a){c&&c(a)})};d.prototype._buildCommand=function(a){var b=[170,a.length+3];b=b.concat(a);a=b[2];for(var e=3;e<b.length;e++)a^=b[e];b.push(a);return new Buffer(b)};d.prototype._doCommand=function(a,b){var e=this;this._getPID(function(d,c){d?(e._logger.log("trace","get program pid error:"+d.message),b&&b(d)):c?e._write(a,b):(e._logger.log("trace","program not running"),b&&b(Error("program not running")))})};
d.prototype._write=function(a,b){var e=require("fs"),g=this;e.access(d.NAMED_PIPE,e.F_OK,function(c){if(c)g._logger.log("warn","led control program not running"),b&&b(c);else{var f=e.createWriteStream(d.NAMED_PIPE);f.on("open",function(){g._logger.log("trace","stream open and write bytes");f.end(a)});f.on("error",function(a){g._logger.log("trace","stream error:"+a.messae);f.__writeTO&&(clearTimeout(f.__writeTO),f.__writeTO=null);b&&(b(a),b=null);f.destroy()});f.on("close",function(){g._logger.log("trace",
"stream close");f.__writeTO&&(clearTimeout(f.__writeTO),f.__writeTO=null);b&&(b(),b=null)});f.__writeTO=setTimeout(function(){g._logger.log("trace","stream write timeout");b&&(b(Error("write timeout")),b=null);f.destroy()},2E3)}})};d.prototype._getPID=function(a){var b=require("child_process").exec;b=b("pidof "+d.PROCESS);var e=null;b.stdout.on("data",function(a){e=String(a).trim()});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(null,e),a=null)})};return d}();
x.hub.v6.ResetPin=function(){var d=function(a,b){this._logger=require("x.logger.js").getLogger("x.hub.v6.ResetPin");this._handler=a;this._pinID=b;this._pinID||(this._pinID=d.PIN);this._checkInterval=this._pressedTS=this._resetMode=this._pin=null};d.PIN=24;d.prototype.init=function(){this._logger.log("trace","init reset pin:"+this._pinID);if("PI-CM3+"==global.PLATFORM){var a=require("onoff").Gpio;(new a(this._pinID,"in","both")).unexport();this._pin=new a(this._pinID,"in","both");var b=this;this._pin.watch(function(a,
d){b._logger.log("trace","reset pin value:"+d);1==d?b._onPress():0==d&&b._onRelease()})}};d.prototype._checkResetPin=function(){var a=this._pin.readSync();this._logger.log("trace","check reset pin value:"+a);0==a?this._onRelease():(a=Date.now()-this._pressedTS,8E3<a?"reboot"!=this._resetMode&&(this._pressedTS=Date.now(),this._resetMode="reboot",this._onModeChange()):6E3<a?"factory"!=this._resetMode&&(this._resetMode="factory",this._onModeChange()):4E3<a?"passwords"!=this._resetMode&&(this._resetMode=
"passwords",this._onModeChange()):2E3<a&&"network"!=this._resetMode&&(this._resetMode="network",this._onModeChange()))};d.prototype._onPress=function(){this._logger.log("trace","reset pin pressed");this._resetMode="reboot";this._pressedTS=Date.now();this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this;this._checkInterval=setInterval(function(){a._checkResetPin()},200);this._onModeChange()};d.prototype._onRelease=function(){this._logger.log("trace","reset pin released, reset mode:"+
this._resetMode);this._checkInterval&&(clearInterval(this._checkInterval),this._checkInterval=null);var a=this._resetMode;this._pressedTS=this._resetMode=null;var b=this,e=this._handler._hub,d=require("x.hub.v6.js")._led;if(e)switch(a){case "reboot":e.restart();break;case "factory":case "passwords":case "network":e.reset(a,function(c,f){b._logger.log("trace",a+" reset finish, reboot:"+f);d.stopResetSystem();!c&&f&&e.restart(1E3)})}};d.prototype._onModeChange=function(){this._logger.log("trace","reset mode change to:"+
this._resetMode);var a=require("x.hub.v6.js")._led;switch(this._resetMode){case "reboot":a.startResetSystem(0,0,0);break;case "network":a.startResetSystem(0,255,0);break;case "passwords":a.startResetSystem(255,255,0);break;case "factory":a.startResetSystem(255,0,0)}};return d}();
x.hub.v6.Recovery=function(){var d=function(){};d.FILE="/config/.recoveryMode";d.prototype.init=function(a){global.SYSTEM_ROOT&&(d.FILE=SYSTEM_ROOT+d.FILE);a&&a()};d.prototype.createEmptyFile=function(a){this._writeProperties({},function(b){a&&a(b)})};d.prototype.setFirmwareUpdateUrl=function(a,b){var e=this;this._readProperties(function(d,c){d?b&&b(d):(c||(c={}),c.URL=a,e._writeProperties(c,function(a){b&&b(a)}))})};d.prototype._readProperties=function(a){var b=require("fs");b.existsSync(d.FILE)?
b.readFile(d.FILE,{encoding:"utf8"},function(b,d){if(b)a&&a(b);else{b={};if(d){d=d.split("\n");for(var c=0;c<d.length;c++){var e=d[c].trim().split("=");b[e[0]]=e[1]}}a(null,b)}}):a(null,{})};d.prototype._writeProperties=function(a,b){var e=require("fs"),g=[],c;for(c in a){var f=a[c];if(void 0==f||null==f)f="";g.push(c+"="+f)}a=g.length?g.join("\n"):"";e.writeFile(d.FILE,a,function(a){b(a)})};return d}();
x.hub.v6.ExtraInfo=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ExtraInfo")};d.prototype.getInfo=function(a){var b=this,e={};this._logger.log("trace","get cpu temperature");this._getCPUTemperature(function(d,c){b._logger.log("trace","get cpu temperature "+(d?"failed:"+d.message:"success:"+c));d||(e.cpuTemp=c);b._logger.log("trace","get gpu temperature");b._getGPUTemperature(function(d,g){b._logger.log("trace","get gpu temperature "+(d?"failed:"+d.message:"success:"+
c));d||(e.gpuTemp=g);a&&a(null,e)})})};d.prototype._getCPUTemperature=function(a){require("fs").readFile("/sys/class/thermal/thermal_zone0/temp",{encoding:"utf8"},function(b,e){b?a(b):(b=parseInt(e),isNaN(b)?a(Error("invalid temperature")):a(null,b/1E3))})};d.prototype._getGPUTemperature=function(a){var b=require("child_process").exec;b=b("vcgencmd measure_temp");var e=null,d=this;b.stdout.on("data",function(a){d._logger.log("trace","get gpu temperature:"+String(a));a=String(a).trim();"temp="==a.substr(0,
5)&&(a=a.substring(5,a.length-2),a=parseFloat(a),isNaN(a)||(e=a))});b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){0!=b?a&&(a(Error("read gpu temperature failed")),a=null):null==e?a&&(a(Error("invalid temperature")),a=null):a&&(a(null,e),a=null)})};return d}();
x.hub.v6.ZwayServer=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.ZwayServer");this._state=0};d.SCRIPT="/srv/init.d/S01z-way-server";d.FOLDER="/srv/z-way-server";d.prototype.init=function(a){global.SYSTEM_ROOT&&(d.FOLDER=SYSTEM_ROOT+d.FOLDER,d.SCRIPT=SYSTEM_ROOT+d.SCRIPT);a&&a()};d.prototype._getConfigFolder=function(){return d.FOLDER+"/config"};d.prototype._getAutomationFolder=function(){return d.FOLDER+"/automation"};d.prototype._getAutomationStorageFolder=
function(){return this._getAutomationFolder()+"/storage"};d.prototype.start=function(a){if(this._state)a&&a(Error("current state is:"+this._state));else{var b=this;this._state=1;this._startAndCheck(3,1E3,function(e){b._state=0;a&&a(e)})}};d.prototype.stop=function(a){if(this._state)a&&a(Error("current state is:"+this._state));else{var b=this;this._state=2;this._stopAndCheck(3,1E3,function(e){b._state=0;a&&a(e)})}};d.prototype.reset=function(a){if(this._state)a&&a(Error("current state is:"+this._state));
else{var b=this;this._state=3;this._logger.log("trace","reset z-way-server");var e=!1;require("async").series([function(a){b._logger.log("trace","check z-way-server state");b._isRunning(function(c,d){b._logger.log("trace","check z-way-server state "+(c?" failed:"+c.message:" running:"+d));c||(e=d);a()})},function(a){e?(b._logger.log("trace","stop z-way-server"),b._stopAndCheck(3,1E3,function(b){a(b)})):a()},function(a){b._logger.log("trace","clear z-way-server folder");b._reset(!1,a)},function(a){e?
(b._logger.log("trace","start z-way-server"),b._startAndCheck(3,1E3,a)):a()}],function(e){b._state=0;a&&a(e)})}};d.prototype.restore=function(a,b,e){if(this._state)e&&e(Error("current state is:"+this._state));else{var g=b?b.restoreUZB:null,c=this;this._state=5;this._logger.log("trace","retore zway data (restoreUZB="+g+") from:"+a+" to:"+d.FOLDER);var f=!1;require("async").series([function(e){if(b&&"v5+"==b.backupType){var d=require("fs");d.existsSync(a+"/zway/automation/storage")&&d.readdir(a+"/zway/automation/storage",
function(b,f){if(!b&&f)for(b=0;b<f.length;b++){var g=f[b];if(g&&"configjson-"==g.substr(0,11))try{c._logger.log("trace","v5+ backup, remove file:"+g),d.unlinkSync(a+"/zway/automation/storage/"+g)}catch(p){}}e()})}else e()},function(a){c._logger.log("trace","check z-way-server state");c._isRunning(function(b,e){c._logger.log("trace","check z-way-server state "+(b?" failed:"+b.message:" running:"+e));b||(f=e);a()})},function(b){if(g){c._logger.log("trace","retore uzb");var e;require("fs").existsSync(a+
"/zway/z-way-backup.zbk")?(e=require("x.hub.m.zway.js").getZway())?e.restore(a+"/zway/z-way-backup.zbk",!0,function(a){c._logger.log("trace","retore uzb "+(a?" failed:"+a.message:" success"));a&&!a.code&&(a.code=-313);b(a)}):(c._logger.log("trace","retore uzb failed: z-way-server not running"),e=Error("z-way-server not running"),e.code=-312,b(e)):(c._logger.log("trace","retore uzb failed: no uzb backup file"),e=Error("no uzb backup file"),e.code=-311,b(e))}else b()},function(a){f?(c._logger.log("trace",
"stop z-way-server"),c._stopAndCheck(3,1E3,function(b){c._logger.log("trace","stop z-way-server "+(b?" failed:"+b.message:" success"));b&&!b.code&&(b.code=-314);a(b)})):a()},function(a){c._logger.log("trace","clear z-way-server folder (restoreUZB="+g+")");c._reset(g,function(b){c._logger.log("trace","clear z-way-server folder (restoreUZB="+g+")"+(b?" failed:"+b.message:" success"));b&&!b.code&&(b.code=-315);a(b)})},function(b){c._logger.log("trace","restore z-way-server folder (restoreUZB="+g+")");
c._restore(a,g,function(a){c._logger.log("trace","restore z-way-server folder (restoreUZB="+g+")"+(a?" failed:"+a.message:" success"));a&&!a.code&&(a.code=-316);b(a)})},function(a){f?(c._logger.log("trace","start z-way-server"),c._startAndCheck(3,1E3,function(b){c._logger.log("trace","start z-way-server "+(b?" failed:"+b.message:" success"));b&&!b.code&&(b.code=-317);a(b)})):a()}],function(a){c._state=0;e&&e(a)})}};d.prototype.backup=function(a,b,e){if(this._state)e&&e(Error("current state is:"+this._state));
else{this._state=4;this._logger.log("trace","backup zway data (backupUZB="+b+") to:"+a);var d=require("fs-extra"),c=this._getConfigFolder(),f=this._getAutomationStorageFolder();if(d.existsSync(c))try{d.copySync(c,a+"/zway/config")}catch(l){}if(d.existsSync(f))try{d.copySync(f,a+"/zway/automation/storage")}catch(l){}if(0==b)this._state=0,e&&e();else if((d=require("x.hub.m.zway.js").getZway())||b)if(!d&&b)this._state=0,e&&e(Error("z-way-server not running"));else{var h=this;this._logger.log("trace",
"backup zwave usb stick");d.backup(a+"/zway",function(a){h._logger.log("trace","backup zwave usb stick "+(a?" failed:"+a.message:" success"));h._state=0;e&&e(a)})}else this._state=0,e&&e()}};d.prototype._startAndCheck=function(a,b,e){var d=this;this._start(function(c){if(c)e&&e(c);else{var f=0,g=function(c,h){c?e&&e(c):h?e&&e():(f++,f<a?setTimeout(function(){d._isRunning(g)},b):e&&e(Error("z-way-server do not run after execute start command")))};setTimeout(function(){d._isRunning(g)},b)}})};d.prototype._stopAndCheck=
function(a,b,e){var d=this;this._stop(function(c){if(c)e&&e(c);else{var f=0,g=function(c,h){c?e&&e(c):h?(f++,f<a?setTimeout(function(){d._isRunning(g)},b):e&&e(Error("z-way-server still run after execute stop command"))):e&&e()};setTimeout(function(){d._isRunning(g)},b)}})};d.prototype._isRunning=function(a){this._logger.log("trace","check z-way-server pid");var b=require("child_process").exec;b=b("pidof z-way-server");var e=this,d=null;b.stdout.on("data",function(a){e._logger.log("trace","get z-way-server pid out:"+
String(a));d=String(a)});b.on("error",function(b){e._logger.log("trace","get z-way-server pid error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){e._logger.log("trace","get z-way-server pid finish: code="+b);0==b?a&&(a(null,d?!0:!1),a=null):1==b?a&&(a(null,!1),a=null):a&&(a(Error("get z-way-server pid failed, return code:"+b)),a=null)})};d.prototype._start=function(a){var b=d.SCRIPT+" start";this._logger.log("trace","start z-way-server with command:"+b);var e=require("child_process").exec;
b=e(b);var g=this;b.stdout.on("data",function(a){g._logger.log("trace","start z-way-server out:"+String(a))});b.on("error",function(b){g._logger.log("trace","start z-way-server error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){g._logger.log("trace","start z-way-server "+(0==b?"success":"failed"));0!=b?a&&(a(Error("start z-way-server failed, return code:"+b)),a=null):a&&(a(0==b?null:Error("start z-way-server failed")),a=null)})};d.prototype._stop=function(a){var b=d.SCRIPT+" stop";this._logger.log("trace",
"stop z-way-server with command:"+b);var e=require("child_process").exec;b=e(b);var g=this;b.stdout.on("data",function(a){g._logger.log("trace","stop z-way-server out:"+String(a))});b.on("error",function(b){g._logger.log("trace","stop z-way-server error:"+b.message);a&&(a(b),a=null)});b.on("close",function(b){g._logger.log("trace","stop z-way-server "+(0==b?"success":"failed"));a&&(a(0==b?null:Error("stop z-way-server failed")),a=null)})};d.prototype._reset=function(a,b){var e=this._getConfigFolder(),
d=this._getAutomationStorageFolder();a||this._logger.log("trace","clear z-way-server config folder:"+e);this._logger.log("trace","clear z-way-server automation storage folder:"+d);e="rm -f "+e+"/zddx/*.xml && rm -f "+d+"/*.json";a&&(e="rm -f "+d+"/*.json");a=require("child_process").exec;a=a(e);var c=this;a.stdout.on("data",function(a){c._logger.log("trace","reset z-way-server out:"+String(a))});a.on("error",function(a){c._logger.log("trace","reset z-way-server error:"+a.message);b&&(b(a),b=null)});
a.on("close",function(a){c._logger.log("trace","clear z-way-server config "+(0==a?"success":"failed"));b&&(b(0==a?null:Error("clear z-way-server config failed")),b=null)})};d.prototype._restore=function(a,b,e){this._logger.log("trace","retore zway data (restoreUZB="+b+") from:"+a+" to:"+d.FOLDER);var g=require("fs"),c=require("fs-extra");if(!b&&g.existsSync(a+"/zway/config")&&g.existsSync(d.FOLDER)){this._logger.log("trace","copy zway data from:"+a+"/zway/config to:"+this._getConfigFolder());try{c.copySync(a+
"/zway/config",this._getConfigFolder())}catch(f){}}if(g.existsSync(a+"/zway/automation/storage")&&g.existsSync(this._getAutomationFolder())){this._logger.log("trace","copy zway data from:"+a+"/zway/automation/storag to:"+this._getAutomationStorageFolder());try{c.copySync(a+"/zway/automation/storage",this._getAutomationStorageFolder())}catch(f){}}e&&e()};return d}();
x.hub.v6.Handler=function(){var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.v6.Handler");this._centralUnit=null;this._recovery=new x.hub.v6.Recovery;this._sysConf=new x.hub.v6.SystemConf;this._stm=new x.hub.v6.STM(this,global.STM?global.STM:null);this._led=new x.hub.v6.LED;this._resetPin=new x.hub.v6.ResetPin(this);this._network=new x.hub.v6.Network(this);this._time=new x.hub.v6.Time(this);this._location=new x.hub.v6.Location(this);this._zwayServer=new x.hub.v6.ZwayServer(this);
this._extraInfo=new x.hub.v6.ExtraInfo(this);this._hub=null};d.prototype.CentralUnit=x.hub.v6.CentralUnit;d.prototype.LED=x.hub.v6.LED;d.prototype.ResetPin=x.hub.v6.ResetPin;d.prototype.init=function(a,b){var e=this;this._hub=a;this._led.init();this._resetPin.init();this._recovery.init();this._sysConf.init(function(){e._network.init();e._time.init();b&&b()});this._stm.init();this._zwayServer.init()};d.prototype.setIPData=function(a,b){var e=this,d=function(a,b){if(a.MAC)if(12==a.MAC.length&&a.MAC.match(/^([a-fA-F0-9]{2}){6}/g)){e._logger.log("trace",
"set mac:"+a.MAC);var c=a.MAC.substr(0,2)+":"+a.MAC.substr(2,2)+":"+a.MAC.substr(4,2)+":"+a.MAC.substr(6,2)+":"+a.MAC.substr(8,2)+":"+a.MAC.substr(10,2),d=new Buffer(a.MAC,"hex");e._logger.log("trace","set mac "+a.MAC+" on stm");e._stm.sendCommand(57,d,function(d){d&&d.error?(e._logger.log("trace","set mac "+a.MAC+" on stm failed: "+d.error),b(err,!1)):(e._logger.log("trace","set mac "+a.MAC+" on file"),e._network.setMAC(c,function(a){b(a,a?!1:!0)}))})}else b(Error("invalid mac address"));else b(null,
!1)},c=function(a,b){if(1!=a.DHCP&&0!=a.DHCP)b(null,!1);else{var c={dhcp:!0};if(0==a.DHCP){if(!(a.IP&&a.SN&&a.GW&&a.DNS)){b(Error("invalid static ip settings"));return}c.dhcp=!1;c.ip=a.IP;c.subnet=a.SN;c.router=a.GW;c.dns=a.DNS.split(",")}e._logger.log("trace","set network eth0:"+JSON.stringify(c));e._network.setNetwork("eth0",c,function(a){b(a,a?!1:!0)})}},f=!1;this._logger.log("trace","set ip data:"+JSON.stringify(a));(function(a,b){a.NTP?(e._logger.log("trace","set ntp:"+a.NTP),a=a.NTP.split(","),
e._time.setNTPServers(a,function(a){b(a,!1)})):b(null,!1)})(a,function(g,l){g?(e._logger.log("trace","set ntp failed:"+g.stack),b&&b(g)):(f=f||l,d(a,function(d,g){d?(e._logger.log("trace","set mac failed:"+d.stack),b&&b(d)):(f=f||g,c(a,function(a,c){a?(e._logger.log("trace","set network failed:"+a.stack),b&&b(a)):(f=f||c,e._logger.log("trace","set ip data finish (reboot="+f+")"),b&&b(null,f))}))}))})};d.prototype.setTZData=function(a,b){a?this._time.setTimezoneEncoded(a,function(a){b&&b(a)}):b&&b(Error("invalid timezone"))};
d.prototype.getTZData=function(a){this._time.getTimezoneEncoded(a)};d.prototype.setLocation=function(a,b,e){this._location.setLocation(a,b,e)};d.prototype.getLocation=function(a){this._location.getLocation(a)};d.prototype.getTimezoneSync=function(){return this._time.getTimezoneSync()};d.prototype.setTime=function(a,b){this._time.setTime(a,b)};d.prototype.reboot=function(a,b,e){this._logger.log("trace","reboot");if("PI-CM3+"!=global.PLATFORM)e&&e();else{var d=this;require("async").series([function(b){"recovery"==
a?d._recovery.createEmptyFile(function(a){b(a)}):b()},function(a){b?setTimeout(function(){a()},b):a()},function(a){d._reboot(a)}],function(a){e&&e(a)})}};d.prototype._reboot=function(a){var b=require("child_process").exec;b=b("reboot");b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("system reboot failed")),a=null)})};d.prototype.poweroff=function(a,b){this._logger.log("trace","power off");if("PI-CM3+"!=global.PLATFORM)b&&b();else{var e=this;require("async").series([function(b){a?
setTimeout(function(){b()},a):b()},function(a){e._led.setColor(0,0,0,function(){a()})},function(a){e._poweroff(a)}],function(a){b&&b(a)})}};d.prototype._poweroff=function(a){var b=require("child_process").exec;b=b("poweroff");b.on("error",function(b){a&&(a(b),a=null)});b.on("close",function(b){a&&(a(0==b?null:Error("system poweroff failed")),a=null)})};d.prototype.reset=function(a,b){this._logger.log("trace","reset "+a);var e=this;switch(a){case "network":this._network.resetNetwork(function(a){b&&
b(a,a?!1:!0)});break;case "factory":this._logger.log("trace","reset stm");this._stm.reset(function(a){e._logger.log("trace","reset stm "+(a?"failed:"+a.message:"success"));a?b&&b(a,a?!1:!0):(e._logger.log("trace","reset z-way-server"),e._zwayServer.reset(function(a){e._logger.log("trace","reset z-way-server "+(a?"failed:"+a.message:"success"));a?b&&b(a,a?!1:!0):(e._logger.log("trace","reset network"),e._network.resetNetwork(function(a){e._logger.log("trace","reset network "+(a?"failed:"+a.message:
"success"));e._logger.log("trace","reset system.conf");e._sysConf.reset(function(a){e._logger.log("trace","reset system.conf "+(a?"failed:"+a.message:"success"));b&&b(a,a?!1:!0)})}))}))});break;default:b&&b(Error("unknonw reset type: "+a))}};d.prototype.updateSTM=function(a,b,e){var d=this,c=function(a,b,c){var e=function(a){a&&a.progress&&b.write(a.progress+".")};d._led.startFlashSTM(function(){d._stm.on("flash",e);d._stm.flashFirmware(a,function(a){d._stm.removeListener("flash",e);a?b.write(JSON.stringify({XC_ERR:{code:"000000",
msg:a.message}})):b.write(JSON.stringify({XC_SUC:{}}));b.end();d._led.stopFlashSTM(function(){c&&c(a)})})})};a?this._saveTempFile("stm.bin",a,function(a,d){a?e&&e(a):c(d,b,e)}):c(null,b,e)};d.prototype._saveTempFile=function(a,b,d){var e=require("fs"),c=require("os"),f=require("path");c=c.tmpdir();var h=f.join(c,a);e.existsSync(f)&&e.unlinkSync(f);var l=e.createWriteStream(h);b.pipe(l);l.on("finish",function(){l.close(function(){d&&d(null,h)})});l.on("error",function(a){e.unlink(h);d&&d(a)})};d.prototype.backup=
function(a,b,d){var e=this,c=function(a,b,c){var d=require("fs-extra"),f=require("path"),g=require("os").tmpdir(),h=require("archiver"),l=new Date,k=l.getFullYear()+"",n=l.getMonth()+1+"";1==n.length&&(n="0"+n);var m=l.getDate()+"";1==m.length&&(m="0"+m);var p=l.getHours()+"";1==p.length&&(p="0"+p);var q=l.getMinutes()+"";1==q.length&&(q="0"+q);l=l.getSeconds()+"";1==l.length&&(l="0"+l);var w="backup_"+(k+n+m+p+q+l)+".xbp",t=f.join(g,w);f=d.createWriteStream(t);h=h("zip");f.on("close",function(){if(b){var a=
require("crypto").createCipher("aes-256-cbc",b),e=d.createReadStream(t),f=d.createWriteStream(t+".enc");f.on("finish",function(){d.removeSync(t);c(null,t+".enc",w)});e.pipe(a).pipe(f)}else c(null,t,w)});f.on("error",function(a){e._logger.log("warn","write backup zip file failed:"+a.message);c(a)});h.on("error",function(a){e._logger.log("warn","zip backup data failed:"+a.message);c(a)});h.pipe(f);h.directory(a+"/","backup");h.finalize()},f=null,h=require("x.crypt.js");a.query.enc&&"0"!=a.query.enc&&
"false"!=a.query.enc&&(a.query.at?f=a.query.at:a.query.auth&&(f=h.MD5(unescape(encodeURI(a.query.auth+"_SALT!")))));this._logger.log("trace","generate backup"+(f?" (encrypted)":""));h=require("fs");var l=require("os").tmpdir(),k=require("path").join(l,"backup");if(h.existsSync(k))try{h.rmdirRecursiveSync(k)}catch(m){}try{this._logger.log("trace","create backup folder: "+k),h.mkdirSync(k)}catch(m){b.status(500).json({code:-1,message:'create backup folder "'+k+'" failed:'+m.message});this._logger.log("trace",
'create backup folder "'+k+'" failed:'+m.message);d&&d(Error('create backup folder "'+k+'" failed:'+m.message));return}this._logger.log("trace","assemble backup files");this._backup(k,a.query,function(a){a?(b.status(500).json({code:a.code?a.code:-2,message:"assemble backup files failed:"+a.message}),e._logger.log("warn","assemble backup files failed:"+a.message),d&&d(a)):(e._logger.log("trace","compress backup files"),c(k,f,function(a,c,f){a?(b.status(500).json({code:-3,message:"compress backup files failed:"+
a.message}),e._logger.log("warn","compress backup files failed:"+a.message),d&&d(a)):(e._logger.log("trace","return backup file:"+c),b.setHeader("Content-disposition","attachment; filename="+f),b.sendFile(c,null,function(a){require("fs-extra").removeSync(c);a?(e._logger.log("warn","return backup file failed:"+a.message),b.status(500).json({code:-4,message:"return backup file failed:"+a.message})):e._logger.log("trace","backup data finish");d&&d(a)}))}))})};d.prototype._backup=function(a,b,d){var e=
null;if(b)if("true"==b.backup_uzb||1==b.backup_uzb||"1"==b.backup_uzb)e=!0;else if("false"==b.backup_uzb||0==b.backup_uzb||"0"==b.backup_uzb)e=!1;var c=this;require("async").series([function(b){c._zwayServer?(c._logger.log("trace","backup zwave data"),c._zwayServer.backup(a,e,function(a){c._logger.log("trace","backup zwave data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup zwave data failed: "+a.message);d.code=a.code?a.code:-210}b(d)})):b()},function(b){c._stm?(c._logger.log("trace",
"backup stm data"),c._stm.backup(a,function(a){c._logger.log("trace","backup stm data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup stm data failed: "+a.message);d.code=a.code?a.code:-220}b(d)})):b()},function(b){c._network?(c._logger.log("trace","backup network config"),c._network.backup(a,function(a){c._logger.log("trace","backup network config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup network config failed: "+a.message);d.code=a.code?a.code:-230}b(d)})):
b()},function(b){c._sysConf?(c._logger.log("trace","backup system config"),c._sysConf.backup(a,function(a){c._logger.log("trace","backup system config "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup system config failed: "+a.message);d.code=a.code?a.code:-240}b(d)})):b()},function(b){var d=require("fs-extra"),e=require("path"),f=require("x.hub.fileman.js").fileManager.getUserRootDataPath();c._logger.log("trace","backup general data");d.copy(f,e.join(a,"data"),{dereference:!0},function(f){if(f){c._logger.log("trace",
"backup general data failed:"+f.message);var g=Error("backup system config failed: "+f.message);g.code=f.code?f.code:-250;b(g)}else f=e.join(a,"data","localstorage","x.hub.Server.lock"),d.existsSync(f)&&d.removeSync(f),d.exists(e.join(a,"data","localstorage","x.hub.Server.pin"),function(f){f&&d.removeSync(e.join(a,"data","localstorage","x.hub.Server.pin"));d.exists(e.join(a,"data","localstorage","x.hub.Server.pwd"),function(f){f?d.remove(e.join(a,"data","localstorage","x.hub.Server.pwd"),function(a){c._logger.log("trace",
"backup general data "+(a?" failed:"+a.message:" success"));if(a){var d=Error("backup general data failed: "+a.message);d.code=a.code?a.code:-250}b(d)}):(c._logger.log("trace","backup general data success"),b())})})})}],function(a){d&&d(a)})};d.prototype.restore=function(a,b,d){var e=function(a,b,c){var d=require("fs"),e=require("fs-extra"),f=require("os").tmpdir(),g=require("path"),k=g.join(f,"restore"),l=g.join(k,"backup");if(e.existsSync(k))try{e.removeSync(k)}catch(y){c(y);return}var m=require("adm-zip"),
r=null;try{(new m(a)).extractAllTo(k,!0)}catch(y){h._logger.log("warn","backup file may be encrypted"),r="invalid backup file/password"}r?b?(h._logger.log("trace","decrpyt backup file"),b=require("crypto").createDecipher("aes-256-cbc",b),f=d.createReadStream(a),d=d.createWriteStream(a+".dec.zip"),b.on("error",function(){e.removeSync(a);e.removeSync(a+".dec.zip");c(Error(r))}),d.on("finish",function(){r=null;try{(new m(a+".dec.zip")).extractAllTo(k,!0)}catch(y){r="invalid backup file/password"}e.removeSync(a);
e.removeSync(a+".dec.zip");c(r?Error(r):null,l)}),f.pipe(b).pipe(d)):(e.removeSync(a),c(Error(r)),c=null):(e.removeSync(a),c(null,l),c=null)},c=require("x.crypt.js"),f=null;a.query.key?f=a.query.key:a.query.at?f=a.query.at:a.query.auth&&(f=c.MD5(unescape(encodeURI(a.query.auth+"_SALT!"))));var h=this;this._logger.log("trace","restore backup");(function(a,b){var c=require("fs"),d=require("os").tmpdir(),e=require("path").join(d,"restore.zip");if(c.existsSync(e))try{c.unlinkSync(e)}catch(u){b(u);return}var f=
c.createWriteStream(e);a.pipe(f);f.on("finish",function(){f.close(function(){b(null,e)})});f.on("error",function(a){c.unlink(e);b(a)})})(a,function(c,g){c?(h._logger.log("warn","download backup file failed: "+c.message),b.json({XC_ERR:{code:-1,msg:"donwload backup file failed:"+c.message}}),d&&d(c)):(h._logger.log("trace","extract backup data from: "+g),e(g,f,function(c,e){c?(h._logger.log("warn","extract backup data failed: "+c.message),b.json({XC_ERR:{code:-2,msg:"extract backup data failed:"+c.message}}),
d&&d(c)):(h._logger.log("trace","restore data from: "+e),h._restore(e,a.query,function(a){try{var c=require("fs-extra");c.removeSync(g);c.removeSync(e)}catch(u){}a?(h._logger.log("warn","restore data failed: "+a.message),b.json({XC_ERR:{code:a.code?a.code:-3,msg:"restore backup data failed:"+a.message}})):(h._logger.log("trace","restore data finish"),b.json({XC_SUC:{}}),h.reboot(null,1E3));d&&d(a)}))}))})};d.prototype._restore=function(a,b,d){var e=null;if(b)if("true"==b.restore_uzb||1==b.restore_uzb||
"1"==b.restore_uzb)e=!0;else if("false"==b.restore_uzb||0==b.restore_uzb||"0"==b.restore_uzb)e=!1;var c=!1,f=require("fs"),h=require("fs-extra"),l=require("path");f.existsSync(a+"/config/system.conf")||(c=!0);var k=this;require("async").series([function(b){k._zwayServer?(k._logger.log("trace","restore zwave data"),k._zwayServer.restore(a,{restoreUZB:e,backupType:c?"v5+":"v6+"},function(a){k._logger.log("trace","restore zwave data"+(a?" failed:"+a.message:" success"));if(a){var c=Error("restore zwave data failed: "+
a.message);c.code=a.code?a.code:-310}b(c)})):b()},function(b){k._stm?(k._logger.log("trace","restore stm data"),k._stm.restore(a,function(a){k._logger.log("trace","restore stm data"+(a?" failed:"+a.message:" success"));if(a){var c=Error("restore stm data failed: "+a.message);c.code=a.code?a.code:-320}b(c)})):b()},function(b){k._logger.log("trace","restore location");k._location.restore(a,{backupType:c?"v5+":"v6+"},function(a){k._logger.log("trace","restore location "+(a?" failed:"+a.message:" success"));
if(a){var c=Error("restore location failed: "+a.message);c.code=a.code?a.code:-360}b(c)})},function(b){k._logger.log("trace","restore timezone");k._time.restore(a,{backupType:c?"v5+":"v6+"},function(a){k._logger.log("trace","restore timezone"+(a?" failed:"+a.message:" success"));if(a){var c=Error("restore timezone failed: "+a.message);c.code=a.code?a.code:-370}b(c)})},function(b){if(c){k._logger.log("trace","remove v5+ cloud connection settings");var d=l.join(a,"data","localstorage","x.hub.v5.cloudKey"),
e=l.join(a,"data","localstorage","x.hub.v5.cloudServer"),g=l.join(a,"data","localstorage","x.hub.v5.cloudPort");try{f.existsSync(d)&&(k._logger.log("trace","remove v5+ cloud key file: "+d),f.unlinkSync(d)),f.existsSync(e)&&(k._logger.log("trace","remove v5+ cloud server file: "+e),f.unlinkSync(e)),f.existsSync(g)&&(k._logger.log("trace","remove v5+ cloud port file: "+g),f.unlinkSync(g))}catch(u){}}b()},function(b){if(k._network)if(c){var d=l.join(a,"data","localstorage","x.hub.v5.config");try{f.existsSync(d)&&
(k._logger.log("trace","remove v5+ config file: "+d),f.unlinkSync(d))}catch(p){}b()}else k._logger.log("trace","restore network config"),k._network.restore(a,function(a){k._logger.log("trace","restore network config"+(a?" failed:"+a.message:" success"));if(a){var c=Error("restore network config failed: "+a.message);c.code=a.code?a.code:-340}b(c)});else b()},function(b){var c=function(a,b,c){k._logger.log("trace","move "+a+" to "+b);h.exists(a,function(d){d?h.rename(a,b,function(d){d&&k._logger.log("trace",
"move "+a+" to "+b+" failed:"+d.message);c(d)}):(k._logger.log("trace",a+" not exist"),c())})},d=function(a,b,d){k._logger.log("trace","restore current lock,pin,pwd");var e=l.join(a,"localstorage","x.hub.Server.lock"),f=l.join(b,"x.hub.Server.lock"),g=l.join(a,"localstorage","x.hub.Server.pin"),h=l.join(b,"x.hub.Server.pin"),m=l.join(a,"localstorage","x.hub.Server.pwd"),n=l.join(b,"x.hub.Server.pwd");c(f,e,function(){c(h,g,function(){c(n,m,function(){d()})})})},e=function(a,b){k._logger.log("trace",
"clear "+a);h.emptyDir(a,function(c){c&&k._logger.log("trace","clear "+a+" failed:"+c.message);b(c)})};k._logger.log("trace","restore standard data");var f=require("x.hub.fileman.js").fileManager,g=f.getUserRootDataPath(),m=f.getTmpDir();(function(a,b,d){k._logger.log("trace","backup current lock,pin,pwd");var e=l.join(a,"localstorage","x.hub.Server.lock"),f=l.join(b,"x.hub.Server.lock"),g=l.join(a,"localstorage","x.hub.Server.pin"),h=l.join(b,"x.hub.Server.pin"),m=l.join(a,"localstorage","x.hub.Server.pwd"),
n=l.join(b,"x.hub.Server.pwd");c(e,f,function(){c(g,h,function(){c(m,n,function(){d()})})})})(g,m,function(){e(g,function(){h.copy(l.join(a,"data"),g,function(a){k._logger.log("trace","restore standard data"+(a?" failed:"+a.message:" success"));if(a){var c=Error("restore standard data failed: "+a.message);c.code=a.code?a.code:-330}d(g,m,function(){b(c)})})})})},function(b){k._sysConf?(k._logger.log("trace","restore system config"),k._sysConf.restore(a,function(a){k._logger.log("trace","restore system config"+
(a?" failed:"+a.message:" success"));if(a){var c=Error("restore system config failed: "+a.message);c.code=a.code?a.code:-350}b(c)})):b()}],function(a){d&&d(a)})};d.prototype.updateFirmware=function(a,b){var d=this,g=function(a,b){d._recovery.setFirmwareUpdateUrl(a,function(a){b(a)})};this._logger.log("trace","update firmware with url:"+a);(function(a,b){if(a){a=require("url").parse(a);var c=80;if(a.port){c=parseInt(a.port);if(0===c||isNaN(c))c=80;if(!(0<c&&65536>c)){b(Error("invalid port"));return}}"https:"==
a.protocol&&80==c&&(c=443);c={host:a.hostname,port:c,path:a.path,method:"HEAD"};a=require("https:"==a.protocol?"https":"http").request(c,function(a){b&&(200==a.statusCode?b():b(Error("http response code:"+a.statusCode)),b=null)});a.setTimeout(5E3,function(){b&&(b(Error("http timeout")),b=null)});a.on("error",function(a){b&&(b(a),b=null)});a.end()}else b(Error("invalid firmware url"))})(a,function(c){d._logger.log("trace","check online firmware"+(c?" failed:"+c.message:" success"));c?b&&b(Error("check online firmware failed:"+
c.message)):(d._logger.log("trace","set reboot to recovery mode"),g(a,function(a){d._logger.log("trace","save firmware url"+(a?" failed:"+a.message:" success"));b&&b(a?Error("save firmware url failed:"+a.message):null,a?!1:!0)}))})};d.prototype.getExtraInfo=function(a){this._extraInfo.getInfo(a)};return d}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v6.Handler);
