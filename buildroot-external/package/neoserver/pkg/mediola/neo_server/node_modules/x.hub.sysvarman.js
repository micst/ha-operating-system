var x=x||{};x.hub=x.hub||{};x.hub.sysvarman=x.hub.sysvarman||{};
x.hub.sysvarman.SysvarManager=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager");this._sysvarFile=null;this._sysvars={};this._writing=!1;this._writeQueue=0};c.FILE_NAME="sysvar.json";c.prototype.init=function(a,b){this._logger.log("info","init sysvar mananger");var d=require("fs-extra"),f=require("path");this._sysvarFile||(this._sysvarFile=f.resolve(a.getUserRootDataPath(),c.FILE_NAME));var e=this;d.ensureFile(this._sysvarFile,function(a){a?
b&&b(a):e._readData(function(a,d){!a&&d&&(e._sysvars=d);b&&b(a)})})};c.prototype.setVar=function(a,b){this._logger.log("trace","setVar:"+(a?JSON.stringify(a):null));if(a&&a.id&&a.type){var d=parseInt(a.id,16);if(0>=d)b&&b(Error("sysvar out of range"));else{d=d.toString(16).toUpperCase();2>d.length&&(d="0"+d);a={id:d,type:a.type,value:a.value};d=this._sysvars[a.id];switch(a.type){case "ONOFF":a.value||(a.value="OFF");a.value=a.value.toUpperCase();if("ON"!=a.value&&"OFF"!=a.value&&"TOGGLE"!=a.value){b&&
b(Error("ONOFF sysvar value invalid"));return}if("TOGGLE"==a.value)if(d){if(d.type!=a.type){b&&b(Error("sysvar is not a ONOFF type"));return}a.value="ON"==d.value?"OFF":"ON"}else a.value="OFF";break;case "FLOAT":case "INT":a.value||(a.value="00000000");var c=parseInt(a.value,16);if(isNaN(c)){b&&b(Error("FLOAT/INT sysvar value invalid"));return}break;case "STRING":a.value||(a.value=""),a.value=decodeURIComponent(a.value+"")}a.time=(new Date).getTime();this._sysvars[a.id]=a;c=require("x.hub.eventbus.js");
d&&d.value==a.value||c.emit("gatewayevent",this.getSysvarStateLegacy(a.id),{address:"Sysvar"},"STA");c.emit("udpevent",this.getSysvarStateLegacy(a.id),"STA");this._postWrite(function(a){b&&b(a)})}}else b&&b(Error("sysvar format invalid"))};c.prototype.delVar=function(a,b){a&&this._sysvars[a]?(delete this._sysvars[a],this._postWrite(function(a){b&&b(a)})):b&&b()};c.prototype.getVar=function(a){return a?this._sysvars[a]:null};c.prototype.getSysvars=function(){return this._sysvars};c.prototype.getSysvarStateLegacy=
function(a){if(!a||!this._sysvars[a])return null;a=this._sysvars[a];return{type:a.type,adr:a.id,state:a.value}};c.prototype.getSysvarStatesLegacy=function(){var a=[],b;for(b in this._sysvars)if(this._sysvars.hasOwnProperty(b)){var d=this.getSysvarStateLegacy(b);d&&a.push(d)}return a};c.prototype._readData=function(a){require("fs").readFile(this._sysvarFile,"utf8",function(b,d){if(b)a&&a(b);else if(d)try{var c=JSON.parse(d);a&&a(null,c?c:{})}catch(e){a&&a(e)}else a&&a(null,{})})};c.prototype._postWrite=
function(a){this._writeQueue++;this._writing||this._doWrite();a&&a()};c.prototype._doWrite=function(){if(0<this._writeQueue){var a=this;this._writeQueue=0;this._writing=!0;this._writeData(function(b){b&&a._logger.log("warn","write file failed:"+b.message);a._writing=!1;a._doWrite()})}};c.prototype._writeData=function(a){require("fs").writeFile(this._sysvarFile,JSON.stringify(this._sysvars,null,2),function(b){a&&a(b)})};return c}();
x.hub.sysvarman.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler");this.sysvarManager=new x.hub.sysvarman.SysvarManager};c.prototype.SysvarManager=x.hub.sysvarman.SysvarManager;c.prototype.init=function(a,b,d){this.sysvarManager.init(b,function(a){d&&d({error:a})})};c.prototype.setVar=function(a,b){this.sysvarManager.setVar(a,function(a){b&&b({error:a})})};c.prototype.delVar=function(a,b){this.sysvarManager.delVar(a,function(a){b&&b({error:a})})};
c.prototype.getSysvarStates=function(a){var b=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(b));a&&a({data:b})};return c}();module.exports=new x.hub.sysvarman.Handler;
