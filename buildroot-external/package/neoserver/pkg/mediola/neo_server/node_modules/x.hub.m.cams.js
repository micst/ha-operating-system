var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.m=x.hub.m||{};x.hub.m.cams=x.hub.m.cams||{};x.hub.m.cams.CAMS_MODULE=require("xnm.aio.cams.js");
x.hub.m.cams.DoorBirdMonitor=function(){var c=function(a,b){this._id=this._gentId(a);this._logger=require("x.logger.js").getLogger("x.hub.m.cams.DoorBirdMonitor.["+this._id+"]");this._handler=b;this._doorbird=a;this._metaInfos=[];this._running=!1;this._monitor=null;this._stateBuffer={}};c.prototype._gentId=function(a){return a.username+"@"+a.ip};c.prototype.start=function(){this._logger.log("debug","start monitor");if(!this._running){this._running=!0;var a=this._handler.getDoorBirdHandler().addMonitor(this._doorbird);
a.addListener(this);this._monitor=a}};c.prototype.stop=function(a){this._logger.log("debug","stop monitor");this._running?0<this._metaInfos.length?a&&a(null,!1):(this._running=!1,this._monitor.removeListener(this),this._handler.getDoorBirdHandler().removeMonitor(this._doorbird),a&&a(null,!0)):a&&a(null,!0)};c.prototype.addMetaInfo=function(a){for(var b=0;b<this._metaInfos.length;b++){var d=this._metaInfos[b];if(d&&d.callback&&d.callback===a.callback)return}this._metaInfos.push(a)};c.prototype.removeMetaInfo=
function(a){for(var b=-1,d=0;d<this._metaInfos.length;d++){var e=this._metaInfos[d];if(e&&e.callback&&e.callback===a.callback){b=d;break}}-1!=b&&this._metaInfos.splice(b,1)};c.prototype.updateDoorbird=function(a){if(this._doorbirdJSON&&this._doorbirdJSON.mac&&this._doorbirdJSON.mac==a.mac&&this._doorbirdJSON.ip!=a.ip){this._logger.log("debug","doorbird has new ip:"+a.ip);this._doorbirdJSON.ip=a.ip;var b=this._gentId(this._doorbirdJSON.ip);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Monitor.["+
b+"]");this._monitor&&this._monitor.updateDoorbird(a)}};c.prototype.onEvent=function(a,b){var d=(new Date).getTime(),e=this._stateBuffer[a],c=!1,g=null;e?(g=e[0],e=e[1],b!=g?c=!0:1==b&&3E3<d-e&&(c=!0)):c=!0;this._stateBuffer[a]=[b,d];this._logger.log("debug","event:"+a+"="+b+"("+(c?"changed":"not changed")+")");c&&this._invokeCallback({module:"cams",device:this._doorbird,data:{key:a,value:b,oldvalue:g,changed:!0}})};c.prototype._invokeCallback=function(a){for(var b=a.data.key,d=0;d<this._metaInfos.length;d++){var e=
this._metaInfos[d];if(e&&e.statusKey==b&&e.callback&&e.callback.onEvent)try{e.callback.onEvent(a)}catch(f){}}};return c}();
x.hub.m.cams.Handler=function(){var c=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.cams.Handler");this._doorBirdMonitors={};this._doorBirdHandler=x.hub.m.cams.CAMS_MODULE.getDoorBirdHandler();this._searchTo=null;this._searchPeriod=3E5};util.inherits(c,EventEmitter);c.prototype.init=function(a){this._startPeriodicalSearch();this._doorBirdHandler.startUdpMonitor();a&&a()};c.prototype.getSystems=function(){return["cam"]};c.prototype.addStateDevice=function(a,b,d){!a||"system"!=a.type||
"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._startDoorBirdMonitor(a,function(a){b&&b({error:a})},d)};c.prototype.removeStateDevice=function(a,b,d){!a||"system"!=a.type||"doorbird"!=a.manufacturer&&"doorbird"!=a.type||"doorbird"!=a.model?b&&b({error:Error("device json format invalid")}):this._stopDoorBirdMonitor(a,function(a){b&&b({error:a})},d)};c.prototype.getAllStates=function(){return[]};c.prototype.getStates=function(a){return null};
c.prototype.getState=function(a,b,d){require("x.hub.commandman.js").commandHandler.getStateLegacy(a,null,{value:b},d)};c.prototype.executeCommand=function(a,b,d){require("x.hub.commandman.js").commandHandler.executeCommandLegacy(a,null,b,d)};c.prototype.checkDeviceMatch=function(a,b){return b&&b.device&&a&&a.device&&b.device.manufacturer==a.device.manufacturer&&b.device.model==a.device.model?b.device.ip==a.device.ip:!1};c.prototype.getDoorBirdHandler=function(){return this._doorBirdHandler};c.prototype._startDoorBirdMonitor=
function(a,b,d){if(a&&a.ip&&a.username){var c=a.username;this._doorBirdMonitors[c]?(d&&d.callback&&this._doorBirdMonitors[c].addMetaInfo(d),b&&b(null,this._doorBirdMonitors[c])):x.hub.m.cams.CAMS_MODULE.resolveDevice(a)?(a=JSON.parse(JSON.stringify(a)),a=new x.hub.m.cams.DoorBirdMonitor(a,this),this._doorBirdMonitors[c]=a,d&&d.callback&&a.addMetaInfo(d),a.start(),b&&b(null,a)):b&&b(Error("doorbird json format invalid"))}else b&&b(Error("doorbird json format invalid"))};c.prototype._stopDoorBirdMonitor=
function(a,b,d){if(a&&a.ip&&a.username){var c=this,f=a.username;(a=this._doorBirdMonitors[f])?(d&&d.callback&&a.removeMetaInfo(d),a.stop(function(a,d){!a&&d&&delete c._doorBirdMonitors[f];b&&b(a,d)})):b&&b()}else b&&b(Error("doorbird json format invalid"))};c.prototype._startPeriodicalSearch=function(){var a=this,b=function(b){for(var d=0;d<b.length;d++){var c=b[d];if(c._options){a._logger.log("trace","find doorbird:"+JSON.stringify(c._options));for(var e in a._doorBirdMonitors)a._doorBirdMonitors[e].updateDoorbird(c._options)}}},
d=function(){a._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5E3,function(a,c){!a&&c&&b(c);d()})},a._searchPeriod)};this._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5E3,function(a,c){!a&&c&&b(c);d()})},1E4)};return c}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.cams.Handler);
