var x=x||{};x.mdns=x.mdns||{};
x.mdns.DNS_SD=function(){var p=function(){this.data=this.length=this.ttl=this.class=this.type=this.name=null};p.prototype.resolveData=function(a){this.data=a};p.prototype.toJSON=function(){return this};var r=function(){this._info={}};r.prototype.resolveData=function(a,c,g,f){for(c=0;c<a.length-1;){g=2*parseInt(a.substr(c,2),16);var b;if(b=c+2+g>a.length?a.substr(c+2,a.length-c-2):a.substr(c+2,g)){b=e._hex2a(b);var d=b.indexOf("=");-1!=d&&d!=b.length-1&&(f=b.substr(0,d),b=b.substr(d+1),this._info[f]=
b)}c+=2+g}};r.prototype.toJSON=function(){};var m=function(){};m.prototype.resolveData=function(a,c,g,f){this.domain=e._parseName(c,g,f).name};m.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};m.prototype.getDomainTxt=function(){return this.domain?e._hex2name(this.domain):null};m.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,domain:this.getDomainTxt()}};var d=function(){};d.prototype.resolveData=
function(a,c,g,f){this.priority=parseInt(a.substr(0,4),16);this.weight=parseInt(a.substr(4,4),16);this.port=parseInt(a.substr(8,4),16);this.target=e._parseName(c+12,g,f).name};d.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};d.prototype.getTargetTxt=function(){return this.target?e._hex2name(this.target):null};d.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,
port:this.port,target:this.getTargetTxt()}};var h=function(){};h.prototype.resolveData=function(a){this.addr=a};h.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};h.prototype.getAddrTxt=function(){return h._hex2ipv4(this.addr)};h.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};h._hex2ipv4=function(a){if(!a||8>a.length)return null;var c=parseInt(a.substr(0,2),16)+".";c+=parseInt(a.substr(2,
2),16)+".";c+=parseInt(a.substr(4,2),16)+".";return c+=parseInt(a.substr(6,2),16)};var b=function(){};b.prototype.resolveData=function(a){this.addr=a};b.prototype.getNameTxt=function(){return this.name?e._hex2name(this.name):null};b.prototype.getAddrTxt=function(){if(!this.addr||32>this.addr.length)return null;var a=this.addr.substr(0,4)+":";a+=this.addr.substr(4,4)+":";a+=this.addr.substr(8,4)+":";a+=this.addr.substr(12,4)+":";a+=this.addr.substr(16,4)+":";a+=this.addr.substr(20,4)+":";a+=this.addr.substr(24,
4)+":";return a+=this.addr.substr(28,4)};b.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,class:this.class,ttl:this.ttl,length:this.length,addr:this.getAddrTxt()}};var l=function(a,c){this.name=a;this.type=c};l.prototype._name2Array=function(){if(!this.name)return null;for(var a=[],c=0;c<this.name.length-1;c+=2){var g=this.name.substr(c,2);a.push(parseInt(g,16))}return a};l.prototype.toArray=function(){var a=[];a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(1);
a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);a.push(0);var c=this._name2Array(this.name);if(!c)return null;for(var g=0;g<c.length;g++)a.push(c[g]);a.push(0);switch(this.type){case 12:a.push(0);a.push(12);break;case 33:a.push(0);a.push(33);break;case 1:a.push(0);a.push(1);break;default:return null}a.push(0);a.push(1);return a};var e=function(){this.arCount=this.nsCount=this.anCount=this.qdCount=this.flag=this.id=0;this.querys=[];this.answers=[];this.authorities=[];this.additionals=[]};e.prototype.isResponse=
function(){return 1==this.flag>>15};e.prototype.toJSON=function(){var a={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]},c;for(c=0;c<this.querys.length;c++)a.querys.push(this.querys[c].toJSON());for(c=0;c<this.answers.length;c++)a.answers.push(this.answers[c].toJSON());for(c=0;c<this.additionals.length;c++)a.additionals.push(this.additionals[c].toJSON());return a};e.parse=function(a){var c=
new e;4<a.length&&(c.id=parseInt(a.substr(0,4),16));8<a.length&&(c.flag=parseInt(a.substr(4,4),16));12<a.length&&(c.qdCount=parseInt(a.substr(8,4),16));16<a.length&&(c.anCount=parseInt(a.substr(12,4),16));20<a.length&&(c.nsCount=parseInt(a.substr(16,4),16));24<a.length&&(c.arCount=parseInt(a.substr(20,4),16));var g=24,f;if(0<c.qdCount)for(f=0;f<c.qdCount;f++){var b=e._parseQuery(g,a);g=b.queryEnd;c.querys.push(b.query)}if(0<c.anCount)for(f=0;f<c.anCount;f++)b=e._parseAnswer(g,a),g=b.answerEnd,c.answers.push(b.answer);
if(0<c.nsCount)for(f=0;f<c.arCount;f++)b=e._parseAuthority(g,a),g=b.nsEnd,c.authorities.push(b.ns);if(0<c.arCount)for(f=0;f<c.arCount;f++)b=e._parseAdditional(g,a),g=b.addiEnd,c.additionals.push(b.addi);return c};e._parseName=function(a,c,g,f){f=f?f+1:1;if(10<f)return{index:a,name:""};for(var b=a,d=!1,h;g.length>b+2&&"00"!=g.substr(b,2)&&!(c&&b-a>=2*c);)if(1==parseInt(g.substr(b,2),16)>>7){h=parseInt(g.substr(b,4),16)&16383;h=e._parseName(2*h,null,g,f).name;d=!0;b+=4;break}else{var l=parseInt(g.substr(b,
2),16);b+=2+2*l}d?(a=g.substr(a,b-a-4),a+=h):(a=g.substr(a,b-a),b+=2);return{index:b,name:a}};e._name2hex=function(a){var c="";a=a.split(".");for(var g=0;g<a.length;g++){for(var b=a[g].length.toString(16);2>b.length;)b="0"+b;c+=b;for(b=0;b<a[g].length;b++){for(var e=a[g].charCodeAt(b).toString(16);2>e.length;)e="0"+e;c+=e}}return c};e._hex2name=function(a){for(var c="",b=0;b<a.length;){var f=parseInt(a.substr(b,2),16),d=a.substr(b+2,2*f);d=e._hex2a(d);c&&(c+=".");c+=d;b+=2+2*f}return c};e._hex2a=
function(a){a=a.toString();for(var c="",b=0;b<a.length;b+=2)c+=String.fromCharCode(parseInt(a.substr(b,2),16));return c};e._parseRR=function(a,c){var g=e._parseName(a,null,c);var f=a=g.index;g=g.name;if(c.length>a+4){f=a+4;var l=parseInt(c.substr(a,4),16)}if(c.length>a+4+4){f=a+8;var n=parseInt(c.substr(a+4,4),16)}if(c.length>a+8+8){f=a+16;var z=parseInt(c.substr(a+8,8),16)}if(c.length>a+16+4){f=a+20;var q=parseInt(c.substr(a+16,4),16)}if(0<q&&c.length>=a+20+2*q){f=a+20+2*q;var w=c.substr(a+20,2*
q)}switch(l){case 12:var k=new m;break;case 16:k=new r;break;case 33:k=new d;break;case 1:k=new h;break;case 28:k=new b;break;default:k=new p}k&&(k.name=g,k.type=l,k.class=n,k.ttl=z,k.length=q,(k.dataRaw=w)&&k.resolveData(w,a+20,q,c));return{end:f,rr:k}};e._parseQuery=function(a,c){var b=new l;a=e._parseName(a,null,c);var f=a.index;b.name=a.name;c.length>f+4&&(b.type=parseInt(c.substr(f,4),16));c.length>=f+4+4&&(b.class=parseInt(c.substr(f+4,4),16));return{queryEnd:f+8,query:b}};e._parseAnswer=function(a,
c){a=e._parseRR(a,c);return{answerEnd:a.end,answer:a.rr}};e._parseAuthority=function(a,c){a=e._parseRR(a,c);return{nsEnd:a.end,ns:a.rr}};e._parseAdditional=function(a,c){a=e._parseRR(a,c);return{addiEnd:a.end,addi:a.rr}};var n=function(){this._sockets=[];this._searchCallbacks={};this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};n.prototype.startListener=function(a){function c(a,c,g){var f=this,e=g;g=require("dgram");try{var d=g.createSocket({type:"udp4",reuseAddr:!0})}catch(v){d=
g.createSocket("udp4")}d.on("message",function(a,c){f._onReceiveDNSPacket(a,c)});d.on("listening",function(){try{d.setBroadcast(!0),d.addMembership("224.0.0.251"),e&&(e(null,d),e=null)}catch(v){b&&console.error("Caught error:",v),b&&console.error("Address causing the error: "+c,a),e&&(e(v),e=null)}});d.on("error",function(a){b&&console.error("Socket on error:",a);e&&(e(a),e=null)});d.bind(a,c)}var b="undefined"!==typeof console&&"function"===typeof console.error,f=function(a,c){var g=this,e=c;c=require("dgram");
try{var f=c.createSocket({type:"udp4",reuseAddr:!0})}catch(A){f=c.createSocket("udp4")}f.on("message",function(a,c){g._onReceiveDNSPacket(a,c)});f.on("listening",function(){var c=null;try{f.setBroadcast(!0);for(var g=0;g<a.length;g++)c=a[g],f.addMembership("224.0.0.251",c);e&&(e(null,f),e=null)}catch(y){b&&console.error("Caught error:",y),b&&console.error("Address causing the error: "+c,"| All: "+a.join(", ")),e&&(e(y),e=null)}});f.on("error",function(a){b&&console.error("Socket on error:",a);e&&
(e(a),e=null)});f.bind(5353)},e=this,d=require("os");if(d&&d.networkInterfaces){d=d.networkInterfaces();var h=[],l;for(l in d)if(d.hasOwnProperty(l))for(var n=d[l],k=0;k<n.length;k++)"IPv4"==n[k].family&&0==n[k].internal&&h.push(n[k].address);f.call(this,h,function(b,g){if(b)a&&a(b);else{g&&e._sockets.push(g);var f=0;for(b=0;b<h.length;b++)c.call(e,5353,h[b],function(c,b){f++;!c&&b&&(b._isSendSocket=!0,e._sockets.push(b));f==h.length&&a&&a()})}})}else c.call(this,5353,null,function(c,b){c?a&&a(c):
(b&&(b._isSendSocket=!0,e._sockets.push(b)),a&&a())})};n.prototype.stopListener=function(a){if(this._sockets)for(var c=0;c<this._sockets.length;c++){var b=this._sockets[c];b&&b.close()}a&&a()};n.prototype.removeDiscoverServiceCallback=function(a,c){if(a&&c&&(a=this._searchCallbacks[a])){for(var b=-1,f=0;f<a.length;f++)if(a[f]===c){b=f;break}-1!=b&&a.splice(b,1)}};n.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}}};n.prototype.discoverService=
function(a,c){if(a){var b=this._searchCallbacks[a];b||(this._searchCallbacks[a]=[],b=this._searchCallbacks[a]);c&&-1==b.indexOf(c)&&b.push(c);c._targets=[];c._domains=[];a=e._name2hex(a);(a=(new l(a,12)).toArray())&&this._sendQuery(new Buffer(a))}else c&&c(Error("serviceType is empty"))};n.prototype._sendQuery=function(a){for(var c=0;c<this._sockets.length;c++){var b=this._sockets[c];b._isSendSocket&&b.send(a,0,a.length,5353,"224.0.0.251")}};n.prototype._searchRecords=function(){var a;for(a in this._searchCallbacks)if(this._searchCallbacks.hasOwnProperty(a)){var c=
e._name2hex(a);if(this._rrBuffer._ptrRecords[c])for(var b=0;b<this._rrBuffer._ptrRecords[c].length;b++){var f=this._rrBuffer._ptrRecords[c][b],d=this._rrBuffer._txtRecords[f];if(this._rrBuffer._srvRecords[f])for(var n=0;n<this._rrBuffer._srvRecords[f].length;n++){var m=this._rrBuffer._srvRecords[f][n];if(!this._rrBuffer._aRecords[m]){var q=new l(m,1);(q=q.toArray())&&this._sendQuery(new Buffer(q))}else if(0<this._rrBuffer._aRecords[m].length){q=[];for(var p=0;p<this._rrBuffer._aRecords[m].length;p++){var k=
h._hex2ipv4(this._rrBuffer._aRecords[m][p]);k&&q.push(k)}if(0<q.length&&(p=this._searchCallbacks[a])){m=e._hex2name(m);k=e._hex2name(f);for(var r=0;r<p.length;r++){var t=p[r];if(t){var u=t._domains;u||(t._domains=[],u=t._domains);-1==u.indexOf(k)&&(t._domains.push(k),t(null,{target:m,domain:k,ip:q,info:d}))}}}}}else q=new l(f,33),(q=q.toArray())&&this._sendQuery(new Buffer(q))}}};n.prototype._handleRR=function(a){switch(a.type){case 12:var c=a.name;var b=a.domain;var f=this._rrBuffer._ptrRecords[c];
f||(this._rrBuffer._ptrRecords[c]=[],f=this._rrBuffer._ptrRecords[c]);c=!1;for(a=0;a<f.length;a++)if(f[a]==b){c=!0;break}c||f.push(b);break;case 16:c=a.name;this._rrBuffer._txtRecords[c]=a._info;break;case 33:c=a.name;b=a.target;f=this._rrBuffer._srvRecords[c];f||(this._rrBuffer._srvRecords[c]=[],f=this._rrBuffer._srvRecords[c]);c=!1;for(a=0;a<f.length;a++)if(f[a]==b){c=!0;break}c||f.push(b);break;case 1:c=a.name;b=a.addr;f=this._rrBuffer._aRecords[c];f||(this._rrBuffer._aRecords[c]=[],f=this._rrBuffer._aRecords[c]);
c=!1;for(a=0;a<f.length;a++)if(f[a]==b){c=!0;break}c||f.push(b);break;case 28:c=a.name;b=a.addr;f=this._rrBuffer._aaaaRecords[c];f||(this._rrBuffer._aaaaRecords[c]=[],f=this._rrBuffer._aaaaRecords[c]);c=!1;for(a=0;a<f.length;a++)if(f[a]==b){c=!0;break}c||f.push(b)}};n.prototype._onReceiveDNSPacket=function(a,c){a=a.toString("hex");if((a=e.parse(a))&&a.isResponse()){var b;if(a.answers)for(c=0;c<a.answers.length;c++)(b=a.answers[c])&&this._handleRR(b);if(a.authorities)for(c=0;c<a.authorities.length;c++)(b=
a.authorities[c])&&this._handleRR(b);if(a.additionals)for(c=0;c<a.additionals.length;c++)(b=a.additionals[c])&&this._handleRR(b);this._searchRecords()}};return n}();
x.mdns.Handler=function(){var p=function(){this._mDns=null};p.prototype.start=function(d){if(this._mDns)d&&d();else{var h=this,b=new x.mdns.DNS_SD;b.startListener(function(l){l||(h._mDns=b);d&&d(l)})}};p.prototype.stop=function(d){if(this._mDns){var h=this;this._mDns.stopListener(function(){h._mDns=null;d&&d()})}else d&&d(Error("mDns not started"))};p.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer()};p.prototype.discoverServiceWithTimeout=function(d,h,b){var l=this,
e=[];this.discoverService(d,function(b,a){!b&&a&&e.push(a)});setTimeout(function(){l._mDns&&l._mDns.removeDiscoverServiceCallback(d,b);b&&b(null,e)},h)};p.prototype.discoverService=function(d,h){if(d){-1==d.indexOf(".local")&&(d+=".local");var b=this;this._mDns?this._mDns.discoverService(d,h):this.start(function(l){l?h&&h(l):b._mDns.discoverService(d,h)})}else h&&h(Error("serviceType is empty"))};p.prototype.stopDiscover=function(d,h){this._mDns?this._mDns.removeDiscoverServiceCallback(d,h):h&&h()};
var r=function(){var d=function(b,d,e){this._serviceType=b;this._domain=d;this._ios=e;this._running=!1;this._callbacks=[];this._services=[]};d.prototype.discover=function(b){b&&-1==this._callbacks.indexOf(b)&&this._callbacks.push(b);if(this._running)for(var d=0;d<this._services.length;d++)b&&b(null,this._services[d]);else if(!this._running){this._running=!0;var e=this;XC.callHost("mdns","search",{service:this._serviceType},function(b){if(b.error){for(var a=0;a<e._callbacks.length;a++)e._callbacks[a](Error(b.error));
e._callbacks=[];e._stop()}else for(b.target&&"."==b.target.charAt(b.target.length-1)&&(b.target=b.target.substr(0,b.target.length-1)),b.domain&&"."==b.domain.charAt(b.domain.length-1)&&(b.domain=b.domain.substr(0,b.domain.length-1)),e._services.push(b),a=0;a<e._callbacks.length;a++)e._callbacks[a](null,b)})}};d.prototype.removeCallback=function(b){var d=!1;b&&0<this._callbacks.length&&(b=this._callbacks.indexOf(b),-1!=b&&this._callbacks.splice(b,1));0==this._callbacks.length&&(this._stop(),d=!0);
return d};d.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(b){})};var h=function(){this._serviceHandlers={}};h.prototype.start=function(b){b&&b()};h.prototype.stop=function(b){b&&b()};h.prototype.clearRecordBuffer=function(){};h.prototype.discoverServiceWithTimeout=function(b,d,e){var h=this,a=[],c=function(b,c){!b&&c&&a.push(c)};this.discoverService(b,c);setTimeout(function(){h._removeDiscoverServiceCallback(b,c);e&&e(null,a)},d)};h.prototype.discoverService=
function(b,h){if(b){-1!=b.indexOf(".local")&&(b=b.replace(".local",""));var e=this._serviceHandlers[b];e||(e=new d(b,"local",this),this._serviceHandlers[b]=e);e.discover(h)}else h&&h(Error("serviceType is empty"))};h.prototype.stopDiscover=function(b,d){if(b){-1!=b.indexOf(".local")&&(b=b.replace(".local",""));var e=this._serviceHandlers[b];e?e.removeCallback(d)&&delete this._serviceHandlers[b]:d&&d()}else d&&d(Error("serviceType is empty"))};h.prototype._removeDiscoverServiceCallback=function(b,
d){-1!=b.indexOf(".local")&&(b=b.replace(".local",""));var e=this._serviceHandlers[b];e&&e.removeCallback(d)&&delete this._serviceHandlers[b]};return h}(),m=function(){this._nativeHandler=null};m.prototype.start=function(d){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.start(d)};m.prototype.stop=function(d){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.stop(d)};m.prototype.clearRecordBuffer=function(){this._nativeHandler||
(this._nativeHandler=this._getNativeHandler());this._nativeHandler.clearRecordBuffer()};m.prototype.discoverServiceWithTimeout=function(d,h,b){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverServiceWithTimeout(d,h,b)};m.prototype.discoverService=function(d,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());this._nativeHandler.discoverService(d,h)};m.prototype.stopDiscover=function(d,h){this._nativeHandler||(this._nativeHandler=this._getNativeHandler());
this._nativeHandler.stopDiscover(d,h)};m.prototype._getNativeHandler=function(){var d=null;"undefined"!=typeof window&&null!=window&&window.XCHost||(d="node-webkit");"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(d=window.XCHost.getType());return"Android"==d?new r:"node-webkit"==d||"undefined"!=typeof process&&null!=process&&"node"==process.title?new p:new r};return m}();"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler);
