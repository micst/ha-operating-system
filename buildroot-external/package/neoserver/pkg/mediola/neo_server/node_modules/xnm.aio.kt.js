var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.kt=xnm.aio.kt||{};xnm.aio.kt.Socket=function(a,b,c){this.ip=a;this.port=28530;this.uuid=b;this._state="?";c&&(this._manuCode=c.manuCode,this._authCode=c.authCode,this._deviceType=c.deviceType);this.CommandHandler=null};
xnm.aio.kt.Socket.prototype._sendMessage=function(a,b){for(var c=[1,0],e=this.uuid.replace(/-/g,""),d=0;6>d;d++)c.push(parseInt(e.substr(2*d,2),16));c.push(a.length+7);c.push(0);c.push(0);c.push(0);c.push(this._manuCode);c.push(this._authCode[0]);c.push(this._authCode[1]);c.push(this._deviceType);for(d=0;d<a.length;d++)c.push(a[d]);a=new Buffer(c);console.log("send packet",a.toString("hex"));var f=require("dgram").createSocket("udp4");f.send(a,0,a.length,this.port,this.ip,function(a,c){f.close();
b&&setTimeout(function(){b.call()},1E3)})};xnm.aio.kt.Socket.prototype.getState=function(a){this._sendMessage([2,0,0,0,0]);var b=this;setTimeout(function(){a(b._state)},3E3)};xnm.aio.kt.Socket.prototype.executeCommand=function(a,b,c){var e=this,d=[1,0,0,0,255];if("on"==b)d[3]=255;else if("toggle"==b){this.getState(function(a){"on"==a||"off"==a?("off"==a&&(d[3]=255),e._sendMessage(d,function(){e._sendMessage(d,c)})):c&&c.call()});return}e._sendMessage(d,function(){e._sendMessage(d,c)})};
xnm.aio.kt.Socket.prototype.getStates=function(a,b,c){var e=this;this.CommandHandler=a;this.getState(function(a){var d={state:a};b&&e.CommandHandler.setState?e.CommandHandler.setState(b.id,a):e.CommandHandler.receivedState&&e.CommandHandler.receivedState("kt",e.uuid,d);c&&c(d)})};xnm.aio.kt.Socket.prototype.getStateValues=function(a){return a};
xnm.aio.kt.Discovery=function(){this.Devices={};this.callback=null;this._sockets=[];var a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a)for(var c=a[b],e=0;e<c.length;e++)this._addDiscoverSocket(28530,c[e])}else this._addDiscoverSocket(28530,null)};xnm.aio.kt.Discovery.prototype._getMAC=function(a){for(var b="",c=0;5>c;c++)b+=XC.getHexVal(a[c],2).toUpperCase()+"-";return b+=XC.getHexVal(a[c],2).toUpperCase()};
xnm.aio.kt.Discovery.prototype._receivedData=function(a,b){b=b.toString("hex");b=new Buffer(b,"hex");XC.debugf("Received data from "+a+" ("+b.length+")");XC.debugf(b.toString("hex"));var c,e,d,f;1<b.length&&(c=b[0]);2<b.length&&(e=b[1]);8<b.length&&(d=b.slice(2,8));9<b.length&&(f=b[8]);b.slice(9);var g=!1;e&64&&(g=!0);console.log(c,e,d,f,g);44==b.length&&35==b[16]?(c={manuCode:b[12],authCode:[b[13],b[14]],deviceType:b[15]},d=this._getMAC(b.slice(21,27)),this.Devices[a]=new xnm.aio.kt.Socket(a,d,c),
this.callback&&this.Devices[a]&&this.callback(this.Devices[a])):21==b.length&&2==b[16]&&this.Devices[a]&&(this.Devices[a]._state=255==b[b.length-2]?"on":"off",this.Devices[a].CommandHandler&&this.Devices[a].CommandHandler.receivedState&&this.Devices[a].CommandHandler.receivedState("kt",this.Devices[a].uuid,{state:this.Devices[a]._state}))};
xnm.aio.kt.Discovery.prototype._addDiscoverSocket=function(a,b){var c=require("dgram"),e=this;if(b)"IPv4"==b.family&&0==b.internal&&(d=c.createSocket("udp4"),d.on("listening",function(){d.setBroadcast(!0)}),d.on("message",function(a,b){e._receivedData(b.address,a)}),d.bind(a,b.address),this._sockets.push(d));else{var d=c.createSocket("udp4");d.on("message",function(a,b){e._receivedData(b.address,a)});d.bind(a);this._sockets.push(d)}};
xnm.aio.kt.Discovery.prototype._sendDiscoveryMessages=function(a,b,c,e){a=new Buffer([1,0,255,255,255,255,255,255,14,0,0,0,202,253,102,33,35,255,255,255,255,255,255]);for(b=0;2>b;b++)for(c=0;c<this._sockets.length;c++)this._sockets[c].send(a,0,a.length,28530,"255.255.255.255")};xnm.aio.kt.Discovery.prototype.discoverDevices=function(){this._sendDiscoveryMessages()};xnm.aio.kt.Handler=function(){this._Discovery=new xnm.aio.kt.Discovery;this._Discovery.discoverDevices()};
xnm.aio.kt.Handler.prototype.discoverDevices=function(a){a&&(this._Discovery.callback=a);this._Discovery.discoverDevices()};xnm.aio.kt.Handler.prototype.getStateValues=function(a,b){return(new xnm.aio.kt.Socket).getStateValues(b)};xnm.aio.kt.Handler.prototype.getDeviceCommandList=function(a,b){a=[];a.push({id:window.XC_Text.on,cmd:"on"});a.push({id:window.XC_Text.off,cmd:"off"});return a};
xnm.aio.kt.Handler.prototype.getDevice=function(a){for(var b in this._Discovery.Devices)if(a.address&&this._Discovery.Devices[b].uuid==a.address)return this._Discovery.Devices[b];return null};xnm.aio.kt.Handler.prototype.Socket=xnm.aio.kt.Socket;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.kt.Handler);
