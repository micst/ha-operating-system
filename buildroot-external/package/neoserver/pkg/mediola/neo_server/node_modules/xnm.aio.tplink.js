var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.tplink=xnm.aio.tplink||{};xnm.aio.tplink.SmartPlug=function(a,c){this._host=a;this._port=c;this._port||(this._port=9999);this._timeout=2E3;this.CommandHandler=null};xnm.aio.tplink.SmartPlug.prototype._decryptData=function(a){var c=null;if(a&&4<a.length&&a[3]+(a[2]<<8)==a.length-4){c="";for(var d=171,b=4;b<a.length;b++){c.charCodeAt(b);var e=d^a[b];d=a[b];c+=String.fromCharCode(e)}}return c};
xnm.aio.tplink.SmartPlug.prototype._send=function(a,c){var d=[0,0,0,0];c=JSON.stringify(c);for(var b=171,e=0;e<c.length;e++){var f=c.charCodeAt(e);b=f^=b;d.push(f)}d[3]=d.length-4;d=new Buffer(d);a&&a.write(d)};
xnm.aio.tplink.SmartPlug.prototype._doRequest=function(a,c){var d=this,b=require("net").connect({port:this._port,host:this._host});b.setTimeout(this._timeout);b.on("connect",function(){d._send(b,a)});b.on("data",function(a){a=d._decryptData(a);var b=null;try{b=JSON.parse(a)}catch(g){}c&&c(b)});b.on("error",function(a){c&&c(null)});b.on("timeout",function(){b&&b.destroy();c&&c(null)});b.on("close",function(){b=null})};
xnm.aio.tplink.SmartPlug.prototype.executeCommand=function(a,c,d){var b=null;if("on"==c)b={system:{set_relay_state:{state:1}}};else if("off"==c)b={system:{set_relay_state:{state:0}}};else if("ledOn"==c)b={system:{set_led_off:{off:0}}};else if("ledOff"==c)b={system:{set_led_off:{off:1}}};else if("toggle"==c||"toggleLED"==c){var e=this;this.getState(function(b){b?"toggle"==c?"off"==b.state?e.executeCommand(a,"on",d):e.executeCommand(a,"off",d):"toggleLED"==c&&("off"==b.led?e.executeCommand(a,"ledOn",
d):e.executeCommand(a,"ledOff",d)):d&&d()})}else d&&d();b&&this._doRequest(b,function(a,b){d&&d()})};
xnm.aio.tplink.SmartPlug.prototype.getState=function(a){var c=this;this._doRequest({system:{get_sysinfo:{}}},function(d,b){var e={state:"?"};d&&d.system&&d.system.get_sysinfo?(1==d.system.get_sysinfo.relay_state?e.state="on":0==d.system.get_sysinfo.relay_state&&(e.state="off"),1==d.system.get_sysinfo.led_off?e.led="off":0==d.system.get_sysinfo.led_off&&(e.led="on"),c._doRequest({emeter:{get_realtime:{}}},function(b,c){b&&b.emeter&&b.emeter.get_realtime&&(e.current=b.emeter.get_realtime.current,e.power=
b.emeter.get_realtime.power);a&&a(e)})):a&&a(e)})};xnm.aio.tplink.SmartPlug.prototype.getStates=function(a,c,d){var b=this;this.CommandHandler=a;this.getState(function(a){device&&b.CommandHandler.setState?b.CommandHandler.setState(device.id,a.state):b.CommandHandler.receivedState&&b.CommandHandler.receivedState("tplink",b.host,a);d&&d(a)})};xnm.aio.tplink.SmartPlug.prototype.getStateValues=function(a,c){return c};xnm.aio.tplink.Handler=function(){this.detectedSmartPlugs={}};
xnm.aio.tplink.Handler.prototype.discoverSmartPlugs=function(a){};xnm.aio.tplink.Handler.prototype.SmartPlug=xnm.aio.tplink.SmartPlug;xnm.aio.tplink.Handler.prototype.getStateValues=function(a,c){return(new xnm.aio.tplink.SmartPlug).getStateValues(a.type,c)};xnm.aio.tplink.Handler.prototype.getDeviceCommandList=function(a,c,d){a=[];a.push({id:"on",cmd:"on"});a.push({id:"off",cmd:"off"});a.push({id:"toggle",cmd:"toggle"});return a};
"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tplink.Handler);
