var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{};x.hub.peripheralman=x.hub.peripheralman||{};
x.hub.peripheralman.PeripheralManager=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.PeripheralManager");this._peripherals=[]};e.FILE_NAME="pm.json";e.prototype.init=function(a){var c=this;this._load(function(d){d?a&&a(d):(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION||global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM||c._initUdevMonitor(),a&&a())})};e.prototype.getUSBDevices=function(){return this._peripherals};e.prototype._load=
function(a){var c=this,d=require("fs-extra"),b=require("x.hub.fileman.js").fileManager,g=require("path");b=b.getUserRootDataPath();var f=g.resolve(b,e.FILE_NAME);d.ensureFile(f,function(b){b?a&&a(b):c._loadData(f,function(b,d){b?a&&a(b):(c._peripherals=d,a&&a())})})};e.prototype._loadData=function(a,c){require("fs").readFile(a,"utf8",function(a,b){if(a)c&&c(a);else if(b)try{var d=JSON.parse(b);c&&c(null,d)}catch(f){c&&c(f)}else c&&c(null,[])})};e.prototype._initUdevMonitor=function(){var a=require("udev").monitor();
a.on("add",this._onAdd.bind(this));a.on("remove",this._onRemove.bind(this));a.on("change",this._onChange.bind(this));a=this._listSerialDev();var c=this;a&&a.forEach(function(a){(a=c._udev2dev(a))&&c._onFindUsbDevice(a)})};e.prototype._listSerialDev=function(){if(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION||global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM)return null;var a=require("udev"),c=a.list("tty");a=a.list("net");var d=[];c&&(d=d.concat(c));a&&(d=d.concat(a));
return d};e.prototype._isSameDev=function(a,c){for(var d in a)if(a.hasOwnProperty(d)&&a[d]!=c[d])return!1;for(d in c)if(c.hasOwnProperty(d)&&a[d]!=c[d])return!1;return!0};e.prototype._onAdd=function(a){this._logger.log("trace","add: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onFindUsbDevice(a)};e.prototype._onRemove=function(a){this._logger.log("trace","remove: "+JSON.stringify(a));(a=this._udev2dev(a))&&this._onRemoveUsbDevice(a)};e.prototype._onChange=function(a){this._logger.log("trace",
"changed: "+JSON.stringify(a))};e.prototype._udev2dev=function(a){if(!a||"usb"!=a.ID_BUS)return null;var c=a.DEVNAME,d={},b;for(b in a)a.hasOwnProperty(b)&&"ID"==b.substr(0,2)&&(d[b]=a[b]);"wlan"==a.DEVTYPE&&a.INTERFACE&&(c=a.INTERFACE);if(!c)return null;a={port:c,info:d};if("EnOcean_GmbH"==d.ID_VENDOR&&d.ID_USB_DRIVER)a.type="enocean";else if("0658"==d.ID_VENDOR&&d.ID_USB_DRIVER)a.type="zwave";else if("0451"==d.ID_VENDOR_ID&&"16a8"==d.ID_MODEL_ID&&d.ID_USB_DRIVER)a.type="zigbee";else if("wlan0"==
a.port||"wlan1"==a.port)a.type="wlan";return a};e.prototype._onFindUsbDevice=function(a){for(var c=this._peripherals.length,d=!1,b=null;c;)if(c--,b=this._peripherals[c],this._isSameDev(b.info,a.info)){d=!0;b.port=a.port;break}d||(b=a,b.type?this._peripherals.push(b):b.info&&b.info.ID_USB_DRIVER&&this._peripherals.push(b));a=require("x.hub.eventbus.js");switch(b.type){case "enocean":this._logger.log("debug","add enocean stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ENOCEAN",b);break;
case "zwave":this._logger.log("debug","add zwave stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ZWAVE",b);break;case "zigbee":this._logger.log("debug","add zigbee stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.ADD_ZIGBEE",b);break;case "wlan":this._logger.log("debug","add wlan stick: "+JSON.stringify(b)),a.emit("x.hub.peripheralman.ADD_WLAN",b)}b&&b.info&&b.info.ID_USB_DRIVER&&a.emit("x.hub.peripheralman.ADD_SEIRAL",b)};e.prototype._onRemoveUsbDevice=function(a){for(var c=this._peripherals.length,
d=!1,b=null;c;)if(c--,b=this._peripherals[c],this._isSameDev(b.info,a.info)){d=!0;break}d&&this._peripherals.splice(c,1);a=require("x.hub.eventbus.js");switch(b.type){case "enocean":this._logger.log("debug","remove enocean stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_ENOCEAN",b);break;case "zwave":this._logger.log("debug","remove zwave stick: "+JSON.stringify(b));a.emit("x.hub.peripheralman.REMOVE_ZWAVE",b);break;case "zigbee":this._logger.log("debug","remove zigbee stick: "+JSON.stringify(b));
a.emit("x.hub.peripheralman.REMOVE_ZIGBEE",b);break;case "wlan":this._logger.log("debug","remove wlan stick: "+JSON.stringify(b)),a.emit("x.hub.peripheralman.REMOVE_WLAN",b)}b&&b.info&&b.info.ID_USB_DRIVER&&a.emit("x.hub.peripheralman.REMOVE_SEIRAL",b)};return e}();
x.hub.peripheralman.Handler=function(){var e=function(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.Handler");this.peripheralManager=new x.hub.peripheralman.PeripheralManager};e.prototype.PeripheralManager=x.hub.peripheralman.PeripheralManager;e.prototype.init=function(a,c,d){this.peripheralManager.init(d)};e.prototype.getUSBDevices=function(a){var c=this.peripheralManager.getUSBDevices();a&&a({data:c})};e.prototype.getUSBDevicesShortInfo=function(a){for(var c=this.peripheralManager.getUSBDevices(),
d=[],b=0;b<c.length;b++){var e=c[b];e.type&&d.push({port:e.port,type:e.type,model:e.info?e.info.ID_MODEL:null,serial:e.info?e.info.ID_SERIAL:null,vendor:e.info?e.info.ID_VENDOR:null})}a&&a({data:d})};return e}();module.exports=new x.hub.peripheralman.Handler;
