var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(e,b,a){e instanceof String&&(e=String(e));for(var c=e.length,d=0;d<c;d++){var f=e[d];if(b.call(a,f,d,e))return{i:d,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(e,b,a){e!=Array.prototype&&e!=Object.prototype&&(e[b]=a.value)};$jscomp.getGlobal=function(e){e=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,e];for(var b=0;b<e.length;++b){var a=e[b];if(a&&a.Math==Math)return a}return globalThis};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(e,b,a,c){if(b){a=$jscomp.global;e=e.split(".");for(c=0;c<e.length-1;c++){var d=e[c];d in a||(a[d]={});a=a[d]}e=e[e.length-1];c=a[e];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(a,e,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(e){return e?e:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.bose=xnm.aio.bose||{};
xnm.aio.bose.SoundTouch=function(){var e=function(b){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.SoundTouch"):{log:{}};this._renderer=null;this.mac=b?b.mac:null;this.name=b?b.name:null;this.bass=b?b.base:null;this.sources=b?b.sources:null;this.isMaster=!1;this.members=null;b&&b.ip&&b.port&&b.uuid&&(this._renderer=this._getRenderer(b.ip,b.port,b.uuid))};e.PLAY_STATUS=["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"];
e.prototype.getIP=function(){return this._renderer?this._renderer.ip:null};e.prototype.setIP=function(b){this._renderer&&(this._renderer.ip=b)};e.prototype.getPort=function(){return this._renderer?this._renderer.port:null};e.prototype.setPort=function(b){this._renderer&&(this._renderer.port=b)};e.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null};e.prototype.getName=function(){return this.name?this.name:this._renderer?this._renderer.name:null};e.prototype.getMac=function(){return this.mac?
this.mac:this._renderer?this._renderer.serialNumber:null};e.prototype.getInfos=function(b){var a=4,c={},d=function(d){a--;d?b&&b(d):0==a&&b&&b(null,c)};this._getInfo(function(a,b){b&&(c.name=b.name,c.mac=b.mac);d&&d(a);a&&(d=null)});this._getBassCap(function(a,b){b&&(c.bass=b.bass);d&&d(a);a&&(d=null)});this._getSources(function(a,b){b&&(c.sources=b);d&&d(a);a&&(d=null)});this._getZone(function(a,b){b&&(c.zoneInfo=b);d&&d(a);a&&(d=null)})};e.prototype.getRooms=function(b){var a=this;require("xnm.aio.bose.js").master.getZones(function(c,
d){if(c)b&&b(c);else{c={};for(var f=0;f<d.length;f++){var g=d[f];if(g&&g.masterMac==a.mac){for(d=0;d<g.players.length;d++)(f=g.players[d])&&f.mac&&f.name&&(c[f.mac]=f.name);break}}b&&b(null,c)}})};e.prototype.getPlayInfo=function(b){this._getNowPlaying(function(a,c){a?b&&b(a):(a={trackMetaData:c},a.trackMetaData.albumArtURI=c.art,a.trackMetaData.title=c.track,b&&b(null,a))})};e.prototype.play=function(b,a,c){if(b&&a&&a["class"]&&a.id)if(this._renderer){var d=this;b.browseMetaData(a.id,function(f,
g){f?c&&c(f):0!=a["class"].indexOf("object.container")||a.res&&a.res.url?a.res&&a.res.url?d._renderer.playResource({url:a.res.url},g.result,c):c&&c(Error("resource url invalid")):b.uuid?d._renderer.playContainer({containerID:a.id,server_uuid:b.uuid},g.result,c):c&&c(Error("media server uuid invalid"))})}else c&&c(Error("renderer not inited"));else c&&c(Error("play obj invalid"))};e.prototype.playUrl=function(b,a){if(b){var c=this;this._renderer._setAVTransportURI(0,b,null,function(b){b?a&&a(b):c._renderer.play(a)})}else a&&
a(Error("url is null"))};e.prototype.browser=function(b,a,c,d,f){b?(a||(a=0),c||(c=0),d||(d=0),b.browseChildren(a,c,d,null,function(a,b,c){f&&f(a,b,c)})):f&&f(Error("play obj invalid"))};e.prototype.executeCommandCreator=function(b,a,c){a&&a.value?this._executeCommand(a.value,a.ext,function(a){c&&c(a)}):c&&c(Error("command value is empty"))};e.prototype.getStatesCreator=function(b,a,c){this._getStates(function(b,f){if(b)c&&c(b);else{b=[];for(var d=0;d<a.length;d++){var e=a[d];if(e&&e.id&&e.status){var k=
"?";switch(e.status.value){case "power":case "muted":case "volume":case "repeatMode":case "shuffleMode":case "playState":case "durationS":case "positionS":case "bass":k=f[e.status.value];break;case "artist":case "title":case "album":case "radio":(k=f[e.status.value])||(k="")}if("undefined"==typeof k||null==k)k="?";b.push({id:e.id,status:k})}}c&&c(null,b)}})};e.prototype._executeCommand=function(b,a,c){if(this._renderer){var d=this;switch(b){case "play":this._clickKey("PLAY",c);break;case "pause":this._clickKey("PAUSE",
c);break;case "tooglePlay":this._clickKey("PLAY_PAUSE",c);break;case "stop":this._clickKey("STOP",c);break;case "previous":this._clickKey("PREV_TRACK",c);break;case "next":this._clickKey("NEXT_TRACK",c);break;case "togglePower":this._clickKey("POWER",c);break;case "toggleMute":this._clickKey("MUTE",c);break;case "volumeUp":this._clickKey("VOLUME_UP",c);break;case "volumeDown":this._clickKey("VOLUME_DOWN",c);break;case "setVolume":if("undefined"==typeof a||null==a){c&&c(Error("volume value invalid"));
break}a=parseInt(a);100<a&&(a=100);0>a&&(a=0);this._setVolume(a,c);break;case "thumbUp":this._clickKey("THUMBS_UP",c);break;case "thumbDown":this._clickKey("THUMBS_DOWN",c);break;case "bookmark":this._clickKey("BOOKMARK",c);break;case "preset":if(!a){c&&c(Error("preset value invalid"));break}this._clickKey("PRESET_"+a,c);break;case "shuffleOn":this._clickKey("SHUFFLE_ON",c);break;case "shuffleOff":this._clickKey("SHUFFLE_OFF",c);break;case "toggleShuffle":this._getNowPlaying(function(a,b){a?c&&c(a):
b&&b.shuffleSetting?(a="SHUFFLE_ON","SHUFFLE_ON"==b.shuffleSetting&&(a="SHUFFLE_OFF"),d._clickKey(a,c)):c&&c(Error("no shuffle setting"))});break;case "setRepeatMode":if(!a){c&&c(Error("play mode value invalid"));break}this._clickKey(a,c);break;case "addFav":this._clickKey("ADD_FAVORITE",c);break;case "removeFav":this._clickKey("REMOVE_FAVORITE",c);break;case "bassUp":case "bassDown":if("undefined"==typeof a||null==a){c&&c(Error("seek value invalid"));break}this._getBass(function(a,e){if(a)c&&c(a);
else if(e&&"undefined"!=typeof e.actualbass&&null!=e.actualbass){a=e.actualbass;a="bassUp"==b?a+1:a-1;if(this.bass&&(f=this.bass.indexOf("-",1),-1!=f)){e=this.bass.substring(0,f);var g=this.bass.substr(f+1);e=parseInt(e);g=parseInt(g);a<e&&(a=e);a>g&&(a=g)}d._setBass(a,c)}else c&&c(Error("no bass info"))});break;case "setBass":if("undefined"==typeof a||null==a){c&&c(Error("volume value invalid"));break}a=parseInt(a);if(this.bass){var f=this.bass.indexOf("-",1);if(-1!=f){var e=this.bass.substring(0,
f),h=this.bass.substr(f+1);e=parseInt(e);h=parseInt(h);a<e&&(a=e);a>h&&(a=h)}}this._setBass(a,c);break;case "playUrl":if(!a){c&&c(Error("url value invalid"));break}this.playUrl(a,c);break;default:b&&"select:"==b.substr(0,7)?(e=b.substr(7),f=e.indexOf("@"),a=e.substring(0,f),e=e.substr(f+1),d._setSource(a,e,c)):c&&c(Error("unknown command"))}}else c&&c(Error("renderer not initialized"))};e.prototype._getStates=function(b){var a=function(){d--;0==d&&b&&b(null,c)},c={},d=3;this._getBass(function(b,d){!b&&
d&&(c.bass=d.actualbass);a()});this._getVolume(function(b,d){!b&&d&&(c.volume=d.actualvolume,c.muted=d.muteenabled);a()});this._getNowPlaying(function(b,d){!b&&d&&(c.power="STANDBY"==d.source?"off":"on",d.repeatSetting&&(c.repeatMode=d.repeatSetting),d.shuffleSetting&&(c.shuffleMode=d.shuffleSetting),d.playStatus&&(c.playState=d.playStatus),d.duration&&(c.durationS=d.duration),d.position&&(c.positionS=d.position),d.position&&(c.positionS=d.position),d.track&&(c.title=d.track),d.stationName&&(c.radio=
d.stationName),d.artist&&(c.artist=d.artist),d.album&&(c.album=d.album));a()})};e.prototype._getRenderer=function(b,a,c){var d=new (require("x.upnp.js").MediaRenderer);d.init(b,a,c,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/UD/"+c+"?2"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/UD/"+c+"?1"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/UD/"+c+"?0"}});return d};e.prototype._clickKey=function(b,a){var c=
this;this._pressKey(b,function(d){d?a&&a(d):c._releaseKey(b,function(b){a&&a(b)})})};e.prototype._getInfo=function(b){var a=this;this._sendRequest("GET","/info",null,function(c,d){c?b&&b(c):(c=d.find("info"))&&c[0]?(c=$(c[0]),a.mac=c.attr("deviceID"),(c=c.find("name"))&&c[0]&&(a.name=$(c[0]).text()),b&&b(null,{name:a.name,mac:a.mac})):b&&b(Error("get info xml invalid"))})};e.prototype._pressKey=function(b,a){this._sendRequest("POST","/key",'<key state="press" sender="Gabbo">'+b+"</key>",a)};e.prototype._releaseKey=
function(b,a){this._sendRequest("POST","/key",'<key state="release" sender="Gabbo">'+b+"</key>",a)};e.prototype._getSources=function(b){var a=this;this._sendRequest("GET","/sources",null,function(c,d){if(c)b&&b(c);else{var f=[];d.find("sourceItem").each(function(){var a=$(this);f.push({source:a.attr("source"),sourceAccount:a.attr("sourceAccount")?a.attr("sourceAccount"):null,isLocal:a.attr("isLocal"),name:a.text()?a.text():null})});a.sources=f;b&&b(null,f)}})};e.prototype._setSource=function(b,a,
c){b='<ContentItem source="'+b+'"';a&&(b+=' sourceAccount="'+a+'"');this._sendRequest("POST","/select",b+"></ContentItem>",c)};e.prototype._setBass=function(b,a){this._sendRequest("POST","/bass","<bass>"+b+"</bass>",a)};e.prototype._getBass=function(b){this._sendRequest("GET","/bass",null,function(a,c){if(a)b&&b(a);else{var d={},f=c.find("targetbass");f&&f[0]&&(d.targetbass=parseInt($(f[0]).text()));(f=c.find("actualbass"))&&f[0]&&(d.actualbass=parseInt($(f[0]).text()));b&&b(a,d)}})};e.prototype._getBassCap=
function(b){var a=this;this._sendRequest("GET","/bassCapabilities",null,function(c,d){if(c)b&&b(c);else if((c=d.find("bassAvailable"))&&c[0])if((c=$(c[0]).text())&&"false"!=c.toLowerCase()){c=0;var f=d.find("bassMin");f&&f[0]&&(c=$(f[0]).text());f=100;(d=d.find("bassMax"))&&d[0]&&(f=$(d[0]).text());a.bass=c+"-"+f;b&&b(null,{bass:a.bass})}else b&&b(null,null);else b&&b(Error("get bass cap xml invalid"))})};e.prototype._getZone=function(b){var a=this;this._sendRequest("GET","/getZone",null,function(c,
d){if(c)b&&b(c);else{var f={isMaster:!1};if((c=d.find("zone"))&&c[0]){d=$(c[0]).attr("master");if(!d){f.isMaster=!0;f.master=a.getMac();f.members={};f.members[a.getMac()]=a.getIP();a.isMaster=!0;a.members=f.members;b&&b(null,f);return}f.master=d;d==a.getMac()&&(f.isMaster=!0)}$(c[0]).find("member").each(function(){var a=$(this),b=a.attr("ipaddress");a=a.text();b&&a&&(f.members||(f.members={}),f.members[a]=b)});a.isMaster=f.isMaster;a.members=f.members;b&&b(null,f)}})};e.prototype._setZone=function(b,
a,c){b='<zone master="'+b+'" senderIPAddress="0.0.0.0">';for(var d in a)a.hasOwnProperty(d)&&a[d]&&(b+='<member ipaddress="'+a[d]+'">'+d+"</member>");this._sendRequest("POST","/setZone",b+"</zone>",c)};e.prototype._getVolume=function(b){this._sendRequest("GET","/volume",null,function(a,c){if(a)b&&b(a);else{var d={},f=c.find("targetvolume");f&&f[0]&&(d.targetvolume=parseInt($(f[0]).text()));(f=c.find("actualvolume"))&&f[0]&&(d.actualvolume=parseInt($(f[0]).text()));(f=c.find("muteenabled"))&&f[0]&&
(d.muteenabled=$(f[0]).text());b&&b(a,d)}})};e.prototype._setVolume=function(b,a){this._sendRequest("POST","/volume","<volume>"+b+"</volume>",a)};e.prototype._getNowPlaying=function(b){this._sendRequest("GET","/now_playing",null,function(a,c){if(a)b&&b(a);else{a={};var d=c.find("nowPlaying");if(d&&d[0]){var f=$(d[0]).getAttributes();a=JSON.parse(JSON.stringify(f))}(d=c.find("ContentItem"))&&d[0]&&(f=$(d[0]).getAttributes(),a.content=JSON.parse(JSON.stringify(f)),(f=$(d[0]).find("itemName"))&&f[0]&&
(a.content.itemName=$(f[0]).text()));(d=c.find("track"))&&d[0]&&(a.track=$(d[0]).text());(d=c.find("artist"))&&d[0]&&(a.artist=$(d[0]).text());(d=c.find("album"))&&d[0]&&(a.album=$(d[0]).text());(d=c.find("stationName"))&&d[0]&&(a.stationName=$(d[0]).text());(d=c.find("art"))&&d[0]&&(a.artImageStatus=$(d[0]).attr("artImageStatus"),a.art=$(d[0]).text());(d=c.find("playStatus"))&&d[0]&&(a.playStatus=$(d[0]).text());(d=c.find("description"))&&d[0]&&(a.description=$(d[0]).text());(d=c.find("stationLocation"))&&
d[0]&&(a.description=$(d[0]).text());(d=c.find("time"))&&d[0]&&(a.duration=$(d[0]).attr("total"),a.position=$(d[0]).text());(d=c.find("shuffleSetting"))&&d[0]&&(a.shuffleSetting=$(d[0]).text());(d=c.find("repeatSetting"))&&d[0]&&(a.repeatSetting=$(d[0]).text());b&&b(null,a)}})};e.prototype._sendRequest=function(b,a,c,d){this._doRequest(this.getIP(),8090,b,a,c,function(a,b){if(a)d&&d(a);else try{var c=$($.parseXML(b)),f=c.find("error");if(f&&f[0]){var e=$(f[0]),g=e.text(),n=e.attr("name");d&&d(Error(g+
":"+n))}else d&&d(null,c)}catch(p){d&&d(p)}})};e.prototype._doRequest=function(b,a,c,d,f,e){var g=this;b="http://"+b+":"+a+d;this._logger.log("trace","send "+c+" to url:"+b);f&&this._logger.log("trace","with data "+f);var k=e;e={url:b,type:c,timeout:2E3,contentType:"text/xml",dataType:"text",cache:!0,success:function(a){g._logger.log("trace","http request success:"+a);k&&(k(null,a),k=null)},error:function(a,b){a="http request error:"+(a?a.status:"0")+"-"+b;g._logger.log("trace",a);k&&(k(Error(a)),
k=null)}};"post"==c.toLowerCase()&&f&&(e.data=f);$.ajax(e)};e.prototype.toJSON=function(){return{sys:"bose",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"SoundTouch",model:this._renderer?this._renderer.modelName:null,mac:this.getMac(),bass:this.bass,sources:this.sources,name:this.getName()}};e.prototype.equalsTo=function(b){return b&&b instanceof e?this.getIP()==b.getIP()&&this.getPort()==b.getPort():!1};return e}();
xnm.aio.bose.Master=function(){var e=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.Master"):{log:{}};this._mediaServer={};this._soundTouchs={};this._currentZone=null;var b=this;this._discovery=new xnm.aio.bose.Discovery;this._discoveryListener=function(a,c){a&&c&&("mediaServer"==a?b._mediaServer[c.uuid]=c:"soundTouch"==a&&b._onFindSoundTouch(c))};this._discovery.addListener(this._discoveryListener);this._discoveryCB=[];this._autoSearchTO=
null;this.searchSoundTouch()};e.prototype._onFindSoundTouch=function(b){var a=b.getUUID();this._soundTouchs[a]?(a=this._soundTouchs[a],a.dummy=!1,a.player.setIP(b.getIP()),a.player.setPort(b.getPort()),a.player.isMaster=b.isMaster,a.player.members=b.members):this._soundTouchs[a]={missCount:0,dummy:!1,player:b};this._currentZone?b.getMac()!=this._currentZone||b.isMaster||this.setCurrentZone():b.isMaster&&(this._currentZone=b.getMac())};e.prototype.searchSoundTouch=function(b){var a=this._discoveryCB.length;
b||(b=function(){});b&&-1==this._discoveryCB.indexOf(b)&&this._discoveryCB.push(b);if(0==a){this._autoSearchTO&&(clearTimeout(this._autoSearchTO),this._autoSearchTO=null);this._search();var c=this;setTimeout(function(){c._autoSearchTO=setTimeout(function(){c.searchSoundTouch(null)},3E4);var a=c._discoveryCB;c._discoveryCB=[];a.forEach(function(a){a(null,c._getFoundSoundTouchs())})},5E3)}};e.prototype._search=function(){for(var b in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(b)){var a=this._soundTouchs[b];
5<=a.missCount?delete this._soundTouchs[b]:a.missCount++}this._discovery.searchSoundTouch()};e.prototype.getCurrentZone=function(b){var a=this,c=this._getFoundSoundTouchs();if(c&&0!=c.length)if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);if(d){c=d.members;d={masterPlayer:d,masterMac:this._currentZone,players:[]};for(var e in c)if(c.hasOwnProperty(e)){var g=this._findPlayerWithMac(e);g&&d.players.push(g)}b&&b(null,d)}else b&&b(Error("no player with mac:"+this._currentZone))}else this.setCurrentZone(null,
function(c){c?b&&b(c):a.getCurrentZone(b)});else this.searchSoundTouch(function(c,d){c?b&&b(c):d&&0!=d.length?a.getCurrentZone(b):b&&b(Error("find no sound touch player"))})};e.prototype._findPlayerWithMac=function(b){for(var a in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(a)){var c=this._soundTouchs[a];if(c&&c.player&&c.player.getMac()==b)return c.player}return null};e.prototype.setCurrentZone=function(b,a){var c=null;if(b)(c=this._findPlayerWithMac(b))&&!c.isMaster&&(c=null);else for(var d in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(d)&&
(b=this._soundTouchs[d])&&b.player&&b.player.isMaster){c=b.player;break}c?(this._currentZone=c.getMac(),a&&a()):a&&a(Error("no such master"))};e.prototype.getZones=function(b){var a=this,c=this._getFoundSoundTouchs();if(c&&0!=c.length)for(var d=0,e={},g=function(f,g){d++;!f&&g&&g.isMaster&&g.master&&g.members&&(e[g.master]=g.members);if(d==c.length){f=[];for(var h in e)if(e.hasOwnProperty(h)){g={masterMac:h,players:[]};var k=e[h],l;for(l in k)if(k.hasOwnProperty(l)){var m=a._findPlayerWithMac(l);
m&&-1==g.players.indexOf(m)&&g.players.push(m)}f.push(g)}b&&b(null,f)}},h=0;h<c.length;h++)c[h]._getZone(g);else this.searchSoundTouch(function(c,d){c?b&&b(c):d&&0!=d.length?a.getZones(b):b&&b(Error("find no sound touch player"))})};e.prototype.createZone=function(b,a){if(b&&0!=b.length){var c={},d=b[0],e=d.getMac();if(1<b.length)for(var g=0;g<b.length;g++){var h=b[g];c[h.getMac()]=h.getIP()}var k=this;d._setZone(e,c,function(b){b?a&&a(b):k.getZones(function(b){a&&a(b)})})}else a&&a()};e.prototype._getFoundSoundTouchs=
function(){var b=[],a;for(a in this._soundTouchs)if(this._soundTouchs.hasOwnProperty(a)){var c=this._soundTouchs[a];c&&!c.dummy&&c.player&&b.push(c.player)}return b};e.prototype.getSoundTouch=function(b){if(!b.uuid)return null;if("master"==b.uuid)return this;var a=this._soundTouchs[b.uuid];if(a&&a.player)return a.player;a=new xnm.aio.bose.SoundTouch(b);this._soundTouchs[b.uuid]={missCount:0,dummy:!0,player:a};return a};e.prototype.executeCommandCreator=function(b,a,c){if(this._currentZone){var d=
this._findPlayerWithMac(this._currentZone);d?d.executeCommandCreator(b,a,c):c&&c(Error("current zone not found"))}else c&&c(Error("current zone not set"))};e.prototype.getStatesCreator=function(b,a,c){if(this._currentZone){var d=this._findPlayerWithMac(this._currentZone);d?d.getStatesCreator(b,a,c):c&&c(Error("current zone not found"))}else c&&c(Error("current zone not set"))};e.prototype.toJSON=function(){return{sys:"bose",ip:"xxxxxxx",port:0,uuid:"master",type:"master"}};return e}();
xnm.aio.bose.Discovery=function(){var e=function(a){a._setAVTransportURI=function(a,b,e,g){a="<InstanceID>"+a+"</InstanceID><CurrentURI>"+this._maskMetaData('<TrackInfo index="0" byteOffsetIntoTrack="0" timeOffsetIntoTrack="0" url="'+this._maskMetaData(b)+'" trackData="" sourceId="0" />')+"</CurrentURI><CurrentURIMetaData>"+(e?this._maskMetaData(e):"")+"</CurrentURIMetaData>";this._doSOAPBodyRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",a,g)};a._doSOAPBodyRequest=
function(a,b,e,g,h){g="<u:"+e+' xmlns:u="'+b+'">'+g+("</u:"+e+">");var c=this;this._doRequest(a,'"'+b+"#"+e+'"',g,function(a,b){a?h&&h(a):(a=c._parseSOAPResponse(b,e+"Response"))?h&&h(null,a):h&&h(Error(e+" reponse format invalid"))})};return a},b=function(){this._logger="undefined"!=typeof require&&require?require("x.logger.js").getLogger("xnm.aio.bose.Discovery"):{log:{}};this._upnpCB=null;this._searchCB=[];this._searching=!1};b.prototype.addListener=function(a){a&&-1==this._searchCB.indexOf(a)&&
this._searchCB.push(a)};b.prototype.removeListener=function(a){a&&(a=this._searchCB.indexOf(a),-1!=a&&this._searchCB.splice(a,1))};b.prototype.searchSoundTouch=function(){if(!this._searching){this._searching=!0;this._search();var a=this;setTimeout(function(){a._searching=!1},5E3)}};b.prototype._search=function(){if(!this._upnpCB){var a=this;this._upnpCB=function(b){a._findUpnpDevice(b)}}var b=require("x.upnp.js").getDiscoveryService();b.addCallback("upnp:rootdevice",this._upnpCB);b.discoverTarget("upnp:rootdevice")};
b.prototype._findUpnpDevice=function(a){if(a){var b=this;switch(a.deviceType){case "urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+a.name+" @"+a.ip);this._searchCB.forEach(function(b){b&&b("mediaServer",a)});break;case "urn:schemas-upnp-org:device:MediaRenderer:1":if(a.modelName&&-1!=a.modelName.indexOf("SoundTouch")){this._logger.log("trace","find SoundTouch:"+a.name+" @"+a.ip);a=e(a);var d=new xnm.aio.bose.SoundTouch;d._renderer=a;d.getInfos(function(a){a||
b._searchCB.forEach(function(a){a&&a("soundTouch",d)})})}}}};return b}();
xnm.aio.bose.DM=function(){var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"play/pause",ref:{value:"tooglePlay",value_t:"playPause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle power",ref:{value:"togglePower"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",
ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"thumb up",ref:{value:"thumbUp"}},{type:"enum",name:"thumb down",ref:{value:"thumbDown"}},{type:"enum",name:"bookmark",ref:{value:"bookmark"}},{type:"enum",name:"preset",ref:{value:"preset",ext:"%e",extMeta:"123456".split("")}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},
{type:"enum",name:"toggle shuffle",ref:{value:"toggleShuffle"}},{type:"enum",name:"set repeat mode",ref:{value:"setRepeatMode",ext:"%e",extMeta:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"add to favorite",ref:{value:"addFav"}},{type:"enum",name:"remove from favorite",ref:{value:"removeFav"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",
value_t:"volumeAudio",extMeta:"0-100"}},{type:"enum",name:"repeat mode",ref:{value:"repeatMode",options:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"shuffle mode",ref:{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]}},{type:"string",name:"play state",ref:{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"int",name:"track position (seconds)",
ref:{value:"positionS"}},{type:"string",name:"radio station",ref:{value:"radio"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]},b=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};b.prototype=Error();b.prototype.name="RaumfeldDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return{SYS:"bose",getIPDeviceType:function(){return[{sys:this.SYS,
name:"Bose SoundTouch"}]},createDevice:function(a,c,d){c=b.ERROR_CODE;a?a.type?a.ip?a.port?a.uuid?d(null,a):d(new b(c.INVALID,"uuid is invalid")):d(new b(c.INVALID,"port is invalid")):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,"type is invalid")):d(new b(c.INVALID,"info is invalid"))},updateDevice:function(a,c,d){c=b.ERROR_CODE;a?a.type?a.ip?a.port?a.uuid?d(null,a):d(new b(c.INVALID,"uuid is invalid")):d(new b(c.INVALID,"port is invalid")):d(new b(c.INVALID,"ip is invalid")):d(new b(c.INVALID,
"type is invalid")):d(new b(c.INVALID,"info is invalid"))},deleteDevice:function(a,b,d){d()},applyUIFilter:function(a,b,d){var c=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},e=function(a,b,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){c(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),
e.push(a))})}return e},h=function(a,b){var c=[],f=xnm.aio.bose.DM.getCommandStatusMap(a,d);f&&(a=e(f,a,b),c=c.concat(a));return c};if(!a.sys)return null;var k=JSON.parse(JSON.stringify(a)),l=null;switch(b.catagory){case "command":l=h(a,b);k.command=l;break;case "status":l=h(a,b);k.status=l;break;default:return null}return l&&0!=l.length?k:null},getCommandStatusMap:function(a,b){var c=JSON.parse(JSON.stringify(e));a&&a.bass&&(c.command.push({type:"enum",name:"bass up",ref:{value:"bassUp"}}),c.command.push({type:"enum",
name:"bass down",ref:{value:"bassDown"}}),c.command.push({type:"int",name:"set bass",ref:{value:"setBass",value_t:"bass",ext:"%d",extMeta:a.bass}}),c.status.push({type:"int",name:"bass",ref:{value:"bass",extMeta:a.bass}}));a&&a.sources&&a.sources.forEach(function(a){if(a&&"true"==a.isLocal){var b=a.source;a.name&&(b=a.name);var d=a.sourceAccount?a.sourceAccount:"";a.source&&c.command.push({type:"enum",name:"select "+b,ref:{value:"select:"+a.source+"@"+d}})}});return c}}}();
xnm.aio.bose.Handler=function(){var e=function(){this.master=new xnm.aio.bose.Master};e.prototype.devicemanager=xnm.aio.bose.DM;e.prototype.SoundTouch=xnm.aio.bose.SoundTouch;e.prototype.registModule=function(b){b.register(xnm.aio.bose.DM.SYS,"bose")};e.prototype.resolveDevice=function(b){return b?this.master.getSoundTouch(b):null};e.prototype.getDeviceCommands=function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"command",elems:"*"}))?b.command:[];a&&a(null,b)};e.prototype.getDeviceStatus=
function(b,a){b=(b=this.devicemanager.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];a&&a(null,b)};e.prototype.doCommand=function(b,a,c){var d=this.resolveDevice(b);d?d.executeCommandCreator(b,a,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};e.prototype.doStatus=function(b,a,c,d){var e=this.resolveDevice(a);e?e.getStatesCreator(null,[{id:b,device:a,status:c}],function(a,b){a?d&&d(a):d&&d(null,b[0])}):d&&d(Error("device json format invalid"))};e.prototype.discover=function(b){var a=
this;this.master.searchSoundTouch(function(c,d){!c&&d&&d.push(a.master);b&&b(c,d)})};e.prototype.getPlayer=function(b,a){if(b&&b.uuid)if("master"==b.uuid)a&&a(null,this.master);else{var c=this.master.getSoundTouch(b);if(c)a&&a(null,c);else{var d=this;this.master.searchSoundTouch(function(){c=d.master.getSoundTouch(b);a&&a(null,c)})}}else a&&a(Error("device json invalid"))};return e}();"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.bose.Handler);
