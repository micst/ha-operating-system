var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.rgb=xnm.aio.rgb||{};
xnm.aio.rgb.Util={rgbToHsv:function(d,a,b){d/=255;a/=255;b/=255;var c=Math.max(d,a,b),e=Math.min(d,a,b),f=c,g=c-e;var h=0==c?0:g/c;if(c==e)var k=0;else{switch(c){case d:k=(a-b)/g+(a<b?6:0);break;case a:k=(b-d)/g+2;break;case b:k=(d-a)/g+4}k=Math.round(60*k);h=Math.round(100*h);f=Math.round(100*f)}return[k,h,f]},hsvToMilightColor:function(d){return(432-Math.floor(Number(d[0])/360*255))%256},rgbToHue:function(d,a,b){d=this.rgbToHsv(d,a,b);return(432-Math.floor(Number(d[0])/360*255))%256}};
xnm.aio.rgb.ArtNetNode=function(){var d=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3],a=function(a,c){this.ip=a;this.port=c;this.port||(this.port=6454)};a.prototype.executeCommandCreator=function(a,c,e){this._executeCommand(c,function(c){e&&e(c)})};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.ip==b.ip&&this.port==b.port:!1};a.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port}};a.prototype._executeCommand=function(a,c){if(a){switch(a.value){case "hex":a=
a.ext;break;default:c&&c(Error("no such command:"+a.value));return}a?(a=this._buildData(a),this._doRequest(a,function(){c&&c()})):c&&c(Error("command is empty"))}else c&&c(Error("command format invalid"))};a.prototype._buildData=function(a){0!=a.length%2&&(a="0"+a);var c=d.slice();c[16]=a.length/2>>8&15;c[17]=a.length/2&15;for(var b=0;b<a.length/2;b++){var f=a.substr(2*b,2);c.push(parseInt(f,16))}return c};a.prototype._doRequest=function(a,c){var b=require("dgram"),f=new Buffer(a),d=b.createSocket("udp4");
d.send(f,0,a.length,this.port,this.ip,function(a){d.close();c&&c(a)})};a._stateBuffer={};a.parseJSON=function(b){return b.ip?new a(b.ip,b.port):null};return a}();
xnm.aio.rgb.ArtNetNode.DM=function(){var d={command:[{type:"string",name:"HEX command",ref:{value:"hex",ext:"%s"}}]};return{SYS:"artnet",registModule:function(a){a.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"ArtNet Node"}},createDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid")):c(new b(e.INVALID,"info is invalid"))},updateDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;
a?a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid")):c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},getCommandStatusMap:function(){return d}}}();
xnm.aio.rgb.WiFiLED2=function(){var d=function(a,b){var c=require("x.logger.js");this._logger=c?c.getLogger("xnm.aio.rgb.WiFiLED2"):{log:function(){}};this.ip=a;this.port=b;this.port||(this.port=5E4)};d.prototype._doRequest=function(a,b){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(a));var c=require("dgram");a=new Buffer(a);var e=c.createSocket("udp4");e.send(a,0,a.length,this.port,this.ip,function(c){e.close();b&&setTimeout(function(){b(c)},250)})};d.prototype.executeCommand=
function(a,b){var c=[32,0,85];if("on"==a)c[0]=34;else if("off"==a)c[0]=33;else if("up"==a)c[0]=35;else if("down"==a)c[0]=36;else if("modeUp"==a)c[0]=39;else if("modeDown"==a)c[0]=40;else if("speedUp"==a)c[0]=37;else if("speedDown"==a)c[0]=38;else if("allBulbsOn"==a)c[0]=53;else if("allBulbsOff"==a)c[0]=57;else if("bulbUp"==a)c[0]=60;else if("bulbDown"==a)c[0]=52;else if("bulbLightUp"==a)c[0]=62;else if("bulbLightDown"==a)c[0]=63;else if("zone1On"==a)c[0]=56;else if("zone1Off"==a)c[0]=59;else if("zone2On"==
a)c[0]=61;else if("zone2Off"==a)c[0]=51;else if("zone3On"==a)c[0]=55;else if("zone3Off"==a)c[0]=58;else if("zone4On"==a)c[0]=50;else if("zone4Off"==a)c[0]=54;else if(6==a.length){var e=parseInt(a.substr(0,2),16),f=parseInt(a.substr(2,2),16);a=parseInt(a.substr(4,2),16);var d=0,h=85,k=a,l=f;a<=e&&a<=f?(k=f,l=e,d=86,h=170):f<=e&&f<=a&&(k=e,l=a,d=171,h=255);d=(255==k?d+l/255*((h-d)/2):h-k/255*((h-d)/2))+10;255<d&&(d-=255);0==e&&0==f&&0==a?c[0]=21:c[1]=d}this._doRequest(c,b)};d.prototype.executeCommandCreator=
function(a,b,c){a=b.value;if("rgb"==a||"rgbS"==a)a=b.ext;this.executeCommand(a,function(){c&&c()})};d.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rgb.WiFiLED2?this.ip==a.ip&&this.port==a.port:!1};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port):null};return d}();
xnm.aio.rgb.WiFiLED2.DM=function(){var d={command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"modeUp",ref:{value:"modeUp"}},{type:"enum",name:"modeDown",ref:{value:"modeDown"}},{type:"enum",name:"speedUp",ref:{value:"speedUp"}},{type:"enum",name:"speedDown",ref:{value:"speedDown"}},{type:"enum",name:"allBulbsOn",ref:{value:"allBulbsOn"}},{type:"enum",name:"allBulbsOff",
ref:{value:"allBulbsOff"}},{type:"enum",name:"bulbUp",ref:{value:"bulbUp"}},{type:"enum",name:"bulbDown",ref:{value:"bulbDown"}},{type:"enum",name:"bulbLightUp",ref:{value:"bulbLightUp"}},{type:"enum",name:"bulbLightDown",ref:{value:"bulbLightDown"}},{type:"enum",name:"zone1On",ref:{value:"zone1On"}},{type:"enum",name:"zone1Off",ref:{value:"zone1Off"}},{type:"enum",name:"zone2On",ref:{value:"zone2On"}},{type:"enum",name:"zone2Off",ref:{value:"zone2Off"}},{type:"enum",name:"zone3On",ref:{value:"zone3On"}},
{type:"enum",name:"zone3Off",ref:{value:"zone3Off"}},{type:"enum",name:"zone4On",ref:{value:"zone4On"}},{type:"enum",name:"zone4Off",ref:{value:"zone4Off"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]};return{SYS:"wifiled2",registModule:function(a){a.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"Wifi LED II"}},createDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;
a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid"))},updateDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid"))},deleteDevice:function(a,b,c){c()},getCommandStatusMap:function(){return d}}}();
xnm.aio.rgb.DMX4ALL=function(){var d=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3,0,0,0],a=function(a,c){this.ip=a;this.port=c;this.port||(this.port=6454)};a.prototype.executeCommandCreator=function(a,c,e){this._executeCommand(c,function(c){e&&e(c)})};a.prototype.equalsTo=function(b){return b&&b instanceof a?this.ip==b.ip&&this.port==b.port:!1};a.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port}};a.prototype._executeCommand=function(b,c){if(b){var e=
0,f=0,d=0,h=0,k=100;if(a._stateBuffer[this.ip]){var l=a._stateBuffer[this.ip];null!=l.red&&"undefined"!=typeof l.red&&(e=l.red);null!=l.green&&"undefined"!=typeof l.green&&(f=l.green);null!=l.blue&&"undefined"!=typeof l.blue&&(d=l.blue);null!=l.white&&"undefined"!=typeof l.white&&(h=l.white);null!=l.bri&&"undefined"!=typeof l.bri&&(k=l.bri)}switch(b.value){case "off":h=d=f=e=0;break;case "red":case "green":case "blue":case "white":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command red value invalid"));
return}if("number"==typeof b.ext)switch(b.value){case "red":e=parseInt(b.ext);break;case "green":f=parseInt(b.ext);break;case "blue":d=parseInt(b.ext);break;case "white":h=parseInt(b.ext)}else if(b.ext.match(/^[-+]?[0-9]+$/))switch(b.value){case "red":e=parseInt(b.ext);break;case "green":f=parseInt(b.ext);break;case "blue":d=parseInt(b.ext);break;case "white":h=parseInt(b.ext)}else{c&&c(Error("command red value invalid"));return}break;case "rgb":case "rgbS":if(!b.ext||6>b.ext.length){c&&c(Error("command rgb value invalid"));
return}e=parseInt(b.ext.substr(0,2),16);f=parseInt(b.ext.substr(2,2),16);d=parseInt(b.ext.substr(4,2),16);break;case "rgbw":case "rgbwS":if(!b.ext||8>b.ext.length){c&&c(Error("command rgbw value invalid"));return}e=parseInt(b.ext.substr(0,2),16);f=parseInt(b.ext.substr(2,2),16);d=parseInt(b.ext.substr(4,2),16);h=parseInt(b.ext.substr(6,2),16);break;case "brightness":if(null==b.ext||"undefined"==typeof b.ext){c&&c(Error("command brightness value invalid"));return}if("number"==typeof b.ext)k=parseInt(b.ext);
else if(b.ext.match(/^[-+]?[0-9]+$/))k=parseInt(b.ext);else{c&&c(Error("command brightness value invalid"));return}break;default:c&&c(Error("no such command:"+b.value));return}a._stateBuffer[this.ip]={red:e,green:f,blue:d,white:h,bri:k};b=this._buildColor(e,f,d,h,k/100);this._doRequest(new Buffer(b),function(){c&&c()})}else c&&c(Error("command format invalid"))};a.prototype._buildColor=function(a,c,e,f,g){a=Math.round(a*g);c=Math.round(c*g);e=Math.round(e*g);f=Math.round(f*g);255<a&&(a=255);255<c&&
(c=255);255<e&&(e=255);255<f&&(f=255);g=d.slice();g[17]=4;g[18]=a;g[19]=c;g[20]=e;g.push(f);return g};a.prototype._doRequest=function(a,c){var b=require("dgram").createSocket("udp4");b.send(a,0,a.length,this.port,this.ip,function(a){b.close();c&&c(a)})};a._stateBuffer={};a._discovery=function(b,c){if(!a._logger){var e=require("x.logger.js");a._logger=e?e.getLogger("xnm.aio.rgb.DMX4ALL"):{log:function(){}}}var f=function(c,b){var f=b,e=require("dgram").createSocket("udp4");e.on("listening",function(){a._logger.log("trace",
"sender socket started:"+c);e.setBroadcast(!0);f&&(f(null,e),f=null)});e.on("error",function(c){f&&(f(c),f=null)});e.bind(null,c)},d=function(c){var a=[],b=[],e=require("os");require("dgram");if(e&&e.networkInterfaces){e=e.networkInterfaces();for(var d in e)if(e.hasOwnProperty(d))for(var g=e[d],h=0;h<g.length;h++)"IPv4"==g[h].family&&0==g[h].internal&&a.push(g[h].address)}else a.push("0.0.0.0");var k=0;for(d=0;d<a.length;d++)e=a[d],"0.0.0.0"==e&&(e=null),f(e,function(e,f){k++;!e&&f&&b.push(f);k==
a.length&&c&&c(null,b)})},h=function(c,a){if(0==c.length)a();else for(var b=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]),e=0,f=0;f<c.length;f++)c[f].send(b,0,b.length,6454,"255.255.255.255",function(){e++;e==c.length&&a()})};if(c){this._discoveryCallback||(this._discoveryCallback=[]);e=!1;for(var k=0;k<this._discoveryCallback.length;k++)if(this._discoveryCallback[k]===c){e=!0;break}e||this._discoveryCallback.push(c);if(!this._discoverRunning){this._discoverResults={};this._discoverRunning=
!0;var l,n,p=this._discoverResults,m=this;(function(c,b){var e=require("dgram"),f=b,d=e.createSocket("udp4");d.on("listening",function(){a._logger.log("trace","listener socket started");d.setBroadcast(!0);f&&(f(null,d),f=null)});d.on("message",function(a,b){c(a,b)});d.on("error",function(c){f?(a._logger.log("warn","create listener socket error:"+c),f(c),f=null):a._logger.log("warn","listener socket error:"+c)});d.bind(6454)})(function(c){c=c.toString("hex");var b=c.substr(0,16);if(16<c.length&&"4172742d4e657400"==
b.toLowerCase()&&(b=c.substr(16,4),20<c.length&&"0021"==b.toLowerCase()&&28<c.length)){var e=parseInt(c.substr(20,2),16)+"."+parseInt(c.substr(22,2),16)+"."+parseInt(c.substr(24,2),16)+"."+parseInt(c.substr(26,2),16);b=c.substr(48,4);52<c.length&&"1a2c"==b.toLowerCase()&&(b=c.substr(52,36),88<c.length&&"4172744e65742d4c45442044696d6d657200"==b.toLowerCase()&&(p[e]=new a(e)))}},function(c,a){if(c){for(a=0;a<m._discoveryCallback.length;a++)m._discoveryCallback[a](c);m._discoverRunning=!1}else l=a,d(function(c,
a){if(c){for(a=0;a<m._discoveryCallback.length;a++)m._discoveryCallback[a](c);m._discoverRunning=!1;l.end()}else n=a,h(n,function(){setTimeout(function(){for(var c=0;c<n.length;c++)n[c].close();l.close();for(c=0;c<m._discoveryCallback.length;c++){var a=[],b;for(b in m._discoverResults)m._discoverResults.hasOwnProperty(b)&&a.push(m._discoverResults[b]);m._discoveryCallback[c](null,a)}m._discoverRunning=!1;m._discoveryCallback=[]},b)})})})}}};a.parseJSON=function(b){return b.ip?new a(b.ip,b.port):null};
return a}();
xnm.aio.rgb.DMX4ALL.DM=function(){var d={command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"int",name:"red",ref:{value:"red",ext:"%d",extMeta:"0-255"}},{type:"int",name:"green",ref:{value:"green",ext:"%d",extMeta:"0-255"}},{type:"int",name:"blue",ref:{value:"blue",ext:"%d",extMeta:"0-255"}},{type:"int",name:"white",ref:{value:"white",ext:"%d",extMeta:"0-255"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"int",
name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100"}},{type:"string",name:"rgb+white color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}}]};return{SYS:"dmx4all",registModule:function(a){a.register(this.SYS,"rgb")},getIPDeviceType:function(){return{sys:this.SYS,name:"DMX4ALL"}},createDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid")):c(new b(e.INVALID,
"info is invalid"))},updateDevice:function(a,b,c){b=xnm.aio.rgb.DMError;var e=xnm.aio.rgb.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new b(e.INVALID,"ip is invalid")):c(new b(e.INVALID,"info is invalid"))},deleteDevice:function(a,b,c){c()},getCommandStatusMap:function(){return d}}}();
xnm.aio.rgb.MiLight=function(){var d=function(a,b,c){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.rgb.MiLight"):{log:function(){}};this.ip=a;this.port=b;this.port||(this.port=8899);this.uuid=c};d.prototype._doRequest=function(a,b){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(a));var c=require("dgram");a=new Buffer(a);var e=c.createSocket("udp4"),f=this;e.send(a,0,a.length,this.port,this.ip,function(c){c&&f._logger.log("warn","send data error:"+c.message);
e.close();b&&setTimeout(function(){b(c)},250)})};d.prototype.executeCommand=function(a,b,c){if(a&&a.type&&null!=b&&"undefined"!=typeof b)switch(a.type){case "easy_rgbw":case "easy_white":if(null==a.address||"undefined"==typeof a.address){c&&c(Error("address invalid"));break}"easy_rgbw"==a.type?this._execEasyRGBW(a.address,b,c):this._execEasyWhite(a.address,b,c);break;case "rgb":this._execRGB(b,c);break;default:c&&c(Error(a.type+" not supported"))}else c&&c(Error("argument invalid"))};d.prototype.executeCommandCreator=
function(a,b,c){if(a&&a.type&&b){var e=b.value;switch(a.type){case "easy_rgbw":case "easy_white":switch(b.value){case "brightness":case "rgbS":case "rgb":e=b.ext}break;case "rgb":switch(b.value){case "rgbS":case "rgb":e=b.ext}}null==e||"undefined"==typeof e?c&&c(Error("command invalid")):this.executeCommand(a,e,function(a){c&&c(a)})}else c&&c(Error("argument invalid"))};d.prototype._execEasyRGBW=function(a,b,c){var e=this;switch(b){case "speedDown":case "speedUp":case "discoMode":case "on":case "off":var f=
this._buildEasyRGBWData(a,b);this._doRequest(f,c);break;default:"white"==b||6==b.length||0<=parseInt(b)&&100>=parseInt(b)?(f=this._buildEasyRGBWData(a,"on"),this._doRequest(f,function(d){d?c&&c(d):(f=e._buildEasyRGBWData(a,b),setTimeout(function(){e._doRequest(f,c)},100))})):c&&c(Error("no such command"))}};d.prototype._buildEasyRGBWData=function(a,b){a=parseInt(a);var c=[255,0,85];switch(b){case "speedDown":c[0]=67;break;case "speedUp":c[0]=68;break;case "discoMode":c[0]=77;break;case "on":switch(a){case 0:c[0]=
66;break;case 1:c[0]=69;break;case 2:c[0]=71;break;case 3:c[0]=73;break;case 4:c[0]=75}break;case "off":switch(a){case 0:c[0]=65;break;case 1:c[0]=70;break;case 2:c[0]=72;break;case 3:c[0]=74;break;case 4:c[0]=76}break;case "white":switch(a){case 0:c[0]=194;break;case 1:c[0]=197;break;case 2:c[0]=199;break;case 3:c[0]=201;break;case 4:c[0]=203}break;default:if(6==b.length){var e=parseInt(b.substr(0,2),16),f=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);var d=0;var h=85,k=b,l=f;b<=e&&b<=
f?(k=f,l=e,d=86,h=170):f<=e&&f<=b&&(k=e,l=b,d=171,h=255);d=(255==k?d+l/255*((h-d)/2):h-k/255*((h-d)/2))+10;255<d&&(d-=255);if(0==e&&0==f&&0==b)return this._buildEasyRGBWData(a,"off");c[0]=64;c[1]=d}else if(0<=parseInt(b)&&100>=parseInt(b)){d=Math.round(parseInt(b)/100*26)+1;1>d?d=1:27<d&&(d=27);if(1==d)return this._buildEasyRGBWData(a,"off");c[0]=78;c[1]=d}}return 255==c[0]?null:c};d.prototype._execEasyWhite=function(a,b,c){var e=this;switch(b){case "briUp":case "briDown":case "warmUp":case "coolUp":case "on":case "off":var f=
this._buildEasyWhiteData(a,b);this._doRequest(f,c);break;case "night":case "fullbri":f="night"==b?this._buildEasyWhiteData(a,"off"):this._buildEasyWhiteData(a,"on");this._doRequest(f,function(d){d?c&&c(d):(f=e._buildEasyWhiteData(a,b),setTimeout(function(){e._doRequest(f,c)},100))});break;default:c&&c(Error("no such command"))}};d.prototype._buildEasyWhiteData=function(a,b){a=parseInt(a);var c=[255,0,85];switch(b){case "briUp":c[0]=60;break;case "briDown":c[0]=52;break;case "warmUp":c[0]=62;break;
case "coolUp":c[0]=63;break;case "on":switch(a){case 0:c[0]=53;break;case 1:c[0]=56;break;case 2:c[0]=61;break;case 3:c[0]=55;break;case 4:c[0]=50}break;case "off":switch(a){case 0:c[0]=57;break;case 1:c[0]=59;break;case 2:c[0]=51;break;case 3:c[0]=58;break;case 4:c[0]=54}break;case "night":switch(a){case 0:c[0]=185;break;case 1:c[0]=187;break;case 2:c[0]=179;break;case 3:c[0]=186;break;case 4:c[0]=182}break;case "fullbri":switch(a){case 0:c[0]=181;break;case 1:c[0]=184;break;case 2:c[0]=189;break;
case 3:c[0]=183;break;case 4:c[0]=178}}return 255==c[0]?null:c};d.prototype._execRGB=function(a,b){var c=this;switch(a){case "speedDown":case "speedUp":case "briUp":case "briDown":case "modeUp":case "modeDown":case "on":case "off":var e=this._buildRGBData(a);this._doRequest(e,b);break;default:6==a.length?(e=this._buildRGBData("on"),this._doRequest(e,function(f){f?b&&b(f):(e=c._buildRGBData(a),setTimeout(function(){c._doRequest(e,b)},100))})):b&&b(Error("no such command"))}};d.prototype._buildRGBData=
function(a){var b=[255,0,85];switch(a){case "off":b[0]=33;break;case "on":b[0]=34;break;case "briUp":b[0]=35;break;case "briDown":b[0]=36;break;case "speedUp":b[0]=37;break;case "speedDown":b[0]=38;break;case "modeUp":b[0]=39;break;case "modeDown":b[0]=40;break;default:if(6==a.length){var c=parseInt(a.substr(0,2),16),e=parseInt(a.substr(2,2),16);a=parseInt(a.substr(4,2),16);var f=0,d=85,h=a,k=e;a<=c&&a<=e?(h=e,k=c,f=86,d=170):e<=c&&e<=a&&(h=c,k=a,f=171,d=255);f=(255==h?f+k/255*((d-f)/2):d-h/255*((d-
f)/2))+10;255<f&&(f-=255);if(0==c&&0==e&&0==a)return this._buildRGBData("off");b[0]=32;b[1]=f}}return 255==b[0]?null:b};d.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rgb.MiLight?this.ip==a.ip&&this.port==a.port:!1};d.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLight.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};d.parseJSON=function(a){return a.ip?new d(a.ip,a.port,a.uuid):null};return d}();
xnm.aio.rgb.MiLight.Discovery=function(){var d=function(){var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.rgb.MiLight.Discovery"):{log:function(){}};this._searching=!1;this._tempCallbacks=[];this._callbacks=[];this._controllers={};this._sockets=[];a=require("os");require("dgram");if(a&&a.networkInterfaces){a=a.networkInterfaces();for(var b in a)if(a.hasOwnProperty(b))for(var c=a[b],e=0;e<c.length;e++)this._addDiscoverSocket(48899,c[e])}else this._addDiscoverSocket(48899,null)};d.prototype.discoverDevices=
function(a){this._addCallback(a,this._callbacks);this._sendDiscoveryMessages()};d.prototype.discoverWithTimeout=function(a,b){this._addCallback(b,this._tempCallbacks);this._searching||(this._controllers={},this._searching=!0,this._sendDiscoveryMessages());var c=this;setTimeout(function(){c._removeCallback(b,c._tempCallbacks);var a=[],f;for(f in c._controllers)c._controllers.hasOwnProperty(f)&&c._controllers[f]&&a.push(c._controllers[f]);b(a);0==c._tempCallbacks.length&&(c._searching=!1)},a)};d.prototype._addCallback=
function(a,b){if(a)for(var c=0;c<b.length;c++)if(b[c]===a)return;b.push(a)};d.prototype._removeCallback=function(a,b){if(a){for(var c=-1,e=0;e<b.length;e++)if(b[e]===a){c=e;break}-1!=c&&b.splice(c,1)}};d.prototype._addDiscoverSocket=function(a,b){var c=require("dgram"),e=this;try{var f=c.createSocket({reuseAddr:!0,type:"udp4"})}catch(g){f=c.createSocket("udp4")}b?"IPv4"==b.family&&0==b.internal&&(f.on("listening",function(){f.setBroadcast(!0)}),f.on("message",function(c,a){e._receivedData(a.address,
c)}),f.on("error",function(c){e._logger.log("warn","milight listener error on address:"+b.address+" mesage:"+(c?c.message:null))}),f.bind(a,b.address),this._logger.log("start listener on address:"+b.address+"-port:"+a),this._sockets.push(f)):(f.on("message",function(c,a){e._receivedData(a.address,c)}),f.on("error",function(c){e._logger.log("warn","milight listener error:"+(c?c.message:null))}),f.bind(a),this._logger.log("debug","start listener on address:[ANY]-port:"+a),this._sockets.push(f))};d.prototype._receivedData=
function(a,b){"object"==typeof b&&(b=b.toString());this._logger.log("trace","receive discovery response:"+b);var c=b.split(",");if(2<=c.length&&(b=c[0],a=c[1],c=c[2],b&&a))for(b=c?new xnm.aio.rgb.MiLightV6(b,null,a):new xnm.aio.rgb.MiLight(b,null,a),this._controllers[a]=b,a=0;a<this._callbacks.length;a++)if(this._callbacks[a])this._callbacks[a](b)};d.prototype._sendDiscoveryMessages=function(){for(var a="Link_Wi-Fi",b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,48899,"255.255.255.255");
a="HF-A11ASSISTHREAD";for(b=0;b<this._sockets.length;b++)this._sockets[b].send(a,0,a.length,48899,"255.255.255.255")};return d}();
xnm.aio.rgb.MiLight.DM=function(){return{SYS:"milight",MAP:{easy_rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]},easy_rgbw_all:{command:[{type:"enum",name:"disco mode",ref:{value:"discoMode"}},
{type:"enum",name:"disco speed up",ref:{value:"speedUp"}},{type:"enum",name:"disco speed down",ref:{value:"speedDown"}}]},easy_white:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night mode",ref:{value:"night"}},{type:"enum",name:"full brightness",ref:{value:"fullbri"}}]},easy_white_all:{command:[{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"warm white up",
ref:{value:"warmUp"}},{type:"enum",name:"cool white up",ref:{value:"coolUp"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}},
{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]}},registModule:function(d){d.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,name:"Mi.Light Controller (WiFi)",port:8899}},getGatewayDeviceType:function(d){return d.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"MultiZone RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"MultiZone White Bulb"},{sys:this.SYS,type:"rgb",name:"SingleZone RGB Bulb"}]:null},
createGateway:function(d,a,b){a=xnm.aio.rgb.DMError;var c=xnm.aio.rgb.DMError.ERROR_CODE;d?d.ip?b(null,d):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){d=xnm.aio.rgb.DMError;b=xnm.aio.rgb.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.gateway)if(null==
d.type||"undefined"==typeof d.type)b(new c(e.INVALID,"type is invalid"));else{if("easy_rgbw"==d.type||"easy_white"==d.type)if(null==d.address||"undefined"==typeof d.address){b(new c(e.INVALID,"address is invalid"));return}if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?b(null,d):b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+
" not exists"))}else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)b(new c(e.INVALID,"type is invalid"));else{if("easy_rgbw"==d.type||"easy_white"==d.type)if(null==d.address||"undefined"==typeof d.address){b(new c(e.INVALID,"address is invalid"));return}if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=
a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?b(null,d):b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){b()},getCommandStatusMap:function(d){if(!d)return null;var a=null;switch(d.type){case "easy_rgbw":a=JSON.parse(JSON.stringify(this.MAP.easy_rgbw));
0==parseInt(d.address)&&(d=JSON.parse(JSON.stringify(this.MAP.easy_rgbw_all)),a.command=a.command.concat(d.command));break;case "easy_white":a=JSON.parse(JSON.stringify(this.MAP.easy_white));0==parseInt(d.address)&&(d=JSON.parse(JSON.stringify(this.MAP.easy_white_all)),a.command=a.command.concat(d.command));break;case "rgb":a=JSON.parse(JSON.stringify(this.MAP.rgb))}return a}}}();
xnm.aio.rgb.MiLightV6=function(){var d={bridges:{},socket:null,init:function(){this.socket=new a(this)},receiveData:function(c,a){(c=this.bridges[c])&&c.receiveData(a)},getBridge:function(c){return this.bridges[c]},setBridge:function(c,a){this.bridges[c]=a},sendPacket:function(c,a,b){this.socket&&this.socket.sendPacket(c,a,b)}},a=function(c){var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.rgb.MiLightV6.UdpSocket"):{log:function(){}};this._listener=c;this._sockets=[];c=require("os");
require("dgram");if(c&&c.networkInterfaces){c=c.networkInterfaces();for(var b in c)if(c.hasOwnProperty(b)){a=c[b];for(var d=0;d<a.length;d++)this._addDiscoverSocket(5987,a[d])}}else this._addDiscoverSocket(5987,null)};a.prototype._receivedData=function(c,a){a=a.toString("hex");a=new Buffer(a,"hex");this._listener&&this._listener.receiveData(c,a)};a.prototype._addDiscoverSocket=function(c,a){var b=require("dgram"),d=this;if(!a){try{var e=b.createSocket({reuseAddr:!0,type:"udp4"})}catch(k){e=b.createSocket("udp4")}e.on("message",
function(c,a){d._receivedData(a.address,c)});e.on("error",function(a){d._logger.log("error","udp socket at"+c+" error:"+a.message)});e.bind(c);this._sockets.push(e)}else if("IPv4"==a.family&&0==a.internal){try{e=b.createSocket({reuseAddr:!0,type:"udp4"})}catch(k){e=b.createSocket("udp4")}e.on("listening",function(){e.setBroadcast(!0)});e.on("message",function(c,a){d._receivedData(a.address,c)});e.on("error",function(b){d._logger.log("error","udp socket at"+c+"@"+a.address+" error:"+b.message)});e.bind(c,
a.address);this._sockets.push(e)}};a.prototype.sendPacket=function(c,a,b){for(var d=0;d<this._sockets.length;d++)this._sockets[d].send(c,0,c.length,b,a)};var b=function(c,a,b){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.rgb.MiLightV6"):{log:function(){}};this.ip=c;this.port=a;this.port||(this.port=5987);this.uuid=b;d.getBridge(c)||d.setBridge(c,this);this._packetBuffer=[];this._sessionCreating=!1;this._session=this._sessionCreateTimeout=null;this._seqNo=-1};b.prototype.executeCommandCreator=
function(c,a,b){if(c&&c.type&&a){switch(c.type){case "wifi_box":var d=this._buildWifiBoxCommand(a.value,a.ext);break;case "rgb":d=this._buildRGBCommand(a.value,a.ext);break;case "rgbw":if("undefined"==typeof c.address||null==c.address){b&&b(Error("device has no address"));return}d=this._buildRGBWCommand(c.address,a.value,a.ext);break;case "rgbww_cw":if("undefined"==typeof c.address||null==c.address){b&&b(Error("device has no address"));return}d=this._buildRGBWWCommand(c.address,a.value,a.ext);break;
case "ww_cw":if("undefined"==typeof c.address||null==c.address){b&&b(Error("device has no address"));return}d=this._buildWWCommand(c.address,a.value,a.ext)}d?this.sendCommand(d,function(a){b&&b(a)}):b&&b(Error("command invalid"))}else b&&b(Error("argument invalid"))};b.prototype._buildWifiBoxCommand=function(a,b){var c=[49,0,0,0,255,255,0,0,0,1];switch(a){case "on":c[4]=3;c[5]=3;break;case "off":c[4]=3;c[5]=4;break;case "white":c[4]=3;c[5]=5;break;case "speedUp":c[4]=3;c[5]=2;break;case "speedDown":c[4]=
3;c[5]=1;break;case "mode":if(!c)return null;c[4]=4;c[5]=parseInt(b);break;case "brightness":c[4]=2;c[5]=parseInt(b);break;case "rgb":case "rgbS":if(!b||6>b.length)return null;a=parseInt(b.substr(0,2),16);var d=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);b=xnm.aio.rgb.Util.rgbToHue(a,d,b);b=Math.min(Math.max(b,0),255);b=255-b-82;0>b&&(b=255+b);c[4]=1;c[5]=b;c[6]=b;c[7]=b;c[8]=b;break;default:return null}return c};b.prototype._buildRGBWWCommand=function(c,a,b){var d=[49,0,0,8,255,255,0,
0,0,255];d[9]=parseInt(c);switch(a){case "on":d[4]=4;d[5]=1;break;case "off":d[4]=4;d[5]=2;break;case "night":d[4]=4;d[5]=5;break;case "white":d[4]=5;d[5]=100;break;case "speedUp":d[4]=4;d[5]=3;break;case "speedDown":d[4]=4;d[5]=4;break;case "mode":if(!d)return null;d[4]=6;d[5]=parseInt(b);break;case "brightness":d[4]=3;d[5]=parseInt(b);break;case "saturation":d[4]=2;d[5]=parseInt(b);break;case "kelvin":d[4]=5;b=(parseInt(b)-2700)/18;0>b&&(b=0);100<b&&(b=100);d[5]=b;break;case "rgb":case "rgbS":if(!b||
6>b.length)return null;c=parseInt(b.substr(0,2),16);a=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);b=xnm.aio.rgb.Util.rgbToHue(c,a,b);b=Math.min(Math.max(b,0),255);b=255-b-82;0>b&&(b=255+b);d[4]=1;d[5]=b;d[6]=b;d[7]=b;d[8]=b;break;default:return null}return d};b.prototype._buildRGBWCommand=function(c,a,b){var d=[49,0,0,7,255,255,0,0,0,255];d[9]=parseInt(c);switch(a){case "on":d[4]=3;d[5]=1;break;case "off":d[4]=3;d[5]=2;break;case "night":d[4]=3;d[5]=6;break;case "white":d[4]=3;d[5]=5;
break;case "speedUp":d[4]=3;d[5]=3;break;case "speedDown":d[4]=3;d[5]=4;break;case "mode":if(!d)return null;d[4]=4;d[5]=parseInt(b);break;case "brightness":d[4]=2;d[5]=parseInt(b);break;case "rgb":case "rgbS":if(!b||6>b.length)return null;c=parseInt(b.substr(0,2),16);a=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);b=xnm.aio.rgb.Util.rgbToHue(c,a,b);b=Math.min(Math.max(b,0),255);b=255-b-55;0>b&&(b=255+b);d[4]=1;d[5]=b;d[6]=b;d[7]=b;d[8]=b;break;default:return null}return d};b.prototype._buildRGBCommand=
function(a,b){var c=[49,0,0,5,255,255,0,0,0,1];switch(a){case "on":c[4]=2;c[5]=9;break;case "off":c[4]=2;c[5]=10;break;case "briUp":c[4]=2;c[5]=1;break;case "briDown":c[4]=2;c[5]=2;break;case "speedUp":c[4]=2;c[5]=3;break;case "speedDown":c[4]=2;c[5]=4;break;case "modeUp":c[4]=2;c[5]=5;break;case "modeDown":c[4]=2;c[5]=6;break;case "rgb":case "rgbS":if(!b||6>b.length)return null;a=parseInt(b.substr(0,2),16);var d=parseInt(b.substr(2,2),16);b=parseInt(b.substr(4,2),16);b=xnm.aio.rgb.Util.rgbToHue(a,
d,b);b=Math.min(Math.max(b,0),255);b=255-b-55;0>b&&(b=255+b);c[4]=1;c[5]=b;c[6]=b;c[7]=b;c[8]=b;break;default:return null}return c};b.prototype._buildWWCommand=function(c,a,b){b=[49,0,0,1,255,255,0,0,0,255];b[9]=parseInt(c);switch(a){case "on":b[4]=1;b[5]=7;break;case "off":b[4]=1;b[5]=8;break;case "night":b[4]=1;b[5]=6;break;case "briUp":b[4]=1;b[5]=1;break;case "briDown":b[4]=1;b[5]=2;break;case "briMax":b[4]=129;b[5]=7;break;case "warmer":b[4]=1;b[5]=3;break;case "cooler":b[4]=1;b[5]=4;break;default:return null}return b};
b.prototype.sendCommand=function(c,a){this._logger.log("trace","start send command");var b=this._packetBuffer.length;this._packetBuffer.push({command:c,callback:a});null!=this._session||this._sessionCreating?this._session&&0==b&&this._sendNextPacket():this._createSession()};b.prototype._buildPacket=function(c,a,b){var d=[128,0,0,0,17,255,255,0,255,0,255,255,255,255,255,255,255,255,255,255,0,255];d[5]=a[0];d[6]=a[1];d[8]=b;for(a=0;a<c.length;a++)d[10+a]=c[a];for(b=a=0;b<c.length;b++)a+=c[b];d[21]=
a&255;return new Buffer(d)};b.prototype._sendNextPacket=function(){if(0<this._packetBuffer.length){var a=this._packetBuffer[0];if(a){if(a.command){var b=this._buildPacket(a.command,this._session,this._seqNo++);this._logger.log("trace","send command:"+b.toString("hex"));d.sendPacket(b,this.ip,this.port)}a.callback&&a.callback()}this._packetBuffer.splice(0,1);this._sendNextPacket()}else this._sessionCreating=!1,this._session=this._sessionCreateTimeout=null,this._seqNo=-1};b.prototype._cancelAllPacket=
function(){var a=this._packetBuffer;this._packetBuffer=[];for(var b=0;b<a.length;b++){var d=a[b];d&&d.callback&&d.callback(Error("can not create session"))}};b.prototype._createSession=function(){if(!this._sessionCreating){this._sessionCreating=!0;var a=this,b=new Buffer([32,0,0,0,22,2,98,58,213,237,163,1,174,8,45,70,97,65,167,246,220,175,211,230,0,0,30]);this._logger.log("trace","start session:"+b.toString("hex"));d.sendPacket(b,this.ip,this.port);setTimeout(function(){a._sessionCreated(!1)},2E3)}};
b.prototype._sessionCreated=function(a){a?(this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._seqNo=0,this._sendNextPacket()):(this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._session=null,this._seqNo=-1,this._cancelAllPacket())};b.prototype.receiveData=function(a){this._logger.log("trace","receive ("+this.ip+") data:"+a.toString("hex"));
if(40==a[0]){this._session=[];for(var b=19;21>b;b++)this._session.push(a[b]);this._logger.log("trace","get session id:"+(new Buffer(this._session)).toString("hex"));this._sessionCreated(!0)}};b.prototype.equalsTo=function(a){return a&&a instanceof xnm.aio.rgb.MiLightV6?this.ip==a.ip&&this.port==a.port:!1};b.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLightV6.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};b.parseJSON=function(a){if(!a.ip)return null;var c=new b(a.ip,a.port,a.uuid);return(a=
d.getBridge(a.ip))?a:c};b.init=function(){d.init()};return b}();
xnm.aio.rgb.MiLightV6.DM=function(){return{SYS:"milightv6",MAP:{wifi_box:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",
ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},ww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"max brightness",ref:{value:"briMax"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"warmer",ref:{value:"warmer"}},{type:"enum",name:"cooler",
ref:{value:"cooler"}}]},rgbww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"saturation",ref:{value:"saturation",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"kelvin",ref:{value:"kelvin",ext:"%d",extMeta:"2700-6500",scale:"18"}},{type:"string",
name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",
name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",
ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}}]}},registModule:function(d){d.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,
name:"Mi.Light iBox",port:5987}},getGatewayDeviceType:function(d){return d.sys==this.SYS?[{sys:this.SYS,type:"wifi_box",name:"WIFI Box"},{sys:this.SYS,type:"rgbww_cw",name:"RGBWW/CW Bulb"},{sys:this.SYS,type:"rgbw",name:"RGBW Bulb"},{sys:this.SYS,type:"rgb",name:"RGB Bulb"},{sys:this.SYS,type:"ww_cw",name:"WW/CW Bulb"}]:null},createGateway:function(d,a,b){a=xnm.aio.rgb.DMError;var c=xnm.aio.rgb.DMError.ERROR_CODE;d?d.ip?b(null,d):b(new a(c.INVALID,"ip is invalid")):b(new a(c.INVALID,"info is invalid"))},
updateGateway:function(d,a,b,c){d=xnm.aio.rgb.DMError;b=xnm.aio.rgb.DMError.ERROR_CODE;a?a.ip?c(null,a):c(new d(b.INVALID,"ip is invalid")):c(new d(b.INVALID,"update is invalid"))},deleteGateway:function(d,a,b){b()},createDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)b(new c(e.INVALID,"type is invalid"));else if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===
d.gateway){var g=a[f];break}g?b(null,d):b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"));else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.gateway)if(null==d.type||"undefined"==typeof d.type)b(new c(e.INVALID,"type is invalid"));else{if("easy_rgbw"==d.type||"easy_white"==
d.type)if(null==d.address||"undefined"==typeof d.address){b(new c(e.INVALID,"address is invalid"));return}if(a.data&&a.data.gateways&&0!==a.data.gateways.length){a=a.data.gateways;var f;for(f=0;f<a.length;f++)if(a[f].index===d.gateway){var g=a[f];break}g?b(null,d):b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.NOT_FOUND,"gateway with index "+d.gateway+" not exists"))}else b(new c(e.INVALID,"gateway is invalid"));else b(new c(e.INVALID,"info is invalid"))},deleteDevice:function(d,
a,b){b()},getCommandStatusMap:function(d){return d?this.MAP[d.type]:null}}}();
xnm.aio.rgb.EasyLED=function(){var d=function(a,b,c){xnm.aio.rgb.MiLight.call(this,a,b,c);this._logger=(a=require("x.logger.js"))?a.getLogger("xnm.aio.rgb.EasyLED"):{log:function(){}}};d.prototype=Object.create(xnm.aio.rgb.MiLight.prototype);d.prototype.constructor=d;d.prototype.equalsTo=function(a){return a&&a instanceof d?this.ip==a.ip&&this.port==a.port:!1};d.prototype.toJSON=function(){return{sys:xnm.aio.rgb.EasyLED.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid}};d.parseJSON=function(a){return a.ip?
new d(a.ip,a.port,a.uuid):null};return d}();
xnm.aio.rgb.EasyLED.DM=function(){return{SYS:"easyled",registModule:function(d){d.register(this.SYS,"rgb")},getGatewayType:function(){return{sys:this.SYS,name:"EasyLED Controller (WiFi)",port:8899}},getGatewayDeviceType:function(d){return d.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"Easy RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"Easy White Bulb"}]:null},createGateway:function(d,a,b){xnm.aio.rgb.MiLight.DM.createGateway(d,a,b)},updateGateway:function(d,a,b,c){xnm.aio.rgb.MiLight.DM.updateGateway(d,
a,b,c)},deleteGateway:function(d,a,b){xnm.aio.rgb.MiLight.DM.deleteGateway(d,a,b)},createDevice:function(d,a,b){xnm.aio.rgb.MiLight.DM.createDevice(d,a,b)},updateDevice:function(d,a,b){xnm.aio.rgb.MiLight.DM.updateDevice(d,a,b)},deleteDevice:function(d,a,b){xnm.aio.rgb.MiLight.DM.deleteDevice(d,a,b)},getCommandStatusMap:function(d){return xnm.aio.rgb.MiLight.DM.getCommandStatusMap(d)}}}();
xnm.aio.rgb.DMError=function(){var d=function(a,b){this.code=a;this.message=b;this.stack=Error().stack};d.prototype=Error();d.prototype.name="RgbDmError";d.prototype.code=0;d.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};return d}();
xnm.aio.rgb.DM=function(){return{getGatewayType:function(){var d=[],a;for(a in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(a)){var b=xnm.aio.rgb[a];b&&b.DM&&b.DM.getGatewayType&&(b=b.DM.getGatewayType())&&d.push(b)}return d},getGatewayDeviceType:function(d){var a=[],b;for(b in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(b)){var c=xnm.aio.rgb[b];c&&c.DM&&c.DM.getGatewayDeviceType&&(c=c.DM.getGatewayDeviceType(d))&&(Array.isArray(c)?a=a.concat(c):a.push(c))}return a},getIPDeviceType:function(d,a){var b=
[],c;for(c in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(c)){var e=xnm.aio.rgb[c];e&&e.DM&&e.DM.getIPDeviceType&&(e=e.DM.getIPDeviceType(d,a))&&b.push(e)}return b},_getSystem:function(d){for(var a in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(a)){var b=xnm.aio.rgb[a];if(b&&b.DM&&b.DM.SYS&&b.DM.SYS==d)return b}return null},createGateway:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.createGateway?f.DM.createGateway(d,
a,b):b&&b(new c(e.INVALID,"no such sys:"+d.sys))}else b&&b(new c(e.INVALID,"sys is invalid"));else b&&b(new c(e.INVALID,"info is invalid"))},updateGateway:function(d,a,b,c){var e=xnm.aio.rgb.DMError,f=xnm.aio.rgb.DMError.ERROR_CODE;if(a)if(a.sys){var g=this._getSystem(a.sys);g&&g.DM&&g.DM.updateGateway?g.DM.updateGateway(d,a,b,c):c&&c(new e(f.INVALID,"no such sys:"+a.sys))}else c&&c(new e(f.INVALID,"sys is invalid"));else c(new e(f.INVALID,"info is invalid"))},deleteGateway:function(d,a,b){var c=
xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.deleteGateway?f.DM.deleteGateway(d,a,b):b&&b(new c(e.INVALID,"no such sys:"+d.sys))}else b&&b(new c(e.INVALID,"sys is invalid"));else b()},createDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.createDevice?f.DM.createDevice(d,a,b):b&&b(new c(e.INVALID,"no such sys:"+d.sys))}else b&&b(new c(e.INVALID,
"sys is invalid"));else b&&b(new c(e.INVALID,"info is invalid"))},updateDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);f&&f.DM&&f.DM.updateDevice?f.DM.updateDevice(d,a,b):b&&b(new c(e.INVALID,"no such sys:"+d.sys))}else b&&b(new c(e.INVALID,"sys is invalid"));else b(new c(e.INVALID,"info is invalid"))},deleteDevice:function(d,a,b){var c=xnm.aio.rgb.DMError,e=xnm.aio.rgb.DMError.ERROR_CODE;if(d)if(d.sys){var f=this._getSystem(d.sys);
f&&f.DM&&f.DM.deleteDevice?f.DM.deleteDevice(d,a,b):b&&b(new c(e.INVALID,"no such sys:"+d.sys))}else b&&b(new c(e.INVALID,"sys is invalid"));else b()},applyUIFilter:function(d,a){var b=function(a,b){if("*"==a)return!0;for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;break}return c},c=function(a,c,d){var e=[];switch(d.catagory){case "command":a.command&&a.command.forEach(function(a){b(d.elems,a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))});break;case "status":a.status&&a.status.forEach(function(a){b(d.elems,
a.type)&&(a=JSON.parse(JSON.stringify(a)),e.push(a))})}return e},e=function(a,b){var d=[],e;if(a.sys){var f=this._getSystem(a.sys);f&&f.DM&&f.DM.getCommandStatusMap&&(e=f.DM.getCommandStatusMap(a))}e&&(a=c(e,a,b),d=d.concat(a));return d};if(!d.sys)return null;var f=JSON.parse(JSON.stringify(d)),g=null;switch(a.catagory){case "command":g=e.call(this,d,a);f.command=g;break;case "status":g=e.call(this,d,a);f.status=g;break;default:return null}return g&&0!=g.length?f:null}}}();
xnm.aio.rgb.Handler=function(){var d=function(){this._milightDiscovery=new xnm.aio.rgb.MiLight.Discovery;this.MiLightV6.init()};d.prototype.devicemanager=xnm.aio.rgb.DM;d.prototype.MiLight=xnm.aio.rgb.MiLight;d.prototype.MiLightV6=xnm.aio.rgb.MiLightV6;d.prototype.EasyLED=xnm.aio.rgb.EasyLED;d.prototype.registModule=function(a){for(var b in xnm.aio.rgb)if(xnm.aio.rgb.hasOwnProperty(b)){var c=xnm.aio.rgb[b];c&&c.DM&&c.DM.registModule&&c.DM.registModule(a)}};d.prototype.resolveDevice=function(a){switch(a.sys){case xnm.aio.rgb.WiFiLED2.DM.SYS:return xnm.aio.rgb.WiFiLED2.parseJSON(a);
case xnm.aio.rgb.DMX4ALL.DM.SYS:return xnm.aio.rgb.DMX4ALL.parseJSON(a);case xnm.aio.rgb.ArtNetNode.DM.SYS:return xnm.aio.rgb.ArtNetNode.parseJSON(a);default:return null}};d.prototype.resolveGateway=function(a){switch(a.sys){case xnm.aio.rgb.MiLight.DM.SYS:return xnm.aio.rgb.MiLight.parseJSON(a);case xnm.aio.rgb.MiLightV6.DM.SYS:return xnm.aio.rgb.MiLightV6.parseJSON(a);case xnm.aio.rgb.EasyLED.DM.SYS:return xnm.aio.rgb.EasyLED.parseJSON(a);default:return null}};d.prototype.getDeviceCommands=function(a,
b){a=(a=xnm.aio.rgb.DM.applyUIFilter(a,{catagory:"command",elems:"*"}))?a.command:[];b&&b(null,a)};d.prototype.doWifiLED2Command=function(a,b,c){(a=this.resolveDevice(a))?a.executeCommandCreator(null,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doDMX4ALLCommand=function(a,b,c){(a=this.resolveDevice(a))?a.executeCommandCreator(null,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.discoverDMX4ALLWithTimeout=function(a,b){xnm.aio.rgb.DMX4ALL._discovery(a,
b)};d.prototype.doArtNetCommand=function(a,b,c){(a=this.resolveDevice(a))?a.executeCommandCreator(null,b,function(a){c&&c(a)}):c&&c(Error("device json format invalid"))};d.prototype.doMilightCommand=function(a,b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.discoverMilightWithTimeout=function(a,b){this._milightDiscovery.discoverWithTimeout(a,function(a){b&&b(null,a)})};d.prototype.doEasyLEDCommand=function(a,
b,c,d){(a=this.resolveGateway(a))?a.executeCommandCreator(b,c,function(a){d&&d(a)}):d&&d(Error("gateway json format invalid"))};d.prototype.discoverEasyLEDWithTimeout=function(a,b){this._milightDiscovery.discoverWithTimeout(a,function(a){var c=[];if(a)for(var d=0;d<a.length;d++)a[d]&&c.push(new xnm.aio.rgb.EasyLED(a[d].ip,a[d].port,a[d].uuid));b&&b(null,c)})};return d}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rgb.Handler);
