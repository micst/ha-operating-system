var util=require("util"),commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{};x.hub.group=x.hub.group||{};
x.hub.group.GroupManager=function(){var f=function(a,b,c){this._id=a;this._type=b;this._logger=require("x.logger.js").getLogger("x.hub.group.Group.["+a+"]");this._devices=c};f.prototype.getId=function(){return this._id};f.prototype.executeCommand=function(a,b){if(this._devices&&this._devices.length)for(var c=this._devices.length,g=function(){c--;0==c&&b&&b()},e=0;e<this._devices.length;e++)this._doDeviceCommand(this._devices[e],a,g);else b&&b()};f.prototype._doDeviceCommand=function(a,b,c){this._logger.log("trace",
"execute command:"+JSON.stringify(b)+" for device:"+JSON.stringify(a));if(a){var g=JSON.parse(JSON.stringify(a)),e;for(e in b)"group"!=e&&(g[e]=b[e]);var d=this;commandman.commandHandlerV6.executeCommandWithCommandInfo(g,function(e){d._logger.log("trace","execute command finish:"+JSON.stringify(b)+" for device:"+JSON.stringify(a)+(e?" failed:"+e.message:" success"));c&&c(e)})}else c&&c()};f.parse=function(a,b){return a&&b&&b.type?new f(a,b.type,b.devices):null};var d=function(){this._logger=require("x.logger.js").getLogger("x.hub.group.GroupManager");
this._groups=this._dataFolder=null;this._writing=!1;this._writeCallbacks=[]};d.FILE_NAME="group.json";d.prototype.init=function(a,b){this._logger.log("info","init group manager");this._dataFolder=a.getUserRootDataPath();this._loadGroups(function(a){b&&b(a)})};d.prototype.getGroups=function(){return this._groups};d.prototype.getGroup=function(a){return this._groups?this._groups[a]:null};d.prototype.setGroup=function(a,b,c){void 0==a||null==a?c&&c(Error("invalid group id")):(b?this._groups[a]=b:delete this._groups[a],
this._writeGroups(function(a){c&&c(a,b)}))};d.prototype.executeGroupCommand=function(a,b,c){if(void 0!=a&&null!=a&&this._groups[a])if(b){var d=f.parse(a,this._groups[a]);d?(this._logger.log("trace","execute group#"+a+" command:"+JSON.stringify(b)),d.executeCommand(b,c)):c&&c(Error("invalid group"))}else c&&c(Error("invalid command"));else c&&c(Error("invalid group id"))};d.prototype._loadGroups=function(a){var b=require("fs-extra"),c=this._getFile(),d=this;b.ensureFile(c,function(b){b?a(b):d._loadFile(function(b,
c){b?a(b):(d._groups=c?c:{},a())})})};d.prototype._writeGroups=function(a){a&&-1==this._writeCallbacks.indexOf(a)&&this._writeCallbacks.push(a);if(!this._writing&&this._writeCallbacks.length){this._writing=!0;var b=this._writeCallbacks;this._writeCallbacks=[];var c=this;this._writeFile(this._groups,function(a){c._writing=!1;b.forEach(function(b){try{b&&b(a)}catch(h){}});c._writeGroups()})}};d.prototype._getFile=function(){return require("path").resolve(this._dataFolder,d.FILE_NAME)};d.prototype._loadFile=
function(a){var b=require("fs"),c=this._getFile();b.readFile(c,"utf8",function(b,c){if(b)a(b);else if(c)try{var d=JSON.parse(c);a(null,d)}catch(k){a(null,{})}else a(null,{})})};d.prototype._writeFile=function(a,b){var c=require("fs"),d=this._getFile();c.writeFile(d,JSON.stringify(a,null,2),function(a){b&&b(a)})};return d}();
x.hub.group.Handler=function(){var f=function(){this._logger=require("x.logger.js").getLogger("x.hub.group.Handler");this._groupManager=new x.hub.group.GroupManager};f.prototype.init=function(d,a,b){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(d);this._groupManager.init(a,function(a){a&&b(a)})};f.prototype.getGroupManager=function(){return this._groupManager};f.prototype._initHttpApi=function(){var d=this,a=require("x.hub.js").getServer();a.addRoute("/api/groups",{method:"GET"},function(b,a,f){b=
d._groupManager.getGroups();a.json({XC_SUC:b?b:{}})});a.addRoute("/data/grp/",{method:"GET"},function(b,a,f){b=b.path.substr(10);(b=d._groupManager.getGroup(b))?a.json({XC_SUC:b}):a.json({XC_ERR:{code:"000101",msg:"failed to open file"}})});a.addRoute("/data/grp/",{method:"POST"},function(a,c){var b=a.path.substr(10);try{d._groupManager.setGroup(b,a.json,function(b,d){b?c.json({XC_ERR:{code:"000101",msg:"failed to set group:"+b.message}}):d?c.json({XC_SUC:{bytes:a.size}}):c.json({XC_SUC:{bytes:0}})})}catch(e){c.json({XC_ERR:{code:"000101",
msg:"failed to set group:"+e.message}})}})};return f}();module.exports=new x.hub.group.Handler;
