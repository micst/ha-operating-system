<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
</head>
<script type="text/javascript">

  var appendText = function(text){
    var txt = document.getElementById("output").value;
    if (txt.length > 1000*100) {
      txt = txt.substr(10*100);
    }
    document.getElementById("output").value = txt+text;
  };

  var wsConnection = null;

  var start = function(){

    document.getElementById("system").disabled = true;
    document.getElementById("start").disabled = true;
    document.getElementById("stop").disabled = false;

    var e = document.getElementById("system");
    var system = e.options[e.selectedIndex].value;

    var loc = window.location, new_uri;

    if (loc.protocol === "https:") {
      new_uri = "wss:";
    } else {
      new_uri = "ws:";
    }
    new_uri += "//" + loc.host;
    new_uri += "/debug/tracker/ws";
    console.log(new_uri);
    var connection = new WebSocket(new_uri);
    wsConnection = connection;
    connection.onopen = function () {
      console.log("ws open");
      connection.send(JSON.stringify({system:system}))
    };

    // Log errors
    connection.onerror = function (error) {
      console.log('WebSocket Error ' + error);
      connection.close();
    };

    // Log messages from the server
    connection.onmessage = function (msg) {
      console.log(msg);
      appendText(msg.data);
    };
  };

  var stop = function(){
    document.getElementById("system").disabled = false;
    document.getElementById("start").disabled = false;
    document.getElementById("stop").disabled = true;

    if (wsConnection) wsConnection.close();
  };

  var clearTxt = function(){
    document.getElementById("output").value = '';
  };

  var getlog = function(){
    var e = document.getElementById("system");
    var system = e.options[e.selectedIndex].value;
    var win = window.open('/debug/tracker/log?system='+system, '_blank');
    if (win) {
      //Browser has allowed it to be opened
      win.focus();
    } else {
      //Browser has blocked it
      alert('Please allow popups for this website');
    }
  };

  var setlogger = function(){
    var e = document.getElementById("level");
    var level = e.options[e.selectedIndex].value;

    var tag = document.getElementById("logtag").value;

    var auth = getQueryStringValue("auth");

    var data = {XC_FNC:"SetLogger", level:level,tag:tag};
    if (auth) {data.auth = auth}
    $.ajax({
      url: "/cmd",
      type: "GET",
      timeout: 2000,
      data: data,
      success: function(data) {
        console.log("set logger success");
      },
      error: function(jqXHR, textStatus) {
        var msg = "http request error:"+(jqXHR?jqXHR.status:'0')+'-'+textStatus;
        console.log("set logger success error:"+msg);
      }
    });
  };

  var loaded = function(){
  };
  document.addEventListener('DOMContentLoaded', loaded, false);
</script>
<body style="height:100%">
<div>
  Set Logger Level:
  <div>
    Enter Logger Tag:
    <input type="text" id="logtag">
    Select Level:
    <select id="level">
      <option value="trace">Trace</option>
      <option value="debug">Debug</option>
      <option value="info">Info</option>
      <option value="warn">Warn</option>
      <option value="error">Error</option>
    </select>
    <button type="button" id="setlogger" onclick="setlogger()">Set</button>
  </div>
</div>
<div>
  <select id="system">
    <option value="main">Main</option>
    <option value="aio">AIO</option>
    <option value="knx">KNX</option>
    <option value="zigbee">Zigbee</option>
    <option value="enocean">EnOcean</option>
    <option value="zwave">ZWave</option>
    <option value="taskmanager">TaskManager</option>
  </select>
  <button type="button" id="start" onclick="start()">Start</button>
  <button type="button" id="stop" onclick="stop()">Stop</button>
  <button type="button" id="clear" onclick="clearTxt()">Clear</button>
  <button type="button" id="getlog" onclick="getlog()">Get Log</button>
</div>
<div>
  <textarea id="output" style="width:100%; height:100% "></textarea>
</div>
</body>
</html>