var m=m||{};m.aio=m.aio||{};m.aio.backupmanager=m.aio.backupmanager||{};
m.aio.backupmanager.BackupManager=function(){var f=function(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager");this._restoreListener=this._fm=null};f.prototype.BACKUP_DIR="backups";f.prototype.init=function(a,b,e){this._fm=a;this._restoreListener=b;e&&e()};f.prototype.getBackups=function(a){var b=require("fs-extra"),e=require("path"),k=require("async"),d=this._getBackupDir(),g=[];b.ensureDir(d,function(c){c?a&&a(c):b.readdir(d,function(b,d){b?a&&a(b):k.eachLimit(d,
10,function(b,a){var d=e.extname(b),h=e.basename(b);h=h.substr(0,h.length-d.length).toLowerCase();if(d&&".zip"==d.toLowerCase()&&h&&!(6>=h.length)&&"backup"==h.substr(0,6)&&(d=h.indexOf("_"),-1!=d&&d!=h.length-1)){var c=h.substr(d+1);c.match(/^\d+$/)&&(c=parseInt(c,10),g.push({file:b,name:h.substr(0,d),time:c}))}a()}.bind(this),function(b){a&&a(b,g)})})})};f.prototype.restoreBackup=function(a,b){var e=require("fs-extra"),k=require("path"),d=this._getBackupDir(),g=this._fm.getUserRootDataPath(),c=
this,f=k.join(d,a);d=k.basename(a);a=k.extname(a);var l=d.substr(0,d.length-a.length);e.stat(f,function(a){a?(c._logger.log("warn","restore backup 1 error:"+a.message),b&&b(a)):c._unzip(f,l,function(a,d){if(a)c._logger.log("warn","restore backup 2 error:"+a.message),b&&b(a);else{var h=c._getBackupContentDirs();c._deleteCurrentFolders(h,function(a){if(a)c._logger.log("warn","restore backup 3 error:"+a.message),b&&b(a);else try{for(a=0;a<h.length;a++)e.copySync(k.join(d,h[a]),k.join(g,h[a]));c._restoreListener?
c._restoreListener(function(a){a?(c._logger.log("warn","restore backup 5 error:"+a.message),b&&b(a)):e.remove(d,function(){b&&b()})}):e.remove(d,function(){b&&b()})}catch(r){c._logger.log("warn","restore backup 4 error:"+r.message),b&&b(r)}})}})})};f.prototype.createBackup=function(a){var b=require("fs-extra"),e=require("path"),k=this._getBackupDir(),d=this;d._logger.log("debug","Backup dir: "+k);b.ensureDir(k,function(g){g?(d._logger.log("warn","create backup 1 error:"+g.message),a&&a(g)):b.readdir(k,
function(c,g){if(c)d._logger.log("warn","create backup 2 error:"+c.message),a&&a(c);else{c=d._findBackupPrefix(g);var f=d._getBackupContentDirs(),p=d._fm.getUserRootDataPath(),q=c+"_"+Math.round((new Date).getTime()/1E3)+".zip";d._logger.log("debug","ZIP file to create: "+q);var n=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(n,function(c){d._logger.log("debug","Checked CPU for features: "+n.join(", ")+". Result: "+c);if(c){var g=require("archiver");c=b.createWriteStream(e.join(k,q));g=g("zip");c.on("error",
function(b){d._logger.log("warn","create backup 3 error:"+b.message);a&&(a(b),a=null)});c.on("close",function(){a&&(a(),a=null)});g.on("error",function(b){d._logger.log("warn","create backup 4 error:"+b.message);a&&(a(b),a=null)});g.pipe(c);for(c=0;c<f.length;c++)d._logger.log("debug","Adding directory: "+f[c]),g.directory(e.join(p,f[c]),f[c]);d._logger.log("debug","Calling ZIP finalize.");g.finalize()}else{var h=new (require("jszip")),l=Date.now(),t=function(a){h.folder(a);for(var c=b.readdirSync(e.join(p,
a),{withFileTypes:!0}),d=0;d<c.length;d++){var g=c[d];if(g.isFile()){var f=g.name.toLowerCase();".ds_store"!==f&&"thumbs.db"!==f&&(f=e.join(p,a,g.name),f=b.readFileSync(f),h.file(a+"/"+g.name,f))}else g.isDirectory()&&t(a+"/"+g.name)}};for(c=0;c<f.length;c++)t(f[c]);d._logger.log("debug","Listed all folders and files in "+(Date.now()-l)+" ms.");l=Date.now();h.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(b.createWriteStream(e.join(k,
q))).on("finish",function(){d._logger.log("debug","Backup ZIP has been created: "+q);d._logger.log("debug","Creating the ZIP took "+(Date.now()-l)+" ms.");a&&(a(),a=null)})}})}})})};f.prototype.deleteBackup=function(a,b){var e=require("fs-extra"),f=require("path"),d=this._getBackupDir();e.ensureDir(d,function(g){g?b&&b(g):e.remove(f.join(d,a),function(a){b&&b(a)})})};f.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR)};f.prototype._getBackupContentDirs=
function(){return["tenants","resources"]};f.prototype._findBackupPrefix=function(a){for(var b=0,e="backup"+b;this._hasBackupWithPrefix(e,a);)b++,e="backup"+b;return e};f.prototype._hasBackupWithPrefix=function(a,b){for(var e=0;e<b.length;e++)if(b[e]&&b[e].substr(0,a.length)==a)return!0;return!1};f.prototype._unzip=function(a,b,e){var f=this._fm.getTmpDir(),d=require("path"),g=require("fs-extra"),c=d.join(f,b);try{g.existsSync(c)&&g.removeSync(c),g.ensureDirSync(c)}catch(p){e&&e(p);return}var n=this,
l=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(l,function(b){n._logger.log("debug","Checked CPU for features: "+l.join(", ")+". Result: "+b);if(b){n._logger.log("debug","Unzipping backup file with ADM-ZIP.");b=Date.now();var d=new (require("adm-zip"))(a);try{d.extractAllTo(c,!0),n._logger.log("debug","Finished unzipping after "+(Date.now()-b)+" ms."),e&&e(null,c)}catch(u){e&&e(u)}}else XC.unzip(a,c,n._logger,e)})};f.prototype._deleteCurrentFolders=function(a,b){var e=require("fs-extra"),f=require("path"),
d=this._fm.getUserRootDataPath();try{for(var g=0;g<a.length;g++)e.removeSync(f.join(d,a[g]));b()}catch(c){b(c)}};return f}();m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager;"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler);
