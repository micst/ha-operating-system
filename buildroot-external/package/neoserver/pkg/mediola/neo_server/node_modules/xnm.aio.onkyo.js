var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var e=0;return function(){return e<b.length?{done:!1,value:b[e++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,e,g){b!=Array.prototype&&b!=Object.prototype&&(b[e]=g.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var e=0;e<b.length;++e){var g=b[e];if(g&&g.Math==Math)return g}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,e){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:e})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(g){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(g||"")+"_"+e++,g)}var e=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,e){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var g=0,h={next:function(){if(g<b.length){var f=g++;return{value:e(f,b[f]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};
$jscomp.polyfill=function(b,e,g,h){if(e){g=$jscomp.global;b=b.split(".");for(h=0;h<b.length-1;h++){var f=b[h];f in g||(g[f]={});g=g[f]}b=b[b.length-1];h=g[b];e=e(h);e!=h&&null!=e&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(e){return e})}},"es6","es3");var xnm=xnm||{};xnm.aio=xnm.aio||{};xnm.aio.onkyo=xnm.aio.onkyo||{};
xnm.aio.onkyo.AVReceiverBuffer={getAVR:function(b,e){return b&&e?this[b+":"+e]:null},setAVR:function(b){if(!b||!b.getIp())return null;this[b.getIp()+":"+b.getPort()]=b}};
xnm.aio.onkyo.AVReceiver=function(){var b=[1,2,3,4],e=function(a,c,d,e){this._taskBuffer=a;this._avr=c;this._datapoints=d;this._callback=e};e.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var a=this,c={},d=0,e=function(b,l){if(!b||1!=b.errorCode&&2!=b.errorCode&&3!=b.errorCode){b=a._datapoints[d];var f=null,g=b.indexOf(":");0<g&&(f=b.substr(0,g),b=b.substr(g+1));g="?";"frontTone"==b?l&&(null!=l.mainzone.frontBass&&"undefined"!=typeof l.mainzone.frontBass&&
(c["mainzone:frontBass"]=l.mainzone.frontBass),null!=l.mainzone.frontTreble&&"undefined"!=typeof l.mainzone.frontTreble&&(c["mainzone:frontTreble"]=l.mainzone.frontTreble)):(l&&(f||null==l[b]||"undefined"==typeof l[b]?f&&l[f]&&null!=l[f][b]&&"undefined"!=typeof l[f][b]&&(g=l[f][b]):g=l[b]),c[a._datapoints[d]]=g);d+=1;d<a._datapoints.length?(l=a._avr._getStateQuest(a._datapoints[d]),a._avr._doStateReq(l,e)):a._taskBuffer._finishLastTask(null,c)}else a._taskBuffer._finishAllTask(b)},b=this._avr._getStateQuest(this._datapoints[d]);
b?this._avr._doStateReq(b,e):e(Error("unknow status"))};e.prototype.merge=function(a){if(a&&a._datapoints)if(this._datapoints){a=this._datapoints.concat(a._datapoints);for(var c=0;c<a.length;++c)for(var d=c+1;d<a.length;++d)a[c]===a[d]&&a.splice(d,1);this._datapoints=a}else this._datapoints=a._datapoints};var g=function(a,c,d,b){this._taskBuffer=a;this._avr=c;this._commandTxt=d;this._callback=b};g.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var a=
this,c=this._commandTxt,d=null,b=c.indexOf(":");0<b&&(d=c.substr(0,b),c=c.substr(b+1));var e=null;"toggle"==c?(e=this._avr._getStateQuest(d+":power"),this._avr._doStateReq(e,function(c,b){c?1==c.errorCode||2==c.errorCode||3==c.errorCode?a._taskBuffer._finishAllTask(c):a._taskBuffer._finishLastTask(c):(c="on",b&&b[d]&&"on"==b[d].power&&(c="off"),e=a._avr._getCommandQuest(d+":"+c),a._avr._doCommandReq(e,function(c){!c||1!=c.errorCode&&2!=c.errorCode&&3!=c.errorCode?a._taskBuffer._finishLastTask(c):
a._taskBuffer._finishAllTask(c)}))})):(e=this._avr._getCommandQuest(this._commandTxt),this._avr._doCommandReq(e,function(c){!c||1!=c.errorCode&&2!=c.errorCode&&3!=c.errorCode?a._taskBuffer._finishLastTask(c):a._taskBuffer._finishAllTask(c)}))};var h=function(a){this._avr=a;this._buffer=[]};h.prototype.executeTask=function(a){if(0==this._buffer.length)this._buffer.push(a),this._doNextTask();else if(a instanceof g)1<this._buffer.length&&this._buffer[this._buffer.length-1]&&this._buffer[this._buffer.length-
1]instanceof e?this._buffer.splice(this._buffer.length-1,0,a):this._buffer.push(a);else{if(a instanceof e){var c=[];if(1<this._buffer.length){for(var d=1;d<this._buffer.length;d++)this._buffer[d]&&this._buffer[d]instanceof e&&(c.push(d),a.merge(this._buffer[d]));for(d=0;d<c.length;d++)this._buffer.splice(c[d],1)}}this._buffer.push(a)}};h.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run()};h.prototype._finishLastTask=function(a,c){if(0<this._buffer.length){var d=this._buffer[0];
d&&d._callback&&(d._callback(a,c),d._callback=null);this._buffer.splice(0,1)}this._doNextTask()};h.prototype._finishAllTask=function(a){var c=this._buffer;this._buffer=[];for(var d=0;d<c.length;d++)c[d]&&c[d]._callback&&(c[d]._callback(a),c[d]._callback=null)};var f=function(a){this._avr=a;this._buffer=[];this._bufferEmptyTo=null};f.prototype.RESPONSE_TO=1E3;f.prototype.PACKET_IDLE_TO=6E4;f.prototype.sendPacket=function(a,c,d){if(a){var b=this._buffer.length;this._buffer.push({packet:a,ignoreRsp:c,
callback:d});this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);0==b&&this._sendNextPacket()}else d&&d(Error("ISCP message is null"))};f.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var a=this,c=this._buffer[0];this._avr._sendPacket(c.packet,function(d){d?(d.errorCode=b[0],a._finishAllPacket(d)):c.ignoreRsp?a._finishLastPacket():c.timeout=setTimeout(function(){a._avr._logger.log("warn","packet response timeout");var c=Error("packet reponse timeout");
c.errorCode=b[3];a._finishLastPacket(c)},a.RESPONSE_TO)})}};f.prototype._finishLastPacket=function(a,c){0<this._buffer.length&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(a,c),this._buffer[0].callback=null)),this._buffer.splice(0,1));if(0==this._buffer.length){var d=this;this._bufferEmptyTo=setTimeout(function(){d._bufferEmptyTo=null;0==d._buffer.length&&d._avr._disconnect()},this.PACKET_IDLE_TO)}else this._sendNextPacket()};
f.prototype._finishAllPacket=function(a){var c=this._buffer;this._buffer=[];this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var d=0;d<c.length;d++)c[d]&&(c[d].timeout&&(clearTimeout(c[d].timeout),c[d].timeout=null),c[d].callback&&(c[d].callback(a),c[d].callback=null))};f.prototype._onSocketData=function(a){a=new Buffer(a);a=a.toString("hex");a=new Buffer(a,"hex");12<a.length&&(a=a.slice(18,18+(a[11]-2)).toString().trim(),a=a.replace(/[\x1a]/g,""),this._avr&&this._avr._datapointBuffer&&
this._avr._datapointBuffer.updateDpt(a),0<this._buffer.length&&this._buffer[0]&&this._buffer[0].packet&&this._buffer[0].packet.substr(0,3)==a.substr(0,3)&&this._finishLastPacket(null,a))};f.prototype._onSocketTimeout=function(){};f.prototype._onSocketError=function(a){a.errorCode=b[1];this._finishAllPacket(a)};f.prototype._onSocketClose=function(a){a=Error("socket closed");a.errorCode=b[2];this._finishAllPacket(a)};var n=function(){this._buffer={}};n.prototype.EXPIRE_TO=3E3;n.prototype.updateDpt=
function(a){if(a&&3<a.length){var c=a.substr(0,3);this._buffer[c]={status:a,timestamp:(new Date).getTime()}}};n.prototype.getDpt=function(a){if(a&&3<a.length&&(a=a.substr(0,3),this._buffer[a])){if(!this._buffer[a].timestamp)return delete this._buffer[a],null;var c=(new Date).getTime(),d=c-this._buffer[a].timestamp;return d>this.EXPIRE_TO||0>d?(this._buffer[a].timestamp=c,null):null==this._buffer[a].status||"undefined"==typeof this._buffer[a].status?(delete this._buffer[a],null):this._buffer[a].status}return null};
n.prototype.delDpt=function(a){a&&3<a.length&&(a=a.substr(0,3),"AMT"!=a?delete this._buffer[a]:this._buffer[a].timestamp=(new Date).getTime())};n.prototype.refreshDptTime=function(){var a=(new Date).getTime(),c;for(c in this._buffer)this._buffer.hasOwnProperty(c)&&(this._buffer[c].timestamp=a)};var k=function(a,c,d,b,e){this._ip=a;this._port=c;this._port||(this._port=60128);this._uuid=d;this._logger=require("x.logger.js").getLogger("xnm.aio.onkyo.AVReceiver");this._model=b;this._name=e;this._socket=
null;this._taskBuffer=new h(this);this._packetBuffer=new f(this);this._datapointBuffer=new n};k.prototype.getIp=function(){return this._ip};k.prototype.getPort=function(){return this._port};k.prototype.executeCommandCreator=function(a,c,d){if(c&&c.value)if("openNative"==c.value)window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"onkyo-remote3://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM",
"startApp",{scheme:"com.onkyo.jp.onkyoremote"})),d&&d();else{a="";c.path&&c.path[0]&&"global"!=c.path[0]&&(a=c.path[0]+":");var b=a+c.value;if("setTo"==c.value||"tuner"==c.value||"frontBassTo"==c.value||"frontTrebleTo"==c.value){if(null==c.ext||"undefined"==typeof c.ext){d&&d(Error("command setTo ext format invalid"));return}b+=c.ext}else if("audioMode"==c.value){if(!c.ext){d&&d(Error("command audioMode ext format invalid"));return}b+=c.ext}else if("setInput"==c.value){if(!c.ext){d&&d(Error("command setInput ext format invalid"));
return}b=a+c.ext}else if("customCMD"==c.value){if(!c.ext){d&&d(Error("command customCMD ext format invalid"));return}b=a+c.ext}var e=this;this._executeCommand(b,function(a){if(a)d&&d(a);else if("on"==c.value||"off"==c.value||"toggle"==c.value)setTimeout(function(){d&&d()},4E3);else{if("mute"==c.value||"unmute"==c.value||"toggleMute"==c.value){if(c.path&&c.path[0]&&"mainzone"==c.path[0]){e._datapointBuffer&&e._datapointBuffer.refreshDptTime();setTimeout(function(){d&&d()},3E3);return}}else if("volumeUp"==
c.value||"volumeDown"==c.value){setTimeout(function(){d&&d()},100);return}d&&d(a)}})}else d&&d(Error("command json format invalid"))};k.prototype.getStatesCreator=function(a,c,d){a=function(a,c){for(var d=0;d<c.length;d++)if(c[d]===a)return!0;return!1};for(var b=[],e=[],f=0;f<c.length;f++)if(c[f]&&c[f].id&&c[f].status&&c[f].status.value){var g="";c[f].status.path&&c[f].status.path[0]&&"global"!=c[f].status.path[0]&&(g=c[f].status.path[0]+":");var h=c[f].status.value;b.push({id:c[f].id,datapoint:g+
h});if("frontBass"==h||"frontTreble"==h)h="frontTone";a(g+h,e)||e.push(g+h)}this._getStates(e,function(a,c){if(a)d&&d(a);else{a=[];for(var e=0;e<b.length;e++){var f="?",g=b[e].id,l=b[e].datapoint;c&&null!=c[l]&&"undefined"!=typeof c[l]&&(f=c[l]);a.push({id:g,status:f})}d&&d(null,a)}})};k.prototype.executeCommand=function(a,c){this._executeCommand(a,c)};k.prototype.getStates=function(a){var c=Object.keys(k.STATUS_DPT_QUEST);this._getStates(c,function(c,b){a&&a(c,b)})};k.prototype._executeCommand=function(a,
c){this._logger.log("debug","execute command: "+a);a=new g(this._taskBuffer,this,a,c);this._taskBuffer.executeTask(a)};k.prototype._getStates=function(a,c){this._logger.log("debug","get states: "+JSON.stringify(a));a=new e(this._taskBuffer,this,a,c);this._taskBuffer.executeTask(a)};k.prototype._getCommandQuest=function(a){var c=a;var d=null;var b=a.indexOf(":");0<b&&(d=a.substr(0,b),a=a.substr(b+1));if("on"==a)c="zone2"==d?"ZPW01":"zone3"==d?"PW301":"PWR01";else if("off"==a)c="zone2"==d?"ZPW00":"zone3"==
d?"PW300":"PWR00";else if("mute"==a)c="zone2"==d?"ZMT01":"zone3"==d?"MT301":"AMT01";else if("unmute"==a)c="zone2"==d?"ZMT00":"zone3"==d?"MT300":"AMT00";else if("toggleMute"==a)c="zone2"==d?"ZMTTG":"zone3"==d?"MT3TG":"AMTTG";else if("volumeDown"==a)c="zone2"==d?"ZVLDOWN":"zone3"==d?"VL3DOWN":"MVLDOWN";else if("volumeUp"==a)c="zone2"==d?"ZVLUP":"zone3"==d?"VL3UP":"MVLUP";else if("BDDVD"==a||"BD/DVD"==a)c="zone2"==d?"SLZ10":"zone3"==d?"SL310":"SLI10";else if("STRMBOX"==a||"STRM BOX"==a)c="zone2"==d?
"SLZ11":"zone3"==d?"SL311":"SLI11";else if("CBLSAT"==a||"CBL/SAT"==a)c="zone2"==d?"SLZ01":"zone3"==d?"SL301":"SLI01";else if("PC"==a)c="zone2"==d?"SLZ05":"zone3"==d?"SL305":"SLI05";else if("GAME"==a)c="zone2"==d?"SLZ02":"zone3"==d?"SL302":"SLI02";else if("AUX"==a)c="zone2"==d?"SLZ03":"zone2"==d?"SL303":"SLI03";else if("CD"==a)c="zone2"==d?"SLZ23":"zone3"==d?"SL323":"SLI23";else if("TV"==a)c="zone2"==d?"SLZ12":"zone3"==d?"SL312":"SLI12";else if("FM"==a)c="zone2"==d?"SLZ24":"zone3"==d?"SL324":"SLI24";
else if("AM"==a)c="zone2"==d?"SLZ25":"zone3"==d?"SL325":"SLI25";else if("NET"==a)c="zone2"==d?"SLZ2B":"zone3"==d?"SL32B":"SLI2B";else if("BLUETOOTH"==a)c="zone2"==d?"SLZ2E":"zone3"==d?"SL32E":"SLI2E";else if("Optical"==a)c="zone2"==d?"SLZ44":"zone3"==d?"SL344":"SLI44";else if(0==a.indexOf("audioMode")){if(a=a.replace(/audioMode/g,""),"STEREO"==a||"MOVIE"==a||"MUSIC"==a||"GAME"==a)"STEREO"==a&&(a="00"),c="LMD"+a}else if("play"==a)c="NTCPLAY";else if("pause"==a)c="NTCPAUSE";else if("stop"==a)c="NTCSTOP";
else if("previous"==a)c="NTCTRDN";else if("next"==a)c="NTCTRUP";else if("frontBassUp"==a)c="TFRBUP";else if("frontBassDown"==a)c="TFRBDOWN";else if("frontTrebleUp"==a)c="TFRTUP";else if("frontTrebleDown"==a)c="TFRTDOWN";else if(0==a.indexOf("frontBassTo"))0==a.indexOf("frontBassTo")&&(a=a.replace(/frontBassTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),d=!1,0>a&&(d=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),c="TFRB"+(d?"-"+a:"+"+a);else if(0==a.indexOf("frontTrebleTo"))0==a.indexOf("frontTrebleTo")&&
(a=a.replace(/frontTrebleTo/g,"")),a=a.replace(/%/g,""),a=parseInt(a),d=!1,0>a&&(d=!0,a=0-a),0>a&&(a=0),10<a&&(a=10),a=a.toString(16).toUpperCase(),c="TFRT"+(d?"-"+a:"+"+a);else if(0==a.indexOf("tuner"))a=a.replace(/tuner/g,""),"Up"==a?c="zone2"==d?"PRZUP":"zone3"==d?"PR3UP":"PRSUP":"Down"==a?c="zone2"==d?"PRZDOWN":"zone3"==d?"PR3DOWN":"PRSDOWN":(a=parseInt(a),0>a?a=0:40<a&&(a=40),c="zone2"==d?"PRZ"+XC.getHexVal(a,2):"zone3"==d?"PR3"+XC.getHexVal(a,2):"PRS"+XC.getHexVal(a,2));else if(0==a.indexOf("setTo")||
/^\d+$/.test(a))0==a.indexOf("setTo")&&(a=a.replace(/setTo/g,"")),a=a.replace(/%/g,""),"zone2"==d?(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="ZVL"+XC.getHexVal(a,2)):"zone3"==d?(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="VL3"+XC.getHexVal(a,2)):(a=parseInt(a),0>a?a=0:100<a&&(a=100),c="MVL"+XC.getHexVal(a,2));return c};k.STATUS_DPT_QUEST={"mainzone:power":"PWRQSTN","mainzone:volume":"MVLQSTN","mainzone:mute":"AMTQSTN","mainzone:audioMode":"LMDQSTN","mainzone:input":"SLIQSTN","mainzone:frontTone":"TFRQSTN",
"zone2:power":"ZPWQSTN","zone2:volume":"ZVLQSTN","zone2:mute":"ZMTQSTN","zone2:input":"SLZQSTN","zone3:power":"PW3QSTN","zone3:volume":"VL3QSTN","zone3:mute":"MT3QSTN","zone3:input":"SL3QSTN"};k.LMD_MAP={"00":"Stereo","01":"Direct","02":"SURROUND","03":"Game-RPG","04":"THX","05":"Game-Action","06":"Game-Rock","07":"MONO MOVIE","08":"Orchestra","09":"Unplugged","0A":"Studio-Mix","0B":"TV Logic","0C":"All Ch Stereo","0D":"Theater-Dimensional","0E":"Game-Sports","0F":"Mono",11:"Pure Audio",12:"MULTIPLEX",
13:"Full Mono",14:"DOLBY VIRTUAL",15:"DTS Surround Sensation",16:"Audyssey DSX","1F":"Whole House Mode",23:"Stage",25:"Action",26:"Music","2E":"Sports",40:"Straight Decode*1",41:"Dolby EX*2",42:"THX Cinema",43:"THX Surround EX",44:"THX Music",45:"THX Games",50:"THX U2/S2/I/S Cinema/Cinema2",51:"THX U2/S2/I/S Music",52:"THX U2/S2/I/S Games",80:"Dolby Surround",81:"PLII/PLIIx Music",82:"DTS Neo:6 Cinema",83:"DTS Neo:6 Music",84:"PLII/PLIIx THX Cinema",85:"Neo:6/Neo:X THX Cinema",86:"PLII/PLIIx Game",
87:"Neural Surr*3",88:"Neural THX/Neural Surround",89:"PLII/PLIIx THX Games","8A":"Neo:6/Neo:X THX Games","8B":"PLII/PLIIx THX Music","8C":"Neo:6/Neo:X THX Music","8D":"Neural THX Cinema","8E":"Neural THX Music","8F":"Neural THX Games",90:"PLIIz Height",91:"Neo:6 Cinema DTS Surround Sensation",92:"Neo:6 Music DTS Surround Sensation",93:"Neural Digital Music",94:"PLIIz Height + THX Cinema",95:"PLIIz Height + THX Music",96:"PLIIz Height + THX Games",97:"PLIIz Height + THX U2/S2 Cinema",98:"PLIIz Height + THX U2/S2 Music",
99:"PLIIz Height + THX U2/S2 Games","9A":"Neo:X Game",A0:"PLIIx/PLII Movie + Audyssey DSX",A1:"PLIIx/PLII Music + Audyssey DSX",A2:"PLIIx/PLII Game + Audyssey DSX",A3:"Neo:6 Cinema + Audyssey DSX",A4:"Neo:6 Music + Audyssey DSX",A5:"Neural Surround + Audyssey DSX",A6:"Neural Digital Music + Audyssey DSX",A7:"Dolby EX + Audyssey DSX"};k.prototype._getStateQuest=function(a){return a?k.STATUS_DPT_QUEST[a]:null};k.prototype._buildData=function(a){var c=[73,83,67,80,0,0,0,16,0,0,0,8,1,0,0,0,33,49],d=2+
a.length+1&4294967295;c[8]=d>>24&255;c[9]=d>>16&255;c[9]=d>>8&255;c[11]=d&255;for(d=0;d<a.length;d++)c.push(a.charCodeAt(d));c.push(13);return new Buffer(c)};k.prototype._resolveStatus=function(a){var c={mainzone:{},zone2:{},zone3:{}};if(0==a.indexOf("MVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(c.mainzone.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PWR"))"00"==a.substr(3)?c.mainzone.power="off":"01"==a.substr(3)&&(c.mainzone.power="on");else if(0==a.indexOf("AMT"))"00"==a.substr(3)?c.mainzone.mute=
"off":"01"==a.substr(3)&&(c.mainzone.mute="on");else if(0==a.indexOf("LMD"))a=a.substr(3).trim(),k.LMD_MAP[a]&&(c.mainzone.audioMode=k.LMD_MAP[a]);else if(0==a.indexOf("TFR")){if(a=a.substr(3),6==a.length){var d=parseInt(a.substr(2,1),16),b="-"==a.charAt(1);b&&(d=0-d);var e=parseInt(a.substr(5,1),16);(b="-"==a.charAt(4))&&(e=0-e);c.mainzone.frontBass=d;c.mainzone.frontTreble=e}}else if(0==a.indexOf("ZVL"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(c.zone2.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("ZPW"))"00"==
a.substr(3)?c.zone2.power="off":"01"==a.substr(3)&&(c.zone2.power="on");else if(0==a.indexOf("ZMT"))"00"==a.substr(3)?c.zone2.mute="off":"01"==a.substr(3)&&(c.zone2.mute="on");else if(0==a.indexOf("VL3"))a.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(c.zone3.volume=parseInt(a.substr(3),16));else if(0==a.indexOf("PW3"))"00"==a.substr(3)?c.zone3.power="off":"01"==a.substr(3)&&(c.zone3.power="on");else if(0==a.indexOf("MT3"))"00"==a.substr(3)?c.zone3.mute="off":"01"==a.substr(3)&&(c.zone3.mute="on");else if(0==
a.indexOf("SLI")||0==a.indexOf("SLZ")||0==a.indexOf("SL3"))d=c.mainzone,0==a.indexOf("SLZ")?d=c.zone2:0==a.indexOf("SL3")&&(d=c.zone3),"10"==a.substr(3)?d.input="BD/DVD":"11"==a.substr(3)?d.input="STRM BOX":"01"==a.substr(3)?d.input="CBL/SAT":"05"==a.substr(3)?d.input="PC":"02"==a.substr(3)?d.input="GAME":"03"==a.substr(3)?d.input="AUX":"23"==a.substr(3)?d.input="CD":"12"==a.substr(3)?d.input="TV":"24"==a.substr(3)?d.input="FM":"25"==a.substr(3)?d.input="AM":"2B"==a.substr(3)?d.input="NET":"2E"==
a.substr(3)?d.input="BLUETOOTH":"44"==a.substr(3)&&(d.input="Optical");return c};k.prototype._doCommandReq=function(a,c){this._datapointBuffer&&this._datapointBuffer.delDpt(a);this._packetBuffer.sendPacket(a,!0,c)};k.prototype._doStateReq=function(a,c){var d=this;if(this._datapointBuffer){var b=this._datapointBuffer.getDpt(a);if(b){a=this._resolveStatus(b);c(null,a);return}}this._packetBuffer.sendPacket(a,!1,function(a,b){a?c(a):(a=d._resolveStatus(b),c(null,a))})};k.prototype._sendPacket=function(a,
c){if(this._socket){this._logger.log("trace","send ISCP message:"+a);var d=this._buildData(a);this._socket.write(d,"binary");c()}else{var b=this;this._connect(function(d){d?c(d):b._sendPacket(a,c)})}};k.prototype._connect=function(a){this._socket&&(this._socket.end(),this._socket=null);var c=this,d={port:this._port,host:this._ip},b=require("net").connect(d);b.setTimeout(2E3);b.__connected=!1;b.on("connect",function(){c._logger.log("trace","connect to onkyo avr:"+c._ip);b.__connected=!0;c._socket=
b;a()});b.on("data",function(a){c._logger.log("trace","receive from onkyo avr "+(b.__disconnected?"(closed)":"")+":"+c._ip+" data:"+a);b.__disconnected||c._packetBuffer._onSocketData(a)});b.on("error",function(d){b.__connected?(c._logger.log("trace","onkyo avr"+(b.__disconnected?"(closed)":"")+":"+c._ip+" error:"+d.message),b.destroy(),b.__disconnected||(b.__disconnected=!0,c._socket=null,c._packetBuffer._onSocketError(d))):(c._logger.log("trace","onkyo avr:"+c._ip+" connection error:"+d.message),
a(d))});b.on("timeout",function(){b.__connected?(c._logger.log("trace","onkyo avr"+(b.__disconnected?"(closed)":"")+":"+c._ip+" data timeout"),b.__disconnected||c._packetBuffer._onSocketTimeout()):(c._logger.log("trace","onkyo avr:"+c._ip+" connection timeout"),b.destroy&&b.destroy(),a(Error("timeout")))});b.on("close",function(){c._logger.log("trace","onkyo avr"+(b.__disconnected?"(closed)":"")+":"+c._ip+" close socket");b.__disconnected||(b.__disconnected=!0,c._socket=null,c._packetBuffer._onSocketClose(b))});
b._doConnect&&"function"==typeof b._doConnect&&b._doConnect();return b};k.prototype._disconnect=function(){this._logger.log("debug","disconnect socket");this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null)};k.prototype.toJSON=function(){var a={sys:xnm.aio.onkyo.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model};this._name&&(a.name=this._name);return a};k.prototype.equalsTo=function(a){return a&&a instanceof k?this._ip==a._ip&&this._port==
a._port:!1};k.parseJSON=function(a){return a.ip?new k(a.ip,a.port,a.uuid,a.model,a.name):null};var m=function(a,c,d,b,e){this._avr=xnm.aio.onkyo.AVReceiverBuffer.getAVR(a,c);this._avr||(this._avr=new k(a,c,d,b,e),xnm.aio.onkyo.AVReceiverBuffer.setAVR(this._avr))};m.prototype.getUUID=function(){return this._avr?this._avr._uuid:null};m.prototype.executeCommandCreator=function(a,c,d){this._avr.executeCommandCreator(a,c,d)};m.prototype.getStatesCreator=function(a,c,d){this._avr.getStatesCreator(a,c,d)};
m.prototype.executeCommand=function(a,c){this._avr.executeCommand(a,c)};m.prototype.getStates=function(a){this._avr.getStates(a)};m.prototype.toJSON=function(){return this._avr.toJSON()};m.prototype.equalsTo=function(a){return this._avr.equalsTo(a._avr)};m.parseJSON=function(a){return a.ip?new m(a.ip,a.port,a.uuid,a.model,a.name):null};return m}();
xnm.aio.onkyo.DM=function(){var b=function(b,e){this.code=b;this.message=e;this.stack=Error().stack};b.prototype=Error();b.prototype.name="OnkyoDMError";b.prototype.code=0;b.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open Onkyo Remote App",ref:{value:"openNative",value_t:"open_app_onkyo"}}]},
{type:"root",name:"NET",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},
{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","STEREO"]}},{type:"enum",name:"front bass up",
ref:{value:"frontBassUp",value_t:"bassUp"}},{type:"enum",name:"front bass down",ref:{value:"frontBassDown",value_t:"bassDown"}},{type:"int",name:"front bass to",ref:{value:"frontBassTo",value_t:"bassTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"front treble up",ref:{value:"frontTrebleUp",value_t:"trebleUp"}},{type:"enum",name:"front treble down",ref:{value:"frontTrebleDown",value_t:"trebleDown"}},{type:"int",name:"front treble to",ref:{value:"frontTrebleTo",value_t:"trebleTo",ext:"%d",
extMeta:"-10-10",scale:"2"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",
name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},
{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},
{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",
name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:"CBL/SAT;BD/DVD;STRM BOX;GAME;AUX;PC;CD;TV;NET;BLUETOOTH;FM;AM;Optical".split(";")}}]}],status:[{type:"root",name:"main zone",value:"mainzone",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},
{type:"int",name:"front bass",ref:{value:"frontBass",value_t:"bass",extMeta:"-10-10",scale:"2"}},{type:"int",name:"front treble",ref:{value:"frontTreble",value_t:"treble",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["Stereo","All Ch Stereo"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",
ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on",
"off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:"CBLSAT BDDVD STRMBOX GAME AUX PC CD TV NET BLUETOOTH FM AM Optical".split(" ")}}]}]}};return{SYS:"onkyo",getIPDeviceType:function(){return[{sys:this.SYS,name:"Onkyo AV Receiver",type:"avr"}]},createDevice:function(e,h,f){h=b.ERROR_CODE;e?e.ip?f(null,e):f(new b(h.INVALID,"ip is invalid")):f(new b(h.INVALID,"info is invalid"))},updateDevice:function(e,h,f){h=b.ERROR_CODE;
e?e.ip?f(null,e):f(new b(h.INVALID,"ip is invalid")):f(new b(h.INVALID,"info is invalid"))},deleteDevice:function(b,e,f){f()},applyUIFilter:function(b,e,f){var g=function(a,d,b){var c=[];a.forEach(function(a){if("root"==a.type){a=JSON.parse(JSON.stringify(a));var e=g(a.children,d,b);e&&0<e.length&&(a.children=e,c.push(a))}else{e=b.elems;if("*"==e)e=!0;else{for(var f=!1,h=0;h<e.length;h++)if(e[h]==a.type){f=!0;break}e=f}e&&(a=JSON.parse(JSON.stringify(a)),c.push(a))}});return c},h=function(a,d){var c=
[],b=xnm.aio.onkyo.DM.getCommandStatusMap(a,f);if(b){var e=[];switch(d.catagory){case "command":b.command&&(e=g(b.command,a,d));break;case "status":b.status&&(e=g(b.status,a,d))}c=c.concat(e)}return c};if(!b.sys)return null;var m=JSON.parse(JSON.stringify(b)),a=null;switch(e.catagory){case "command":a=h(b,e);m.command=a;break;case "status":a=h(b,e);m.status=a;break;default:return null}return a&&0!=a.length?m:null},getCommandStatusMap:function(b){return b&&b.type?e[b.type]:null}}}();
xnm.aio.onkyo.Handler=function(){var b=function(){this.detectedAVRs={}};b.prototype.devicemanager=xnm.aio.onkyo.DM;b.prototype.AVReceiver=xnm.aio.onkyo.AVReceiver;b.prototype.registModule=function(b){b.register(xnm.aio.onkyo.DM.SYS,"onkyo")};b.prototype.resolveDevice=function(b){if(!b)return null;switch(b.type){case "avr":return xnm.aio.onkyo.AVReceiver.parseJSON(b);default:return null}};b.prototype.getDeviceCommands=function(b,g){b=(b=xnm.aio.onkyo.DM.applyUIFilter(b,{catagory:"command",elems:"*"}))?
b.command:[];g&&g(null,b)};b.prototype.getDeviceStatus=function(b,g){b=(b=xnm.aio.onkyo.DM.applyUIFilter(b,{catagory:"status",elems:"*"}))?b.status:[];g&&g(null,b)};b.prototype.doCommand=function(b,g,h){var e=this.resolveDevice(b);e?e.executeCommandCreator(b,g,function(b){h&&h(b)}):h&&h(Error("device json format invalid"))};b.prototype.doStatus=function(b,g,h,f){var e=this.resolveDevice(g);e?e.getStatesCreator(null,[{id:b,device:g,status:h}],function(b,e){b?f&&f(b):f&&f(null,e[0])}):f&&f(Error("device json format invalid"))};
b.prototype.getDeviceCommandList=function(b,g,h){var e=[];if(g)e.push({id:window.XC_Text.on,cmd:"on"}),e.push({id:window.XC_Text.off,cmd:"off"});else if(h&&"avr"==b.type){b=[];b.push({id:"on",cmd:"on"});b.push({id:"off",cmd:"off"});b.push({id:"toggle",cmd:"toggle"});b.push({id:"volumeDown",cmd:"volumeDown"});b.push({id:"volumeUp",cmd:"volumeUp"});b.push({id:"set volume",cmd:"setTo",step:"1",max:"80"});b.push({id:"mute",cmd:"mute"});b.push({id:"unmute",cmd:"unmute"});b.push({id:"toggleMute",cmd:"toggleMute"});
b.push({id:"CBLSAT",cmd:"CBLSAT"});b.push({id:"BDDVD",cmd:"BDDVD"});b.push({id:"STRMBOX",cmd:"STRMBOX"});b.push({id:"GAME",cmd:"GAME"});b.push({id:"AUX",cmd:"AUX"});b.push({id:"PC",cmd:"PC"});b.push({id:"CD",cmd:"CD"});b.push({id:"TV",cmd:"TV"});b.push({id:"NET",cmd:"NET"});b.push({id:"BLUETOOTH",cmd:"BLUETOOTH"});b.push({id:"FM",cmd:"FM"});b.push({id:"AM",cmd:"AM"});b.push({id:"tunerUp",cmd:"tunerUp"});b.push({id:"tunerDown",cmd:"tunerDown"});b.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",
max:"40"});cl=b.length;for(g=0;g<cl;g++)h=JSON.parse(JSON.stringify(b[g])),h.ch="mainzone",e.push(h),h=JSON.parse(JSON.stringify(b[g])),h.ch="zone2",e.push(h);e.push({id:"MOVIE",cmd:"MOVIE"});e.push({id:"MUSIC",cmd:"MUSIC"});e.push({id:"GAME",cmd:"GAME"});e.push({id:"STEREO",cmd:"STEREO"});e.push({id:"play",cmd:"play"});e.push({id:"pause",cmd:"pause"});e.push({id:"stop",cmd:"stop"});e.push({id:"previous",cmd:"previous"});e.push({id:"next",cmd:"next"})}return e};b.prototype.discoverDevices=function(b){var e=
require("x.upnp.js");if(e){var h=this;e.discoverDevicesWithTimeout(3E3,function(e){if(e.manufacturer&&0==e.manufacturer.indexOf("ONKYO")&&"AV Receiver"==e.modelDescription){var f=new xnm.aio.onkyo.AVReceiver(e.ip,null,e.uuid,e.modelName,e.name);h.detectedAVRs["uuid:"+e.uuid]||(h.detectedAVRs["uuid:"+e.uuid]=f);b(f)}})}};b.prototype.discoverWithTimeout=function(b,g){var e={};this.discoverDevices(function(b){b&&b.getUUID()&&!e[b.getUUID()]&&(e[b.getUUID()]=b)});setTimeout(function(){var b=[],h;for(h in e)e.hasOwnProperty(h)&&
b.push(e[h]);g&&g(null,b)},b)};return b}();"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.onkyo.Handler);
